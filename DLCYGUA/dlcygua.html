<!DOCTYPE html>
<html lang="es" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DL Cumanayagua | Tu Tienda Local</title>
    
    <meta name="description" content="DL Cumanayagua: Tu mercado local online. Disfruta de ENV√çOS GRATIS en todo el municipio. Compra alimentos y regalos desde el exterior pagando con Zelle.">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://erick890406.github.io/TheDo-aLuc-aGroup/DLCYGUA/dlcygua.html">
    <meta property="og:site_name" content="DL Cumanayagua">
    <meta property="og:title" content="DL Cumanayagua: ¬°Env√≠os GRATIS en el Municipio! üöõ">
    <meta property="og:description" content="Servicio exclusivo. Compra comida y regalos para tu familia con entrega gratuita. Pagos seguros v√≠a Zelle.">
    <meta property="og:image" content="https://i.postimg.cc/QdCNKRg6/meta.jpg">
    <meta property="og:image:secure_url" content="https://i.postimg.cc/QdCNKRg6/meta.jpg">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="628">
    <meta property="og:image:alt" content="Env√≠os Gratis en Cumanayagua - DL Cumanayagua">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="DL Cumanayagua: Env√≠os Locales GRATIS">
    <meta name="twitter:description" content="Aprovecha la entrega gratuita en todo Cumanayagua. Alimentos, aseo y regalos. Paga con Zelle.">
    <meta name="twitter:image" content="https://i.postimg.cc/QdCNKRg6/meta.jpg">
    <meta name="twitter:image:alt" content="Promoci√≥n DL Cumanayagua">

    <link rel="icon" type="image/png" href="./img/Logo-DL-Cumanayagua.png">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <link rel="manifest" href="./manifest.json">
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DL Cumanayagua">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        if (!customElements.get('lottie-player')) {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js';
            document.head.appendChild(script);
        }
    </script>

    <style>
        /* ============ ESTILOS MODERNOS (TIENDA LOCAL) ============ */
        :root {
            --primary: #ea580c;
            --primary-dark: #c2410c;
            --secondary: #334155;
            --success: #16a34a;
            --background: #f8fafc;
            --surface: rgba(255, 255, 255, 0.95);
            --text-main: #0f172a;
            --text-light: #64748b;
            --radius-md: 12px;
            --radius-lg: 20px;
            --shadow-soft: 0 10px 30px -10px rgba(0,0,0,0.08);
            
            /* Colores Stories */
            --story-gradient: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            --story-brand-gradient: linear-gradient(45deg, #ea580c, #16a34a);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            padding-top: 80px;
            overflow-x: hidden;
            padding-bottom: 90px;
        }

        /* Navbar Glass */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 12px 0;
            transition: all 0.3s ease;
        }
        .navbar-brand { font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; font-size: 1.3rem; }
        .nav-link { font-weight: 500; color: var(--text-light); cursor: pointer; position: relative; }
        .nav-link.active { color: var(--primary); font-weight: 600; }
        .nav-link.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: var(--primary); border-radius: 10px; }

        /* Tarjetas de Producto */
        .card {
            border: none;
            border-radius: var(--radius-lg);
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            height: 100%;
            position: relative;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .card-body { padding: 1.25rem; display: flex; flex-direction: column; }

        .product-image-container { position: relative; overflow: hidden; border-radius: var(--radius-md); aspect-ratio: 1/1; margin-bottom: 1rem; background: #f1f5f9; }
        .product-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .card:hover .product-image { transform: scale(1.05); }

        /* Bot√≥n (+) Flotante en Producto */
        .btn-plus-overlay {
            position: absolute; bottom: 10px; right: 10px; width: 40px; height: 40px;
            background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); color: var(--primary); font-size: 1.5rem;
            transition: all 0.2s ease; z-index: 5; cursor: pointer;
        }
        .btn-plus-overlay:hover { background: var(--primary); color: white; transform: scale(1.1); }
        .btn-plus-overlay:active { transform: scale(0.95); }

        /* --- BOT√ìN FAVORITO (CORAZ√ìN) CON ANIMACI√ìN --- */
        .btn-heart-overlay {
            position: absolute; top: 10px; right: 10px; width: 35px; height: 35px;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: #cbd5e1; font-size: 1.2rem;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5; cursor: pointer;
        }
        .btn-heart-overlay.active { color: #ef4444; background: white; transform: scale(1.1); }
        .btn-heart-overlay:active { transform: scale(0.9); }

        /* Animaci√≥n de Latido */
        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.3); }
            70% { transform: scale(1); }
        }
        .animate-heartbeat {
            animation: heartbeat 0.8s ease-in-out;
        }

        .card-title { font-weight: 600; margin-bottom: 0.3rem; font-size: 1rem; color: var(--text-main); line-height: 1.4; }
        .price { font-weight: 800; color: var(--primary); font-size: 1.2rem; }

        /* Badge Env√≠o Gratis */
        .badge-free {
            background-color: #dcfce7; color: #166534; font-size: 0.75rem; padding: 6px 12px;
            border-radius: 50px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px;
            margin-top: auto; width: fit-content;
        }

        /* Botones */
        .btn { border-radius: 50px; padding: 0.7rem 1.5rem; font-weight: 600; transition: all 0.3s ease; border: none; letter-spacing: 0.3px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #c2410c 100%); color: white; box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3); }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(234, 88, 12, 0.4); }
        .btn-outline-primary { border: 2px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-outline-primary:hover { background: var(--primary-light); color: var(--primary); }

        /* ============ HERO CAROUSEL UNIFORME ============ */
        #hero-promo {
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 3rem;
            position: relative;
            background: white;
        }

        /* ALTURA FIJA PARA TODOS LOS SLIDES */
        .hero-slide-content {
            height: 400px; /* Altura fija uniforme */
            padding: 2rem 1.5rem;
            text-align: center;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* FONDOS DE LAS OFERTAS */
        .bg-slide-1 { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); position: relative; }
        .bg-slide-1::after { content: 'üõµ'; font-size: 10rem; position: absolute; right: -20px; bottom: -40px; opacity: 0.15; transform: rotate(-15deg); }

        .bg-slide-2 { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); position: relative; }
        .bg-slide-2::after { content: 'üçï'; font-size: 10rem; position: absolute; left: -20px; bottom: -30px; opacity: 0.15; transform: rotate(15deg); }

        .bg-slide-3 { background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); position: relative; }
        .bg-slide-3::after { content: 'üöÄ'; font-size: 10rem; position: absolute; right: 10px; top: -20px; opacity: 0.15; transform: rotate(-10deg); }

        .carousel-indicators [data-bs-target] { background-color: white; opacity: 0.5; height: 4px; border-radius: 2px; width: 20px; margin: 0 4px; border: none; }
        .carousel-indicators .active { opacity: 1; width: 30px; }

        /* Categor√≠as (Pills) */
        .filter-scroll-container { display: flex; gap: 10px; overflow-x: auto; padding: 5px 5px 15px 5px; scrollbar-width: none; }
        .filter-scroll-container::-webkit-scrollbar { display: none; }
        .cat-pill {
            white-space: nowrap; padding: 10px 24px; border-radius: 50px; background: white; border: 1px solid #e2e8f0;
            color: var(--text-light); font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .cat-pill.active { background: var(--text-main); color: white; border-color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Floating Buttons */
        .floating-buttons-container { position: fixed; bottom: 30px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 15px; }
        .floating-button {
            width: 64px; height: 64px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .floating-button:hover { transform: scale(1.1); }
        #floatingCartButton { background: var(--text-main); color: white; }
        #whatsappButton { background: #25D366; color: white; }

        /* Spinner */
        .loading-spinner { background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner-border { color: var(--primary); width: 3rem; height: 3rem; border-width: 4px; }

        /* FOOTER */
        .footer-custom { background-color: white; border-top: 1px solid #E2E8F0; padding: 4rem 0 2rem; margin-top: 5rem; }
        .footer-avatar { width: 60px !important; height: 60px !important; border-radius: 12px; object-fit: cover; aspect-ratio: 1/1; border: 2px solid #f1f5f9; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Bot√≥n Refresh Footer */
        .refresh-btn-footer {
            color: #ea580c; /* Naranja para resaltar */
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        .refresh-btn-footer:hover { transform: rotate(180deg); color: #c2410c; }

        /* ESTILOS MENSAJE GLOBAL & BLOQUEO */
        .global-message-wrapper {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 24px; padding: 2.5rem 1.5rem; text-align: center; position: relative; overflow: hidden;
            box-shadow: 0 25px 60px rgba(0,0,0,0.15);
        }
        .global-message-wrapper::before {
            content: ''; position: absolute; top: -60%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(79, 70, 229, 0.1) 0%, transparent 60%);
            animation: spinBg 12s linear infinite; z-index: 0;
        }
        @keyframes spinBg { 100% { transform: rotate(360deg); } }

        /* --- ESTILOS ESPECIALES PARA MODO CERRADO (LOCKOUT) --- */
        .lockout-modal-content {
            background-color: #0f172a !important; /* Dark Navy Background */
            
            border: 1px solid rgba(255,255,255,0.1) !important;
            color: white !important;
            border-radius: 24px !important;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.5) !important;
        }
        
        .clock-anim { 
            font-size: 4rem; 
            color: #f59e0b; 
            display: block;
            margin: 0 auto 1rem auto;
            animation: swing 2s infinite ease-in-out;
        }

        @keyframes swing {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-15deg); }
            100% { transform: rotate(0deg); }
        }

        .gm-title { font-family: 'Poppins', sans-serif; font-weight: 800; font-size: 1.6rem; line-height: 1.2; margin-bottom: 0.5rem; color: #1e293b; }
        .gm-text { font-size: 0.95rem; color: #475569; margin-bottom: 1.5rem; }
        .gm-cta { cursor: pointer; color: var(--primary); font-weight: bold; margin-top: 1rem; }

        /* Modal Glass Reset */
        .modal-glass .modal-content { background: transparent; border: none; box-shadow: none; }

        /* CARRITO */
        .cart-item-card {
            background: white; border-radius: 16px; padding: 12px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 15px; border: 1px solid #f1f5f9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: transform 0.2s;
        }
        .cart-item-card:hover { transform: translateX(2px); border-color: #e2e8f0; }
        .cart-item-img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; background: #f8fafc; }
        .cart-qty-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #e2e8f0; background: white; display: flex; align-items: center; justify-content: center; color: var(--text-main); font-weight: bold; transition: all 0.2s; cursor: pointer; }
        .cart-qty-btn:active { background: var(--primary); border-color: var(--primary); color: white; }

        /* Stepper */
        .step-circle { width: 35px; height: 35px; border-radius: 50%; background: #e2e8f0; color: #64748b; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #fff; transition: all 0.3s; z-index: 2; position: relative; }
        .step-item.active .step-circle { background: var(--success); color: white; transform: scale(1.1); box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.15); }
        .stepper-progress-line { height: 4px; background: #e2e8f0; position: absolute; top: 15px; left: 0; right: 0; z-index: 0; border-radius: 10px; }
        .progress-bar-fill { height: 100%; background: var(--success); transition: width 0.3s ease; border-radius: 10px; }

        /* Inputs Invalidos */
        .is-invalid { border-color: #dc3545 !important; background-image: none !important; }

        /* ESTILO PERSONALIZADO PARA TOASTS (Notificaciones) EN LA PARTE SUPERIOR */
        .toast-container-top {
            position: fixed;
            top: 20px; /* Separaci√≥n del top */
            left: 50%;
            transform: translateX(-50%);
            z-index: 2055;
            width: max-content;
            max-width: 90%;
        }

        /* Estilo para los Modales SweetAlert2 (Para que coincidan con el tema) */
        div:where(.swal2-container) div:where(.swal2-popup) {
            border-radius: 20px !important;
            font-family: 'Poppins', sans-serif !important;
        }

        @media (max-width: 576px) {
            .btn { width: 100%; }
            #hero-promo { padding: 0; border-radius: 20px; } /* Ajuste Hero Mobile */
            #hero-promo h1 { font-size: 2rem; }
            .gm-headline { font-size: 1.8rem; }
        }
        /* --- PANTALLA COMPLETA DE BLOQUEO (SOLID BACKGROUND) --- */
        .full-screen-lockout {
            background-color: #0f172a !important; /* Color Azul Navy S√≥lido */
            width: 100% !important;
            height: 100% !important;
            padding: 0 !important;
            z-index: 10000 !important; /* Por encima de todo */
        }

        /* Centrar el contenido en la pantalla completa */
        .full-screen-lockout .modal-dialog {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            max-width: 100%;
            margin: 0;
        }

        /* Quitar el fondo a la tarjeta interna para que se fusione con el fondo grande */
        .full-screen-lockout .lockout-modal-content {
            background-color: transparent !important; 
            border: none !important;
            box-shadow: none !important;
        }

        /* === CONTENEDORES DIN√ÅMICOS PARA PROMOS === */
        #promo-bottom-fixed {
            position: fixed;
            bottom: 20px; /* Encima de botones flotantes (que est√°n a 30px, ajustar z-index) */
            left: 5%; 
            width: 90%;
            z-index: 99; /* Debajo de los botones flotantes (z-100) */
            display: none;
        }
        
        /* Ajuste de Z-Index para asegurar visibilidad */
        .floating-buttons-container { z-index: 200 !important; }
        
        /* ESTILOS POR DEFECTO PARA ELEMENTOS INYECTADOS SI LA PLANTILLA FALLA */
        .promo-fallback {
            background: #2563eb; color: white; padding: 15px; border-radius: 12px; text-align: center;
        }
        /* ============ ESTILOS MODAL ACTUALIZACI√ìN (CYBER) ============ */
        .modal-cyber-backdrop {
            background-color: rgba(15, 23, 42, 0.95) !important; /* Fondo muy oscuro */
            backdrop-filter: blur(10px);
        }

        .cyber-card {
            background: #1e293b;
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            margin: 0 auto;
        }

        .cyber-glow {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            animation: cyberSpin 10s linear infinite;
            z-index: 0;
        }

        @keyframes cyberSpin { 100% { transform: rotate(360deg); } }

        .cyber-layout { position: relative; z-index: 1; }

        .cyber-icon-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cyber-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            opacity: 0.2;
            animation: pulseCyber 2s infinite;
        }

        .cyber-icon {
            font-size: 2.5rem;
            color: #8b5cf6;
            background: -webkit-linear-gradient(#6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.5));
        }

        .cyber-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #818cf8;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 1rem;
            letter-spacing: 1px;
        }

        .cyber-title { color: white; font-weight: 800; margin-bottom: 0.5rem; }
        .cyber-body { color: #94a3b8; font-size: 0.95rem; margin-bottom: 2rem; }

        .cyber-btn {
            position: relative;
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            font-weight: 700;
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .cyber-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5); }
        .cyber-btn:active { transform: scale(0.98); }

        .cyber-btn-shine {
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: btnShine 3s infinite;
        }

        @keyframes btnShine { 100% { left: 100%; } }
        @keyframes pulseCyber { 0% { transform: scale(1); opacity: 0.2; } 50% { transform: scale(1.1); opacity: 0.1; } 100% { transform: scale(1); opacity: 0.2; } }

        /* ============ ESTILOS STORIES (INSTAGRAM STYLE) ============ */
        .stories-wrapper {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 15px;
            scrollbar-width: none; /* Firefox */
            margin-bottom: 1rem;
            background: white;
            border-bottom: 1px solid #f1f5f9;
        }
        .stories-wrapper::-webkit-scrollbar { display: none; }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 72px;
            flex-shrink: 0;
        }

        .story-circle-container {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            padding: 3px;
            /* Gradiente de marca: Naranja a Verde */
            background: var(--story-brand-gradient); 
            position: relative;
            transition: transform 0.2s ease;
        }
        
        .story-circle-container.seen {
            background: #e2e8f0; /* Color gris si ya fue visto */
        }

        .story-item:hover .story-circle-container {
            transform: scale(1.05);
        }

        .story-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white; /* Borde blanco interno */
            background-color: #f1f5f9;
        }

        .story-label {
            font-size: 0.75rem;
            margin-top: 5px;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
        }

        /* --- VISOR DE HISTORIAS (FULL SCREEN) --- */
        #story-viewer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 1050; /* Encima de todo, debajo de SweetAlert */
            display: none;
            flex-direction: column;
            user-select: none; /* Prevenir selecci√≥n al mantener presionado */
        }

        .story-content-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111;
        }

        .story-full-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Barras de progreso */
        .story-progress-container {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            padding: 0 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .story-progress-bar-bg {
            height: 3px;
            background: rgba(255,255,255,0.3);
            flex-grow: 1;
            border-radius: 2px;
            overflow: hidden;
        }

        .story-progress-bar-fill {
            height: 100%;
            background: white;
            width: 0%;
            /* Animaci√≥n controlada por Keyframes para poder pausar */
        }
        
        /* Keyframe para la animaci√≥n de la barra */
        @keyframes fillStoryBar {
            from { width: 0%; }
            to { width: 100%; }
        }

        /* Controles de navegaci√≥n invisibles */
        .story-nav-left, .story-nav-right {
            position: absolute;
            top: 0;
            height: 100%;
            width: 30%; /* Reducido para dejar centro libre para press */
            z-index: 5;
        }
        .story-nav-left { left: 0; }
        .story-nav-right { right: 0; }

        /* Cabecera del Story */
        .story-header {
            position: absolute;
            top: 25px;
            left: 15px;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .story-header-avatar { width: 32px; height: 32px; border-radius: 50%; border: 1px solid white; }
        .story-header-name { font-weight: 600; font-size: 0.9rem; }
        .story-close-btn {
            position: absolute;
            top: 20px;
            right: 15px;
            z-index: 20;
            color: white;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            padding: 10px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        /* ============ DETALLE PRODUCTO FULLSCREEN ============ */
        #productDetailModal .modal-content {
            background: #f8fafc;
        }
        .detail-image-container {
            width: 100%;
            height: 45vh;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            padding-bottom: 20px;
        }
        .detail-image {
            max-height: 90%;
            max-width: 90%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        .detail-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px);
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            color: #334155;
            z-index: 10;
            font-size: 1.2rem;
        }
        .detail-info-container {
            padding: 25px;
            background: transparent;
        }
        .detail-price-tag {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -1px;
        }
        .detail-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            line-height: 1.2;
            margin-bottom: 10px;
        }
        .recommendation-scroll-wrapper {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 5px 20px 5px;
            scrollbar-width: none;
        }
        .recommendation-scroll-wrapper::-webkit-scrollbar { display: none; }
        .rec-card-modern {
            min-width: 140px;
            background: white;
            border-radius: 16px;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            border: 1px solid #f1f5f9;
        }

        /* ============ ESTILOS PROMOCIONES (TIKTOK STYLE PREMIUM) ============ */
        .tiktok-card {
            background: #000;
            border: none;
            border-radius: 20px; /* Bordes redondeados en el modal */
            padding: 0;
            overflow: hidden;
            position: relative;
            height: 75vh; /* Altura considerable */
            width: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        /* Imagen de fondo Full Bleed */
        .tiktok-img-bg {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0; left: 0;
            z-index: 0;
        }

        /* Overlay Gradiente */
        .tiktok-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%; /* Gradiente desde la mitad */
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 50%, transparent 100%);
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 2rem;
            text-align: left;
        }

        .tiktok-content {
            position: relative;
            z-index: 2;
            color: white;
        }

        .tiktok-badge {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .tiktok-title {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .tiktok-desc {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .tiktok-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        .tiktok-btn:hover {
            background: white;
            color: black;
            transform: translateY(-2px);
        }

        /* Indicador de Swipe */
        .tiktok-swipe-hint {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            z-index: 5;
            opacity: 0.7;
            animation: pulseHint 2s infinite;
        }
        .tiktok-swipe-hint i {
            font-size: 1.5rem;
            color: white;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        @keyframes pulseHint { 0% { transform: translateY(-50%) translateX(0); opacity: 0.5; } 50% { transform: translateY(-50%) translateX(5px); opacity: 1; } 100% { transform: translateY(-50%) translateX(0); opacity: 0.5; } }

        /* ============ BARRA PROGRESO LUXURY GAMING (GLASSMORPHISM + PARTICLES) ============ */
        .min-order-pill {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 320px;
            height: 55px;
            background: rgba(10, 10, 20, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            overflow: hidden;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            z-index: 1040;
            display: none;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .min-order-pill.completed-anim {
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.4);
        }

        .min-order-content {
            position: relative;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            height: 100%;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .min-order-text {
            font-size: 0.95rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.5px;
        }

        .min-order-bar-bg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        .min-order-bar-fill {
            height: 100%;
            width: 0%;
            position: absolute;
            top: 0; left: 0;
            z-index: 2;
            background: linear-gradient(90deg, #ff8c00 0%, #ff0080 50%, #7928ca 100%);
            background-size: 200% 100%;
            opacity: 0.8;
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: gamingFlow 3s linear infinite;
        }

        @keyframes gamingFlow {
            0% { background-position: 100% 0; }
            100% { background-position: 0 0; }
        }

        .lux-particle {
            position: fixed;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: white;
            z-index: 1050;
            pointer-events: none;
            opacity: 0;
        }

        /* ============ NUEVAS FUNCIONALIDADES (FOMO, TIMELINE) ============ */
        
        /* FOMO Notifications */
        #fomo-container {
            position: fixed;
            bottom: 90px; /* Encima de la barra de progreso */
            left: 20px;
            z-index: 1030;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none; /* Dejar pasar clicks */
        }

        .fomo-toast {
            background: rgba(15, 23, 42, 0.85); /* Dark Glass */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            border-radius: 16px;
            color: white;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            animation: slideInLeft 0.5s ease forwards, fadeOut 0.5s ease 4.5s forwards;
            max-width: 280px;
        }
        
        .fomo-icon {
            font-size: 1.2rem;
            color: #4ade80; /* Green accent */
        }

        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); } }

        /* Timeline de Pedido */
        .order-timeline {
            position: relative;
            padding-left: 20px;
            margin-top: 15px;
            border-left: 2px solid #e2e8f0;
        }
        
        .timeline-step {
            position: relative;
            padding-bottom: 20px;
            padding-left: 20px;
        }
        
        .timeline-step:last-child { padding-bottom: 0; }

        .timeline-dot {
            position: absolute;
            left: -26px; /* Ajuste para centrar en la l√≠nea */
            top: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #cbd5e1;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #f1f5f9;
            transition: all 0.3s ease;
        }
        
        .timeline-step.active .timeline-dot {
            background: #22c55e; /* Green active */
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
            transform: scale(1.2);
        }
        
        .timeline-step.active .timeline-text { color: #0f172a; font-weight: 700; }
        .timeline-text { font-size: 0.85rem; color: #64748b; }
        .timeline-date { font-size: 0.75rem; color: #94a3b8; display: block; }

    </style>
</head>
<body id="top">

<nav class="navbar navbar-expand-lg navbar-custom fixed-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#">
            <img src="img/Logo-DL-Cumanayagua.png" width="36" height="36" class="rounded-3 shadow-sm">
            DL Cumanayagua
        </a>
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" id="navbarToggler">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center gap-lg-3 mt-3 mt-lg-0">
                <li class="nav-item"><a class="nav-link" onclick="handleNavClick('menu-tab-link'); setCategoryFilter('all')">Men√∫</a></li>
                <li class="nav-item"><a class="nav-link" id="favorites-tab-link" data-bs-toggle="pill" href="#favorites-tab" onclick="handleNavClick('favorites-tab-link'); renderFavorites()">‚ù§Ô∏è Favoritos</a></li>
                <span id="dynamic-nav-items" class="d-lg-flex d-block gap-lg-3" style="display: contents;"></span>
                <li class="nav-item"><a class="nav-link" id="my-orders-tab-link" data-bs-toggle="pill" href="#my-orders-tab" onclick="handleNavClick('my-orders-tab-link'); loadUserOrders()">üìã Mis Pedidos</a></li>
                
                <li class="nav-item">
                    <button class="btn btn-sm btn-danger rounded-pill px-3 ms-lg-2 mt-2 mt-lg-0 fw-bold shadow-sm" onclick="openPromoSwipe(); closeNav()">
                        <i class="bi bi-megaphone-fill me-1"></i> üî• Promociones
                    </button>
                </li>

                <li class="nav-item d-flex align-items-center mt-2 mt-lg-0" id="auth-buttons-nav-container">
                    <div id="auth-buttons-nav"></div>
                    <button id="btn-share-nav" class="btn btn-sm btn-light border rounded-pill ms-2" onclick="openShareModal()"><i class="bi bi-share-fill"></i></button>
                    <button id="logoutButtonNav" class="btn btn-sm btn-outline-danger rounded-pill px-3 ms-2" style="display:none;" onclick="logoutClient()">Salir</button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<main class="container mt-4 pt-2 pb-5">

    <div id="stories-section" class="animate__animated animate__fadeIn">
        </div>

    <div id="hero-promo" class="animate__animated animate__fadeInUp">
        <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3500">

            <div class="carousel-indicators mb-4">
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2"></button>
            </div>

            <div class="carousel-inner">

                <div class="carousel-item active">
                    <div class="hero-slide-content bg-slide-1">
                        <div id="hero-guest" style="display: block; width: 100%; position: relative; z-index: 2;">
                            <span class="badge bg-white text-success px-3 py-1 rounded-pill fw-bold shadow-sm mb-3 text-uppercase ls-1">¬°Servicio 24/7!</span>
                            <h1 class="mb-3 fw-bold">Domicilio GRATIS en<br>Cumanayagua</h1>
                            <p class="mb-4 opacity-90 fs-6">Paga en efectivo (CUP) al recibir.</p>
                            <div class="d-flex gap-3 justify-content-center">
                                <button class="btn btn-light text-success btn-lg rounded-pill shadow-sm px-4 fw-bold" onclick="openAuthModal('login')">Ingresar</button>
                                <button class="btn btn-outline-light btn-lg rounded-pill px-4" onclick="openAuthModal('register')">Crear Cuenta</button>
                            </div>
                        </div>

                        <div id="hero-user" style="display: none; width: 100%; position: relative; z-index: 2;">
                            <h2 class="mb-2 fw-bold">üëã Hola, <span id="hero-user-name">Vecino</span></h2>
                            <p class="mb-4 opacity-90 fs-5">¬øQu√© te gustar√≠a pedir hoy?</p>
                            <div class="d-flex gap-3 justify-content-center">
                                <button class="btn btn-light text-success btn-lg rounded-pill shadow-sm px-4 fw-bold" onclick="document.getElementById('menu-tab-link').click()">Ver Men√∫</button>
                                <button class="btn btn-outline-light btn-lg rounded-pill px-4" onclick="loadUserOrders(); document.getElementById('my-orders-tab-link').click()">Mis Pedidos</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="carousel-item">
                    <div class="hero-slide-content bg-slide-2">
                        <div style="position: relative; z-index: 2;">
                            <span class="badge bg-warning text-dark px-3 py-1 rounded-pill fw-bold shadow-sm mb-3">üî• ¬°OFERTA DEL D√çA!</span>
                            <h1 class="mb-3 fw-bold">Pizzas Calientes<br>a tu Puerta</h1>
                            <p class="mb-4 opacity-90 fs-6">Disfruta el sabor aut√©ntico sin salir de casa.</p>
                            <button class="btn btn-light text-warning fw-bold btn-lg rounded-pill px-5 shadow-sm" onclick="setCategoryFilter('Pizzas'); showTabAndScroll('menu-tab-link')">
                                Ordenar Ahora <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="carousel-item">
                    <div class="hero-slide-content bg-slide-3">
                        <div style="position: relative; z-index: 2;">
                            <img src="./img/Logo-DL-Cumanayagua.png" width="60" height="60" class="rounded-3 shadow mb-3 border border-2 border-white">
                            <h1 class="mb-3 fw-bold">¬°Tenemos App Oficial!</h1>
                            <p class="mb-4 opacity-90 fs-6">Desc√°rgala para una experiencia m√°s r√°pida.</p>
                            <a href="https://github.com/Erick890406/TheDo-aLuc-aGroup/releases/download/v1.0/app-debug.apk" target="_blank" class="btn btn-light text-primary fw-bold btn-lg rounded-pill px-4 shadow-sm bg-white">
                                <i class="bi bi-cloud-arrow-down-fill me-2"></i> Descargar APK
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <ul class="nav nav-pills justify-content-center mb-4 gap-2">
        <li class="nav-item"><a class="nav-link active" id="menu-tab-link" data-bs-toggle="pill" href="#menu-tab" onclick="setCategoryFilter('all')">üçΩÔ∏è Men√∫</a></li>
        
        <span id="dynamic-pills-items" class="d-flex gap-2" style="display: contents;"></span>
        
        <li class="nav-item"><a class="nav-link" id="favorites-tab-link" data-bs-toggle="pill" href="#favorites-tab" onclick="renderFavorites()">‚ù§Ô∏è Favoritos</a></li>
        <li class="nav-item"><a class="nav-link" id="my-orders-tab-link" data-bs-toggle="pill" href="#my-orders-tab" onclick="loadUserOrders()">üìã Mis Pedidos</a></li>
    </ul>

    <div class="tab-content">

        <div class="tab-pane fade show active" id="menu-tab">

            <div class="alert alert-warning border-0 shadow-sm rounded-4 mb-4 d-flex align-items-center gap-3 animate__animated animate__fadeIn" role="alert">
                <div class="bg-white bg-opacity-50 rounded-circle p-2 text-warning">
                    <i class="bi bi-info-circle-fill fs-3"></i>
                </div>
                <div>
                    <h6 class="fw-bold mb-1 text-dark">Informaci√≥n Importante</h6>
                    <p class="mb-0 small text-dark opacity-75 lh-sm">
                        Los domicilios dentro del Municipio son <strong>sin costo alguno</strong> pero con una compra m√≠nima: <strong>$500 CUP</strong> por compra en productos.
                    </p>
                </div>
            </div>

            <div id="promo-banner-container" style="display: none;"></div>

            <div class="row justify-content-center mb-4">
                <div class="col-lg-8">
                    <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden border-0">
                        <span class="input-group-text bg-white border-0 ps-4"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" id="productSearchInput" class="form-control border-0" placeholder="¬øQu√© buscas hoy?">
                    </div>
                </div>
            </div>

            <div id="category-pills-container" class="filter-scroll-container justify-content-lg-center px-2 mb-4"></div>

            <div class="row g-3" id="menu-container"><div class="col-12 text-center py-5"><div class="spinner-border opacity-25"></div></div></div>
        </div>

        <div class="tab-pane fade" id="favorites-tab">
            <div class="row g-3" id="favorites-container">
                <div class="col-12 text-center py-5 text-muted">
                    <i class="bi bi-heart-break display-4 opacity-25"></i>
                    <p class="mt-3">A√∫n no tienes favoritos.</p>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="my-orders-tab">
            <div id="orders-history-container" class="row justify-content-center g-3">
                <div class="col-md-8 text-center py-5 text-muted">
                    <i class="bi bi-box-seam display-4 opacity-25"></i>
                    <p class="mt-3">Inicia sesi√≥n para ver tu historial.</p>
                </div>
            </div>
        </div>
    </div>

</main>

<div id="story-viewer">
    <div class="story-progress-container" id="story-progress-bars">
        </div>
    
    <div class="story-header">
        <img src="img/Logo-DL-Cumanayagua.png" class="story-header-avatar">
        <span class="story-header-name" id="story-header-title">DL Cumanayagua</span>
    </div>

    <button class="story-close-btn" onclick="closeStory()"><i class="bi bi-x-lg"></i></button>

    <div class="story-content-container">
        <div class="story-nav-left" onclick="prevStorySlide()"></div>
        <div class="story-nav-right" onclick="nextStorySlide()"></div>
        
        <img src="" class="story-full-img animate__animated" id="story-image">
    </div>
</div>

<div id="promo-bottom-fixed"></div>

<div id="min-order-pill" class="min-order-pill">
    <div class="min-order-bar-bg"><div class="min-order-bar-fill" id="min-order-bar-fill"></div></div>
    <div class="min-order-content">
        <span class="min-order-text" id="min-order-text">
            <i class="bi bi-bag"></i> Calculando...
        </span>
        <span id="min-order-percent" class="small opacity-75">0%</span>
    </div>
</div>

<div id="fomo-container"></div>

<div class="floating-buttons-container">
    <a id="whatsappButton" href="https://wa.me/5355189657" class="floating-button" target="_blank"><i class="bi bi-whatsapp fs-3"></i></a>
    <button id="floatingCartButton" class="floating-button position-relative" data-bs-toggle="modal" data-bs-target="#cartModal" style="display: none;">
        <i class="bi bi-bag-fill fs-3"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-2 border-white" id="floating-cart-count">0</span>
    </button>
</div>

<div id="loadingSpinnerUser" class="loading-spinner d-none">
    <div class="spinner-border" role="status"></div>
</div>

<div class="toast-container-top" id="toastPlacement"></div>

<div class="modal fade" id="refreshConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-body p-4 text-center">
                <div class="bg-warning bg-opacity-10 text-warning rounded-circle d-inline-flex p-3 mb-3">
                    <i class="bi bi-exclamation-triangle-fill fs-1"></i>
                </div>
                <h5 class="fw-bold mb-3">¬øRecargar Aplicaci√≥n?</h5>
                <p class="text-muted mb-4">Utiliza esta opci√≥n si hay una nueva versi√≥n o si la app presenta errores. Se borrar√° el cach√© y se recargar√° todo desde cero.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning rounded-pill px-4 fw-bold" onclick="forceFullCacheRefresh()">S√≠, Recargar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-glass" id="globalMessageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-0" id="global-message-content"></div></div></div></div>

<div class="modal fade" id="authModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header border-0"><h5 class="modal-title fw-bold">Bienvenido</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4">
    <ul class="nav nav-pills nav-fill mb-4 bg-light rounded-pill p-1"><li class="nav-item"><button class="nav-link active rounded-pill" id="login-tab-btn" onclick="switchAuthTab('login')">Ingresar</button></li><li class="nav-item"><button class="nav-link rounded-pill" id="register-tab-btn" onclick="switchAuthTab('register')">Registrarse</button></li></ul>
    <div class="tab-content">
        <div id="login-tab-pane" class="d-block animate__animated animate__fadeIn">
            <form id="loginForm" class="d-grid gap-3">
                <div class="form-floating"><input type="tel" class="form-control" id="loginPhone" placeholder="Tel√©fono" required><label>Tel√©fono</label></div>
                <div class="form-floating"><input type="password" class="form-control" id="loginPassword" placeholder="Contrase√±a" required><label>Contrase√±a</label></div>
                <div id="login-feedback" class="text-center small text-danger"></div>
                <button type="button" class="btn btn-primary btn-lg w-100 rounded-pill mt-2" onclick="handleLoginAttempt()">Iniciar Sesi√≥n</button>
            </form>
        </div>
        <div id="register-tab-pane" class="d-none animate__animated animate__fadeIn">
            <form id="newUserRegistrationForm" class="d-grid gap-3">
                <div class="form-floating"><input type="text" class="form-control" id="newUserName" placeholder="Nombre" required><label>Nombre Completo</label></div>
                <div class="form-floating"><input type="tel" class="form-control" id="newUserPhone" placeholder="Tel√©fono" required><label>Tel√©fono</label></div>
                <div class="form-floating"><input type="email" class="form-control" id="newUserEmail" placeholder="Email" required><label>Email (Opcional)</label></div>
                <div class="form-floating"><input type="password" class="form-control" id="newUserPassword" placeholder="Contrase√±a" required><label>Contrase√±a</label></div>
                <div class="form-floating"><input type="password" class="form-control" id="newUserConfirmPassword" placeholder="Confirmar" required><label>Confirmar Contrase√±a</label></div>
                <div class="form-floating"><input type="text" class="form-control" id="newUserReferralCodeUsed" placeholder="C√≥digo"><label>C√≥digo de Amigo (Opcional)</label></div>
                <div id="registration-feedback" class="text-center small text-danger"></div>
                <button type="button" class="btn btn-primary btn-lg w-100 rounded-pill mt-2" onclick="handleUserRegistrationAttempt()">Crear Cuenta</button>
            </form>
        </div>
    </div>
</div></div></div></div>

<div class="modal fade" id="sharePageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4 p-4 text-center"><h5 class="fw-bold mb-4">Comparte la Tienda</h5><div id="qrcodeCanvas" class="d-flex justify-content-center mb-4 p-3 bg-light rounded-4 mx-auto" style="width: fit-content;"></div><div class="d-grid gap-2"><button id="copyLinkButton" class="btn btn-light border btn-lg rounded-pill" onclick="copyPageLink(this)">Copiar Enlace</button><a id="shareViaWhatsAppButton" class="btn btn-success btn-lg rounded-pill" target="_blank"><i class="bi bi-whatsapp me-2"></i> Enviar por WhatsApp</a></div></div></div></div>

<div class="modal fade" id="cartModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content border-0 shadow-lg" style="border-radius: 24px;"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold ms-2">Tu Pedido</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4">

        <div class="stepper-wrapper d-flex justify-content-between position-relative mb-4 px-4 align-items-center">
            <div class="stepper-progress-line"><div class="progress-bar-fill" id="stepperLine" style="width: 0%;"></div></div>
            <div class="step-item position-relative z-1 text-center active" id="stepIndicator1"><div class="step-circle"><i class="bi bi-bag"></i></div><small class="fw-bold mt-1 d-block" style="font-size: 0.7rem;">Carrito</small></div>
            <div class="step-item position-relative z-1 text-center" id="stepIndicator2"><div class="step-circle"><i class="bi bi-geo-alt"></i></div><small class="fw-bold mt-1 d-block text-muted" style="font-size: 0.7rem;">Entrega</small></div>
            <div class="step-item position-relative z-1 text-center" id="stepIndicator3"><div class="step-circle"><i class="bi bi-check-lg"></i></div><small class="fw-bold mt-1 d-block text-muted" style="font-size: 0.7rem;">Listo</small></div>
        </div>

        <div id="stepContent1" class="step-content animate__animated animate__fadeIn active">
            <div id="cart-items-container" class="mb-3"></div>
            <div id="empty-cart-msg" class="text-center py-5 d-none"><i class="bi bi-basket display-1 text-light"></i><p class="text-muted mt-3">Tu carrito est√° vac√≠o</p></div>
        </div>

        <div id="stepContent2" class="step-content animate__animated animate__fadeIn" style="display: none;">
            <div class="alert alert-light border rounded-4 mb-4 d-flex align-items-center gap-3">
                <i class="bi bi-person-circle fs-3 text-primary"></i>
                <div><small class="text-muted fw-bold text-uppercase d-block lh-1">Comprador</small><span class="fw-bold text-dark fs-6" id="step2-client-name">Usuario</span></div>
            </div>
            <h6 class="fw-bold mb-3">üìç Datos de Entrega</h6>
            <div class="row g-3">
                <div class="col-md-6"><div class="form-floating"><input type="text" class="form-control" id="deliveryName" placeholder="N"><label>Nombre y Apellidos *</label></div></div>
                <div class="col-12"><div class="form-floating"><input type="tel" class="form-control" id="deliveryPhone" placeholder="T"><label>Tel√©fono de Contacto *</label></div></div>
                <div class="col-12"><div class="form-floating"><input type="text" class="form-control" id="deliveryAddress" placeholder="D"><label>Direcci√≥n (Cumanayagua) *</label></div></div>
                <div class="col-12"><div class="form-floating"><input type="text" class="form-control" id="deliveryRef" placeholder="R"><label>Punto de Referencia *</label></div></div>
                <div class="col-12"><div class="form-floating"><textarea class="form-control" id="deliveryExtra" placeholder="N" style="height: 80px"></textarea><label>Nota para el mensajero</label></div></div>
            </div>
        </div>

        <div id="stepContent3" class="step-content animate__animated animate__fadeIn text-center" style="display: none;">
            <div id="order-placement-feedback"></div>
        </div>

    </div>
        <div class="modal-footer border-0 pt-0 justify-content-between" id="cartModalFooter">
            <button class="btn btn-light text-muted rounded-pill px-4" id="btnBack" onclick="changeStep(-1)" style="display: none;">Atr√°s</button>
            <div class="ms-auto d-flex gap-2">
                <button class="btn btn-dark rounded-pill px-4" id="btnNext" onclick="changeStep(1)">Siguiente</button>
                <button class="btn btn-success rounded-pill px-4 shadow-lg" id="btnPay" onclick="confirmAndPlaceOrder()" style="display: none;">Confirmar Pedido</button>
            </div>
        </div>
    </div></div></div>

<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content border-0">
            <div class="modal-body p-0 position-relative overflow-y-auto" style="padding-bottom: 100px !important;">
                
                <button type="button" class="detail-close-btn" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i></button>

                <div class="detail-image-container">
                    <img src="" id="modal-product-image" class="detail-image">
                </div>

                <div class="detail-info-container">
                    <div class="d-flex flex-column gap-1 mb-3">
                        <h2 id="modal-product-name" class="detail-title"></h2>
                        <h3 id="modal-product-price" class="detail-price-tag"></h3>
                    </div>

                    <p id="modal-product-description" class="text-muted fs-6 mb-4 lh-base"></p>
                    
                    <div class="d-flex align-items-center gap-2 mb-4">
                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-2 rounded-pill"><i class="bi bi-scooter me-1"></i> Env√≠o Gratis</span>
                        <span class="badge bg-light text-dark border px-3 py-2 rounded-pill"><i class="bi bi-shield-check me-1"></i> Compra Segura</span>
                    </div>

                    <hr class="opacity-10 my-4">

                    <div id="modal-recommendations-container">
                        </div>
                </div>
            </div>
            <div class="modal-footer border-0 fixed-bottom bg-white shadow-lg p-3 justify-content-center" style="z-index: 1055;">
                <div id="modal-add-to-cart-button-container" class="w-100" style="max-width: 600px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="avatarGalleryModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content border-0 rounded-4"><div class="modal-header border-0"><h5 class="fw-bold">Elige tu Avatar</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="avatar-gallery" class="d-flex flex-wrap gap-3 justify-content-center"></div></div></div></div></div>
<div class="modal fade" id="updateAppModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0" id="update-modal-content">
                <div class="cyber-card animate__animated animate__backInUp">
                    <div class="cyber-glow"></div>
                    
                    <div class="cyber-layout">
                        <div class="cyber-icon-wrapper">
                            <div class="cyber-circle"></div>
                            <i class="bi bi-rocket-takeoff-fill cyber-icon"></i>
                        </div>
                        
                        <div class="cyber-content">
                            <div class="cyber-badge">NUEVA VERSI√ìN DISPONIBLE</div>
                            <h3 class="cyber-title" id="update-title">Mejora Disponible</h3>
                            <p class="cyber-body" id="update-body">Hemos a√±adido nuevas funciones y mejoras de velocidad. Actualiza para continuar.</p>
                        </div>
                    </div>

                    <button class="cyber-btn" id="btn-force-update">
                        <span class="cyber-btn-shine"></span>
                        <span class="cyber-btn-content">
                            <i class="bi bi-lightning-charge-fill"></i> INSTALAR MEJORA
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="promoSwipeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
            <div id="promoCarousel" class="carousel slide help-carousel-container" data-bs-ride="false" data-bs-touch="true">
                <div class="carousel-inner" id="promo-carousel-inner">
                    </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#promoCarousel" data-bs-slide="prev" style="width: 10%;">
                    <span class="carousel-control-prev-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#promoCarousel" data-bs-slide="next" style="width: 10%;">
                    <span class="carousel-control-next-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                </button>
            </div>
             <div class="text-center mt-3">
                <button class="btn btn-light rounded-pill px-4 fw-bold shadow-lg" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<footer class="footer-custom">
    <div class="container">
        <div class="row align-items-center gy-4">
            <div class="col-md-6 text-center text-md-start">
                <div class="d-flex align-items-center justify-content-center justify-content-md-start gap-3">
                    <img src="./img/Logo-DL-Cumanayagua.png" class="footer-avatar shadow-sm">
                    <div class="lh-1">
                        <h6 class="fw-bold mb-1 text-dark">DL Cumanayagua</h6>
                        <small class="text-muted">Servicio Local de Confianza</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-center text-md-end">
                <div class="d-flex justify-content-center justify-content-md-end gap-3 mb-2 align-items-center">
                    <a href="https://wa.me/5355189657" class="text-dark opacity-50 hover-opacity-100 fs-5"><i class="bi bi-whatsapp"></i></a>
                    <i class="bi bi-arrow-clockwise refresh-btn-footer ms-3 opacity-50 hover-opacity-100" onclick="confirmRefresh()" data-bs-toggle="tooltip" title="Recargar App"></i>
                </div>
                <small class="text-muted">¬© 2025 DL CUMANAYAGUA.</small>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    // ==================== CONFIGURACI√ìN ====================
    const GOOGLE_SCRIPT_URL_USER = 'https://script.google.com/macros/s/AKfycbxnGPCddfcdV8osGZ0cpoYdvD6T-dCD6NjsWH65garMmxSW1-FDjXy10tbXYR_OR7QrUg/exec';
    const LOGGED_IN_CLIENT_KEY = 'dlClient_v29_final';
    const USER_CART_KEY = 'dlCart_v29_final';
    const MENU_CACHE_KEY = 'dlMenu_cache_v1'; 
    const USER_FAVORITES_KEY = 'dlFavorites_v1';
    const FIXED_SHARE_URL = 'https://erick890406.github.io/TheDo-aLuc-aGroup/DLCYGUA/dlcygua.html';
    
    // M√çNIMO DE COMPRA CONFIGURABLE
    const MIN_ORDER_AMOUNT = 500;
    
    // NUEVO: Clave para controlar la versi√≥n de la App
    const APP_VERSION_KEY = 'dl_app_version_v1';

    // ==================== ESTADO ====================
    let clientData = null, menuItems = [], shoppingCart = [], userFavorites = [];
    let authModal, cartModal, prodModal, globalMsgModal, shareModal, refreshModal, updateModal, promoSwipeModal;
    let currentFilterCategory = 'all';
    
    // Variables para controlar que los mensajes no se repitan
    let lastProductHash = "";
    let lastGlobalMsgHash = ""; 

    // ==================== STORIES DATA (AYUDA) ====================
    const storiesData = [
            {
                id: 'story1',
                title: '¬øC√≥mo pedir?',
                thumbnail: 'https://i.postimg.cc/XvXwqvL1/ayudaminiatura.jpg', // Miniatura naranja
                slides: [
                    { type: 'image', url: 'https://i.postimg.cc/hGh9vGs5/ayudaimegen1.jpg', duration: 5000 },
                    { type: 'image', url: 'https://i.postimg.cc/g0rvj0sB/ayudaimegen2.jpg', duration: 5000 },
                    { type: 'image', url: 'https://i.postimg.cc/mrhQkrjy/ayudaimegen3.jpg', duration: 5000 }
                ]
            },
        {
            id: 'story2',
            title: 'Env√≠os Gratis',
            thumbnail: 'https://i.postimg.cc/g2ZSJN0m/envio_gratis.jpg', // Miniatura verde
            slides: [
                { type: 'image', url: 'https://i.postimg.cc/3xvSRnwK/Pedidominimo500cup.jpg', duration: 5000 },
                { type: 'image', url: 'https://i.postimg.cc/K8MqzJYj/Enviosgratisfoto.jpg', duration: 5000 }
            ]
        },
        {
            id: 'story3',
            title: 'Horarios',
            thumbnail: 'https://i.postimg.cc/jjRHbXn2/horariosminiatura.jpg', // Miniatura gris
            slides: [
                { type: 'image', url: 'https://i.postimg.cc/qRRZk06V/horario1.jpg', duration: 5000 },
                { type: 'image', url: 'https://i.postimg.cc/d11SqvZK/horario2.jpg', duration: 5000 }
            ]
        },
        // --- NUEVAS HISTORIAS AGREGADAS ---
        {
            id: 'story4',
            title: 'Ofertas Flash',
            thumbnail: 'https://i.postimg.cc/zfDz5bJt/Gemini-Generated-Image-3uab4x3uab4x3uab.png', // Miniatura Roja
            slides: [
                { type: 'image', url: 'https://i.postimg.cc/sfT22JBn/Gemini-Generated-Image-je6jtyje6jtyje6j.png', duration: 5000 },
                { type: 'image', url: 'https://i.postimg.cc/Hs7CC0b8/Gemini-Generated-Image-lnv3cplnv3cplnv3.png', duration: 5000 }
            ]
        },
        {
            id: 'story5',
            title: 'Formas de Pago',
            thumbnail: 'https://i.postimg.cc/W1kW3X43/Gemini_Generated_Image_dqx3tdqx3tdqx3td2.jpg', // Miniatura Azul
            slides: [
                { type: 'image', url: 'https://i.postimg.cc/CLMmGwL2/Gemini_Generated_Image_jumi68jumi68jumi_(1).jpg', duration: 5000 },
                { type: 'image', url: 'https://i.postimg.cc/yYP6GyKh/Gemini_Generated_Image_dqx3tdqx3tdqx3td_(3).jpg', duration: 5000 },
                { type: 'image', url: 'https://i.postimg.cc/m2wZny4y/Gemini_Generated_Image_dqx3tdqx3tdqx3td_(2).jpg', duration: 5000 },
                { type: 'image', url: 'https://i.postimg.cc/CLMmGwLQ/Gemini_Generated_Image_jumi68jumi68jumi_(2).jpg', duration: 5000 }
            ]
        },
        {
            id: 'story6',
            title: 'Soporte',
            thumbnail: 'https://i.postimg.cc/d09hjc10/Gemini_Generated_Image_dqx3tdqx3tdqx3td.jpg', // Miniatura Violeta
            slides: [
                { type: 'image', url: 'https://i.postimg.cc/Xvgrk6JJ/Gemini_Generated_Image_dqx3tdqx3tdqx3td_(1).jpg', duration: 5000 }
            ]
        }
    ];

    let currentStoryIndex = 0;
    let currentSlideIndex = 0;
    let storyTimer = null;
    let storyStartTime = 0;
    let storyDuration = 0;
    
    // Variables para Pausa de Historias
    let isStoryPaused = false;
    let storyRemainingTime = 0;
    let storyStartTimestamp = 0;

    // ==================== INICIALIZACI√ìN ====================
    document.addEventListener('DOMContentLoaded', async () => {
        // REGISTRO DEL SERVICE WORKER (PWA - CACH√â)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registrado', reg))
                .catch(err => console.log('SW error', err));
        }

        // Inicializar modales
        authModal = new bootstrap.Modal(document.getElementById('authModal'));
        cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
        prodModal = new bootstrap.Modal(document.getElementById('productDetailModal'));
        globalMsgModal = new bootstrap.Modal(document.getElementById('globalMessageModal')); 
        shareModal = new bootstrap.Modal(document.getElementById('sharePageModal'));
        refreshModal = new bootstrap.Modal(document.getElementById('refreshConfirmModal'));
        updateModal = new bootstrap.Modal(document.getElementById('updateAppModal'));
        promoSwipeModal = new bootstrap.Modal(document.getElementById('promoSwipeModal'));

        // GLOBAL VIBRATION LISTENER
        document.body.addEventListener('click', (e) => {
            if (e.target.closest('button, a, .card, .nav-link, .step-item, .gm-cta, .btn-plus-overlay, .cyber-btn, .story-item')) {
                if(navigator.vibrate) navigator.vibrate(40);
            }
        });

        // INPUT VIBRATION
        document.body.addEventListener('input', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if(navigator.vibrate) navigator.vibrate(25);
            }
        });
        
        // EVENTOS PARA PAUSAR HISTORIAS (Desktop & Mobile)
        const storyViewer = document.getElementById('story-viewer');
        
        // Touch events - PAUSA AL PRESIONAR CUALQUIER PARTE
        storyViewer.addEventListener('touchstart', (e) => {
            if(e.target.closest('.story-close-btn')) return;
            pauseStory();
        }, {passive: true});
        
        storyViewer.addEventListener('touchend', (e) => {
             if(e.target.closest('.story-close-btn')) return;
             resumeStory();
        }, {passive: true});

        // Mouse events
        storyViewer.addEventListener('mousedown', (e) => {
             if(e.target.closest('.story-close-btn')) return;
             pauseStory();
        });
        
        storyViewer.addEventListener('mouseup', (e) => {
             if(e.target.closest('.story-close-btn')) return;
             resumeStory();
        });


        // NUEVO: Event Listener para el bot√≥n de forzar actualizaci√≥n
        const btnForceUpdate = document.getElementById('btn-force-update');
        if(btnForceUpdate) {
            btnForceUpdate.addEventListener('click', () => {
                const pendingVersion = document.getElementById('updateAppModal').dataset.pendingVersion;
                if(pendingVersion) {
                    localStorage.setItem(APP_VERSION_KEY, pendingVersion); 
                }
                forceFullCacheRefresh(); 
            });
        }

        // Renderizar Historias
        renderStories();

        // INICIAR LOOP FOMO
        startFomoLoop();

        // FUNCIONES GLOBALES
        window.openAuthModal = function(tab) { authModal.show(); window.switchAuthTab(tab); };
        window.confirmRefresh = function() { refreshModal.show(); };

        window.switchAuthTab = function(tab) {
            const loginPane = document.getElementById('login-tab-pane');
            const registerPane = document.getElementById('register-tab-pane');
            const loginBtn = document.getElementById('login-tab-btn');
            const registerBtn = document.getElementById('register-tab-btn');

            if(tab === 'login') {
                loginPane.classList.remove('d-none'); loginPane.classList.add('d-block');
                registerPane.classList.remove('d-block'); registerPane.classList.add('d-none');
                loginBtn.classList.add('active'); registerBtn.classList.remove('active');
            } else {
                loginPane.classList.remove('d-block'); loginPane.classList.add('d-none');
                registerPane.classList.remove('d-none'); registerPane.classList.add('d-block');
                loginBtn.classList.remove('active'); registerBtn.classList.add('active');
            }
        };

        window.openShareModal = function() {
            const qrContainer = document.getElementById('qrcodeCanvas');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: FIXED_SHARE_URL,
                width: 150, height: 150, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
            });
            const msg = "¬°Hola! Mira esta tienda local, tienen env√≠os gratis: " + FIXED_SHARE_URL;
            document.getElementById('shareViaWhatsAppButton').href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            shareModal.show();
        };

        window.setCategoryFilter = function(cat) {
            document.getElementById('productSearchInput').value = ''; 
            currentFilterCategory = cat;
            generateCategoryFilters();
            generateMenu();
        };

        window.showTabAndScroll = function(tabId) {
            const triggerEl = document.getElementById(tabId);
            if(triggerEl) {
                const tab = new bootstrap.Tab(triggerEl);
                tab.show();
                document.querySelector(triggerEl.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
            }
        };

        window.filterAndScroll = function(category) {
            const menuTabLink = document.getElementById('menu-tab-link');
            const tab = new bootstrap.Tab(menuTabLink);
            tab.show();
            currentFilterCategory = category;
            generateCategoryFilters();
            generateMenu();
            document.getElementById('menu-tab').scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.sharePromo = function(title, body) {
            const text = `${title}\n${body}\n\n¬°Mira esto aqu√≠! üëâ ${FIXED_SHARE_URL}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };
        
        // --- NUEVO: CIERRE DE MEN√ö Y SCROLL ---
        window.closeNav = function() {
            const nav = document.getElementById('navbarNav');
            if(nav.classList.contains('show')) {
                const toggler = document.getElementById('navbarToggler');
                if(toggler) toggler.click(); // Manera m√°s segura de cerrar
            }
        };

        window.handleNavClick = function(tabId) {
            closeNav();
            showTabAndScroll(tabId);
        };

        // Cargar men√∫ y favoritos
        loadCachedMenu();
        loadFavorites();
        loadClientData();
        loadCart();
        updateUI();

        document.getElementById('cartModal')?.addEventListener('show.bs.modal', initCartStepper);
        document.getElementById('productSearchInput')?.addEventListener('input', generateMenu);

        await loadInitialData();
        startAutoUpdate(); 
    });

    // ==================== L√ìGICA DE STORIES ====================
    function renderStories() {
        const container = document.getElementById('stories-section');
        if(!container) return;
        
        let html = '<div class="stories-wrapper">';
        storiesData.forEach((story, index) => {
            html += `
                <div class="story-item" onclick="openStory(${index})">
                    <div class="story-circle-container">
                        <img src="${story.thumbnail}" class="story-img">
                    </div>
                    <span class="story-label">${story.title}</span>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    window.openStory = function(index) {
        currentStoryIndex = index;
        currentSlideIndex = 0;
        
        const viewer = document.getElementById('story-viewer');
        viewer.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Bloquear scroll de fondo
        
        loadStorySlide();
    };

    window.closeStory = function() {
        const viewer = document.getElementById('story-viewer');
        viewer.style.display = 'none';
        document.body.style.overflow = 'auto'; // Restaurar scroll
        clearTimeout(storyTimer);
        isStoryPaused = false;
    };

    function loadStorySlide(resume = false) {
        const story = storiesData[currentStoryIndex];
        const slide = story.slides[currentSlideIndex];
        
        if (!resume) {
            // Actualizar Cabecera
            document.getElementById('story-header-title').innerText = story.title;
            
            // Actualizar Imagen Central
            const imgEl = document.getElementById('story-image');
            imgEl.style.display = 'none'; // Ocultar mientras carga o cambia
            imgEl.classList.remove('animate__fadeIn');
            
            setTimeout(() => {
                imgEl.src = slide.url;
                imgEl.style.display = 'block';
                imgEl.classList.add('animate__fadeIn');
            }, 50);
            
            storyRemainingTime = slide.duration;
        }

        // Generar/Actualizar Barras de Progreso
        const progressContainer = document.getElementById('story-progress-bars');
        
        if (!resume) {
            progressContainer.innerHTML = '';
            story.slides.forEach((s, idx) => {
                const barBg = document.createElement('div');
                barBg.className = 'story-progress-bar-bg';
                
                const barFill = document.createElement('div');
                barFill.className = 'story-progress-bar-fill';
                barFill.id = `story-bar-${idx}`;
                
                if (idx < currentSlideIndex) {
                    barFill.style.width = '100%';
                } else if (idx === currentSlideIndex) {
                    barFill.style.width = '0%';
                    barFill.style.animation = `fillStoryBar ${slide.duration}ms linear forwards`;
                } else {
                    barFill.style.width = '0%';
                }
                
                barBg.appendChild(barFill);
                progressContainer.appendChild(barBg);
            });
        } else {
            // Si es resume, reajustamos la animaci√≥n de la barra actual
            const currentBar = document.getElementById(`story-bar-${currentSlideIndex}`);
            if(currentBar) {
                currentBar.style.animationPlayState = 'running';
            }
        }

        // Configurar Timer
        clearTimeout(storyTimer);
        storyStartTimestamp = Date.now();
        storyTimer = setTimeout(() => {
            nextStorySlide();
        }, storyRemainingTime);
    }
    
    function pauseStory() {
        if (isStoryPaused) return;
        isStoryPaused = true;
        clearTimeout(storyTimer);
        
        const elapsed = Date.now() - storyStartTimestamp;
        storyRemainingTime -= elapsed;
        
        // Pausar animaci√≥n CSS
        const currentBar = document.getElementById(`story-bar-${currentSlideIndex}`);
        if(currentBar) {
            currentBar.style.animationPlayState = 'paused';
        }
    }
    
    function resumeStory() {
        if (!isStoryPaused) return;
        isStoryPaused = false;
        
        loadStorySlide(true); // Resume mode
    }

    window.nextStorySlide = function() {
        const story = storiesData[currentStoryIndex];
        
        if (currentSlideIndex < story.slides.length - 1) {
            currentSlideIndex++;
            loadStorySlide();
        } else {
            // Fin de esta historia, pasar a la siguiente si existe
            if (currentStoryIndex < storiesData.length - 1) {
                currentStoryIndex++;
                currentSlideIndex = 0;
                loadStorySlide();
            } else {
                closeStory(); // Fin de todas las historias
            }
        }
    };

    window.prevStorySlide = function() {
        if (currentSlideIndex > 0) {
            currentSlideIndex--;
            loadStorySlide();
        } else {
            // Volver a la historia anterior
            if (currentStoryIndex > 0) {
                currentStoryIndex--;
                currentSlideIndex = storiesData[currentStoryIndex].slides.length - 1; // Ir a la √∫ltima de la anterior
                loadStorySlide();
            } else {
                // Principio de todo, reiniciar timer de la primera
                currentSlideIndex = 0;
                loadStorySlide();
            }
        }
    };


    // Funci√≥n para cargar men√∫ guardado (Offline support)
    function loadCachedMenu() {
        const cached = localStorage.getItem(MENU_CACHE_KEY);
        if (cached) {
            try {
                menuItems = JSON.parse(cached);
                if(menuItems.length > 0) {
                    generateCategoryFilters();
                    generateMenu();
                    console.log("Men√∫ cargado desde cach√© local (Modo Offline listo)");
                }
            } catch (e) {
                console.error("Error leyendo cach√© de men√∫", e);
            }
        }
    }

    // ==================== DATOS & API ====================
    async function fetchData(action, method, payload=null, silent=false) {
        if(!silent) {
            document.getElementById('loadingSpinnerUser').classList.remove('d-none');
            document.getElementById('loadingSpinnerUser').classList.add('d-flex');
        }
        try {
            let url = GOOGLE_SCRIPT_URL_USER;
            const opts = { method, mode: 'cors' };
            if(method==='GET') url += `?action=${action}&t=${Date.now()}`;
            else opts.body = JSON.stringify({ action, payload });

            const res = await fetch(url, opts);
            const text = await res.text();
            return JSON.parse(text);
        } catch(e) { 
            console.error(e); 
            if(!silent) showToast("Est√°s trabajando sin conexi√≥n", "warning"); 
            return {success:false}; 
        }
        finally {
            if(!silent) {
                document.getElementById('loadingSpinnerUser').classList.add('d-none');
                document.getElementById('loadingSpinnerUser').classList.remove('d-flex');
            }
        }
    }

    async function loadInitialData(silent = false) {
        const res = await fetchData('getInitialClientData', 'GET', null, silent);
        
        if(res.success && res.data) {
            
            // =========================================================
            // L√ìGICA DE ACTUALIZACI√ìN DE APP
            // =========================================================
            if(res.data.globalMessage && res.data.globalMessage.appVersion) {
                const msg = res.data.globalMessage;
                const serverVersion = String(msg.appVersion).trim();
                const localVersion = localStorage.getItem(APP_VERSION_KEY) || "0";

                if (serverVersion !== localVersion) {
                    const modalEl = document.getElementById('updateAppModal');
                    modalEl.dataset.pendingVersion = serverVersion;
                    updateModal.show();
                    document.body.style.overflow = 'hidden'; 
                    return; 
                }
            }
            // =========================================================

            const currentHash = JSON.stringify(res.data.products);
            const hasChanged = currentHash !== lastProductHash;
            
            if (hasChanged || !lastProductHash) {
                lastProductHash = currentHash;
                
                // 1. TABS
                if(res.data.tabs) {
                    const navContainer = document.getElementById('dynamic-nav-items');
                    const pillsContainer = document.getElementById('dynamic-pills-items');
                    let navHtml = ''; let pillsHtml = '';
                    res.data.tabs.forEach(tab => {
                        if(tab.isactive) { 
                            navHtml += `<li class="nav-item"><a class="nav-link" onclick="handleNavClick('menu-tab-link'); filterAndScroll('${tab.categoryfilter}')">${tab.label}</a></li>`;
                            pillsHtml += `<li class="nav-item"><a class="nav-link" onclick="handleNavClick('menu-tab-link'); filterAndScroll('${tab.categoryfilter}')">${tab.label}</a></li>`;
                        }
                    });
                    if(navContainer) navContainer.innerHTML = navHtml;
                    if(pillsContainer) pillsContainer.innerHTML = pillsHtml;
                }

                // 2. PRODUCTOS
                menuItems = (res.data.products||[]).map(p => ({
                    ...p, price: parseFloat(p.price)||0, id:String(p.id), category: p.category || 'Otros'
                }));

                localStorage.setItem(MENU_CACHE_KEY, JSON.stringify(menuItems));

                generateCategoryFilters();
                generateMenu();
            }

            // 3. GLOBAL MESSAGE
            if(res.data.globalMessage) {
                const msg = res.data.globalMessage;
                const currentMsgString = JSON.stringify(msg);
                const isNewMessage = currentMsgString !== lastGlobalMsgHash;

                if(msg.isActive) {
                    if (msg.title.toUpperCase().includes("CERRADO") || isNewMessage) {
                        lastGlobalMsgHash = currentMsgString;
                        renderGlobalMessage(msg);
                    }
                } else {
                    const modalEl = document.getElementById('globalMessageModal');
                    const wasLocked = modalEl.classList.contains('full-screen-lockout');
                    if(modalEl.classList.contains('show') || wasLocked) {
                        globalMsgModal.hide();
                        modalEl.classList.remove('full-screen-lockout');
                        document.body.style.overflow = 'auto'; 
                        document.body.style.paddingRight = '';
                        document.body.classList.remove('modal-open');
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(bd => bd.remove());
                    }
                    if(isNewMessage) {
                         lastGlobalMsgHash = currentMsgString;
                         renderPromoBanner(msg);
                    }
                }
            }
        }
    }
    
    function renderPromoBanner(msg) {
        const containers = {
            top: document.getElementById('promo-banner-container'),
            bottom: document.getElementById('promo-bottom-fixed')
        };
        containers.top.innerHTML = ''; containers.top.style.display = 'none';
        containers.bottom.innerHTML = ''; containers.bottom.style.display = 'none';

        if(!msg.promoActive || !msg.promoHTML) return;

        let styleTag = document.getElementById('dynamic-promo-style');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'dynamic-promo-style';
            document.head.appendChild(styleTag);
        }
        styleTag.innerHTML = msg.promoCSS || '';

        let htmlContent = msg.promoHTML
            .replace(/{{title}}/g, msg.promoTitle)
            .replace(/{{body}}/g, msg.promoBody)
            .replace(/sharePromo\('{{title}}','{{body}}'\)/g, `sharePromo('${msg.promoTitle.replace(/'/g, "\\'")}', '${msg.promoBody.replace(/'/g, "\\'")}')`);

        const position = msg.promoPosition || 'top-menu';

        if(position === 'top-menu') {
            containers.top.innerHTML = htmlContent;
            containers.top.style.display = 'block';
        } 
        else if (position === 'bottom-fixed') {
            containers.bottom.innerHTML = htmlContent;
            containers.bottom.style.display = 'block';
        }
        else if (position === 'popup') {
            if (!Swal.isVisible()) {
                Swal.fire({
                    html: htmlContent,
                    showConfirmButton: false,
                    showCloseButton: true,
                    background: 'transparent',
                    backdrop: 'rgba(0,0,0,0.8)',
                    customClass: { popup: 'p-0 border-0 overflow-hidden' }
                });
            }
        }
    }

    function startAutoUpdate() {
        setInterval(async () => {
            if (navigator.onLine) {
                await loadInitialData(true); 
            }
        }, 15000); 
    }

    function renderGlobalMessage(msg) {
        const container = document.getElementById('global-message-content');
        const modalEl = document.getElementById('globalMessageModal'); 
        const modalContent = modalEl.querySelector('.modal-content'); 
        
        const isLockout = msg.title.toUpperCase().includes("CERRADO");

        let htmlContent = '';
        if (msg.body.includes('gm-actions') || msg.body.includes('btn-download')) {
            htmlContent = msg.body;
        } else {
            if(isLockout) {
                modalEl.classList.add('full-screen-lockout');
                modalContent.classList.add('lockout-modal-content');

                htmlContent = `
                    <div class="text-center p-4 animate__animated animate__zoomIn">
                        <i class="bi bi-clock-history clock-anim mb-3 d-block" style="font-size: 5rem;"></i>
                        <h1 class="fw-bold mb-3 text-white" style="font-size: 2.5rem;">
                            ${msg.title}
                        </h1>
                        <p class="text-white-50 mb-5 fs-5 px-3" style="max-width: 600px; margin: 0 auto;">
                            ${msg.body}
                        </p>
                        <a style="display: none;" href="https://wa.me/5355189657" class="btn btn-success rounded-pill px-5 py-3 fw-bold fs-5 shadow-lg scale-hover">
                            <i class="bi bi-whatsapp me-2"></i> Contactar Soporte
                        </a>
                    </div>
                `;
            } else {
                modalEl.classList.remove('full-screen-lockout');
                modalContent.classList.remove('lockout-modal-content');

                htmlContent = `
                    <div class="global-message-wrapper">
                        <div class="gm-content">
                            <div class="gm-headline">${msg.title}</div>
                            <div class="gm-subhead mt-3">${msg.body}</div>
                            <div class="gm-cta" onclick="globalMsgModal.hide()">üëá ¬°Explora el Men√∫! üëá</div>
                        </div>
                    </div>
                `;
            }
        }
        container.innerHTML = htmlContent;

        if (isLockout) {
            globalMsgModal.dispose(); 
            globalMsgModal = new bootstrap.Modal(modalEl, { backdrop: false, keyboard: false });
            modalEl.querySelectorAll('.btn-close').forEach(btn => btn.style.display = 'none');
        } else {
             globalMsgModal.dispose();
             globalMsgModal = new bootstrap.Modal(modalEl);
        }
        globalMsgModal.show();
    }

    // ==================== FAVORITOS (WISHLIST) ====================
    function loadFavorites() {
        try {
            userFavorites = JSON.parse(localStorage.getItem(USER_FAVORITES_KEY)) || [];
        } catch(e) { userFavorites = []; }
    }

    function toggleFavorite(id, btnElement) {
        // Detener propagaci√≥n para no abrir el modal del producto
        if(event) event.stopPropagation();
        
        const index = userFavorites.indexOf(id);
        
        // --- 1. ACTUALIZAR ARRAY ---
        if(index > -1) {
            userFavorites.splice(index, 1);
            showToast('Eliminado de favoritos', 'secondary');
        } else {
            userFavorites.push(id);
            showToast('A√±adido a favoritos');
        }
        localStorage.setItem(USER_FAVORITES_KEY, JSON.stringify(userFavorites));
        
        // --- 2. MANIPULACI√ìN DOM OPTIMIZADA (SIN RECARGA TOTAL) ---
        if(btnElement) {
            // Cambiar clase 'active' (fondo blanco/color)
            btnElement.classList.toggle('active');
            
            // Cambiar icono (relleno vs contorno)
            const icon = btnElement.querySelector('i');
            if(icon) {
                if(btnElement.classList.contains('active')) {
                    icon.className = 'bi bi-heart-fill';
                } else {
                    icon.className = 'bi bi-heart';
                }
            }
            
            // Animaci√≥n de latido (CSS)
            btnElement.classList.remove('animate-heartbeat');
            void btnElement.offsetWidth; // Trigger reflow para reiniciar animaci√≥n
            btnElement.classList.add('animate-heartbeat');
        }

        // --- 3. SOLO RE-RENDERIZAR SI ESTAMOS EN LA PESTA√ëA "FAVORITOS" ---
        const favoritesTab = document.getElementById('favorites-tab');
        if(favoritesTab && favoritesTab.classList.contains('active') && favoritesTab.classList.contains('show')) {
            // Peque√±o delay para que se vea la animaci√≥n antes de desaparecer
            setTimeout(renderFavorites, 300);
        }
    }

    function renderFavorites() {
        const container = document.getElementById('favorites-container');
        const favItems = menuItems.filter(p => userFavorites.includes(p.id));
        
        if(favItems.length === 0) {
            container.innerHTML = '<div class="col-12 text-center py-5 text-muted"><i class="bi bi-heart-break display-4 opacity-25"></i><p class="mt-3">A√∫n no tienes favoritos.</p></div>';
        } else {
            container.innerHTML = favItems.map((p, index) => `
                <div class="col-6 col-md-4 col-lg-3 animate__animated animate__fadeInUp" style="animation-delay: ${index*0.05}s">
                    <div class="card h-100" onclick="showProductDetails('${p.id}')" style="cursor: pointer;">
                        <div class="card-body p-2">
                            <div class="product-image-container">
                                <img src="${p.imageurl||'./img/placeholder-product.png'}" class="product-image">
                                <div class="btn-heart-overlay active" onclick="toggleFavorite('${p.id}', this)"><i class="bi bi-heart-fill"></i></div>
                                <div class="btn-plus-overlay" onclick="event.stopPropagation(); addToCart('${p.id}')"><i class="bi bi-plus"></i></div>
                            </div>
                            <div class="text-center mt-2">
                                <h6 class="card-title text-truncate">${p.name}</h6>
                                <div class="price">$${p.price.toFixed(2)} CUP</div>
                            </div>
                        </div>
                    </div>
                </div>`).join('');
        }
    }

    // ==================== MENU ====================
    function generateCategoryFilters() {
        const container = document.getElementById('category-pills-container');
        if(!container) return;
        const categories = ['all', ...new Set(menuItems.map(i => i.category || 'Otros'))];
        container.innerHTML = categories.map(cat => `
            <button class="cat-pill ${currentFilterCategory === cat ? 'active' : ''}" onclick="setCategoryFilter('${cat}')">
                ${cat === 'all' ? 'Todo' : cat}
            </button>`).join('');
    }

    function generateMenu() {
        const container = document.getElementById('menu-container');
        const term = document.getElementById('productSearchInput').value.toLowerCase();

        let items = menuItems.filter(i => i.active!==false);
        if(currentFilterCategory !== 'all') items = items.filter(i => (i.category || 'Otros') === currentFilterCategory);
        items = items.filter(i => i.name.toLowerCase().includes(term));

        if(items.length === 0) {
            container.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">No se encontraron productos.</p></div>';
        } else {
            container.innerHTML = items.map((p, index) => {
                const isFav = userFavorites.includes(p.id);
                return `
                <div class="col-6 col-md-4 col-lg-3 animate__animated animate__fadeInUp" style="animation-delay: ${index*0.05}s">
                    <div class="card h-100" onclick="showProductDetails('${p.id}')" style="cursor: pointer;">
                        <div class="card-body p-2">
                            <div class="product-image-container">
                                <img src="${p.imageurl||'./img/placeholder-product.png'}" class="product-image">
                                
                                <div class="btn-heart-overlay ${isFav ? 'active' : ''}" onclick="toggleFavorite('${p.id}', this)">
                                    <i class="bi bi-heart${isFav ? '-fill' : ''}"></i>
                                </div>

                                <div class="btn-plus-overlay" onclick="event.stopPropagation(); addToCart('${p.id}')"><i class="bi bi-plus"></i></div>
                            </div>
                            <div class="text-center mt-2">
                                <h6 class="card-title text-truncate">${p.name}</h6>
                                <div class="price">$${p.price.toFixed(2)} CUP</div>
                                <span class="badge-free">Env√≠o Gratis</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
    }

    function generateRecommendations(currentProductId) {
        const container = document.getElementById('modal-recommendations-container');
        if(!container) return;
        container.innerHTML = '<h6 class="fw-bold mb-3 small text-uppercase ls-1 text-muted">Tambi√©n te podr√≠a gustar</h6>';
        const recs = menuItems.filter(p => p.id !== currentProductId && p.active !== false).sort(() => 0.5 - Math.random()).slice(0, 4); // Mostramos 4

        if(recs.length > 0) {
            const wrapper = document.createElement('div');
            wrapper.className = 'recommendation-scroll-wrapper';
            
            wrapper.innerHTML = recs.map(r => `
                <div class="rec-card-modern" onclick="showProductDetails('${r.id}')" style="cursor:pointer;">
                    <div class="mb-2 position-relative">
                        <img src="${r.imageurl || './img/placeholder-product.png'}" class="rounded-3 w-100 object-fit-cover" style="aspect-ratio:1/1;">
                    </div>
                    <div class="text-center">
                        <small class="d-block text-truncate fw-bold mb-1" style="font-size:0.75rem;">${r.name}</small>
                        <small class="text-primary fw-bold" style="font-size:0.8rem;">$${r.price.toFixed(2)}</small>
                    </div>
                </div>`).join('');
            container.appendChild(wrapper);
        } else container.innerHTML = '';
    }

    function showProductDetails(id) {
        const p = menuItems.find(x => x.id === id);
        
        document.getElementById('modal-product-image').src = p.imageurl;
        document.getElementById('modal-product-name').innerText = p.name;
        // Fix para signos de m√°s en descripciones
        document.getElementById('modal-product-description').innerText = p.description ? p.description.replace(/\+/g, ' ') : '';
        document.getElementById('modal-product-price').innerText = `$${p.price.toFixed(2)} CUP`;
        
        document.getElementById('modal-add-to-cart-button-container').innerHTML =
            `<button class="btn btn-primary w-100 btn-lg rounded-pill shadow fw-bold py-3" onclick="addToCart('${id}'); prodModal.hide()">
                <i class="bi bi-cart-plus-fill me-2"></i> A√±adir al Carrito - $${p.price.toFixed(2)}
             </button>`;
        
        generateRecommendations(id);
        prodModal.show();
    }

    // ==================== ORDERS & TIMELINE ====================
    
    function getTimelineHTML(status) {
        // Mapear status a pasos (1-4)
        let currentStep = 1;
        if(status.toLowerCase().includes('empaquetando') || status.toLowerCase().includes('proceso')) currentStep = 2;
        if(status.toLowerCase().includes('camino') || status.toLowerCase().includes('enviado')) currentStep = 3;
        if(status.toLowerCase().includes('entregado')) currentStep = 4;

        const steps = [
            { label: 'Recibido', date: 'Pedido confirmado' },
            { label: 'Empaquetando', date: 'Preparando tu orden' },
            { label: 'En Camino', date: 'Repartidor asignado' },
            { label: 'Entregado', date: '¬°Disfr√∫talo!' }
        ];

        let html = '<div class="order-timeline">';
        steps.forEach((step, index) => {
            const isActive = (index + 1) <= currentStep;
            const isLast = index === steps.length - 1;
            
            html += `
            <div class="timeline-step ${isActive ? 'active' : ''}">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <div class="timeline-text">${step.label}</div>
                    <small class="timeline-date">${isActive ? step.date : 'Pendiente'}</small>
                </div>
            </div>`;
        });
        html += '</div>';
        return html;
    }

    async function loadUserOrders() {
        if(!clientData) return;
        const container = document.getElementById('orders-history-container');
        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border"></div></div>';

        const res = await fetchData('getUserOrders', 'POST', { clientId: clientData.id });
        if(res.success && res.data.length > 0) {
            container.innerHTML = res.data.map(o => {
                let items = [];
                try {
                    items = typeof o.itemsjson === 'string' ? JSON.parse(o.itemsjson) : o.itemsjson;
                    if(!Array.isArray(items)) items = [];
                } catch(e) { items = []; }

                const productsHtml = items.map(i => `
                    <li class="list-group-item d-flex justify-content-between align-items-center small bg-white px-2 py-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-light text-dark border border-secondary border-opacity-25 rounded-pill">${i.quantity}x</span>
                            <span class="text-dark fw-medium lh-sm">${i.name || 'Producto'}</span>
                        </div>
                        <span class="fw-bold text-muted" style="font-size: 0.85rem;">$${(Number(i.price||0) * Number(i.quantity||1)).toFixed(2)}</span>
                    </li>
                `).join('');

                const timelineHTML = getTimelineHTML(o.status);

                return `
                <div class="accordion accordion-flush mt-3 border rounded-4 shadow-sm overflow-hidden" id="accordion-${o.orderid}">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#flush-${o.orderid}">
                                <div class="w-100 pe-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="badge bg-light text-dark border">#${o.orderid.substr(-4)}</span>
                                        <small class="text-muted" style="font-size: 0.75rem;">${new Date(o.orderdateiso).toLocaleDateString()}</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold text-primary fs-6">$${Number(o.totalamount).toFixed(2)}</span>
                                        <span class="badge rounded-pill bg-${o.status==='Entregado'?'success':'secondary'} bg-opacity-75">${o.status}</span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="flush-${o.orderid}" class="accordion-collapse collapse" data-bs-parent="#accordion-${o.orderid}">
                            <div class="accordion-body bg-light border-top p-3">
                                
                                ${timelineHTML}

                                <div class="mt-4">
                                    <h6 class="small fw-bold text-muted text-uppercase mb-2 ls-1" style="font-size: 0.7rem;">Detalle del Pedido</h6>
                                    <ul class="list-group list-group-flush mb-3 border rounded-3 overflow-hidden shadow-sm">
                                        ${productsHtml || '<li class="list-group-item small text-muted text-center">Detalles no disponibles</li>'}
                                    </ul>
                                </div>

                                <div class="bg-white rounded-3 p-3 border shadow-sm">
                                    <h6 class="small fw-bold text-muted text-uppercase mb-2 ls-1" style="font-size: 0.7rem;">Datos de Entrega</h6>
                                    <div class="d-flex align-items-center gap-2 mb-2 small text-dark">
                                        <i class="bi bi-person-circle text-primary opacity-50"></i> <span>${o.recipientname}</span>
                                    </div>
                                    <div class="d-flex align-items-start gap-2 small text-dark">
                                        <i class="bi bi-geo-alt-fill text-danger opacity-50 mt-1"></i> <span class="lh-sm">${o.deliveryaddress}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        } else {
            container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-box-seam display-4 opacity-25"></i><p class="mt-3">No tienes pedidos recientes.</p></div>';
        }
    }

    // ==================== CART ====================
    let currentStep = 1;
    function initCartStepper() { currentStep = 1; updateStepper(); renderCart(); }
    function changeStep(dir) {
        if(dir===1) {
            if(currentStep===1) {
                if(shoppingCart.length===0) return;
                
                // VALIDACI√ìN DE M√çNIMO DE COMPRA ANTES DE SEGUIR
                const total = shoppingCart.reduce((s,i)=>s+i.price*i.quantity,0);
                if(total < MIN_ORDER_AMOUNT) {
                    showToast(`El pedido m√≠nimo es de $${MIN_ORDER_AMOUNT} CUP`, 'warning');
                    // Efecto visual en la barra de progreso
                    const pill = document.getElementById('min-order-pill');
                    pill.classList.add('animate__animated', 'animate__headShake');
                    setTimeout(() => pill.classList.remove('animate__animated', 'animate__headShake'), 1000);
                    return;
                }

                if(!clientData) { authModal.show(); return; }
                document.getElementById('step2-client-name').innerText = clientData.nombre;
            }
            if(currentStep===2) {
                const req=['deliveryName','deliveryPhone','deliveryAddress','deliveryRef']; let valid=true;
                req.forEach(id=>{ const el=document.getElementById(id); if(!el.value.trim()){el.classList.add('is-invalid');valid=false;}else el.classList.remove('is-invalid'); });
                if(!valid) return showToast('Completa los campos obligatorios','danger');
            }
        }
        currentStep += dir; updateStepper();
    }
    function updateStepper() {
        document.querySelectorAll('.step-content').forEach(el=>el.style.display='none');
        document.getElementById(`stepContent${currentStep}`).style.display='block';
        for(let i=1; i<=3; i++) {
            const el=document.getElementById(`stepIndicator${i}`), circle=el.querySelector('.step-circle');
            el.classList.remove('active'); circle.style.backgroundColor='#e2e8f0'; circle.style.color='#64748b'; circle.style.transform='scale(1)';
            if(i<currentStep) { circle.innerHTML='<i class="bi bi-check-lg"></i>'; circle.style.backgroundColor='#16a34a'; circle.style.color='white'; }
            if(i===currentStep) { el.classList.add('active'); circle.innerHTML=i===1?'<i class="bi bi-bag"></i>':i===2?'<i class="bi bi-geo-alt"></i>':'<i class="bi bi-check-lg"></i>'; }
        }
        document.getElementById('stepperLine').style.width=(currentStep===1?'0%':currentStep===2?'50%':'100%');
        document.getElementById('btnBack').style.display=currentStep===2?'block':'none';
        document.getElementById('btnNext').style.display=currentStep<2?'block':'none';
        document.getElementById('btnPay').style.display=currentStep===2?'block':'none';
        document.getElementById('cartModalFooter').style.display=currentStep===3?'none':'flex';
    }
    function renderCart() {
        const list=document.getElementById('cart-items-container'), empty=document.getElementById('empty-cart-msg');
        if(shoppingCart.length===0) { list.innerHTML=''; empty.classList.remove('d-none'); document.getElementById('btnNext').disabled=true; return; }
        empty.classList.add('d-none');
        
        let total=0;
        list.innerHTML=shoppingCart.map(item=>{
            total+=item.price*item.quantity; const prod=menuItems.find(p=>p.id===item.productId);
            return `<div class="cart-item-card"><img src="${prod?.imageurl||'./img/placeholder-product.png'}" class="cart-item-img"><div class="flex-grow-1"><h6 class="mb-0 fw-bold text-truncate">${item.name}</h6><small class="text-muted">$${item.price.toFixed(2)} x ${item.quantity}</small></div><div class="d-flex flex-column gap-2"><button class="cart-qty-btn" onclick="updateQty('${item.productId}',1)">+</button><button class="cart-qty-btn" onclick="updateQty('${item.productId}',-1)">-</button></div></div>`;
        }).join('')+`<div class="d-flex justify-content-between align-items-center mt-3 p-3 bg-light rounded-4"><span class="fw-bold text-secondary">Total</span><span class="fs-4 fw-bold text-primary">$${total.toFixed(2)} CUP</span></div><div class="text-center mt-3"><button class="btn btn-sm text-danger opacity-75 hover-opacity-100" onclick="clearCart()"><i class="bi bi-trash3 me-1"></i> Vaciar Carrito</button></div>`;
        
        // Bloquear bot√≥n Siguiente si no cumple el m√≠nimo
        const btnNext = document.getElementById('btnNext');
        if (total < MIN_ORDER_AMOUNT) {
            btnNext.disabled = true;
            btnNext.innerHTML = `<i class="bi bi-lock-fill me-1"></i> M√≠nimo $${MIN_ORDER_AMOUNT}`;
            btnNext.classList.remove('btn-dark');
            btnNext.classList.add('btn-secondary');
        } else {
            btnNext.disabled = false;
            btnNext.innerText = 'Siguiente';
            btnNext.classList.remove('btn-secondary');
            btnNext.classList.add('btn-dark');
        }
    }
    
    function clearCart(){ 
        Swal.fire({
            title: '¬øVaciar carrito?',
            text: "No podr√°s deshacer esta acci√≥n",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ea580c',
            cancelButtonColor: '#334155',
            confirmButtonText: 'S√≠, vaciar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                shoppingCart=[]; saveCart(); updateUI(); renderCart();
                Swal.fire('¬°Vaciado!', 'Tu carrito est√° vac√≠o.', 'success');
            }
        })
    }

    async function confirmAndPlaceOrder() {
        const req=['deliveryName','deliveryPhone','deliveryAddress','deliveryRef'];
        for(const id of req) if(!document.getElementById(id).value.trim()) return showToast('Error: Datos incompletos','danger');
        
        // Doble validaci√≥n por seguridad
        const total = shoppingCart.reduce((s,i)=>s+i.price*i.quantity,0);
        if(total < MIN_ORDER_AMOUNT) return showToast(`Pedido m√≠nimo: $${MIN_ORDER_AMOUNT}`, 'danger');

        document.getElementById('btnPay').innerHTML='<span class="spinner-border spinner-border-sm"></span>'; 
        document.getElementById('btnPay').disabled=true;
        
        const d={ recipientName:document.getElementById('deliveryName').value, recipientPhone:document.getElementById('deliveryPhone').value, address:document.getElementById('deliveryAddress').value, notes:`Ref: ${document.getElementById('deliveryRef').value}. ${document.getElementById('deliveryExtra').value}` };
        
        const itemsToSend = shoppingCart.map(i => ({
            productId: i.productId,
            name: i.name,
            price: i.price,
            quantity: i.quantity
        }));

        const res=await fetchData('placeOrder','POST',{
            clientId:clientData.id, 
            cartItems: itemsToSend, 
            deliveryDetails:d
        });
        
        if(res.success) {
            currentStep=3; updateStepper(); 
            // const total ya calculado arriba
            
            const waMsg=`*NUEVO PEDIDO DL Cumanayagua* üõµ\n------------------\nüë§ CLIENTE: ${clientData.nombre}\nüì¶ Enviar a: ${d.recipientName}\nüìç Direcci√≥n: ${d.address}\nüìû Tel√©fono: ${d.recipientPhone}\n\nüìù RESUMEN:\n${shoppingCart.map(i=>`üõí ${i.name}\n    Cant: ${i.quantity} | Subt: $${(i.price*i.quantity).toFixed(2)}`).join('\n')}\n\n------------------\nüí∞ *TOTAL: $${total.toFixed(2)} CUP*\nüìù Nota: ${d.notes}\n#Pedido: ${res.data.orderId.substr(-4)}`;
            
            document.getElementById('order-placement-feedback').innerHTML=`<div class="py-5"><div class="mb-4 text-success"><i class="bi bi-check-circle-fill display-1"></i></div><h3 class="fw-bold mb-3">¬°Pedido Recibido!</h3><p class="text-muted mb-4">Orden <strong>#${res.data.orderId.substr(-4)}</strong> lista.</p><a href="https://wa.me/5355189657?text=${encodeURIComponent(waMsg)}" class="btn btn-success btn-lg rounded-pill w-100 shadow-lg fw-bold"><i class="bi bi-whatsapp me-2"></i> Confirmar por WhatsApp</a></div>`;
            shoppingCart=[]; saveCart(); updateUI();
        } else { 
            showToast(res.message,'danger'); 
            document.getElementById('btnPay').innerHTML='Confirmar Pedido'; 
            document.getElementById('btnPay').disabled=false; 
        }
    }

    // ==================== L√ìGICA TARJETAS DESLIZABLES (PROMOS STYLE) ====================
    const promoSteps = [
        { 
            title: "üî• ¬°2x1 en Pizzas!", 
            desc: "Solo por hoy, compra una familiar y ll√©vate otra totalmente GRATIS. ¬°Corre que se acaban!", 
            img: "https://i.postimg.cc/QdCNKRg6/meta.jpg",
            btnText: "Pedir Ahora"
        },
        { 
            title: "üöö Env√≠os Flash", 
            desc: "Nuevos repartidores en la zona. Tus pedidos llegan en menos de 20 minutos.", 
            img: "https://i.postimg.cc/K8MqzJYj/Enviosgratisfoto.jpg",
            btnText: "Ver Men√∫"
        },
        { 
            title: "üéÅ Sorteo Semanal", 
            desc: "Realiza un pedido mayor a $1000 CUP y participa por una canasta de productos.", 
            img: "https://i.postimg.cc/mrhQkrjy/ayudaimegen3.jpg",
            btnText: "Participar"
        }
    ];

    window.openPromoSwipe = function() {
        const carouselInner = document.getElementById('promo-carousel-inner');
        carouselInner.innerHTML = promoSteps.map((step, index) => `
            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                <div class="tiktok-card">
                    <img src="${step.img}" class="tiktok-img-bg" alt="${step.title}">
                    
                    <div class="tiktok-overlay">
                        <div class="tiktok-content">
                            <span class="tiktok-badge">Novedad</span>
                            <h2 class="tiktok-title">${step.title}</h2>
                            <p class="tiktok-desc">${step.desc}</p>
                            
                            <button class="tiktok-btn" data-bs-dismiss="modal" onclick="document.getElementById('menu-tab-link').click()">
                                ${step.btnText} <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    ${index < promoSteps.length - 1 ? 
                    `<div class="tiktok-swipe-hint">
                        <i class="bi bi-chevron-compact-right"></i>
                    </div>` : ''}
                </div>
            </div>
        `).join('');
        promoSwipeModal.show();
    }

    // UTILS & PROGRESS BAR LOGIC (LUXURY GAMING)
    function updateUI() {
        const isLogged=!!clientData;
        const toggle=(id,s)=>{const el=document.getElementById(id);if(el)el.style.display=s?(el.id.includes('hero-auth')?'flex':'block'):'none'};
        toggle('hero-guest',!isLogged); toggle('hero-user',isLogged); toggle('logoutButtonNav',isLogged);
        if(isLogged){ document.getElementById('hero-user-name').innerText=clientData.nombre.split(' ')[0]; document.getElementById('auth-buttons-nav').innerHTML=''; }
        else document.getElementById('auth-buttons-nav').innerHTML=`<button class="btn btn-sm btn-outline-dark rounded-pill px-3" onclick="openAuthModal('login')">Acceder</button>`;
        const c=shoppingCart.reduce((s,i)=>s+i.quantity,0);
        document.getElementById('floatingCartButton').style.display=c>0?'flex':'none'; document.getElementById('floating-cart-count').innerText=c;
        
        // ACTUALIZAR BARRA PROGRESO M√çNIMO
        updateMinOrderProgress();
    }
    
    function updateMinOrderProgress() {
        const total = shoppingCart.reduce((s,i)=>s+i.price*i.quantity,0);
        const pill = document.getElementById('min-order-pill');
        const bar = document.getElementById('min-order-bar-fill');
        const text = document.getElementById('min-order-text');
        const percent = document.getElementById('min-order-percent');

        if (total > 0) {
            pill.style.display = 'flex';
            
            let percentage = (total / MIN_ORDER_AMOUNT) * 100;
            if (percentage > 100) percentage = 100;
            
            bar.style.width = `${percentage}%`;
            
            if (total >= MIN_ORDER_AMOUNT) {
                pill.classList.add('completed-anim'); // Borde dorado
                
                // Texto de √©xito
                text.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> <span style="color:#4ade80; text-shadow:0 0 10px rgba(74,222,128,0.5);">¬°M√çNIMO ALCANZADO!</span>';
                percent.innerText = '';
                
                // Barra en verde brillante pulsante
                bar.style.background = 'linear-gradient(90deg, #22c55e 0%, #4ade80 100%)';
                bar.style.boxShadow = '0 0 15px rgba(74, 222, 128, 0.6)';
                
                // Disparar explosi√≥n de part√≠culas una sola vez al llegar
                if (!pill.dataset.exploded) {
                    pill.dataset.exploded = "true";
                    triggerLuxuryExplosion(pill);
                    if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
                }
                
            } else {
                pill.classList.remove('completed-anim');
                pill.dataset.exploded = ""; // Resetear explosi√≥n
                
                const remaining = MIN_ORDER_AMOUNT - total;
                text.innerHTML = `<i class="bi bi-basket text-warning"></i> Faltan $${remaining.toFixed(0)}`;
                percent.innerText = `${Math.round(percentage)}%`;
                
                // Gradiente original "Gaming"
                bar.style.background = 'linear-gradient(90deg, #ff8c00 0%, #ff0080 50%, #7928ca 100%)';
                bar.style.boxShadow = 'none';
            }
        } else {
            pill.style.display = 'none';
            pill.classList.remove('completed-anim');
            pill.dataset.exploded = "";
        }
    }

    function triggerLuxuryExplosion(element) {
        const rect = element.getBoundingClientRect();
        const center = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
        
        // Crear 30 part√≠culas
        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.classList.add('lux-particle');
            document.body.appendChild(particle);
            
            // Color aleatorio (Blanco, Dorado, Verde Neon)
            const colors = ['#ffffff', '#fbbf24', '#4ade80'];
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            
            // Posici√≥n inicial
            particle.style.left = center.x + 'px';
            particle.style.top = center.y + 'px';
            
            // Trayectoria aleatoria
            const angle = Math.random() * Math.PI * 2;
            const velocity = 20 + Math.random() * 60; // Distancia de explosi√≥n
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;
            
            // Animaci√≥n manual con Web Animations API para mejor rendimiento
            const anim = particle.animate([
                { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
            ], {
                duration: 600 + Math.random() * 400,
                easing: 'cubic-bezier(0, .9, .57, 1)'
            });
            
            anim.onfinish = () => particle.remove();
        }
        
        // Flash Effect en la barra
        const flash = document.createElement('div');
        flash.style.position = 'absolute';
        flash.style.top = '0'; flash.style.left = '0';
        flash.style.width = '100%'; flash.style.height = '100%';
        flash.style.background = 'white';
        flash.style.opacity = '0.8';
        flash.style.pointerEvents = 'none';
        flash.style.mixBlendMode = 'overlay';
        element.appendChild(flash);
        
        const flashAnim = flash.animate([
            { opacity: 0.8 }, { opacity: 0 }
        ], { duration: 300 });
        
        flashAnim.onfinish = () => flash.remove();
    }

    // ==================== FOMO LOGIC (SOCIAL PROOF) ====================
    
    // Fake names/locations for backup
    const fakeFomoNames = ["Maria", "Pedro", "Ana", "Carlos", "Luis", "Yude", "Ale", "Sof√≠a", "Jorge", "Dayana", "Michel", "Yuniel", "Yanisleidi", "Yoandri", "L√°zaro", "Yordanis", "Yulieski", "Dianelis", "Maikel", "Yusniel", "B√°rbaro", "Yanet", "Reinier", "Yaima", "Geovanis", "Mimi", "Tito", "Neno"];
    const fakeFomoLocations = ["Cumanayagua", "El Tablon", "Las Brisas", "Rafaelitos", "Calle 50", "La Campanita", "Parque Marti", "Calle Nueva", "Calle Orlando G√≥mez e/ Arqu√≠mides y Cienfuegos", "Calle Los Filtros, Cumanayagua", "Calle Independencia e/ Maceo y Mart√≠, Cumanayagua", "Calle Rafael Trejo e/ 24 de Febrero y Agramonte", "Calle Cienfuegos e/ Orlando G√≥mez y 24 de Febrero, Cumanayagua", "Entronque"];

    let realFomoQueue = [];
    let fomoIndex = 0;

    async function startFomoLoop() {
        // 1. Intentar cargar datos reales del backend
        await loadRealFomoData();

        // 2. Iniciar el ciclo de notificaciones
        scheduleNextFomo();
    }

    async function loadRealFomoData() {
        // Llamada silenciosa al backend
        const res = await fetchData('getFomoData', 'GET', null, true); // true = silent (sin spinner)
        
        if (res.success && res.data && res.data.length > 0) {
            // Filtramos solo pedidos de las √∫ltimas 24 horas (1440 minutos) para que sea relevante
            realFomoQueue = res.data.filter(item => item.minsAgo < 1440);
        }
    }

    function scheduleNextFomo() {
        // Tiempo aleatorio entre 15 y 40 segundos
        const nextTime = Math.random() * (40000 - 15000) + 15000;
        setTimeout(showFomoToast, nextTime);
    }

    function showFomoToast() {
        const container = document.getElementById('fomo-container');
        if(!container) return;

        let item;

        // ESTRATEGIA DE MEZCLA:
        if (realFomoQueue.length > 0) {
            // Usar dato real (c√≠clico)
            item = realFomoQueue[fomoIndex % realFomoQueue.length];
            fomoIndex++;
        } else {
            // Usar dato fake CON PRODUCTO REAL
            let prodName = "Oferta Especial";
            if (menuItems && menuItems.length > 0) {
                const randomProd = menuItems[Math.floor(Math.random() * menuItems.length)];
                prodName = randomProd.name;
            }
            
            item = {
                name: fakeFomoNames[Math.floor(Math.random() * fakeFomoNames.length)],
                product: prodName,
                location: fakeFomoLocations[Math.floor(Math.random() * fakeFomoLocations.length)],
                minsAgo: Math.floor(Math.random() * 53) + 2
            };
        }

        // Formatear el tiempo "Hace X"
        let timeText = "Hace un momento";
        if (item.minsAgo > 0) {
            if (item.minsAgo < 60) {
                timeText = `Hace ${item.minsAgo} min`;
            } else {
                const hours = Math.floor(item.minsAgo / 60);
                timeText = `Hace ${hours} ${hours === 1 ? 'hora' : 'horas'}`;
            }
        }

        // Crear el Toast
        const toast = document.createElement('div');
        toast.className = 'fomo-toast';
        // Animaci√≥n de entrada
        toast.style.animation = "slideInLeft 0.5s ease forwards"; 
        
        toast.innerHTML = `
            <div class="fomo-icon"><i class="bi bi-bag-check-fill"></i></div>
            <div>
                <div class="fw-bold" style="font-size:0.75rem; color:#cbd5e1; text-transform:uppercase; letter-spacing:0.5px;">
                    ${timeText}
                </div>
                <div style="font-size:0.9rem; line-height:1.2; margin-top:2px;">
                    <span class="text-white fw-bold">${item.name}</span> compr√≥ <span class="text-warning fw-bold">${item.product}</span><span class="text-white fw-bold">, entre otras cosas...</span>
                </div>
                <div style="font-size:0.75rem; color:rgba(255,255,255,0.5); margin-top:2px;">
                    <i class="bi bi-geo-alt-fill me-1"></i>${item.location}
                </div>
            </div>
        `;

        // Limpiar anteriores
        container.innerHTML = ''; 
        container.appendChild(toast);

        // Eliminar y programar el siguiente
        setTimeout(() => {
            // Animaci√≥n de salida manual antes de eliminar
            toast.style.animation = "fadeOut 0.5s ease forwards";
            setTimeout(() => { 
                if(toast.parentElement) toast.remove(); 
                scheduleNextFomo(); // Programar el siguiente solo cuando este termine
            }, 500);
        }, 5000); // 5 segundos visible
    }

    function addToCart(id) { if(!clientData)return window.openAuthModal('login'); const p=menuItems.find(x=>x.id===id), item=shoppingCart.find(x=>x.productId===id); if(item)item.quantity++; else shoppingCart.push({productId:id,name:p.name,price:p.price,quantity:1}); saveCart(); updateUI(); showToast('A√±adido al carrito'); }
    function updateQty(id,d) { const item=shoppingCart.find(x=>x.productId===id); if(item){item.quantity+=d; if(item.quantity<=0)removeFromCart(id); else{saveCart(); renderCart(); updateUI();}} }
    function removeFromCart(id) { shoppingCart=shoppingCart.filter(x=>x.productId!==id); saveCart(); renderCart(); updateUI(); }
    function saveCart(){localStorage.setItem(USER_CART_KEY,JSON.stringify(shoppingCart))}
    function loadCart(){shoppingCart=JSON.parse(localStorage.getItem(USER_CART_KEY))||[]}
    function saveClientData(){localStorage.setItem(LOGGED_IN_CLIENT_KEY,JSON.stringify(clientData))}
    function loadClientData(){try{clientData=JSON.parse(localStorage.getItem(LOGGED_IN_CLIENT_KEY))}catch(e){}}
    function logoutClient(){clientData=null;localStorage.removeItem(LOGGED_IN_CLIENT_KEY);updateUI()}
    async function handleLoginAttempt(){const res=await fetchData('loginUser','POST',{telefono:document.getElementById('loginPhone').value,password:document.getElementById('loginPassword').value});if(res.success){clientData=res.data;saveClientData();updateUI();authModal.hide()}else document.getElementById('login-feedback').innerText=res.message}
    async function handleUserRegistrationAttempt(){const res=await fetchData('registerNewUser','POST',{nombre:document.getElementById('newUserName').value,telefono:document.getElementById('newUserPhone').value,email:document.getElementById('newUserEmail').value,password:document.getElementById('newUserPassword').value});if(res.success)document.getElementById('registration-feedback').innerHTML='<span class="text-success">¬°Cuenta creada!</span>';else document.getElementById('registration-feedback').innerText=res.message}
    
    // ==================== FUNCI√ìN DE RECARGA TOTAL ====================
    async function forceFullCacheRefresh() {
        if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (let registration of registrations) {
                await registration.unregister();
            }
        }
        if ('caches' in window) {
            const keys = await caches.keys();
            await Promise.all(keys.map(key => caches.delete(key)));
        }
        
        window.location.reload(true);
    }

    function showToast(msg,type='success'){
        const t=document.createElement('div');
        const bgClass = type === 'success' ? 'bg-success' : `bg-${type}`;
        t.className=`toast show align-items-center text-white ${bgClass} border-0 shadow-lg`;
        t.style.borderRadius = "50px";
        t.style.marginBottom = "10px";
        t.innerHTML=`<div class="d-flex py-2 px-3"><div class="toast-body fw-bold">${msg}</div></div>`;
        document.getElementById('toastPlacement').appendChild(t);
        setTimeout(()=>t.remove(),3000)
    }

    function copyPageLink(btn){navigator.clipboard.writeText(FIXED_SHARE_URL);const o=btn.innerText;btn.innerText="¬°Copiado!";setTimeout(()=>btn.innerText=o,2000)} 
</script>
</body>
</html>
