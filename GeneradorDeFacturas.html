<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas MIPYME</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÑ</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primario: #2c3e50;
            --color-secundario: #3498db;
            --color-mipyme: #1a5276;
            --color-danger: #e74c3c;
        }
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #f0f2f5; 
            color: #333; 
        }
        .container-fluid {
            padding: 0;
        }
        .invoice-container { 
            background: white; 
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            border: none;
            min-height: 100vh;
        }
        @media (min-width: 768px) {
            .container-fluid {
                padding: 1.5rem;
            }
            .invoice-container {
                margin: 0 auto;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                border: 1px solid #eee;
            }
        }

        .invoice-header { 
            background: var(--color-primario); 
            color: white; 
            padding: 1rem; 
            position: relative; 
        }
        .invoice-header h2 {
            font-size: 1.25rem;
        }
        .mipyme-badge { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            background-color: var(--color-mipyme); 
            color: white; 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 12px; 
            text-transform: uppercase; 
        }
        .nav-tabs {
            border-bottom: 1px solid #dee2e6;
            flex-wrap: nowrap;
            overflow-x: auto;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .nav-tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        .nav-tabs .nav-item {
            flex-shrink: 0;
        }
        .nav-tabs .nav-link { 
            font-weight: 600; 
            color: var(--color-primario); 
            border: none; 
            padding: 12px 15px; 
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .nav-tabs .nav-link.active { 
            background: transparent; 
            color: var(--color-mipyme); 
            font-weight: 700; 
            border-bottom: 3px solid var(--color-mipyme); 
        }
        .tab-content { padding: 1.25rem; }
        
        h5 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-primario);
        }

        .invoice-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .invoice-table th { background-color: var(--color-mipyme); color: white; padding: 10px; text-align: left; }
        .invoice-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .invoice-table input { min-width: 70px; }
        .invoice-table .form-control-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        
        .btn-gestion-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .signature-container { border-top: 2px dashed #ccc; padding-top: 20px; margin-top: 30px; }
        .signature-box { text-align: center; margin-top: 30px; }
        .signature-line { border-top: 1px solid #333; width: 80%; margin: 0 auto; padding-top: 5px; }

        .template-card { cursor: pointer; transition: all 0.2s ease-in-out; }
        .template-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }

        /* Estilos de Plantillas */
        .template-classic .invoice-header { background: linear-gradient(135deg, #2c3e50, #4a6b8a); }
        .template-classic .invoice-table th { background: linear-gradient(135deg, #1a5276, #2874a6); }
        .template-modern .invoice-header { background: linear-gradient(135deg, #1a5276, #3498db); border-bottom: 5px solid var(--color-mipyme); }
        .template-modern .invoice-table th { background: var(--color-mipyme); }
        .template-horizontal .invoice-header { background: var(--color-mipyme); border-bottom: 3px solid var(--color-primario); }
        .template-horizontal .invoice-table th { background: var(--color-primario); }
        .template-premium .invoice-header { background: linear-gradient(90deg, #c0a062, #d4b57a); }
        .template-premium .invoice-table th { background: #333; color: #d4b57a;}
        .template-minimalist .invoice-header { background: #fff; border-bottom: 2px solid #111;}
        .template-minimalist .invoice-header h2 { color: #111; }
        .template-minimalist .invoice-table th { background: #fff; color: #111; border-bottom: 1px solid #111; }
        .template-creative .invoice-header { background: #4a4a4a; }
        .template-creative .invoice-table th { background: #3498db; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="invoice-container" id="invoiceContainer">
            <div class="invoice-header d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-file-invoice me-2"></i> FACTURA COMERCIAL</h2>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <div class="input-group input-group-sm" style="width: 180px;"><span class="input-group-text">No.</span><input type="text" class="form-control" id="numeroFactura" placeholder="001-001-0001"></div>
                        <div class="input-group input-group-sm" style="width: 160px;"><span class="input-group-text">Fecha</span><input type="date" class="form-control" id="fechaFactura"></div>
                    </div>
                </div>
                <div class="mipyme-badge d-none d-md-block">MIPYME</div>
            </div>

            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="factura-tab" data-bs-toggle="tab" data-bs-target="#factura" type="button">Factura</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="empresa-tab" data-bs-toggle="tab" data-bs-target="#empresa" type="button">Empresa</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="vendedor-tab" data-bs-toggle="tab" data-bs-target="#vendedor" type="button">Vendedor</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="plantillas-tab" data-bs-toggle="tab" data-bs-target="#plantillas" type="button">Plantillas</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="factura" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <h5><i class="fas fa-building me-2"></i> Empresa Emisora</h5>
                            <div id="datosEmpresaDisplay" class="bg-light p-3 rounded small"></div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <h5><i class="fas fa-user-tie me-2"></i> Vendedor</h5>
                             <div id="datosVendedorDisplay" class="bg-light p-3 rounded small"></div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                            <h5><i class="fas fa-user me-2"></i> Datos del Cliente</h5>
                            <div class="btn-gestion-group">
                                <button class="btn btn-primary btn-sm" id="guardarCliente"><i class="fas fa-save me-1"></i> Guardar</button>
                                <button class="btn btn-info btn-sm" id="nuevoCliente"><i class="fas fa-plus me-1"></i> Nuevo</button>
                                <button class="btn btn-danger btn-sm" id="eliminarCliente"><i class="fas fa-trash me-1"></i> Eliminar</button>
                            </div>
                        </div>
                         <div class="mb-2">
                            <label for="clienteSelector" class="form-label small">Seleccionar Cliente:</label>
                            <select class="form-select form-select-sm" id="clienteSelector"></select>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6"><input type="text" class="form-control form-control-sm" id="clienteNombre" placeholder="Nombre/Raz√≥n Social"></div>
                            <div class="col-md-6"><input type="text" class="form-control form-control-sm" id="clienteIdentificacion" placeholder="RUC/C√©dula"></div>
                            <div class="col-12"><input type="text" class="form-control form-control-sm" id="clienteDireccion" placeholder="Direcci√≥n"></div>
                            <div class="col-md-6"><input type="text" class="form-control form-control-sm" id="clienteTelefono" placeholder="Tel√©fono"></div>
                            <div class="col-md-6"><input type="email" class="form-control form-control-sm" id="clienteEmail" placeholder="Email"></div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <h5><i class="fas fa-boxes me-2"></i> Productos/Servicios</h5>
                        <div class="btn-gestion-group">
                            <button class="btn btn-primary btn-sm" id="agregarProducto"><i class="fas fa-plus me-1"></i> Agregar</button>
                            <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalImportar"><i class="fas fa-file-import me-1"></i> Importar</button>
                            <button class="btn btn-danger btn-sm" id="limpiarProductos"><i class="fas fa-broom me-1"></i> Limpiar</button>
                        </div>
                    </div>
                    <div class="table-responsive mb-4">
                        <table class="invoice-table">
                            <thead><tr><th>Descripci√≥n</th><th>Cant.</th><th>P. Unit.</th><th>Desc. %</th><th>Total</th><th></th></tr></thead>
                            <tbody id="listaProductos"></tbody>
                        </table>
                    </div>
                    <div class="row justify-content-end">
                        <div class="col-md-8 col-lg-6">
                            <div class="bg-light p-3 rounded">
                                <div class="d-flex justify-content-between mb-2"><span>Subtotal:</span><span id="subtotal">$0.00</span></div>
                                <div class="d-flex justify-content-between mb-2"><span>Descuento:</span><span id="descuentoTotal">$0.00</span></div>
                                <hr>
                                <div class="d-flex justify-content-between fw-bold fs-5"><span>TOTAL:</span><span id="total">$0.00</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4"><label class="form-label">Notas Adicionales:</label><textarea class="form-control" id="notasFactura" rows="2" placeholder="Condiciones de pago, garant√≠as, etc."></textarea></div>
                    <div class="signature-container">
                        <div class="row">
                            <div class="col-md-4 signature-box"><div class="mb-2">Firma Vendedor</div><div class="signature-line"></div><div class="small text-muted mt-1" id="nombreVendedorFirma"></div></div>
                            <div class="col-md-4 signature-box"><div class="mb-2">Firma Representante</div><div class="signature-line"></div><div class="small text-muted mt-1" id="nombreDue√±oFirma"></div></div>
                            <div class="col-md-4 signature-box"><div class="mb-2">Firma Cliente</div><div class="signature-line"></div><div class="small text-muted mt-1" id="nombreClienteFirma"></div></div>
                        </div>
                    </div>
                    <div class="text-center my-4"><button class="btn btn-danger btn-lg" id="generarFactura"><i class="fas fa-file-pdf me-2"></i> Generar Factura (PDF)</button></div>
                </div>

                <div class="tab-pane fade" id="empresa" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <h5 class="mb-0"><i class="fas fa-building me-2"></i> Datos de la Empresa</h5>
                        <div class="btn-gestion-group">
                            <button class="btn btn-primary btn-sm" id="guardarDatosEmpresa"><i class="fas fa-save me-1"></i> Guardar</button>
                            <button class="btn btn-info btn-sm" id="nuevaEmpresa"><i class="fas fa-plus me-1"></i> Nueva</button>
                             <button class="btn btn-danger btn-sm" id="eliminarEmpresa"><i class="fas fa-trash me-1"></i> Eliminar</button>
                        </div>
                    </div>
                     <div class="mb-3">
                        <label for="empresaSelector" class="form-label">Seleccionar Perfil de Empresa:</label>
                        <select class="form-select" id="empresaSelector"></select>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">Nombre/Raz√≥n Social</label><input type="text" class="form-control" id="empresaNombre"></div>
                        <div class="col-md-6"><label class="form-label">RUC</label><input type="text" class="form-control" id="empresaRuc"></div>
                        <div class="col-12"><label class="form-label">Direcci√≥n</label><input type="text" class="form-control" id="empresaDireccion"></div>
                        <div class="col-md-6"><label class="form-label">Tel√©fono</label><input type="text" class="form-control" id="empresaTelefono"></div>
                        <div class="col-md-6"><label class="form-label">Email</label><input type="email" class="form-control" id="empresaEmail"></div>
                        <div class="col-md-6"><label class="form-label">Nombre del Representante</label><input type="text" class="form-control" id="empresaRepresentante"></div>
                        <div class="col-md-6"><label class="form-label">Cargo del Representante</label><input type="text" class="form-control" id="empresaCargo"></div>
                    </div>
                </div>

                <div class="tab-pane fade" id="vendedor" role="tabpanel">
                     <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i> Datos del Vendedor</h5>
                        <div class="btn-gestion-group">
                            <button class="btn btn-primary btn-sm" id="guardarDatosVendedor"><i class="fas fa-save me-1"></i> Guardar</button>
                             <button class="btn btn-info btn-sm" id="nuevoVendedor"><i class="fas fa-plus me-1"></i> Nuevo</button>
                             <button class="btn btn-danger btn-sm" id="eliminarVendedor"><i class="fas fa-trash me-1"></i> Eliminar</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="vendedorSelector" class="form-label">Seleccionar Perfil de Vendedor:</label>
                        <select class="form-select" id="vendedorSelector"></select>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">Nombre Completo</label><input type="text" class="form-control" id="vendedorNombre"></div>
                        <div class="col-md-6"><label class="form-label">Identificaci√≥n</label><input type="text" class="form-control" id="vendedorIdentificacion"></div>
                        <div class="col-md-6"><label class="form-label">Tel√©fono</label><input type="text" class="form-control" id="vendedorTelefono"></div>
                        <div class="col-md-6"><label class="form-label">Email</label><input type="email" class="form-control" id="vendedorEmail"></div>
                        <div class="col-12"><label class="form-label">Firma Digital (URL)</label><input type="text" class="form-control" id="vendedorFirma" placeholder="https://..."><small class="text-muted">Puede ser un enlace a una imagen de la firma</small></div>
                    </div>
                </div>

                <div class="tab-pane fade" id="plantillas" role="tabpanel">
                    <h5 class="mb-4"><i class="fas fa-palette me-2"></i> Selecciona un Dise√±o</h5>
                    <div class="row">
                        <div class="col-md-4 mb-4"><div class="card template-card" data-template="classic"><div class="card-body text-center"><div class="template-preview mb-3" style="height: 150px; background: linear-gradient(135deg, #f5f5f5, #e0e0e0); border: 1px solid #ddd;"><div style="height: 30%; background: linear-gradient(135deg, #2c3e50, #4a6b8a);"></div><div style="height: 70%; position: relative;"><div style="position: absolute; top: 10px; right: 10px; background-color: #1a5276; color: white; padding: 2px 10px; font-size: 10px; border-radius: 10px;">MIPYME</div></div></div><h6>Cl√°sico Profesional</h6><p class="small text-muted">Dise√±o tradicional con secciones definidas</p><button class="btn btn-sm btn-outline-primary seleccionar-plantilla">Seleccionar</button></div></div></div>
                        <div class="col-md-4 mb-4"><div class="card template-card" data-template="modern"><div class="card-body text-center"><div class="template-preview mb-3" style="height: 150px; background: white; border: 1px solid #ddd;"><div style="height: 25%; background: linear-gradient(135deg, #1a5276, #3498db); border-bottom: 5px solid #1a5276; position: relative;"><div style="position: absolute; top: 5px; right: 5px; background-color: #1a5276; color: white; padding: 2px 8px; font-size: 10px; border-radius: 10px;">MIPYME</div></div><div style="height: 75%;"></div></div><h6>Moderno MIPYME</h6><p class="small text-muted">Estilo contempor√°neo con colores institucionales</p><button class="btn btn-sm btn-outline-primary seleccionar-plantilla">Seleccionar</button></div></div></div>
                        <div class="col-md-4 mb-4"><div class="card template-card" data-template="horizontal"><div class="card-body text-center"><div class="template-preview mb-3" style="height: 150px; background: white; border: 1px solid #ddd;"><div style="height: 20%; background: #1a5276; border-bottom: 3px solid #2c3e50; position: relative;"><div style="position: absolute; top: 5px; right: 5px; background-color: #2c3e50; color: white; padding: 2px 8px; font-size: 10px; border-radius: 10px;">MIPYME</div></div><div style="height: 80%;"></div></div><h6>Horizontal Corporativo</h6><p class="small text-muted">Dise√±o limpio con estructura horizontal</p><button class="btn btn-sm btn-outline-primary seleccionar-plantilla">Seleccionar</button></div></div></div>
                        <div class="col-md-4 mb-4"><div class="card template-card" data-template="premium"><div class="card-body text-center"><div class="template-preview mb-3" style="height: 150px; background: #f4f4f4; border: 1px solid #ddd; display: flex; flex-direction: column; justify-content: space-between;"><div style="height: 10px; background: linear-gradient(90deg, #c0a062, #d4b57a);"></div><div style="font-family: 'Playfair Display', serif; font-size: 14px; color: #333;">Factura</div><div style="height: 5px; background: #333;"></div></div><h6>Premium Gold</h6><p class="small text-muted">Dise√±o elegante con detalles dorados y tipograf√≠a serif.</p><button class="btn btn-sm btn-outline-primary seleccionar-plantilla">Seleccionar</button></div></div></div>
                        <div class="col-md-4 mb-4"><div class="card template-card" data-template="minimalist"><div class="card-body text-center"><div class="template-preview mb-3" style="height: 150px; background: white; border: 1px solid #eee; padding: 10px; text-align: left;"><div style="width: 40px; height: 5px; background: #111; margin-bottom: 10px;"></div><div style="height: 2px; background: #eee; margin-bottom: 3px;"></div><div style="height: 2px; background: #eee; margin-bottom: 3px;"></div><div style="height: 2px; background: #eee; width: 70%;"></div></div><h6>Minimalista Moderno</h6><p class="small text-muted">Enfoque en la tipograf√≠a y el espacio en blanco. Limpio y directo.</p><button class="btn btn-sm btn-outline-primary seleccionar-plantilla">Seleccionar</button></div></div></div>
                        <div class="col-md-4 mb-4"><div class="card template-card" data-template="creative"><div class="card-body text-center"><div class="template-preview mb-3" style="height: 150px; background: white; border: 1px solid #ddd; display: flex;"><div style="width: 30%; background: #4a4a4a; color: white; padding: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><div style="width: 20px; height: 20px; border-radius: 50%; background: #3498db; margin-bottom: 5px;"></div><div style="font-size: 10px; text-transform: uppercase;">Factura</div></div><div style="width: 70%; padding: 10px;"></div></div><h6>Creativo con Barra Lateral</h6><p class="small text-muted">Dise√±o asim√©trico con una barra lateral para datos clave.</p><button class="btn btn-sm btn-outline-primary seleccionar-plantilla">Seleccionar</button></div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalImportar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Importar Productos</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    <p>Formato: <code>Descripci√≥n | Cantidad | Precio | Descuento%</code></p>
                    <textarea class="form-control" id="productosImportar" rows="8" placeholder="Ejemplo:
Producto 1 | 2 | 25.00 | 10
Producto 2 | 1 | 100.00
Servicio 3 | 3 | 50.00 | 15"></textarea>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="importarProductos">Importar</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        const { jsPDF } = window.jspdf;
        
        document.addEventListener('DOMContentLoaded', function() {
            let facturasCount = localStorage.getItem('facturasCount') || 1;
            let plantillaActual = localStorage.getItem('plantillaFactura') || 'classic';
            
            const empresaFields = { empresaNombre: 'nombre', empresaRuc: 'ruc', empresaDireccion: 'direccion', empresaTelefono: 'telefono', empresaEmail: 'email', empresaRepresentante: 'representante', empresaCargo: 'cargo' };
            const vendedorFields = { vendedorNombre: 'nombre', vendedorIdentificacion: 'identificacion', vendedorTelefono: 'telefono', vendedorEmail: 'email', vendedorFirma: 'firma' };
            const clienteFields = { clienteNombre: 'nombre', clienteIdentificacion: 'identificacion', clienteDireccion: 'direccion', clienteTelefono: 'telefono', clienteEmail: 'email' };
            
            cargarPerfilesEmpresa();
            cargarPerfilesVendedor();
            cargarPerfilesCliente();
            cargarProductosGuardados();
            
            setFechaActual();
            generarNumeroFactura();
            
            aplicarPlantilla(plantillaActual);
            
            // --- EVENT LISTENERS GENERALES ---
            document.getElementById('importarProductos').addEventListener('click', importarProductos);
            document.getElementById('generarFactura').addEventListener('click', generarPDF);
            document.getElementById('agregarProducto').addEventListener('click', () => agregarFilaProducto());
            document.getElementById('limpiarProductos').addEventListener('click', limpiarProductos);
            
            document.getElementById('listaProductos').addEventListener('input', guardarProductos);


            document.querySelectorAll('.seleccionar-plantilla').forEach(boton => {
                boton.addEventListener('click', function() {
                    const plantilla = this.closest('.template-card').dataset.template;
                    aplicarPlantilla(plantilla);
                    localStorage.setItem('plantillaFactura', plantilla);
                    alert(`Plantilla "${plantilla}" seleccionada y guardada.`);
                });
            });

            // --- GESTI√ìN DE PERFILES ---
            document.getElementById('empresaSelector').addEventListener('change', (e) => cargarDatosFormularioEmpresa(e.target.value));
            document.getElementById('guardarDatosEmpresa').addEventListener('click', guardarPerfilEmpresa);
            document.getElementById('nuevaEmpresa').addEventListener('click', limpiarFormularioEmpresa);
            document.getElementById('eliminarEmpresa').addEventListener('click', eliminarPerfilEmpresa);

            document.getElementById('vendedorSelector').addEventListener('change', (e) => cargarDatosFormularioVendedor(e.target.value));
            document.getElementById('guardarDatosVendedor').addEventListener('click', guardarPerfilVendedor);
            document.getElementById('nuevoVendedor').addEventListener('click', limpiarFormularioVendedor);
            document.getElementById('eliminarVendedor').addEventListener('click', eliminarPerfilVendedor);

            document.getElementById('clienteSelector').addEventListener('change', (e) => cargarDatosFormularioCliente(e.target.value));
            document.getElementById('guardarCliente').addEventListener('click', guardarPerfilCliente);
            document.getElementById('nuevoCliente').addEventListener('click', limpiarFormularioCliente);
            document.getElementById('eliminarCliente').addEventListener('click', eliminarPerfilCliente);

            // --- FUNCIONES ---

            function aplicarPlantilla(plantilla) {
                const container = document.getElementById('invoiceContainer');
                container.className = 'invoice-container';
                container.classList.add(`template-${plantilla}`);
                plantillaActual = plantilla;
            }

            function generarNumeroFactura() {
                const fecha = new Date();
                const year = fecha.getFullYear().toString().slice(-2);
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const numero = facturasCount.toString().padStart(4, '0');
                document.getElementById('numeroFactura').value = `FAC-${year}${mes}-${numero}`;
            }

            function setFechaActual() {
                const hoy = new Date();
                document.getElementById('fechaFactura').value = hoy.toISOString().split('T')[0];
            }

                       function agregarFilaProducto(descripcion = '', cantidad = 1, precio = 0, descuento = 0) {
                const tbody = document.getElementById('listaProductos');
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td><input type="text" class="form-control form-control-sm descripcion" value="${descripcion}"></td>
                    <td><input type="number" class="form-control form-control-sm cantidad" value="${cantidad}" min="1"></td>
                    <td><input type="number" class="form-control form-control-sm precio" value="${precio.toFixed(2)}" min="0" step="0.01"></td>
                    <td><input type="number" class="form-control form-control-sm descuento" value="${descuento}" min="0" max="100" step="1"></td>
                    <td class="total-item text-end fw-bold">${(cantidad * precio * (1 - descuento/100)).toFixed(2)}</td>
                    <td class="text-center"><button class="btn btn-sm btn-link text-danger eliminar-producto"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(fila);
                
                // --- INICIO DE LA MODIFICACI√ìN ---
                // Seleccionar todo el contenido del input al hacer focus para una edici√≥n r√°pida
                fila.querySelectorAll('input').forEach(input => {
                    input.addEventListener('focus', event => event.target.select());
                });
                // --- FIN DE LA MODIFICACI√ìN ---

                fila.querySelectorAll('input').forEach(input => input.addEventListener('input', () => {
                    calcularTotales();
                    guardarProductos();
                }));
                fila.querySelector('.eliminar-producto').addEventListener('click', () => {
                    fila.remove();
                    calcularTotales();
                    guardarProductos();
                    if(tbody.rows.length === 0) agregarFilaProducto();
                });
                
                calcularTotales();
            }

            function calcularTotales() {
                let subtotal = 0;
                let descuentoTotal = 0;
                
                document.querySelectorAll('#listaProductos tr').forEach(fila => {
                    const cantidad = parseFloat(fila.querySelector('.cantidad').value) || 0;
                    const precio = parseFloat(fila.querySelector('.precio').value) || 0;
                    const descuento = parseFloat(fila.querySelector('.descuento').value) || 0;
                    const totalSinDescuento = cantidad * precio;
                    const totalConDescuento = totalSinDescuento * (1 - descuento/100);
                    fila.querySelector('.total-item').textContent = totalConDescuento.toFixed(2);
                    subtotal += totalSinDescuento;
                    descuentoTotal += (totalSinDescuento - totalConDescuento);
                });
                
                const total = subtotal - descuentoTotal;
                
                document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
                document.getElementById('descuentoTotal').textContent = `$${descuentoTotal.toFixed(2)}`;
                document.getElementById('total').textContent = `$${total.toFixed(2)}`;
            }

            function importarProductos() {
                const texto = document.getElementById('productosImportar').value.trim();
                if (!texto) return;

                const primeraFilaInput = document.querySelector('#listaProductos tr:first-child .descripcion');
                if (document.querySelectorAll('#listaProductos tr').length === 1 && primeraFilaInput && primeraFilaInput.value === '') {
                     document.querySelector('#listaProductos tr:first-child').remove();
                }
                
                texto.split('\n').forEach(linea => {
                    const partes = linea.split('|').map(p => p.trim());
                    if (partes.length >= 2) {
                        agregarFilaProducto(partes[0], parseFloat(partes[1]) || 1, parseFloat(partes[2]) || 0, parseFloat(partes[3]) || 0);
                    }
                });
                
                bootstrap.Modal.getInstance(document.getElementById('modalImportar')).hide();
                document.getElementById('productosImportar').value = '';
                guardarProductos();
            }
            
            function guardarProductos() {
                const productos = [];
                document.querySelectorAll('#listaProductos tr').forEach(fila => {
                    const producto = {
                        descripcion: fila.querySelector('.descripcion').value,
                        cantidad: fila.querySelector('.cantidad').value,
                        precio: fila.querySelector('.precio').value,
                        descuento: fila.querySelector('.descuento').value,
                    };
                    productos.push(producto);
                });
                localStorage.setItem('productosFactura', JSON.stringify(productos));
            }

            function cargarProductosGuardados() {
                const productosGuardados = JSON.parse(localStorage.getItem('productosFactura'));
                if (productosGuardados && productosGuardados.length > 0) {
                    document.getElementById('listaProductos').innerHTML = '';
                    productosGuardados.forEach(p => {
                        agregarFilaProducto(p.descripcion, parseFloat(p.cantidad), parseFloat(p.precio), parseFloat(p.descuento));
                    });
                } else {
                     if (document.getElementById('listaProductos').rows.length === 0) {
                        agregarFilaProducto();
                    }
                }
            }
            
            function limpiarProductos() {
                if(confirm('¬øEst√° seguro de que desea eliminar todos los productos de la lista?')){
                    document.getElementById('listaProductos').innerHTML = '';
                    agregarFilaProducto();
                    guardarProductos();
                    calcularTotales();
                }
            }


            function cargarPerfiles(key, selectorId, displayFn, requiredField) {
                const perfiles = JSON.parse(localStorage.getItem(key)) || [];
                const selector = document.getElementById(selectorId);
                selector.innerHTML = '<option value="">Seleccione o cree uno nuevo...</option>';
                perfiles.forEach(perfil => {
                    const option = document.createElement('option');
                    option.value = perfil.id;
                    option.textContent = `${perfil.nombre} (${perfil[requiredField]})`;
                    selector.appendChild(option);
                });
                const ultimoIdKey = `ultimo${key.charAt(0).toUpperCase() + key.slice(1, -5)}Id`;
                const ultimoId = localStorage.getItem(ultimoIdKey);
                
                if (ultimoId && perfiles.some(p => p.id == ultimoId)) {
                    selector.value = ultimoId;
                }
                displayFn(selector.value);
            }

            function cargarPerfilesEmpresa() { cargarPerfiles('empresasData', 'empresaSelector', cargarDatosFormularioEmpresa, 'ruc'); }
            function cargarPerfilesVendedor() { cargarPerfiles('vendedoresData', 'vendedorSelector', cargarDatosFormularioVendedor, 'identificacion'); }
            function cargarPerfilesCliente() { cargarPerfiles('clientesData', 'clienteSelector', cargarDatosFormularioCliente, 'identificacion'); }
            
            function cargarDatosFormulario(id, key, fields, displayFn) {
                const perfiles = JSON.parse(localStorage.getItem(key)) || [];
                const perfil = perfiles.find(p => p.id == id) || {};
                for (const fieldId in fields) {
                    document.getElementById(fieldId).value = perfil[fields[fieldId]] || '';
                }
                displayFn(perfil);
                const ultimoIdKey = `ultimo${key.charAt(0).toUpperCase() + key.slice(1, -5)}Id`;
                if (id) localStorage.setItem(ultimoIdKey, id);
            }

            function cargarDatosFormularioEmpresa(id) { cargarDatosFormulario(id, 'empresasData', empresaFields, actualizarDisplayEmpresa); }
            function cargarDatosFormularioVendedor(id) { cargarDatosFormulario(id, 'vendedoresData', vendedorFields, actualizarDisplayVendedor); }
            function cargarDatosFormularioCliente(id) { cargarDatosFormulario(id, 'clientesData', clienteFields, p => { document.getElementById('nombreClienteFirma').textContent = p.nombre || ''; }); }

            function limpiarFormulario(selectorId, loadFn) {
                document.getElementById(selectorId).value = "";
                loadFn("");
            }

            function limpiarFormularioEmpresa() { limpiarFormulario('empresaSelector', cargarDatosFormularioEmpresa); }
            function limpiarFormularioVendedor() { limpiarFormulario('vendedorSelector', cargarDatosFormularioVendedor); }
            function limpiarFormularioCliente() { limpiarFormulario('clienteSelector', cargarDatosFormularioCliente); }

            function guardarPerfil(selectorId, key, fields, required, loadFn, displayFn) {
                const id = document.getElementById(selectorId).value;
                let perfiles = JSON.parse(localStorage.getItem(key)) || [];
                const datos = {};
                for (const fieldId in fields) {
                    datos[fields[fieldId]] = document.getElementById(fieldId).value.trim();
                }

                if (!datos[required.field]) return alert(required.message);

                const existingId = datos.ruc || datos.identificacion;
                const isDuplicate = perfiles.some(p => (p.ruc === existingId || p.identificacion === existingId) && p.id != id);

                if (!id && isDuplicate) {
                    return alert('Ya existe un perfil con esta identificaci√≥n.');
                }

                if (id) {
                    const index = perfiles.findIndex(p => p.id == id);
                    perfiles[index] = { ...perfiles[index], ...datos, id: perfiles[index].id };
                } else {
                    datos.id = Date.now();
                    perfiles.push(datos);
                }
                localStorage.setItem(key, JSON.stringify(perfiles));
                alert('Perfil guardado.');
                const nuevoId = id || datos.id;
                loadFn();
                document.getElementById(selectorId).value = nuevoId;
                cargarDatosFormulario(nuevoId, key, fields, displayFn);
            }

            function guardarPerfilEmpresa() { guardarPerfil('empresaSelector', 'empresasData', empresaFields, { field: 'nombre', message: 'El nombre de la empresa es obligatorio.' }, cargarPerfilesEmpresa, actualizarDisplayEmpresa); }
            function guardarPerfilVendedor() { guardarPerfil('vendedorSelector', 'vendedoresData', vendedorFields, { field: 'nombre', message: 'El nombre del vendedor es obligatorio.' }, cargarPerfilesVendedor, actualizarDisplayVendedor); }
            function guardarPerfilCliente() { guardarPerfil('clienteSelector', 'clientesData', clienteFields, { field: 'nombre', message: 'El nombre del cliente es obligatorio.' }, cargarPerfilesCliente, p => { document.getElementById('nombreClienteFirma').textContent = p.nombre || ''; }); }

            function eliminarPerfil(selectorId, key, message, loadFn) {
                const id = document.getElementById(selectorId).value;
                if (!id || !confirm(message)) return;
                let perfiles = JSON.parse(localStorage.getItem(key)) || [];
                perfiles = perfiles.filter(p => p.id != id);
                localStorage.setItem(key, JSON.stringify(perfiles));
                alert('Perfil eliminado.');
                loadFn();
            }

            function eliminarPerfilEmpresa() { eliminarPerfil('empresaSelector', 'empresasData', '¬øEliminar este perfil de empresa?', cargarPerfilesEmpresa); }
            function eliminarPerfilVendedor() { eliminarPerfil('vendedorSelector', 'vendedoresData', '¬øEliminar este perfil de vendedor?', cargarPerfilesVendedor); }
            function eliminarPerfilCliente() { eliminarPerfil('clienteSelector', 'clientesData', '¬øEliminar este cliente?', cargarPerfilesCliente); }
            
            function actualizarDisplayEmpresa(datos) {
                document.getElementById('datosEmpresaDisplay').innerHTML = `<p class="mb-1"><strong>${datos.nombre || 'N/A'}</strong></p><p class="mb-1">RUC: ${datos.ruc || 'N/A'}</p><p class="mb-1">${datos.direccion || ''}</p><p class="mb-1">Tel: ${datos.telefono || ''} | Email: ${datos.email || ''}</p>${datos.representante ? `<p class="mb-0">Rep.: ${datos.representante} (${datos.cargo || 'Titular'})</p>` : ''}`;
                document.getElementById('nombreDue√±oFirma').textContent = datos.representante || '';
            }
            function actualizarDisplayVendedor(datos) {
                document.getElementById('datosVendedorDisplay').innerHTML = `<p class="mb-1"><strong>${datos.nombre || 'N/A'}</strong></p><p class="mb-1">ID: ${datos.identificacion || 'N/A'}</p><p class="mb-0">Tel: ${datos.telefono || ''} | Email: ${datos.email || ''}</p>`;
                document.getElementById('nombreVendedorFirma').textContent = datos.nombre || '';
            }

            async function generarPDF() {
                const empresaId = document.getElementById('empresaSelector').value;
                const vendedorId = document.getElementById('vendedorSelector').value;
                const clienteNombre = document.getElementById('clienteNombre').value;

                if (!empresaId) return alert('Por favor, seleccione o guarde un perfil de empresa.');
                if (!vendedorId) return alert('Por favor, seleccione o guarde un perfil de vendedor.');
                if (!clienteNombre) return alert('Por favor, ingrese los datos del cliente.');
                
                const productos = Array.from(document.querySelectorAll('#listaProductos tr')).filter(row => row.querySelector('.descripcion').value.trim() !== '');
                if (productos.length === 0) {
                    return alert('Agregue al menos un producto.');
                }
                
                const originalText = document.getElementById('generarFactura').innerHTML;
                document.getElementById('generarFactura').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Generando...';
                document.getElementById('generarFactura').disabled = true;
                
                try {
                    facturasCount++;
                    localStorage.setItem('facturasCount', facturasCount);
                    
                    const empresa = (JSON.parse(localStorage.getItem('empresasData')) || []).find(e => e.id == empresaId);
                    const vendedor = (JSON.parse(localStorage.getItem('vendedoresData')) || []).find(v => v.id == vendedorId);
                    
                    const PRODUCTOS_POR_PAGINA = 22;
                    const lotesDeProductos = [];
                    for (let i = 0; i < productos.length; i += PRODUCTOS_POR_PAGINA) {
                        lotesDeProductos.push(productos.slice(i, i + PRODUCTOS_POR_PAGINA));
                    }

                    const pdf = new jsPDF('p', 'mm', 'letter');
                    const totalPaginas = lotesDeProductos.length;

                    for (let i = 0; i < totalPaginas; i++) {
                        const loteActual = lotesDeProductos[i];
                        const numeroPagina = `P√°gina ${i + 1} de ${totalPaginas}`;

                        const datosPagina = {
                            empresa, vendedor, clienteNombre, 
                            numeroFactura: document.getElementById('numeroFactura').value,
                            fechaFormateada: new Date(document.getElementById('fechaFactura').value + 'T00:00:00').toLocaleDateString('es-ES'),
                            numeroPagina,
                            subtotal: document.getElementById('subtotal').textContent,
                            descuentoTotal: document.getElementById('descuentoTotal').textContent,
                            total: document.getElementById('total').textContent,
                            notas: document.getElementById('notasFactura').value.replace(/\n/g, '<br>')
                        };
                        
                        const paginaHtml = construirHtmlParaPagina(loteActual, datosPagina);
                        
                        const element = document.createElement('div');
                        element.style.position = 'absolute';
                        element.style.left = '-9999px';
                        element.style.width = '210mm';
                        element.style.height = '279.4mm';
                        element.style.boxSizing = 'border-box';
                        element.style.display = 'flex';
                        element.style.flexDirection = 'column';
                        element.style.padding = '15mm';
                        element.style.fontFamily = "'Montserrat', sans-serif";
                        element.style.fontSize = '9px';
                        element.style.color = '#333';
                        element.style.background = '#fff';
                        element.innerHTML = paginaHtml;
                        
                        document.body.appendChild(element);
                        
                        const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false, windowHeight: element.scrollHeight });
                        document.body.removeChild(element);

                        const imgData = canvas.toDataURL('image/png');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        
                        if (i > 0) {
                            pdf.addPage();
                        }
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    }

                    pdf.save(`factura_${document.getElementById('numeroFactura').value}.pdf`);

                } catch (error) {
                    console.error('Error al generar PDF:', error);
                    alert('Error al generar el PDF. Por favor intente nuevamente.');
                } finally {
                    document.getElementById('generarFactura').innerHTML = originalText;
                    document.getElementById('generarFactura').disabled = false;
                }
            }

            function construirHtmlParaPagina(loteProductos, datos) {
                const { empresa, vendedor, clienteNombre, numeroFactura, fechaFormateada, numeroPagina, subtotal, descuentoTotal, total, notas } = datos;
                let headerHtml = '', tablaHtml = '', footerHtml = '';

                // --- TABLA DE PRODUCTOS ---
                let tablaBody = '';
                loteProductos.forEach(fila => {
                    const descripcion = fila.querySelector('.descripcion').value || 'N/A';
                    const cantidad = fila.querySelector('.cantidad').value || '0';
                    const precio = parseFloat(fila.querySelector('.precio').value || 0).toFixed(2);
                    const descuento = fila.querySelector('.descuento').value || '0';
                    const totalItem = fila.querySelector('.total-item').textContent || '0.00';
                    
                    if (plantillaActual === 'premium' || plantillaActual === 'minimalist') {
                        tablaBody += `<tr><td style="padding: 6px 0; border-bottom: 1px solid #eee;">${descripcion}</td><td style="padding: 6px 0; text-align: right; border-bottom: 1px solid #eee;">${cantidad}</td><td style="padding: 6px 0; text-align: right; border-bottom: 1px solid #eee;">${precio}</td><td style="padding: 6px 0; text-align: right; border-bottom: 1px solid #eee;">${totalItem}</td></tr>`;
                    } else if (plantillaActual === 'creative') {
                        tablaBody += `<tr><td style="padding: 6px 0; border-bottom: 1px solid #eee;">${descripcion}<br><small style="color: #777;">${cantidad} x ${precio}</small></td><td style="padding: 6px 0; text-align: right; border-bottom: 1px solid #eee;">${totalItem}</td></tr>`;
                    } else {
                        tablaBody += `<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">${descripcion}</td><td style="padding: 5px; border-bottom: 1px solid #eee; text-align: right;">${cantidad}</td><td style="padding: 5px; border-bottom: 1px solid #eee; text-align: right;">${precio}</td><td style="padding: 5px; border-bottom: 1px solid #eee; text-align: right;">${descuento}%</td><td style="padding: 5px; border-bottom: 1px solid #eee; text-align: right;">${totalItem}</td></tr>`;
                    }
                });

                // --- ESTRUCTURA DE CADA PLANTILLA ---
                if (plantillaActual === 'premium') {
                    headerHtml = `<div style="border-top: 8px solid #c0a062; padding-top: 15px;"><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 20px;"><div><h2 style="font-family: 'Playfair Display', serif; color: #111; margin: 0; font-size: 28px; font-weight: 700;">FACTURA</h2><p style="margin: 0; color: #555;">No. ${numeroFactura} | ${numeroPagina}</p></div><div style="text-align: right;"><p style="margin:0;"><strong>${empresa.nombre}</strong></p><p style="margin:0; color: #555;">${empresa.direccion}</p></div></div><div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 10px 0;"><div><strong style="color: #888; font-size: 8px; text-transform: uppercase;">Cliente</strong><p style="margin:0;">${clienteNombre}</p></div><div><strong style="color: #888; font-size: 8px; text-transform: uppercase;">Vendedor</strong><p style="margin:0;">${vendedor.nombre}</p></div><div><strong style="color: #888; font-size: 8px; text-transform: uppercase;">Fecha</strong><p style="margin:0;">${fechaFormateada}</p></div></div></div>`;
                    tablaHtml = `<table style="width: 100%; border-collapse: collapse; font-size: 9px;"><thead><tr style="color: #888; text-transform: uppercase; font-size: 8px; border-bottom: 1px solid #ccc;"><th style="padding: 8px 0; text-align: left;">Descripci√≥n</th><th style="padding: 8px 0; text-align: right;">Cant.</th><th style="padding: 8px 0; text-align: right;">P. Unit.</th><th style="padding: 8px 0; text-align: right;">Total</th></tr></thead><tbody>${tablaBody}</tbody></table>`;
                    footerHtml = `<div style="margin-top: auto;"><div style="display: flex; justify-content: flex-end; margin-top: 15px;"><div style="width: 250px;"><div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>Subtotal:</span><span>${subtotal}</span></div><div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #555;"><span>Descuento:</span><span>${descuentoTotal}</span></div><div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid #111; font-weight: bold; font-size: 14px;"><span>TOTAL GENERAL:</span><span>${total}</span></div></div></div>${notas ? `<div style="font-size: 8px; color: #555; margin-top: 15px;"><strong>Notas:</strong> ${notas}</div>` : ''}</div>`;
                } else if (plantillaActual === 'minimalist') {
                    headerHtml = `<div style="width: 50px; height: 5px; background: #111; margin-bottom: 20px;"></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 20px;"><div><h2 style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin: 0;">Factura para</h2><p style="margin:0; font-size: 16px; font-weight: 600;">${clienteNombre}</p></div><div style="text-align: right;"><p style="margin:0;"><strong>No.:</strong> ${numeroFactura}</p><p style="margin:0;"><strong>Fecha:</strong> ${fechaFormateada}</p><p style="margin:0;">${numeroPagina}</p></div></div>`;
                    tablaHtml = `<table style="width: 100%; border-collapse: collapse; font-size: 9px;"><thead><tr style="border-bottom: 1px solid #111;"><th style="padding: 6px 0; text-align: left;">DESCRIPCI√ìN</th><th style="padding: 6px 0; text-align: right;">CANT.</th><th style="padding: 6px 0; text-align: right;">PRECIO</th><th style="padding: 6px 0; text-align: right;">TOTAL</th></tr></thead><tbody>${tablaBody}</tbody></table>`;
                    footerHtml = `<div style="margin-top: auto; border-top: 1px solid #111; padding-top: 10px;"><div style="text-align: right; "><p style="margin:0; font-size: 16px; font-weight: 600;">Total General: ${total}</p></div><div style="font-size: 8px; color: #555; margin-top: 15px;"><strong>DE:</strong> ${empresa.nombre} | ${empresa.email}</div></div>`;
                } else if (plantillaActual === 'creative') {
                    // La plantilla creative es un caso especial, se construye toda de una vez
                    return `<div style="display: flex; height: 100%;"><div style="width: 35%; background: #2c3e50; color: white; padding: 20px; display: flex; flex-direction: column;"><h2 style="font-family: 'Playfair Display', serif; margin: 0 0 30px 0; font-size: 24px;">Factura</h2><div style="margin-bottom: 15px;"><strong style="font-size: 9px; text-transform: uppercase; opacity: 0.7;">Facturado a:</strong><p style="margin:0;">${clienteNombre}</p><p style="margin:0;">${document.getElementById('clienteDireccion').value}</p></div><div style="margin-bottom: 15px;"><strong style="font-size: 9px; text-transform: uppercase; opacity: 0.7;">Factura No:</strong><p style="margin:0;">${numeroFactura}</p></div><div style="margin-bottom: 15px;"><strong style="font-size: 9px; text-transform: uppercase; opacity: 0.7;">Fecha:</strong><p style="margin:0;">${fechaFormateada}</p></div><p style="margin-top: 15px; font-size: 9px;">${numeroPagina}</p><div style="margin-top: auto;"><p style="font-size: 8px; opacity: 0.7;">${empresa.nombre}<br>${empresa.ruc}</p></div></div><div style="width: 65%; padding: 20px; display: flex; flex-direction: column;"><h3 style="font-family: 'Playfair Display', serif; margin:0 0 15px 0;">Detalles del Servicio</h3><table style="width: 100%; border-collapse: collapse; font-size: 8px;"><thead><tr style="border-bottom: 1px solid #333;"><th style="padding: 6px 0; text-align: left;">Descripci√≥n</th><th style="padding: 6px 0; text-align: right;">Total</th></tr></thead><tbody>${loteProductos.map(fila => `<tr><td style="padding: 6px 0; border-bottom: 1px solid #eee;">${fila.querySelector('.descripcion').value}<br><small style="color: #777;">${fila.querySelector('.cantidad').value} x ${parseFloat(fila.querySelector('.precio').value).toFixed(2)}</small></td><td style="padding: 6px 0; text-align: right; border-bottom: 1px solid #eee;">${fila.querySelector('.total-item').textContent}</td></tr>`).join('')}</tbody></table><div style="margin-top: auto; border-top: 1px solid #333; padding-top: 10px; text-align: right;"><p style="margin:0 0 5px 0;">Subtotal: ${subtotal}</p><p style="margin:0 0 10px 0;">Descuento: ${descuentoTotal}</p><p style="margin:0; font-size: 14px; font-weight: bold;">Total General: ${total}</p></div></div></div>`;
                } else { // Plantillas por defecto
                    headerHtml = `<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #1a5276;"><div><h2 style="font-family: 'Playfair Display', serif; color: #2c3e50; margin: 0 0 5px 0; font-size: 20px;">FACTURA COMERCIAL</h2><p style="margin: 0; font-size: 9px;"><strong>No.:</strong> ${numeroFactura}</p><p style="margin: 0; font-size: 9px;"><strong>Fecha:</strong> ${fechaFormateada}</p></div><div style="text-align: right;"><div style="background-color: #1a5276; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 11px; text-transform: uppercase; display: inline-block; margin-bottom: 5px;">MIPYME</div><p style="margin: 0; font-weight: bold; font-size: 9px;">${numeroPagina}</p></div></div><div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 9px;"><div style="width: 48%;"><h4 style="font-size: 10px; margin: 0 0 4px 0; font-weight: 700;">EMISOR</h4><p style="margin:0;"><strong>${empresa.nombre}</strong></p><p style="margin:0;">RUC: ${empresa.ruc}</p><p style="margin:0;">${empresa.direccion}</p></div><div style="width: 48%;"><h4 style="font-size: 10px; margin: 0 0 4px 0; font-weight: 700;">CLIENTE</h4><p style="margin:0;"><strong>${clienteNombre}</strong></p><p style="margin:0;">RUC/C√©dula: ${document.getElementById('clienteIdentificacion').value}</p><p style="margin:0;">${document.getElementById('clienteDireccion').value}</p></div></div>`;
                    footerHtml = `<div style="margin-top: auto;">${totalesHtml}${notasHtml}${firmasHtml}</div>`;
                }
                
                return `<div>${headerHtml}${tablaHtml}</div>${footerHtml}`;
            }
        });
    </script>
</body>
</html>