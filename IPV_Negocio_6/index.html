
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesti√≥n de Inventario y Gastos v1.3</title> <!-- Versi√≥n actualizada -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="">
<style>
    :root {
      --header-height: 76px;
    }
    body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #1a1a1a;
        color: #eaeaea;
    }
    .container {
        padding: 1% 5% 2% 5%;
        min-height: 100vh;
    }
    .header {
        background: #252526;
        color: #ccc;
        padding: 0 3%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 60px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.6);
        position: sticky;
        top: 0;
        z-index: 1001;
        gap: 10px;
        flex-wrap: wrap;
    }
    .header-left {
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }
    .header .logo {
        max-height: 38px;
        margin-right: 15px;
        display: block;
    }
    .header h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 500;
        white-space: nowrap;
        color: #eee;
    }
    .header-date-input {
        display: flex;
        align-items: center;
        gap: 5px;
        flex-shrink: 0;
        margin: 0 5px;
    }
    .sr-only { /* Screen Reader Only */
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
    .header-date-input input[type="date"] {
        font-size: 14px;
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #444;
        background-color: #1e1e1e;
        color: #ccc;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.4);
        transition: box-shadow 0.15s ease, border-color 0.15s ease;
        cursor: pointer;
        max-width: 150px;
    }
    .header-date-input input[type="date"]:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.5), inset 0 1px 2px rgba(0,0,0,0.4);
    }
    .header-date-input input[type="date"]::-webkit-calendar-picker-indicator {
        background-color: #007bff;
        padding: 3px;
        border-radius: 3px;
        cursor: pointer;
        filter: invert(1) brightness(0.9);
        margin-left: 5px;
    }
    .header-date-input input[type="date"]::-webkit-calendar-picker-indicator:hover {
        background-color: #0056b3;
    }
    .header-date-input input[type="date"]::-webkit-inner-spin-button,
    .header-date-input input[type="date"]::-webkit-clear-button {
        display: none;
    }
    .header-nav-button {
        background-color: #3a3a3e;
        color: #ccc;
        border: 1px solid #555;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        font-weight: bold;
    }
    .header-nav-button:hover {
        background-color: #4a4a4e;
        border-color: #777;
        color: #fff;
    }
    .header-nav-button:active {
        background-color: #2a2a2e;
        border-color: #444;
    }
    .header-center {
        flex-grow: 1;
        margin: 0;
        max-width: 450px;
        min-width: 150px;
    }
    .header #searchInput {
        width: 100%;
        padding: 9px 20px;
        font-size: 15px;
        border: 1px solid #444;
        border-radius: 18px;
        background: #1e1e1e;
        color: #ccc;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        transition: all 0.2s ease-in-out;
        display: inline-block;
        margin: 0;
    }
    .header #searchInput::placeholder { color: #777; }
    .header #searchInput:focus { outline: none; border-color: #007bff; background: #2a2a2a; box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.5), inset 0 1px 3px rgba(0,0,0,0.5); color: #eee; }
    .header-right {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: flex-end;
    }
    .header-button { background-color: transparent; color: #b0b0b0; border: none; padding: 8px 12px; margin: 2px 3px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; transition: background-color 0.2s ease, color 0.2s ease; white-space: nowrap; line-height: 1.4; border-bottom: 2px solid transparent; }
    .header-button:hover { background-color: rgba(255, 255, 255, 0.08); color: #fff; border-bottom-color: #007bff; }
    .header-button:active { background-color: rgba(255, 255, 255, 0.05); color: #eee; border-bottom-color: #0056b3; }
    .worker-selector-header { position: relative; display: inline-block; margin-left: 5px; vertical-align: middle; }
    .worker-display-button { display: inline-flex; align-items: center; background-color: rgba(255, 255, 255, 0.05); color: #c0c0c0; border: 1px solid #444; padding: 7px 20px 7px 10px; margin: 0; border-radius: 18px; cursor: pointer; font-size: 12px; font-weight: 500; letter-spacing: 0.3px; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease; white-space: nowrap; line-height: 1.4; min-width: 110px; text-align: left; position: relative; box-shadow: inset 0 1px 2px rgba(0,0,0,0.4); }
    .worker-display-button::before { content: 'üë§'; margin-right: 6px; font-size: 1em; opacity: 0.8; line-height: 1; }
    .worker-display-button:hover { background-color: rgba(255, 255, 255, 0.1); color: #fff; border-color: #555; box-shadow: inset 0 1px 2px rgba(0,0,0,0.3), 0 0 5px rgba(0, 123, 255, 0.3); }
    .worker-display-button:active { background-color: rgba(255, 255, 255, 0.03); box-shadow: inset 0 2px 3px rgba(0,0,0,0.5); }
    .worker-display-button::after { content: '‚ñº'; position: absolute; right: 10px; top: 50%; transform: translateY(-50%) scale(0.7); pointer-events: none; color: inherit; opacity: 0.7; }
    .worker-selector-header select { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; appearance: none; -webkit-appearance: none; -moz-appearance: none; border: none; background: transparent; padding: 0; margin: 0; font-size: 13px; }
    .user-selector-container, .trabajador-info { display: none !important; }

    /* Estilos Modales Base */
    .modal, .modal-gastos, #pinModal, #confirmModal, #productSummaryModal,
    #performanceReportModal, #comparisonModal, #categoryManagementModal, #previousDayNotesModal,
    #zeroStockModal /* Nuevo modal */
     {
        display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%;
        overflow: auto; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center;
    }
    .modal-content, .modal-content-gastos,
    #productSummaryModal .modal-content,
    #performanceReportModal .modal-content,
    #comparisonModal .modal-content,
    #categoryManagementModal .modal-content,
    #zeroStockModal .modal-content /* Nuevo modal */
    /* No incluir #previousDayNotesModal .modal-content aqu√≠ para que use su estilo espec√≠fico de lujo */
    {
        background-color: #3e3e3e; color: #eaeaea; margin: auto; padding: 30px; border: 1px solid #555;
        width: 85%; max-width: 550px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        animation: modal-open 0.4s ease-out; text-align: left; position: relative;
    }
    #productSummaryModal .modal-content { max-width: 650px; }
    #confirmModal .modal-content { background-color: #2c2c2c; max-width: 400px; padding: 30px; text-align: center;}
    @keyframes modal-open { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* Inputs y Selects dentro de Modales */
    .modal-content input[type="text"], .modal-content input[type="number"], .modal-content input[type="password"], .modal-content select,
    .modal-content-gastos input[type="text"], .modal-content-gastos input[type="number"],
    #productSummaryModal select,
    .modal-content select#modal-product-unit,
    .modal-content input[type="text"]#modal-category-name,
    .modal-content select#performancePeriodSelector,
    .modal-content select#performanceCriteriaSelector,
    .modal-content select#comparisonPeriod1Selector,
    .modal-content select#comparisonPeriod2Selector,
    .modal-content select#deleteCategoryReplacement,
    .modal-content input#renameCategoryInput
    {
        width: calc(100% - 24px); padding: 12px; margin: 10px 0; display: inline-block; border: 1px solid #555;
        border-radius: 4px; box-sizing: border-box; background-color: #555; color: #fff; font-size: 16px;
    }
    #productSummaryModal select,
    #performanceReportModal select,
    #comparisonModal select {
        width: auto;
        min-width: 150px;
        padding: 8px 12px;
        font-size: 14px;
        margin: 0 0 15px 10px;
        vertical-align: middle;
    }
    .modal-content-gastos div { text-align: left; margin: 15px 0 10px 0; font-size: 14px; }
    .modal-content-gastos input[type="checkbox"] { width: auto; margin-right: 8px; vertical-align: middle; cursor: pointer; transform: scale(1.1);}
    .modal-content-gastos label { vertical-align: middle; cursor: pointer; }
    .modal-content input[type="file"] { width: calc(100% - 24px); padding: 10px; margin: 10px 0; border: 1px dashed #666; border-radius: 4px; background-color: #555; color: #ccc; cursor: pointer; }
    .modal-content input::placeholder, .modal-content-gastos input::placeholder { color: #999; }
    .modal-content input:focus, .modal-content select:focus, .modal-content-gastos input:focus,
    #productSummaryModal select:focus, #performanceReportModal select:focus, #comparisonModal select:focus,
    #categoryManagementModal input:focus, #categoryManagementModal select:focus
    { outline: none; border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.5); }

    /* Botones de Modales */
    .modal-content button, .modal-content-gastos button {
        background-color: #4CAF50; color: white; padding: 14px 20px; margin: 10px 0 0 0;
        border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease;
        width: auto;
        min-width: 100px;
    }
    #product-modal .modal-content button { width: calc(100% - 24px); }
    #productSummaryModal .modal-content button,
    #performanceReportModal .modal-content button,
    #comparisonModal .modal-content button,
    #categoryManagementModal .modal-content button,
    #confirmModal button,
    #pinModal button,
    #zeroStockModal .modal-content button /* Nuevo modal */
    {
        width: auto;
        padding: 10px 20px;
        margin: 10px 5px 0 0;
        float: right;
    }
    #categoryManagementModal .category-actions button {
         float: none;
         display: inline-block;
         margin-right: 10px;
    }
    #pinModal button { float: none; width: calc(100% - 24px); margin-top: 15px;}
    #confirmModal button { float: none; display: inline-block; margin: 15px 8px 0; }

    .modal-content button:hover, .modal-content-gastos button:hover { background-color: #45a049; }
    .modal-content .close, .modal-content-gastos .close, #productSummaryModal .close,
    #performanceReportModal .close, #comparisonModal .close, #categoryManagementModal .close,
    #pinModal .close, #previousDayNotesModal .close, #zeroStockModal .close /* Incluir cierre del nuevo modal */
    {
        color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 30px;
        font-weight: bold; cursor: pointer; transition: color 0.3s ease; line-height: 1;
    }
    .modal-content .close:hover, .modal-content .close:focus,
    .modal-content-gastos .close:hover, .modal-content-gastos .close:focus,
    #productSummaryModal .close:hover, #productSummaryModal .close:focus,
    #performanceReportModal .close:hover, #performanceReportModal .close:focus,
    #comparisonModal .close:hover, #comparisonModal .close:focus,
    #categoryManagementModal .close:hover, #categoryManagementModal .close:focus,
    #pinModal .close:hover, #pinModal .close:focus,
    #previousDayNotesModal .close:hover, #previousDayNotesModal .close:focus,
    #zeroStockModal .close:hover, #zeroStockModal .close:focus /* Hover cierre nuevo modal */
    { color: #fff; text-decoration: none; }

    /* Botones Modal Confirmaci√≥n */
    #confirmModal button:hover { transform: translateY(-2px); }
    #confirmYes { background-color: #28a745; } #confirmYes:hover { background-color: #218838; }
    #confirmNo { background-color: #dc3545; } #confirmNo:hover { background-color: #c82333; }

    /* Espec√≠ficos Modal Resumen Producto */
    #productSummaryModal .modal-content h2 { margin-top: 0; color: #64b5f6; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.4em; }
    #productSummaryModal .summary-section { margin-bottom: 15px; }
    #productSummaryModal .summary-section h3 { font-size: 1.1em; color: #ccc; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    #productSummaryModal #selected-products-list { list-style: none; padding: 0; margin: 0 0 15px 0; max-height: 100px; overflow-y: auto; font-size: 0.9em; background-color: rgba(0,0,0,0.2); border-radius: 4px; padding: 8px 12px; border: 1px solid #555; }
    #productSummaryModal #selected-products-list li { margin-bottom: 4px; }
    #productSummaryModal .period-selector-label { font-size: 0.95em; margin-right: 5px; color: #bbb; vertical-align: middle; }
    #productSummaryModal #summary-details p { font-size: 1em; margin: 8px 0; color: #ddd; }
    #productSummaryModal #summary-details strong { color: #fff; margin-left: 8px; font-size: 1.1em; }
    #productSummaryModal #summary-period { font-size: 0.85em; color: #888; margin-top: 15px; text-align: right; }

    /* Estilos para Modal Stock Cero */
    #zeroStockModal .modal-content h2 {
        margin-top: 0; color: #e67e22; /* Color Naranja para atenci√≥n */
        border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.4em;
    }
    #zeroStockModal ul#zeroStockList {
        list-style: none;
        padding: 0;
        margin: 0 0 20px 0;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #555;
        border-radius: 4px;
        background-color: #333; /* Un poco m√°s oscuro para contraste con el contenido del modal */
    }
    #zeroStockModal ul#zeroStockList li {
        padding: 8px 12px;
        border-bottom: 1px solid #484848;
        font-size: 0.95em;
        color: #ddd;
    }
    #zeroStockModal ul#zeroStockList li:last-child {
        border-bottom: none;
    }
    #zeroStockModal ul#zeroStockList li:hover {
        background-color: #444;
    }


    /* Botones bajo el header */
    .button-container { text-align: center; margin-top: 20px; margin-bottom: 30px; padding: 15px; background: #2c2c2c; border-radius: 8px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px;}
    .button-container button { margin: 0; padding: 10px 20px; border: none; color: white; cursor: pointer; font-size: 14px; border-radius: 5px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease; }
    .button-container button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
    .button-container button:active { transform: translateY(1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .button-container #toggleAllBtn { background-color: #8e44ad; }
    .button-container #toggleAllBtn:hover { background-color: #732d91; }
    .button-container #showSelectionSummaryBtn { background-color: #3498db; display: none; }
    .button-container #showSelectionSummaryBtn:hover { background-color: #2980b9; }
    .button-container #showSelectionSummaryBtn:disabled { background-color: #555; cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none;}
    .button-container #showZeroStockBtn { background-color: #e67e22; } /* Naranja */
    .button-container #showZeroStockBtn:hover { background-color: #d35400; }


    /* Tabla Responsiva */
    .responsive-table-wrapper { overflow-x: auto; margin-bottom: 20px; -webkit-overflow-scrolling: touch; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
    .responsive-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; background-color: #2c2c2c; }
    .responsive-table thead { position: sticky; top: var(--header-height); z-index: 100; }
    .responsive-table thead th { background-color: #3d3d3d; color: #eaeaea; padding: 15px 10px; font-size: 13px; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid #555; white-space: nowrap; }
    .responsive-table thead th:first-child { width: 40px; text-align: center; padding: 15px 5px; }
    .responsive-table thead th:nth-child(n+3):nth-child(-n+10) { text-align: center; }
    .responsive-table thead th:nth-child(2) { text-align: left; min-width: 150px; }
    .responsive-table thead th:last-child { text-align: center; }
    .responsive-table tbody tr.category-header { background-color: #4CAF50; color: white; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
    .responsive-table tbody tr.category-header:hover { background-color: #45a049; }
    .responsive-table tbody tr.category-header td { padding: 18px 15px; font-size: 1.15em; text-transform: uppercase; letter-spacing: 1.2px; border-bottom: 1px solid #3d3d3d; text-align: left !important; }
    .responsive-table tbody tr.category-header td[colspan="11"] { text-align: left !important; }
    .toggle-icon { float: right; margin-right: 10px; font-weight: bold; font-size: 1.2em; line-height: 1; }
    .responsive-table tbody tr.product-row { transition: background-color 0.2s ease; border-bottom: 1px solid #444; }
    .responsive-table tbody tr.product-row:nth-child(odd) { background-color: #2c2c2c; }
    .responsive-table tbody tr.product-row:nth-child(even) { background-color: #333333; }
    .responsive-table tbody tr.product-row:hover { background-color: #4a4a4a; }
     .hidden { display: none !important; }
    .responsive-table tbody tr.product-row.hidden { display: none !important; }
    .responsive-table tbody tr.product-row.search-hidden { display: none !important; }
    .responsive-table tbody td { padding: 12px 10px; font-size: 13px; vertical-align: middle; }
    .responsive-table tbody td:first-child { text-align: center; padding: 12px 5px; }
    .responsive-table tbody td:nth-child(n+3):nth-child(-n+10) { text-align: center; }
    #product-list td:nth-child(2) { text-align: left; vertical-align: top; }
    #product-list td:last-child { text-align: center; }
    .responsive-table td input[type="number"], .responsive-table td input[type="text"] { width: 100%; padding: 8px 5px; background-color: transparent; color: #eaeaea; border: 1px solid transparent; border-radius: 4px; outline: none; box-sizing: border-box; font-size: inherit; transition: border-color 0.2s ease, background-color 0.2s ease; }
    .responsive-table td:nth-child(n+3):nth-child(-n+10) input[type="number"] { text-align: center; }
    .responsive-table td:nth-child(2) input[type="text"] { text-align: left; margin-bottom: 2px; }
    .responsive-table td input:focus, .responsive-table td input:hover { background-color: rgba(85,85,85,0.7); border-color: #777; }
    table .delete-button { background-color: #e74c3c; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.3s ease, transform 0.2s ease; display: inline-block; }
    table .delete-button:hover { background-color: #c0392b; transform: scale(1.05); }
    table .delete-button:active { background-color: #a93226; transform: scale(0.98); }
    .product-select-checkbox { transform: scale(1.2); cursor: pointer; accent-color: #4CAF50;}

    /* Estilos filas con error o stock cero */
     .responsive-table tbody tr.product-row.fila-error {
         background-color: #611d1d !important;
     }
     .responsive-table tbody tr.product-row.fila-error:hover {
         background-color: #7a2424 !important;
     }
     .responsive-table tbody tr.product-row.fila-error td input {
         color: #ffdddd !important;
     }
     .responsive-table tbody tr.product-row.fila-stock-cero {
         background-color: #4a3b00 !important;
     }
     .responsive-table tbody tr.product-row.fila-stock-cero:not(.fila-error):hover {
         background-color: #5a4b10 !important;
     }
     .responsive-table tbody tr.product-row.fila-stock-cero td input {
         color: #fff0c4 !important;
     }
     .responsive-table tbody tr.product-row.fila-error.fila-stock-cero {
          background-color: #611d1d !important;
     }
     .responsive-table tbody tr.product-row.fila-error.fila-stock-cero:hover {
          background-color: #7a2424 !important;
     }
      .responsive-table tbody tr.product-row.fila-error.fila-stock-cero td input {
          color: #ffdddd !important;
     }

    /* Secci√≥n Gastos */
    .gastos-section { padding: 20px; background-color: #2c2c2c; box-shadow: 0 0 15px rgba(0,0,0,0.4); border-radius: 8px; margin-bottom: 30px; }
    .gastos-section h2 { color: #4CAF50; margin-top: 0; margin-bottom: 20px; font-size: 1.5em; text-transform: uppercase; letter-spacing: 1px; text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px; }
    .gastos-list { list-style-type: none; padding: 0; margin-bottom: 20px; max-height: 250px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #666 #333; }
    .gastos-list::-webkit-scrollbar { width: 8px; } .gastos-list::-webkit-scrollbar-track { background: #333; border-radius: 4px;} .gastos-list::-webkit-scrollbar-thumb { background-color: #666; border-radius: 4px; border: 2px solid #333;}
    .gastos-list .gasto-item { background-color: #383838; box-shadow: 0 2px 5px rgba(0,0,0,0.3); margin: 8px 0; padding: 12px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s ease; }
    .gastos-list .gasto-item:hover { background-color: #444; }
    .gastos-list .gasto-item[data-is-collection="true"] { background-color: #4a4a4e; border-left: 3px solid #f39c12; padding-left: 12px; }
    .gastos-list .gasto-item span { font-size: 1em; color: #ccc; flex-grow: 1; margin-right: 10px; word-break: break-word; }
    .gastos-list .gasto-item button { background: linear-gradient(90deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%); color: #444; padding: 6px 12px; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease-in-out; text-transform: uppercase; font-weight: bold; font-size: 0.8em; letter-spacing: 0.5px; box-shadow: 0 3px 7px rgba(0,0,0,0.2); flex-shrink: 0; }
    .gastos-list .gasto-item button:hover { transform: scale(1.05); box-shadow: 0 5px 10px rgba(0,0,0,0.25); background: linear-gradient(90deg, #fad0c4 0%, #ff9a9e 100%); }
    .add-gasto-button { background-color: #4CAF50; color: white; padding: 12px 25px; border: none; cursor: pointer; font-size: 1em; border-radius: 5px; transition: background-color 0.3s ease, transform .2s ease-in-out; display: block; width: 100%; box-sizing: border-box; margin-top: 15px; }
    .add-gasto-button:hover { background-color: #45a049; transform: scale(1.02); }
    .total-gastos-container { background: linear-gradient(135deg, #1e1e1e 0%, #3b3b3b 100%); color: #d4af37; padding: 15px 20px; border-radius: 8px; box-shadow: 0 6px 12px rgba(0,0,0,0.5); text-align: center; margin-top: 20px; font-family: 'Roboto', sans-serif; }
    .total-gastos-container h3 { font-size: 1.2em; margin: 0 0 0.5em 0; text-transform: uppercase; color: #ff8c00; text-shadow: 0 0 4px rgba(255,140,0,0.7); }
    .total-gastos-container p { font-size: 1em; margin: 0.3em 0; text-transform: uppercase; color: #ccc; }
    .total-gastos-container strong { font-size: 1.3em; color: #fff; margin-left: 8px; text-shadow: 0 0 5px rgba(255,255,255,0.5); }

    /* Secci√≥n Notas (Estilo de Lujo Actualizado) */
    .notas-section {
        padding: 25px;
        background: linear-gradient(145deg, #3a3a3e, #2a2a2e);
        box-shadow: 0 8px 20px rgba(0,0,0,0.6), inset 0 2px 4px rgba(255,255,255,0.05);
        border-radius: 12px;
        margin-top: 30px;
        margin-bottom: 30px;
        border-top: 2px solid #f39c12;
    }
    .notas-section h2 {
        color: #f39c12;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.6em;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        text-align: center;
        border-bottom: 1px solid rgba(243,156,18,0.3);
        padding-bottom: 15px;
        text-shadow: 0 0 5px rgba(243,156,18,0.5);
    }
    .notas-section textarea {
        width: calc(100% - 24px);
        min-height: 120px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #555;
        border-radius: 6px;
        box-sizing: border-box;
        background-color: #212121;
        color: #e0e0e0;
        font-size: 15px;
        font-family: 'Georgia', serif;
        resize: vertical;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .notas-section textarea:focus {
        outline: none;
        border-color: #f39c12;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.4), 0 0 8px rgba(243,156,18,0.6);
        background-color: #282828;
    }
    .notas-section textarea::placeholder {
        color: #777;
        font-style: italic;
    }
    .notas-guardar-button {
        background: linear-gradient(to bottom, #f39c12, #e67e22);
        color: #fff;
        padding: 12px 25px;
        border: none;
        cursor: pointer;
        font-size: 1.1em;
        border-radius: 6px;
        transition: all 0.3s ease;
        display: block;
        width: 100%;
        box-sizing: border-box;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 -2px 2px rgba(0,0,0,0.2);
    }
    .notas-guardar-button:hover {
        background: linear-gradient(to bottom, #e67e22, #d35400);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 -1px 1px rgba(0,0,0,0.1);
    }
    .notas-guardar-button:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 2px rgba(0,0,0,0.2);
    }

    /* Estilos para el Modal de Notas del D√≠a Anterior (Lujo) */
    #previousDayNotesModal .modal-content-lujo {
        background: radial-gradient(circle, #4a4a4e 0%, #2a2a2e 100%);
        color: #f0f0f0;
        max-width: 600px;
        border-radius: 15px;
        border: 1px solid #f39c12;
        box-shadow: 0 10px 30px rgba(0,0,0,0.7), 0 0 15px rgba(243,156,18,0.3);
        padding: 35px;
    }
    #previousDayNotesModal .modal-content-lujo h2 {
        color: #f39c12;
        text-align: center;
        font-size: 1.8em;
        margin-bottom: 25px;
        text-shadow: 0 0 8px rgba(243,156,18,0.7);
        border-bottom: 1px dashed rgba(243,156,18,0.5);
        padding-bottom: 15px;
    }
    .notas-contenido-lujo {
        background-color: rgba(0,0,0,0.2);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Georgia', serif;
        font-size: 1.1em;
        line-height: 1.6;
        border: 1px solid rgba(255,255,255,0.1);
        white-space: pre-wrap;
    }
    .notas-contenido-lujo p {
        margin: 0;
    }
    .notas-contenido-lujo::-webkit-scrollbar {
        width: 10px;
    }
    .notas-contenido-lujo::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
        border-radius: 5px;
    }
    .notas-contenido-lujo::-webkit-scrollbar-thumb {
        background-color: #f39c12;
        border-radius: 5px;
        border: 2px solid rgba(0,0,0,0.1);
    }
    .notas-contenido-lujo::-webkit-scrollbar-thumb:hover {
        background-color: #e67e22;
    }
    #previousDayNotesModal .modal-boton-lujo {
        background: linear-gradient(to bottom, #f39c12, #e67e22);
        color: white;
        padding: 12px 30px;
        font-size: 1.1em;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        margin-top: 10px;
        float: none;
        display: block;
        margin-left: auto;
        margin-right: auto;
        width: fit-content;
    }
    #previousDayNotesModal .modal-boton-lujo:hover {
        background: linear-gradient(to bottom, #e67e22, #d35400);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    #previousDayNotesModal .close {
        color: #f39c12;
        opacity: 0.8;
        font-size: 35px;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #previousDayNotesModal .close:hover {
        opacity: 1;
        transform: rotate(90deg);
    }


    /* Totales */
    #totales { background: linear-gradient(135deg, #1e1e1e 0%, #3b3b3b 100%); color: #d4af37; padding: 25px; border-radius: 10px; box-shadow: 0 8px 16px rgba(0,0,0,0.6); text-align: center; margin-top: 30px; transition: transform 0.3s, box-shadow 0.3s; font-family: 'Roboto', sans-serif; }
    #totales:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(0,0,0,0.8); }
    #totales h2 { font-size: 1.8em; margin-bottom: 0.8em; text-transform: uppercase; color: #ff8c00; text-shadow: 0 0 5px #ff8c00, 0 0 10px #ff8c00; }
    #totales p { font-size: 1.1em; margin: 0.6em 0; text-transform: uppercase; color: #ccc; }
    #totales strong { font-size: 1.4em; color: #fff; margin-left: 10px; text-shadow: 0 0 5px #fff, 0 0 8px #fff; }
    #fecha.fecha-style { font-size: 1.4em; font-weight: bold; color: #FFD700; text-shadow: 1px 1px 3px #8B4513; border: 1px solid #DAA520; border-radius: 8px; padding: 10px 15px; margin-bottom: 25px; box-shadow: 0 0 8px rgba(218,165,32,0.7); display: inline-block; background-color: rgba(0,0,0,0.2); }
    #totales hr { border: 0; height: 1px; background-image: linear-gradient(to right, rgba(85, 85, 85, 0), rgba(85, 85, 85, 0.75), rgba(85, 85, 85, 0)); margin: 15px 0; }

    /* Resumen General */
    #general-summary {
        background: #2a2a2e; color: #e0e0e0; padding: 25px; border-radius: 10px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.5); text-align: center; margin-top: 30px;
        font-family: 'Roboto', sans-serif; border: 1px solid #444;
    }
    #general-summary h2 { font-size: 1.6em; margin-bottom: 0.8em; text-transform: uppercase; color: #64b5f6; text-shadow: 0 0 4px rgba(100, 181, 246, 0.6); }
    #general-summary p { font-size: 1.05em; margin: 0.7em 0; text-transform: uppercase; color: #bbb; }
    #general-summary strong { font-size: 1.3em; color: #fff; margin-left: 10px; text-shadow: 0 0 4px rgba(255, 255, 255, 0.4); }
    #general-summary #periodo-analizado { font-size: 0.9em; color: #888; display: block; margin-top: 15px; text-transform: none; }
    .header-button.reload-button, .header-button.export-button { border-bottom-color: transparent; }
    .header-button.reload-button:hover, .header-button.export-button:hover { border-bottom-color: #007bff; }

    /* Estilos para Nuevos Modales */
    #performanceReportModal .modal-content,
    #comparisonModal .modal-content,
    #categoryManagementModal .modal-content {
        max-width: 750px;
    }
    #performanceReportModal h3, #comparisonModal h3, #categoryManagementModal h3 {
        font-size: 1.1em; color: #ccc; margin: 15px 0 8px 0;
        text-transform: uppercase; letter-spacing: 0.5px;
        border-bottom: 1px solid #555; padding-bottom: 5px;
    }
    #performanceReportModal table, #comparisonModal table {
        width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em;
    }
    #performanceReportModal th, #comparisonModal th {
        background-color: #4a4a4a; padding: 8px 10px; text-align: left; border-bottom: 1px solid #666; font-size: 0.95em;
    }
    #performanceReportModal td, #comparisonModal td {
        padding: 7px 10px; border-bottom: 1px solid #444;
    }
    #performanceReportModal tbody tr:nth-child(even),
    #comparisonModal tbody tr:nth-child(even) { background-color: rgba(255,255,255,0.05); }
    #performanceReportModal td:nth-child(n+3), #performanceReportModal th:nth-child(n+3),
    #comparisonModal td:nth-child(n+2), #comparisonModal th:nth-child(n+2)
     { text-align: right; }
    #performanceReportModal .profit-col, #comparisonModal .profit-row td:nth-child(n+2)
     { color: #d4af37; }


    /* Espec√≠ficos Modal Gesti√≥n Categor√≠as */
    #categoryManagementModal ul { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #555; border-radius: 4px; background: #333; padding: 10px;}
    #categoryManagementModal li { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #484848; }
    #categoryManagementModal li:last-child { border-bottom: none; }
    #categoryManagementModal li span { flex-grow: 1; margin-right: 10px; }
    #categoryManagementModal li button {
        background-color: #5a5a5e; color: #ccc; border: 1px solid #777; padding: 4px 8px; font-size: 0.8em;
        border-radius: 3px; cursor: pointer; margin-left: 5px; transition: background-color 0.2s;
    }
     #categoryManagementModal li button:disabled { background-color: #444; color: #777; cursor: not-allowed; }
    #categoryManagementModal li button:hover:not(:disabled) { background-color: #6a6a6e; color: #fff; }
    #categoryManagementModal .category-actions { margin-top: 15px; border-top: 1px solid #555; padding-top: 15px; }
    #categoryManagementModal input[type="text"]#modal-category-name { margin-top: 0;}
    #categoryActionPrompt { margin-top: 15px; padding: 15px; border: 1px dashed #666; border-radius: 5px; background-color: rgba(0,0,0,0.2); }
    #categoryActionPrompt p { margin: 0 0 10px 0; font-size: 0.95em; }
    #categoryActionPrompt button { margin-top: 5px; }

    /* Overlay de Carga */
    #loadingOverlay {
        display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; flex-direction: column; text-align: center; color: #fff; font-size: 1.2em;
    }
     #loadingOverlay p { margin-top: 15px; }
    #loadingOverlay::before { content: ''; display: block; width: 40px; height: 40px; margin-bottom: 15px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Bot√≥n Gesti√≥n Categor√≠as (Admin) */
    .admin-feature-button {
        display: none;
        background-color: #6f42c1;
        border-bottom-color: transparent;
    }
     .admin-feature-button:hover { background-color: #5a32a3; border-bottom-color: #fff; }

    /* Media Queries */
    @media screen and (max-width: 1200px) {
        .header-center { max-width: 350px; }
    }
     @media screen and (max-width: 1080px) {
         .header-center { max-width: 250px; }
          .header-button { padding: 8px 10px; font-size: 11px; }
          .worker-display-button { font-size: 11px; min-width: 100px; padding: 6px 15px 6px 8px;}
          .header h1 { font-size: 1.4rem; }
     }
    @media screen and (max-width: 992px) {
        :root { --header-height: 0px; }
        .header { position: static; flex-wrap: wrap; justify-content: center; padding: 15px 3%; min-height: auto; gap: 10px; }
        .header-left { width: 100%; justify-content: center; margin-bottom: 5px; order: 1; }
        .header-date-input { order: 2; margin: 5px auto; justify-content: center; width: auto; }
        .header-center { width: 90%; max-width: none; margin: 5px auto; order: 3; }
        .header-right { width: 100%; justify-content: center; order: 4; flex-wrap: wrap; margin-top: 5px; gap: 5px; }
        .header-button { margin: 3px; font-size: 12px; padding: 8px 10px; }
        .worker-selector-header { margin: 0; }
        .worker-display-button { min-width: 120px; padding: 7px 20px 7px 10px; font-size: 12px; }
         .responsive-table thead { top: 0; }
         .button-container { flex-direction: column; align-items: stretch;}
         .button-container button { width: 90%; margin: 5px auto;}
         #performanceReportModal .modal-content, #comparisonModal .modal-content, #categoryManagementModal .modal-content, #zeroStockModal .modal-content { max-width: 90%; }
    }
    @media screen and (max-width: 768px) {
        .container { padding: 3% 5% 3% 5%; }
        .responsive-table thead th { padding: 12px 8px; font-size: 11px; }
        .responsive-table tbody td { padding: 10px 8px; font-size: 12px; }
        .responsive-table td input { font-size: 12px; padding: 6px 4px;}
        .button-container button { padding: 8px 15px; font-size: 13px; }
        #totales h2 { font-size: 1.5em; } #totales p { font-size: 1em; } #totales strong { font-size: 1.2em; }
        #fecha.fecha-style { font-size: 1.2em; padding: 8px 12px; }
        .gastos-section h2 { font-size: 1.3em; } .gastos-list .gasto-item span { font-size: 0.9em; }
        .total-gastos-container h3 { font-size: 1.1em; } .total-gastos-container strong { font-size: 1.2em; }
        .notas-section h2 { font-size: 1.3em; }
        .notas-section textarea { font-size: 13px; min-height: 80px;}
        .notas-guardar-button { font-size: 0.9em; padding: 8px 15px;}
        #previousDayNotesModal .modal-content-lujo { padding: 20px; }
        #previousDayNotesModal .modal-content-lujo h2 { font-size: 1.5em; margin-bottom: 15px; padding-bottom: 10px;}
        .notas-contenido-lujo { font-size: 1em; padding: 15px; }
        #previousDayNotesModal .modal-boton-lujo { font-size: 1em; padding: 10px 20px; }
        .header h1 { font-size: 1.4rem; }
        .header-date-input { gap: 4px; }
        .header-nav-button { padding: 5px 8px; font-size: 13px; }
        .header-date-input input[type="date"] { font-size: 13px; padding: 5px 7px; max-width: 140px;}
        .worker-display-button { padding: 7px 20px 7px 10px; font-size: 12px; min-width: 110px; }
        #general-summary h2 { font-size: 1.4em; }
        #general-summary p { font-size: 1em; }
        #general-summary strong { font-size: 1.2em; }
        #productSummaryModal .modal-content, #performanceReportModal .modal-content, #comparisonModal .modal-content, #categoryManagementModal .modal-content, #zeroStockModal .modal-content { max-width: 90%; width: 90%; padding: 20px; }
        #productSummaryModal select, #performanceReportModal select, #comparisonModal select { font-size: 13px; padding: 6px 10px; width: 100%; margin: 5px 0 10px 0; }
        #performanceReportModal h4 { font-size: 1em; }
        #performanceReportModal table, #comparisonModal table { font-size: 0.85em; }
    }
    @media screen and (max-width: 600px) {
        .header { gap: 5px; }
        .header h1 { font-size: 1.3rem; }
        .header .logo { max-height: 35px;}
        .header-center { width: 95%; }
        .header-right { gap: 3px 5px; }
        .header-button { margin: 2px; padding: 8px; font-size: 11px; }
        .modal-content, .modal-content-gastos, #confirmModal .modal-content, #productSummaryModal .modal-content,
        #performanceReportModal .modal-content, #comparisonModal .modal-content, #categoryManagementModal .modal-content,
        #previousDayNotesModal .modal-content-lujo, #zeroStockModal .modal-content /* Asegurar que el modal de notas tambi√©n se ajuste */
        { width: 92%; padding: 15px; }
        .button-container button { display: block; width: calc(100% - 16px); margin: 8px auto; }
        .responsive-table-wrapper { overflow-x: auto; margin-bottom: 20px; -webkit-overflow-scrolling: touch; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.4); background-color: #2c2c2c; }
        .responsive-table { display: table; width: auto; min-width: 100%; white-space: nowrap; box-shadow: none; background-color: transparent; margin-bottom: 0; }
        .responsive-table thead th, .responsive-table tbody td { white-space: nowrap; }
        .responsive-table th:nth-child(1), .responsive-table td:nth-child(1) { width: 35px; min-width: 35px; text-align: center; padding-left: 3px; padding-right: 3px;}
        .responsive-table th:nth-child(2), .responsive-table td:nth-child(2) { min-width: 110px; text-align: left; white-space: normal; }
        .responsive-table td:nth-child(2) input[type="text"] { white-space: normal; }
        .responsive-table th:nth-child(n+3):nth-child(-n+10), .responsive-table td:nth-child(n+3):nth-child(-n+10) { min-width: 60px; text-align: center; padding-left: 4px; padding-right: 4px;}
        .responsive-table td:nth-child(n+3):nth-child(-n+10) input[type="number"] { text-align: center; }
        .responsive-table th:last-child, .responsive-table td:last-child { min-width: 65px; text-align: center;}
        .responsive-table tbody tr.category-header td { white-space: normal; text-align: left !important; }
        .toggle-icon { float: right; display: inline-block; }
         .responsive-table tbody tr.product-row:nth-child(odd) { background-color: transparent !important; }
         .responsive-table tbody tr.product-row:nth-child(even) { background-color: rgba(255,255,255,0.03) !important; }
         .responsive-table tbody tr.product-row:hover { background-color: #4a4a4a !important; }
         .responsive-table thead th { background-color: #3d3d3d !important; }
         #productSummaryModal select, #performanceReportModal select, #comparisonModal select { width: 100%; margin: 5px 0 15px 0;}
         #categoryManagementModal li button { font-size: 0.75em; padding: 3px 6px; }
    }
</style>
</head>
<body>

    <!-- Overlay de Carga -->
    <div id="loadingOverlay">
        <p>Procesando...</p>
        <p id="loadingMessage"></p>
    </div>

    <div class="header">
        <div class="header-left">
            <img src="./img/Logo.png" alt="Logo" class="logo">
            <h1>IPV Dependiente</h1>
        </div>
        <div class="header-date-input">
             <button id="prevDayBtn" class="header-nav-button" title="D√≠a Anterior">‚óÄ</button>
             <label for="date" class="sr-only">Fecha:</label>
             <input type="date" id="date">
             <button id="nextDayBtn" class="header-nav-button" title="D√≠a Siguiente">‚ñ∂</button>
        </div>
        <div class="header-center">
            <input type="text" id="searchInput" placeholder="Buscar productos..." onkeyup="searchProducts()">
        </div>
        <div class="header-right">
            <button class="header-button add-product-button" onclick="toggleModal()">A√±adir Producto</button>
            <button class="header-button import-export-button" onclick="document.getElementById('file-input').click()" title="Importar TODO el Historial IPV">Importar Todo</button>
            <button class="header-button export-button" onclick="exportCurrentDayData()" title="Exportar SOLO los datos del d√≠a visible">Exportar D√≠a</button>
            <button class="header-button export-button" onclick="promptExportMonthData()" title="Exportar los datos de un mes espec√≠fico">Exportar Mes</button>
            <button class="header-button export-button" onclick="exportAllData()" title="Exportar TODO el Historial IPV guardado">Exportar Todo</button>
            <button class="header-button reload-button" onclick="reloadFromPreviousDay()" title="Reiniciar el d√≠a actual basado en los finales del d√≠a anterior">Reiniciar D√≠a</button>
            <button class="header-button pdf-button" onclick="generarPDF()" title="Generar PDF">PDF</button>
            <button class="header-button" id="endOfDayBtn" onclick="checkEndOfDay()" title="Realizar comprobaciones de fin de d√≠a">Cierre de D√≠a</button>
            <button class="header-button" id="performanceReportBtn" onclick="showPerformanceReportModal()" title="Ver Informe de Rendimiento de Productos">Rendimiento Prod.</button>
            <button class="header-button" id="comparisonReportBtn" onclick="showComparisonModal()" title="Comparar M√©tricas Entre Per√≠odos">Comparar Per√≠odos</button>
             <button class="header-button admin-button" id="toggleVisibility" title="Administrar (PIN)">Admin</button>
             <button class="header-button admin-feature-button" id="manageCategoriesBtn" onclick="showCategoryManagementModal()" title="Gestionar Categor√≠as de Productos (Requiere PIN)">Gestionar Categor√≠as</button>
             <div class="worker-selector-header">
                <span id="worker-display" class="worker-display-button" title="Cambiar Trabajador">Seleccionar...</span>
                <select id="userSelector" title="Seleccionar Trabajador">
                    <option value="">Seleccionar...</option>
                    <option value="Luneiby">Luneiby</option>
                    <option value="Jose">Jose</option>
                </select>
            </div>
        </div>
    </div>

    <div class="container">

        <div id="product-modal" class="modal">
            <div class="modal-content">
                 <span class="close" onclick="toggleModal()">√ó</span>
                 <label for="modal-product-category">Categor√≠a:</label>
                 <select id="modal-product-category">
                    <option value="otros">Otros</option>
                 </select>
                 <input type="text" id="modal-product-name" placeholder="Nombre del producto (separados por coma si son varios)">
                 <input type="number" id="modal-product-start" placeholder="Inicio">
                 <input type="number" id="modal-product-cost" placeholder="Costo">
                 <input type="number" id="modal-product-price" placeholder="Precio">
                 <label for="modal-product-unit">Unidad de Medida:</label>
                 <select id="modal-product-unit">
                    <option value="unidad">Unidad</option>
                    <option value="paquete">Paquete</option>
                    <option value="caja">Caja</option>
                    <option value="kg">Kg</option>
                    <option value="g">g</option>
                    <option value="L">L</option>
                    <option value="mL">mL</option>
                    <option value="otro">Otro (especificar en nombre)</option>
                 </select>
                 <input style="display: none;" type="file" id="modal-product-image" accept="image/*" placeholder="Imagen del producto">
                 <button onclick="addProduct()">A√±adir Producto</button>
            </div>
        </div>

        <input type="file" id="file-input" onchange="importAllData(event)" style="display: none;">

        <div class="button-container">
            <button id="toggleAllBtn" onclick="toggleAllCategories()">Expandir Todo</button>
            <button id="showSelectionSummaryBtn" onclick="showProductSummaryModal()" title="Ver resumen financiero hist√≥rico de los productos seleccionados" disabled>Ver Resumen Selecci√≥n</button>
            <button id="showZeroStockBtn" onclick="showZeroStockModal()" title="Ver productos con stock cero">Stock Cero</button>
        </div>

         <div id="pinModal" class="modal">
             <div class="modal-content">
                 <span class="close">√ó</span>
                 <p>Por favor, ingresa el PIN de Administrador:</p>
                 <input type="password" id="pinInput" maxlength="4" inputmode="numeric">
                 <button id="submitPin">Acceder</button>
             </div>
         </div>

         <div class="responsive-table-wrapper">
            <table class="responsive-table table" id="product-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="Seleccionar/Deseleccionar Todo"></th>
                        <th>Productos</th>
                        <th>Inicio</th>
                        <th>Entrada</th>
                        <th>Finales</th>
                        <th>Vendido</th>
                        <th class="hidden">Costo</th>
                        <th>Precio</th>
                        <th>Importe</th>
                        <th class="hidden">Ganancias</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="product-list">
                    <!-- Filas generadas por JS -->
                </tbody>
            </table>
         </div>

        <div class="gastos-section">
            <h2>Gastos y Recogidas</h2>
            <div class="gastos-list" id="gastos-list">
                <!-- Items generados por JS -->
            </div>
            <button class="add-gasto-button" onclick="toggleGastosModal()">A√±adir Gasto / Recogida</button>
            <div class="total-gastos-container">
                <h3>Total Movimientos (D√≠a)</h3>
                <p>Monto Total: <strong id="total-gastos">0.00</strong></p>
            </div>
        </div>

        <div class="notas-section">
            <h2>Notas del D√≠a</h2>
            <textarea id="notas-dia" placeholder="Escribe aqu√≠ notas importantes para el d√≠a (ej: sobr√≥/falt√≥ dinero, revisar producto X, etc.). Estas notas se guardar√°n con los datos del d√≠a."></textarea>
            <button id="guardarNotasBtn" class="notas-guardar-button" onclick="guardarNotasManualmente()">Guardar Notas</button>
        </div>

        <div id="gastos-modal" class="modal-gastos">
            <div class="modal-content-gastos">
                <span class="close">√ó</span>
                <input type="text" id="gastos-description" placeholder="Descripci√≥n del gasto/recogida">
                <input type="number" id="gastos-amount" placeholder="Monto">
                <div>
                    <input type="checkbox" id="gasto-is-cash-collection">
                    <label for="gasto-is-cash-collection">¬øEs Recogida de Efectivo? (No afecta rentabilidad)</label>
                </div>
                <button onclick="addGasto()">A√±adir</button>
            </div>
        </div>

        <div id="totales">
            <p id="fecha" class="fecha-style">--/--/----</p>
            <h2>Totales del D√≠a</h2>
            <p class="hidden">Margen Bruto de Ganancias (D√≠a): <strong id="total-ganancias">0.00</strong></p>
            <p>Total Ingresos Brutos (D√≠a): <strong id="total-importe">0.00</strong></p>
            <p>Total despues de Gastos (D√≠a): <strong id="total-despues-gastos">0.00</strong></p>
            <p>Total Gastos/Recogidas (D√≠a): <strong id="total-gastos-display">0.00</strong></p>
            <hr>
            <p class="hidden">Valor Total en Stock (Precio Venta): <strong id="total-stock-value">0.00</strong></p>
            <p class="hidden">Costo Total en Stock: <strong id="total-stock-cost">0.00</strong></p>
             <hr class="hidden">
        </div>

        <div id="general-summary" class="hidden">
            <h2>Resumen Financiero General</h2>
            <p class="hidden">Margen Bruto Productos Acumulado: <strong id="total-ganancia-acumulada">0.00</strong></p>
            <p>Ingresos Brutos Totales Acumulados: <strong id="total-ingresos-acumulados">0.00</strong></p>
            <p>Gastos Operativos Totales Acumulados: <strong id="total-gastos-acumulados">0.00</strong></p>
            <p>Balance Neto Total Acumulado: <strong id="total-balance-neto-acumulado">0.00</strong></p>
            <p id="periodo-analizado">Calculando...</p>
        </div>

        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <p>¬øEst√°s seguro de que deseas eliminar este elemento?</p>
                <button id="confirmYes">S√≠</button>
                <button id="confirmNo">No</button>
            </div>
        </div>

        <div id="productSummaryModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProductSummaryModal()">√ó</span>
                <h2>Resumen Financiero Hist√≥rico de Productos</h2>
                <div class="summary-section">
                    <h3>Productos Seleccionados:</h3>
                    <ul id="selected-products-list">
                        <li>Cargando...</li>
                    </ul>
                </div>
                 <div class="summary-section">
                    <h3>
                         <label for="summaryPeriodSelector" class="period-selector-label">Periodo:</label>
                         <select id="summaryPeriodSelector" onchange="updateProductSummaryDisplay()">
                             <option value="Total">Total Hist√≥rico</option>
                         </select>
                     </h3>
                     <div id="summary-details">
                         <p>Total Unidades Vendidas: <strong id="summary-total-sold">0</strong></p>
                         <p>Total Ingresos Brutos: <strong id="summary-total-income">0.00</strong></p>
                         <p class="hidden">Margen Bruto de Ganancia: <strong id="summary-total-profit">0.00</strong></p>
                     </div>
                     <p id="summary-period">Periodo: Calculando...</p>
                 </div>
                <button onclick="closeProductSummaryModal()">Cerrar</button>
            </div>
        </div>

        <div id="performanceReportModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePerformanceReportModal()">√ó</span>
                <h2>Informe de Rendimiento de Productos</h2>
                <div>
                    <label for="performancePeriodSelector">Periodo:</label>
                    <select id="performancePeriodSelector" onchange="generatePerformanceReport()">
                        <option value="Total">Total Hist√≥rico</option>
                    </select>
                    <label for="performanceCriteriaSelector" style="margin-left: 15px;">Ordenar por:</label>
                    <select id="performanceCriteriaSelector" onchange="generatePerformanceReport()">
                        <option value="units">M√°s Vendidos (Unidades)</option>
                        <option value="income">M√°s Vendidos (Importe)</option>
                        <option value="profit" class="hidden">M√°s Rentables (Ganancia)</option>
                    </select>
                </div>
                <h3 id="reportPeriodDisplay"></h3>
                <div style="display: flex; gap: 20px; margin-top: 15px; max-height: 40vh; overflow-y: auto;">
                    <div style="flex: 1;">
                        <h4>Top 10 Productos</h4>
                        <table id="topProductsTable">
                            <thead>
                                <tr><th>Rank</th><th>Producto (Categor√≠a)</th><th>Unidades</th><th>Importe</th><th class="profit-col hidden">Ganancia</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                 </div>
                <button onclick="closePerformanceReportModal()">Cerrar</button>
            </div>
        </div>

        <div id="comparisonModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeComparisonModal()">√ó</span>
                <h2>Comparaci√≥n de Per√≠odos</h2>
                <div>
                    <label for="comparisonPeriod1Selector">Per√≠odo 1:</label>
                    <select id="comparisonPeriod1Selector" onchange="generateComparisonReport()">
                         <option value="Total">Total Hist√≥rico</option>
                    </select>
                    <label for="comparisonPeriod2Selector" style="margin-left: 15px;">Per√≠odo 2:</label>
                    <select id="comparisonPeriod2Selector" onchange="generateComparisonReport()">
                         <option value="Total">Total Hist√≥rico</option>
                    </select>
                </div>
                <h3 id="comparisonPeriodDisplay"></h3>
                 <div style="max-height: 45vh; overflow-y: auto;">
                     <table id="comparisonTable">
                         <thead>
                             <tr><th>M√©trica</th><th>Per√≠odo 1</th><th>Per√≠odo 2</th><th>Diferencia</th><th>Diferencia (%)</th></tr>
                         </thead>
                         <tbody></tbody>
                     </table>
                 </div>
                <button onclick="closeComparisonModal()">Cerrar</button>
            </div>
        </div>

        <div id="categoryManagementModal" class="modal">
             <div class="modal-content">
                 <span class="close" onclick="closeCategoryManagementModal()">√ó</span>
                 <h2>Gesti√≥n de Categor√≠as</h2>
                 <p style="font-size: 0.9em; color: #aaa;">Aqu√≠ puedes a√±adir, renombrar o eliminar categor√≠as. Renombrar/Eliminar afectar√° a TODOS los productos hist√≥ricos (puede tardar).</p>
                 <h3>Categor√≠as Actuales:</h3>
                 <ul id="categoryList">
                     <li>Cargando...</li>
                 </ul>
                 <h3>A√±adir Nueva Categor√≠a:</h3>
                 <input type="text" id="modal-category-name" placeholder="Nombre de la nueva categor√≠a">
                 <div class="category-actions">
                    <button onclick="addCategory()">A√±adir Categor√≠a</button>
                 </div>
                 <div id="categoryActionPrompt"></div>
                 <button onclick="closeCategoryManagementModal()">Cerrar</button>
             </div>
         </div>

        <div id="previousDayNotesModal" class="modal">
            <div class="modal-content modal-content-lujo">
                <span class="close">√ó</span>
                <h2>üìù Notas Importantes del D√≠a Anterior</h2>
                <div id="previousDayNotesContent" class="notas-contenido-lujo">
                    <p>Cargando notas...</p>
                </div>
                <button class="modal-boton-lujo" onclick="closePreviousDayNotesModal()">Entendido</button>
            </div>
        </div>

        <div id="zeroStockModal" class="modal">
            <div class="modal-content">
                <span class="close">√ó</span>
                <h2>Productos con Stock Cero</h2>
                <ul id="zeroStockList">
                    <!-- JS will populate this -->
                </ul>
                <button onclick="closeZeroStockModal()">Cerrar</button>
            </div>
        </div>


    </div> <!-- Fin Container -->

    <script>
        // --- Variables Globales y Constantes ---
const pinModal = document.getElementById('pinModal');
const productModal = document.getElementById('product-modal');
const gastosModal = document.getElementById('gastos-modal');
const confirmModal = document.getElementById('confirmModal');
const productSummaryModal = document.getElementById('productSummaryModal');
const performanceReportModal = document.getElementById('performanceReportModal');
const comparisonModal = document.getElementById('comparisonModal');
const categoryManagementModal = document.getElementById('categoryManagementModal');
const previousDayNotesModal = document.getElementById('previousDayNotesModal');
const zeroStockModal = document.getElementById('zeroStockModal'); // Nuevo
const previousDayNotesContent = document.getElementById('previousDayNotesContent');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingMessage = document.getElementById('loadingMessage');

const pinModalCloseButton = pinModal.querySelector('.close');
const gastosModalCloseButton = gastosModal.querySelector('.close');
const productSummaryModalCloseButton = productSummaryModal.querySelector('.close');
const zeroStockModalCloseButton = zeroStockModal?.querySelector('.close'); // Nuevo


const toggleVisibilityBtn = document.getElementById('toggleVisibility');
const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');

const pinInput = document.getElementById('pinInput');
const submitPinBtn = document.getElementById('submitPin');
const searchInput = document.getElementById('searchInput');
const dateInput = document.getElementById('date');
const prevDayBtn = document.getElementById('prevDayBtn');
const nextDayBtn = document.getElementById('nextDayBtn');
const productListTbody = document.getElementById('product-list');
const gastosListDiv = document.getElementById('gastos-list');
const userSelector = document.getElementById('userSelector');
const workerDisplay = document.getElementById('worker-display');
const generalSummarySection = document.getElementById('general-summary');
const showSelectionSummaryBtn = document.getElementById('showSelectionSummaryBtn');
const selectAllCheckbox = document.getElementById('selectAllCheckbox');
const summaryPeriodSelector = document.getElementById('summaryPeriodSelector');

let products = [];
let gastos = [];
let notasDiaActual = '';
let itemToDelete = null;
let deleteType = '';
let isPinActive = false;
let cachedHistoricalData = null;
let currentSelectedProductKeys = new Set();
let managedCategories = [];

const IPV_STORAGE_PREFIX = 'ipv_';
const APP_EXPORT_VERSION = 'IPV_App_FullExport_1.3';
const CATEGORIES_STORAGE_KEY = 'ipv_categories_list_v1';
const DEFAULT_CATEGORIES = ["Galletas", "Nevera", "Dulces", "Peter", "Sorbetos", "Confituras Variadas", "Rones", "Sazones", "Aseo Personal", "Otros"];
const DEFAULT_PRODUCT_UNIT = 'unidad';
let notasTimeout;

// --- Inicializaci√≥n y Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
    managedCategories = loadCategories();
    populateCategoryDropdown(document.getElementById('modal-product-category'));

    const now = new Date();
    const fechaHoy = now.toISOString().split('T')[0];
    if (dateInput) dateInput.value = fechaHoy;

    cargarIPV(fechaHoy);
    calculateAndDisplayGeneralSummary();
    updateSelectionState();
    updateToggleAllButtonState();

    const handleFocusSelect = (event) => { if (event.target.matches('input[type="text"], input[type="number"], input[type="password"], textarea')) { setTimeout(() => { event.target.select(); }, 0); } };
    if (productListTbody) productListTbody.addEventListener('focus', handleFocusSelect, true);
    if (productModal) productModal.addEventListener('focus', handleFocusSelect, true);
    if (gastosModal) gastosModal.addEventListener('focus', handleFocusSelect, true);
    if (pinModal) pinModal.addEventListener('focus', handleFocusSelect, true);
    if (categoryManagementModal) categoryManagementModal.addEventListener('focus', handleFocusSelect, true);
    const notasTextarea = document.getElementById('notas-dia');
    if (notasTextarea) {
        notasTextarea.addEventListener('focus', handleFocusSelect, true);
        notasTextarea.addEventListener('input', () => {
            clearTimeout(notasTimeout);
            notasTimeout = setTimeout(() => {
                notasDiaActual = notasTextarea.value;
                const currentDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
                guardarIPV(currentDate);
                console.log("Notas autoguardadas.");
            }, 1500);
        });
    }

    if (toggleVisibilityBtn) toggleVisibilityBtn.onclick = () => { pinModal.style.display = 'flex'; pinInput.focus(); };
    if (submitPinBtn) submitPinBtn.addEventListener('click', verifyPin);
    if (pinInput) pinInput.addEventListener('keyup', (event) => { if (event.key === "Enter") verifyPin(); });
    if (pinModalCloseButton) pinModalCloseButton.onclick = () => pinModal.style.display = 'none';
    if (gastosModalCloseButton) gastosModalCloseButton.onclick = () => gastosModal.style.display = 'none';
    if (productSummaryModalCloseButton) productSummaryModalCloseButton.onclick = closeProductSummaryModal;
    if (zeroStockModalCloseButton) zeroStockModalCloseButton.onclick = closeZeroStockModal; // Nuevo
    const previousDayNotesModalCloseButton = previousDayNotesModal?.querySelector('.close');
    if (previousDayNotesModalCloseButton) previousDayNotesModalCloseButton.onclick = closePreviousDayNotesModal;


    window.onclick = function (event) {
        if (event.target == pinModal) pinModal.style.display = "none";
        if (event.target == productModal) productModal.style.display = "none";
        if (event.target == gastosModal) gastosModal.style.display = "none";
        if (event.target == confirmModal) hideConfirmModal();
        if (event.target == productSummaryModal) closeProductSummaryModal();
        if (event.target == performanceReportModal) closePerformanceReportModal();
        if (event.target == comparisonModal) closeComparisonModal();
        if (event.target == categoryManagementModal) closeCategoryManagementModal();
        if (event.target == previousDayNotesModal) closePreviousDayNotesModal();
        if (event.target == zeroStockModal) closeZeroStockModal(); // Nuevo
    };

    document.getElementById('confirmYes').addEventListener('click', handleConfirmYes);
    document.getElementById('confirmNo').addEventListener('click', hideConfirmModal);

    if (dateInput) dateInput.addEventListener('change', (event) => {
        cargarIPV(event.target.value);
    });

    if (searchInput) searchInput.addEventListener('keyup', searchProducts);
    if (prevDayBtn) prevDayBtn.addEventListener('click', () => changeDay(-1));
    if (nextDayBtn) nextDayBtn.addEventListener('click', () => changeDay(1));

    if (userSelector && workerDisplay) {
        userSelector.addEventListener('change', () => {
            const selectedUser = userSelector.value; workerDisplay.textContent = selectedUser || 'Seleccionar...';
            const currentDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0]; guardarIPV(currentDate);
        });
    }

    const performanceModalCloseBtn = performanceReportModal?.querySelector('button:last-of-type');
    const comparisonModalCloseBtn = comparisonModal?.querySelector('button:last-of-type');
    const categoryModalCloseBtn = categoryManagementModal?.querySelector('button:last-of-type');
    const zeroStockCerrarBtn = zeroStockModal?.querySelector('button'); // Nuevo, asume un solo bot√≥n "Cerrar"

    if (performanceModalCloseBtn && performanceModalCloseBtn.textContent.toLowerCase() === 'cerrar') performanceModalCloseBtn.onclick = closePerformanceReportModal;
    if (comparisonModalCloseBtn && comparisonModalCloseBtn.textContent.toLowerCase() === 'cerrar') comparisonModalCloseBtn.onclick = closeComparisonModal;
    if (categoryModalCloseBtn && categoryModalCloseBtn.textContent.toLowerCase() === 'cerrar') categoryModalCloseBtn.onclick = closeCategoryManagementModal;
    if (zeroStockCerrarBtn && zeroStockCerrarBtn.textContent.toLowerCase() === 'cerrar') zeroStockCerrarBtn.onclick = closeZeroStockModal; // Nuevo

    applyVisibility(isPinActive);
});

// --- Funciones Overlay de Carga ---
function showLoading(message = "Procesando...") {
    if (loadingOverlay) {
        loadingMessage.textContent = message;
        loadingOverlay.style.display = 'flex';
    }
}
function hideLoading() {
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
        loadingMessage.textContent = '';
    }
}

// --- Funciones Gesti√≥n de Categor√≠as ---
function loadCategories() {
    try {
        const storedCategories = localStorage.getItem(CATEGORIES_STORAGE_KEY);
        if (storedCategories) {
            const parsed = JSON.parse(storedCategories);
            if (Array.isArray(parsed) && parsed.length > 0 && parsed.every(item => typeof item === 'string' && item.trim() !== '')) {
                console.log("Categor√≠as cargadas desde localStorage:", parsed);
                if (!parsed.some(c => c.toLowerCase() === 'otros')) {
                    parsed.push('Otros');
                }
                return parsed.sort((a, b) => a.localeCompare(b));
            } else {
                console.warn("Datos de categor√≠as en localStorage inv√°lidos o vac√≠os, usando predeterminadas.");
                saveCategories(DEFAULT_CATEGORIES);
                return [...DEFAULT_CATEGORIES].sort((a, b) => a.localeCompare(b));
            }
        }
        console.log("No hay categor√≠as en localStorage, usando y guardando predeterminadas.");
        saveCategories(DEFAULT_CATEGORIES);
        return [...DEFAULT_CATEGORIES].sort((a, b) => a.localeCompare(b));
    } catch (e) {
        console.error("Error cr√≠tico cargando categor√≠as:", e);
        alert("Error al cargar la lista de categor√≠as. Se usar√°n las predeterminadas.");
        return [...DEFAULT_CATEGORIES].sort((a, b) => a.localeCompare(b));
    }
}

function saveCategories(categoriesArray) {
    try {
        const cleanedCategories = categoriesArray
            .map(c => String(c || '').trim())
            .filter(c => c !== '');
        let uniqueCategories = [...new Set(cleanedCategories)];
        if (!uniqueCategories.some(c => c.toLowerCase() === 'otros')) {
            uniqueCategories.push('Otros');
        }
        uniqueCategories.sort((a, b) => a.localeCompare(b));

        localStorage.setItem(CATEGORIES_STORAGE_KEY, JSON.stringify(uniqueCategories));
        managedCategories = uniqueCategories;
        console.log("Categor√≠as guardadas:", uniqueCategories);
    } catch (e) {
        console.error("Error guardando categor√≠as:", e);
        alert("Error al guardar la lista de categor√≠as. Es posible que el almacenamiento est√© lleno.");
    }
}

function populateCategoryDropdown(selectElement) {
    if (!selectElement) return;
    const currentSelectionText = selectElement.options[selectElement.selectedIndex]?.textContent;
    selectElement.innerHTML = '';
    managedCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        selectElement.appendChild(option);
    });
    let found = false;
    for (let i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].textContent === currentSelectionText) {
            selectElement.selectedIndex = i;
            found = true;
            break;
        }
    }
    if (!found) {
        const otrosIndex = managedCategories.findIndex(c => c.toLowerCase() === 'otros');
        if (otrosIndex !== -1) {
            selectElement.selectedIndex = otrosIndex;
        } else if (selectElement.options.length > 0) {
            selectElement.selectedIndex = selectElement.options.length - 1;
        }
    }
}

function showCategoryManagementModal() {
    if (!isPinActive) {
        alert("Acceso restringido. Por favor, ingresa el PIN de administrador.");
        pinModal.style.display = 'flex'; pinInput.focus();
        return;
    }
    renderCategoryList();
    if(categoryManagementModal) categoryManagementModal.style.display = 'flex';
    document.getElementById('modal-category-name').value = '';
    document.getElementById('categoryActionPrompt').innerHTML = '';
}

function closeCategoryManagementModal() {
    if(categoryManagementModal) categoryManagementModal.style.display = 'none';
    document.getElementById('categoryActionPrompt').innerHTML = '';
    populateCategoryDropdown(document.getElementById('modal-product-category'));
}

function renderCategoryList() {
    const listElement = document.getElementById('categoryList');
    if (!listElement) return;
    listElement.innerHTML = '';
    if (managedCategories.length === 0) {
        listElement.innerHTML = '<li>No hay categor√≠as definidas. A√±ade una.</li>';
        return;
    }
    managedCategories.forEach(category => {
        const li = document.createElement('li');
        const isOtros = category.toLowerCase() === 'otros';
        li.innerHTML = `
            <span>${category}</span>
            <div>
                <button onclick="promptRenameCategory('${category}')" ${isOtros ? 'disabled title="No se puede renombrar la categor√≠a Otros"' : ''}>Renombrar</button>
                <button onclick="promptDeleteCategory('${category}')" ${isOtros ? 'disabled title="No se puede eliminar la categor√≠a Otros"' : ''}>Eliminar</button>
            </div>
        `;
        listElement.appendChild(li);
    });
}

function addCategory() {
    const input = document.getElementById('modal-category-name');
    const newCategoryName = input.value.trim();
    if (!newCategoryName) {
        alert("Por favor, introduce un nombre para la categor√≠a.");
        return;
    }
    if (managedCategories.some(c => c.toLowerCase() === newCategoryName.toLowerCase())) {
        alert(`La categor√≠a "${newCategoryName}" ya existe (insensible a may√∫sculas).`);
        return;
    }
    managedCategories.push(newCategoryName);
    saveCategories(managedCategories);
    renderCategoryList();
    input.value = '';
    input.focus();
}

function promptRenameCategory(oldName) {
    if (oldName.toLowerCase() === 'otros') return;
    const promptDiv = document.getElementById('categoryActionPrompt');
    if (!promptDiv) return;
    promptDiv.innerHTML = `
        <h4>Renombrar Categor√≠a</h4>
        <p>Renombrar "<strong>${oldName}</strong>" a:</p>
        <input type="text" id="renameCategoryInput" value="${oldName}" style="margin-bottom: 10px;">
        <button onclick="executeRenameCategory('${oldName}')">Confirmar Renombrar</button>
        <button onclick="cancelCategoryAction()">Cancelar</button>
        <p style="font-size: 0.8em; color: orange; margin-top: 10px;">Advertencia: Esto actualizar√° la categor√≠a en TODOS los registros hist√≥ricos. Puede tardar.</p>
    `;
    const renameInput = document.getElementById('renameCategoryInput');
    if(renameInput) { renameInput.focus(); renameInput.select(); }
}

async function executeRenameCategory(oldName) {
    const input = document.getElementById('renameCategoryInput');
    const newName = input.value.trim();

    if (!newName) { alert("El nuevo nombre no puede estar vac√≠o."); return; }
    if (newName.toLowerCase() === oldName.toLowerCase()) { cancelCategoryAction(); return; }
    if (managedCategories.some(c => c.toLowerCase() === newName.toLowerCase() && c.toLowerCase() !== oldName.toLowerCase())) {
        alert(`La categor√≠a "${newName}" ya existe.`); return;
    }
    showLoading(`Renombrando "${oldName}" a "${newName}" y actualizando historial...`);
    try {
        managedCategories = managedCategories.map(c => c === oldName ? newName : c);
        saveCategories(managedCategories);
        let updatedDaysCount = 0;
        const allData = loadAllHistoricalData(true);
        const keysToUpdate = [];
        allData.forEach(day => {
            if (day.products.some(product => String(product.category || '').trim() === oldName)) {
                keysToUpdate.push(day.date);
            }
        });
        console.log(`Se necesita actualizar ${keysToUpdate.length} d√≠as por renombre de categor√≠a.`);
        if (keysToUpdate.length > 0) {
            loadingMessage.textContent = `Actualizando ${keysToUpdate.length} d√≠as... (0%)`;
        }
        for (let i = 0; i < keysToUpdate.length; i++) {
            const date = keysToUpdate[i];
            const dayData = allData.find(d => d.date === date);
            if (dayData) {
                const updatedProducts = dayData.products.map(p => {
                    if (String(p.category || '').trim() === oldName) {
                        return { ...p, category: newName };
                    }
                    return p;
                });
                const productsToSave = updatedProducts.map(p => ({
                    id: p.id, name: p.name, category: p.category, unit: p.unit || DEFAULT_PRODUCT_UNIT,
                    start: p.start, entrada: p.entrada, finales: p.finales,
                    cost: p.cost, price: p.price
                }));
                const gastosToSave = dayData.gastos.map(g => ({
                    id: g.id, description: g.description, amount: g.amount, isCashCollection: !!g.isCashCollection
                }));
                const dataToSave = { products: productsToSave, gastos: gastosToSave, user: dayData.user, notas: dayData.notas || '' };
                try {
                    localStorage.setItem(IPV_STORAGE_PREFIX + date, JSON.stringify(dataToSave));
                    updatedDaysCount++;
                } catch (storageError) {
                    console.error(`Error guardando d√≠a ${date} durante renombre:`, storageError);
                    if (storageError.name === 'QuotaExceededError') {
                        throw new Error("Espacio de almacenamiento insuficiente para completar la actualizaci√≥n.");
                    }
                    throw new Error(`Error al guardar d√≠a ${date}: ${storageError.message}`);
                }
                if (i % Math.max(1, Math.floor(keysToUpdate.length / 20)) === 0 || i === keysToUpdate.length - 1) {
                    const progress = Math.round(((i + 1) / keysToUpdate.length) * 100);
                    loadingMessage.textContent = `Actualizando ${keysToUpdate.length} d√≠as... (${progress}%)`;
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
        }
        renderCategoryList();
        cancelCategoryAction();
        cachedHistoricalData = null;
        alert(`Categor√≠a renombrada a "${newName}". Se actualizaron ${updatedDaysCount} registros hist√≥ricos.`);
        const currentDate = dateInput ? dateInput.value : null;
        if (currentDate && keysToUpdate.includes(currentDate)) {
            console.log("Recargando vista del d√≠a actual despu√©s de renombrar categor√≠a.");
            cargarIPV(currentDate);
        } else if (products.some(p => p.category === oldName)) {
            console.log("Actualizando productos en memoria del d√≠a actual tras renombrar categor√≠a.");
            products = products.map(p => p.category === oldName ? {...p, category: newName} : p);
            renderProducts();
        }
    } catch (e) {
        console.error("Error renombrando categor√≠a:", e);
        alert(`Error al renombrar: ${e.message}`);
        managedCategories = loadCategories();
        renderCategoryList();
    } finally {
        hideLoading();
    }
}

function promptDeleteCategory(nameToDelete) {
    if (nameToDelete.toLowerCase() === 'otros') return;
    const promptDiv = document.getElementById('categoryActionPrompt');
    if (!promptDiv) return;
    let replacementOptions = managedCategories
        .filter(c => c !== nameToDelete)
        .map(c => `<option value="${c}" ${c.toLowerCase() === 'otros' ? 'selected' : ''}>${c}</option>`)
        .join('');
    promptDiv.innerHTML = `
        <h4>Eliminar Categor√≠a</h4>
        <p>¬øSeguro que quieres eliminar la categor√≠a "<strong>${nameToDelete}</strong>"?</p>
        <p style="font-size: 0.9em;">Los productos existentes en esta categor√≠a se mover√°n a:</p>
        <select id="deleteCategoryReplacement" style="margin-bottom: 10px;">
            ${replacementOptions}
        </select>
        <button onclick="executeDeleteCategory('${nameToDelete}')">Confirmar Eliminar</button>
        <button onclick="cancelCategoryAction()">Cancelar</button>
        <p style="font-size: 0.8em; color: orange; margin-top: 10px;">Advertencia: Esta acci√≥n es irreversible y actualizar√° TODOS los registros hist√≥ricos. Puede tardar.</p>
    `;
}

async function executeDeleteCategory(nameToDelete) {
    const replacementSelect = document.getElementById('deleteCategoryReplacement');
    const replacementCategory = replacementSelect.value;

    if (!replacementCategory || !managedCategories.includes(replacementCategory)) {
        alert("Error: Categor√≠a de reemplazo inv√°lida."); return;
    }
    showLoading(`Eliminando "${nameToDelete}", moviendo productos a "${replacementCategory}" y actualizando historial...`);
    try {
        managedCategories = managedCategories.filter(c => c !== nameToDelete);
        saveCategories(managedCategories);
        let updatedDaysCount = 0;
        const allData = loadAllHistoricalData(true);
        const keysToUpdate = [];
        allData.forEach(day => {
            if (day.products.some(product => String(product.category || '').trim() === nameToDelete)) {
                keysToUpdate.push(day.date);
            }
        });
        console.log(`Se necesita actualizar ${keysToUpdate.length} d√≠as por eliminaci√≥n de categor√≠a.`);
        if (keysToUpdate.length > 0) {
            loadingMessage.textContent = `Actualizando ${keysToUpdate.length} d√≠as... (0%)`;
        }
        for (let i = 0; i < keysToUpdate.length; i++) {
            const date = keysToUpdate[i];
            const dayData = allData.find(d => d.date === date);
            if (dayData) {
                const updatedProducts = dayData.products.map(p => {
                    if (String(p.category || '').trim() === nameToDelete) {
                        return { ...p, category: replacementCategory };
                    }
                    return p;
                });
                const productsToSave = updatedProducts.map(p => ({
                    id: p.id, name: p.name, category: p.category, unit: p.unit || DEFAULT_PRODUCT_UNIT,
                    start: p.start, entrada: p.entrada, finales: p.finales,
                    cost: p.cost, price: p.price
                }));
                const gastosToSave = dayData.gastos.map(g => ({
                    id: g.id, description: g.description, amount: g.amount, isCashCollection: !!g.isCashCollection
                }));
                const dataToSave = { products: productsToSave, gastos: gastosToSave, user: dayData.user, notas: dayData.notas || '' };
                try {
                    localStorage.setItem(IPV_STORAGE_PREFIX + date, JSON.stringify(dataToSave));
                    updatedDaysCount++;
                } catch (storageError) {
                    console.error(`Error guardando d√≠a ${date} durante eliminaci√≥n:`, storageError);
                    if (storageError.name === 'QuotaExceededError') {
                        throw new Error("Espacio de almacenamiento insuficiente para completar la actualizaci√≥n.");
                    }
                    throw new Error(`Error al guardar d√≠a ${date}: ${storageError.message}`);
                }
                if (i % Math.max(1, Math.floor(keysToUpdate.length / 20)) === 0 || i === keysToUpdate.length - 1) {
                    const progress = Math.round(((i + 1) / keysToUpdate.length) * 100);
                    loadingMessage.textContent = `Actualizando ${keysToUpdate.length} d√≠as... (${progress}%)`;
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
        }
        renderCategoryList();
        cancelCategoryAction();
        cachedHistoricalData = null;
        alert(`Categor√≠a "${nameToDelete}" eliminada. Productos movidos a "${replacementCategory}". Se actualizaron ${updatedDaysCount} registros hist√≥ricos.`);
        const currentDate = dateInput ? dateInput.value : null;
        if (currentDate && keysToUpdate.includes(currentDate)) {
            console.log("Recargando vista del d√≠a actual despu√©s de eliminar categor√≠a.");
            cargarIPV(currentDate);
        } else if (products.some(p => p.category === nameToDelete)) {
            console.log("Actualizando productos en memoria del d√≠a actual tras eliminar categor√≠a.");
            products = products.map(p => p.category === nameToDelete ? {...p, category: replacementCategory} : p);
            renderProducts();
        }
    } catch (e) {
        console.error("Error eliminando categor√≠a:", e);
        alert(`Error al eliminar: ${e.message}`);
        managedCategories = loadCategories();
        renderCategoryList();
    } finally {
        hideLoading();
    }
}

function cancelCategoryAction() {
    const promptDiv = document.getElementById('categoryActionPrompt');
    if(promptDiv) promptDiv.innerHTML = '';
}

// --- Funciones Core Modificadas ---
function verifyPin() {
    const pinCorrecto = '8608';
    if (pinInput.value === pinCorrecto) {
        isPinActive = !isPinActive;
        applyVisibility(isPinActive);
        pinModal.style.display = 'none';
        pinInput.value = '';
        alert(`Acceso de Administrador ${isPinActive ? 'ACTIVADO' : 'DESACTIVADO'}.`);
    } else {
        alert('PIN incorrecto.');
        pinInput.select();
    }
}

function applyVisibility(showSensitive) {
    console.log("Aplicando visibilidad sensible:", showSensitive);
    document.querySelectorAll('#product-table th:nth-child(7), #product-list td:nth-child(7)').forEach(el => el.classList.toggle('hidden', !showSensitive));
    document.querySelectorAll('#product-table th:nth-child(10), #product-list td:nth-child(10)').forEach(el => el.classList.toggle('hidden', !showSensitive));
    document.querySelector('#total-ganancias')?.parentElement.classList.toggle('hidden', !showSensitive);
    document.querySelector('#total-stock-cost')?.parentElement.classList.toggle('hidden', !showSensitive);
    document.querySelector('#total-stock-value')?.parentElement.classList.toggle('hidden', !showSensitive);
    document.querySelector('#totales hr:last-of-type')?.classList.toggle('hidden', !showSensitive);
    generalSummarySection?.classList.toggle('hidden', !showSensitive);
    document.getElementById('total-ganancia-acumulada')?.parentElement.classList.toggle('hidden', !showSensitive);
    document.getElementById('summary-total-profit')?.parentElement.classList.toggle('hidden', !showSensitive);
    document.querySelectorAll('#performanceCriteriaSelector option[value="profit"]').forEach(el => el.classList.toggle('hidden', !showSensitive));
    document.querySelectorAll('#performanceReportModal th.profit-col, #performanceReportModal td.profit-col').forEach(el => el.classList.toggle('hidden', !showSensitive));
    document.querySelectorAll('#comparisonTable tr.profit-row').forEach(el => el.style.display = showSensitive ? '' : 'none');
    if (manageCategoriesBtn) manageCategoriesBtn.style.display = showSensitive ? 'inline-block' : 'none';
    calculateTotals();
    if (performanceReportModal && performanceReportModal.style.display === 'flex') {
        generatePerformanceReport();
    }
    if (comparisonModal && comparisonModal.style.display === 'flex') {
        generateComparisonReport();
    }
    if (productSummaryModal && productSummaryModal.style.display === 'flex') {
        updateProductSummaryDisplay();
    }
    renderProducts();
}

function guardarIPV(fecha) {
    try {
        const notasTextarea = document.getElementById('notas-dia');
        if (notasTextarea) {
            notasDiaActual = notasTextarea.value;
        }

        const selectedUser = userSelector ? userSelector.value : '';
        const productsToSave = products.map(p => ({
            id: p.id, name: String(p.name || '').trim(), category: String(p.category || 'Otros').trim(), unit: String(p.unit || DEFAULT_PRODUCT_UNIT).trim(),
            start: Number(p.start) || 0, entrada: Number(p.entrada) || 0, finales: (p.finales === '' || p.finales === null || p.finales === undefined) ? '' : (Number(p.finales) || 0),
            cost: Number(p.cost) || 0, price: Number(p.price) || 0
        }));
        const gastosToSave = gastos.map(g => ({
            id: g.id, description: String(g.description || '').trim(), amount: Number(g.amount) || 0, isCashCollection: !!g.isCashCollection
        }));
        const ipv = {
            products: productsToSave,
            gastos: gastosToSave,
            user: selectedUser,
            notas: notasDiaActual
        };
        localStorage.setItem(IPV_STORAGE_PREFIX + fecha, JSON.stringify(ipv));
        cachedHistoricalData = null;
    } catch (e) {
        console.error("Error guardando datos:", e);
        if (e.name === 'QuotaExceededError') {
            alert("¬°Error Cr√≠tico! No se pudieron guardar los datos. El almacenamiento local est√° lleno. Por favor, exporta tus datos inmediatamente y considera limpiar historial antiguo si es posible.");
        } else {
            alert("Error al guardar los datos. Revisa la consola para m√°s detalles.");
        }
    }
}

function cargarIPV(fecha) {
    console.log("Cargando datos para la fecha:", fecha);
    let loadedUser = '';
    notasDiaActual = ''; // Resetear notas para el nuevo d√≠a que se est√° cargando

    const fechaObjActual = new Date(fecha + 'T00:00:00Z'); // Asegurar que se trata como UTC para consistencia
    const fechaAnteriorObj = new Date(fechaObjActual.getTime() - 86400000);
    const fechaAnteriorStr = fechaAnteriorObj.toISOString().split('T')[0];
    const ipvDataDiaAnterior = localStorage.getItem(IPV_STORAGE_PREFIX + fechaAnteriorStr);

    if (ipvDataDiaAnterior) {
        try {
            const datosDiaAnterior = JSON.parse(ipvDataDiaAnterior);
            if (datosDiaAnterior.notas && datosDiaAnterior.notas.trim() !== '') {
                // Comprobar si el usuario ha cambiado activamente la fecha en el input principal
                // O si la fecha actual del input es la que se est√° cargando (indicando que es una carga inicial o recarga del mismo d√≠a)
                if (dateInput && dateInput.value === fecha) {
                     mostrarNotasDiaAnterior(datosDiaAnterior.notas, fechaAnteriorStr);
                }
            }
        } catch (e) {
            console.warn("Error al procesar notas del d√≠a anterior:", e);
        }
    }

    const ipvData = localStorage.getItem(IPV_STORAGE_PREFIX + fecha);
    if (ipvData) {
        try {
            const ipv = JSON.parse(ipvData);
            const loadedProductCategories = new Set((ipv.products || []).map(p => String(p.category || 'Otros').trim()).filter(Boolean));
            let categoriesChanged = false;
            loadedProductCategories.forEach(cat => {
                if (cat && !managedCategories.some(mc => mc === cat)) {
                    console.warn(`La categor√≠a "${cat}" encontrada en los datos del d√≠a ${fecha} no est√° en la lista gestionada. A√±adi√©ndola.`);
                    managedCategories.push(cat);
                    categoriesChanged = true;
                }
            });
            if (categoriesChanged) {
                saveCategories(managedCategories);
                populateCategoryDropdown(document.getElementById('modal-product-category'));
            }
            products = (ipv.products || []).map((p, idx) => {
                const start = Number(p.start) || 0;
                const entrada = Number(p.entrada) || 0;
                const finalesRaw = p.finales;
                const finales = (finalesRaw === null || finalesRaw === undefined || finalesRaw === '') ? finalesRaw : (Number(finalesRaw) || 0);
                const cost = Number(p.cost) || 0;
                const price = Number(p.price || 0);
                const vendido = (typeof finales === 'number') ? Math.max(0, start + entrada - finales) : 0;
                const importe = vendido * price;
                const ganancias = importe - (vendido * cost);
                return {
                    id: p.id || Date.now().toString(36) + Math.random().toString(36).substr(2) + idx, name: String(p.name || `Producto Desconocido ${idx + 1}`),
                    category: String(p.category || 'Otros'), unit: String(p.unit || DEFAULT_PRODUCT_UNIT), image: '', start, entrada, finales,
                    cost, price, vendido, importe, ganancias
                };
            });
            gastos = (ipv.gastos || []).map((g, idx) => ({
                id: g.id || Date.now().toString(36) + Math.random().toString(36).substr(2) + 'g' + idx, description: String(g.description || `Gasto Desconocido ${idx + 1}`),
                amount: Number(g.amount) || 0, isCashCollection: !!g.isCashCollection
            }));
            loadedUser = ipv.user || '';
            notasDiaActual = ipv.notas || '';
        } catch (e) {
            console.error("Error parseando datos guardados para "+fecha+":", e);
            alert("Error al cargar los datos guardados para hoy. Se iniciar√° vac√≠o.");
            products = []; gastos = []; loadedUser = ''; notasDiaActual = '';
        }
    } else {
        console.log("No hay datos guardados para hoy, buscando d√≠a anterior (para productos)...");
        const ipvDataAnteriorProductos = localStorage.getItem(IPV_STORAGE_PREFIX + fechaAnteriorStr);
        if (ipvDataAnteriorProductos) {
            try {
                const ipvAnterior = JSON.parse(ipvDataAnteriorProductos);
                 const prevProductCategories = new Set((ipvAnterior.products || []).map(p => String(p.category || 'Otros').trim()).filter(Boolean));
                 let categoriesChangedPrev = false;
                 prevProductCategories.forEach(cat => {
                     if (cat && !managedCategories.some(mc => mc === cat)) {
                          console.warn(`La categor√≠a "${cat}" encontrada en los datos del d√≠a anterior ${fechaAnteriorStr} no est√° en la lista gestionada. A√±adi√©ndola.`);
                          managedCategories.push(cat);
                          categoriesChangedPrev = true;
                     }
                 });
                 if (categoriesChangedPrev) {
                     saveCategories(managedCategories);
                     populateCategoryDropdown(document.getElementById('modal-product-category'));
                 }
                 products = (ipvAnterior.products || []).map((p, idx) => {
                    const startValue = Number(p.finales) || 0;
                    const cost = Number(p.cost) || 0;
                    const price = Number(p.price || 0);
                    return {
                        id: Date.now().toString(36) + Math.random().toString(36).substr(2) + idx, name: String(p.name || `Producto Desconocido ${idx + 1}`),
                        category: String(p.category || 'Otros'), unit: String(p.unit || DEFAULT_PRODUCT_UNIT), start: startValue, entrada: 0,
                        finales: startValue, vendido: 0, cost: cost, price: price, importe: 0, ganancias: 0, image: ''
                    };
                });
                gastos = [];
                loadedUser = '';
                notasDiaActual = ''; // Notas del d√≠a actual vac√≠as
                console.log(`Productos inicializados desde el d√≠a anterior (${fechaAnteriorStr}): ${products.length} productos. Notas del d√≠a actual vac√≠as.`);
            } catch(e) {
                 console.error("Error parseando datos del d√≠a anterior ("+fechaAnteriorStr+"): ", e);
                 products = []; gastos = []; loadedUser = ''; notasDiaActual = '';
                 alert("Error al cargar datos del d√≠a anterior. Se iniciar√° vac√≠o.");
            }
        } else {
             console.log("Tampoco hay datos del d√≠a anterior para productos. Empezando d√≠a vac√≠o.");
             products = []; gastos = []; loadedUser = ''; notasDiaActual = '';
        }
    }

    const notasTextarea = document.getElementById('notas-dia');
    if (notasTextarea) {
        notasTextarea.value = notasDiaActual;
    }

    if (searchInput) searchInput.value = '';
    if (userSelector) userSelector.value = loadedUser;
    if (workerDisplay) workerDisplay.textContent = loadedUser || 'Seleccionar...';
    renderProducts();
    renderGastos();
    updateDateDisplay(fecha);
    updateSelectionState();
    updateToggleAllButtonState();
}

function mostrarNotasDiaAnterior(notas, fechaDiaAnterior) {
    if (previousDayNotesModal && previousDayNotesContent) {
        let fechaFormateadaAnterior = fechaDiaAnterior;
        try {
            const [y, m, d] = fechaDiaAnterior.split('-');
            fechaFormateadaAnterior = `${d}/${m}/${y}`;
        } catch (e) {}

        previousDayNotesModal.querySelector('h2').innerHTML = `üìù Notas Importantes del D√≠a Anterior (${fechaFormateadaAnterior})`;
        previousDayNotesContent.textContent = notas;
        previousDayNotesModal.style.display = 'flex';
    }
}

function closePreviousDayNotesModal() {
    if (previousDayNotesModal) {
        previousDayNotesModal.style.display = 'none';
    }
}

function guardarNotasManualmente() {
    const notasTextarea = document.getElementById('notas-dia');
    if (notasTextarea) {
        notasDiaActual = notasTextarea.value;
        const currentDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        guardarIPV(currentDate);
        alert("Notas guardadas para el d√≠a actual.");
    }
}

function addProduct() {
    const namesInput = document.getElementById('modal-product-name');
    const startInput = document.getElementById('modal-product-start');
    const costInput = document.getElementById('modal-product-cost');
    const priceInput = document.getElementById('modal-product-price');
    const categorySelect = document.getElementById('modal-product-category');
    const unitSelect = document.getElementById('modal-product-unit');

    if (!namesInput || !startInput || !costInput || !priceInput || !categorySelect || !unitSelect) {
        console.error("Error: Elementos del modal de producto no encontrados.");
        return;
    }
    const names = namesInput.value.split(',').map(n => n.trim()).filter(n => n);
    const start = parseInt(startInput.value, 10) || 0;
    const cost = parseFloat(costInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const category = categorySelect.value;
    const unit = unitSelect.value || DEFAULT_PRODUCT_UNIT;
    let addedCount = 0;
    let skippedCount = 0;

    if (names.length === 0) {
        alert("Por favor, introduce al menos un nombre de producto v√°lido.");
        return;
    }
    names.forEach(trimmedName => {
        const exists = products.some(p =>
            p.name.toLowerCase() === trimmedName.toLowerCase() &&
            p.category.toLowerCase() === category.toLowerCase()
        );
        if (exists) {
            console.warn(`Producto "${trimmedName}" en categor√≠a "${category}" ya existe hoy. Omitiendo.`);
            skippedCount++;
        } else {
            const product = {
                id: Date.now().toString(36) + Math.random().toString(36).substr(2) + addedCount, name: trimmedName, image: '', category, unit,
                start, entrada: 0, finales: start, cost, price
            };
            product.vendido = Math.max(0, product.start + product.entrada - product.finales);
            product.importe = product.vendido * product.price;
            product.ganancias = product.importe - (product.vendido * product.cost);
            products.push(product);
            addedCount++;
        }
    });
    if (addedCount > 0) {
        if (searchInput) searchInput.value = '';
        namesInput.value = ''; startInput.value = ''; costInput.value = ''; priceInput.value = '';
        unitSelect.value = DEFAULT_PRODUCT_UNIT;
        const otrosIndex = managedCategories.findIndex(c => c.toLowerCase() === 'otros');
        categorySelect.selectedIndex = (otrosIndex !== -1) ? otrosIndex : (categorySelect.options.length > 0 ? categorySelect.options.length - 1 : 0);
        renderProducts();
        guardarIPV(dateInput.value);
        toggleModal();
        updateSelectionState();
        alert(`${addedCount} producto(s) a√±adido(s).` + (skippedCount > 0 ? ` ${skippedCount} omitido(s) por duplicado.` : ''));
    } else if (skippedCount > 0) {
        alert(`No se a√±adieron nuevos productos. ${skippedCount} ya exist√≠an en la categor√≠a "${category}" para este d√≠a.`);
    }
}

function renderProducts() {
    if (!productListTbody) return;
    const categoryStates = {};
    document.querySelectorAll('.category-header').forEach(header => {
        const catId = header.dataset.categoryId;
        const icon = header.querySelector('.toggle-icon');
        if (catId && icon) { categoryStates[catId] = icon.textContent === '-'; }
    });
    const previouslySelectedIds = getSelectedProductIds();
    productListTbody.innerHTML = '';

    const groupedProducts = products.reduce((acc, product) => {
        const category = product.category || 'Otros';
        if (!acc[category]) acc[category] = [];
        acc[category].push(product);
        return acc;
    }, {});

    const sortedCategoryNames = [...managedCategories];
    Object.keys(groupedProducts).forEach(cat => {
        if (!sortedCategoryNames.includes(cat)) {
            sortedCategoryNames.push(cat); // A√±adir si no est√° para asegurar que se muestre
        }
    });
    // Filtrar solo las categor√≠as que realmente tienen productos *en el d√≠a actual*
    const categoriesWithProductsToday = sortedCategoryNames.filter(cat => groupedProducts[cat] && groupedProducts[cat].length > 0);


    if (products.length === 0) {
        productListTbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 15px;">No hay productos registrados para hoy. A√±ade uno o reinicia desde ayer.</td></tr>`;
        calculateTotals();
        updateSelectionState();
        updateToggleAllButtonState();
        return;
    }

    const isSensitiveVisible = isPinActive;
    const hiddenClassAttr = isSensitiveVisible ? '' : ' class="hidden"';

    categoriesWithProductsToday.forEach(category => {
        const categoryProducts = groupedProducts[category].sort((a, b) => a.name.localeCompare(b.name));
        const categoryId = 'category-' + category.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
        const isExpanded = categoryStates[categoryId] === undefined ? true : categoryStates[categoryId];

        const categoryHeaderRow = document.createElement('tr');
        categoryHeaderRow.classList.add('category-header');
        categoryHeaderRow.dataset.categoryId = categoryId;
        categoryHeaderRow.innerHTML = `<td colspan="11" onclick="toggleCategory('${categoryId}')" style="cursor: pointer;">${category}<span class="toggle-icon" id="icon-${categoryId}">${isExpanded ? '-' : '+'}</span></td>`;
        productListTbody.appendChild(categoryHeaderRow);

        categoryProducts.forEach((product) => {
            const globalIndex = products.findIndex(p => p.id === product.id);
            if (globalIndex !== -1) {
                const isChecked = previouslySelectedIds.includes(product.id);
                const productRow = document.createElement('tr');
                productRow.classList.add('product-row', categoryId);
                productRow.dataset.productId = product.id;

                let hasError = false;
                let errorTitle = `Nombre: ${product.name}\nCategor√≠a: ${product.category}\nUnidad: ${product.unit || DEFAULT_PRODUCT_UNIT}`;
                const inicio = Number(product.start) || 0;
                const entrada = Number(product.entrada) || 0;

                if (typeof product.finales === 'number') {
                    if (product.finales > (inicio + entrada)) {
                        hasError = true;
                        errorTitle = `Error: Finales (${product.finales}) > Inicio (${inicio}) + Entrada (${entrada}). Total=${inicio + entrada}`;
                    }
                }
                productRow.classList.toggle('fila-error', hasError);

                const isStockZero = (typeof product.finales === 'number' && product.finales === 0);
                productRow.classList.toggle('fila-stock-cero', isStockZero);
                if (isStockZero && !hasError) {
                   errorTitle = `¬°STOCK CERO!\nNombre: ${product.name}\nCategor√≠a: ${product.category}\nUnidad: ${product.unit || DEFAULT_PRODUCT_UNIT}`;
                }

                const finalesDisplayValue = (product.finales === null || product.finales === undefined || product.finales === '') ? '' : product.finales;

                productRow.innerHTML = `
                    <td><input type="checkbox" class="product-select-checkbox" data-product-id="${product.id}" onchange="updateSelectionState()" ${isChecked ? 'checked' : ''}></td>
                    <td>
                        <input type="text" value="${product.name || ''}" onchange="updateProduct(${globalIndex}, 'name', this.value)">
                        <span style='font-size:0.8em; color:#aaa; display:block;'>${product.unit && product.unit !== DEFAULT_PRODUCT_UNIT ? product.unit : ''}</span>
                    </td>
                    <td><input type="number" value="${product.start}" onchange="updateProduct(${globalIndex}, 'start', this.value)"></td>
                    <td><input type="number" value="${product.entrada}" onchange="updateProduct(${globalIndex}, 'entrada', this.value)"></td>
                    <td><input type="number" value="${finalesDisplayValue}" onchange="updateProduct(${globalIndex}, 'finales', this.value)" placeholder="N/A"></td>
                    <td>${product.vendido}</td>
                    <td ${hiddenClassAttr}><input type="number" step="0.01" value="${product.cost.toFixed(2)}" onchange="updateProduct(${globalIndex}, 'cost', this.value)"></td>
                    <td><input type="number" step="0.01" value="${product.price.toFixed(2)}" onchange="updateProduct(${globalIndex}, 'price', this.value)"></td>
                    <td>${product.importe.toFixed(2)}</td>
                    <td ${hiddenClassAttr}>${isSensitiveVisible ? product.ganancias.toFixed(2) : ''}</td>
                    <td><button class="delete-button" onclick="requestDeleteProduct(${globalIndex})">Eliminar</button></td>
                `;
                const nameInputTd = productRow.querySelector('td:nth-child(2)');
                if(nameInputTd) nameInputTd.style.verticalAlign = 'top';
                const nameInput = productRow.querySelector('td:nth-child(2) input');
                if(nameInput) nameInput.style.width = '100%';

                if (!isExpanded) { productRow.classList.add('hidden'); }
                productListTbody.appendChild(productRow);

                 const finalRowElement = productListTbody.querySelector(`tr[data-product-id="${product.id}"]`);
                 if (finalRowElement) {
                       finalRowElement.title = errorTitle;
                 }
            }
        });
    });
    searchProducts();
    calculateTotals();
    updateSelectionState();
    updateToggleAllButtonState();
}

// --- Funciones de Tabla ---
function searchProducts() {
    if (!searchInput || !productListTbody) return;
    const searchTerm = searchInput.value.trim().toLowerCase();
    const allProductRows = productListTbody.querySelectorAll('tr.product-row');
    const allCategoryHeaders = productListTbody.querySelectorAll('tr.category-header');

    allProductRows.forEach(row => {
        const productNameCell = row.querySelector('td:nth-child(2) input[type="text"]');
        const productName = productNameCell ? productNameCell.value.toLowerCase() : '';
        const productId = row.dataset.productId;
        const productData = products.find(p => p.id === productId);
        const categoryName = productData ? productData.category.toLowerCase() : '';
        const matches = productName.includes(searchTerm) || categoryName.includes(searchTerm);
        const categoryId = productData ? 'category-' + productData.category.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase() : null;
        const header = categoryId ? productListTbody.querySelector(`tr.category-header[data-category-id="${categoryId}"]`) : null;
        const icon = header ? header.querySelector('.toggle-icon') : null;
        const isCategoryExpanded = icon ? icon.textContent === '-' : true;
        row.style.display = (matches && isCategoryExpanded) ? '' : 'none';
        row.classList.toggle('search-hidden', !matches);
    });

    allCategoryHeaders.forEach(header => {
        const categoryId = header.dataset.categoryId;
        const categoryNameElement = header.querySelector('td');
        const categoryName = categoryNameElement ? categoryNameElement.firstChild.textContent.trim().toLowerCase() : '';
        const hasVisibleProducts = !!productListTbody.querySelector(`tr.product-row.${categoryId}:not(.search-hidden)[style*="display: table-row"], tr.product-row.${categoryId}:not(.search-hidden)[style*="display: block"], tr.product-row.${categoryId}:not(.search-hidden)[style*="display: flex"], tr.product-row.${categoryId}:not(.search-hidden)[style=""]`);
        const categoryMatchesSearch = categoryName.includes(searchTerm);
        header.style.display = (hasVisibleProducts || categoryMatchesSearch) ? '' : 'none';
        if (header.style.display !== 'none' && categoryMatchesSearch) {
            const icon = header.querySelector('.toggle-icon');
            if (icon && icon.textContent === '+') {
                toggleCategory(categoryId, true);
            }
        }
    });
    updateSelectionState();
    calculateTotals();
    updateToggleAllButtonState();
}

function calculateTotals() {
    let totalImporteDia = 0, totalGananciasDia = 0, totalGastosDirecto = 0;
    let totalStockCost = 0, totalStockValue = 0;
    products.forEach(p => {
        totalImporteDia += Number(p.importe) || 0;
        totalGananciasDia += Number(p.ganancias) || 0;
        const finalesNum = (typeof p.finales === 'number') ? p.finales : 0;
        totalStockCost += finalesNum * (Number(p.cost) || 0);
        totalStockValue += finalesNum * (Number(p.price) || 0);
    });
    gastos.forEach(g => { totalGastosDirecto += g.amount || 0; });
    const totalNetoDia = totalImporteDia - totalGastosDirecto;
    const totalImporteSpan = document.getElementById('total-importe');
    const totalGananciasSpan = document.getElementById('total-ganancias');
    const totalStockCostSpan = document.getElementById('total-stock-cost');
    const totalStockValueSpan = document.getElementById('total-stock-value');
    const totalGastosDisplaySpan = document.getElementById('total-gastos-display');
    const totalGastosInSectionSpan = document.getElementById('total-gastos');
    const totalDespuesGastosSpan = document.getElementById('total-despues-gastos');
    if (totalImporteSpan) totalImporteSpan.textContent = totalImporteDia.toFixed(2);
    if (totalGananciasSpan) totalGananciasSpan.textContent = totalGananciasDia.toFixed(2);
    if (totalStockCostSpan) totalStockCostSpan.textContent = totalStockCost.toFixed(2);
    if (totalStockValueSpan) totalStockValueSpan.textContent = totalStockValue.toFixed(2);
    if (totalGastosDisplaySpan) totalGastosDisplaySpan.textContent = totalGastosDirecto.toFixed(2);
    if (totalGastosInSectionSpan) totalGastosInSectionSpan.textContent = totalGastosDirecto.toFixed(2);
    if (totalDespuesGastosSpan) totalDespuesGastosSpan.textContent = totalNetoDia.toFixed(2);
    const isCurrentlySensitiveVisible = isPinActive;
    document.querySelector('#total-ganancias')?.parentElement.classList.toggle('hidden', !isCurrentlySensitiveVisible);
    document.querySelector('#total-stock-cost')?.parentElement.classList.toggle('hidden', !isCurrentlySensitiveVisible);
    document.querySelector('#total-stock-value')?.parentElement.classList.toggle('hidden', !isCurrentlySensitiveVisible);
    document.querySelector('#totales hr:last-of-type')?.classList.toggle('hidden', !isCurrentlySensitiveVisible);
    updateDateDisplay(dateInput ? dateInput.value : new Date().toISOString().split('T')[0]);
}

function updateProduct(index, field, value) {
    if (index < 0 || index >= products.length) return;
    const product = products[index];
    switch (field) {
        case 'name': product[field] = value.trim(); break;
        case 'cost': case 'price':
            product[field] = Math.max(0, parseFloat(value) || 0); break;
        case 'start': case 'entrada':
            product[field] = Math.max(0, parseInt(value, 10) || 0); break;
        case 'finales':
            product[field] = (value === null || value === undefined || value === '') ? '' : Math.max(0, parseInt(value, 10) || 0);
            break;
        default: console.warn(`Intento de actualizar campo desconocido: ${field}`); return;
    }
    const { start = 0, entrada = 0, cost = 0, price = 0 } = product;
    const finalesNum = (typeof product.finales === 'number') ? product.finales : 0;
    product.vendido = (typeof product.finales === 'number') ? Math.max(0, start + entrada - finalesNum) : 0;
    product.importe = product.vendido * price;
    product.ganancias = product.importe - (product.vendido * cost);
    const row = productListTbody.querySelector(`tr[data-product-id="${product.id}"]`);
    if (row) {
        const inputElement = row.querySelector(`td:nth-child(${getFieldColumnIndex(field)}) input`);
        const stringValue = String(value);
        if (inputElement && inputElement.value !== stringValue) {
            if (field === 'cost' || field === 'price') {
                inputElement.value = product[field].toFixed(2);
            } else if (field === 'finales' && value === '') {
                inputElement.value = '';
            } else {
                inputElement.value = value;
            }
        }
        const vendidoCell = row.querySelector('td:nth-child(6)');
        const importeCell = row.querySelector('td:nth-child(9)');
        const gananciasCell = row.querySelector('td:nth-child(10)');
        if (vendidoCell) vendidoCell.textContent = product.vendido;
        if (importeCell) importeCell.textContent = product.importe.toFixed(2);
        if (gananciasCell && !gananciasCell.classList.contains('hidden')) {
            gananciasCell.textContent = product.ganancias.toFixed(2);
        } else if (gananciasCell) {
            gananciasCell.textContent = '';
        }
        let hasError = false;
        let errorTitle = `Nombre: ${product.name}\nCategor√≠a: ${product.category}\nUnidad: ${product.unit || DEFAULT_PRODUCT_UNIT}`;
        if (['start', 'entrada', 'finales'].includes(field) || field === 'finales') {
            const inicioCheck = Number(product.start) || 0;
            const entradaCheck = Number(product.entrada) || 0;
            if (typeof product.finales === 'number' && product.finales > (inicioCheck + entradaCheck)) {
                hasError = true;
                errorTitle = `Error: Finales (${product.finales}) > Inicio (${inicioCheck}) + Entrada (${entradaCheck}). Total=${inicioCheck + entradaCheck}`;
            }
        }
        row.classList.toggle('fila-error', hasError);

        const isStockZero = (typeof product.finales === 'number' && product.finales === 0);
        row.classList.toggle('fila-stock-cero', isStockZero);
        if (hasError) {
            // errorTitle ya est√° seteado
        } else if (isStockZero) {
            errorTitle = `¬°STOCK CERO!\nNombre: ${product.name}\nCategor√≠a: ${product.category}\nUnidad: ${product.unit || DEFAULT_PRODUCT_UNIT}`;
        }
        row.title = errorTitle;
    } else {
        console.warn("Fila del producto no encontrada en el DOM para actualizar:", product.id);
    }
    calculateTotals();
    guardarIPV(dateInput.value);
}

function getFieldColumnIndex(field) {
    switch (field) {
        case 'name': return 2; case 'start': return 3; case 'entrada': return 4; case 'finales': return 5;
        case 'cost': return 7; case 'price': return 8; default: return -1;
    }
}

function deleteProduct(index) {
    if (index >= 0 && index < products.length) {
        const productName = products[index].name;
        products.splice(index, 1);
        console.log(`Producto "${productName}" eliminado.`);
        if (searchInput) searchInput.value = '';
        renderProducts();
        guardarIPV(dateInput.value);
        calculateAndDisplayGeneralSummary();
        updateSelectionState();
    }
}

// --- Funciones Gastos ---
function addGasto() {
    const descriptionInput = document.getElementById('gastos-description');
    const amountInput = document.getElementById('gastos-amount');
    const isCashCollectionCheckbox = document.getElementById('gasto-is-cash-collection');
    const description = descriptionInput.value.trim();
    const amount = parseFloat(amountInput.value) || 0;
    const isCashCollection = isCashCollectionCheckbox.checked;
    if (description && amount > 0) {
        const gasto = { id: Date.now().toString(36) + Math.random().toString(36).substr(2) + 'g', description, amount, isCashCollection };
        gastos.push(gasto);
        descriptionInput.value = ''; amountInput.value = ''; isCashCollectionCheckbox.checked = false;
        renderGastos();
        guardarIPV(dateInput.value);
        toggleGastosModal();
        calculateAndDisplayGeneralSummary();
    } else {
        alert("Por favor, ingresa una descripci√≥n v√°lida y un monto mayor que cero.");
    }
}

function renderGastos() {
    if (!gastosListDiv) return;
    gastosListDiv.innerHTML = '';
    let totalGastosDiarios = 0;
    if (gastos.length === 0) {
        gastosListDiv.innerHTML = '<p style="text-align:center; color: #888; padding: 10px 0;">No hay gastos ni recogidas registradas hoy.</p>';
    } else {
        const sortedGastos = [...gastos].sort((a, b) => a.description.localeCompare(b.description));
        sortedGastos.forEach((gasto) => {
            totalGastosDiarios += gasto.amount;
            const gastoItem = document.createElement('div');
            gastoItem.classList.add('gasto-item');
            gastoItem.dataset.isCollection = gasto.isCashCollection;
            const displayDescription = gasto.isCashCollection ? `${gasto.description} <em style="font-size:0.85em; color:#f39c12;">(Recogida Efec.)</em>` : gasto.description;
            const globalIndex = gastos.findIndex(g => g.id === gasto.id);
            if (globalIndex !== -1) {
                gastoItem.innerHTML = `<span>${displayDescription} - $${gasto.amount.toFixed(2)}</span> <button onclick="requestDeleteGasto(${globalIndex})">Eliminar</button>`;
                gastosListDiv.appendChild(gastoItem);
            }
        });
    }
    const totalGastosSpan = document.getElementById('total-gastos');
    if (totalGastosSpan) totalGastosSpan.textContent = totalGastosDiarios.toFixed(2);
    calculateTotals();
}

function deleteGasto(index) {
    if (index >= 0 && index < gastos.length) {
        const gastoDesc = gastos[index].description;
        gastos.splice(index, 1);
        console.log(`Gasto/Recogida "${gastoDesc}" eliminado.`);
        renderGastos();
        guardarIPV(dateInput.value);
        calculateAndDisplayGeneralSummary();
    }
}

// --- Funciones Modales ---
function toggleModal() {
    const isVisible = productModal.style.display === "flex";
    if (!isVisible) {
        populateCategoryDropdown(document.getElementById('modal-product-category'));
        document.getElementById('modal-product-name').value = ''; document.getElementById('modal-product-start').value = '';
        document.getElementById('modal-product-cost').value = ''; document.getElementById('modal-product-price').value = '';
        document.getElementById('modal-product-unit').value = DEFAULT_PRODUCT_UNIT;
        const categorySelect = document.getElementById('modal-product-category');
        const otrosIndex = managedCategories.findIndex(c => c.toLowerCase() === 'otros');
        categorySelect.selectedIndex = (otrosIndex !== -1) ? otrosIndex : (categorySelect.options.length > 0 ? categorySelect.options.length - 1 : 0);
        productModal.style.display = "flex";
        const firstInput = document.getElementById('modal-product-category');
        if (firstInput) setTimeout(() => firstInput.focus(), 50);
    } else {
        productModal.style.display = "none";
    }
}
function toggleGastosModal() {
    const isVisible = gastosModal.style.display === "flex";
    gastosModal.style.display = isVisible ? "none" : "flex";
    if (!isVisible) {
        document.getElementById('gastos-description').value = ''; document.getElementById('gastos-amount').value = '';
        document.getElementById('gasto-is-cash-collection').checked = false;
        const firstInput = document.getElementById('gastos-description');
        if (firstInput) setTimeout(() => firstInput.focus(), 50);
    }
}
function showConfirmModal(type, index) {
    itemToDelete = index; deleteType = type;
    const confirmMessage = confirmModal.querySelector('p');
    if (confirmMessage) {
        let itemName = '';
        if (type === 'producto' && index >= 0 && index < products.length) { itemName = `"${products[index].name}"`; }
        else if (type === 'gasto' && index >= 0 && index < gastos.length) { itemName = `"${gastos[index].description}"`; }
        confirmMessage.textContent = `¬øEst√°s seguro de que deseas eliminar ${type === 'producto' ? 'el producto' : 'el gasto/recogida'} ${itemName}? Esta acci√≥n no se puede deshacer.`;
    }
    confirmModal.style.display = 'flex';
    document.getElementById('confirmNo').focus();
}
function hideConfirmModal() { confirmModal.style.display = 'none'; itemToDelete = null; deleteType = ''; }
function handleConfirmYes() {
    if (deleteType === 'producto') { deleteProduct(itemToDelete); }
    else if (deleteType === 'gasto') { deleteGasto(itemToDelete); }
    hideConfirmModal();
}
function requestDeleteProduct(index) { showConfirmModal('producto', index); }
function requestDeleteGasto(index) { showConfirmModal('gasto', index); }

// --- Funciones Modal Stock Cero (Nuevo) ---
function showZeroStockModal() {
    if (!zeroStockModal) return;
    const zeroStockListUl = document.getElementById('zeroStockList');
    if (!zeroStockListUl) return;

    zeroStockListUl.innerHTML = ''; // Clear previous list

    const zeroStockProducts = products.filter(p => typeof p.finales === 'number' && p.finales === 0);

    if (zeroStockProducts.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No hay productos con stock cero para el d√≠a actual.';
        li.style.textAlign = 'center';
        li.style.padding = '20px';
        li.style.color = '#888';
        zeroStockListUl.appendChild(li);
    } else {
        zeroStockProducts.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
            const li = document.createElement('li');
            li.textContent = `${p.name} (Categor√≠a: ${p.category || 'Otros'})`;
            zeroStockListUl.appendChild(li);
        });
    }
    zeroStockModal.style.display = 'flex';
}

function closeZeroStockModal() {
    if (zeroStockModal) {
        zeroStockModal.style.display = 'none';
    }
}


// --- Funciones Importar/Exportar ---
function triggerJsonDownload(dataObject, filename) {
    try {
        const jsonData = JSON.stringify(dataObject, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        console.log(`Archivo ${filename} listo para descargar.`);
    } catch (error) { console.error("Error al generar el archivo de descarga JSON:", error); alert(`Error al crear el archivo JSON: ${error.message}`); }
}

function exportCurrentDayData() {
    if (!dateInput || !dateInput.value) { alert("Por favor, selecciona una fecha v√°lida."); return; }
    const currentDateStr = dateInput.value;
    if (!/^\d{4}-\d{2}-\d{2}$/.test(currentDateStr)) { alert(`La fecha seleccionada '${currentDateStr}' no es v√°lida.`); return; }
    if (products.length === 0 && gastos.length === 0 && notasDiaActual.trim() === '') { alert(`No hay datos (productos, gastos o notas) para exportar en el d√≠a ${currentDateStr}.`); return; }
    try {
        const notasTextarea = document.getElementById('notas-dia');
        const currentNotes = notasTextarea ? notasTextarea.value : notasDiaActual;

        const validatedData = {
            products: products.map(p => ({ name:String(p.name||''), category:String(p.category||'Otros'), unit: String(p.unit || DEFAULT_PRODUCT_UNIT), start:Number(p.start||0), entrada:Number(p.entrada||0), finales: (p.finales === '' || p.finales === null || p.finales === undefined) ? '' : Number(p.finales||0), cost:Number(p.cost||0), price:Number(p.price||0) })),
            gastos: gastos.map(g => ({ description: String(g.description || ''), amount: Number(g.amount || 0), isCashCollection: !!g.isCashCollection })),
            user: String(userSelector ? userSelector.value : ''),
            notas: currentNotes
        };
        const dataToExport = { appVersion: APP_EXPORT_VERSION, exportTimestamp: new Date().toISOString(), dataType: 'singleDay', date: currentDateStr, managedCategories: managedCategories, data: validatedData };
        const filename = `IPV_Backup_Dia_${currentDateStr.replace(/-/g, '')}.json`;
        triggerJsonDownload(dataToExport, filename);
        alert(`Exportaci√≥n del d√≠a ${currentDateStr} iniciada.`);
    } catch (error) { console.error(`Error al procesar o exportar datos para ${currentDateStr}:`, error); alert(`Error al exportar los datos del d√≠a ${currentDateStr}: ${error.message}`); }
}

function promptExportMonthData() {
    const yearInput = prompt("Ingresa el a√±o (4 d√≠gitos) a exportar (ej: 2024):", new Date().getFullYear());
    if (yearInput === null || yearInput.trim() === '') { alert("Exportaci√≥n cancelada."); return; }
    const year = parseInt(yearInput, 10);
    if (isNaN(year) || year < 2000 || year > 2100) { alert("A√±o inv√°lido."); return; }
    const monthInput = prompt(`Ingresa el mes para ${year} (1=Ene, 12=Dic):`, new Date().getMonth() + 1);
    if (monthInput === null || monthInput.trim() === '') { alert("Exportaci√≥n cancelada."); return; }
    const month = parseInt(monthInput, 10);
    if (isNaN(month) || month < 1 || month > 12) { alert("Mes inv√°lido."); return; }
    exportMonthData(year, month);
}

function exportMonthData(year, month) {
    const monthString = String(month).padStart(2, '0');
    const targetMonthPrefix = `${year}-${monthString}-`;
    console.log(`Buscando datos para exportar del mes: ${year}-${monthString}`);
    const monthHistoricalData = {}; let daysFound = 0; const keys = Object.keys(localStorage);
    for (const key of keys) {
        if (key.startsWith(IPV_STORAGE_PREFIX)) {
            const date = key.substring(IPV_STORAGE_PREFIX.length);
            if (/^\d{4}-\d{2}-\d{2}$/.test(date) && date.startsWith(targetMonthPrefix)) {
                try {
                    const dayDataString = localStorage.getItem(key);
                    if (dayDataString) {
                        const dayData = JSON.parse(dayDataString);
                        const validatedData = {
                            products: (dayData.products || []).map(p => ({ name:String(p.name||''), category:String(p.category||'Otros'), unit: String(p.unit || DEFAULT_PRODUCT_UNIT), start:Number(p.start||0), entrada:Number(p.entrada||0), finales: (p.finales === '' || p.finales === null || p.finales === undefined) ? '' : Number(p.finales||0), cost:Number(p.cost||0), price:Number(p.price||0) })),
                            gastos: (dayData.gastos || []).map(g => ({ description: String(g.description || ''), amount: Number(g.amount || 0), isCashCollection: !!g.isCashCollection })),
                            user: String(dayData.user || ''),
                            notas: String(dayData.notas || '')
                        };
                        monthHistoricalData[date] = validatedData; daysFound++;
                    }
                } catch (e) { console.warn(`Error procesando datos del d√≠a ${date} para exportaci√≥n mensual:`, e); }
            }
        }
    }
    if (daysFound === 0) { alert(`No se encontraron datos para el mes ${monthString}/${year}.`); return; }
    const dataToExport = { appVersion: APP_EXPORT_VERSION, exportTimestamp: new Date().toISOString(), dataType: 'monthly', month: `${year}-${monthString}`, managedCategories: managedCategories, historicalData: monthHistoricalData };
    const filename = `IPV_Backup_Mes_${year}${monthString}.json`;
    triggerJsonDownload(dataToExport, filename);
    alert(`Exportaci√≥n del mes ${monthString}/${year} (${daysFound} d√≠a/s) iniciada.`);
}

function exportAllData() {
    console.log("Iniciando exportaci√≥n completa...");
    if (!confirm("Esto exportar√° TODO el historial. Puede generar un archivo grande. ¬øContinuar?")) { alert("Exportaci√≥n cancelada."); return; }
    showLoading("Exportando todo el historial...");
    setTimeout(() => {
        try {
            const historicalData = {}; let daysExported = 0; const keys = Object.keys(localStorage);
            for (const key of keys) {
                if (key.startsWith(IPV_STORAGE_PREFIX)) {
                    const date = key.substring(IPV_STORAGE_PREFIX.length);
                    if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                        try {
                            const dayDataString = localStorage.getItem(key);
                            if (dayDataString) {
                                const dayData = JSON.parse(dayDataString);
                                historicalData[date] = {
                                    products: (dayData.products || []).map(p => ({ name:String(p.name||''), category:String(p.category||'Otros'), unit: String(p.unit || DEFAULT_PRODUCT_UNIT), start:Number(p.start||0), entrada:Number(p.entrada||0), finales: (p.finales === '' || p.finales === null || p.finales === undefined) ? '' : Number(p.finales||0), cost:Number(p.cost||0), price:Number(p.price||0) })),
                                    gastos: (dayData.gastos || []).map(g => ({ description: String(g.description || ''), amount: Number(g.amount || 0), isCashCollection: !!g.isCashCollection })),
                                    user: String(dayData.user || ''),
                                    notas: String(dayData.notas || '')
                                };
                                daysExported++;
                            }
                        } catch (e) { console.warn(`Error procesando ${date} para exportaci√≥n completa:`, e); }
                    }
                }
            }
            if (daysExported === 0) { alert("No hay datos hist√≥ricos para exportar."); hideLoading(); return; }
            const dataToExport = { appVersion: APP_EXPORT_VERSION, exportTimestamp: new Date().toISOString(), dataType: 'full', managedCategories: managedCategories, historicalData };
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const filename = `IPV_Backup_Full_${timestamp}.json`;
            triggerJsonDownload(dataToExport, filename);
            hideLoading();
            alert(`Exportaci√≥n completa: ${daysExported} d√≠as y categor√≠as.`);
        } catch (error) { hideLoading(); console.error("Error exportando todo:", error); alert(`Error al exportar todo: ${error.message}`); }
    }, 50);
}

function importAllData(event) {
    const fileInput = event.target;
    const file = fileInput.files[0];
    if (!file || file.type !== 'application/json') {
        alert(`Archivo no v√°lido. Selecciona un archivo .json.`);
        fileInput.value = null;
        return;
    }

    console.log(`Importando desde: ${file.name}`);
    const reader = new FileReader();

    reader.onload = function (e) {
        showLoading("Procesando archivo importado...");
        setTimeout(() => {
            try {
                const importedWrapper = JSON.parse(e.target.result);

                if (!importedWrapper || typeof importedWrapper !== 'object' || (!importedWrapper.historicalData && !(importedWrapper.dataType === 'singleDay' && importedWrapper.data && importedWrapper.date))) {
                    throw new Error("Formato JSON inv√°lido o tipo de dato no reconocido. Falta 'historicalData' o estructura de d√≠a √∫nico.");
                }

                let categoriesImportedFromFile = false;
                if (importedWrapper.managedCategories && Array.isArray(importedWrapper.managedCategories)) {
                    if (confirm("El archivo contiene una lista de categor√≠as gestionadas. ¬øDeseas reemplazar tu lista actual con la del archivo? \n\n(Cancelar usar√° tu lista actual y a√±adir√° las nuevas que encuentre en los productos del archivo)")) {
                        const validImportedCategories = importedWrapper.managedCategories
                            .map(c => String(c || '').trim())
                            .filter(c => c !== '');
                        if (validImportedCategories.length > 0) {
                            saveCategories(validImportedCategories);
                            populateCategoryDropdown(document.getElementById('modal-product-category'));
                            console.log("Lista de categor√≠as gestionadas actualizada desde el archivo.");
                            categoriesImportedFromFile = true;
                        } else {
                            console.warn("Lista de categor√≠as gestionadas en archivo vac√≠a/inv√°lida. No se reemplaz√≥.");
                        }
                    } else {
                        console.log("Importaci√≥n de lista de categor√≠as gestionadas omitida por el usuario. Se intentar√° a√±adir categor√≠as de los productos.");
                    }
                }

                let historicalDataFromFile;
                let datesToImport;
                if (importedWrapper.dataType === 'singleDay' && importedWrapper.date && importedWrapper.data) {
                    historicalDataFromFile = { [importedWrapper.date]: importedWrapper.data };
                    datesToImport = [importedWrapper.date];
                } else if (importedWrapper.historicalData) {
                    historicalDataFromFile = importedWrapper.historicalData;
                    datesToImport = Object.keys(historicalDataFromFile);
                } else {
                    throw new Error("No se pudieron determinar los datos hist√≥ricos a importar.");
                }

                if (datesToImport.length === 0) {
                    throw new Error("El archivo no contiene datos hist√≥ricos v√°lidos.");
                }

                if (!confirm(`‚ö†Ô∏è Se importar√°n/sobrescribir√°n datos para ${datesToImport.length} d√≠a(s). ¬øContinuar?`)) {
                    throw new Error("Importaci√≥n cancelada por el usuario.");
                }

                showLoading(`Importando ${datesToImport.length} d√≠a(s)...`);
                let importedCount = 0, errorCount = 0, skippedInvalidDate = 0, skippedInvalidData = 0;
                let categoriesFoundInData = new Set();

                for (const date of datesToImport) {
                    loadingMessage.textContent = `Procesando ${date}... (${importedCount}/${datesToImport.length})`;
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                        skippedInvalidDate++;
                        errorCount++;
                        console.warn(`Fecha inv√°lida omitida: ${date}`);
                        continue;
                    }
                    const dayData = historicalDataFromFile[date];

                    if (dayData && typeof dayData === 'object' && Array.isArray(dayData.products) && Array.isArray(dayData.gastos) && typeof dayData.user !== 'undefined') {
                        try {
                            const validatedProducts = (dayData.products || []).map(p => {
                                let categoryName = String(p.category || 'Otros').trim();
                                // Normalizar nombres de categor√≠as comunes
                                if (categoryName.toLowerCase() === "nevera") categoryName = "Nevera";
                                if (categoryName.toLowerCase() === "aseo_personal") categoryName = "Aseo Personal";
                                if (categoryName.toLowerCase() === "galletas") categoryName = "Galletas";
                                if (categoryName.toLowerCase() === "sazones") categoryName = "Sazones";
                                if (categoryName.toLowerCase() === "otros") categoryName = "Otros";
                                if (categoryName.toLowerCase() === "rones") categoryName = "Rones";
                                if (categoryName.toLowerCase() === "sorbetos") categoryName = "Sorbetos";
                                if (categoryName.toLowerCase() === "confituras_variadas") categoryName = "Confituras Variadas";
                                if (categoryName.toLowerCase() === "peter") categoryName = "Peter";
                                if (categoryName.toLowerCase() === "dulces") categoryName = "Dulces";

                                if (categoryName && !managedCategories.some(mc => mc === categoryName)) {
                                    categoriesFoundInData.add(categoryName);
                                }
                                return {
                                    id: Date.now().toString(36) + Math.random().toString(36).substr(2) + 'p' + importedCount + String(p.name || '').slice(0,2),
                                    name: String(p.name || 'Importado').trim(),
                                    category: categoryName,
                                    unit: String(p.unit || DEFAULT_PRODUCT_UNIT).trim(),
                                    start: Number(p.start || 0),
                                    entrada: Number(p.entrada || 0),
                                    finales: (p.finales === '' || p.finales === null || p.finales === undefined) ? '' : Number(p.finales || 0),
                                    cost: Number(p.cost || 0),
                                    price: Number(p.price || 0)
                                };
                            });

                            const validatedGastos = (dayData.gastos || []).map(g => ({
                                id: Date.now().toString(36) + Math.random().toString(36).substr(2) + 'g' + importedCount + String(g.description || '').slice(0,2),
                                description: String(g.description || 'Gasto Imp.').trim(),
                                amount: Number(g.amount || 0),
                                isCashCollection: !!g.isCashCollection
                            }));

                            const validatedDayData = {
                                products: validatedProducts,
                                gastos: validatedGastos,
                                user: String(dayData.user || ''),
                                notas: String(dayData.notas || '')
                            };
                            localStorage.setItem(IPV_STORAGE_PREFIX + date, JSON.stringify(validatedDayData));
                            importedCount++;
                        } catch (storageError) {
                            console.error(`Error guardando ${date} importado:`, storageError);
                            errorCount++;
                            if (storageError.name === 'QuotaExceededError') {
                                throw new Error("¬°Error Cr√≠tico! Espacio de almacenamiento lleno durante importaci√≥n.");
                            }
                        }
                    } else {
                        skippedInvalidData++;
                        errorCount++;
                        console.warn(`Datos inv√°lidos/incompletos omitidos para ${date}`);
                    }
                }

                let newCategoriesAddedMessage = "";
                if (categoriesFoundInData.size > 0) {
                    let actuallyAddedToManaged = false;
                    categoriesFoundInData.forEach(catName => {
                        if (!managedCategories.some(mc => mc === catName)) {
                            managedCategories.push(catName);
                            actuallyAddedToManaged = true;
                        }
                    });
                    if (actuallyAddedToManaged) {
                        saveCategories(managedCategories);
                        populateCategoryDropdown(document.getElementById('modal-product-category'));
                        newCategoriesAddedMessage = `- Se a√±adieron ${categoriesFoundInData.size} categor√≠as nuevas desde los productos: ${Array.from(categoriesFoundInData).join(', ')}\n`;
                        console.log(newCategoriesAddedMessage);
                    }
                }

                cachedHistoricalData = null;
                const currentDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
                cargarIPV(currentDate);
                calculateAndDisplayGeneralSummary();

                let message = `Importaci√≥n Finalizada:\n- ${importedCount} d√≠a(s) importado(s)/sobrescrito(s).\n`;
                if (categoriesImportedFromFile) message += "- Lista de categor√≠as gestionadas reemplazada desde archivo.\n";
                message += newCategoriesAddedMessage;
                if (errorCount > 0) {
                    message += `- Errores/Omitidos: ${errorCount} (Fechas Inv√°lidas: ${skippedInvalidDate}, Datos Inv√°lidos: ${skippedInvalidData})\n`;
                    alert(message + "\nRevisa la consola (F12) para m√°s detalles.");
                } else {
                    alert(message);
                }
                console.log(message);

            } catch (error) {
                console.error("Error fatal durante importaci√≥n:", error);
                alert(`Error: ${error.message}\nRevisa la consola (F12) para m√°s detalles.`);
            } finally {
                hideLoading();
                fileInput.value = null;
            }
        }, 50);
    };
    reader.onerror = (err) => {
        console.error("Error leyendo archivo:", err);
        alert("Error al leer el archivo.");
        fileInput.value = null;
    };
    reader.readAsText(file);
}


// --- Funciones PDF ---
function generarPDF() {
    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.autoTable !== 'function') { console.error("Error: jsPDF o jsPDF-AutoTable no cargados."); alert("Error al generar PDF: Librer√≠as no encontradas."); return; }
    showLoading("Generando PDF...");
    setTimeout(() => {
        try {
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); const fechaInforme = dateInput.value; let fechaFormateada = fechaInforme;
            try { const [y, m, d] = fechaInforme.split('-'); fechaFormateada = `${d}/${m}/${y}`; } catch (e) {}
            const logo = new Image(); logo.src = './img/Logo.png';
            const crearContenidoPDF = () => {
                try {
                    let currentY = 15; const pageHeight = doc.internal.pageSize.height; const pageWidth = doc.internal.pageSize.width; const margin = 14;
                    if (logo.complete && logo.naturalWidth > 0) { doc.addImage(logo, 'PNG', margin, currentY - 5, 20, 20); } else { console.warn("Logo no cargado para PDF."); }
                    doc.setFontSize(16); doc.setFont(undefined, 'bold'); doc.text('Inventario y Venta de Productos (IPV)', margin + 25, currentY);
                    doc.setFontSize(12); doc.setFont(undefined, 'normal'); doc.text(`Fecha del Informe: ${fechaFormateada}`, margin + 25, currentY + 7);
                    const currentUser = userSelector ? userSelector.value : ''; if (currentUser) { doc.setFontSize(10); doc.setTextColor(80); doc.text(`Trabajador: ${currentUser}`, margin + 25, currentY + 13); doc.setTextColor(0); } currentY += 25;
                    doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text('Detalle de Productos', margin, currentY); currentY += 6;
                    const showSensitiveData = isPinActive; const pdfTableColumns = ["Producto (Unidad)", "Inicio", "Entr", "Final", "Vend", "Precio", "Importe"];
                    if (showSensitiveData) { pdfTableColumns.splice(5, 0, "Costo"); pdfTableColumns.push("Ganancia"); }
                    const tableRows = []; let subTotalImporte = 0, subTotalGanancia = 0;
                    const groupedProductsPDF = products.reduce((acc, p) => { const cat = p.category || 'Otros'; if (!acc[cat]) acc[cat] = []; acc[cat].push(p); return acc; }, {});
                    const sortedCategoriesPDF = [...managedCategories].filter(cat => groupedProductsPDF[cat]);
                    sortedCategoriesPDF.forEach(category => {
                        tableRows.push([{ content: category, colSpan: pdfTableColumns.length, styles: { halign: 'left', fontStyle: 'bold', fillColor: [220, 220, 220], textColor: 20, fontSize: 9, cellPadding: 2 } }]);
                        groupedProductsPDF[category].sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
                            const nombreConUnidad = p.unit && p.unit !== DEFAULT_PRODUCT_UNIT ? `${p.name} (${p.unit})` : p.name;
                            const finalesPDF = (p.finales === null || p.finales === undefined || p.finales === '') ? 'N/A' : p.finales;
                            const rowData = [nombreConUnidad, p.start, p.entrada, finalesPDF, p.vendido, p.price.toFixed(2), p.importe.toFixed(2)];
                            if (showSensitiveData) { rowData.splice(5, 0, p.cost.toFixed(2)); rowData.push(p.ganancias.toFixed(2)); }
                            tableRows.push(rowData); subTotalImporte += p.importe || 0; subTotalGanancia += p.ganancias || 0;
                        });
                    });
                    const subtotalRow = [{ content: 'Subtotal Productos', colSpan: showSensitiveData ? 6 : 5, styles: { halign: 'right', fontStyle: 'bold' } }, { content: subTotalImporte.toFixed(2), styles: { fontStyle: 'bold', halign: 'right' } }];
                    if (showSensitiveData) { subtotalRow.splice(1, 0, ''); subtotalRow.push({ content: subTotalGanancia.toFixed(2), styles: { fontStyle: 'bold', halign: 'right' } }); }
                    tableRows.push(subtotalRow); const columnStyles = { 0: { cellWidth: 'auto' } };
                    const numStyle = { halign: 'right', cellPadding: { top: 1.5, right: 2, bottom: 1.5, left: 2 }, fontSize: 8 };
                    const numWidthShort = 12, numWidthMed = 16, numWidthLong = 18;
                    columnStyles[1] = { cellWidth: numWidthShort, ...numStyle }; columnStyles[2] = { cellWidth: numWidthShort, ...numStyle }; columnStyles[3] = { cellWidth: numWidthShort, ...numStyle }; columnStyles[4] = { cellWidth: numWidthShort, ...numStyle };
                    if (showSensitiveData) { columnStyles[5] = { cellWidth: numWidthMed, ...numStyle }; columnStyles[6] = { cellWidth: numWidthMed, ...numStyle }; columnStyles[7] = { cellWidth: numWidthLong, ...numStyle }; columnStyles[8] = { cellWidth: numWidthLong, ...numStyle }; }
                    else { columnStyles[5] = { cellWidth: numWidthMed, ...numStyle }; columnStyles[6] = { cellWidth: numWidthLong, ...numStyle }; }
                    doc.autoTable({ head: [pdfTableColumns], body: tableRows, startY: currentY, theme: 'grid', headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold', fontSize: 9, halign: 'center' }, styles: { fontSize: 8, cellPadding: 1.5, overflow: 'linebreak', valign: 'middle' }, columnStyles: columnStyles, didDrawPage: (data) => { currentY = data.cursor.y; } });
                    let finalY = doc.lastAutoTable.finalY || currentY;
                    finalY += 8;
                    if (gastos.length > 0) {
                        if (finalY + 30 > pageHeight) { doc.addPage(); finalY = margin; }
                        doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text('Gastos y Recogidas del D√≠a', margin, finalY); finalY += 6;
                        const gastosData = gastos.map(g => [g.isCashCollection ? `${g.description} (Recogida)` : g.description, g.amount.toFixed(2)]);
                        let totalGastosDiariosPDF = gastos.reduce((sum, g) => sum + (g.amount || 0), 0);
                        gastosData.push([{ content: 'Total Movimientos', styles: { halign: 'right', fontStyle: 'bold' } }, { content: totalGastosDiariosPDF.toFixed(2), styles: { fontStyle: 'bold', halign: 'right' } }]);
                        doc.autoTable({ head: [['Descripci√≥n', 'Monto (CUP)']], body: gastosData, startY: finalY, theme: 'grid', headStyles: { fillColor: [192, 57, 43], textColor: 255, fontStyle: 'bold', fontSize: 9, halign: 'center' }, styles: { fontSize: 8, cellPadding: 2 }, columnStyles: { 0: { cellWidth: 'auto' }, 1: { cellWidth: 40, halign: 'right' } }, didDrawPage: (data) => { finalY = data.cursor.y; } });
                        finalY = doc.lastAutoTable.finalY || finalY;
                    } else { if (finalY + 10 > pageHeight) { doc.addPage(); finalY = margin; } doc.setFontSize(9); doc.setTextColor(150); doc.text('No se registraron gastos ni recogidas hoy.', margin, finalY); doc.setTextColor(0); finalY += 5; }
                    finalY += 10; if (finalY + (showSensitiveData ? 60 : 40) > pageHeight) { doc.addPage(); finalY = margin; }
                    doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text('Resumen del D√≠a', margin, finalY); doc.setFont(undefined, 'normal'); finalY += 6;
                    const pdfTotalImporteDia = parseFloat(document.getElementById('total-importe')?.textContent || 0);
                    const pdfTotalGananciasDia = parseFloat(document.getElementById('total-ganancias')?.textContent || 0);
                    const pdfTotalGastos = parseFloat(document.getElementById('total-gastos-display')?.textContent || 0);
                    const pdfTotalNetoDia = parseFloat(document.getElementById('total-despues-gastos')?.textContent || 0);
                    const pdfTotalStockCost = parseFloat(document.getElementById('total-stock-cost')?.textContent || 0);
                    const pdfTotalStockValue = parseFloat(document.getElementById('total-stock-value')?.textContent || 0);
                    const summaryData = [ ['Total Ingresos Brutos (D√≠a):', `${pdfTotalImporteDia.toFixed(2)} CUP`], ['Total Gastos/Recogidas (D√≠a):', `${pdfTotalGastos.toFixed(2)} CUP`], ['Total Neto Caja (Ingr - Movim):', `${pdfTotalNetoDia.toFixed(2)} CUP`] ];
                    if (showSensitiveData) { summaryData.splice(1, 0, ['Margen Bruto Productos (D√≠a):', `${pdfTotalGananciasDia.toFixed(2)} CUP`]); summaryData.push(['Costo Total en Stock (Estimado):', `${pdfTotalStockCost.toFixed(2)} CUP`]); summaryData.push(['Valor Total en Stock (Precio Venta):', `${pdfTotalStockValue.toFixed(2)} CUP`]); }
                    summaryData.sort((a, b) => { const order = ['Ingresos Brutos', 'Margen Bruto', 'Gastos/Recogidas', 'Neto Caja', 'Valor Total en Stock', 'Costo Total en Stock']; const aIndex = order.findIndex(s => a[0].includes(s)); const bIndex = order.findIndex(s => b[0].includes(s)); return (aIndex === -1 ? 99 : aIndex) - (bIndex === -1 ? 99 : bIndex); });
                    doc.autoTable({ body: summaryData, startY: finalY, theme: 'plain', styles: { fontSize: 9, cellPadding: 1.8 }, columnStyles: { 0: { halign: 'right', cellWidth: 85, fontStyle: 'normal' }, 1: { halign: 'left', fontStyle: 'bold' } } });
                    finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : finalY;

                    const notasActualesPDF = document.getElementById('notas-dia')?.value || notasDiaActual;
                    if (notasActualesPDF.trim() !== '') {
                        finalY += 10;
                        if (finalY + 30 > pageHeight) { doc.addPage(); finalY = margin; }
                        doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text('Notas del D√≠a:', margin, finalY); finalY += 6;
                        doc.setFontSize(9); doc.setFont(undefined, 'normal');
                        const splitNotes = doc.splitTextToSize(notasActualesPDF, pageWidth - (margin * 2));
                        doc.text(splitNotes, margin, finalY);
                        finalY += (splitNotes.length * doc.getTextDimensions('Tg').h);
                    }

                    const pageCount = doc.internal.getNumberOfPages(); for (let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150); doc.text(`P√°gina ${i} de ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: 'right' }); }
                    doc.save(`Informe_IPV_${fechaFormateada.replace(/\//g, '-')}.pdf`); console.log("PDF generado.");
                } catch (pdfError) { console.error("Error durante generaci√≥n contenido PDF:", pdfError); alert(`Error: ${pdfError.message}`); }
                finally { hideLoading(); }
            };
            if (logo.complete && logo.naturalWidth > 0) { setTimeout(crearContenidoPDF, 0); }
            else { logo.onload = crearContenidoPDF; logo.onerror = () => { console.error("Error logo PDF."); crearContenidoPDF(); }; setTimeout(() => { if (!logo.complete || logo.naturalWidth === 0) { console.warn("Logo PDF no carg√≥."); crearContenidoPDF(); } }, 3000); }
        } catch (e) { console.error("Error inicializando jsPDF:", e); alert(`Error PDF: ${e.message}`); hideLoading(); }
    }, 50);
}

// --- Funciones Resumen General y Datos Hist√≥ricos ---
function loadAllHistoricalData(forceReload = false) {
    if (cachedHistoricalData && !forceReload) { console.log("Usando historial cacheado."); return cachedHistoricalData; }
    const startLoadTime = performance.now(); const allData = []; const keys = Object.keys(localStorage); let validKeys = 0;
    for (const key of keys) {
        if (key.startsWith(IPV_STORAGE_PREFIX)) {
            const date = key.substring(IPV_STORAGE_PREFIX.length); if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) continue; validKeys++;
            try {
                const dailyRawData = localStorage.getItem(key);
                if (dailyRawData) {
                    const dailyParsed = JSON.parse(dailyRawData);
                    if (dailyParsed && dailyParsed.products && dailyParsed.gastos) {
                        const processedProducts = (dailyParsed.products || []).map(p => {
                            const start = Number(p.start || 0); const entrada = Number(p.entrada || 0); const finalesNum = (p.finales === '' || p.finales === null || p.finales === undefined) ? 0 : Number(p.finales || 0);
                            const cost = Number(p.cost || 0); const price = Number(p.price || 0); const vendido = Math.max(0, start + entrada - finalesNum);
                            const importe = vendido * price; const ganancias = importe - (vendido * cost);
                            return { ...p, category: String(p.category || 'Otros').trim(), name: String(p.name || 'Desconocido').trim(), unit: String(p.unit || DEFAULT_PRODUCT_UNIT).trim(), start, entrada, finales: finalesNum, cost, price, vendido, importe, ganancias };
                        });
                        const processedGastos = (dailyParsed.gastos || []).map(g => ({ ...g, description: String(g.description || 'Desconocido').trim(), amount: Number(g.amount || 0), isCashCollection: !!g.isCashCollection }));
                        allData.push({ date, products: processedProducts, gastos: processedGastos, user: dailyParsed.user || 'N/A', notas: dailyParsed.notas || '' });
                    } else { console.warn(`Datos incompletos omitidos para ${date} en historial.`); }
                }
            } catch (e) { console.warn(`Error parseando ${date} para historial:`, e); }
        }
    }
    allData.sort((a, b) => a.date.localeCompare(b.date)); const endLoadTime = performance.now();
    console.log(`Historial completo cargado: ${allData.length} d√≠as v√°lidos (${(endLoadTime - startLoadTime).toFixed(1)} ms)`);
    cachedHistoricalData = allData; return allData;
}

function calculateAndDisplayGeneralSummary() {
    console.log("Calculando resumen financiero general..."); const historicalData = loadAllHistoricalData();
    const totalGananciaAcumuladaEl = document.getElementById('total-ganancia-acumulada'); const totalIngresosAcumuladosEl = document.getElementById('total-ingresos-acumulados');
    const totalGastosAcumuladosEl = document.getElementById('total-gastos-acumulados'); const totalBalanceNetoAcumuladoEl = document.getElementById('total-balance-neto-acumulado');
    const periodoAnalizadoEl = document.getElementById('periodo-analizado');
    if (!totalGananciaAcumuladaEl || !totalIngresosAcumuladosEl || !totalGastosAcumuladosEl || !totalBalanceNetoAcumuladoEl || !periodoAnalizadoEl) { console.error("Error DOM: Elementos resumen general no encontrados."); return; }
    if (historicalData.length === 0) {
        totalGananciaAcumuladaEl.textContent = '0.00'; totalIngresosAcumuladosEl.textContent = '0.00'; totalGastosAcumuladosEl.textContent = '0.00'; totalBalanceNetoAcumuladoEl.textContent = '0.00';
        periodoAnalizadoEl.textContent = 'No hay datos hist√≥ricos.'; generalSummarySection?.classList.add('hidden'); return;
    }
    let accumulatedMargin = 0, accumulatedIncome = 0, accumulatedOperationalExpenses = 0;
    historicalData.forEach(day => { day.products.forEach(product => { accumulatedMargin += product.ganancias || 0; accumulatedIncome += product.importe || 0; }); day.gastos.forEach(gasto => { if (!gasto.isCashCollection) { accumulatedOperationalExpenses += gasto.amount || 0; } }); });
    const accumulatedNetBalance = accumulatedIncome - accumulatedOperationalExpenses; const firstDate = historicalData[0].date; const lastDate = historicalData[historicalData.length - 1].date;
    const formatDate = (isoDate) => { try { const [y,m,d] = isoDate.split('-'); return `${d}/${m}/${y}`; } catch { return isoDate; } }
    totalGananciaAcumuladaEl.textContent = accumulatedMargin.toFixed(2); totalIngresosAcumuladosEl.textContent = accumulatedIncome.toFixed(2);
    totalGastosAcumuladosEl.textContent = accumulatedOperationalExpenses.toFixed(2); totalBalanceNetoAcumuladoEl.textContent = accumulatedNetBalance.toFixed(2);
    periodoAnalizadoEl.textContent = `Datos desde ${formatDate(firstDate)} hasta ${formatDate(lastDate)} (${historicalData.length} d√≠as)`;
    const isCurrentlySensitiveVisible = isPinActive; generalSummarySection?.classList.toggle('hidden', !isCurrentlySensitiveVisible);
    totalGananciaAcumuladaEl.parentElement.classList.toggle('hidden', !isCurrentlySensitiveVisible);
}

// --- Funciones Navegaci√≥n y Utilidades Fecha ---
function changeDay(offset) {
    if (!dateInput) return; const currentDateStr = dateInput.value;
    if (!currentDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(currentDateStr)) { console.warn("Fecha actual inv√°lida, estableciendo a hoy."); dateInput.value = new Date().toISOString().split('T')[0]; cargarIPV(dateInput.value); return; }
    try {
        const [year, month, day] = currentDateStr.split('-').map(Number); const currentDate = new Date(Date.UTC(year, month - 1, day));
        if (isNaN(currentDate.getTime())) { throw new Error("Fecha inv√°lida generada"); }
        currentDate.setUTCDate(currentDate.getUTCDate() + offset); const newDateStr = currentDate.toISOString().split('T')[0];
        dateInput.value = newDateStr; dateInput.dispatchEvent(new Event('change', { bubbles: true }));
    } catch (error) { console.error("Error cambiando fecha:", error); alert("Error al cambiar la fecha. Se restablecer√° a hoy."); dateInput.value = new Date().toISOString().split('T')[0]; cargarIPV(dateInput.value); }
}
function updateDateDisplay(fechaISO) {
    const fechaDisplay = document.getElementById('fecha'); if (!fechaDisplay) return; let fechaFormateada = fechaISO;
    try { const [y, m, d] = fechaISO.split('-'); if (y && m && d && y.length === 4 && m.length === 2 && d.length === 2) { fechaFormateada = `${d}/${m}/${y}`; } else { throw new Error("Formato inv√°lido"); } }
    catch (e) { console.warn("No se pudo formatear fecha:", fechaISO); } fechaDisplay.textContent = fechaFormateada;
}

// --- Funci√≥n Reiniciar D√≠a ---
function reloadFromPreviousDay() {
    if (!dateInput) return; const currentDateStr = dateInput.value;
    if (!currentDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(currentDateStr)) { alert("Fecha actual no v√°lida."); return; }
    let previousDateStr = '';
    try { const [year, month, day] = currentDateStr.split('-').map(Number); const currentDate = new Date(Date.UTC(year, month - 1, day)); if (isNaN(currentDate.getTime())) throw new Error("Fecha inv√°lida"); currentDate.setUTCDate(currentDate.getUTCDate() - 1); previousDateStr = currentDate.toISOString().split('T')[0]; }
    catch (error) { console.error("Error calculando fecha anterior:", error); alert("No se pudo calcular la fecha anterior."); return; }
    console.log(`Intentando reiniciar ${currentDateStr} basado en ${previousDateStr}`);
    const ipvDataAnterior = localStorage.getItem(IPV_STORAGE_PREFIX + previousDateStr);
    if (!ipvDataAnterior) { alert(`No se encontraron datos para ${previousDateStr}. No se puede reiniciar.`); return; }
    const confirmation = confirm( `¬øReiniciar COMPLETAMENTE ${currentDateStr} usando 'Finales' de ${previousDateStr}?\n\nADVERTENCIA:\n- Se sobrescribir√°n 'Inicio'.\n- 'Entradas' a 0.\n- 'Finales' igual a 'Inicio'.\n- Se perder√°n ventas y notas de hoy.\n\n¬øContinuar?` );
    if (!confirmation) { alert("Reinicio cancelado."); return; }
    try {
        const ipvAnterior = JSON.parse(ipvDataAnterior); const productosAnteriores = ipvAnterior.products || [];
        let updatedCount = 0, resetNewCount = 0; if (!Array.isArray(products)) { throw new Error("Variable 'products' no es array."); }
        const previousProductsMap = new Map(); productosAnteriores.forEach(p => { const key = `${String(p.category||'Otros').trim().toLowerCase()}-${String(p.name||'').trim().toLowerCase()}`; if (p.name) { previousProductsMap.set(key, p); } });
        const newProductsToday = [];
        products.forEach((productActual) => {
            const currentKey = `${String(productActual.category||'Otros').trim().toLowerCase()}-${String(productActual.name||'').trim().toLowerCase()}`;
            const productoAnteriorMatch = previousProductsMap.get(currentKey);
            if (productoAnteriorMatch) {
                const finalesAnterior = (productoAnteriorMatch.finales === '' || productoAnteriorMatch.finales === null || productoAnteriorMatch.finales === undefined) ? 0 : Number(productoAnteriorMatch.finales || 0);
                newProductsToday.push({ ...productActual, start: finalesAnterior, entrada: 0, finales: finalesAnterior, vendido: 0, importe: 0, ganancias: 0 });
                updatedCount++; previousProductsMap.delete(currentKey);
            } else { console.log(`Producto "${productActual.name}" (${productActual.category}) no encontrado ayer. Reseteando.`); newProductsToday.push({ ...productActual, entrada: 0, finales: productActual.start, vendido: 0, importe: 0, ganancias: 0 }); resetNewCount++; }
        });
        if (previousProductsMap.size > 0) { console.warn(`${previousProductsMap.size} productos de ayer no existen hoy:`, Array.from(previousProductsMap.values()).map(p => `${p.name} (${p.category})`)); }
        products = newProductsToday; gastos = []; notasDiaActual = '';
        const notasTextarea = document.getElementById('notas-dia');
        if (notasTextarea) { notasTextarea.value = ''; }
        console.log(`Reinicio completado. Actualizados: ${updatedCount}. Reiniciados (solo hoy): ${resetNewCount}. Notas reseteadas.`);
        renderProducts(); renderGastos(); guardarIPV(currentDateStr); calculateAndDisplayGeneralSummary();
        alert(`D√≠a ${currentDateStr} reiniciado. Actualizados: ${updatedCount}, Reiniciados: ${resetNewCount}.`);
    } catch (e) { console.error("Error procesando reinicio:", e); alert("Error al reiniciar: " + e.message); cargarIPV(currentDateStr); }
}

// --- Funciones Selecci√≥n de Productos ---
function getSelectedProductIds() { const selectedCheckboxes = productListTbody.querySelectorAll('.product-select-checkbox:checked'); return Array.from(selectedCheckboxes).map(cb => cb.dataset.productId); }
function updateSelectionState() {
    const allVisibleCheckboxes = productListTbody.querySelectorAll('.product-row:not([style*="display: none"]):not(.search-hidden) .product-select-checkbox');
    const selectedVisibleCheckboxes = productListTbody.querySelectorAll('.product-row:not([style*="display: none"]):not(.search-hidden) .product-select-checkbox:checked');
    const selectedCount = selectedVisibleCheckboxes.length; const totalVisibleCount = allVisibleCheckboxes.length;
    if (showSelectionSummaryBtn) { showSelectionSummaryBtn.disabled = selectedCount === 0; showSelectionSummaryBtn.style.display = selectedCount > 0 ? 'inline-block' : 'none'; showSelectionSummaryBtn.textContent = `Ver Resumen (${selectedCount})`; }
    if (selectAllCheckbox) { if (totalVisibleCount === 0) { selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = false; } else { selectAllCheckbox.checked = selectedCount === totalVisibleCount; selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalVisibleCount; } }
}
function toggleSelectAll(masterCheckbox) { const isChecked = masterCheckbox.checked; const visibleCheckboxes = productListTbody.querySelectorAll('.product-row:not([style*="display: none"]):not(.search-hidden) .product-select-checkbox'); visibleCheckboxes.forEach(checkbox => { checkbox.checked = isChecked; }); updateSelectionState(); }

// --- Funciones Modal Resumen Productos Seleccionados ---
function getAvailableMonths() {
    const monthSet = new Set(); const keys = Object.keys(localStorage); const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    for (const key of keys) { if (key.startsWith(IPV_STORAGE_PREFIX)) { const date = key.substring(IPV_STORAGE_PREFIX.length); if (/^\d{4}-\d{2}-\d{2}$/.test(date)) { monthSet.add(date.substring(0, 7)); } } }
    return Array.from(monthSet).sort().map(my => { const [year, month] = my.split('-'); const monthIndex = parseInt(month, 10) - 1; return { value: my, text: `${monthNames[monthIndex]} ${year}` }; });
}
function showProductSummaryModal() {
    const selectedIds = getSelectedProductIds(); if (selectedIds.length === 0) { alert("Selecciona al menos un producto."); return; }
    const selectedProductDetails = products.filter(p => selectedIds.includes(p.id)).map(p => ({ id: p.id, name: String(p.name || '').trim(), category: String(p.category || 'Otros').trim() }));
    currentSelectedProductKeys = new Set(selectedProductDetails.map(p => `${p.category}-${p.name}`));
    const listElement = document.getElementById('selected-products-list'); listElement.innerHTML = ''; selectedProductDetails.forEach(p => { const li = document.createElement('li'); li.textContent = `${p.name} (${p.category})`; listElement.appendChild(li); });
    const availableMonths = getAvailableMonths(); summaryPeriodSelector.innerHTML = '<option value="Total">Total Hist√≥rico</option>'; availableMonths.forEach(month => { const option = document.createElement('option'); option.value = month.value; option.textContent = month.text; summaryPeriodSelector.appendChild(option); });
    summaryPeriodSelector.value = "Total"; document.getElementById('summary-total-sold').textContent = '...'; document.getElementById('summary-total-income').textContent = '...'; document.getElementById('summary-total-profit').textContent = '...'; document.getElementById('summary-period').textContent = '...';
    productSummaryModal.style.display = 'flex'; setTimeout(() => { updateProductSummaryDisplay(); }, 50);
}
function updateProductSummaryDisplay() {
    if (!productSummaryModal || productSummaryModal.style.display !== 'flex' || currentSelectedProductKeys.size === 0) { return; }
    const selectedPeriod = summaryPeriodSelector.value; const historicalData = loadAllHistoricalData();
    const summary = calculateSummaryForSelectedProducts(currentSelectedProductKeys, historicalData, selectedPeriod);
    document.getElementById('summary-total-sold').textContent = summary.totalSold; document.getElementById('summary-total-income').textContent = summary.totalIncome.toFixed(2);
    document.getElementById('summary-total-profit').textContent = summary.totalProfit.toFixed(2); const periodText = selectedPeriod === "Total" ? "Hist√≥rico Completo" : summaryPeriodSelector.options[summaryPeriodSelector.selectedIndex].text;
    document.getElementById('summary-period').textContent = `Periodo: ${periodText} (${summary.daysCount} d√≠as: ${summary.firstDateFormatted} - ${summary.lastDateFormatted})`;
    document.getElementById('summary-total-profit')?.parentElement.classList.toggle('hidden', !isPinActive);
}
function calculateSummaryForSelectedProducts(selectedKeys, historicalData, period = "Total") {
    let totalSold = 0, totalIncome = 0, totalProfit = 0; const relevantDaysData = new Set();
    historicalData.forEach(day => { if (period === "Total" || day.date.startsWith(period)) { let dayHasRelevantProduct = false; day.products.forEach(product => { const productKey = `${String(product.category || 'Otros').trim()}-${String(product.name || '').trim()}`; if (selectedKeys.has(productKey)) { totalSold += product.vendido || 0; totalIncome += product.importe || 0; totalProfit += product.ganancias || 0; dayHasRelevantProduct = true; } }); if (dayHasRelevantProduct) { relevantDaysData.add(day.date); } } });
    const sortedDates = Array.from(relevantDaysData).sort(); const firstDate = sortedDates.length > 0 ? sortedDates[0] : null; const lastDate = sortedDates.length > 0 ? sortedDates[sortedDates.length - 1] : null;
    const daysCount = sortedDates.length; const formatDate = (isoDate) => { if (!isoDate) return 'N/A'; try { const [y,m,d] = isoDate.split('-'); return `${d}/${m}/${y}`; } catch { return isoDate; } }
    return { totalSold, totalIncome, totalProfit, firstDateFormatted: formatDate(firstDate), lastDateFormatted: formatDate(lastDate), daysCount };
}
function closeProductSummaryModal() { if (productSummaryModal) { productSummaryModal.style.display = 'none'; document.getElementById('selected-products-list').innerHTML = ''; currentSelectedProductKeys.clear(); } }

// --- Funciones Informe Rendimiento Productos ---
function showPerformanceReportModal() {
    if (!performanceReportModal) return; const periodSelector = document.getElementById('performancePeriodSelector'); const criteriaSelector = document.getElementById('performanceCriteriaSelector');
    if (!periodSelector || !criteriaSelector) return; const availableMonths = getAvailableMonths(); periodSelector.innerHTML = '<option value="Total">Total Hist√≥rico</option>';
    availableMonths.forEach(month => { const option = document.createElement('option'); option.value = month.value; option.textContent = month.text; periodSelector.appendChild(option); });
    periodSelector.value = "Total"; criteriaSelector.value = "units"; document.getElementById('topProductsTable').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;">Selecciona per√≠odo y criterio.</td></tr>';
    document.getElementById('reportPeriodDisplay').textContent = 'Calculando...'; criteriaSelector.querySelector('option[value="profit"]').classList.toggle('hidden', !isPinActive);
    document.querySelectorAll('#performanceReportModal .profit-col').forEach(el => el.classList.toggle('hidden', !isPinActive)); performanceReportModal.style.display = 'flex'; generatePerformanceReport();
}
function closePerformanceReportModal() { if (performanceReportModal) performanceReportModal.style.display = 'none'; }
function generatePerformanceReport() {
    if (!performanceReportModal || performanceReportModal.style.display !== 'flex') return;
    const periodSelector = document.getElementById('performancePeriodSelector'); const criteriaSelector = document.getElementById('performanceCriteriaSelector');
    const topTableBody = document.getElementById('topProductsTable')?.querySelector('tbody'); const reportPeriodDisplay = document.getElementById('reportPeriodDisplay');
    if (!periodSelector || !criteriaSelector || !topTableBody || !reportPeriodDisplay) { console.error("DOM informe rendimiento no encontrado."); return; }
    const selectedPeriod = periodSelector.value; let selectedCriteria = criteriaSelector.value; const profitOption = criteriaSelector.querySelector('option[value="profit"]'); const profitColumns = document.querySelectorAll('#performanceReportModal .profit-col');
    if (!isPinActive) { if (profitOption) profitOption.classList.add('hidden'); profitColumns.forEach(el => el.classList.add('hidden')); if (selectedCriteria === 'profit') { selectedCriteria = 'income'; criteriaSelector.value = 'income'; console.warn("Criterio cambiado a 'income', PIN no activo."); } }
    else { if (profitOption) profitOption.classList.remove('hidden'); profitColumns.forEach(el => el.classList.remove('hidden')); } showLoading("Generando informe...");
    setTimeout(() => {
        try {
            const historicalData = loadAllHistoricalData(); const productPerformance = {}; const uniqueDays = new Set();
            historicalData.forEach(day => { if (selectedPeriod === "Total" || day.date.startsWith(selectedPeriod)) { uniqueDays.add(day.date); day.products.forEach(product => { const key = `${String(product.category||'Otros').trim()}-${String(product.name||'').trim()}`; if (!productPerformance[key]) { productPerformance[key] = { units: 0, income: 0, profit: 0, category: String(product.category||'Otros').trim(), name: String(product.name||'').trim() }; } productPerformance[key].units += product.vendido||0; productPerformance[key].income += product.importe||0; productPerformance[key].profit += product.ganancias||0; }); } });
            const performanceArray = Object.values(productPerformance).filter(item => item.units > 0 || item.income > 0);
            performanceArray.sort((a, b) => { switch (selectedCriteria) { case 'income': return b.income - a.income; case 'profit': return isPinActive ? (b.profit - a.profit) : (b.income - a.income); case 'units': default: return b.units - a.units; } });
            topTableBody.innerHTML = ''; const topN = 10; performanceArray.slice(0, topN).forEach((item, index) => { const row = topTableBody.insertRow(); row.innerHTML = `<td>${index+1}</td><td>${item.name} <em style='font-size:0.8em; color:#aaa;'>(${item.category})</em></td><td>${item.units}</td><td>${item.income.toFixed(2)}</td><td class="profit-col ${!isPinActive ? 'hidden' : ''}">${isPinActive ? item.profit.toFixed(2) : ''}</td>`; });
            if (performanceArray.length === 0) { topTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay datos de ventas.</td></tr>'; }
            const sortedDays = Array.from(uniqueDays).sort(); const firstDateOverall = sortedDays.length > 0 ? sortedDays[0] : null; const lastDateOverall = sortedDays.length > 0 ? sortedDays[sortedDays.length - 1] : null;
            const formatDate = (isoDate) => isoDate ? isoDate.split('-').reverse().join('/') : 'N/A'; const periodText = selectedPeriod === "Total" ? "Hist√≥rico Completo" : periodSelector.options[periodSelector.selectedIndex].text;
            reportPeriodDisplay.textContent = `Informe para: ${periodText} (${uniqueDays.size} d√≠as: ${formatDate(firstDateOverall)} - ${formatDate(lastDateOverall)})`;
        } catch (e) { console.error("Error generando informe rendimiento:", e); alert(`Error: ${e.message}`); topTableBody.innerHTML = '<tr><td colspan="5">Error al generar.</td></tr>'; reportPeriodDisplay.textContent = 'Error'; }
        finally { hideLoading(); }
    }, 50);
}

// --- Funciones Informe Comparaci√≥n Per√≠odos ---
function showComparisonModal() {
    if (!comparisonModal) return; const period1Selector = document.getElementById('comparisonPeriod1Selector'); const period2Selector = document.getElementById('comparisonPeriod2Selector');
    if (!period1Selector || !period2Selector) return; const availableMonths = getAvailableMonths(); const populate = (selector) => { selector.innerHTML = '<option value="Total">Total Hist√≥rico</option>'; availableMonths.forEach(month => { const option = document.createElement('option'); option.value = month.value; option.textContent = month.text; selector.appendChild(option); }); };
    populate(period1Selector); populate(period2Selector);
    if (availableMonths.length >= 2) { period1Selector.value = availableMonths[availableMonths.length - 1].value; period2Selector.value = availableMonths[availableMonths.length - 2].value; }
    else if (availableMonths.length === 1) { period1Selector.value = availableMonths[0].value; period2Selector.value = "Total"; }
    else { period1Selector.value = "Total"; period2Selector.value = "Total"; }
    document.getElementById('comparisonTable').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;">Selecciona per√≠odos diferentes.</td></tr>';
    document.getElementById('comparisonPeriodDisplay').textContent = ''; comparisonModal.style.display = 'flex'; generateComparisonReport();
}
function closeComparisonModal() { if (comparisonModal) comparisonModal.style.display = 'none'; }
function calculateTotalsForPeriod(period, historicalData) {
    let income = 0, profit = 0, expenses = 0; const uniqueDays = new Set();
    historicalData.forEach(day => { if (period === "Total" || day.date.startsWith(period)) { uniqueDays.add(day.date); day.products.forEach(p => { income += p.importe || 0; profit += p.ganancias || 0; }); day.gastos.forEach(g => { if (!g.isCashCollection) { expenses += g.amount || 0; } }); } });
    const sortedDays = Array.from(uniqueDays).sort(); const firstDate = sortedDays.length > 0 ? sortedDays[0] : null; const lastDate = sortedDays.length > 0 ? sortedDays[sortedDays.length - 1] : null;
    return { income, profit, expenses, netBalance: income - expenses, daysCount: uniqueDays.size, firstDate, lastDate };
}
function generateComparisonReport() {
    if (!comparisonModal || comparisonModal.style.display !== 'flex') return;
    const period1Selector = document.getElementById('comparisonPeriod1Selector'); const period2Selector = document.getElementById('comparisonPeriod2Selector');
    const tableBody = document.getElementById('comparisonTable')?.querySelector('tbody'); const reportPeriodDisplay = document.getElementById('comparisonPeriodDisplay');
    if (!period1Selector || !period2Selector || !tableBody || !reportPeriodDisplay) { console.error("DOM modal comparaci√≥n no encontrado."); return; }
    const period1 = period1Selector.value; const period2 = period2Selector.value;
    if (period1 === period2) { tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Selecciona dos per√≠odos diferentes.</td></tr>'; reportPeriodDisplay.textContent = ''; return; }
    showLoading("Generando comparaci√≥n...");
    setTimeout(() => {
        try {
            const historicalData = loadAllHistoricalData(); const data1 = calculateTotalsForPeriod(period1, historicalData); const data2 = calculateTotalsForPeriod(period2, historicalData);
            tableBody.innerHTML = ''; const formatCurrency = (value) => value.toFixed(2); const formatPercentage = (value) => { if (!isFinite(value)) return 'N/A'; const sign = value > 0 ? '+' : ''; return `${sign}${value.toFixed(1)}%`; }; const calculateDiff = (v1, v2) => v1 - v2; const calculatePercDiff = (v1, v2) => (v2 === 0 ? (v1 === 0 ? 0 : Infinity) : ((v1 - v2) / Math.abs(v2)) * 100); const getDiffClass = (perc) => { if (!isFinite(perc) || perc === 0) return ''; return perc > 0 ? 'positive-diff' : 'negative-diff'; };
            const metrics = [ { label: "Ingresos Brutos", key: "income" }, { label: "Margen Bruto Prod.", key: "profit", sensitive: true }, { label: "Gastos Operativos", key: "expenses", higherIsWorse: true }, { label: "Balance Neto", key: "netBalance" }, { label: "D√≠as con Datos", key: "daysCount", isCount: true } ];
            metrics.forEach(metric => { if (metric.sensitive && !isPinActive) return; const val1 = data1[metric.key]; const val2 = data2[metric.key]; let diffAbsStr = '', diffPercStr = '', diffClass = ''; const diffAbs = calculateDiff(val1, val2); const diffPerc = calculatePercDiff(val1, val2); if (!metric.isCount) { diffAbsStr = formatCurrency(diffAbs); diffPercStr = formatPercentage(diffPerc); } else { diffAbsStr = diffAbs.toString(); diffPercStr = formatPercentage(diffPerc); } const effectivePerc = metric.higherIsWorse ? -diffPerc : diffPerc; diffClass = getDiffClass(effectivePerc); const row = tableBody.insertRow(); row.classList.toggle('profit-row', metric.sensitive); if (diffClass) row.classList.add(diffClass); row.style.display = (metric.sensitive && !isPinActive) ? 'none' : ''; row.innerHTML = `<td>${metric.label}</td><td>${metric.isCount?val1:formatCurrency(val1)}</td><td>${metric.isCount?val2:formatCurrency(val2)}</td><td>${diffAbsStr}</td><td>${diffPercStr}</td>`; });
            const formatDate = (isoDate) => isoDate ? isoDate.split('-').reverse().join('/') : 'N/A'; const getPeriodText = (sel) => sel.value === "Total" ? "Total Hist√≥rico" : sel.options[sel.selectedIndex].text;
            reportPeriodDisplay.textContent = `Comparando: ${getPeriodText(period1Selector)} (${data1.daysCount} d) vs ${getPeriodText(period2Selector)} (${data2.daysCount} d)`;
        } catch (e) { console.error("Error generando comparaci√≥n:", e); alert(`Error: ${e.message}`); tableBody.innerHTML = '<tr><td colspan="5">Error al generar.</td></tr>'; reportPeriodDisplay.textContent = 'Error'; }
        finally { hideLoading(); }
    }, 50);
}

// --- Funci√≥n Comprobaci√≥n Fin de D√≠a ---
function checkEndOfDay() {
    if (!dateInput || !dateInput.value) { alert("Selecciona fecha v√°lida."); return; }
    const currentDateStr = dateInput.value; console.log(`Comprobando fin de d√≠a para: ${currentDateStr}`);
    let missingFinales = []; products.forEach(p => { if (p.finales === '' || p.finales === null || p.finales === undefined) { missingFinales.push(`- ${p.name} (${p.category})`); } });
    let message = `Resumen R√°pido ${currentDateStr}:\n-----------------------------------\n`;
    message += `Ingresos Brutos: ${document.getElementById('total-importe')?.textContent || 'N/A'}\n`;
    if (isPinActive) { message += `Margen Bruto: ${document.getElementById('total-ganancias')?.textContent || 'N/A'}\n`; }
    message += `Gastos/Recogidas: ${document.getElementById('total-gastos-display')?.textContent || 'N/A'}\n`;
    message += `Total Neto Caja: ${document.getElementById('total-despues-gastos')?.textContent || 'N/A'}\n`;
    if (isPinActive) { message += `Stock (Costo): ${document.getElementById('total-stock-cost')?.textContent || 'N/A'}\n`; message += `Stock (Venta): ${document.getElementById('total-stock-value')?.textContent || 'N/A'}\n`; }
    message += `-----------------------------------\n\n`;
    if (missingFinales.length > 0) {
        message += `‚ö†Ô∏è ¬°Atenci√≥n! Falta rellenar "Finales" para:\n`;
        message += missingFinales.slice(0, 5).join('\n'); if (missingFinales.length > 5) { message += `\n... y ${missingFinales.length - 5} m√°s.`; }
        message += `\n\n¬øMarcar d√≠a como revisado y guardar?`;
        if (!confirm(message)) { console.log("Cierre cancelado por 'Finales' faltantes."); return; } else { console.log("Usuario confirma a pesar de 'Finales' faltantes."); }
    } else { message += `Todos los campos "Finales" parecen estar rellenados. üëç\n¬øMarcar d√≠a como revisado y guardar?`; if (!confirm(message)) { console.log("Cierre cancelado."); return; } }
    guardarIPV(currentDateStr); alert(`Datos ${currentDateStr} guardados.`); console.log(`Fin d√≠a ${currentDateStr} completado.`);
}

// --- Funciones Categor√≠as Tabla (Expandir/Contraer) ---
function toggleCategory(categoryId, forceExpand = false) {
    const productRows = document.querySelectorAll(`.product-row.${categoryId}`); const toggleIcon = document.getElementById(`icon-${categoryId}`);
    if (!productRows.length || !toggleIcon) return; const isCurrentlyHidden = toggleIcon.textContent === '+'; const shouldExpand = forceExpand || isCurrentlyHidden;
    productRows.forEach(row => { const searchHidden = row.classList.contains('search-hidden'); if (!searchHidden) { row.style.display = shouldExpand ? '' : 'none'; } if (shouldExpand) row.classList.remove('hidden'); else row.classList.add('hidden'); });
    toggleIcon.textContent = shouldExpand ? '-' : '+'; updateSelectionState(); updateToggleAllButtonState();
}
function updateToggleAllButtonState() {
    const allCategoryHeaders = document.querySelectorAll('#product-list .category-header'); if (!allCategoryHeaders.length) return;
    let hiddenCount = 0; let totalVisibleCategories = 0;
    allCategoryHeaders.forEach(header => { if (header.style.display !== 'none') { totalVisibleCategories++; const icon = header.querySelector('.toggle-icon'); if (icon && icon.textContent === '+') hiddenCount++; } });
    const toggleBtn = document.getElementById('toggleAllBtn'); if (!toggleBtn) return;
    if (totalVisibleCategories === 0) { toggleBtn.textContent = 'Expandir Todo'; toggleBtn.disabled = true; }
    else { toggleBtn.disabled = false; toggleBtn.textContent = (hiddenCount > 0) ? 'Expandir Todo' : 'Contraer Todo'; }
}
function toggleAllCategories() {
    const toggleBtn = document.getElementById('toggleAllBtn'); if (!toggleBtn || toggleBtn.disabled) return;
    const shouldExpand = toggleBtn.textContent.includes('Expandir');
    const allVisibleCategoryHeaders = document.querySelectorAll('#product-list .category-header:not([style*="display: none"])');
    allVisibleCategoryHeaders.forEach(header => { const categoryId = header.dataset.categoryId; const icon = header.querySelector('.toggle-icon'); const isCurrentlyHidden = icon ? icon.textContent === '+' : false; if ((shouldExpand && isCurrentlyHidden) || (!shouldExpand && !isCurrentlyHidden)) { toggleCategory(categoryId, shouldExpand); } });
}
    </script>
</body>
</html>
