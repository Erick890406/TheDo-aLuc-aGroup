<!DOCTYPE html>
<html lang="es" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DL Cumanayagua | Tu Tienda Local</title>
    <link rel="icon" type="image/png" href="./img/Logo-DL-Cumanayagua.png">

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        /* ============ ESTILOS MODERNOS (TIENDA LOCAL) ============ */
        :root {
            --primary: #ea580c; 
            --primary-dark: #c2410c;
            --secondary: #334155;
            --success: #16a34a;
            --background: #f8fafc;
            --surface: rgba(255, 255, 255, 0.95);
            --text-main: #0f172a;
            --text-light: #64748b;
            --radius-md: 12px;
            --radius-lg: 20px;
            --shadow-soft: 0 10px 30px -10px rgba(0,0,0,0.08);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--background); 
            color: var(--text-main); 
            -webkit-font-smoothing: antialiased; 
            padding-top: 80px; 
            overflow-x: hidden;
        }
        
        /* Navbar Glass */
        .navbar-custom { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            padding: 12px 0; 
            transition: all 0.3s ease; 
        }
        .navbar-brand { font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; font-size: 1.3rem; }
        .nav-link { font-weight: 500; color: var(--text-light); cursor: pointer; position: relative; }
        .nav-link.active { color: var(--primary); font-weight: 600; }
        .nav-link.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: var(--primary); border-radius: 10px; }

        /* Tarjetas de Producto */
        .card { 
            border: none; 
            border-radius: var(--radius-lg); 
            background: white; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            overflow: hidden;
            height: 100%;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .card-body { padding: 1.25rem; display: flex; flex-direction: column; }
        
        .product-image-container { position: relative; overflow: hidden; border-radius: var(--radius-md); aspect-ratio: 1/1; margin-bottom: 1rem; background: #f1f5f9; }
        .product-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .card:hover .product-image { transform: scale(1.05); }
        
        /* Bot√≥n (+) Flotante en Producto */
        .btn-plus-overlay {
            position: absolute; bottom: 10px; right: 10px; width: 40px; height: 40px;
            background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); color: var(--primary); font-size: 1.5rem;
            transition: all 0.2s ease; z-index: 5; cursor: pointer;
        }
        .btn-plus-overlay:hover { background: var(--primary); color: white; transform: scale(1.1); }
        .btn-plus-overlay:active { transform: scale(0.95); }

        .card-title { font-weight: 600; margin-bottom: 0.3rem; font-size: 1rem; color: var(--text-main); line-height: 1.4; }
        .price { font-weight: 800; color: var(--primary); font-size: 1.2rem; }
        
        /* Badge Env√≠o Gratis */
        .badge-free {
            background-color: #dcfce7; color: #166534; font-size: 0.75rem; padding: 6px 12px;
            border-radius: 50px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px;
            margin-top: auto; width: fit-content;
        }

        /* Botones */
        .btn { border-radius: 50px; padding: 0.7rem 1.5rem; font-weight: 600; transition: all 0.3s ease; border: none; letter-spacing: 0.3px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #c2410c 100%); color: white; box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3); }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(234, 88, 12, 0.4); }
        .btn-outline-primary { border: 2px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-outline-primary:hover { background: var(--primary-light); color: var(--primary); }
        
        /* ============ HERO CAROUSEL UNIFORME ============ */
        #hero-promo {
            border-radius: 24px;
            overflow: hidden; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 3rem;
            position: relative;
            background: white;
        }

        /* ALTURA FIJA PARA TODOS LOS SLIDES */
        .hero-slide-content {
            height: 400px; /* Altura fija uniforme */
            padding: 2rem 1.5rem;
            text-align: center;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* FONDOS DE LAS OFERTAS */
        .bg-slide-1 { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); position: relative; }
        .bg-slide-1::after { content: 'üõµ'; font-size: 10rem; position: absolute; right: -20px; bottom: -40px; opacity: 0.15; transform: rotate(-15deg); }

        .bg-slide-2 { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); position: relative; }
        .bg-slide-2::after { content: 'üçï'; font-size: 10rem; position: absolute; left: -20px; bottom: -30px; opacity: 0.15; transform: rotate(15deg); }

        .bg-slide-3 { background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); position: relative; }
        .bg-slide-3::after { content: 'üöÄ'; font-size: 10rem; position: absolute; right: 10px; top: -20px; opacity: 0.15; transform: rotate(-10deg); }

        .carousel-indicators [data-bs-target] { background-color: white; opacity: 0.5; height: 4px; border-radius: 2px; width: 20px; margin: 0 4px; border: none; }
        .carousel-indicators .active { opacity: 1; width: 30px; }

        /* Categor√≠as (Pills) */
        .filter-scroll-container { display: flex; gap: 10px; overflow-x: auto; padding: 5px 5px 15px 5px; scrollbar-width: none; }
        .filter-scroll-container::-webkit-scrollbar { display: none; }
        .cat-pill {
            white-space: nowrap; padding: 10px 24px; border-radius: 50px; background: white; border: 1px solid #e2e8f0;
            color: var(--text-light); font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .cat-pill.active { background: var(--text-main); color: white; border-color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Floating Buttons */
        .floating-buttons-container { position: fixed; bottom: 30px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 15px; }
        .floating-button { 
            width: 64px; height: 64px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .floating-button:hover { transform: scale(1.1); }
        #floatingCartButton { background: var(--text-main); color: white; }
        #whatsappButton { background: #25D366; color: white; }

        /* Spinner */
        .loading-spinner { background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner-border { color: var(--primary); width: 3rem; height: 3rem; border-width: 4px; }

        /* FOOTER */
        .footer-custom { background-color: white; border-top: 1px solid #E2E8F0; padding: 4rem 0 2rem; margin-top: 5rem; }
        .footer-avatar { width: 60px !important; height: 60px !important; border-radius: 12px; object-fit: cover; aspect-ratio: 1/1; border: 2px solid #f1f5f9; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* ESTILOS MENSAJE GLOBAL */
        .global-message-wrapper {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 24px; padding: 2.5rem 1.5rem; text-align: center; position: relative; overflow: hidden;
            box-shadow: 0 25px 60px rgba(0,0,0,0.15);
        }
        .global-message-wrapper::before {
            content: ''; position: absolute; top: -60%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(79, 70, 229, 0.1) 0%, transparent 60%);
            animation: spinBg 12s linear infinite; z-index: 0;
        }
        @keyframes spinBg { 100% { transform: rotate(360deg); } }
        
        .gm-content-layer { position: relative; z-index: 2; }
        
        /* Icono App */
        .gm-app-icon-container { position: relative; width: 90px; height: 90px; margin: 0 auto 1.5rem auto; animation: floatIcon 3s ease-in-out infinite; }
        .gm-app-icon { width: 100%; height: 100%; object-fit: cover; border-radius: 22px; box-shadow: 0 10px 25px rgba(0,0,0,0.25); border: 2px solid rgba(255,255,255,0.5); }
        .gm-app-icon-container::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 110%; height: 110%; background: radial-gradient(circle, rgba(234, 88, 12, 0.4) 0%, transparent 70%); z-index: -1; filter: blur(10px); }
        @keyframes floatIcon { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }

        .gm-title { font-family: 'Poppins', sans-serif; font-weight: 800; font-size: 1.6rem; line-height: 1.2; margin-bottom: 0.5rem; color: #1e293b; }
        .gm-text { font-size: 0.95rem; color: #475569; margin-bottom: 1.5rem; }
        .gm-highlight { color: #ea580c; font-weight: 700; background: #fff7ed; padding: 2px 6px; border-radius: 4px; }
        
        .gm-actions { display: flex; flex-direction: column; gap: 10px; }
        .btn-download { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white; text-decoration: none; padding: 12px; border-radius: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(15, 23, 42, 0.3); transition: transform 0.2s; }
        .btn-download:hover { transform: scale(1.02); color: white; }
        .btn-share-wa { background: rgba(37, 211, 102, 0.1); color: #15803d; text-decoration: none; padding: 12px; border-radius: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid rgba(37, 211, 102, 0.3); transition: background 0.2s; }
        .btn-share-wa:hover { background: rgba(37, 211, 102, 0.2); color: #15803d; }
        .gm-footer { margin-top: 1rem; font-size: 0.8rem; color: #94a3b8; cursor: pointer; text-decoration: underline; }

        /* Modal Glass Reset */
        .modal-glass .modal-content { background: transparent; border: none; box-shadow: none; }

        /* CARRITO */
        .cart-item-card {
            background: white; border-radius: 16px; padding: 12px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 15px; border: 1px solid #f1f5f9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: transform 0.2s;
        }
        .cart-item-card:hover { transform: translateX(2px); border-color: #e2e8f0; }
        .cart-item-img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; background: #f8fafc; }
        .cart-qty-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #e2e8f0; background: white; display: flex; align-items: center; justify-content: center; color: var(--text-main); font-weight: bold; transition: all 0.2s; cursor: pointer; }
        .cart-qty-btn:active { background: var(--primary); border-color: var(--primary); color: white; }
        
        /* Stepper */
        .step-circle { width: 35px; height: 35px; border-radius: 50%; background: #e2e8f0; color: #64748b; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #fff; transition: all 0.3s; z-index: 2; position: relative; }
        .step-item.active .step-circle { background: var(--success); color: white; transform: scale(1.1); box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.15); }
        .stepper-progress-line { height: 4px; background: #e2e8f0; position: absolute; top: 15px; left: 0; right: 0; z-index: 0; border-radius: 10px; }
        .progress-bar-fill { height: 100%; background: var(--success); transition: width 0.3s ease; border-radius: 10px; }

        /* Inputs Invalidos */
        .is-invalid { border-color: #dc3545 !important; background-image: none !important; }

        @media (max-width: 576px) {
            .btn { width: 100%; }
            #hero-promo { padding: 0; border-radius: 20px; } /* Ajuste Hero Mobile */
            #hero-promo h1 { font-size: 2rem; }
            .gm-headline { font-size: 1.8rem; }
        }
    </style>
</head>
<body id="top">

    <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img src="img/Logo-DL-Cumanayagua.png" width="36" height="36" class="rounded-3 shadow-sm"> 
                DL Cumanayagua
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center gap-lg-3 mt-3 mt-lg-0">
                    <li class="nav-item"><a class="nav-link" onclick="showTabAndScroll('menu-tab-link'); setCategoryFilter('all')">Men√∫</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="filterAndScroll('Combos')">Combos</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="filterAndScroll('Por Mayor')">Por Mayor</a></li>
                    
                    <li class="nav-item"><a class="nav-link" onclick="showTabAndScroll('my-orders-tab-link')">Mis Pedidos</a></li>
                    <li class="nav-item d-flex align-items-center" id="auth-buttons-nav-container">
                        <div id="auth-buttons-nav"></div>
                        <button id="btn-share-nav" class="btn btn-sm btn-light border rounded-pill ms-2" onclick="openShareModal()"><i class="bi bi-share-fill"></i></button>
                        <button id="logoutButtonNav" class="btn btn-sm btn-outline-danger rounded-pill px-3 ms-2" style="display:none;" onclick="logoutClient()">Salir</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4 pt-2 pb-5">
        
        <div id="hero-promo" class="animate__animated animate__fadeInUp">
            <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3500">
                
                <div class="carousel-indicators mb-4">
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2"></button>
                </div>

                <div class="carousel-inner">
                    
                    <div class="carousel-item active">
                        <div class="hero-slide-content bg-slide-1">
                            <div id="hero-guest" style="display: block; width: 100%; position: relative; z-index: 2;">
                                <span class="badge bg-white text-success px-3 py-1 rounded-pill fw-bold shadow-sm mb-3 text-uppercase ls-1">¬°Servicio 24/7!</span>
                                <h1 class="mb-3 fw-bold">Domicilio GRATIS en<br>Cumanayagua</h1>
                                <p class="mb-4 opacity-90 fs-6">Paga en efectivo (CUP) al recibir.</p>
                                <div class="d-flex gap-3 justify-content-center">
                                    <button class="btn btn-light text-success btn-lg rounded-pill shadow-sm px-4 fw-bold" onclick="openAuthModal('login')">Ingresar</button>
                                    <button class="btn btn-outline-light btn-lg rounded-pill px-4" onclick="openAuthModal('register')">Crear Cuenta</button>
                                </div>
                            </div>

                            <div id="hero-user" style="display: none; width: 100%; position: relative; z-index: 2;">
                                <h2 class="mb-2 fw-bold">üëã Hola, <span id="hero-user-name">Vecino</span></h2>
                                <p class="mb-4 opacity-90 fs-5">¬øQu√© te gustar√≠a pedir hoy?</p>
                                <div class="d-flex gap-3 justify-content-center">
                                    <button class="btn btn-light text-success btn-lg rounded-pill shadow-sm px-4 fw-bold" onclick="document.getElementById('menu-tab-link').click()">Ver Men√∫</button>
                                    <button class="btn btn-outline-light btn-lg rounded-pill px-4" onclick="loadUserOrders(); document.getElementById('my-orders-tab-link').click()">Mis Pedidos</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="carousel-item">
                        <div class="hero-slide-content bg-slide-2">
                            <div style="position: relative; z-index: 2;">
                                <span class="badge bg-warning text-dark px-3 py-1 rounded-pill fw-bold shadow-sm mb-3">üî• ¬°OFERTA DEL D√çA!</span>
                                <h1 class="mb-3 fw-bold">Pizzas Calientes<br>a tu Puerta</h1>
                                <p class="mb-4 opacity-90 fs-6">Disfruta el sabor aut√©ntico sin salir de casa.</p>
                                <button class="btn btn-light text-warning fw-bold btn-lg rounded-pill px-5 shadow-sm" onclick="setCategoryFilter('Alimentos'); document.getElementById('menu-tab-link').click()">
                                    Ordenar Ahora <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="carousel-item">
                        <div class="hero-slide-content bg-slide-3">
                            <div style="position: relative; z-index: 2;">
                                <img src="./img/Logo-DL-Cumanayagua.png" width="60" height="60" class="rounded-3 shadow mb-3 border border-2 border-white">
                                <h1 class="mb-3 fw-bold">¬°Tenemos App Oficial!</h1>
                                <p class="mb-4 opacity-90 fs-6">Desc√°rgala para una experiencia m√°s r√°pida.</p>
                                <a href="https://drive.google.com/uc?export=download&id=TU_ID_DE_DRIVE" target="_blank" class="btn btn-light text-primary fw-bold btn-lg rounded-pill px-4 shadow-sm bg-white">
                                    <i class="bi bi-cloud-arrow-down-fill me-2"></i> Descargar APK
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <ul class="nav nav-pills justify-content-center mb-4 gap-2">
            <li class="nav-item"><a class="nav-link active" id="menu-tab-link" data-bs-toggle="pill" href="#menu-tab" onclick="setCategoryFilter('all')">üçΩÔ∏è Men√∫</a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterAndScroll('Combos')">üçî Combos</a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterAndScroll('Por Mayor')">üì¶ Por Mayor</a></li>
            <li class="nav-item"><a class="nav-link" id="my-orders-tab-link" data-bs-toggle="pill" href="#my-orders-tab" onclick="loadUserOrders()">üìã Mis Pedidos</a></li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="menu-tab">
                
                <div class="alert alert-warning border-0 shadow-sm rounded-4 mb-4 d-flex align-items-center gap-3 animate__animated animate__fadeIn" role="alert">
                    <div class="bg-white bg-opacity-50 rounded-circle p-2 text-warning">
                        <i class="bi bi-info-circle-fill fs-3"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-1 text-dark">Informaci√≥n Importante</h6>
                        <p class="mb-0 small text-dark opacity-75 lh-sm">
                            Los domicilios dentro del Municipio son <strong>sin costo alguno</strong> pero con una compra m√≠nima: <strong>$500 CUP</strong> por compra en productos.
                        </p>
                    </div>
                </div>

                <div class="row justify-content-center mb-4">
                    <div class="col-lg-8">
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden border-0">
                            <span class="input-group-text bg-white border-0 ps-4"><i class="bi bi-search text-muted"></i></span>
                            <input type="text" id="productSearchInput" class="form-control border-0" placeholder="¬øQu√© buscas hoy?">
                        </div>
                    </div>
                </div>
                
                <div id="category-pills-container" class="filter-scroll-container justify-content-lg-center px-2 mb-4"></div>

                <div class="row g-3" id="menu-container"><div class="col-12 text-center py-5"><div class="spinner-border opacity-25"></div></div></div>
            </div>

            <div class="tab-pane fade" id="my-orders-tab">
                <div id="orders-history-container" class="row justify-content-center g-3">
                    <div class="col-md-8 text-center py-5 text-muted">
                        <i class="bi bi-box-seam display-4 opacity-25"></i>
                        <p class="mt-3">Inicia sesi√≥n para ver tu historial.</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div class="floating-buttons-container">
        <a id="whatsappButton" href="https://wa.me/5355189657" class="floating-button" target="_blank"><i class="bi bi-whatsapp fs-3"></i></a>
        <button id="floatingCartButton" class="floating-button position-relative" data-bs-toggle="modal" data-bs-target="#cartModal" style="display: none;">
            <i class="bi bi-bag-fill fs-3"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-2 border-white" id="floating-cart-count">0</span>
        </button>
    </div>

    <div id="loadingSpinnerUser" class="loading-spinner d-none">
        <div class="spinner-border" role="status"></div>
    </div>

    <div class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3" id="toastPlacement" style="z-index: 2050;"></div>

    <div class="modal fade modal-glass" id="globalMessageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-0" id="global-message-content"></div></div></div></div>

    <div class="modal fade" id="authModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header border-0"><h5 class="modal-title fw-bold">Bienvenido</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4">
        <ul class="nav nav-pills nav-fill mb-4 bg-light rounded-pill p-1"><li class="nav-item"><button class="nav-link active rounded-pill" id="login-tab-btn" onclick="switchAuthTab('login')">Ingresar</button></li><li class="nav-item"><button class="nav-link rounded-pill" id="register-tab-btn" onclick="switchAuthTab('register')">Registrarse</button></li></ul>
        <div class="tab-content">
            <div id="login-tab-pane" class="d-block animate__animated animate__fadeIn">
                <form id="loginForm" class="d-grid gap-3">
                    <div class="form-floating"><input type="tel" class="form-control" id="loginPhone" placeholder="Tel√©fono" required><label>Tel√©fono</label></div>
                    <div class="form-floating"><input type="password" class="form-control" id="loginPassword" placeholder="Contrase√±a" required><label>Contrase√±a</label></div>
                    <div id="login-feedback" class="text-center small text-danger"></div>
                    <button type="button" class="btn btn-primary btn-lg w-100 rounded-pill mt-2" onclick="handleLoginAttempt()">Iniciar Sesi√≥n</button>
                </form>
            </div>
            <div id="register-tab-pane" class="d-none animate__animated animate__fadeIn">
                <form id="newUserRegistrationForm" class="d-grid gap-3">
                    <div class="form-floating"><input type="text" class="form-control" id="newUserName" placeholder="Nombre" required><label>Nombre Completo</label></div>
                    <div class="form-floating"><input type="tel" class="form-control" id="newUserPhone" placeholder="Tel√©fono" required><label>Tel√©fono</label></div>
                    <div class="form-floating"><input type="email" class="form-control" id="newUserEmail" placeholder="Email" required><label>Email (Opcional)</label></div>
                    <div class="form-floating"><input type="password" class="form-control" id="newUserPassword" placeholder="Contrase√±a" required><label>Contrase√±a</label></div>
                    <div class="form-floating"><input type="password" class="form-control" id="newUserConfirmPassword" placeholder="Confirmar" required><label>Confirmar Contrase√±a</label></div>
                    <div class="form-floating"><input type="text" class="form-control" id="newUserReferralCodeUsed" placeholder="C√≥digo"><label>C√≥digo de Amigo (Opcional)</label></div>
                    <div id="registration-feedback" class="text-center small text-danger"></div>
                    <button type="button" class="btn btn-primary btn-lg w-100 rounded-pill mt-2" onclick="handleUserRegistrationAttempt()">Crear Cuenta</button>
                </form>
            </div>
        </div>
    </div></div></div></div>

    <div class="modal fade" id="sharePageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4 p-4 text-center"><h5 class="fw-bold mb-4">Comparte la Tienda</h5><div id="qrcodeCanvas" class="d-flex justify-content-center mb-4 p-3 bg-light rounded-4 mx-auto" style="width: fit-content;"></div><div class="d-grid gap-2"><button id="copyLinkButton" class="btn btn-light border btn-lg rounded-pill" onclick="copyPageLink(this)">Copiar Enlace</button><a id="shareViaWhatsAppButton" class="btn btn-success btn-lg rounded-pill" target="_blank"><i class="bi bi-whatsapp me-2"></i> Enviar por WhatsApp</a></div></div></div></div>

    <div class="modal fade" id="cartModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content border-0 shadow-lg" style="border-radius: 24px;"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold ms-2">Tu Pedido</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4">
            
            <div class="stepper-wrapper d-flex justify-content-between position-relative mb-4 px-4 align-items-center">
                <div class="stepper-progress-line"><div class="progress-bar-fill" id="stepperLine" style="width: 0%;"></div></div>
                <div class="step-item position-relative z-1 text-center active" id="stepIndicator1"><div class="step-circle"><i class="bi bi-bag"></i></div><small class="fw-bold mt-1 d-block" style="font-size: 0.7rem;">Carrito</small></div>
                <div class="step-item position-relative z-1 text-center" id="stepIndicator2"><div class="step-circle"><i class="bi bi-geo-alt"></i></div><small class="fw-bold mt-1 d-block text-muted" style="font-size: 0.7rem;">Entrega</small></div>
                <div class="step-item position-relative z-1 text-center" id="stepIndicator3"><div class="step-circle"><i class="bi bi-check-lg"></i></div><small class="fw-bold mt-1 d-block text-muted" style="font-size: 0.7rem;">Listo</small></div>
            </div>

            <div id="stepContent1" class="step-content animate__animated animate__fadeIn active">
                <div id="cart-items-container" class="mb-3"></div>
                <div id="empty-cart-msg" class="text-center py-5 d-none"><i class="bi bi-basket display-1 text-light"></i><p class="text-muted mt-3">Tu carrito est√° vac√≠o</p></div>
            </div>

            <div id="stepContent2" class="step-content animate__animated animate__fadeIn" style="display: none;">
                <div class="alert alert-light border rounded-4 mb-4 d-flex align-items-center gap-3">
                    <i class="bi bi-person-circle fs-3 text-primary"></i>
                    <div><small class="text-muted fw-bold text-uppercase d-block lh-1">Comprador</small><span class="fw-bold text-dark fs-6" id="step2-client-name">Usuario</span></div>
                </div>
                <h6 class="fw-bold mb-3">üìç Datos de Entrega</h6>
                <div class="row g-3">
                    <div class="col-md-6"><div class="form-floating"><input type="text" class="form-control" id="deliveryName" placeholder="N"><label>Nombre y Apellidos *</label></div></div>
                    <div class="col-12"><div class="form-floating"><input type="tel" class="form-control" id="deliveryPhone" placeholder="T"><label>Tel√©fono de Contacto *</label></div></div>
                    <div class="col-12"><div class="form-floating"><input type="text" class="form-control" id="deliveryAddress" placeholder="D"><label>Direcci√≥n (Cumanayagua) *</label></div></div>
                    <div class="col-12"><div class="form-floating"><input type="text" class="form-control" id="deliveryRef" placeholder="R"><label>Punto de Referencia *</label></div></div>
                    <div class="col-12"><div class="form-floating"><textarea class="form-control" id="deliveryExtra" placeholder="N" style="height: 80px"></textarea><label>Nota para el mensajero</label></div></div>
                </div>
            </div>

            <div id="stepContent3" class="step-content animate__animated animate__fadeIn text-center" style="display: none;">
                <div id="order-placement-feedback"></div>
            </div>

        </div>
        <div class="modal-footer border-0 pt-0 justify-content-between" id="cartModalFooter">
            <button class="btn btn-light text-muted rounded-pill px-4" id="btnBack" onclick="changeStep(-1)" style="display: none;">Atr√°s</button>
            <div class="ms-auto d-flex gap-2">
                 <button class="btn btn-dark rounded-pill px-4" id="btnNext" onclick="changeStep(1)">Siguiente</button>
                 <button class="btn btn-success rounded-pill px-4 shadow-lg" id="btnPay" onclick="confirmAndPlaceOrder()" style="display: none;">Confirmar Pedido</button>
            </div>
        </div>
    </div></div></div>

    <div class="modal fade" id="productDetailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden"><div class="modal-header border-0 position-absolute end-0 top-0 z-2"><button type="button" class="btn-close bg-white rounded-circle p-2 m-2 shadow-sm" data-bs-dismiss="modal"></button></div><div class="modal-body p-0">
        <img src="" id="modal-product-image" class="w-100 object-fit-cover" style="height: 300px;">
        <div class="p-4 bg-white position-relative" style="margin-top: -20px; border-radius: 24px 24px 0 0;">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h3 id="modal-product-name" class="fw-bold mb-0 text-dark"></h3>
                <h4 id="modal-product-price" class="text-primary fw-bold mb-0"></h4>
            </div>
            <p id="modal-product-description" class="text-muted mb-4"></p>
            <span class="badge bg-success bg-opacity-10 text-success mb-3 border border-success border-opacity-25 px-3 py-2"><i class="bi bi-scooter me-1"></i> Env√≠o Gratis</span>
            <div id="modal-add-to-cart-button-container"></div>
            <div id="modal-recommendations-container" class="mt-4 pt-4 border-top"></div>
        </div>
    </div></div></div></div>

    <div class="modal fade" id="avatarGalleryModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content border-0 rounded-4"><div class="modal-header border-0"><h5 class="fw-bold">Elige tu Avatar</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="avatar-gallery" class="d-flex flex-wrap gap-3 justify-content-center"></div></div></div></div></div>

    <footer class="footer-custom">
        <div class="container">
            <div class="row align-items-center gy-4">
                <div class="col-md-6 text-center text-md-start">
                    <div class="d-flex align-items-center justify-content-center justify-content-md-start gap-3">
                        <img src="./img/Logo-DL-Cumanayagua.png" class="footer-avatar shadow-sm">
                        <div class="lh-1">
                            <h6 class="fw-bold mb-1 text-dark">DL Cumanayagua</h6>
                            <small class="text-muted">Servicio Local de Confianza</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <div class="d-flex justify-content-center justify-content-md-end gap-3 mb-2">
                        <a href="https://wa.me/5355189657" class="text-dark opacity-50 hover-opacity-100 fs-5"><i class="bi bi-whatsapp"></i></a>
                    </div>
                    <small class="text-muted">¬© 2025 DL Group. <a href="#" onclick="forceFullCacheRefresh()" class="text-muted text-decoration-none ms-2"><i class="bi bi-arrow-clockwise"></i></a></small>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// ==================== CONFIGURACI√ìN ====================
// ¬°IMPORTANTE! Aseg√∫rate de que esta URL sea la correcta de tu script
const GOOGLE_SCRIPT_URL_USER = 'https://script.google.com/macros/s/AKfycbyMiML3_beoYSeKdGQlhi5HWvP4dEVD765ON--eb4y4CtRL5u0uoo2A3l0O22OS4NvtMA/exec'; 
const LOGGED_IN_CLIENT_KEY = 'dlClient_v29_final'; 
const USER_CART_KEY = 'dlCart_v29_final'; 

// NUEVA CONFIGURACI√ìN: URL FIJA PARA COMPARTIR
// Cambia esto por la URL real de tu p√°gina (ej: https://tutienda.com)
const FIXED_SHARE_URL = 'https://dlcumanayagua.com'; 

// ==================== ESTADO ====================
let clientData = null, menuItems = [], shoppingCart = [];
let authModal, cartModal, prodModal, globalMsgModal, shareModal;
let currentFilterCategory = 'all';

// ==================== INICIALIZACI√ìN ====================
document.addEventListener('DOMContentLoaded', async () => {
    // Inicializar modales
    authModal = new bootstrap.Modal(document.getElementById('authModal'));
    cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
    prodModal = new bootstrap.Modal(document.getElementById('productDetailModal'));
    globalMsgModal = new bootstrap.Modal(document.getElementById('globalMessageModal'));
    shareModal = new bootstrap.Modal(document.getElementById('sharePageModal'));

    // GLOBAL VIBRATION LISTENER (DELEGATION FOR DYNAMIC ELEMENTS)
    document.body.addEventListener('click', (e) => {
        if (e.target.closest('button, a, .card, .nav-link, .step-item, .gm-cta, .btn-plus-overlay')) {
            if(navigator.vibrate) navigator.vibrate(40); // 40ms tick
        }
    });

    // INPUT VIBRATION
    document.body.addEventListener('input', (e) => {
        if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if(navigator.vibrate) navigator.vibrate(25); // 25ms tick for typing
        }
    });

    // EXPORTAR FUNCIONES GLOBALES
    window.openAuthModal = function(tab) {
        authModal.show();
        window.switchAuthTab(tab);
    };
    
    window.switchAuthTab = function(tab) {
        const loginPane = document.getElementById('login-tab-pane');
        const registerPane = document.getElementById('register-tab-pane');
        const loginBtn = document.getElementById('login-tab-btn');
        const registerBtn = document.getElementById('register-tab-btn');
        
        if(tab === 'login') {
            loginPane.classList.remove('d-none'); loginPane.classList.add('d-block');
            registerPane.classList.remove('d-block'); registerPane.classList.add('d-none');
            loginBtn.classList.add('active'); registerBtn.classList.remove('active');
        } else {
            loginPane.classList.remove('d-block'); loginPane.classList.add('d-none');
            registerPane.classList.remove('d-none'); registerPane.classList.add('d-block');
            loginBtn.classList.remove('active'); registerBtn.classList.add('active');
        }
    };

    window.openShareModal = function() {
        const qrContainer = document.getElementById('qrcodeCanvas');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: FIXED_SHARE_URL, // Usamos la URL FIJA
            width: 150, height: 150, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
        });
        const msg = "¬°Hola! Mira esta tienda local, tienen env√≠os gratis: " + FIXED_SHARE_URL; // Usamos la URL FIJA
        document.getElementById('shareViaWhatsAppButton').href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        shareModal.show();
    };

    window.setCategoryFilter = function(cat) {
        currentFilterCategory = cat;
        generateCategoryFilters();
        generateMenu();
    };

    // FUNCION PARA ACTIVAR PESTA√ëA Y FILTRAR
    window.showTabAndScroll = function(tabId) {
        const triggerEl = document.getElementById(tabId);
        if(triggerEl) {
            const tab = new bootstrap.Tab(triggerEl);
            tab.show();
            // Scroll suave
            document.querySelector(triggerEl.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
        }
    };

    // NUEVA FUNCION PARA LAS PESTA√ëAS ESPECIALES
    window.filterAndScroll = function(category) {
        // 1. Activar visualmente la pesta√±a de Men√∫ (bootstrap tab)
        const menuTabLink = document.getElementById('menu-tab-link');
        const tab = new bootstrap.Tab(menuTabLink);
        tab.show();

        // 2. Establecer el filtro
        currentFilterCategory = category;
        
        // 3. Regenerar filtros visuales (pills) y productos
        generateCategoryFilters();
        generateMenu();

        // 4. Scroll al √°rea del men√∫
        document.getElementById('menu-tab').scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    loadClientData();
    loadCart();
    updateUI();

    document.getElementById('cartModal')?.addEventListener('show.bs.modal', initCartStepper);
    document.getElementById('productSearchInput')?.addEventListener('input', generateMenu);
    
    await loadInitialData();
});

// ==================== DATOS & API ====================
async function fetchData(action, method, payload=null) {
    document.getElementById('loadingSpinnerUser').classList.remove('d-none');
    document.getElementById('loadingSpinnerUser').classList.add('d-flex');
    try {
        let url = GOOGLE_SCRIPT_URL_USER;
        const opts = { method, mode: 'cors' };
        if(method==='GET') url += `?action=${action}&t=${Date.now()}`;
        else opts.body = JSON.stringify({ action, payload });

        const res = await fetch(url, opts);
        const text = await res.text();
        return JSON.parse(text);
    } catch(e) { console.error(e); return {success:false}; }
    finally { 
        document.getElementById('loadingSpinnerUser').classList.add('d-none'); 
        document.getElementById('loadingSpinnerUser').classList.remove('d-flex');
    }
}

async function loadInitialData() {
    const res = await fetchData('getInitialClientData', 'GET');
    if(res.success && res.data) {
        if(res.data.globalMessage && res.data.globalMessage.isActive) {
            renderGlobalMessage(res.data.globalMessage);
        }

        menuItems = (res.data.products||[]).map(p => ({
            ...p, 
            price: parseFloat(p.price)||0, 
            id:String(p.id),
            category: p.category || 'Otros'
        }));
        
        generateCategoryFilters();
        generateMenu();
    }
}

function renderGlobalMessage(msg) {
    const container = document.getElementById('global-message-content');
    
    // Verificamos si el mensaje del backend ya trae botones (HTML completo)
    if (msg.body.includes('gm-actions') || msg.body.includes('btn-download')) {
        // Inyectar HTML directo sin duplicar estructura
        container.innerHTML = msg.body;
    } else {
        // Plantilla est√°ndar para mensajes de texto simple
        container.innerHTML = `
            <div class="global-message-wrapper">
                <div class="gm-content">
                    <div class="gm-headline">${msg.title}</div>
                    <div class="gm-subhead">${msg.body}</div>
                    <div class="gm-cta" onclick="globalMsgModal.hide()">üëá ¬°Explora el Men√∫! üëá</div>
                </div>
            </div>
        `;
    }
    
    globalMsgModal.show();
}

// ==================== MENU ====================
function generateCategoryFilters() {
    const container = document.getElementById('category-pills-container');
    if(!container) return;
    const categories = ['all', ...new Set(menuItems.map(i => i.category || 'Otros'))];
    container.innerHTML = categories.map(cat => `
        <button class="cat-pill ${currentFilterCategory === cat ? 'active' : ''}" onclick="setCategoryFilter('${cat}')">
            ${cat === 'all' ? 'Todo' : cat}
        </button>`).join('');
}

function generateMenu() {
    const container = document.getElementById('menu-container');
    const term = document.getElementById('productSearchInput').value.toLowerCase();
    
    let items = menuItems.filter(i => i.active!==false);
    if(currentFilterCategory !== 'all') items = items.filter(i => (i.category || 'Otros') === currentFilterCategory);
    items = items.filter(i => i.name.toLowerCase().includes(term));
    
    container.innerHTML = items.map((p, index) => `
        <div class="col-6 col-md-4 col-lg-3 animate__animated animate__fadeInUp" style="animation-delay: ${index*0.05}s">
            <div class="card h-100" onclick="showProductDetails('${p.id}')" style="cursor: pointer;">
                <div class="card-body p-2">
                    <div class="product-image-container">
                        <img src="${p.imageurl||'./img/placeholder-product.png'}" class="product-image">
                        <div class="btn-plus-overlay" onclick="event.stopPropagation(); addToCart('${p.id}')"><i class="bi bi-plus"></i></div>
                    </div>
                    <div class="text-center mt-2">
                        <h6 class="card-title text-truncate">${p.name}</h6>
                        <div class="price">$${p.price.toFixed(2)} CUP</div>
                        <span class="badge-free">Env√≠o Gratis</span>
                    </div>
                </div>
            </div>
        </div>`).join('');
}

function generateRecommendations(currentProductId) {
    const container = document.getElementById('modal-recommendations-container');
    if(!container) return;
    container.innerHTML = '<h6 class="fw-bold mb-3 small text-uppercase ls-1 text-muted">Te recomendamos</h6>';
    const recs = menuItems.filter(p => p.id !== currentProductId && p.active !== false).sort(() => 0.5 - Math.random()).slice(0, 3);
    
    if(recs.length > 0) {
        const row = document.createElement('div'); row.className = 'row g-2';
        row.innerHTML = recs.map(r => `
            <div class="col-4"><div class="card h-100 border-0 bg-light" onclick="showProductDetails('${r.id}')" style="cursor:pointer;">
                <div class="p-2 pb-0"><img src="${r.imageurl || './img/placeholder-product.png'}" class="rounded-3 w-100 object-fit-cover" style="aspect-ratio:1/1;"></div>
                <div class="card-body p-2 text-center"><small class="d-block text-truncate fw-bold" style="font-size:0.7rem;">${r.name}</small><small class="text-primary fw-bold" style="font-size:0.7rem;">$${r.price.toFixed(2)}</small></div>
            </div></div>`).join('');
        container.appendChild(row);
    } else container.innerHTML = '';
}

function showProductDetails(id) {
    const p = menuItems.find(x => x.id === id);
    document.getElementById('modal-product-image').src = p.imageurl;
    document.getElementById('modal-product-name').innerText = p.name;
    document.getElementById('modal-product-description').innerText = p.description;
    document.getElementById('modal-product-price').innerText = `$${p.price.toFixed(2)} CUP`;
    document.getElementById('modal-add-to-cart-button-container').innerHTML = 
        `<button class="btn btn-primary w-100 btn-lg rounded-pill shadow" onclick="addToCart('${id}'); prodModal.hide()">A√±adir al Carrito</button>`;
    generateRecommendations(id);
    prodModal.show();
}

// ==================== ORDERS (CON DESPLEGABLE) ====================
async function loadUserOrders() {
    if(!clientData) return;
    const container = document.getElementById('orders-history-container');
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border"></div></div>';
    
    const res = await fetchData('getUserOrders', 'POST', { clientId: clientData.id });
    if(res.success && res.data.length > 0) {
        container.innerHTML = res.data.map(o => {
            let items = [];
            try { items = JSON.parse(o.itemsjson || '[]'); } catch(e) {}
            return `
            <div class="accordion accordion-flush mt-3 border rounded-3 shadow-sm" id="accordion-${o.orderid}">
                <div class="accordion-item rounded-3">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-${o.orderid}">
                            <div class="w-100 pe-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="badge bg-light text-dark border">#${o.orderid.substr(-4)}</span>
                                    <small class="text-muted">${new Date(o.orderdateiso).toLocaleDateString()}</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-primary">$${o.totalamount.toFixed(2)}</span>
                                    <span class="badge bg-${o.status==='Entregado'?'success':'secondary'}">${o.status}</span>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="flush-${o.orderid}" class="accordion-collapse collapse" data-bs-parent="#accordion-${o.orderid}">
                        <div class="accordion-body bg-light border-top">
                            <ul class="list-group list-group-flush mb-2 border rounded">
                                ${items.map(i => `<li class="list-group-item d-flex justify-content-between small bg-white"><span>${i.name} <span class="text-muted">x${i.quantity}</span></span><span class="fw-bold">$${(i.price * i.quantity).toFixed(2)}</span></li>`).join('')}
                            </ul>
                            <div class="small p-2 bg-white rounded border"><strong>Entrega:</strong> ${o.recipientname}<br><strong>Direcci√≥n:</strong> ${o.deliveryaddress}</div>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    } else {
        container.innerHTML = '<div class="text-center py-5 text-muted">No tienes pedidos recientes.</div>';
    }
}

// ==================== CART ====================
let currentStep = 1;
function initCartStepper() { currentStep = 1; updateStepper(); renderCart(); }
function changeStep(dir) {
    if(dir===1) {
        if(currentStep===1) {
            if(shoppingCart.length===0) return;
            if(!clientData) { authModal.show(); return; }
            document.getElementById('step2-client-name').innerText = clientData.nombre;
        }
        if(currentStep===2) {
            const req=['deliveryName','deliveryPhone','deliveryAddress','deliveryRef']; let valid=true;
            req.forEach(id=>{ const el=document.getElementById(id); if(!el.value.trim()){el.classList.add('is-invalid');valid=false;}else el.classList.remove('is-invalid'); });
            if(!valid) return showToast('Completa los campos obligatorios','danger');
        }
    }
    currentStep += dir; updateStepper();
}
function updateStepper() {
    document.querySelectorAll('.step-content').forEach(el=>el.style.display='none');
    document.getElementById(`stepContent${currentStep}`).style.display='block';
    for(let i=1; i<=3; i++) {
        const el=document.getElementById(`stepIndicator${i}`), circle=el.querySelector('.step-circle');
        el.classList.remove('active'); circle.style.backgroundColor='#e2e8f0'; circle.style.color='#64748b'; circle.style.transform='scale(1)';
        if(i<currentStep) { circle.innerHTML='<i class="bi bi-check-lg"></i>'; circle.style.backgroundColor='#16a34a'; circle.style.color='white'; }
        if(i===currentStep) { el.classList.add('active'); circle.innerHTML=i===1?'<i class="bi bi-bag"></i>':i===2?'<i class="bi bi-geo-alt"></i>':'<i class="bi bi-check-lg"></i>'; }
    }
    document.getElementById('stepperLine').style.width=(currentStep===1?'0%':currentStep===2?'50%':'100%');
    document.getElementById('btnBack').style.display=currentStep===2?'block':'none';
    document.getElementById('btnNext').style.display=currentStep<2?'block':'none';
    document.getElementById('btnPay').style.display=currentStep===2?'block':'none';
    document.getElementById('cartModalFooter').style.display=currentStep===3?'none':'flex';
}
function renderCart() {
    const list=document.getElementById('cart-items-container'), empty=document.getElementById('empty-cart-msg');
    if(shoppingCart.length===0) { list.innerHTML=''; empty.classList.remove('d-none'); document.getElementById('btnNext').disabled=true; return; }
    empty.classList.add('d-none'); document.getElementById('btnNext').disabled=false;
    let total=0;
    list.innerHTML=shoppingCart.map(item=>{
        total+=item.price*item.quantity; const prod=menuItems.find(p=>p.id===item.productId);
        return `<div class="cart-item-card"><img src="${prod?.imageurl||'./img/placeholder-product.png'}" class="cart-item-img"><div class="flex-grow-1"><h6 class="mb-0 fw-bold text-truncate">${item.name}</h6><small class="text-muted">$${item.price.toFixed(2)} x ${item.quantity}</small></div><div class="d-flex flex-column gap-2"><button class="cart-qty-btn" onclick="updateQty('${item.productId}',1)">+</button><button class="cart-qty-btn" onclick="updateQty('${item.productId}',-1)">-</button></div></div>`;
    }).join('')+`<div class="d-flex justify-content-between align-items-center mt-3 p-3 bg-light rounded-4"><span class="fw-bold text-secondary">Total</span><span class="fs-4 fw-bold text-primary">$${total.toFixed(2)} CUP</span></div><div class="text-center mt-3"><button class="btn btn-sm text-danger opacity-75 hover-opacity-100" onclick="clearCart()"><i class="bi bi-trash3 me-1"></i> Vaciar Carrito</button></div>`;
}
function clearCart(){ if(confirm('¬øVaciar todo el carrito?')){ shoppingCart=[]; saveCart(); updateUI(); renderCart(); } }
async function confirmAndPlaceOrder() {
    const req=['deliveryName','deliveryPhone','deliveryAddress','deliveryRef'];
    for(const id of req) if(!document.getElementById(id).value.trim()) return showToast('Error: Datos incompletos','danger');
    document.getElementById('btnPay').innerHTML='<span class="spinner-border spinner-border-sm"></span>'; document.getElementById('btnPay').disabled=true;
    const d={ recipientName:document.getElementById('deliveryName').value, recipientPhone:document.getElementById('deliveryPhone').value, address:document.getElementById('deliveryAddress').value, notes:`Ref: ${document.getElementById('deliveryRef').value}. ${document.getElementById('deliveryExtra').value}` };
    const res=await fetchData('placeOrder','POST',{clientId:clientData.id, cartItems:shoppingCart.map(i=>({productId:i.productId, quantity:i.quantity})), deliveryDetails:d});
    if(res.success) {
        currentStep=3; updateStepper(); const total=shoppingCart.reduce((s,i)=>s+i.price*i.quantity,0);
        const waMsg=`*NUEVO PEDIDO DL Cumanayagua* üõµ\n------------------\nüë§ CLIENTE: ${clientData.nombre}\nüì¶ Enviar a: ${d.recipientName}\nüìç Direcci√≥n: ${d.address}\nüìû Tel√©fono: ${d.recipientPhone}\n\nüìù RESUMEN:\n${shoppingCart.map(i=>`üõí ${i.name}\n   Cant: ${i.quantity} | Subt: $${(i.price*i.quantity).toFixed(2)}`).join('\n')}\n\n------------------\nüí∞ *TOTAL: $${total.toFixed(2)} CUP*\nüìù Nota: ${d.notes}\n#Pedido: ${res.data.orderId.substr(-4)}`;
        document.getElementById('order-placement-feedback').innerHTML=`<div class="py-5"><div class="mb-4 text-success"><i class="bi bi-check-circle-fill display-1"></i></div><h3 class="fw-bold mb-3">¬°Pedido Recibido!</h3><p class="text-muted mb-4">Orden <strong>#${res.data.orderId.substr(-4)}</strong> lista.</p><a href="https://wa.me/5355189657?text=${encodeURIComponent(waMsg)}" class="btn btn-success btn-lg rounded-pill w-100 shadow-lg fw-bold"><i class="bi bi-whatsapp me-2"></i> Confirmar por WhatsApp</a></div>`;
        shoppingCart=[]; saveCart(); updateUI();
    } else { showToast(res.message,'danger'); document.getElementById('btnPay').innerHTML='Confirmar Pedido'; document.getElementById('btnPay').disabled=false; }
}

// UTILS
function updateUI() {
    const isLogged=!!clientData;
    const toggle=(id,s)=>{const el=document.getElementById(id);if(el)el.style.display=s?(el.id.includes('hero-auth')?'flex':'block'):'none'};
    toggle('hero-guest',!isLogged); toggle('hero-user',isLogged); toggle('logoutButtonNav',isLogged);
    if(isLogged){ document.getElementById('hero-user-name').innerText=clientData.nombre.split(' ')[0]; document.getElementById('auth-buttons-nav').innerHTML=''; }
    else document.getElementById('auth-buttons-nav').innerHTML=`<button class="btn btn-sm btn-outline-dark rounded-pill px-3" onclick="openAuthModal('login')">Acceder</button>`;
    const c=shoppingCart.reduce((s,i)=>s+i.quantity,0);
    document.getElementById('floatingCartButton').style.display=c>0?'flex':'none'; document.getElementById('floating-cart-count').innerText=c;
}
function addToCart(id) { if(!clientData)return window.openAuthModal('login'); const p=menuItems.find(x=>x.id===id), item=shoppingCart.find(x=>x.productId===id); if(item)item.quantity++; else shoppingCart.push({productId:id,name:p.name,price:p.price,quantity:1}); saveCart(); updateUI(); showToast('A√±adido al carrito'); }
function updateQty(id,d) { const item=shoppingCart.find(x=>x.productId===id); if(item){item.quantity+=d; if(item.quantity<=0)removeFromCart(id); else{saveCart(); renderCart(); updateUI();}} }
function removeFromCart(id) { shoppingCart=shoppingCart.filter(x=>x.productId!==id); saveCart(); renderCart(); updateUI(); }
function saveCart(){localStorage.setItem(USER_CART_KEY,JSON.stringify(shoppingCart))}
function loadCart(){shoppingCart=JSON.parse(localStorage.getItem(USER_CART_KEY))||[]}
function saveClientData(){localStorage.setItem(LOGGED_IN_CLIENT_KEY,JSON.stringify(clientData))}
function loadClientData(){try{clientData=JSON.parse(localStorage.getItem(LOGGED_IN_CLIENT_KEY))}catch(e){}}
function logoutClient(){clientData=null;localStorage.removeItem(LOGGED_IN_CLIENT_KEY);updateUI()}
async function handleLoginAttempt(){const res=await fetchData('loginUser','POST',{telefono:document.getElementById('loginPhone').value,password:document.getElementById('loginPassword').value});if(res.success){clientData=res.data;saveClientData();updateUI();authModal.hide()}else document.getElementById('login-feedback').innerText=res.message}
async function handleUserRegistrationAttempt(){const res=await fetchData('registerNewUser','POST',{nombre:document.getElementById('newUserName').value,telefono:document.getElementById('newUserPhone').value,email:document.getElementById('newUserEmail').value,password:document.getElementById('newUserPassword').value});if(res.success)document.getElementById('registration-feedback').innerHTML='<span class="text-success">¬°Cuenta creada!</span>';else document.getElementById('registration-feedback').innerText=res.message}
function showToast(msg,type='success'){const t=document.createElement('div');t.className=`toast show align-items-center text-white bg-${type} border-0 position-fixed bottom-0 start-50 translate-middle-x mb-4`;t.style.zIndex=1100;t.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button></div>`;document.body.appendChild(t);setTimeout(()=>t.remove(),3000)}
function copyPageLink(btn){navigator.clipboard.writeText(FIXED_SHARE_URL);const o=btn.innerText;btn.innerText="¬°Copiado!";setTimeout(()=>btn.innerText=o,2000)} // Usamos la URL FIJA
function forceFullCacheRefresh(){localStorage.clear();window.location.reload()}
</script>
</body>
</html>
