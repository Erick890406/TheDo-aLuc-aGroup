<!DOCTYPE html>
<html lang="es" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta VIP - Doña Lucía</title>
    <link rel="icon" type="image/png" href="./img/Logo-DL-Cumanayagua.png">

     <!-- =================================================================== -->
    <!-- ================ INICIO: CONFIGURACIÓN PWA ======================== -->
    <!-- =================================================================== -->
    <!-- Enlace al Web App Manifest -->
    <link rel="manifest" href="./manifest.json">
    <!-- Color de la barra de estado/direcciones del navegador en móviles -->
    <meta name="theme-color" content="#2563EB">
    <!-- Meta tags para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes"> <!-- Añadido para estándares modernos -->
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DL Cumanayagua">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <!-- =================================================================== -->
    <!-- ================= FIN: CONFIGURACIÓN PWA ========================== -->
    <!-- =================================================================== -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <meta name="description" content="Con DL USD Cumanayagua, compra fácil y seguro productos, alimentos y regalos para tus seres queridos en Cumanayagua, Cuba. Paga cómodamente desde USA con Zelle.">
    <meta property="og:title" content="DL USD Cumanayagua: ¡Sorprende a tu Familia en Cuba!" />
    <meta property="og:description" content="Envía amor comprando productos en Cumanayagua. Compra online desde USA para tu familia en Cuba y paga con Zelle. ¡Fácil, rápido y con cariño!" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://erick890406.github.io/TheDo-aLuc-aGroup/portal-cliente-usd.html" />
    <meta property="og:site_name" content="DL USD Cumanayagua" />
    <meta property="og:image" content="https://i.postimg.cc/x8hj4gKx/Dl-Usd-2-cuamanayagua.png" />
    <meta property="og:image:secure_url" content="https://i.postimg.cc/x8hj4gKx/Dl-Usd-2-cuamanayagua.png" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="628" />
    <meta property="og:image:alt" content="Envía productos a Cuba - DL USD Cumanayagua" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Envía a Cuba con DL USD Cumanayagua" />
    <meta name="twitter:description" content="Compra para tu familia en Cumanayagua desde USA. Paga con Zelle. Alimentos, regalos y más. ¡Visítanos!" />
    <meta name="twitter:image" content="https://i.postimg.cc/jjNmrcyw/Meta-Etiqueta.png" />
    <meta name="twitter:image:alt" content="Promoción DL USD Cumanayagua para compras familiares en Cuba" />
<style>
 /* =================================================================== */
/* ======== DISEÑO PREMIUM v2: BANNER DE INSTALACIÓN PWA =========== */
/* =================================================================== */
#pwa-install-banner {
    display: none; /* Se activa con JS */
    position: fixed;
    /* AJUSTE 1: Posición más abajo y debajo del navbar */
    top: 0; /* Se ajustará con JS para quedar debajo del navbar */
    left: 0;
    width: 100%;
    z-index: 1050; /* Por encima del navbar (que suele ser 1000-1030) */
    
    /* Apariencia de lujo, ahora como una barra */
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.08); /* Solo un borde inferior */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 12px 16px;
    
    /* Organización interna */
    display: flex;
    align-items: center;
    gap: 12px;
}

/* Contenedor del icono/logo */
#pwa-install-banner .banner-icon-wrapper img {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

/* Contenedor del texto */
#pwa-install-banner .banner-text-wrapper {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}
#pwa-install-banner .banner-title {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
    line-height: 1.2;
}
#pwa-install-banner .banner-subtitle {
    font-size: 0.8rem;
    color: var(--text-secondary);
    /* AJUSTE 2: Permitir que el texto se ajuste en varias líneas */
    white-space: normal; /* En lugar de 'nowrap' */
    line-height: 1.3;
}

/* Contenedor de los botones */
#pwa-install-banner .banner-actions-wrapper {
    display: flex;
    align-items: center;
    flex-shrink: 0;
    gap: 15px;
}

/* Botón "Obtener" */
#pwa-install-banner .btn-install {
    background-color: var(--primary-100);
    color: var(--primary-700);
    font-weight: 600;
    font-size: 0.85rem;
    padding: 6px 16px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s ease;
}
#pwa-install-banner .btn-install:hover {
    background-color: var(--primary-200);
}

/* Botón de cierre "X" */
#pwa-install-banner .btn-close-banner {
    background: none;
    border: none;
    font-size: 1.5rem;
    font-weight: 300;
    color: var(--text-tertiary);
    cursor: pointer;
    padding: 0;
    line-height: 1;
    opacity: 0.7;
    transition: opacity 0.2s ease;
}
#pwa-install-banner .btn-close-banner:hover {
    opacity: 1;
}

/* Responsive para móviles */
@media (max-width: 380px) {
    /* En pantallas muy pequeñas, hacemos el texto y el logo un poco más pequeños */
    #pwa-install-banner .banner-icon-wrapper img {
        width: 36px;
        height: 36px;
    }
    #pwa-install-banner .banner-title {
        font-size: 0.85rem;
    }
    #pwa-install-banner .banner-subtitle {
        font-size: 0.75rem;
    }
}
:root {
    /* Sistema de Design - Paleta Clara Moderna */
    --primary-50: #EFF6FF;
    --primary-100: #DBEAFE;
    --primary-500: #3B82F6;
    --primary-600: #2563EB;
    --primary-700: #1D4ED8;
    
    --accent-50: #F0F9FF;
    --accent-500: #0EA5E9;
    --accent-600: #0284C7;
    
    --success-50: #ECFDF5;
    --success-500: #10B981;
    --success-600: #059669;
    
    --warning-50: #FFFBEB;
    --warning-500: #F59E0B;
    --warning-600: #D97706;
    
    --error-50: #FEF2F2;
    --error-500: #EF4444;
    --error-600: #DC2626;
    
    /* Escala de Grises - Sistema consistente */
    --white: #FFFFFF;
    --gray-50: #F8FAFC;
    --gray-100: #F1F5F9;
    --gray-200: #E2E8F0;
    --gray-300: #CBD5E1;
    --gray-400: #94A3B8;
    --gray-500: #64748B;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1E293B;
    --gray-900: #0F172A;
    
    /* Tokens Semánticos */
    --bg-primary: var(--white);
    --bg-secondary: var(--gray-50);
    --bg-tertiary: var(--gray-100);
    
    --text-primary: var(--gray-900);
    --text-secondary: var(--gray-700);
    --text-tertiary: var(--gray-500);
    --text-muted: var(--gray-400);
    
    --border-primary: var(--gray-200);
    --border-secondary: var(--gray-300);
    --border-focused: var(--primary-500);
    
    /* Elevación - Sistema de sombras */
    --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    
    /* Border Radius - Escala consistente */
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --radius-2xl: 20px;
    
    /* Espaciado - Sistema 4px grid */
    --space-1: 4px;
    --space-2: 8px;
    --space-3: 12px;
    --space-4: 16px;
    --space-5: 20px;
    --space-6: 24px;
    --space-8: 32px;
    --space-10: 40px;
    --space-12: 48px;
    --space-16: 64px;
    
    /* Tipografía - Sistema escalable */
    --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --font-family-display: 'Inter', sans-serif;
    
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;
    
    --font-weight-normal: 400;
    --font-weight-medium: 500;
    --font-weight-semibold: 600;
    --font-weight-bold: 700;
    
    /* Transiciones - Consistentes */
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* Reset Moderno */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

/* Base Styles */
body {
    font-family: var(--font-family-sans);
    font-size: var(--text-base);
    font-weight: var(--font-weight-normal);
    line-height: 1.5;
    color: var(--text-primary);
    background: var(--bg-secondary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

main {
    flex-grow: 1;
    padding-top: 80px; /* Para compensar navbar fixed */
}

/* Container System */
.container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-4);
}

/* Typography Scale */
h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-family-display);
    font-weight: var(--font-weight-semibold);
    line-height: 1.2;
    color: var(--text-primary);
    margin-bottom: var(--space-4);
}

h1 { font-size: var(--text-3xl); }
h2 { font-size: var(--text-2xl); }
h3 { font-size: var(--text-xl); }
h4 { font-size: var(--text-lg); }
h5 { font-size: var(--text-base); }
h6 { font-size: var(--text-sm); }

.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-tertiary { color: var(--text-tertiary); }
.text-muted { color: var(--text-muted); }

/* Navigation - Modern Header */
.navbar-custom {
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-primary);
    box-shadow: var(--shadow-sm);
    backdrop-filter: blur(8px);
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1000;
    padding: var(--space-3) 0;
}

.navbar-brand {
    font-family: var(--font-family-display);
    font-size: var(--text-xl);
    font-weight: var(--font-weight-bold);
    color: var(--primary-600);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.navbar-brand img {
    height: 32px;
    width: auto;
    border-radius: var(--radius-sm);
}

.navbar-nav {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    list-style: none;
    margin: 0;
    padding: 0;
}

.nav-link {
    color: var(--text-secondary);
    text-decoration: none;
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    border: none;
    background: none;
    cursor: pointer;
}

.nav-link:hover,
.nav-link.active {
    color: var(--primary-600);
    background: var(--primary-50);
}

/* Dropdown Styles */
.navbar .dropdown-menu {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: var(--space-2);
    min-width: 200px;
}

.navbar .dropdown-item {
    color: var(--text-secondary);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

.navbar .dropdown-item:hover {
    background: var(--primary-50);
    color: var(--primary-600);
}

.navbar .dropdown-divider {
    border-color: var(--border-primary);
    margin: var(--space-2) 0;
}

.navbar-toggler {
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-2);
    background: none;
    cursor: pointer;
}

.navbar-toggler-icon {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='%2364748B' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
    width: 20px;
    height: 20px;
}

/* Button System */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-5);
    border: 1.5px solid transparent;
    border-radius: var(--radius-md);
    font-weight: var(--font-weight-medium);
    font-size: var(--text-sm);
    text-decoration: none;
    cursor: pointer;
    transition: var(--transition-fast);
    position: relative;
    overflow: hidden;
    background: none;
}

.btn:focus {
    outline: 2px solid var(--primary-100);
    outline-offset: 2px;
}

.btn-primary {
    background: var(--primary-600);
    color: var(--white);
    border-color: var(--primary-600);
}

.btn-primary:hover {
    background: var(--primary-700);
    border-color: var(--primary-700);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background: var(--white);
    color: var(--text-secondary);
    border-color: var(--border-primary);
}

.btn-secondary:hover {
    background: var(--gray-50);
    border-color: var(--border-secondary);
    transform: translateY(-1px);
}

.btn-outline {
    background: transparent;
    color: var(--primary-600);
    border-color: var(--primary-600);
}

.btn-outline:hover {
    background: var(--primary-50);
    transform: translateY(-1px);
}

.btn-success {
    background: var(--success-600);
    color: var(--white);
    border-color: var(--success-600);
}

.btn-success:hover {
    background: var(--success-700);
    border-color: var(--success-700);
    transform: translateY(-1px);
}

.btn-warning {
    background: var(--warning-500);
    color: var(--white);
    border-color: var(--warning-500);
}

.btn-warning:hover {
    background: var(--warning-600);
    border-color: var(--warning-600);
    transform: translateY(-1px);
}

.btn-danger {
    background: var(--error-500);
    color: var(--white);
    border-color: var(--error-500);
}

.btn-danger:hover {
    background: var(--error-600);
    border-color: var(--error-600);
    transform: translateY(-1px);
}

.btn-sm {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-xs);
}

.btn-lg {
    padding: var(--space-4) var(--space-6);
    font-size: var(--text-base);
}

/* Card System */
.card {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-sm);
    transition: var(--transition-normal);
    overflow: hidden;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--border-secondary);
}

.menu-item-card,
.reward-card {
    composes: card;
}

.product-image,
.reward-image {
    width: 100%;
    aspect-ratio: 3 / 4;
    object-fit: cover;
    border-bottom: 1px solid var(--border-primary);
}

.card-body {
    padding: var(--space-6);
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.card-title {
    font-size: var(--text-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    line-height: 1.3;
    margin: 0;
}

.card-text {
    color: var(--text-secondary);
    font-size: var(--text-sm);
    line-height: 1.5;
    flex-grow: 1;
}

.price-points-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-primary);
}

.price {
    font-size: var(--text-xl);
    font-weight: var(--font-weight-bold);
    color: var(--primary-600);
}

/* Badge System */
.badge {
    display: inline-flex;
    align-items: center;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-lg);
    font-size: var(--text-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge-success {
    background: var(--success-50);
    color: var(--success-700);
    border: 1px solid var(--success-200);
}

.badge-primary {
    background: var(--primary-50);
    color: var(--primary-700);
    border: 1px solid var(--primary-200);
}

.badge-warning {
    background: var(--warning-50);
    color: var(--warning-700);
    border: 1px solid var(--warning-200);
}

.badge-danger {
    background: var(--error-50);
    color: var(--error-700);
    border: 1px solid var(--error-200);
}

.badge-info {
    background: var(--accent-50);
    color: var(--accent-700);
    border: 1px solid var(--accent-200);
}

/* Filter System */
#filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-6);
    justify-content: center;
}

.btn-filter {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
    cursor: pointer;
    text-decoration: none;
}

.btn-filter:hover,
.btn-filter.active {
    background: var(--primary-600);
    border-color: var(--primary-600);
    color: var(--white);
    transform: translateY(-1px);
}

/* Sort Select */
#sortProductsSelect {
    background: var(--bg-primary);
    border: 1.5px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-2) var(--space-4);
    color: var(--text-primary);
    font-size: var(--text-sm);
    min-width: 200px;
    cursor: pointer;
}

#sortProductsSelect:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px var(--primary-100);
}

/* Search Input */
#productSearchInput {
    background: var(--bg-primary);
    border: 1.5px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-base);
    color: var(--text-primary);
    width: 100%;
    transition: var(--transition-fast);
}

#productSearchInput:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px var(--primary-100);
}

#clearSearchButton {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-md);
    transition: var(--transition-fast);
}

#clearSearchButton:hover {
    background: var(--gray-100);
    color: var(--text-secondary);
}

/* ============================================= */
/* ===== ESTILOS DE LA TARJETA VIP DE LUJO ===== */
/* ============================================= */

/* Contenedor Principal de la Tarjeta */
#vip-card-container.vip-card {
    background: #1a202c; /* Base oscura y sofisticada */
    border-radius: var(--radius-xl, 20px);
    color: var(--white, #FFFFFF);
    padding: 0; /* El padding lo controlará el contenido interno */
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    transition: transform 0.4s cubic-bezier(0.1, 0.8, 0.2, 1), box-shadow 0.4s cubic-bezier(0.1, 0.8, 0.2, 1);
    transform-style: preserve-3d;
    backface-visibility: hidden;
    margin-bottom: var(--space-8);
}

#vip-card-container.vip-card:hover {
    box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.6);
}

/* 1. Capa de Brillo Interactivo (sigue al mouse) */
.vip-card-glow {
    position: absolute;
    top: 0;
    left: 0;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at center, 
        rgba(118, 75, 162, 0.3) 0%,   /* Morado sutil */
        rgba(102, 126, 234, 0.2) 30%, /* Azul sutil */
        transparent 70%
    );
    opacity: 0;
    transition: opacity 0.5s ease;
    z-index: 0;
    will-change: transform;
}

#vip-card-container.vip-card:hover .vip-card-glow {
    opacity: 1;
}

/* 2. Capa de Textura de Ruido Sutil */
.vip-card-noise {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    opacity: 0.03;
    z-index: 1;
    pointer-events: none; /* No interfiere con el mouse */
}

/* Contenedor del Contenido Principal */
.vip-card-content {
    position: relative;
    z-index: 2;
    padding: var(--space-6, 24px) var(--space-8, 32px);
    display: flex;
    flex-direction: column;
    gap: var(--space-6, 24px);
    backdrop-filter: blur(10px); /* Efecto cristalino sutil */
    background: rgba(26, 32, 44, 0.3);
}

/* Encabezado: Badge e Icono */
.vip-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.vip-badge {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: var(--text-xs, 12px);
    padding: var(--space-1, 4px) var(--space-3, 12px);
    border-radius: 20px;
    font-weight: var(--font-weight-medium, 500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.vip-icon {
    font-size: var(--text-xl, 20px);
    color: rgba(255, 255, 255, 0.4);
}

/* Cuerpo Principal: Avatar e Información */
.vip-card-body {
    display: flex;
    align-items: center;
    gap: var(--space-8, 32px);
}

/* Sección del Avatar */
.vip-avatar-section {
    flex-shrink: 0;
    cursor: pointer; /* MODIFICADO: Ahora toda la sección es clickeable */
}

.vip-avatar {
    width: 96px;
    height: 96px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.5), inset 0 0 10px rgba(0,0,0,0.3);
    transition: transform 0.3s ease;
}

.vip-avatar-section:hover .vip-avatar {
    transform: scale(1.05);
}

/* Sección de Información */
.vip-info-section {
    flex-grow: 1;
}
.client-status-text {
    font-size: var(--text-sm, 14px);
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: var(--space-1, 4px);
    font-weight: var(--font-weight-medium, 500);
}
.client-name-heading {
    font-family: 'Playfair Display', serif;
    font-size: var(--text-3xl, 30px);
    font-weight: 700;
    margin: 0 0 var(--space-4, 16px);
    line-height: 1.1;
    letter-spacing: 0.02em;
    color: var(--white);
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}
.points-display-wrapper {
    margin-bottom: var(--space-2, 8px);
}
.points-value {
    font-size: 2.8rem; /* 48px */
    font-weight: 700;
    line-height: 1;
    background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); /* Gradiente dorado */
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-right: var(--space-3, 12px);
    display: inline-block;
}
.points-label {
    font-size: var(--text-sm, 14px);
    color: rgba(255, 255, 255, 0.7);
    font-weight: var(--font-weight-medium, 500);
}
.client-phone-text {
    font-size: var(--text-sm, 14px);
    color: rgba(255, 255, 255, 0.5);
    display: block;
    margin-top: var(--space-2);
}

/* Pie de Tarjeta: Código de Referido */
.vip-card-footer {
    background: rgba(0, 0, 0, 0.2);
    margin: 0 calc(-1 * var(--space-8, 32px)) calc(-1 * var(--space-6, 24px));
    padding: var(--space-4, 16px) var(--space-8, 32px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.referral-info {
    display: flex;
    flex-direction: column;
}
.referral-label {
    display: block;
    font-size: var(--text-xs, 12px);
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 2px;
}
.referral-code {
    font-family: 'Courier New', Courier, monospace;
    font-size: var(--text-lg, 18px);
    font-weight: 700;
    color: #f6d365; /* Color dorado */
    letter-spacing: 0.1em;
}
.copy-referral-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--white);
    padding: var(--space-2, 8px) var(--space-3, 12px);
    border-radius: var(--radius-md, 8px);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-2, 8px);
    transition: background 0.2s ease;
}
.copy-referral-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}
.copy-referral-btn .copy-text {
    font-weight: 500;
    font-size: 13px;
}

/* Ocultar el botón original, ya que lo integramos en el nuevo diseño */
#vip-card-container > .vip-card-content-centered {
    display: none;
}
/* Form System */
.form-control {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    border: 1.5px solid var(--border-primary);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    transition: var(--transition-fast);
    background: var(--bg-primary);
    color: var(--text-primary);
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px var(--primary-100);
}

.form-select {
    background: var(--bg-primary);
    border: 1.5px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-3) var(--space-4);
    color: var(--text-primary);
    font-size: var(--text-base);
    cursor: pointer;
}

.form-select:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px var(--primary-100);
}

/* Tab System */
.nav-pills {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-2);
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-8);
    flex-wrap: wrap;
}

.nav-pills .nav-item {
    flex: 1;
    min-width: 120px;
}

.nav-pills .nav-link {
    background: transparent;
    color: var(--text-secondary);
    border-radius: var(--radius-md);
    padding: var(--space-3) var(--space-4);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
    text-align: center;
    border: none;
    text-decoration: none;
    display: block;
    width: 100%;
}

.nav-pills .nav-link:hover {
    background: var(--gray-50);
    color: var(--text-primary);
}

.nav-pills .nav-link.active {
    background: var(--primary-600);
    color: var(--white);
    box-shadow: var(--shadow-sm);
}

/* Modal System */
.modal-content {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    color: var(--text-primary);
}

.modal-header {
    border-bottom: 1px solid var(--border-primary);
    padding: var(--space-6);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    color: var(--text-primary);
    font-weight: var(--font-weight-semibold);
    font-size: var(--text-xl);
    margin: 0;
}

.modal-body {
    padding: var(--space-6);
    color: var(--text-primary);
}

.modal-footer {
    border-top: 1px solid var(--border-primary);
    padding: var(--space-6);
}

/* Close Button - CORRECCIÓN DEFINITIVA */
.btn-close {
    background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%2364748B'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
    border: none;
    opacity: 1; /* Opacidad completa para la base */
    width: 1em;
    height: 1em;
    padding: 0.25em;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.btn-close:hover {
    opacity: 1; 
    background-color: var(--gray-100);
}

.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%);
    opacity: 1 !important; /* Asegura que la versión blanca también sea 100% visible */
}

/* Añadimos una regla de hover específica para la versión blanca */
.btn-close-white:hover {
    background-color: rgba(255, 255, 255, 0.15);
    opacity: 1 !important;
}
/* Arreglo visual para el botón de cerrar */
.btn-close {
    opacity: 1 !important;            /* Siempre visible */
    filter: none !important;          /* Evita efectos de inversión */
    background-color: transparent !important;
    background-repeat: no-repeat;
    background-position: center;
    background-size: 1em;
}

/* Asegura buena visibilidad sobre fondos claros u oscuros */
.modal-header .btn-close {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='%23333' viewBox='0 0 16 16'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586l6.293-6.293a1 1 0 0 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293A1 1 0 0 1 .293 14.707L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") !important;
}

/* Si usas modales oscuros */
.modal-header.bg-dark .btn-close {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 16 16'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586l6.293-6.293a1 1 0 0 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293A1 1 0 0 1 .293 14.707L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") !important;
}


/* Product Detail Modal */
#modal-product-image {
    width: 100%;
    aspect-ratio: 4 / 5;
    object-fit: cover;
    border-radius: var(--radius-lg);
    border: 2px solid var(--primary-500);
}

#modal-product-name {
    color: var(--text-primary);
    font-weight: var(--font-weight-bold);
    font-size: var(--text-2xl);
    margin-bottom: var(--space-4);
}

#modal-product-description {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-4);
}

#modal-product-price {
    color: var(--primary-600);
    font-size: var(--text-2xl);
    font-weight: var(--font-weight-bold);
}

#modal-product-points {
    background: var(--success-50);
    color: var(--success-700);
    border: 1px solid var(--success-200);
}

/* Recommendations */
#modal-recommendations-container h5 {
    color: var(--text-primary);
    border-bottom: 2px solid var(--primary-500);
    padding-bottom: var(--space-2);
    margin-bottom: var(--space-4);
    font-weight: var(--font-weight-semibold);
}

.recommendation-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition-fast);
    text-decoration: none;
    color: inherit;
}

.recommendation-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary-500);
    box-shadow: var(--shadow-md);
    text-decoration: none;
    color: inherit;
}

.recommendation-card img {
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
}

.recommendation-card .rec-title {
    font-size: var(--text-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
    padding: var(--space-2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
}

.recommendation-card .rec-title + small.text-primary {
    color: var(--primary-600) !important;
    font-weight: var(--font-weight-semibold);
    padding: 0 var(--space-2) var(--space-2);
    display: block;
}

/* Reward Detail Modal */
#modal-reward-image {
    width: 100%;
    aspect-ratio: 4 / 5;
    object-fit: cover;
    border-radius: var(--radius-lg);
    border: 2px solid var(--accent-500);
}

#modal-reward-name {
    color: var(--text-primary);
    font-weight: var(--font-weight-bold);
    font-size: var(--text-2xl);
    margin-bottom: var(--space-4);
}

#modal-reward-description {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-4);
}

#modal-reward-points-required {
    color: var(--accent-600);
    font-size: var(--text-2xl);
    font-weight: var(--font-weight-bold);
}

/* ===== VARIABLES CSS ===== */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --warning-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    --error-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    
    --dark-bg: #1a202c;
    --darker-bg: #0f1419;
    --card-bg: rgba(255, 255, 255, 0.95);
    /*--text-primary: #2d3748; Overridden by main system */
    /* --text-secondary: #718096; Overridden by main system */
    --text-light: #e2e8f0;
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    
    --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-large: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    
    /* --radius-sm: 8px; Overridden */
    /* --radius-md: 12px; Overridden */
    /* --radius-lg: 16px; Overridden */
    /* --radius-xl: 20px; Overridden */
    
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    /* --transition-fast: all 0.15s ease; Overridden */
    --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===== CONTENEDOR PRINCIPAL ===== */
.cart-section {
    background: var(--card-bg);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-large);
    padding: 1.5rem;
    margin: 1rem 0;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.cart-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
    z-index: 1;
}

/* ===== ENCABEZADO ===== */
.cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-light);
}

.cart-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.cart-title i {
    color: #667eea;
}

.cart-subtitle {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin: 0;
}

/* ===== ITEMS DEL CARRITO ===== */
.cart-items {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
    margin-bottom: 1.5rem;
}

.cart-item {
    display: grid;
    grid-template-columns: 60px 1fr auto auto;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    background: white;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
    transition: var(--transition);
    position: relative;
    animation: slideInUp 0.4s ease-out;
}

.cart-item:nth-child(1) { animation-delay: 0.1s; }
.cart-item:nth-child(2) { animation-delay: 0.2s; }
.cart-item:nth-child(3) { animation-delay: 0.3s; }
.cart-item:nth-child(4) { animation-delay: 0.4s; }

.cart-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: #667eea;
}

.cart-item.removing {
    animation: slideOutRight 0.4s ease-in-out forwards;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideOutRight {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100%);
    }
}

/* ===== MINIATURAS ===== */
.item-thumbnail-container {
    position: relative;
    width: 50px;
    height: 50px;
    border-radius: var(--radius-md);
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    flex-shrink: 0;
}

.item-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
    background: var(--primary-gradient);
}

.cart-item:hover .item-thumbnail {
    transform: scale(1.1);
}

.item-thumbnail.fallback {
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.8rem;
}

.item-thumbnail.fallback::before {
    content: 'DL';
}

.quantity-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--secondary-gradient);
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
    border: 2px solid white;
    box-shadow: var(--shadow-soft);
    z-index: 2;
    transition: var(--transition);
}

.quantity-badge.high-quantity {
    background: var(--warning-gradient);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1);
        box-shadow: var(--shadow-soft);
    }
    50% { 
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
    }
}

/* ===== INFORMACIÓN DEL PRODUCTO ===== */
.item-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 0;
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.95rem;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
}

.item-details {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

.item-price {
    font-weight: 700;
    color: #667eea;
    font-size: 0.9rem;
    background: rgba(102, 126, 234, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
}

.item-unit-price {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.item-points {
    background: var(--success-gradient);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

/* ===== CONTROLES DE CANTIDAD ===== */
.cart-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f7fafc;
    padding: 0.5rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    flex-shrink: 0;
}

.quantity-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    color: white;
    flex-shrink: 0;
}

.quantity-btn:active {
    transform: scale(0.9);
}

.quantity-btn.decrease {
    background: #e53e3e;
}

.quantity-btn.decrease:hover {
    background: #c53030;
    box-shadow: var(--shadow-soft);
}

.quantity-btn.increase {
    background: #38a169;
}

.quantity-btn.increase:hover {
    background: #2f855a;
    box-shadow: var(--shadow-soft);
}

.quantity-display {
    min-width: 30px;
    text-align: center;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
    background: white;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--border-light);
    transition: var(--transition);
}

/* ===== BOTÓN ELIMINAR ===== */
.remove-btn {
    background: #718096;
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    cursor: pointer;
    transition: var(--transition);
    margin-left: 0.25rem;
    flex-shrink: 0;
}

.remove-btn:active {
    transform: scale(0.9);
}

.remove-btn:hover {
    background: #4a5568;
    box-shadow: var(--shadow-soft);
}

/* ===== RESUMEN DEL CARRITO ===== */
.cart-summary {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: #f7fafc;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding: 0.5rem 0;
}

.summary-row:last-child {
    margin-bottom: 0;
}

.summary-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
}

.summary-value {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.points-summary {
    background: var(--success-gradient);
    color: white;
    padding: 1rem;
    border-radius: var(--radius-lg);
    margin: 1rem 0;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.points-summary::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
}

.points-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 1;
}

.points-text {
    font-size: 1.25rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    position: relative;
    z-index: 1;
}

.points-icon {
    color: rgba(255, 255, 255, 0.9);
}

/* ===== SECCIÓN TOTAL ===== */
.total-section {
    background: var(--dark-bg);
    color: white;
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    margin: 1rem 0;
    position: relative;
    overflow: hidden;
}

.total-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--primary-gradient);
    opacity: 0.9;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
}

.total-label {
    font-size: 1.1rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
}

.total-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* ===== BOTONES DE ACCIÓN ===== */
.cart-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.cart-action-btn {
    flex: 1;
    min-width: 120px;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-medium);
    background: white;
    color: var(--text-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
    border: none;
}

.cart-action-btn:hover {
    background: #f7fafc;
    border-color: var(--border-light);
    transform: translateY(-1px);
}

.cart-action-btn.danger {
    background: #fed7d7;
    color: #c53030;
    border-color: #feb2b2;
}

.cart-action-btn.danger:hover {
    background: #feb2b2;
    color: #9b2c2c;
}

/* ===== BOTÓN DE PAGO ===== */
.payment-method {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    background: var(--secondary-gradient);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: var(--transition);
    margin-top: 1rem;
    text-decoration: none;
    width: 100%;
    box-sizing: border-box;
}

.payment-method:active {
    transform: scale(0.98);
}

.payment-method:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.payment-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.payment-icon {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.payment-text-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.payment-text {
    font-weight: 600;
    font-size: 1rem;
    color: white;
}

.payment-subtext {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.8);
}

.payment-arrow {
    font-size: 1.2rem;
    opacity: 0.8;
    flex-shrink: 0;
}

/* ===== ESTADO VACÍO ===== */
.cart-empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-secondary);
}

.cart-empty-icon {
    font-size: 3rem;
    color: #cbd5e0;
    margin-bottom: 1rem;
    opacity: 0.7;
}

.cart-empty-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.cart-empty-subtext {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

/* ===== NOTIFICACIONES ===== */
.cart-notification {
    position: fixed;
    top: 100px;
    right: 20px;
    background: var(--success-gradient);
    color: white;
    padding: 12px 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    z-index: 10000;
    transform: translateX(400px);
    transition: var(--transition-slow);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 300px;
}

.cart-notification.show {
    transform: translateX(0);
}

.cart-notification .notification-content {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}

.cart-notification i {
    font-size: 1.2em;
}

.cart-notification.success {
    background: var(--success-gradient);
}

.cart-notification.error {
    background: var(--error-gradient);
}

.cart-notification.warning {
    background: var(--warning-gradient);
}

.cart-notification.info {
    background: var(--primary-gradient);
}

/* ===== SCROLLBAR ===== */
.cart-items::-webkit-scrollbar {
    width: 6px;
}

.cart-items::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.cart-items::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.cart-items::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* ===== RESPONSIVE - TABLETS ===== */
@media (max-width: 768px) {
    .cart-section {
        padding: 1.25rem;
        margin: 0.75rem 0;
        border-radius: var(--radius-lg);
    }
    
    .cart-item {
        grid-template-columns: 50px 1fr auto;
        gap: 0.75rem;
        padding: 0.75rem;
        min-height: 70px;
    }
    
    .cart-controls {
        grid-column: unset;
        justify-content: flex-end;
        margin-top: 0;
        padding: 0.4rem;
        gap: 0.4rem;
        background: #f8fafc;
        border-radius: var(--radius-sm);
        min-width: fit-content;
    }
    
    .quantity-btn {
        width: 28px;
        height: 28px;
        min-width: 28px;
        font-size: 0.8rem;
    }
    
    .remove-btn {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
        margin-left: 0.2rem;
    }
    
    .quantity-display {
        min-width: 25px;
        font-size: 0.8rem;
        padding: 0.2rem 0.4rem;
    }
    
    .item-info {
        min-width: 0;
        padding-right: 0.5rem;
    }
    
    .item-name {
        font-size: 0.85rem;
    }
    
    .item-details {
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .item-price {
        font-size: 0.8rem;
        padding: 0.15rem 0.5rem;
    }
    
    .item-unit-price {
        font-size: 0.7rem;
    }
    
    .item-points {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
    }
    
    .item-thumbnail-container {
        width: 45px;
        height: 45px;
    }
    
    .quantity-badge {
        width: 18px;
        height: 18px;
        font-size: 0.6rem;
        top: -4px;
        right: -4px;
    }
    
    .cart-summary {
        padding: 1.25rem;
        margin-top: 1.25rem;
    }
    
    .total-section {
        padding: 1.25rem;
    }
    
    .total-amount {
        font-size: 1.3rem;
    }
    
    .payment-method {
        padding: 0.875rem 1.25rem;
    }
    
    .cart-actions {
        gap: 0.5rem;
    }
    
    .cart-action-btn {
        min-width: 100px;
        padding: 0.625rem 0.875rem;
        font-size: 0.8rem;
    }
}

/* ===== RESPONSIVE - MÓVILES PEQUEÑOS ===== */
@media (max-width: 480px) {
    .cart-section {
        padding: 1rem;
        margin: 0.5rem;
        border-radius: var(--radius-md);
    }
    
    .cart-header {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
    }
    
    .cart-title {
        font-size: 1.25rem;
    }
    
    .cart-item {
        grid-template-columns: 40px 1fr auto;
        gap: 0.5rem;
        padding: 0.6rem;
    }
    
    .item-thumbnail-container {
        width: 40px;
        height: 40px;
    }
    
    .item-thumbnail {
        border-radius: var(--radius-sm);
    }
    
    .cart-controls {
        padding: 0.3rem;
        gap: 0.3rem;
    }
    
    .quantity-btn {
        width: 26px;
        height: 26px;
        min-width: 26px;
        font-size: 0.75rem;
    }
    
    .remove-btn {
        width: 26px;
        height: 26px;
        font-size: 0.75rem;
    }
    
    .quantity-display {
        min-width: 22px;
        font-size: 0.75rem;
        padding: 0.15rem 0.3rem;
    }
    
    .item-name {
        font-size: 0.8rem;
    }
    
    .item-details {
        gap: 0.3rem;
    }
    
    .item-price {
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
    }
    
    .item-unit-price {
        font-size: 0.65rem;
    }
    
    .item-points {
        font-size: 0.6rem;
        padding: 0.1rem 0.3rem;
    }
    
    .cart-summary {
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .summary-row {
        margin-bottom: 0.5rem;
    }
    
    .points-summary {
        padding: 0.75rem;
        margin: 0.75rem 0;
    }
    
    .total-section {
        padding: 1rem;
        margin: 0.75rem 0;
    }
    
    .total-amount {
        font-size: 1.3rem;
    }
    
    .payment-method {
        padding: 0.875rem 1rem;
        margin-top: 0.75rem;
    }
    
    .payment-icon {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
    }
    
    .payment-text {
        font-size: 0.9rem;
    }
    
    .cart-actions {
        flex-direction: column;
    }
    
    .cart-action-btn {
        min-width: auto;
        width: 100%;
    }
}

/* ===== RESPONSIVE - MÓVILES MUY PEQUEÑOS ===== */
@media (max-width: 360px) {
    .cart-item {
        grid-template-columns: 35px minmax(0, 1fr) auto;
        gap: 0.4rem;
        padding: 0.5rem;
    }
    
    .item-thumbnail-container {
        width: 35px;
        height: 35px;
    }
    
    .quantity-badge {
        width: 16px;
        height: 16px;
        font-size: 0.55rem;
        top: -3px;
        right: -3px;
    }
    
    .cart-controls {
        padding: 0.25rem;
        gap: 0.25rem;
    }
    
    .quantity-btn {
        width: 24px;
        height: 24px;
        min-width: 24px;
        font-size: 0.7rem;
    }
    
    .remove-btn {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
    }
    
    .quantity-display {
        min-width: 20px;
        font-size: 0.7rem;
        padding: 0.1rem 0.25rem;
    }
    
    .item-name {
        font-size: 0.75rem;
    }
    
    .item-details {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.2rem;
    }
    
    .item-price,
    .item-unit-price,
    .item-points {
        font-size: 0.65rem;
    }
}

/* ===== OPTIMIZACIONES TÁCTILES ===== */
@media (hover: none) and (pointer: coarse) {
    .quantity-btn,
    .remove-btn {
        min-width: 44px;
        min-height: 44px;
    }
    
    .cart-controls {
        padding: 0.5rem;
    }
    
    .cart-item {
        min-height: 80px;
    }
    
    .quantity-btn:active,
    .remove-btn:active,
    .payment-method:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
    }
}

/* ===== MEJORAS DE ACCESIBILIDAD ===== */
@media (prefers-reduced-motion: reduce) {
    .cart-item,
    .quantity-btn,
    .remove-btn,
    .payment-method {
        transition: none;
        animation: none;
    }
}

/* ===== MODO OSCURO ===== */
@media (prefers-color-scheme: dark) {
    .cart-item {
        background: #2d3748;
        border-color: #4a5568;
    }
    
    .item-name {
        color: #e2e8f0;
    }
    
    .item-unit-price {
        color: #a0aec0;
    }
    
    .cart-controls {
        background: #1a202c;
        border-color: #4a5568;
    }
    
    .quantity-display {
        background: #2d3748;
        color: #e2e8f0;
        border-color: #4a5568;
    }
    
    .cart-summary {
        background: #2d3748;
        border-color: #4a5568;
    }
    
    .summary-label {
        color: #a0aec0;
    }
    
    .summary-value {
        color: #e2e8f0;
    }
    
    .cart-action-btn {
        background: #2d3748;
        color: #e2e8f0;
        border-color: #4a5568;
    }
    
    .cart-action-btn:hover {
        background: #374151;
    }
}
/* Toast System */
.toast {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    color: var(--text-primary);
}

.toast-body {
    padding: var(--space-4);
    color: var(--text-primary);
}

.toast.bg-primary { 
    background: var(--primary-600) !important; 
    color: var(--white);
    border: none;
}

.toast.bg-success { 
    background: var(--success-600) !important; 
    color: var(--white);
    border: none;
}

.toast.bg-danger { 
    background: var(--error-600) !important; 
    color: var(--white);
    border: none;
}

.toast.bg-warning { 
    background: var(--warning-600) !important; 
    color: var(--white);
    border: none;
}

/* Floating Action Buttons */
.floating-buttons-container {
    position: fixed;
    bottom: var(--space-8);
    right: var(--space-8);
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.floating-button {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-xl);
    color: var(--white);
    font-size: var(--text-xl);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-lg);
    border: none;
    transition: var(--transition-normal);
    text-decoration: none;
    position: relative;
    cursor: pointer;
}

.floating-button:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-xl);
}

#floatingCartButton {
    background: var(--primary-600);
}

#whatsappButton {
    background: var(--success-600);
}

#floatingShareButton {
    background: var(--accent-600);
}

.floating-cart-count {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--error-600);
    color: var(--white);
    font-size: var(--text-xs);
    font-weight: var(--font-weight-bold);
    padding: 2px 6px;
    border-radius: 20px;
    border: 2px solid var(--bg-primary);
    min-width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.floating-button.clicked-animation {
    animation: fabPulse 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

@keyframes fabPulse {
    0% {
        transform: scale(1);
        box-shadow: var(--shadow-lg);
    }
    50% {
        transform: scale(0.9);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    100% {
        transform: scale(1);
        box-shadow: var(--shadow-lg);
    }
}

/* Footer */
.footer-custom {
    background: var(--bg-primary);
    border-top: 1px solid var(--border-primary);
    color: var(--text-secondary);
    margin-top: auto;
    padding: var(--space-8) 0;
}

.footer-avatar {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: var(--radius-xl);
    border: 3px solid var(--primary-500);
}

.footer-name {
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin: var(--space-2) 0;
}

.footer-link {
    color: var(--text-secondary);
    text-decoration: none;
    transition: var(--transition-fast);
    display: inline-block;
    margin-bottom: var(--space-2);
}

.footer-link:hover {
    color: var(--primary-600);
    transform: translateX(2px);
    text-decoration: none;
}

.social-icons .social-icon-link {
    font-size: var(--text-xl);
    color: var(--text-muted);
    transition: var(--transition-fast);
    text-decoration: none;
}

.social-icons .social-icon-link:hover {
    color: var(--primary-600);
    transform: translateY(-2px);
    text-decoration: none;
}

.footer-refresh-btn {
    width: 36px;
    height: 36px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 50%;
    color: var(--text-muted);
    transition: var(--transition-fast);
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.footer-refresh-btn:hover {
    color: var(--primary-600);
    background: var(--primary-50);
    border-color: var(--primary-500);
}

/* Loading States */
.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.loading-spinner.show {
    display: flex;
}

.luxury-spinner-inner {
    border: 3px solid var(--border-primary);
    border-top: 3px solid var(--primary-600);
    border-radius: 50%;
    width: 48px;
    height: 48px;
    animation: spin 1s linear infinite;
}

.luxury-spinner-text {
    margin-top: var(--space-4);
    color: var(--white);
    font-weight: var(--font-weight-medium);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Alert System */
.alert {
    padding: var(--space-4) var(--space-5);
    border-radius: var(--radius-lg);
    border-left: 4px solid;
    background: var(--bg-primary);
    margin-bottom: var(--space-4);
}

.alert-info {
    border-left-color: var(--primary-500);
    background: var(--primary-50);
    color: var(--primary-700);
}

.alert-success {
    border-left-color: var(--success-500);
    background: var(--success-50);
    color: var(--success-700);
}

.alert-warning {
    border-left-color: var(--warning-500);
    background: var(--warning-50);
    color: var(--warning-700);
}

.alert-danger {
    border-left-color: var(--error-500);
    background: var(--error-50);
    color: var(--error-700);
}

/* Guest Prompt */
#guest-prompt {
    background: linear-gradient(135deg, var(--primary-50), var(--accent-50));
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    text-align: center;
    margin-bottom: var(--space-8);
    box-shadow: var(--shadow-sm);
}

#guest-prompt h4 {
    color: var(--primary-700);
    margin-bottom: var(--space-4);
}

#guest-prompt .lead {
    color: var(--text-secondary);
    font-size: var(--text-lg);
    margin-bottom: var(--space-4);
}

/* Quick Navigation */
#quick-nav-buttons {
    position: fixed;
    bottom: 140px;
    right: var(--space-8);
    z-index: 99;
    display: none;
    flex-direction: column;
    gap: var(--space-2);
}

.quick-nav-btn {
    width: 40px;
    height: 40px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--primary-600);
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: var(--transition-fast);
    box-shadow: var(--shadow-sm);
}

.quick-nav-btn:hover {
    background: var(--primary-600);
    color: var(--white);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

/* Auth Modal Tabs */
#authModal .nav-tabs {
    border-bottom: 1px solid var(--border-primary);
    margin-bottom: var(--space-6);
}

#authModal .nav-tabs .nav-link {
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-secondary);
    padding: var(--space-3) var(--space-4);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
}

#authModal .nav-tabs .nav-link:hover {
    border-bottom-color: var(--border-secondary);
    color: var(--text-primary);
}

#authModal .nav-tabs .nav-link.active {
    border-bottom-color: var(--primary-600);
    color: var(--primary-600);
    background: transparent;
}

#authModal .tab-content {
    padding-top: var(--space-4);
}

/* Help Modal Accordion */
.accordion-item {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-3);
    overflow: hidden;
}

.accordion-button {
    background: var(--bg-primary);
    color: var(--text-primary);
    border: none;
    padding: var(--space-4) var(--space-5);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
}

.accordion-button:not(.collapsed) {
    background: var(--primary-50);
    color: var(--primary-700);
    box-shadow: none;
}

.accordion-button:focus {
    border-color: var(--primary-500);
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.accordion-body {
    background: var(--bg-primary);
    color: var(--text-secondary);
    padding: var(--space-4) var(--space-5);
    border-top: 1px solid var(--border-primary);
}

/* NUEVO: Estilos para la galería de avatares */
#avatar-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: var(--space-3);
    max-height: 40vh;
    overflow-y: auto;
    padding: var(--space-2);
}
.gallery-avatar {
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 50%;
    object-fit: cover;
    cursor: pointer;
    border: 3px solid transparent;
    transition: var(--transition-fast);
}
.gallery-avatar:hover {
    transform: scale(1.05);
    border-color: var(--primary-500);
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 0 var(--space-4);
    }
    
    .navbar-brand {
        font-size: var(--text-lg);
    }
    
    .navbar-nav {
        gap: var(--space-1);
    }
    
    .nav-link {
        padding: var(--space-2);
        font-size: var(--text-sm);
    }
    
    .card-body {
        padding: var(--space-4);
    }
    
    .floating-buttons-container {
        bottom: var(--space-6);
        right: var(--space-6);
    }
    
    .floating-button {
        width: 52px;
        height: 52px;
        font-size: var(--text-lg);
    }
    
    #quick-nav-buttons {
        bottom: 120px;
        right: var(--space-6);
    }
    
    .nav-pills {
        flex-direction: column;
    }
    
    .nav-pills .nav-item {
        min-width: auto;
    }
}

@media (max-width: 576px) {
    main {
        padding-top: 70px;
    }
    
    .btn {
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-sm);
    }
    
    #vip-card-container {
        padding: var(--space-6);
        margin: var(--space-4) 0;
    }
    
    .floating-buttons-container {
        bottom: var(--space-4);
        right: var(--space-4);
    }
    
    .floating-button {
        width: 48px;
        height: 48px;
        font-size: var(--text-base);
    }
    
    .floating-cart-count {
        top: -2px;
        right: -2px;
        font-size: 10px;
        min-width: 18px;
        height: 18px;
    }
    
    .modal-body,
    .modal-header,
    .modal-footer {
        padding: var(--space-4);
    }
}

/* Utility Classes */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

.d-flex { display: flex; }
.d-none { display: none; }
.d-block { display: block; }
.d-inline-block { display: inline-block; }

.flex-column { flex-direction: column; }
.flex-wrap { flex-wrap: wrap; }
.align-items-center { align-items: center; }
.justify-content-center { justify-content: center; }
.justify-content-between { justify-content: space-between; }
.justify-content-end { justify-content: flex-end; }

.mt-1 { margin-top: var(--space-1); }
.mt-2 { margin-top: var(--space-2); }
.mt-3 { margin-top: var(--space-3); }
.mt-4 { margin-top: var(--space-4); }
.mt-6 { margin-top: var(--space-6); }
.mb-1 { margin-bottom: var(--space-1); }
.mb-2 { margin-bottom: var(--space-2); }
.mb-3 { margin-bottom: var(--space-3); }
.mb-4 { margin-bottom: var(--space-4); }
.mb-6 { margin-bottom: var(--space-6); }

.ms-1 { margin-left: var(--space-1); }
.ms-2 { margin-left: var(--space-2); }
.ms-3 { margin-left: var(--space-3); }
.ms-4 { margin-left: var(--space-4); }
.me-1 { margin-right: var(--space-1); }
.me-2 { margin-right: var(--space-2); }
.me-3 { margin-right: var(--space-3); }

.p-1 { padding: var(--space-1); }
.p-2 { padding: var(--space-2); }
.p-3 { padding: var(--space-3); }
.p-4 { padding: var(--space-4); }
.p-6 { padding: var(--space-6); }

.ps-2 { padding-left: var(--space-2); }
.ps-3 { padding-left: var(--space-3); }
.pe-2 { padding-right: var(--space-2); }
.pe-3 { padding-right: var(--space-3); }

.gap-2 { gap: var(--space-2); }
.gap-3 { gap: var(--space-3); }
.gap-4 { gap: var(--space-4); }

.w-100 { width: 100%; }
.h-100 { height: 100%; }

.position-relative { position: relative; }
.position-absolute { position: absolute; }
.position-fixed { position: fixed; }

.top-0 { top: 0; }
.bottom-0 { bottom: 0; }
.start-0 { left: 0; }
.end-0 { right: 0; }

.opacity-75 { opacity: 0.75; }
.opacity-50 { opacity: 0.5; }

.fw-bold { font-weight: var(--font-weight-bold); }
.fw-semibold { font-weight: var(--font-weight-semibold); }
.fw-medium { font-weight: var(--font-weight-medium); }
.fw-normal { font-weight: var(--font-weight-normal); }

.fs-5 { font-size: var(--text-lg); }
.fs-6 { font-size: var(--text-base); }

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: var(--gray-100);
}

::-webkit-scrollbar-thumb {
    background: var(--gray-400);
    border-radius: var(--radius-sm);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--gray-500);
}

/* Focus Management */
*:focus-visible {
    outline: 2px solid var(--primary-500);
    outline-offset: 2px;
}

/* Reduced Motion Support */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
/* Estilos para botones de compartir */
.btn-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

/* Efectos hover para botones de redes sociales */
#shareViaWhatsAppButton:hover {
    background-color: #128C7E !important;
    transform: translateY(-1px);
}

#shareViaFacebookButton:hover {
    background-color: #0e63b8 !important;
    transform: translateY(-1px);
}

#shareViaTwitterButton:hover {
    background-color: #1a91da !important;
    transform: translateY(-1px);
}

#shareViaInstagramButton:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

#shareViaTelegramButton:hover {
    background-color: #0088cc !important;
    transform: translateY(-1px);
}

#shareViaEmailButton:hover {
    background-color: #5a6268 !important;
    transform: translateY(-1px);
}

/* Transiciones suaves */
.btn {
    transition: all 0.2s ease-in-out;
}

/* Responsive para móviles pequeños */
@media (max-width: 576px) {
    .modal-body .row .col-4 {
        padding: 0 2px;
    }
    
    .btn-sm {
        padding: 0.4rem 0.5rem;
        font-size: 0.8rem;
    }
}

</style>
</head>
<body id="top">
 <!-- INICIO: Banner de Instalación de PWA (Diseño Premium) -->
<div id="pwa-install-banner" class="animate__animated">
    <div class="banner-icon-wrapper">
        <img src="./img/Logo-DL-Cumanayagua.png" alt="App Icon">
    </div>
    <div class="banner-text-wrapper">
        <span class="banner-title">DL Cumanayagua</span>
        <span class="banner-subtitle">Instala la app para una mejor experiencia.</span>
    </div>
    <div class="banner-actions-wrapper">
        <button id="pwa-install-button" class="btn-install">Instalar</button>
        <button id="pwa-close-banner-button" class="btn-close-banner" aria-label="Cerrar">&times;</button>
    </div>
</div>
<!-- FIN: Banner de Instalación de PWA -->
    <!-- MODAL DE GALERÍA DE AVATARES -->
    <div class="modal fade" id="avatarGalleryModal" tabindex="-1" aria-labelledby="avatarGalleryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="avatarGalleryModalLabel"><i class="bi bi-person-bounding-box me-2"></i>Elige tu Avatar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="avatar-gallery">
                        <!-- La galería de avatares se poblará aquí dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <nav class="navbar navbar-expand-sm navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#top">
                <img src="img/Logo-DL-Cumanayagua.png" alt="Doña Lucía Logo" style="height: 30px; margin-right: 8px;">
                DL Cumanayagua
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavContent" aria-controls="navbarNavContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavContent">
                <ul class="navbar-nav ms-auto mb-2 mb-sm-0 align-items-sm-center">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTabAndScroll('menu-tab-link')"><i class="bi bi-card-list me-1"></i>Menú</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTabAndScroll('rewards-tab-link')"><i class="bi bi-gift me-1"></i>Recompensas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTabAndScroll('my-orders-tab-link')"><i class="bi bi-receipt me-1"></i>Mis Envíos</a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal"><i class="bi bi-question-circle me-1"></i>Ayuda</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="moreOptionsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical me-1"></i>Más
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="moreOptionsDropdown">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#presentationVideoModal"><i class="bi bi-play-btn-fill me-2"></i>Ver Video Intro</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#sharePageModal"><i class="bi bi-share-fill me-2"></i>Compartir Página</a></li>
                            <li><a class="dropdown-item" href="#" id="installAppButton" style="display: none;"><i class="bi bi-download me-2"></i>Instalar App</a></li>
                        </ul>
                    </li>
                     <li class="nav-item d-block d-sm-none my-2">
                        <hr class="border-secondary">
                    </li>
                    <li class="nav-item d-flex align-items-center" id="auth-buttons-nav-container">
                        <div id="auth-buttons-nav" class="d-flex align-items-center">
                        </div>
                         <button id="logoutButtonNav" class="btn btn-sm btn-outline-warning ms-2" style="display:none;" onclick="logoutClient()"><i class="bi bi-box-arrow-right"></i> Salir</button>
                    </li>
                     <li class="nav-item ms-sm-2" id="cartNavItem" style="display: none !important;">
                        <button class="btn cart-nav-button p-0" type="button" data-bs-toggle="modal" data-bs-target="#cartModal">
                            <i class="bi bi-cart-fill"></i>
                            <span class="badge rounded-pill cart-count-nav" id="cart-count-nav">0</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <main>
        <div class="container mt-5 pt-4 pb-5">
            <div id="vip-card-container" class="vip-card animate__animated animate__fadeInDown" >
                <div class="vip-card-glow"></div>
                <div class="vip-card-noise"></div>
                <div class="vip-card-content">
                    <div class="vip-card-header">
                        <span id="vip-status-badge" class="vip-badge">Cliente VIP</span>
                        <i class="bi bi-shield-check-fill vip-icon"></i>
                    </div>
                    <div class="vip-card-body">
                        <div class="vip-avatar-section" title="Cambiar avatar">
                            <img id="user-avatar" src="./img/placeholder-avatar.png" alt="Avatar del Cliente" class="vip-avatar">
                        </div>
                        <div class="vip-info-section">
                            <p id="client-status" class="client-status-text">Miembro de Doña Lucía</p>
                            <h2 id="client-name" class="client-name-heading">¡Hola!</h2>
                            <div class="points-display-wrapper">
                                <span id="client-points" class="points-value">0</span>
                                <span class="points-label">Puntos Disponibles</span>
                            </div>
                            <small id="client-phone-display" class="client-phone-text"></small>
                        </div>
                    </div>
                    <div id="client-referral-code-container" class="vip-card-footer" style="display: none;">
                        <div class="referral-info">
                            <span class="referral-label">Tu Código de Referido</span>
                            <strong id="clientReferralCode" class="referral-code">Cargando...</strong>
                        </div>
                        <button class="copy-referral-btn" onclick="copyReferralCodeWithFeedback(this)" title="Copiar código">
                            <i class="bi bi-clipboard"></i>
                            <span class="copy-text">Copiar</span>
                        </button>
                    </div>
                </div>
            </div>
             <div id="guest-prompt" class="alert alert-info text-center shadow-sm animate__animated animate__fadeInUp" style="display: block;">
                <h4><i class="bi bi-gift-fill me-2"></i>¡Envía alegría a Cuba con DL Cumanayagua!</h4>
                <p class="lead mb-2">Compra para tus familiares y amigos en Cumanayagua desde cualquier parte del mundo. Paga fácilmente con Zelle.</p>
                <p>Inicia sesión o regístrate para gestionar tus envíos y acumular puntos para futuras compras.</p>
            </div>
            <ul class="nav nav-pills mb-4">
                <li class="nav-item" role="presentation"><a class="nav-link active" id="menu-tab-link" data-bs-toggle="pill" href="#menu-tab" role="tab" aria-controls="menu-tab" aria-selected="true"><i class="bi bi-card-list me-1"></i>Menú y Combos</a></li>
                <li class="nav-item" role="presentation"><a class="nav-link" id="rewards-tab-link" data-bs-toggle="pill" href="#rewards-tab" role="tab" aria-controls="rewards-tab" aria-selected="false"><i class="bi bi-gift me-1"></i>Recompensas</a></li>
                <li class="nav-item" role="presentation"><a class="nav-link" id="my-orders-tab-link" data-bs-toggle="pill" href="#my-orders-tab" role="tab" aria-controls="my-orders-tab" aria-selected="false"><i class="bi bi-receipt me-1"></i>Mis Envíos</a></li>
            </ul>
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="menu-tab" role="tabpanel" aria-labelledby="menu-tab-link">
                    <div class="d-flex justify-content-center align-items-center mb-4">
                        <h3 class="mb-0 me-3 text-center"><i class="bi bi-cup-straw me-2"></i>Catálogo de Productos</h3>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshMenuButton" onclick="forceLoadMenuItems()" title="Actualizar menú">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div id="popular-items-section" class="mb-5">
                        <h4 class="mb-3 text-center"><i class="bi bi-star-fill text-warning me-2"></i>¡Lo Más Pedido Hoy!</h4>
                        <div class="row g-3 g-md-4" id="popular-items-container">
                            <div class="col-12 text-center p-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div><span class="ms-2">Cargando populares...</span></div>
                        </div>
                        <hr class="my-4 border-secondary">
                    </div>
                    <div class="mb-4 position-relative">
                        <input type="text" id="productSearchInput" class="form-control form-control-lg" placeholder="Buscar productos por nombre..." aria-label="Buscar productos">
                        <button id="clearSearchButton" class="btn btn-sm position-absolute end-0 top-50 translate-middle-y me-2" style="display:none;" title="Limpiar búsqueda">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
                        <div id="filter-container" class="d-flex flex-wrap justify-content-center align-items-center">
                        </div>
                        <div class="ms-auto">
                            <select id="sortProductsSelect" class="form-select form-select-sm" style="min-width: 200px;">
                                <option value="default" selected>Ordenar por...</option>
                                <option value="name-asc">Nombre (A-Z)</option>
                                <option value="name-desc">Nombre (Z-A)</option>
                                <option value="price-asc">Precio (Menor a Mayor)</option>
                                <option value="price-desc">Precio (Mayor a Menor)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 g-md-4" id="menu-container"><div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div></div>
                </div>
                <div class="tab-pane fade" id="rewards-tab" role="tabpanel" aria-labelledby="rewards-tab-link">
                    <div class="d-flex justify-content-center align-items-center mb-4">
                        <h3 class="mb-0 me-3 text-center"><i class="bi bi-stars me-2"></i>Recompensas para tus Envíos</h3>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshRewardsButton" onclick="forceLoadRewards()" title="Actualizar recompensas">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="row g-3 g-md-4" id="rewards-container"><div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div></div>
                </div>
                <div class="tab-pane fade" id="my-orders-tab" role="tabpanel" aria-labelledby="my-orders-tab-link">
                    <h3 class="mb-4 text-center"><i class="bi bi-clock-history me-2"></i>Historial de Envíos</h3>
                    <div id="orders-history-container"><div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tus envíos.</p></div></div>
                </div>
            </div>
        </div>
    </main>
    <div id="loadingSpinnerUser" class="loading-spinner">
      <div class="luxury-spinner">
        <div class="luxury-spinner-inner"></div>
        <span class="luxury-spinner-text">Cargando...</span>
      </div>
    </div>
    <div class="toast-container position-fixed bottom-0 start-0 p-3" id="toastPlacement" style="z-index: 2050"> </div>
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalLabel">Acceso / Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs nav-fill mb-3" id="authTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="login-tab-btn" data-bs-toggle="tab" data-bs-target="#login-tab-pane" type="button" role="tab" aria-controls="login-tab-pane" aria-selected="true">
                                <i class="bi bi-box-arrow-in-right me-1"></i>Iniciar Sesión
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="register-tab-btn" data-bs-toggle="tab" data-bs-target="#register-tab-pane" type="button" role="tab" aria-controls="register-tab-pane" aria-selected="false">
                                <i class="bi bi-person-plus-fill me-1"></i>Crear Cuenta
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="authTabContent">
                        <div class="tab-pane fade show active" id="login-tab-pane" role="tabpanel" aria-labelledby="login-tab-btn" tabindex="0">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="loginPhone" class="form-label">Teléfono (Tuyo)</label>
                                    <input type="tel" class="form-control" id="loginPhone" required autocomplete="username tel">
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="loginPassword" required autocomplete="current-password">
                                </div>
                                <div id="login-feedback" class="mt-3 mb-3"></div>
                                <button type="button" class="btn btn-primary w-100" onclick="handleLoginAttempt()">Acceder</button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="register-tab-pane" role="tabpanel" aria-labelledby="register-tab-btn" tabindex="0">
                            <form id="newUserRegistrationForm">
                                <div class="mb-3">
                                    <label for="newUserName" class="form-label">Nombre Completo (Tuyo) <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newUserName" required autocomplete="name">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserPhone" class="form-label">Teléfono (Tuyo, con código de país si es de USA) <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="newUserPhone" required placeholder="Ej: +1 XXX XXX XXXX" autocomplete="tel">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserEmail" class="form-label">Correo (Tuyo) <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="newUserEmail" required autocomplete="email">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserPassword" class="form-label">Contraseña <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="newUserPassword" required autocomplete="new-password">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserConfirmPassword" class="form-label">Confirmar Contraseña <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="newUserConfirmPassword" required autocomplete="new-password">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserReferralCodeUsed" class="form-label">Código de Referido (Opcional)</label>
                                    <input type="text" class="form-control" id="newUserReferralCodeUsed" placeholder="Ingresa un código si tienes uno">
                                    <div id="referral-code-feedback" class="form-text text-success mt-1" style="display: none;">
                                        <i class="bi bi-check-circle-fill"></i> Código de referido aplicado.
                                    </div>
                                </div>
                                <div id="registration-feedback" class="mt-3 mb-3"></div>
                                <button type="button" class="btn btn-primary w-100" onclick="handleUserRegistrationAttempt()">Registrarme</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cartModalLabel"><i class="bi bi-cart-fill me-2"></i> Mi Carrito de Envío</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-0">
             <div class="p-3" id="cart-items-container"></div>
             <div class="p-3" id="order-placement-feedback"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title" id="productDetailModalLabel">Detalles del Producto</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body pt-0"><div class="row g-4"><div class="col-md-6"><img src="./img/placeholder-product.png" id="modal-product-image" class="img-fluid" alt="Imagen del producto"></div><div class="col-md-6 d-flex flex-column"><h2 id="modal-product-name" class="mb-2">Nombre del Producto</h2><p id="modal-product-description" class="text-muted flex-grow-1">Descripción detallada del producto...</p><div class="d-flex justify-content-between align-items-center mb-3"><span id="modal-product-price">USD 0.00</span><span class="badge bg-success" id="modal-product-points">+0 Puntos</span></div><div id="modal-add-to-cart-button-container" class="mb-4"></div><div id="modal-recommendations-container"></div></div></div></div></div></div>
    </div>
    <div class="modal fade" id="rewardDetailModal" tabindex="-1" aria-labelledby="rewardDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="rewardDetailModalLabel">Detalles de la Recompensa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="row g-4">
                    <div class="col-md-5">
                        <img src="./img/placeholder-product.png" id="modal-reward-image" class="img-fluid" alt="Imagen de la recompensa" style="aspect-ratio: 4 / 5; object-fit: cover; border-radius: 1rem; border: 2px solid var(--accent-500);">
                    </div>
                    <div class="col-md-7 d-flex flex-column">
                        <h2 id="modal-reward-name" class="mb-2" style="font-family: 'Playfair Display', serif; color: var(--accent-color);">Nombre de la Recompensa</h2>
                        <p id="modal-reward-description" class="text-muted">Descripción detallada de la recompensa...</p>
                        <div class="d-flex justify-content-between align-items-center my-3">
                            <span id="modal-reward-points-required" style="color: var(--accent-color); font-size: 1.75rem; font-weight: 700;">0 Puntos</span>
                            <span class="badge" id="modal-reward-stock-info"></span>
                        </div>
                        <div id="modal-redeem-reward-button-container" class="mb-3"></div>
                        <hr class="border-secondary my-3">
                        <div id="modal-product-recommendations-for-reward-container">
                            <h5 class="mb-3" style="font-weight: 600;"><i class="bi bi-hand-thumbs-up-fill me-2"></i>Productos que te podrían gustar:</h5>
                            <div id="reward-modal-product-recs-row" class="row g-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
   <div class="modal fade" id="sharePageModal" tabindex="-1" aria-labelledby="sharePageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sharePageModalLabel"><i class="bi bi-share-fill me-2"></i>Compartir esta Página</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-3">Comparte esta página para que otros puedan realizar compras y envíos.</p>
                
                <!-- Código QR -->
                <div id="qrcodeCanvas" class="mx-auto mb-4 border p-2 rounded" style="width: 150px; height: 150px; background-color: white;">
                </div>
                
                <!-- Botones de Compartir - Primera Fila -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <button class="btn btn-primary btn-sm w-100" id="copyLinkButton">
                            <i class="bi bi-clipboard-check-fill me-1"></i>Copiar Enlace
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-dark btn-sm w-100" id="shareViaSystemButton">
                            <i class="bi bi-share me-1"></i>Compartir
                        </button>
                    </div>
                </div>
                
                <!-- Redes Sociales Principales -->
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <a id="shareViaWhatsAppButton" class="btn btn-success btn-sm w-100" href="#" target="_blank">
                            <i class="bi bi-whatsapp"></i>
                        </a>
                    </div>
                    <div class="col-4">
                        <a id="shareViaFacebookButton" class="btn btn-primary btn-sm w-100" href="#" target="_blank" style="background-color: #1877F2; border-color: #1877F2;">
                            <i class="bi bi-facebook"></i>
                        </a>
                    </div>
                    <div class="col-4">
                        <a id="shareViaTwitterButton" class="btn btn-info btn-sm w-100" href="#" target="_blank" style="background-color: #1DA1F2; border-color: #1DA1F2;">
                            <i class="bi bi-twitter"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Más Redes Sociales -->
                <div class="row g-2 mb-4">
                    <div class="col-4">
                        <a id="shareViaInstagramButton" class="btn btn-danger btn-sm w-100" href="#" target="_blank" style="background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D); border: none;">
                            <i class="bi bi-instagram"></i>
                        </a>
                    </div>
                    <div class="col-4">
                        <a id="shareViaTelegramButton" class="btn btn-info btn-sm w-100" href="#" target="_blank">
                            <i class="bi bi-telegram"></i>
                        </a>
                    </div>
                    <div class="col-4">
                        <a id="shareViaEmailButton" class="btn btn-secondary btn-sm w-100" href="#">
                            <i class="bi bi-envelope-fill"></i>
                        </a>
                    </div>
                </div>
                
                <small class="d-block mt-3 text-muted">Muestra el código QR para escanear directamente o comparte el enlace.</small>
            </div>
        </div>
    </div>
</div>
    <div class="modal fade" id="confirmClearCartModal" tabindex="-1" aria-labelledby="confirmClearCartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmClearCartModalLabel"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirmar Acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres vaciar completamente tu carrito de envío? Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmClearCartButton">
                        <i class="bi bi-trash3-fill me-1"></i>Sí, Vaciar Carrito
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="confirmRedeemRewardModal" tabindex="-1" aria-labelledby="confirmRedeemRewardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmRedeemRewardModalLabel"><i class="bi bi-patch-check-fill text-warning me-2"></i>Confirmar Canje de Recompensa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmRedeemRewardText">¿Estás seguro de que quieres canjear esta recompensa?</p>
                    <div id="redeemRewardFeedback" class="mt-3"></div>
                </div>
                <div class="modal-footer" id="confirmRedeemRewardFooter">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="confirmRedeemRewardButton">
                        <i class="bi bi-award-fill me-1"></i>Sí, Canjear Ahora
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="presentationVideoModal" tabindex="-1" aria-labelledby="presentationVideoModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-xl" id="presentationVideoDialog">
            <div class="modal-content" id="presentationVideoContent" style="background-color: transparent; border: none; box-shadow: none;">
                <div class="modal-header border-0 position-absolute top-0 end-0" style="z-index: 10;">
                     <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="closePresentationVideoModal" style="background-color: rgba(0,0,0,0.5); border-radius:50%; padding:0.5em;"></button>
                </div>
                <div class="modal-body p-0" id="presentationVideoBody">
                    <video id="introVideo" width="100%" height="auto" controls autoplay muted playsinline preload="auto">
                        <source src="./Dl%20Cumanayagua%20Logo%20reveal.mp4" type="video/mp4">
                        Tu navegador no soporta la etiqueta de video.
                    </video>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel"><i class="bi bi-question-circle-fill me-2"></i>Ayuda y Cómo Funciona</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="lead">¡Bienvenido a DL Cumanayagua! Aquí te explicamos cómo funciona nuestra plataforma para que puedas enviar productos y cariño a tus seres queridos en Cumanayagua, Cuba, de forma fácil y segura.</p>
                    <div class="accordion" id="helpAccordion">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="globalMessageModal" tabindex="-1" aria-labelledby="globalMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalMessageModalTitle">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Anuncio Importante
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="globalMessageModalBody">
                    <p>Cargando mensaje...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>

     <!-- MODAL DE INSTALACIÓN DE PWA -->
 <div class="modal fade" id="pwaInstallModal" tabindex="-1" aria-labelledby="pwaInstallModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pwaInstallModalLabel">
                        <i class="bi bi-download me-2"></i>Instalar App DL Cumanayagua
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <i class="bi bi-phone display-1 text-primary"></i>
                    </div>
                    <h4 class="mb-3">¡Instala nuestra app!</h4>
                    <p class="mb-4">Obtén la mejor experiencia instalando DL Cumanayagua en tu dispositivo. Acceso rápido, notificaciones y funcionamiento offline.</p>
                    <div class="d-grid gap-2">
                        <button id="installPWAButton" class="btn btn-primary btn-lg">
                            <i class="bi bi-download me-2"></i>Instalar App
                        </button>
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Quizás más tarde
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="floating-buttons-container">
        <a id="whatsappButton" href="https://wa.me/5355189657?text=Hola,%20tengo%20una%20consulta%20sobre%20DL%20Cumanayagua." class="floating-button" target="_blank" title="Chatea con nosotros">
            <i class="bi bi-whatsapp"></i>
        </a>
        <button id="floatingCartButton" class="floating-button" type="button" data-bs-toggle="modal" data-bs-target="#cartModal" style="display: none;" title="Ver Carrito de Envío">
            <i class="bi bi-cart3"></i>
            <span class="floating-cart-count" id="floating-cart-count">0</span>
        </button>
        <button id="floatingShareButton" class="floating-button" type="button" data-bs-toggle="modal" data-bs-target="#sharePageModal" title="Compartir esta página" style="background: linear-gradient(145deg, #5D3FD3, #8A2BE2);">
            <i class="bi bi-share-fill"></i>
        </button>
    </div>
    <div id="quick-nav-buttons">
        <a href="#top" class="quick-nav-btn" title="Ir arriba"><i class="bi bi-arrow-up"></i></a>
        <a href="#bottom" id="go-down-btn" class="quick-nav-btn" title="Ir abajo"><i class="bi bi-arrow-down"></i></a>
    </div>
    <footer id="bottom" class="footer-custom pt-5 pb-4">
        <div class="container text-center text-md-start">
            <div class="row gy-4">
                <div class="col-lg-4 col-md-12 mb-4 mb-md-0">
                    <div class="d-flex align-items-center justify-content-center justify-content-md-start mb-3">
                         <img src="https://i.postimg.cc/rsFSGFt2/Generated-Image-June-11-2025-1-22-AM.jpg" alt="Erick Olivera" class="footer-avatar me-3">
                         <div>
                            <h5 class="text-uppercase fw-bold mb-1">DL Cumanayagua</h5>
                            <p class="footer-name mb-0">Erick Olivera</p>
                         </div>
                    </div>
                    <p class="small text-muted">
                        Tu conexión directa para enviar productos y cariño a tus seres queridos en Cumanayagua. Fácil, rápido y seguro.
                    </p>
                </div>
                <div class="col-lg-2 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Navegación</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" onclick="showTabAndScroll('menu-tab-link'); return false;" class="footer-link">Menú</a></li>
                        <li><a href="#" onclick="showTabAndScroll('rewards-tab-link'); return false;" class="footer-link">Recompensas</a></li>
                        <li><a href="#" onclick="showTabAndScroll('my-orders-tab-link'); return false;" class="footer-link">Mis Envíos</a></li>
                         <li><a href="#" data-bs-toggle="modal" data-bs-target="#helpModal" class="footer-link">Ayuda</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Contacto</h5>
                     <p><i class="bi bi-telephone-fill me-2"></i>+53 55189657</p>
                     <p><i class="bi bi-geo-alt-fill me-2"></i>Cumanayagua, Cuba</p>
                </div>
                <div class="col-lg-3 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Síguenos</h5>
                    <div class="social-icons">
                        <a href="https://wa.me/5355189657?text=Hola,%20tengo%20una%20consulta%20sobre%20DL%20Cumanayagua." class="social-icon-link me-3 fs-4" title="WhatsApp"><i class="bi bi-whatsapp"></i></a>
                        <a href="#!" class="social-icon-link me-3 fs-4" title="Facebook"><i class="bi bi-facebook"></i></a>
                        <a href="#!" class="social-icon-link fs-4" title="Instagram"><i class="bi bi-instagram"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4">
            <div class="footer-copyright-container d-flex justify-content-center align-items-center">
                <span class="small text-muted">© 2024 DL Cumanayagua. Todos los derechos reservados.</span>
                <button class="footer-refresh-btn ms-3" onclick="forceFullCacheRefresh()" title="Actualizar datos de la página">
                    <i class="bi bi-cloud-arrow-down-fill fs-5"></i>
                </button>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
// ===================================================================
// ==================== CONFIGURACIÓN Y CONSTANTES ===================
// ===================================================================
const GOOGLE_SCRIPT_URL_USER = 'https://script.google.com/macros/s/AKfycbzbbeuK7TA0VBDucZZALIK_Q2XFwLoT_mD-gEmkecd2Gr8IE7uFoWDOex6B58SRpEWrVg/exec';
const LOGGED_IN_CLIENT_KEY = 'cafeteriaVipClientLoggedIn_v9';
const USER_CART_KEY = 'cafeteriaUserCart_v6';
const PRESENTATION_VIDEO_SHOWN_KEY = 'presentationVideoShown_v1';
const REFERRAL_POINTS_FOR_REFERRER = 25;
const REFERRAL_POINTS_FOR_REFEREE = 15;
const SEEN_MESSAGE_TIMESTAMP_KEY = 'seenGlobalMessageTimestamp_v1';

const AVATAR_GALLERY_IMAGES = [
    'https://i.postimg.cc/DZJmXb0N/Caricature1.png', 'https://i.postimg.cc/NM9LHrFz/Caricature2.png',
    'https://i.postimg.cc/76Gb2Thc/Caricature3.png', 'https://i.postimg.cc/mDzhHFkJ/Caricature4.png',
    'https://i.postimg.cc/sXQ1hZ1x/Caricature5.png', 'https://i.postimg.cc/76FhMYTq/Caricature6.png',
    'https://i.postimg.cc/V6xvBLbs/Caricature7.png', 'https://i.postimg.cc/RFkhQVnZ/Caricature8.png',
    'https://i.postimg.cc/Kz6jrvgT/Caricature9.png', 'https://i.postimg.cc/B6rbcQ1D/Caricature10.png',
    'https://i.postimg.cc/V6xvBLbq/Caricature11.png', 'https://i.postimg.cc/Kz6jrvgr/Caricature12.png'
];

// ===================================================================
        // ==================== INSTALACIÓN DE PWA ===========================
        // ===================================================================

        let deferredPrompt;

        // Registrar el Service Worker para habilitar PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('Service Worker registrado con éxito:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Error al registrar el Service Worker:', error);
                    });
            });
        }

        // Detectar cuando la app se puede instalar
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // En lugar de un modal, mostramos nuestro banner superior
            showPWAInstallBanner();
        });

        function showPWAInstallBanner() {
    const banner = document.getElementById('pwa-install-banner');
    const navbar = document.querySelector('.navbar-custom');
    
    // No mostrar si ya fue descartado en esta sesión
    if (banner && !sessionStorage.getItem('pwaBannerDismissed')) {
        // AJUSTE 3: Calculamos la posición para que quede debajo del navbar
        if (navbar) {
            banner.style.top = `${navbar.offsetHeight}px`;
        }
        
        banner.style.display = 'flex';
        banner.classList.add('animate__fadeInDown');
    }
}

        // Detectar si la app ya está instalada
        window.addEventListener('appinstalled', () => {
            console.log('PWA fue instalada');
            deferredPrompt = null;
            hideInstallButton();
        });

        // Verificar si la app ya está instalada al cargar la página
        function checkIfPWAInstalled() {
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                console.log('App ya instalada.');
                hideInstallButton();
                return true;
            }
            return false;
        }

        function hideInstallButton() {
            const installAppButton = document.getElementById('installAppButton');
            const banner = document.getElementById('pwa-install-banner');
            if (installAppButton) {
                installAppButton.style.display = 'none';
            }
            if(banner){
                banner.style.display = 'none';
            }
        }

        // Mostrar manualmente el prompt de instalación
        function showManualInstallPrompt() {
            if (deferredPrompt) {
                // Ahora muestra el banner en lugar del modal
                showPWAInstallBanner();
            } else {
                showGlobalFeedback('Tu navegador no soporta la instalación o la app ya está instalada.', 'info', 4000);
            }
        }

// ===================================================================
// ==================== VARIABLES GLOBALES ===========================
// ===================================================================
let clientData = null;
let menuItems = [];
let availableRewards = [];
let shoppingCart = [];
let currentFilterCategory = 'all';
let currentSortOption = 'default';
const loadingSpinnerUser = document.getElementById('loadingSpinnerUser');
let authModalInstance, cartModalInstance, productDetailModalInstance,
    sharePageModalInstance, confirmClearCartModalInstance, confirmRedeemRewardModalInstance,
    presentationVideoModalInstance, helpModalInstance, rewardDetailModalInstance,
    globalMessageModalInstance, avatarGalleryModalInstance;
let floatingCartButtonEl, floatingCartCountEl;
let qrcodePageInstance = null;
let lastOrderDetails = null;
let initialReferralCode = null; // Variable para almacenar el código de referido de la URL

// ===================================================================
// ==================== INICIALIZACIÓN DE LA PÁGINA ==================
// ===================================================================
document.addEventListener('DOMContentLoaded', async function() {
    floatingCartButtonEl = document.getElementById('floatingCartButton');
    floatingCartCountEl = document.getElementById('floating-cart-count');
    
    handleInitialReferral();
    
    if (initialReferralCode && !sessionStorage.getItem('referralModalShown')) {
        setTimeout(() => {
            openAuthModal('register');
            sessionStorage.setItem('referralModalShown', 'true');
        }, 1000);
    }
    
    initializeModals();
    loadCartFromStorage();
    loadClientDataFromStorage();
    updateClientDisplayAndUI();
    
    await loadInitialData();
    
    setupEventListeners();
    handleScroll();
    initializeShareModal();
    setupFloatingButtonFeedback();
    setupNavbarToggler();
    populateAvatarGallery();
    setupSearchAndSort();
    setupVipCardInteraction();

    // Inicializar funcionalidades de PWA
            checkIfPWAInstalled();
            
            const installAppButton = document.getElementById('installAppButton');
            if (installAppButton && deferredPrompt) {
                installAppButton.style.display = 'block';
                installAppButton.addEventListener('click', showManualInstallPrompt);
            }

            // Lógica para el nuevo banner de instalación de PWA
            const installBanner = document.getElementById('pwa-install-banner');
            const installButtonBanner = document.getElementById('pwa-install-button');
            const closeButtonBanner = document.getElementById('pwa-close-banner-button');

            if (installButtonBanner) {
                installButtonBanner.addEventListener('click', async () => {
                    if (installBanner) installBanner.style.display = 'none';

                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            showGlobalFeedback('¡App instalada con éxito!', 'success');
                        } else {
                            showGlobalFeedback('Instalación cancelada.', 'info');
                        }
                        deferredPrompt = null;
                    }
                });
            }

            // AÑADE ESTE NUEVO BLOQUE
            if (installBanner) {
                // Escucha el evento de Bootstrap cuando el banner se empieza a cerrar
                installBanner.addEventListener('close.bs.alert', () => {
                    // Recordar que el usuario cerró el banner en esta sesión
                    sessionStorage.setItem('pwaBannerDismissed', 'true');
                });
            }
        });

// ===================================================================
// ==================== SISTEMA DE REFERIDOS =========================
// ===================================================================

function handleInitialReferral() {
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');
    if (refCode) {
        initialReferralCode = refCode.trim();
        console.log('Referral code detected:', initialReferralCode);
        showGlobalFeedback(`¡Código de referido detectado! Recibirás puntos extra al registrarte.`, 'success', 5000);
    }
}

function generateReferralLink() {
    const baseUrl = window.location.origin + window.location.pathname;
    if (clientData && clientData.referralcode) {
        return `${baseUrl}?ref=${clientData.referralcode}`;
    }
    return baseUrl;
}

function applyReferralCodeToForm() {
    if (initialReferralCode) {
        const referralInput = document.getElementById('newUserReferralCodeUsed');
        const referralFeedback = document.getElementById('referral-code-feedback');
        if (referralInput) {
            referralInput.value = initialReferralCode;
            referralInput.readOnly = true;
            if (referralFeedback) {
                referralFeedback.style.display = 'block';
            }
        }
    }
}

function initializeShareModal() {
     const shareModalEl = document.getElementById('sharePageModal');
     if (shareModalEl) {
        shareModalEl.addEventListener('shown.bs.modal', () => {
            const qrPageCanvas = document.getElementById('qrcodeCanvas');
            const pageUrl = generateReferralLink();

            // --- INICIO DE LA NUEVA LÓGICA ---
            let shareText;
            const hasReferralCode = clientData && clientData.referralcode;

            if (hasReferralCode) {
                // Mensaje promocional si hay código de referido
                shareText = `¡Te invito a DL Cumanayagua! Usa mi código de referido al registrarte y ambos ganaremos puntos de descuento. ¡Es fácil y seguro enviar a Cuba!`;
            } else {
                // Mensaje estándar si no hay código
                shareText = "¡Echa un vistazo a DL Cumanayagua para enviar productos a Cuba! Fácil, rápido y seguro.";
            }
            // --- FIN DE LA NUEVA LÓGICA ---

            const encodedShareText = encodeURIComponent(shareText);
            const encodedUrl = encodeURIComponent(pageUrl);

            // Generar QR Code (no cambia)
            if (qrPageCanvas) {
                qrPageCanvas.innerHTML = '';
                if (qrcodePageInstance) {
                    qrcodePageInstance.clear();
                    qrcodePageInstance = null;
                }
                qrcodePageInstance = new QRCode(qrPageCanvas, {
                    text: pageUrl, 
                    width: 130, 
                    height: 130,
                    colorDark : "#000000", 
                    colorLight : "#ffffff", 
                    correctLevel : QRCode.CorrectLevel.H
                });
            }

            // Configurar enlaces de redes sociales con el nuevo texto dinámico
            document.getElementById('shareViaWhatsAppButton').href = `https://wa.me/?text=${encodedShareText}%20${encodedUrl}`;
            document.getElementById('shareViaTelegramButton').href = `https://t.me/share/url?url=${encodedUrl}&text=${encodedShareText}`;
            document.getElementById('shareViaFacebookButton').href = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedShareText}`;
            document.getElementById('shareViaTwitterButton').href = `https://twitter.com/intent/tweet?text=${encodedShareText}&url=${encodedUrl}`;
            document.getElementById('shareViaInstagramButton').href = `https://www.instagram.com/?url=${encodedUrl}`; // Instagram no soporta texto predefinido
            document.getElementById('shareViaEmailButton').href = `mailto:?subject=${encodeURIComponent('DL Cumanayagua - Envíos a Cuba')}&body=${encodedShareText}%0D%0A%0D%0A${encodedUrl}`;

            // Botón Copiar Enlace (no cambia)
            const copyLinkButton = document.getElementById('copyLinkButton');
            copyLinkButton.onclick = function() {
                navigator.clipboard.writeText(pageUrl).then(() => {
                    showGlobalFeedback('¡Enlace copiado al portapapeles!', 'success', 2000);
                    const originalText = copyLinkButton.innerHTML;
                    copyLinkButton.innerHTML = '<i class="bi bi-check-lg me-1"></i>¡Copiado!';
                    copyLinkButton.classList.remove('btn-primary');
                    copyLinkButton.classList.add('btn-success');
                    setTimeout(() => {
                        copyLinkButton.innerHTML = originalText;
                        copyLinkButton.classList.remove('btn-success');
                        copyLinkButton.classList.add('btn-primary');
                    }, 2000);
                }).catch((err) => {
                    showGlobalFeedback('Error al copiar el enlace.', 'danger');
                });
            };

            // Botón Compartir Nativo (Web Share API) con el nuevo texto dinámico
            const shareViaSystemButton = document.getElementById('shareViaSystemButton');
            if (navigator.share) {
                shareViaSystemButton.style.display = 'block';
                shareViaSystemButton.onclick = async function() {
                    try {
                        await navigator.share({
                            title: 'DL Cumanayagua - Envíos a Cuba',
                            text: shareText, // Usamos la variable con el texto dinámico
                            url: pageUrl
                        });
                        showGlobalFeedback('¡Contenido compartido!', 'success', 2000);
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            showGlobalFeedback('Error al compartir.', 'warning');
                        }
                    }
                };
            } else {
                shareViaSystemButton.style.display = 'none';
            }
        });
     }
}

function openAuthModal(tabToActivate = 'login') {
    if (authModalInstance) {
        authModalInstance.show();
        const tabButtonId = (tabToActivate === 'register') ? 'register-tab-btn' : 'login-tab-btn';
        const tabButton = document.getElementById(tabButtonId);
        if (tabButton) {
            bootstrap.Tab.getOrCreateInstance(tabButton).show();
        }

        if (tabToActivate === 'register') {
            applyReferralCodeToForm();
        }
    }
}

function clearFormAndFeedback(formId, feedbackId) {
    document.getElementById(formId)?.reset();
    document.getElementById(feedbackId).innerHTML = '';

    if (formId === 'newUserRegistrationForm') {
        const referralInput = document.getElementById('newUserReferralCodeUsed');
        const referralFeedback = document.getElementById('referral-code-feedback');
        if (referralInput) {
            referralInput.readOnly = false;
        }
        if (referralFeedback) {
            referralFeedback.style.display = 'none';
        }
    }
}

// ===================================================================
// ==================== RESTO DEL SCRIPT (COMPLETO) ==================
// ===================================================================

function setupFloatingButtonFeedback() {
    if (floatingCartButtonEl) {
        floatingCartButtonEl.addEventListener('click', function() {
            floatingCartButtonEl.classList.add('clicked-animation');
            setTimeout(() => {
                floatingCartButtonEl.classList.remove('clicked-animation');
            }, 400);
        });
    }

    const floatingShareButtonEl = document.getElementById('floatingShareButton');
    if (floatingShareButtonEl) {
        floatingShareButtonEl.addEventListener('click', function() {
            floatingShareButtonEl.classList.add('clicked-animation');
            setTimeout(() => {
                floatingShareButtonEl.classList.remove('clicked-animation');
            }, 400);
        });
    }

    const whatsappButtonEl = document.getElementById('whatsappButton');
    if (whatsappButtonEl) {
        whatsappButtonEl.addEventListener('click', function(event) {
            whatsappButtonEl.classList.add('clicked-animation');
            setTimeout(() => {
                whatsappButtonEl.classList.remove('clicked-animation');
            }, 400);
        });
    }
}


function initializeModals() {
    const modalIds = [
        'authModal', 'cartModal', 'productDetailModal', 'sharePageModal', 
        'confirmClearCartModal', 'confirmRedeemRewardModal', 'presentationVideoModal', 
        'helpModal', 'rewardDetailModal', 'globalMessageModal', 'avatarGalleryModal'
    ];
    modalIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            const instance = new bootstrap.Modal(el);
            if (id === 'authModal') authModalInstance = instance;
            if (id === 'cartModal') cartModalInstance = instance;
            if (id === 'productDetailModal') productDetailModalInstance = instance;
            if (id === 'sharePageModal') sharePageModalInstance = instance;
            if (id === 'confirmClearCartModal') confirmClearCartModalInstance = instance;
            if (id === 'confirmRedeemRewardModal') confirmRedeemRewardModalInstance = instance;
            if (id === 'presentationVideoModal') presentationVideoModalInstance = instance;
            if (id === 'helpModal') helpModalInstance = instance;
            if (id === 'rewardDetailModal') rewardDetailModalInstance = instance;
            if (id === 'globalMessageModal') globalMessageModalInstance = instance;
            if (id === 'avatarGalleryModal') avatarGalleryModalInstance = instance;
        } else { console.warn(`Modal con ID '${id}' no encontrado.`); }
    });
}

function setupEventListeners() {
    document.getElementById('authModal')?.addEventListener('hidden.bs.modal', () => {
        clearFormAndFeedback('newUserRegistrationForm', 'registration-feedback');
        clearFormAndFeedback('loginForm', 'login-feedback');
    });
    
    document.getElementById('cartModal')?.addEventListener('show.bs.modal', renderCartItems);
    document.getElementById('cartModal')?.addEventListener('hidden.bs.modal', () => {
        document.getElementById('order-placement-feedback').innerHTML = '';
    });

    document.querySelector('.vip-avatar-section')?.addEventListener('click', () => {
        if (clientData && clientData.id) {
            avatarGalleryModalInstance?.show();
        } else {
            showGlobalFeedback("Inicia sesión para cambiar tu avatar.", "warning");
            openAuthModal('login');
        }
    });
    
    document.getElementById('rewards-tab-link')?.addEventListener('shown.bs.tab', () => {
        if (!clientData || !clientData.id) generateRewardsList();
        else if (availableRewards.length === 0) forceLoadRewards();
    });

    document.getElementById('my-orders-tab-link')?.addEventListener('shown.bs.tab', loadUserOrders);
    
    window.addEventListener('resize', adjustBodyPaddingAndFabPosition);
    window.addEventListener('scroll', handleScroll);
}

function setupSearchAndSort() {
    const productSearchInput = document.getElementById('productSearchInput');
    const clearSearchButton = document.getElementById('clearSearchButton');
    const sortProductsSelect = document.getElementById('sortProductsSelect');

    productSearchInput?.addEventListener('input', () => {
        generateMenu();
        if (clearSearchButton) clearSearchButton.style.display = productSearchInput.value.length > 0 ? 'block' : 'none';
    });
    clearSearchButton?.addEventListener('click', () => {
        if (productSearchInput) productSearchInput.value = '';
        clearSearchButton.style.display = 'none';
        generateMenu();
    });
    sortProductsSelect?.addEventListener('change', function() {
        currentSortOption = this.value;
        generateMenu();
    });
}

function populateAvatarGallery() {
    const galleryContainer = document.getElementById('avatar-gallery');
    if (!galleryContainer) return;
    galleryContainer.innerHTML = AVATAR_GALLERY_IMAGES.map(imageUrl => 
        `<img src="${imageUrl}" alt="Avatar" class="gallery-avatar" loading="lazy" onclick="selectAvatar('${imageUrl}')">`
    ).join('');
}

async function selectAvatar(imageUrl) {
    if (!clientData || !clientData.id) {
        showGlobalFeedback('Debes iniciar sesión para cambiar tu avatar.', 'warning');
        return;
    }
    document.getElementById('user-avatar').src = imageUrl;
    clientData.avatarurl = imageUrl;
    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
    
    avatarGalleryModalInstance?.hide();
    showGlobalFeedback('Avatar actualizado. Guardando en el servidor...', 'info', 3000);

    const payload = { clientId: clientData.id, newAvatarUrl: imageUrl };
    const result = await fetchDataFromGAS('updateClientAvatarUrl', 'POST', payload);

    if (result.success) {
        showGlobalFeedback('¡Avatar guardado con éxito!', 'success');
        if(result.data && result.data.clientData) {
            clientData = result.data.clientData;
            localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
        }
    } else {
        showGlobalFeedback(result.message || 'Error al guardar el avatar.', 'warning');
    }
}

function updateClientDisplayAndUI() {
    const el = id => document.getElementById(id);
    const vipCard = el('vip-card-container'), guestPrompt = el('guest-prompt');
    const userAvatarImg = el('user-avatar');

    if (clientData && clientData.id) {
        el('client-name').textContent = clientData.nombre || 'Cliente VIP';
        el('client-points').textContent = clientData.puntos || 0;
        el('client-status').textContent = `Nivel: ${(clientData.puntos||0)>=150?"Oro":(clientData.puntos||0)>=75?"Plata":"Bronce"}`;
        userAvatarImg.src = clientData.avatarurl || './img/placeholder-avatar.png';
        el('auth-buttons-nav').innerHTML = `<span class="navbar-text me-2 small">Hola, ${clientData.nombre ? clientData.nombre.split(' ')[0] : 'VIP'}</span>`;
        el('logoutButtonNav').style.display = 'inline-block';
        vipCard.style.display = 'block';
        guestPrompt.style.display = 'none';
        if (clientData.referralcode) {
            el('clientReferralCode').textContent = clientData.referralcode;
            el('client-referral-code-container').style.display = 'flex';
        }
    } else {
        vipCard.style.display = 'none';
        guestPrompt.style.display = 'block';
        el('auth-buttons-nav').innerHTML = `<button class="btn btn-sm btn-outline-primary me-2" onclick="openAuthModal('login')"><i class="bi bi-box-arrow-in-right"></i> Login</button> <button class="btn btn-sm btn-warning" onclick="openAuthModal('register')"><i class="bi bi-person-plus"></i> Registro</button>`;
        el('logoutButtonNav').style.display = 'none';
        loadUserOrders();
        generateRewardsList();
    }
    updateCartDisplay();
}

async function handleLoginAttempt() {
    const telefono = document.getElementById('loginPhone').value.trim();
    const password = document.getElementById('loginPassword').value;
    const feedbackElId = 'login-feedback';
    if (!telefono || !password) {
        showFeedbackInModal(null, feedbackElId, 'Teléfono y contraseña son requeridos.', 'danger'); return;
    }
    showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Iniciando sesión...', 'info', null);
    const payload = { telefono, password };
    const result = await fetchDataFromGAS('loginUser', 'POST', payload);
    if (result.success && result.data) {
        clientData = result.data;
        localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
        updateClientDisplayAndUI();
        showFeedbackInModal(null, feedbackElId, `¡Bienvenido de nuevo, ${clientData.nombre.split(' ')[0]}! Listo para enviar.`, 'success', 3000);
        setTimeout(() => authModalInstance?.hide(), 2000);
        loadUserOrders();
    } else {
        showFeedbackInModal(null, feedbackElId, result.message || 'Error al iniciar sesión. Verifica tus datos.', 'danger');
    }
}

async function handleUserRegistrationAttempt() {
    const nombre = document.getElementById('newUserName').value.trim();
    const telefono = document.getElementById('newUserPhone').value.trim();
    const email = document.getElementById('newUserEmail').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const confirmPassword = document.getElementById('newUserConfirmPassword').value;
    const referralCodeUsed = document.getElementById('newUserReferralCodeUsed').value.trim();
    const feedbackElId = 'registration-feedback';

    if (!nombre || !telefono || !email || !password || !confirmPassword) {
        showFeedbackInModal(null, feedbackElId, 'Todos los campos marcados con * son requeridos.', 'danger'); return;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showFeedbackInModal(null, feedbackElId, 'Por favor, ingresa un correo electrónico válido.', 'danger'); return;
    }
    if (password !== confirmPassword) {
        showFeedbackInModal(null, feedbackElId, 'Las contraseñas no coinciden.', 'danger'); return;
    }
    if (!/^\+?\d{7,15}$/.test(telefono)) {
        showFeedbackInModal(null, feedbackElId, 'Por favor, ingresa un número de teléfono válido (7-15 dígitos, puede incluir + al inicio).', 'danger'); return;
    }
     if (password.length < 6) {
        showFeedbackInModal(null, feedbackElId, 'La contraseña debe tener al menos 6 caracteres.', 'danger'); return;
    }
    showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Registrando...', 'info', null);
    const payload = { nombre, telefono, email, password, referralCodeUsed };
    const result = await fetchDataFromGAS('registerNewUser', 'POST', payload);
    if (result.success) {
        showFeedbackInModal(null, feedbackElId, `${result.message || '¡Registro exitoso!'} Ahora puedes iniciar sesión para realizar tus envíos.`, 'success', 4000);
        document.getElementById('newUserRegistrationForm').reset();
        setTimeout(() => {
            if (authModalInstance) {
                const loginTabBtn = document.getElementById('login-tab-btn');
                if (loginTabBtn) {
                    bootstrap.Tab.getOrCreateInstance(loginTabBtn).show();
                }
                clearFormAndFeedback('newUserRegistrationForm', 'registration-feedback');
            }
        }, 3000);
    } else {
        showFeedbackInModal(null, feedbackElId, result.message || 'Error al registrar. Intenta de nuevo.', 'danger');
    }
}

function logoutClient() {
    clientData = null;
    localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
    shoppingCart = [];
    availableRewards = [];
    localStorage.removeItem(USER_CART_KEY);
    updateClientDisplayAndUI();
    showGlobalFeedback('Sesión cerrada. ¡Vuelve pronto!', 'info');
}

function setupVipCardInteraction() {
    const card = document.getElementById('vip-card-container');
    if (!card) return;
    const glow = card.querySelector('.vip-card-glow');

    card.addEventListener('mousemove', (e) => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left, y = e.clientY - rect.top;
        if(glow) glow.style.transform = `translate(${x - rect.width}px, ${y - rect.height}px)`;
        const mouseX = x - rect.width / 2, mouseY = y - rect.height / 2;
        card.style.transform = `perspective(1000px) rotateX(${-mouseY/20}deg) rotateY(${mouseX/20}deg)`;
    });

    card.addEventListener('mouseleave', () => {
        card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg)';
        if(glow) glow.style.transform = 'translate(-50%, -50%)';
    });
}

function copyReferralCodeWithFeedback(buttonElement) {
    if (clientData && clientData.referralcode) {
        navigator.clipboard.writeText(clientData.referralcode).then(() => {
            const icon = buttonElement.querySelector('i'), text = buttonElement.querySelector('.copy-text');
            if (icon && text) {
                icon.className = 'bi bi-check-lg'; text.textContent = 'Copiado';
                buttonElement.style.background = '#10B981';
                setTimeout(() => {
                    icon.className = 'bi bi-clipboard'; text.textContent = 'Copiar';
                    buttonElement.style.background = '';
                }, 2000);
            }
            showGlobalFeedback('¡Código de referido copiado!', 'success', 2000);
        }).catch(err => showGlobalFeedback('Error al copiar el código.', 'danger'));
    }
}

function formatOrderDate(dateStr) {
    if (!dateStr) return 'Fecha no disponible';
    const date = new Date(dateStr);
    if (isNaN(date.getTime()) || date.getFullYear() < 2000) {
        return 'Fecha inválida';
    }
    return date.toLocaleDateString('es-ES', { 
        year: 'numeric', month: 'short', day: 'numeric', 
        hour: '2-digit', minute: '2-digit', hour12: true 
    });
}

async function loadUserOrders() {
    const container = document.getElementById('orders-history-container');
    if (!container) return;
    if (!clientData || !clientData.id) {
        container.innerHTML = `<div class="text-center p-5"><p>Inicia sesión para ver tus envíos.</p></div>`;
        return;
    }
    
    container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando envíos...</p></div>`;
    const result = await fetchDataFromGAS('getUserOrders', 'POST', { clientId: String(clientData.id) });

    if (result.success && Array.isArray(result.data)) {
        if (result.data.length === 0) {
            container.innerHTML = `<div class="text-center p-5"><p>Aún no tienes envíos registrados.</p></div>`;
            return;
        }

        let html = '<div class="accordion shadow-sm" id="ordersAccordion">';
        result.data.forEach((order, index) => {
            let items = order.itemsjson || []; 
            let itemsHtml = '<div class="table-responsive"><table class="table table-sm table-borderless small mt-2">';
            itemsHtml += '<thead class="text-muted"><tr><th>Cant.</th><th>Producto</th><th class="text-end">Precio Unit.</th><th class="text-end">Subtotal</th></tr></thead><tbody>';
            
            if (items.length > 0) {
                items.forEach(item => {
                    const unitPrice = parseFloat(item.price) || 0;
                    const quantity = parseInt(item.quantity) || 0;
                    const subtotal = unitPrice * quantity;
                    itemsHtml += `<tr><td>${quantity}x</td><td>${item.name}</td><td class="text-end">$${unitPrice.toFixed(2)}</td><td class="text-end fw-bold">$${subtotal.toFixed(2)}</td></tr>`;
                });
            } else { 
                itemsHtml += '<tr><td colspan="4">No hay detalles de ítems.</td></tr>'; 
            }
            itemsHtml += '</tbody></table></div>';
            
            let sbc = 'bg-secondary';
            const os = String(order.status || '').toLowerCase();
            if (os.includes('pendiente')) sbc = 'bg-warning text-dark';
            else if (os.includes('procesado') || os.includes('preparación')) sbc = 'bg-info text-dark';
            else if (os.includes('entregado') || os.includes('completado')) sbc = 'bg-success';
            else if (os.includes('cancelado')) sbc = 'bg-danger';

            const formattedDate = formatOrderDate(order.orderdateiso || order.orderdate);
            
            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="hO${order.orderid}"><button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#cO${order.orderid}" aria-expanded="${index===0}"><span class="me-auto">${formattedDate} - Envío #${String(order.orderid || '').substr(-6)}</span><span class="badge ${sbc} text-uppercase">${order.status||'N/A'}</span></button></h2>
                    <div id="cO${order.orderid}" class="accordion-collapse collapse ${index===0 ? 'show' : ''}" data-bs-parent="#ordersAccordion">
                        <div class="accordion-body">
                            <h6>Detalles del Envío</h6>
                            ${itemsHtml}
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Puntos Otorgados:</span>
                                <span><strong>${order.totalpointsawarded || 0}</strong> Pts</span>
                            </div>
                            <div class="d-flex justify-content-between mt-2 fs-5">
                                <span class="fw-bold">TOTAL:</span>
                                <span class="fw-bold text-primary">USD ${(parseFloat(order.totalamount)||0).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    } else {
        container.innerHTML = `<div class="text-center p-5 text-danger"><p>Error al cargar envíos: ${result.message}</p></div>`;
    }
}

function generateEmailBody(orderId, cart, total) {
    let body = `¡Hola! He realizado un nuevo pedido desde DL Cumanayagua.\n\n`;
    body += `*Nro. de Envío:* ${orderId}\n\n`;
    body += `*Resumen del pedido:*\n`;
    cart.forEach(item => {
        body += `- ${item.quantity}x ${item.name}\n`;
    });
    body += `\n*Total:* USD ${total.toFixed(2)}\n\n`;
    body += `Espero instrucciones para el pago. ¡Gracias!`;
    body = body.replace(/\*/g, '').replace(/\n/g, '%0D%0A');
    return body;
}

async function confirmAndPlaceOrder() {
    if (shoppingCart.length === 0) {
        showFeedbackInModal(null, 'order-placement-feedback', "Tu carrito está vacío.", "warning");
        return;
    }
    if (!clientData || !clientData.id) {
        showFeedbackInModal(null, 'order-placement-feedback', 'Inicia sesión para realizar un envío.', 'warning');
        cartModalInstance?.hide(); openAuthModal('login'); return;
    }

    showFeedbackInModal(null, 'order-placement-feedback', '<div class="spinner-border spinner-border-sm me-2"></div>Procesando envío...', 'info', null);
    
    const cartPayload = shoppingCart.map(item => ({ productId: String(item.productId), quantity: item.quantity }));
    const result = await fetchDataFromGAS('placeOrder', 'POST', { clientId: String(clientData.id), cartItems: cartPayload });

    if (result.success && result.data) {
        const orderTotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        lastOrderDetails = { orderId: result.data.orderId, cart: [...shoppingCart], total: orderTotal };

        const whatsappMessage = generateWhatsAppMessage(lastOrderDetails.orderId, lastOrderDetails.cart, lastOrderDetails.total);
        const whatsappUrl = `https://wa.me/5355189657?text=${whatsappMessage}`;

        document.getElementById('order-placement-feedback').innerHTML = `
            <div class="alert alert-success" role="alert">
              <h4 class="alert-heading">¡Envío Registrado con Éxito!</h4>
              <p>Tu pedido <strong>#${lastOrderDetails.orderId}</strong> ha sido creado. Por favor, notifícanos para coordinar el pago.</p>
              <hr>
              <div class="d-grid gap-2">
                  <a href="${whatsappUrl}" target="_blank" class="btn btn-success btn-lg" onclick="postWhatsAppNotification()">
                    <i class="bi bi-whatsapp me-2"></i><strong>Notificar por WhatsApp</strong>
                  </a>
                  <button class="btn btn-outline-primary btn-lg" onclick="sendOrderViaEmail()">
                    <i class="bi bi-envelope-fill me-2"></i>Notificar (Abrir App de Email)
                  </button>
              </div>
            </div>`;
        
        shoppingCart = [];
        saveCartToStorage();
        if (result.data.updatedClient) {
            clientData = result.data.updatedClient;
            localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
        }
        updateClientDisplayAndUI();
        renderCartItems();
        loadUserOrders();
    } else {
        showFeedbackInModal(null, 'order-placement-feedback', result.message || 'Error al programar el envío.', 'danger');
    }
}

function sendOrderViaEmail() {
    if (!lastOrderDetails) {
        showGlobalFeedback("No hay información del último pedido para enviar.", "warning");
        return;
    }
    
    const recipientEmail = "erick890406@gmail.com"; 
    const subject = encodeURIComponent(`Notificación de Nuevo Pedido #${lastOrderDetails.orderId}`);
    const body = generateEmailBody(lastOrderDetails.orderId, lastOrderDetails.cart, lastOrderDetails.total);

    const mailtoLink = `mailto:${recipientEmail}?subject=${subject}&body=${body}`;
    window.open(mailtoLink, '_self');
}

function generateWhatsAppMessage(orderId, cart, total) {
    let message = `¡Hola! 👋 He realizado un nuevo pedido desde DL Cumanayagua.\n\n`;
    message += `*Nro. de Envío:* ${orderId}\n\n`;
    message += "*Resumen del pedido:*\n";
    cart.forEach(item => {
        message += `- ${item.quantity}x ${item.name}\n`;
    });
    message += `\n*Total:* USD ${total.toFixed(2)}\n\n`;
    message += `Espero instrucciones para el pago. ¡Gracias!`;
    return encodeURIComponent(message);
}

function renderCartItems() {
    const container = document.getElementById('cart-items-container');
    if (!container) return;
    
    container.innerHTML = ''; 

    if (!Array.isArray(shoppingCart) || shoppingCart.length === 0) {
        container.innerHTML = `<div class="cart-empty-state"><i class="bi bi-cart-x cart-empty-icon"></i><p class="cart-empty-text">Tu carrito de envío está vacío</p><p class="cart-empty-subtext">Añade productos desde el menú para empezar.</p></div>`;
        updateCartDisplay();
        return;
    }
    
    let currentTotal = 0, totalPoints = 0, totalItems = 0;
    const cartItemsWrapper = document.createElement('div');
    cartItemsWrapper.className = 'cart-items';

    shoppingCart.forEach(item => {
        const itemTotal = (item.price || 0) * (item.quantity || 1);
        const itemPoints = (item.points || 0) * (item.quantity || 1);
        currentTotal += itemTotal;
        totalPoints += itemPoints;
        totalItems += (item.quantity || 1);
        const itemProductId = String(item.productId || '');
        const productInfo = menuItems.find(p => p.id === itemProductId);
        const imageUrl = productInfo ? productInfo.imageurl : '';

        cartItemsWrapper.innerHTML += `
            <div class="cart-item" data-product-id="${itemProductId}">
                <div class="item-thumbnail-container">
                    <img src="${imageUrl || './img/placeholder-product.png'}" alt="${item.name}" class="item-thumbnail" loading="lazy">
                    <span class="quantity-badge">${item.quantity}</span>
                </div>
                <div class="item-info">
                    <p class="item-name">${item.name}</p>
                    <div class="item-details">
                        <span class="item-price">USD ${itemTotal.toFixed(2)}</span>
                        <span class="item-unit-price">(${item.quantity} × $${item.price.toFixed(2)})</span>
                        ${itemPoints > 0 ? `<span class="item-points">+${itemPoints} pts</span>` : ''}
                    </div>
                </div>
                <div class="cart-controls">
                    <button class="quantity-btn decrease" onclick="handleQuantityChange('${itemProductId}', -1, this)">-</button>
                    <span class="quantity-display">${item.quantity}</span>
                    <button class="quantity-btn increase" onclick="handleQuantityChange('${itemProductId}', 1, this)">+</button>
                </div>
                <button class="remove-btn" onclick="handleRemoveItem('${itemProductId}', this)"><i class="bi bi-trash3"></i></button>
            </div>`;
    });
    container.appendChild(cartItemsWrapper);
    
    container.innerHTML += `
        <div class="cart-summary">
            <div class="summary-row">
                <span class="summary-label">Subtotal (${totalItems} items)</span>
                <span class="summary-value">USD ${currentTotal.toFixed(2)}</span>
            </div>
            <div class="points-summary">
                <div class="points-text"><i class="bi bi-star-fill points-icon"></i> Puntos a ganar: <strong>${totalPoints}</strong></div>
            </div>
        </div>
        <div class="total-section">
            <div class="total-row">
                <span class="total-label">Total del Envío</span>
                <span class="total-amount">USD ${currentTotal.toFixed(2)}</span>
            </div>
        </div>
        <div class="cart-actions">
            <button class="cart-action-btn danger" onclick="clearCart()"><i class="bi bi-trash3"></i> Vaciar Carrito</button>
            <button class="cart-action-btn" onclick="continueShopping()"><i class="bi bi-arrow-left-circle"></i> Seguir Comprando</button>
        </div>
        <a href="#" class="payment-method" onclick="event.preventDefault(); handlePayment();">
            <div class="payment-info"><div class="payment-icon">Z</div><span class="payment-text">Pagar con Zelle</span></div>
            <i class="bi bi-arrow-right-circle payment-arrow"></i>
        </a>`;
    updateCartDisplay();
}

async function loadInitialData() {
    const menuContainer = document.getElementById('menu-container');
    const rewardsContainer = document.getElementById('rewards-container');
    const popularContainer = document.getElementById('popular-items-container');
    
    if (menuContainer) menuContainer.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div><p class="mt-3">Cargando menú...</p></div>`;
    if (rewardsContainer) rewardsContainer.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border text-info" style="width: 3rem; height: 3rem;"></div><p class="mt-3">Cargando recompensas...</p></div>`;
    if (popularContainer) popularContainer.innerHTML = `<div class="col-12 text-center p-3"><div class="spinner-border spinner-border-sm text-warning"></div><span class="ms-2">Buscando lo más popular...</span></div>`;

    const res = await fetchDataFromGAS('getInitialClientData', 'GET');

    if (res.success && res.data) {
        menuItems = (res.data.products || []).map(p => ({ ...p, price: parseFloat(p.price) || 0, points: parseInt(p.points) || 0, id: String(p.id), category: p.category || "Otros" }));
        generatePopularItems();
        generateCategoryFilters();
        generateMenu();

        availableRewards = (res.data.rewards || []).map(r => ({ ...r, rewardid: String(r.rewardid), pointsrequired: parseInt(r.pointsrequired) || 0, stock: parseInt(r.stock) }));
        generateRewardsList();

        if (res.data.globalMessage && res.data.globalMessage.lastUpdated) {
            handleGlobalMessage(res.data.globalMessage);
        }
    } else {
        const errorMessage = `<div class="col-12 text-center text-danger p-5"><h4>Error al cargar</h4><p>${res.message || 'No se pudieron obtener los datos del servidor.'}</p></div>`;
        if (menuContainer) menuContainer.innerHTML = errorMessage;
        if (rewardsContainer) rewardsContainer.innerHTML = errorMessage;
        if (popularContainer) popularContainer.innerHTML = errorMessage;
    }
}

function handleGlobalMessage(message) {
    const lastSeenTimestamp = localStorage.getItem(SEEN_MESSAGE_TIMESTAMP_KEY);
    
    if (message.lastUpdated !== lastSeenTimestamp) {
        const titleEl = document.getElementById('globalMessageModalTitle');
        const bodyEl = document.getElementById('globalMessageModalBody');
        
        if (titleEl && bodyEl && globalMessageModalInstance) {
            titleEl.innerHTML = `<i class="bi bi-info-circle-fill me-2" style="color:var(--primary-color);"></i> ${message.title}`;
            bodyEl.innerHTML = message.body;

            globalMessageModalInstance.show();
            
            localStorage.setItem(SEEN_MESSAGE_TIMESTAMP_KEY, message.lastUpdated);
        }
    }
}

async function forceLoadMenuItems() {
     const res = await fetchDataFromGAS('getPublicProducts', 'GET');
     if (res.success && Array.isArray(res.data)) {
        menuItems = res.data.map(p => ({...p, price: parseFloat(p.price) || 0, points: parseInt(p.points) || 0, id: String(p.id), category: p.category || "Otros"}));
        generatePopularItems();
        generateCategoryFilters();
        generateMenu();
        showGlobalFeedback("Menú y combos actualizados.", "success", 2000);
     } else {
        showGlobalFeedback("No se pudo actualizar el menú.", "warning", 4000);
     }
}

function generatePopularItems() {
    const popularContainer = document.getElementById('popular-items-container');
    if (!popularContainer) return;

    if (!menuItems || menuItems.length === 0) {
        popularContainer.innerHTML = '<div class="col-12 text-center p-3"><p class="text-muted">No hay productos para mostrar como populares aún.</p></div>';
        return;
    }
    
    let availableItems = menuItems.filter(item => item.active !== false);
    
    let popularToShow = [...availableItems];
    popularToShow.sort(() => 0.5 - Math.random());
    popularToShow = popularToShow.slice(0, 4);

    if (popularToShow.length === 0) {
         popularContainer.innerHTML = '<div class="col-12 text-center p-3"><p class="text-muted">No hay productos destacados en este momento.</p></div>';
         return;
    }
    
    popularContainer.innerHTML = '';
    popularToShow.forEach(item => {
        const itemId = String(item.id);
        popularContainer.innerHTML += `
        <div class="col-6 col-md-6 col-lg-3 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.6s;">
            <div class="menu-item-card card w-100 d-flex flex-column">
               <img src="${item.imageurl || './img/placeholder-product.png'}"
                     class="product-image card-img-top" alt="${item.name || 'Producto'}" style="cursor: pointer;" onclick="showProductDetailModal('${itemId}')" loading="lazy">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${item.name || 'Sin Nombre'}</h5>
                    <p class="card-text small flex-grow-1">${(item.description || 'Deliciosa opción de nuestro menú.').substring(0,70)}${(item.description || '').length > 70 ? '...' : ''}</p>
                    <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-2">
                        <span class="fw-bold fs-6" style="color: var(--primary-color);">USD ${(item.price || 0).toFixed(2)}</span>
                        <span class="badge bg-success text-white small">+${item.points || 0} Pts</span>
                    </div>
                    <button class="btn btn-sm btn-primary mt-2 w-100" onclick="addToCart('${itemId}')"><i class="bi bi-cart-plus-fill me-1"></i>Añadir</button>
                </div>
            </div>
        </div>`;
    });
}

function generateCategoryFilters() {
    const filterContainer = document.getElementById('filter-container');
    if (!filterContainer) {
        console.error("Contenedor de filtros no encontrado.");
        return;
    }
    filterContainer.innerHTML = '';
    if (!menuItems || menuItems.length === 0) {
        return;
    }
    const allBtn = document.createElement('button');
    allBtn.className = 'btn btn-sm btn-filter';
    allBtn.textContent = 'Todos';
    allBtn.onclick = () => filterMenuByCategory('all');
    filterContainer.appendChild(allBtn);
    const categories = [...new Set(menuItems.map(item => item.category || "Otros"))]
        .sort((a, b) => a.localeCompare(b));
    categories.forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-filter';
        btn.textContent = category;
        btn.onclick = () => filterMenuByCategory(category);
        filterContainer.appendChild(btn);
    });
    const filterButtons = filterContainer.querySelectorAll('.btn-filter');
    filterButtons.forEach(btn => {
        const btnTextLower = btn.textContent.toLowerCase();
        const currentFilterLower = currentFilterCategory.toLowerCase();
        if ((currentFilterLower === 'all' && btnTextLower === 'todos') ||
            (btnTextLower === currentFilterLower && currentFilterLower !== 'all')) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

function filterMenuByCategory(category) {
    currentFilterCategory = category;
    generateCategoryFilters();
    generateMenu();
}

function generateMenu() {
    const menuContainer = document.getElementById('menu-container');
    if (!menuContainer) return;
    menuContainer.innerHTML = '';

    const searchTerm = document.getElementById('productSearchInput')?.value.toLowerCase().trim() || '';
    
    let itemsToDisplay = [...menuItems].filter(item => item.active !== false);

    if (currentFilterCategory !== 'all') {
        itemsToDisplay = itemsToDisplay.filter(item => (item.category || "Otros") === currentFilterCategory);
    }

    if (searchTerm) {
        itemsToDisplay = itemsToDisplay.filter(item =>
            (item.name || '').toLowerCase().includes(searchTerm) ||
            (item.description || '').toLowerCase().includes(searchTerm)
        );
    }

    switch (currentSortOption) {
        case 'name-asc':
            itemsToDisplay.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
            break;
        case 'name-desc':
            itemsToDisplay.sort((a, b) => (b.name || "").localeCompare(a.name || ""));
            break;
        case 'price-asc':
            itemsToDisplay.sort((a, b) => (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0));
            break;
        case 'price-desc':
            itemsToDisplay.sort((a, b) => (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0));
            break;
        case 'default':
        default:
            itemsToDisplay.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
            break;
    }

    if (!itemsToDisplay || itemsToDisplay.length === 0) {
        let emptyMessage = `<div class="col-12 text-center p-md-5 p-4">`;
        emptyMessage += `<i class="bi bi-search-heart display-1 text-muted opacity-50 mb-3"></i>`;
        if (searchTerm && currentFilterCategory === 'all') {
            emptyMessage += `<h4 class="text-light mb-2">Sin resultados para "${searchTerm}"</h4><p class="text-muted mb-3">No encontramos productos que coincidan con tu búsqueda.</p>`;
        } else if (searchTerm && currentFilterCategory !== 'all') {
             emptyMessage += `<h4 class="text-light mb-2">Sin resultados en "${currentFilterCategory}"</h4><p class="text-muted mb-3">No hay productos en esta categoría que coincidan con "${searchTerm}".</p>`;
        } else if (!searchTerm && currentFilterCategory !== 'all') {
            emptyMessage += `<h4 class="text-light mb-2">Categoría Vacía</h4><p class="text-muted mb-3">No hay productos disponibles en la categoría "${currentFilterCategory}".</p>`;
        } else {
            emptyMessage += `<h4 class="text-light mb-2">Menú Vacío</h4><p class="text-muted mb-3">No hay productos disponibles en el menú en este momento.</p>`;
        }
        emptyMessage += `<p class="text-muted">Intenta con otros términos o revisa todas las categorías.</p>`;
        if (searchTerm || currentFilterCategory !== 'all') {
            emptyMessage += `<button class="btn btn-outline-primary mt-2" onclick="resetFiltersAndSearch()">Ver todo el menú</button>`;
        }
        emptyMessage += `</div>`;
        menuContainer.innerHTML = emptyMessage;
        return;
    }

    itemsToDisplay.forEach(item => {
        const itemId = String(item.id);
        const buttonHtml = `<button class="btn btn-primary mt-3 w-100" onclick="addToCart('${itemId}')"><i class="bi bi-cart-plus-fill me-2"></i>Añadir</button>`;

        menuContainer.innerHTML += `
        <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
            <div class="menu-item-card card w-100 d-flex flex-column">
                <img src="${item.imageurl || 'https://via.placeholder.com/350x220/E74C3C/FFF?text=' + encodeURIComponent(item.name || 'Producto')}"
                     class="product-image card-img-top" alt="${item.name || 'Producto'}" style="cursor: pointer;" onclick="showProductDetailModal('${itemId}')" loading="lazy">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${item.name || 'Sin Nombre'}</h5>
                    <p class="card-text flex-grow-1">${item.description || 'Deliciosa opción de nuestro menú.'}</p>
                    <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                        <span class="fw-bold fs-5" style="color: var(--primary-color);">USD ${(item.price || 0).toFixed(2)}</span>
                        <span class="badge bg-success text-white">+${item.points || 0} Puntos</span>
                    </div>
                    ${buttonHtml}
                </div>
            </div>
        </div>`;
    });
}

function resetFiltersAndSearch() {
    const productSearchInput = document.getElementById('productSearchInput');
    if (productSearchInput) productSearchInput.value = '';
    const clearSearchButton = document.getElementById('clearSearchButton');
    if (clearSearchButton) clearSearchButton.style.display = 'none';
    currentFilterCategory = 'all';
    currentSortOption = 'default';
    const sortSelect = document.getElementById('sortProductsSelect');
    if (sortSelect) sortSelect.value = 'default';
    generateCategoryFilters();
    generateMenu();
}

function showProductDetailModal(productId) {
    populateModalWithProduct(productId);
    productDetailModalInstance.show();
}

function switchProductInModal(productId) {
    populateModalWithProduct(productId);
}

function populateModalWithProduct(productId) {
    const product = menuItems.find(p => p.id === productId);
    if (!product) {
        console.error("Producto no encontrado para el modal:", productId);
        return;
    }
    document.getElementById('modal-product-image').src = product.imageurl || './img/placeholder-product.png';
    document.getElementById('modal-product-name').textContent = product.name || 'Sin Nombre';
    document.getElementById('modal-product-description').textContent = product.description || 'Descripción no disponible.';
    document.getElementById('modal-product-price').textContent = `USD ${(product.price || 0).toFixed(2)}`;
    document.getElementById('modal-product-points').textContent = `+${product.points || 0} Puntos`;
    
    const btnContainer = document.getElementById('modal-add-to-cart-button-container');
    const isAvailable = product.active !== false;
    
    if (isAvailable) {
         btnContainer.innerHTML = `<button class="btn btn-primary btn-lg w-100" onclick="addToCartAndCloseModal('${productId}')"><i class="bi bi-cart-plus-fill me-2"></i>Añadir al Carrito</button>`;
    } else {
         btnContainer.innerHTML = `<button class="btn btn-secondary btn-lg w-100" disabled><i class="bi bi-x-circle-fill me-2"></i>Producto No Disponible</button>`;
    }

    generateRecommendations(productId);
}

function generateRecommendations(currentProductId) {
    const recommendationsContainer = document.getElementById('modal-recommendations-container');
    recommendationsContainer.innerHTML = '<h5><i class="bi bi-magic me-2"></i>También podría interesarte</h5>';
    const currentProduct = menuItems.find(p => p.id === currentProductId);
    if (!currentProduct) return;
    
    const candidates = menuItems.filter(p => p.id !== currentProductId && p.active !== false);
    
    const sameCategory = candidates.filter(p => p.category === currentProduct.category);
    const otherCategory = candidates.filter(p => p.category !== currentProduct.category);
    const shuffledCandidates = [...sameCategory.sort(() => 0.5 - Math.random()), ...otherCategory.sort(() => 0.5 - Math.random())];
    const finalRecommendations = shuffledCandidates.slice(0, 3);
    
    if (finalRecommendations.length === 0) {
        recommendationsContainer.innerHTML += '<p class="small text-muted">No hay otras recomendaciones por ahora.</p>';
        return;
    }
    
    const recRow = document.createElement('div');
    recRow.className = 'row g-2';
    finalRecommendations.forEach(rec => {
        recRow.innerHTML += `
        <div class="col-4">
            <div class="recommendation-card" onclick="switchProductInModal('${rec.id}')">
                <img src="${rec.imageurl || './img/placeholder-product.png'}" alt="${rec.name}" loading="lazy">
                <div class="p-2"><div class="rec-title">${rec.name}</div></div>
            </div>
        </div>`;
    });
    recommendationsContainer.appendChild(recRow);
}

function addToCartAndCloseModal(productId) {
    addToCart(productId);
    productDetailModalInstance.hide();
}

function loadCartFromStorage(){
    const storedCart = localStorage.getItem(USER_CART_KEY);
    shoppingCart = storedCart ? (JSON.parse(storedCart) || []) : [];
    updateCartDisplay();
}

function saveCartToStorage(){
    try {
        localStorage.setItem(USER_CART_KEY, JSON.stringify(shoppingCart));
    } catch(e) {
        showGlobalFeedback("No se pudo guardar el carrito. Espacio de almacenamiento lleno?", "danger");
    }
}

function addToCart(productId) {
    if (!clientData || !clientData.id) {
        showGlobalFeedback('Inicia sesión para añadir productos a tu envío.', 'warning');
        openAuthModal('login');
        return;
    }
    if (!menuItems || menuItems.length === 0) {
        showGlobalFeedback("Error: El menú no está cargado. Intenta recargar la página.", "danger");
        return;
    }
    const product = menuItems.find(item => item.id === productId);
    if (!product) {
        showGlobalFeedback("Producto no encontrado.", "danger");
        return;
    }
    const existingItem = shoppingCart.find(item => item.productId === productId);
    if (existingItem) {
        existingItem.quantity = (existingItem.quantity || 0) + 1;
    } else {
        shoppingCart.push({
            productId: product.id, name: product.name,
            price:parseFloat(product.price)||0, quantity:1, points:parseInt(product.points)||0
        });
    }
    saveCartToStorage();
    updateCartDisplay();
    renderCartItems();
    showGlobalFeedback(`${product.name} añadido a tu envío!`, 'success', 2000);
}

function updateCartQuantity(productId, change) {
    const itemInCart = shoppingCart.find(item => item.productId === productId);
    if (itemInCart) {
        itemInCart.quantity += change;
        if (itemInCart.quantity <= 0) {
            shoppingCart = shoppingCart.filter(item => item.productId !== productId);
        }
    }
    saveCartToStorage();
    renderCartItems();
    updateCartDisplay();
}

function removeFromCart(productId) {
    shoppingCart = shoppingCart.filter(item => item.productId !== productId);
    saveCartToStorage();
    renderCartItems();
    updateCartDisplay();
    showGlobalFeedback("Producto eliminado del envío.", "info", 1500);
}

function clearCart() {
    if (shoppingCart.length === 0) {
        showFeedbackInModal(null, 'order-placement-feedback', 'El carrito de envío ya está vacío.', 'info', 2000);
        if (cartModalInstance && document.getElementById('cartModal').classList.contains('show')) {
        } else if (cartModalInstance) {
            cartModalInstance.show();
        }
        return;
    }

    if (confirmClearCartModalInstance) {
        confirmClearCartModalInstance.show();
    } else {
        if (confirm("¿Estás seguro de que quieres vaciar tu carrito de envío?")) {
            performClearCartActions();
        }
    }
}

function performClearCartActions() {
    shoppingCart = [];
    saveCartToStorage();
    renderCartItems();
    updateCartDisplay();
    showFeedbackInModal(null, 'order-placement-feedback', 'Carrito de envío vaciado.', 'info', 2000);
    if (cartModalInstance && document.getElementById('cartModal').classList.contains('show')) {
    } else {
        showGlobalFeedback('Carrito de envío vaciado.', 'info');
    }
    if (confirmClearCartModalInstance) {
         confirmClearCartModalInstance.hide();
    }
}

function updateCartDisplay() {
    let totalItems = Array.isArray(shoppingCart) ? shoppingCart.reduce((s, i) => s + (i.quantity || 0), 0) : 0;
    if (floatingCartButtonEl && floatingCartCountEl) {
        const isCurrentlyVisible = floatingCartButtonEl.style.display !== 'none' && !floatingCartButtonEl.classList.contains('animate__zoomOut');
        const shouldBeVisible = totalItems > 0 && clientData && clientData.id;
        if (shouldBeVisible && !isCurrentlyVisible) {
            floatingCartButtonEl.classList.remove('animate__zoomOut');
            floatingCartButtonEl.classList.add('animate__animated', 'animate__zoomIn');
            floatingCartButtonEl.style.display = 'flex';
        } else if (!shouldBeVisible && isCurrentlyVisible) {
            floatingCartButtonEl.classList.remove('animate__zoomIn');
            floatingCartButtonEl.classList.add('animate__animated', 'animate__zoomOut');
            setTimeout(() => {
                if ( !(totalItems > 0 && clientData && clientData.id) ) {
                   floatingCartButtonEl.style.display = 'none';
                }
            }, 500);
        }
        floatingCartCountEl.textContent = totalItems;
    }
    const pointsEl = document.getElementById('cart-points-to-earn');
    if(pointsEl) pointsEl.textContent = Array.isArray(shoppingCart) ? shoppingCart.reduce((s,i)=>s+((i.points||0)*(i.quantity||0)),0) : 0;
    adjustBodyPaddingAndFabPosition();
}

function handleQuantityChange(productId, change, button) {
    if (button) {
        button.style.transform = 'scale(0.9)';
        setTimeout(() => {
            button.style.transform = 'scale(1)';
        }, 150);
    }
    updateCartQuantity(productId, change);
}

function handleRemoveItem(productId, button) {
    if (button) {
        button.style.transform = 'scale(0.8) rotate(90deg)';
        setTimeout(() => {
            removeFromCart(productId);
        }, 300);
    } else {
        removeFromCart(productId);
    }
}

function handlePayment() {
    const paymentButton = document.querySelector('.payment-method');
    if (paymentButton) {
        paymentButton.style.transform = 'scale(0.95)';
        paymentButton.style.opacity = '0.8';
        
        setTimeout(() => {
            paymentButton.style.transform = 'scale(1)';
            paymentButton.style.opacity = '1';
            confirmAndPlaceOrder();
        }, 200);
    } else {
        confirmAndPlaceOrder();
    }
}

function applyMobileOptimizations() {
    const isMobile = window.innerWidth <= 768;
    if (isMobile) {
        const cartItems = document.querySelectorAll('.cart-item');
        cartItems.forEach(item => {
            const controls = item.querySelector('.cart-controls');
            const thumbnail = item.querySelector('.item-thumbnail-container');
            
            if (controls) {
                controls.style.display = 'flex';
                controls.style.visibility = 'visible';
                controls.style.opacity = '1';
            }
            
            if (thumbnail) {
                thumbnail.style.display = 'block';
                thumbnail.style.visibility = 'visible';
            }
        });
    }
}

function animateCartItems() {
    const items = document.querySelectorAll('.cart-item');
    items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.4s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateX(0)';
        }, index * 100);
    });
}

function showCartNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `cart-notification ${type}`;
    
    const icons = {
        success: 'bi-check-circle-fill',
        error: 'bi-exclamation-circle-fill',
        warning: 'bi-exclamation-triangle-fill',
        info: 'bi-info-circle-fill'
    };
    
    notification.innerHTML = `
        <div class="notification-content">
            <i class="bi ${icons[type] || icons.success}"></i>
            <span>${message}</span>
        </div>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 10000;
        transform: translateX(400px);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.1);
        max-width: 300px;
        color: white;
    `;
    
    const colors = {
        success: 'linear-gradient(135deg, #10b981, #059669)',
        error: 'linear-gradient(135deg, #ef4444, #dc2626)',
        warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
        info: 'linear-gradient(135deg, #3b82f6, #1d4ed8)'
    };
    notification.style.background = colors[type] || colors.success;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 3000);
}

function continueShopping() {
    const cartModal = bootstrap.Modal.getInstance(document.getElementById('cartModal'));
    if (cartModal) {
        cartModal.hide();
    }
    showCartNotification('Puedes seguir agregando productos', 'info');
}

function postWhatsAppNotification() {
    showGlobalFeedback("Serás redirigido a WhatsApp. Una vez enviado el mensaje, puedes cerrar esta ventana.", "info", 8000);
    setTimeout(() => {
        cartModalInstance?.hide();
    }, 5000);
}

async function forceLoadRewards() {
    if (!clientData || !clientData.id) {
        generateRewardsList();
        showGlobalFeedback("Inicia sesión para ver y actualizar recompensas.", "warning");
        return;
    }
    const res = await fetchDataFromGAS('getAvailableRewards', 'GET');
    if (res.success && Array.isArray(res.data)) {
        availableRewards = res.data.map(r => ({...r, rewardid: String(r.rewardid), pointsrequired:parseInt(r.pointsrequired)||0, stock:parseInt(r.stock) }));
        generateRewardsList();
        showGlobalFeedback("Recompensas actualizadas.", "success", 2000);
    } else {
        showGlobalFeedback("No se pudieron actualizar las recompensas.", "warning", 4000);
    }
}

function generateRewardsList() {
    const rc = document.getElementById('rewards-container');
    if (!rc) return;
    rc.innerHTML = '';
    if (!clientData || !clientData.id) {
        rc.innerHTML = `
            <div class="col-12 text-center p-md-5 p-4">
                <i class="bi bi-person-fill-lock display-1 text-muted opacity-50 mb-3"></i>
                <h4 class="text-light mb-2">Acceso VIP Requerido</h4>
                <p class="text-muted mb-3">Inicia sesión o regístrate para descubrir y canjear recompensas exclusivas para tus envíos.</p>
                <button class="btn btn-warning me-2" onclick="openAuthModal('login')">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesión
                </button>
                <button class="btn btn-outline-light" onclick="openAuthModal('register')">
                    <i class="bi bi-person-plus me-2"></i>Registrarme
                </button>
            </div>`;
        return;
    }
    if (!availableRewards || availableRewards.length === 0) {
        rc.innerHTML = `
            <div class="col-12 text-center p-md-5 p-4">
                <i class="bi bi-gift-fill display-1 text-muted opacity-50 mb-3"></i>
                <h4 class="text-light mb-2">Aún no hay recompensas disponibles</h4>
                <p class="text-muted mb-3">Sigue realizando envíos para acumular puntos y estate atento a nuevas recompensas. ¡Pronto podrías canjear grandes beneficios!</p>
                <button class="btn btn-primary" onclick="showTabAndScroll('menu-tab-link')">
                    <i class="bi bi-bag-heart-fill me-2"></i>Hacer un Envío y Ganar Puntos
                </button>
            </div>`;
        return;
    }
    const cp = clientData ? (parseInt(clientData.puntos) || 0) : 0;
    availableRewards.sort((a,b) => (a.pointsrequired||0)-(b.pointsrequired||0));
    availableRewards.forEach(reward => {
        const ca = cp >= reward.pointsrequired;
        const hs = isNaN(reward.stock) || reward.stock === 9999 || reward.stock > 0;
        const cr = ca && hs; 
        const rid = String(reward.rewardid);
        rc.innerHTML += `
        <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
            <div class="reward-card card w-100 ${!cr ? 'opacity-75' : ''}">
               <img src="${reward.imageurl || './img/placeholder-product.png'}"
                     class="reward-image card-img-top" alt="${reward.name||'Recompensa'}" loading="lazy"
                     style="cursor: pointer;" onclick="showRewardDetailModal('${rid}')">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title mb-1" style="cursor: pointer;" onclick="showRewardDetailModal('${rid}')">${reward.name||'N/A'}</h5>
                    <p class="card-text small flex-grow-1 mb-3">${(reward.description||'Beneficio para tus envíos.').substring(0,70)}${(reward.description || '').length > 70 ? '...' : ''}</p>
                    <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                        <span class="fw-bold fs-5" style="color: var(--accent-color);">${reward.pointsrequired} Pts</span>
                        ${!isNaN(reward.stock) && reward.stock !== 9999 ? `<span class="small text-muted">Disp: ${reward.stock}</span>` : (reward.stock === 0 ? `<span class="small text-danger fw-bold">Agotado</span>` : `<span class="small text-muted">Ilimitado</span>`)}
                    </div>
                    <button class="btn btn-warning w-100 mt-3" onclick="attemptRedeemReward('${rid}')" ${!cr?'disabled':''}>
                        <i class="bi bi-award-fill me-2"></i> ${cr ? 'Canjear para Envío' : (ca && !hs && reward.stock === 0 ? 'Agotado' : (ca && !hs ? 'Agotado' : 'Puntos Insuf.'))}
                    </button>
                </div>
            </div>
        </div>`;
    });
}

async function showRewardDetailModal(rewardId) {
    if (!availableRewards || availableRewards.length === 0) await forceLoadRewards();
    const reward = availableRewards.find(r => r.rewardid === rewardId);

    if (!reward) {
        showGlobalFeedback("Recompensa no encontrada.", "danger");
        return;
    }

   document.getElementById('modal-reward-image').src = reward.imageurl || './img/placeholder-product.png';
    document.getElementById('modal-reward-name').textContent = reward.name || 'Sin Nombre';
    document.getElementById('modal-reward-description').textContent = reward.description || 'Descripción no disponible.';
    document.getElementById('modal-reward-points-required').textContent = `${reward.pointsrequired || 0} Puntos`;

    const stockInfoEl = document.getElementById('modal-reward-stock-info');
    if (!isNaN(reward.stock) && reward.stock !== 9999) {
        stockInfoEl.textContent = `Disponibles: ${reward.stock}`;
        stockInfoEl.className = reward.stock > 0 ? 'badge bg-success' : 'badge bg-danger';
    } else if (reward.stock === 0) { 
         stockInfoEl.textContent = `Agotado`;
         stockInfoEl.className = 'badge bg-danger fw-bold';
    } else { 
        stockInfoEl.textContent = 'Ilimitado';
        stockInfoEl.className = 'badge bg-info';
    }


    const redeemBtnContainer = document.getElementById('modal-redeem-reward-button-container');
    const clientPoints = clientData ? (parseInt(clientData.puntos) || 0) : 0;
    const canAfford = clientPoints >= reward.pointsrequired;
    const hasStock = isNaN(reward.stock) || reward.stock === 9999 || reward.stock > 0;
    const canRedeem = canAfford && hasStock && clientData && clientData.id;

    if (canRedeem) {
        redeemBtnContainer.innerHTML = `<button class="btn btn-warning btn-lg w-100" onclick="redeemFromDetailModal('${reward.rewardid}')"><i class="bi bi-award-fill me-2"></i>Canjear por ${reward.pointsrequired} Pts</button>`;
    } else if (clientData && clientData.id) {
        let reason = "";
        if (!canAfford) reason = "Puntos insuficientes.";
        else if (!hasStock) reason = "Recompensa agotada.";
        redeemBtnContainer.innerHTML = `<button class="btn btn-secondary btn-lg w-100" disabled><i class="bi bi-x-octagon-fill me-2"></i>No canjeable (${reason})</button>`;
    } else {
         redeemBtnContainer.innerHTML = `<button class="btn btn-outline-light btn-lg w-100" onclick="if(rewardDetailModalInstance) rewardDetailModalInstance.hide(); openAuthModal('login');"><i class="bi bi-person-check-fill me-2"></i>Iniciar sesión para canjear</button>`;
    }

    generateProductRecommendationsForRewardModal();
    if(rewardDetailModalInstance) rewardDetailModalInstance.show();
}

function redeemFromDetailModal(rewardId) {
    if(rewardDetailModalInstance) rewardDetailModalInstance.hide();
    attemptRedeemReward(rewardId);
}

function generateProductRecommendationsForRewardModal() {
    const recommendationsContainer = document.getElementById('reward-modal-product-recs-row');
    if (!recommendationsContainer) return;
    recommendationsContainer.innerHTML = '';

    if (!menuItems || menuItems.length === 0) {
        recommendationsContainer.innerHTML = '<p class="text-muted small col-12">No hay productos para recomendar en este momento.</p>';
        return;
    }

    let candidates = [...menuItems].filter(item => item.active !== false);
    candidates.sort(() => 0.5 - Math.random());

    const finalRecommendations = candidates.slice(0, 3);

    if (finalRecommendations.length === 0) {
        recommendationsContainer.innerHTML = '<p class="text-muted small col-12">No hay productos para recomendar.</p>';
        return;
    }

    finalRecommendations.forEach(rec => {
    recommendationsContainer.innerHTML += `
    <div class="col-4">
        <div class="recommendation-card" onclick="if(rewardDetailModalInstance) rewardDetailModalInstance.hide(); showProductDetailModal('${rec.id}');">
            <img src="${rec.imageurl || './img/placeholder-product.png'}" alt="${rec.name}" loading="lazy">
            <div class="p-2">
                <div class="rec-title">${rec.name}</div>
                <small class="text-primary fw-bold d-block mt-1">USD ${rec.price.toFixed(2)}</small>
            </div>
        </div>
    </div>`;
});
}

function generateRewardWhatsAppMessage(rewardName, clientName) {
    let message = `¡Hola! 👋 Acabo de canjear una recompensa desde DL Cumanayagua.\n\n`;
    message += `*Cliente:* ${clientName}\n`;
    message += `*Recompensa Canjeada:* ${rewardName}\n\n`;
    message += `Por favor, tomar nota para mi próximo envío. ¡Gracias!`;
    return encodeURIComponent(message);
}

async function attemptRedeemReward(rewardId) {
    if (!clientData || !clientData.id) {
        showGlobalFeedback("Debes iniciar sesión para canjear.", "warning");
        openAuthModal('login');
        return;
    }
    const reward = availableRewards.find(r => r.rewardid === rewardId);
    if (!reward) {
        showGlobalFeedback("Recompensa no encontrada.", "danger");
        return;
    }

    const modalTextEl = document.getElementById('confirmRedeemRewardText');
    const modalFeedbackEl = document.getElementById('redeemRewardFeedback');
    const modalFooterEl = document.getElementById('confirmRedeemRewardFooter');

    if (modalTextEl) modalTextEl.innerHTML = `¿Estás seguro de que quieres canjear "<strong>${reward.name}</strong>" por <strong>${reward.pointsrequired} puntos</strong>?`;
    if (modalFeedbackEl) modalFeedbackEl.innerHTML = '';

    if (modalFooterEl) {
        modalFooterEl.innerHTML = `
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-warning" id="confirmRedeemRewardButtonDynamicInstance">
                <i class="bi bi-award-fill me-1"></i>Sí, Canjear Ahora
            </button>`;

        const confirmButtonDynamic = document.getElementById('confirmRedeemRewardButtonDynamicInstance');
        if (confirmButtonDynamic) {
            confirmButtonDynamic.onclick = async () => {
                if (modalFeedbackEl) modalFeedbackEl.innerHTML = `<div class="alert alert-info py-2 small"><div class="spinner-border spinner-border-sm me-2"></div>Procesando canje...</div>`;
                confirmButtonDynamic.disabled = true;

                const result = await fetchDataFromGAS('redeemReward', 'POST', { clientId: String(clientData.id), rewardId: rewardId });

                if (result.success && result.data) {
                    const pointsBefore = clientData.puntos;
                    clientData.puntos = (clientData.puntos || 0) - (reward.pointsrequired || 0);
                    if (clientData.puntos < 0) clientData.puntos = 0;

                    if (result.data.updatedClient) {
                        const serverPoints = result.data.updatedClient.puntos;
                        clientData = result.data.updatedClient;
                        clientData.puntos = Math.min(pointsBefore - (reward.pointsrequired || 0), serverPoints);
                    }

                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    updateClientDisplayAndUI();

                    const whatsappMessage = generateRewardWhatsAppMessage(reward.name, clientData.nombre);
                    const whatsappUrl = `https://wa.me/5355189657?text=${whatsappMessage}`;
                    if (modalFeedbackEl) {
                        modalFeedbackEl.innerHTML = `
                            <div class="alert alert-success py-2 small">
                                ${result.message || "¡Recompensa canjeada con éxito!"}
                                <hr class="my-2">
                                <a href="${whatsappUrl}" target="_blank" class="btn btn-sm btn-success w-100"
                                   onclick="if(confirmRedeemRewardModalInstance) confirmRedeemRewardModalInstance.hide(); if(rewardDetailModalInstance && rewardDetailModalInstance._isShown) rewardDetailModalInstance.hide();">
                                    <i class="bi bi-whatsapp me-2"></i>Notificar Canje por WhatsApp
                                </a>
                            </div>`;
                    }
                    if (modalFooterEl) {
                        modalFooterEl.innerHTML = `<button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="if(rewardDetailModalInstance && rewardDetailModalInstance._isShown) rewardDetailModalInstance.hide();">Cerrar</button>`;
                    }
                    forceLoadRewards();
                } else {
                    if (modalFeedbackEl) modalFeedbackEl.innerHTML = `<div class="alert alert-danger py-2 small">${result.message || "No se pudo canjear. Intenta de nuevo."}</div>`;
                    if(confirmButtonDynamic) confirmButtonDynamic.disabled = false;
                }
            };
        }
    }

    if (confirmRedeemRewardModalInstance) {
        confirmRedeemRewardModalInstance.show();
    }
}

function showFeedbackInModal(modalIdUnused, elId, msg, type='info', dur=4000) {
    const div = document.getElementById(elId);
    if (!div) return;
    div.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show small py-2" role="alert">${msg}<button type="button" class="btn-close btn-close-white btn-sm py-2" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
    if (dur !== null && type !== 'info' && !(String(msg).includes('spinner-border'))) {
         setTimeout(() => { if (div && div.innerHTML.includes(msg)) div.innerHTML = ''; }, dur);
    }
}

function showGlobalFeedback(msg, type = 'info', dur = 4000) {
    const toastPlacement = document.getElementById('toastPlacement');
    if (!toastPlacement) {
        alert(`${type.toUpperCase()}: ${msg}`);
        return;
    }
    const toastId = 'liveToast-' + Date.now();
    let tbc = 'bg-primary text-white', bcc = 'btn-close-white';
    if (type === 'danger') { tbc = 'bg-danger text-white'; }
    else if (type === 'success') { tbc = 'bg-success text-white'; }
    else if (type === 'warning') { tbc = 'bg-warning text-dark'; bcc = 'btn-close-dark';}
    const toastHTML = `
        <div class="toast align-items-center ${tbc} border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
            <div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close ${bcc} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
        </div>`;
    toastPlacement.insertAdjacentHTML('beforeend', toastHTML);
    const toastEl = document.getElementById(toastId);
    if (toastEl) {
        const toastInstance = new bootstrap.Toast(toastEl, {
            autohide: (dur !== null && !String(msg).includes('spinner-border')),
            delay: dur
        });
        toastInstance.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }
}

window.addEventListener('resize', function() {
    applyMobileOptimizations();
});

document.addEventListener('DOMContentLoaded', function() {
    if (typeof handleQuantityChange === 'undefined') {
        window.handleQuantityChange = handleQuantityChange;
    }
    if (typeof handleRemoveItem === 'undefined') {
        window.handleRemoveItem = handleRemoveItem;
    }
    if (typeof handlePayment === 'undefined') {
        window.handlePayment = handlePayment;
    }
});

function setupNavbarToggler() {
    const navLinks = document.querySelectorAll('#navbarNavContent .nav-link, #navbarNavContent .dropdown-item');
    const navbarToggler = document.querySelector('.navbar-toggler');
    const navbarCollapseEl = document.getElementById('navbarNavContent');
    let navbarCollapseInstance = null;

    if (navbarCollapseEl) {
        navbarCollapseInstance = bootstrap.Collapse.getOrCreateInstance(navbarCollapseEl, {toggle: false});
    }

    navLinks.forEach(link => {
        link.addEventListener('click', (event) => {
            const isTogglerVisible = getComputedStyle(navbarToggler).display !== 'none';
            const isMenuExpanded = navbarCollapseEl.classList.contains('show');

            if (isMenuExpanded && isTogglerVisible) {
                const opensModal = link.getAttribute('data-bs-toggle') === 'modal';
                const isDropdownToggle = link.classList.contains('dropdown-toggle');

                if (!opensModal && !isDropdownToggle) {
                    if (navbarCollapseInstance) {
                        navbarCollapseInstance.hide();
                    }
                }
            }
        });
    });
}

function showTabAndScroll(tabLinkId) {
    const tabLink = document.getElementById(tabLinkId);
    if (tabLink) {
        const tabInstance = bootstrap.Tab.getOrCreateInstance(tabLink);
        tabInstance.show();

        const tabPaneId = tabLink.getAttribute('href');
        if (tabPaneId) {
            const tabPane = document.querySelector(tabPaneId);
            if (tabPane) {
                setTimeout(() => {
                    tabPane.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 150);
            }
        }
    }
}

function handleScroll() {
    const quickNav = document.getElementById('quick-nav-buttons');
    const goDownBtn = document.getElementById('go-down-btn');
    if (!quickNav || !goDownBtn) return;

    const floatingButtonsContainer = document.querySelector('.floating-buttons-container');
    let fabContainerBottom = 25;
     if (floatingButtonsContainer) {
        const style = window.getComputedStyle(floatingButtonsContainer);
        fabContainerBottom = parseFloat(style.bottom) || fabContainerBottom;
    }

    if (window.scrollY > 300) {
        quickNav.style.display = 'flex';
    } else {
        quickNav.style.display = 'none';
    }

    let pageBottomOffset = 100;
    const footer = document.getElementById('bottom');
    if (footer) pageBottomOffset += footer.offsetHeight;

    const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - pageBottomOffset);
    goDownBtn.style.display = nearBottom ? 'none' : 'flex';
}

async function forceFullCacheRefresh() {
    if (confirm("Esto borrará TODOS los datos de navegación (incluyendo sesión iniciada, carrito, etc.) y recargará la página desde cero para obtener la versión más reciente. ¿Deseas continuar?")) {
        showGlobalFeedback("Limpiando datos y actualizando...", "info", null);
        try {
            localStorage.clear();
            sessionStorage.clear();
            if ('serviceWorker' in navigator && navigator.serviceWorker.getRegistrations) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                }
            }
            if (window.caches && window.caches.keys) {
                const keys = await window.caches.keys();
                await Promise.all(keys.map(key => window.caches.delete(key)));
            }
        } catch (error) {
            console.error("Error durante la limpieza de caché:", error);
            showGlobalFeedback("Error al limpiar algunos datos de caché.", "warning");
        }

        try {
            const baseUrl = window.location.origin + window.location.pathname;
            const timestamp = new Date().getTime();
            const newUrl = `${baseUrl}?t=${timestamp}`;
            window.location.href = newUrl;
            setTimeout(() => { window.location.reload(true); }, 1500);
        } catch (e) {
            setTimeout(() => { window.location.reload(true); }, 1500);
        }
    }
}

function adjustBodyPaddingAndFabPosition() {
    const bodyEl = document.body;
    const floatingButtonsContainer = document.querySelector('.floating-buttons-container');
    const quickNavButtons = document.getElementById('quick-nav-buttons');
    const navbarEl = document.querySelector('.navbar-custom.fixed-top');

    let totalPaddingBottom = 0;
    let fabContainerBottomOffset = 25;
    let quickNavBottomOffset = 260;

    if (window.matchMedia("(max-width: 768px)").matches) {
        fabContainerBottomOffset = 20;
        quickNavBottomOffset = 235;
    }
    if (window.matchMedia("(max-width: 576px)").matches) {
        fabContainerBottomOffset = 15;
        quickNavBottomOffset = 210;
    }
    
    bodyEl.style.paddingBottom = totalPaddingBottom + 'px';

    if (navbarEl) {
        const navbarHeight = navbarEl.offsetHeight;
        const mainEl = document.querySelector('main');
        if (mainEl && parseFloat(mainEl.style.paddingTop) !== navbarHeight) {
            mainEl.style.paddingTop = navbarHeight + 'px';
        }
    }

    if (floatingButtonsContainer) {
         floatingButtonsContainer.style.bottom = fabContainerBottomOffset + 'px';
    }
    if (quickNavButtons && quickNavButtons.style.display !== 'none') {
        quickNavButtons.style.bottom = quickNavBottomOffset + 'px';
    }
     handleScroll();
}

function loadClientDataFromStorage() {
    const storedClientData = localStorage.getItem(LOGGED_IN_CLIENT_KEY);
    if (storedClientData) {
        try {
            clientData = JSON.parse(storedClientData);
        } catch (e) {
            localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
            clientData = null;
        }
    } else {
        clientData = null;
    }
}

async function fetchDataFromGAS(action, method = 'POST', payloadData = null) {
    if (loadingSpinnerUser) loadingSpinnerUser.classList.add('show');
    try {
        let url = GOOGLE_SCRIPT_URL_USER;
        const options = { method: method, headers: {}, mode: 'cors', redirect: 'follow' };
        if (method === 'GET') {
            const params = new URLSearchParams({ action: action, cacheBuster: new Date().getTime() });
            if (payloadData) {
                for (const key in payloadData) {
                    if (payloadData.hasOwnProperty(key)) { params.append(key, payloadData[key]); }
                }
            }
            url += `?${params.toString()}`;
        } else {
            options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
            const dataToSend = { action: action, payload: payloadData };
            const formBody = new URLSearchParams();
            formBody.append("data", JSON.stringify(dataToSend));
            options.body = formBody.toString();
        }
        const res = await fetch(url, options);
        const responseText = await res.text();
        let responseData;
        try {
            responseData = JSON.parse(responseText);
        } catch (parseError) {
            throw new Error(`Respuesta no es JSON válido del servidor: ${responseText.substring(0,150)}`);
        }
        return responseData;
    } catch (error) {
        showGlobalFeedback(`Error de conexión o servidor: ${error.message || 'Desconocido'}. Intenta de nuevo.`, "danger", 7000);
        return { success: false, message: `Error de conexión o servidor: ${error.message || 'Desconocido'}.` };
    } finally {
        if (loadingSpinnerUser) loadingSpinnerUser.classList.remove('show');
    }
}
</script>
</body>
</html>
