<!DOCTYPE html>
<html lang="es" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta VIP - Doña Lucía</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <meta name="description" content="Con DL USD Cumanayagua, compra fácil y seguro productos, alimentos y regalos para tus seres queridos en Cumanayagua, Cuba. Paga cómodamente desde USA con Zelle.">
    <meta property="og:title" content="DL USD Cumanayagua: ¡Sorprende a tu Familia en Cuba!" />
    <meta property="og:description" content="Envía amor comprando productos en Cumanayagua. Compra online desde USA para tu familia en Cuba y paga con Zelle. ¡Fácil, rápido y con cariño!" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://erick890406.github.io/TheDo-aLuc-aGroup/portal-cliente-usd.html" /> 
    <meta property="og:site_name" content="DL USD Cumanayagua" />
    <meta property="og:image" content="https://i.postimg.cc/x8hj4gKx/Dl-Usd-2-cuamanayagua.png" />
    <meta property="og:image:secure_url" content="https://i.postimg.cc/x8hj4gKx/Dl-Usd-2-cuamanayagua.png" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="628" />
    <meta property="og:image:alt" content="Envía productos a Cuba - DL USD Cumanayagua" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Envía a Cuba con DL USD Cumanayagua" />
    <meta name="twitter:description" content="Compra para tu familia en Cumanayagua desde USA. Paga con Zelle. Alimentos, regalos y más. ¡Visítanos!" />
    <meta name="twitter:image" content="https://i.postimg.cc/jjNmrcyw/Meta-Etiqueta.png" />
    <meta name="twitter:image:alt" content="Promoción DL USD Cumanayagua para compras familiares en Cuba" />
    <style>
:root {
    --primary-color: #F1C40F;
    --accent-color: #E67E22;
    --bg-dark: #141E30;
    --bg-card: #21243D;
    --text-light: #FAFAFA;
    --text-muted: #B0B0B0;
    --radius-lg: 1.5rem;
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.25);
    --transition-fast: all 0.3s ease;
    --primary-color-rgb: 241,196,15; 
}

body {
    font-family: 'Montserrat', sans-serif;
    background: linear-gradient(135deg, var(--bg-dark) 0%, #243B55 100%);
    color: var(--text-light);
    margin: 0;
    padding: 0;
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: 0px; 
    display: flex;
    flex-direction: column;
}

main {
    flex-grow: 1;
}

.navbar-custom {
    background: #0f1c2d;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    box-shadow: var(--shadow-lg);
    z-index: 1030;
}

.navbar-brand {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-color) !important;
}

.navbar .nav-link,
.navbar-text {
    color: var(--text-light);
}

.btn-primary {
    background-color: var(--primary-color);
    border: none;
    color: #000;
    font-weight: 600;
    transition: var(--transition-fast);
}

.btn-primary:hover {
    background-color: #d4ac0d;
}

.btn-outline-secondary {
    border-color: var(--accent-color);
    color: var(--accent-color);
}

.btn-outline-secondary:hover {
    background-color: var(--accent-color);
    color: white;
}

.menu-item-card,
.reward-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: none;
    display: flex;
    flex-direction: column;
    height: 100%;
    transition: var(--transition-fast);
}

.menu-item-card:hover,
.reward-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.4);
}

.product-image,
.reward-image {
    width: 100%;
    aspect-ratio: 3 / 4;
    object-fit: cover;
    border-top-left-radius: var(--radius-lg);
    border-top-right-radius: var(--radius-lg);
    border-bottom: 3px solid var(--primary-color);
}

.card-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 1rem;
}

.card-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.card-text {
    color: var(--text-muted);
    font-size: 0.9rem;
    flex-grow: 1;
}

.reward-card .card-text {
    color: var(--text-light);
}

.price-points-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.badge {
    font-size: 0.8rem;
    padding: 0.4em 0.6em;
    border-radius: 0.75rem;
}

#user-avatar,
#changeAvatarButton,
#vip-card-container > .text-center.text-md-start > .position-relative.d-inline-block {
    display: none !important;
}

#filter-container .btn-filter {
    margin: 0.25rem;
    background: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    transition: var(--transition-fast);
}

#filter-container .btn-filter.active,
#filter-container .btn-filter:hover {
    background: var(--primary-color);
    color: #2C3E50;
}

.toast {
    border-radius: var(--radius-lg);
    font-weight: 500;
}

.toast-body {
    font-size: 0.9rem;
}

.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(20, 30, 48, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    transition: opacity 0.3s ease;
}
.loading-spinner.show {
    display: flex !important;
}


.luxury-spinner-inner {
    border: 5px solid rgba(255,255,255,0.1);
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

.luxury-spinner-text {
    margin-top: 1rem;
    color: var(--text-muted);
    font-weight: bold;
}

@keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
}

.modal-content {
    background-color: #1f2a3d;
    color: var(--text-light);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
}

.form-control {
    background-color: #2c3e50;
    border: 1px solid #3b4a5a;
    color: white;
}

.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(241, 196, 15, 0.25);
    background-color: #2c3e50;
    color: white;
}

.nav-pills {
    background-color: rgba(0,0,0,0.2);
    padding: 0.5rem;
    border-radius: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.nav-pills .nav-item {
    flex-grow: 1;
    flex-basis: 0;
    min-width: 100px;
}

.nav-pills .nav-link {
    background-color: #2c3e50;
    color: var(--text-light);
    border-radius: 0.75rem;
    transition: var(--transition-fast);
    padding: 0.6rem 0.5rem;
    font-size: 0.85rem;
    text-align: center;
    display: block;
    width: 100%;
}

.nav-pills .nav-link:hover {
    background-color: #3a506b;
}

.nav-pills .nav-link.active {
    background-color: var(--primary-color);
    color: #2C3E50;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(241,196,15,0.3);
}

.accordion-button {
    background-color: #1f2a3d;
    color: var(--text-light);
    border: none;
}
.accordion-button:not(.collapsed) {
    color: var(--primary-color);
    background-color: #1a2535;
    box-shadow: inset 0 -1px 0 rgba(255,255,255,.1);
}
.accordion-button:focus {
    z-index: 3;
    border-color: var(--primary-color);
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(241,196,15,.25);
}


.accordion-body {
    background-color: var(--bg-card);
    color: var(--text-light);
}

#vip-card-container {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 2px solid rgba(241, 196, 15, 0.6);
    box-shadow: 0 0 25px rgba(241, 196, 15, 0.2), 0 0 60px rgba(0,0,0,0.4);
    border-radius: var(--radius-lg);
    color: var(--text-light);
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease;
    padding: 2rem;
    backdrop-filter: blur(10px);
}

#vip-card-container:hover {
    transform: scale(1.02);
    box-shadow: 0 0 35px rgba(241, 196, 15, 0.4), 0 0 80px rgba(0,0,0,0.5);
}

#vip-card-container::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at center, rgba(241,196,15,0.08), transparent 70%);
    transform: rotate(25deg);
    z-index: 0;
}

#vip-card-container * {
    position: relative;
    z-index: 1;
}

#vip-status-badge {
    background: linear-gradient(45deg, #F1C40F, #E67E22);
    color: #2C3E50;
    font-size: 0.9rem;
    padding: 0.4em 0.8em;
    border-radius: 2rem;
    font-weight: 700;
    text-shadow: 0 0 3px rgba(0,0,0,0.5);
}

#user-avatar {
    border: 3px solid #F1C40F;
    box-shadow: 0 0 15px rgba(241, 196, 15, 0.5);
    transition: transform 0.3s ease;
    object-fit: cover;
}

#user-avatar:hover {
    transform: scale(1.05);
    cursor: pointer;
}

#client-name {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
    margin-top: 0.5rem;
}

#client-status {
    font-size: 1rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
}

.points-display {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--primary-color);
}

#client-phone-display {
    font-size: 0.9rem;
    color: var(--text-muted);
}

#changeAvatarButton {
    background: var(--primary-color);
    color: #2C3E50;
    box-shadow: 0 0 5px rgba(241,196,15,0.6);
    border: none;
}

#cartNavItem {
    display: none !important; 
}


#downloadAppBanner {
    border-top: 3px solid var(--primary-color);
    animation-duration: 0.6s;
    z-index: 1040;
}

.floating-buttons-container {
    position: fixed;
    bottom: 25px; 
    right: 25px;
    z-index: 1035;
    display: flex;
    gap: 0.75rem;
}

.floating-button {
    width: 65px; 
    height: 65px;
    border-radius: 50%;
    color: white; 
    font-size: 1.8rem; 
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
    border: 2px solid rgba(255, 255, 255, 0.15); 
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
    padding: 0; 
    cursor: pointer;
    text-decoration: none; 
}

.floating-button:hover {
    transform: scale(1.1) translateY(-3px);
}

#floatingCartButton {
    background: linear-gradient(145deg, var(--accent-color), var(--primary-color));
    color: var(--bg-dark);
    position: relative;
}
#floatingCartButton:hover {
     box-shadow: 0 10px 25px rgba(var(--primary-color-rgb), 0.5); 
}

#whatsappButton {
    background: linear-gradient(145deg, #25D366, #128C7E);
}
#whatsappButton:hover {
    box-shadow: 0 10px 25px rgba(37, 211, 102, 0.5); 
}

.floating-cart-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: var(--bg-dark);
    color: var(--primary-color);
    font-size: 0.8rem;
    font-weight: bold;
    padding: 0.3em 0.6em;
    border-radius: 50%;
    border: 1.5px solid var(--primary-color);
    min-width: 24px; 
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

#productDetailModal .modal-content {
    border: 1px solid rgba(255,255,255,0.1);
}

#modal-product-image {
    width: 100%;
    aspect-ratio: 4 / 5;
    object-fit: cover;
    border-radius: 1rem;
    border: 2px solid var(--primary-color);
}

#modal-product-name {
    font-family: 'Playfair Display', serif;
    color: var(--primary-color);
}

#modal-product-price {
    color: var(--primary-color);
    font-size: 1.75rem;
    font-weight: 700;
}

#modal-recommendations-container h5 {
    color: var(--text-light);
    border-bottom: 1px solid rgba(255,255,255,0.15);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.recommendation-card {
    background: var(--bg-card);
    border-radius: 1rem;
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition-fast);
    border: 1px solid transparent;
}

.recommendation-card:hover {
    transform: translateY(-4px);
    border-color: var(--accent-color);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.recommendation-card img {
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
}

.recommendation-card .rec-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-light);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.footer-custom {
    background-color: #0f1c2d;
    color: var(--text-muted);
    border-top: 3px solid var(--primary-color);
    margin-top: auto;
}

.footer-avatar {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid var(--accent-color);
}

.footer-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    color: var(--text-light);
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
}

.footer-custom h5 {
    color: var(--text-light);
}

.footer-link {
    color: var(--text-muted);
    text-decoration: none;
    transition: var(--transition-fast);
    display: inline-block;
    margin-bottom: 0.5rem;
}

.footer-link:hover {
    color: var(--primary-color);
    transform: translateX(5px);
}

.social-icons .social-icon-link {
    font-size: 1.5rem;
    color: var(--text-muted);
    transition: var(--transition-fast);
}

.social-icons .social-icon-link:hover {
    color: var(--primary-color);
    transform: translateY(-2px);
}

.footer-refresh-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    opacity: 0.6;
    transition: var(--transition-fast);
    padding: 0.2rem 0.5rem;
}
.footer-refresh-btn:hover {
    opacity: 1;
    color: var(--accent-color);
}

#quick-nav-buttons {
    position: fixed;
    bottom: 100px; 
    right: 30px;
    z-index: 1034;
    display: none;
    flex-direction: column;
    gap: 0.5rem;
}

.quick-nav-btn {
    width: 45px;
    height: 45px;
    background-color: rgba(33, 37, 61, 0.8);
    backdrop-filter: blur(5px);
    color: var(--primary-color);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    text-decoration: none;
    transition: all 0.3s ease;
}

.quick-nav-btn:hover {
    background-color: var(--bg-card);
    color: var(--accent-color);
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .navbar-brand { font-size: 1.25rem; }
    .card-text { font-size: 0.85rem; }
    .btn { font-size: 0.85rem; }
    .card-body { padding: 0.75rem; }
    #downloadAppBanner .container { flex-direction: column; text-align: center; }
    #downloadAppBanner .me-3.mb-2.mb-md-0 { margin-bottom: 0.75rem !important; }
    .floating-buttons-container { bottom: 20px; right: 20px; }
    .floating-button { width: 60px; height: 60px; font-size: 1.6rem; }
    .floating-cart-count { font-size: 0.75rem; min-width: 22px; height: 22px; top: -6px; right: -6px; }
    #quick-nav-buttons { bottom: 90px; right: 20px; }
    .quick-nav-btn { width: 40px; height: 40px; font-size: 1.2rem; }
}

@media (max-width: 576px) {
    .card-title { font-size: 0.95rem; }
    .price-points-row { flex-direction: column; gap: 0.25rem; align-items: flex-start; }
    .btn { font-size: 0.8rem; }
    #client-name { font-size: 1.5rem; }
    .points-display { font-size: 1.5rem; }
    .nav-pills .nav-link { font-size: 0.8rem; padding: 0.5rem; }
    .nav-pills .nav-item { min-width: 90px; }
    .floating-buttons-container { bottom: 15px; right: 15px; }
    .floating-button { width: 55px; height: 55px; font-size: 1.5rem; }
    .floating-cart-count { font-size: 0.7rem; min-width: 20px; height: 20px; top: -5px; right: -5px; }
    #quick-nav-buttons { bottom: 80px; right: 15px; }
    .quick-nav-btn { width: 38px; height: 38px; font-size: 1.1rem; }
}
</style>

</head>
<body id="top">
    <input type="file" id="avatarUploadInput" accept="image/jpeg, image/png, image/gif" style="display: none;">

       <nav class="navbar navbar-expand-sm navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#downloadAppModal" style="cursor:pointer;">
                <img src="https://i.postimg.cc/bwc5SzJG/striking-app-icon-the-letters-dl-in-a-custom-l-1.png" alt="Doña Lucía Logo" style="height: 30px; margin-right: 8px;">
                DL Cumanayagua
            </a>
            <div class="ms-auto d-flex align-items-center">
                <div id="auth-buttons-nav" class="d-flex align-items-center">
                </div>
                <button id="logoutButtonNav" class="btn btn-sm btn-outline-warning ms-2" style="display:none;" onclick="logoutClient()"><i class="bi bi-box-arrow-right"></i> Salir</button>
                <div class="nav-item ms-2" id="cartNavItem" style="display: none !important;">
                    <button class="btn cart-nav-button p-0" type="button" data-bs-toggle="modal" data-bs-target="#cartModal">
                        <i class="bi bi-cart-fill"></i>
                        <span class="badge rounded-pill cart-count-nav" id="cart-count-nav">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <main>
        <div class="container mt-5 pt-4 pb-5">
            <div id="vip-card-container" class="vip-card p-md-4 p-3 mb-4 position-relative animate__animated animate__fadeInDown" style="display: none;">
                <span class="position-absolute top-0 start-0 m-3 badge" id="vip-status-badge">VIP</span>
                <div class="text-center text-md-start">
                    <div class="position-relative d-inline-block">
                        <img id="user-avatar" src="https://via.placeholder.com/80/FFFFFF/2C3E50?Text=VIP" alt="User Avatar" class="rounded-circle mb-2 shadow-sm" width="80" height="80" style="cursor:pointer; display:none;" title="Haz clic para cambiar tu avatar">
                        <button id="changeAvatarButton" class="btn btn-sm position-absolute bottom-0 end-0 mb-2 me-0 rounded-circle p-1 lh-1" title="Cambiar avatar" style="display:none; transform: translate(25%, 25%);">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                    </div>
                    <h2 class="mb-1 mt-2 mt-md-0" id="client-name">¡Hola!</h2>
                </div>
                <div class="text-center text-md-start mt-2">
                    <p class="mb-1 opacity-75" id="client-status">Miembro DL</p>
                    <div class="points-display mb-2" id="client-points">0</div>
                    <small id="client-phone-display" class="text-light opacity-75"></small>
                </div>
            </div>
            
             <div id="guest-prompt" class="alert alert-info text-center shadow-sm animate__animated animate__fadeInUp" style="display: block;">
                <h4><i class="bi bi-gift-fill me-2"></i>¡Envía alegría a Cuba con DL Cumanayagua!</h4>
                <p class="lead mb-2">Compra para tus familiares y amigos en Cumanayagua desde cualquier parte del mundo. Paga fácilmente con Zelle.</p>
                <p>Inicia sesión o regístrate para gestionar tus envíos y acumular puntos para futuras compras.</p>
            </div>
    
            <ul class="nav nav-pills mb-4">
                <li class="nav-item" role="presentation"><a class="nav-link active" id="menu-tab-link" data-bs-toggle="pill" href="#menu-tab" role="tab" aria-controls="menu-tab" aria-selected="true"><i class="bi bi-card-list me-1"></i>Menú y Combos</a></li>
                <li class="nav-item" role="presentation"><a class="nav-link" id="rewards-tab-link" data-bs-toggle="pill" href="#rewards-tab" role="tab" aria-controls="rewards-tab" aria-selected="false"><i class="bi bi-gift me-1"></i>Recompensas</a></li>
                <li class="nav-item" role="presentation"><a class="nav-link" id="my-orders-tab-link" data-bs-toggle="pill" href="#my-orders-tab" role="tab" aria-controls="my-orders-tab" aria-selected="false"><i class="bi bi-receipt me-1"></i>Mis Envíos</a></li>
            </ul>
    
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="menu-tab" role="tabpanel" aria-labelledby="menu-tab-link">
                    <div class="d-flex justify-content-center align-items-center mb-4">
                        <h3 class="mb-0 me-3 text-center"><i class="bi bi-cup-straw me-2"></i>Menú y Combos para Enviar</h3>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshMenuButton" onclick="forceLoadMenuItems()" title="Actualizar menú">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div id="filter-container" class="d-flex flex-wrap justify-content-center align-items-center mb-3"></div>
                    <div class="row g-3 g-md-4" id="menu-container"><div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div></div>
                </div>
                <div class="tab-pane fade" id="rewards-tab" role="tabpanel" aria-labelledby="rewards-tab-link">
                    <div class="d-flex justify-content-center align-items-center mb-4">
                        <h3 class="mb-0 me-3 text-center"><i class="bi bi-stars me-2"></i>Recompensas para tus Envíos</h3>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshRewardsButton" onclick="forceLoadRewards()" title="Actualizar recompensas">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="row g-3 g-md-4" id="rewards-container"><div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div></div>
                </div>
                <div class="tab-pane fade" id="my-orders-tab" role="tabpanel" aria-labelledby="my-orders-tab-link">
                    <h3 class="mb-4 text-center"><i class="bi bi-clock-history me-2"></i>Historial de Envíos</h3>
                    <div id="orders-history-container"><div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tus envíos.</p></div></div>
                </div>
            </div>
        </div>
    </main>

    <div id="loadingSpinnerUser" class="loading-spinner">
      <div class="luxury-spinner">
        <div class="luxury-spinner-inner"></div>
        <span class="luxury-spinner-text">Cargando...</span>
      </div>
    </div>
    <div id="downloadAppBanner" class="fixed-bottom p-3 bg-dark text-light shadow-lg" style="z-index: 1040; display:none;">
        <div class="container d-flex justify-content-between align-items-center flex-wrap">
            <div class="me-3 mb-2 mb-md-0">
                <strong class="d-block fs-5"><i class="bi bi-star-fill me-1 text-warning"></i> ¡Nuestra App para tu familia en Cuba!</strong>
                <span class="small">Permite que gestionen sus pedidos y beneficios fácilmente.</span>
            </div>
            <div class="d-flex align-items-center">
                <a href="https://drive.google.com/file/d/1JN1qbrX2JB7P5apVzzhtBy5x2hBPxCWa/view?usp=drive_link" download="DonaLucia_Cumanayagua.apk" class="btn btn-warning btn-sm me-3 py-2">
                    <i class="bi bi-android2 me-1"></i> Descargar App
                </a>
                <button type="button" class="btn-close btn-close-white" aria-label="Cerrar banner"></button>
            </div>
        </div>
    </div>
    <div class="toast-container position-fixed bottom-0 start-0 p-3" id="toastPlacement" style="z-index: 2050"> </div>
    <div class="modal fade" id="registerUserModal" tabindex="-1" aria-labelledby="registerUserModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="registerUserModalLabel">Crear Cuenta para Envíos</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="newUserRegistrationForm"><div class="mb-3"><label for="newUserName" class="form-label">Nombre Completo (Tuyo) <span class="text-danger">*</span></label><input type="text" class="form-control" id="newUserName" required autocomplete="name"></div><div class="mb-3"><label for="newUserPhone" class="form-label">Teléfono (Tuyo, con código de país si es de USA) <span class="text-danger">*</span></label><input type="tel" class="form-control" id="newUserPhone" required placeholder="Ej: +1 XXX XXX XXXX" autocomplete="tel"></div><div class="mb-3"><label for="newUserEmail" class="form-label">Correo (Tuyo, Opcional)</label><input type="email" class="form-control" id="newUserEmail" autocomplete="email"></div><div class="mb-3"><label for="newUserPassword" class="form-label">Contraseña <span class="text-danger">*</span></label><input type="password" class="form-control" id="newUserPassword" required autocomplete="new-password"></div><div class="mb-3"><label for="newUserConfirmPassword" class="form-label">Confirmar Contraseña <span class="text-danger">*</span></label><input type="password" class="form-control" id="newUserConfirmPassword" required autocomplete="new-password"></div><div id="registration-feedback" class="mt-3"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="handleUserRegistrationAttempt()">Registrarme</button></div></div></div></div>
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="loginModalLabel">Iniciar Sesión para Envíos</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="loginForm"><div class="mb-3"><label for="loginPhone" class="form-label">Teléfono (Tuyo)</label><input type="tel" class="form-control" id="loginPhone" required autocomplete="username tel"></div><div class="mb-3"><label for="loginPassword" class="form-label">Contraseña</label><input type="password" class="form-control" id="loginPassword" required autocomplete="current-password"></div><div id="login-feedback" class="mt-3"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="handleLoginAttempt()">Acceder</button></div></div></div></div>
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="cartModalLabel"><i class="bi bi-cart3 me-2"></i>Mi Carrito de Envío</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="cart-items-container"><p class="text-center">Tu carrito está vacío.</p></div><div class="modal-footer justify-content-between flex-wrap"><div id="cart-footer-info"><small class="text-muted d-block">Puntos a ganar: <span id="cart-points-to-earn" class="fw-bold">0</span></small><strong class="fs-5">Total: <span id="cart-total-price" style="color: var(--primary-color);">0.00</span> USD</strong><br><small class="text-warning"><i class="bi bi-credit-card-2-front-fill"></i> Pagos por Zelle.</small></div><div class="d-flex mt-2 mt-sm-0" id="cart-footer-buttons"><button type="button" class="btn btn-outline-danger me-2" onclick="clearCart()"><i class="bi bi-trash3 me-1"></i>Vaciar</button><button type="button" class="btn btn-success" onclick="confirmAndPlaceOrder()"><i class="bi bi-check-circle me-1"></i>Confirmar Envío</button></div></div><div id="order-placement-feedback" class="m-3"></div></div></div></div>
    <div class="modal fade" id="downloadAppModal" tabindex="-1" aria-labelledby="downloadAppModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="downloadAppModalLabel"><i class="bi bi-phone-vibrate-fill me-2" style="color:var(--primary-color);"></i> ¡App para tu Familia en Cuba!</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body text-center"><img src="https://i.postimg.cc/XJxYzHZW/striking-app-icon-the-letters-dl-in-a-custom-l.png" alt="Doña Lucía App Icon" class="img-fluid rounded-circle mb-3 shadow" style="width: 100px; height: 100px; border: 3px solid var(--primary-color);"><p class="lead mb-2">Permite que tus seres queridos en Cumanayagua gestionen sus pedidos y beneficios directamente.</p><p>Con la app, podrán ver el menú, canjear puntos y estar al tanto de las novedades. ¡Una forma fácil de conectar!</p><a href="https://drive.google.com/file/d/1JN1qbrX2JB7P5apVzzhtBy5x2hBPxCWa/view?usp=drive_link" download="DonaLucia_Cumanayagua.apk" class="btn btn-primary btn-lg mt-3 w-100 animate__animated animate__pulse animate__infinite animate__slower"><i class="bi bi-android2 me-2"></i> Descargar para Android</a><p class="mt-3 mb-1"><small class="text-muted">Si su dispositivo lo solicita, deben habilitar "Instalar apps desconocidas" en Ajustes para poder instalarla.</small></p></div><div class="modal-footer justify-content-center border-0 pt-0"><div class="form-check"><input class="form-check-input" type="checkbox" value="" id="dontShowDownloadModalAgain"><label class="form-check-label small" for="dontShowDownloadModalAgain">No volver a mostrar este mensaje (al inicio)</label></div></div></div></div>
    </div>
    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title" id="productDetailModalLabel">Detalles del Producto</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body pt-0"><div class="row g-4"><div class="col-md-6"><img src="https://via.placeholder.com/500x600" id="modal-product-image" class="img-fluid" alt="Imagen del producto"></div><div class="col-md-6 d-flex flex-column"><h2 id="modal-product-name" class="mb-2">Nombre del Producto</h2><p id="modal-product-description" class="text-muted flex-grow-1">Descripción detallada del producto...</p><div class="d-flex justify-content-between align-items-center mb-3"><span id="modal-product-price">USD 0.00</span><span class="badge bg-success" id="modal-product-points">+0 Puntos</span></div><div id="modal-add-to-cart-button-container" class="mb-4"></div><div id="modal-recommendations-container"></div></div></div></div></div></div>
    </div>

    <div class="floating-buttons-container">
        <a id="whatsappButton" href="https://wa.me/5355189657?text=Hola,%20tengo%20una%20consulta%20sobre%20DL%20Cumanayagua." class="floating-button" target="_blank" title="Chatea con nosotros">
            <i class="bi bi-whatsapp"></i>
        </a>
        <button id="floatingCartButton" class="floating-button" type="button" data-bs-toggle="modal" data-bs-target="#cartModal" style="display: none;" title="Ver Carrito de Envío">
            <i class="bi bi-cart3"></i>
            <span class="floating-cart-count" id="floating-cart-count">0</span>
        </button>
    </div>
    
    <div id="quick-nav-buttons">
        <a href="#top" class="quick-nav-btn" title="Ir arriba"><i class="bi bi-arrow-up"></i></a>
        <a href="#bottom" id="go-down-btn" class="quick-nav-btn" title="Ir abajo"><i class="bi bi-arrow-down"></i></a>
    </div>

    <footer id="bottom" class="footer-custom pt-5 pb-4">
        <div class="container text-center text-md-start">
            <div class="row gy-4">
                <div class="col-lg-4 col-md-12 mb-4 mb-md-0">
                    <div class="d-flex align-items-center justify-content-center justify-content-md-start mb-3">
                         <img src="https://i.postimg.cc/rsFSGFt2/Generated-Image-June-11-2025-1-22-AM.jpg" alt="Erick Olivera" class="footer-avatar me-3">
                         
                         <div>
                            <h5 class="text-uppercase fw-bold mb-1" style="color: var(--primary-color);">DL Cumanayagua</h5>
                            <p class="footer-name mb-0">Erick Olivera</p>
                         </div>
                    </div>
                    <p class="small text-muted">
                        Tu conexión directa para enviar productos y cariño a tus seres queridos en Cumanayagua. Fácil, rápido y seguro.
                    </p>
                </div>
                <div class="col-lg-2 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Navegación</h5>
                    <ul class="list-unstyled">
                        <li><a href="#menu-tab" class="footer-link">Menú</a></li>
                        <li><a href="#rewards-tab" class="footer-link">Recompensas</a></li>
                        <li><a href="#my-orders-tab" class="footer-link">Mis Envíos</a></li>
                        <li><a href="#" data-bs-toggle="modal" data-bs-target="#downloadAppModal" class="footer-link">App para Cuba</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Contacto</h5>
                     <p><i class="bi bi-telephone-fill me-2"></i>+53 55189657</p>
                     <p><i class="bi bi-geo-alt-fill me-2"></i>Cumanayagua, Cuba</p>
                </div>
                <div class="col-lg-3 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Síguenos</h5>
                    <div class="social-icons">
                        <a href="https://wa.me/5355189657?text=Hola,%20tengo%20una%20consulta%20sobre%20DL%20Cumanayagua." class="social-icon-link me-3 fs-4" title="WhatsApp"><i class="bi bi-whatsapp"></i></a>
                        <a href="#!" class="social-icon-link me-3 fs-4" title="Facebook"><i class="bi bi-facebook"></i></a>
                        <a href="#!" class="social-icon-link fs-4" title="Instagram"><i class="bi bi-instagram"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4" style="border-color: rgba(255,255,255,0.1);">
            <div class="d-flex justify-content-center align-items-center">
                <span class="small text-muted">© 2024 DL Cumanayagua. Todos los derechos reservados.</span>
                <button class="footer-refresh-btn ms-3" onclick="forceFullCacheRefresh()" title="Actualizar datos de la página">
                    <i class="bi bi-cloud-arrow-down-fill"></i>
                </button>
            </div>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const GOOGLE_SCRIPT_URL_USER = 'https://script.google.com/macros/s/AKfycby2a0TdrlDqtZI_NucSP9q2xcHV9fKYWe1OMpvlMx3vfS8b_2s2fS7zNMBsVHaHFC-JVw/exec';
        const LOGGED_IN_CLIENT_KEY = 'cafeteriaVipClientLoggedIn_v8';
        const PRODUCTS_USER_CACHE_KEY = 'cafeteriaUserProductsCache_v8';
        const USER_CART_KEY = 'cafeteriaUserCart_v5';
        const REWARDS_USER_CACHE_KEY = 'cafeteriaUserRewardsCache_v3';
        const REWARDS_CACHE_EXPIRY_KEY = 'cafeteriaRewardsCacheExpiry_v1';
        const MENU_CACHE_EXPIRY_KEY = 'cafeteriaMenuCacheExpiry_v1';
        const CACHE_DURATION_MS = 60 * 60 * 1000;
        const MAX_AVATAR_DIMENSION = 200;
        const AVATAR_JPEG_QUALITY = 0.75;
        const LOCAL_AVATAR_DATA_KEY = 'localAvatarDataUrl_v1';
        const DOWNLOAD_MODAL_DISMISSED_KEY = 'downloadModalDismissed_DL_v2';
        const DOWNLOAD_BANNER_DISMISSED_KEY = 'downloadBannerDismissed_DL_v1';
        let clientData = null;
        let menuItems = [];
        let availableRewards = [];
        let shoppingCart = [];
        let currentFilterCategory = 'all';
        const loadingSpinnerUser = document.getElementById('loadingSpinnerUser');
        let registrationModalInstance, loginModalInstance, cartModalInstance, downloadAppModalInstance, productDetailModalInstance;
        let floatingCartButtonEl;
        let floatingCartCountEl;

        document.addEventListener('DOMContentLoaded', async function() {
            floatingCartButtonEl = document.getElementById('floatingCartButton');
            floatingCartCountEl = document.getElementById('floating-cart-count');
            initializeModals();
            loadCartFromStorage();
            loadClientDataFromStorage();
            updateClientDisplayAndUI();
            await loadMenuItems();
            setupEventListeners();
            handleAppDownloadPromotion();
            handleScroll();
        });

        function handleScroll() {
            const quickNav = document.getElementById('quick-nav-buttons');
            const goDownBtn = document.getElementById('go-down-btn');
            if (!quickNav || !goDownBtn) return;
            if (window.scrollY > 300) {
                quickNav.style.display = 'flex';
            } else {
                quickNav.style.display = 'none';
            }
            const nearBottom = (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 150;
            goDownBtn.style.display = nearBottom ? 'none' : 'flex';
        }
        
        async function forceFullCacheRefresh() {
            if (confirm("Esto borrará TODOS los datos de navegación (incluyendo sesión iniciada, carrito, etc.) y recargará la página desde cero para obtener la versión más reciente. ¿Deseas continuar?")) {
                showGlobalFeedback("Limpiando datos y actualizando...", "info", null);

                try {
                    console.log("Limpiando localStorage...");
                    localStorage.clear();
                    console.log("localStorage limpiado.");
                    
                    console.log("Limpiando sessionStorage...");
                    sessionStorage.clear();
                    console.log("sessionStorage limpiado.");
                    
                    if ('serviceWorker' in navigator) {
                        console.log("Intentando desregistrar Service Workers...");
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (let registration of registrations) {
                            await registration.unregister();
                            console.log('Service Worker desregistrado:', registration);
                        }
                    }

                    if (window.caches) {
                        console.log("Intentando limpiar caché de la API de Cache...");
                        const keys = await window.caches.keys();
                        await Promise.all(keys.map(key => window.caches.delete(key)));
                        console.log("Cachés de la API eliminados.");
                    }

                } catch (error) {
                    console.error("Error durante la limpieza de caché:", error);
                    showGlobalFeedback("Error al limpiar algunos datos.", "warning");
                }
                
                setTimeout(() => {
                    location.reload(true);
                }, 1500);
            }
        }

        function initializeModals() {
            try {
                ['registerUserModal', 'loginModal', 'cartModal', 'downloadAppModal', 'productDetailModal'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id === 'registerUserModal') registrationModalInstance = new bootstrap.Modal(el);
                        else if (id === 'loginModal') loginModalInstance = new bootstrap.Modal(el);
                        else if (id === 'cartModal') cartModalInstance = new bootstrap.Modal(el);
                        else if (id === 'downloadAppModal') downloadAppModalInstance = new bootstrap.Modal(el);
                        else if (id === 'productDetailModal') productDetailModalInstance = new bootstrap.Modal(el);
                    } else { console.warn(`Modal con ID '${id}' no encontrado.`); }
                });
            } catch (error) { console.error("Error inicializando modales:", error); }
        }
        
        function setupEventListeners() {
            document.getElementById('registerUserModal')?.addEventListener('hidden.bs.modal', () => clearFormAndFeedback('newUserRegistrationForm', 'registration-feedback'));
            document.getElementById('loginModal')?.addEventListener('hidden.bs.modal', () => clearFormAndFeedback('loginForm', 'login-feedback'));
            document.getElementById('cartModal')?.addEventListener('show.bs.modal', renderCartItems);
            const avatarUploadInputEl = document.getElementById('avatarUploadInput');
            const userAvatarImgEl = document.getElementById('user-avatar');
            const changeAvatarBtnEl = document.getElementById('changeAvatarButton');
            const triggerAvatarUpload = () => {
                if (clientData && clientData.id && avatarUploadInputEl) {
                    avatarUploadInputEl.click();
                } else if (!clientData || !clientData.id) {
                    showGlobalFeedback("Inicia sesión para cambiar tu avatar.", "warning");
                    loginModalInstance?.show();
                }
            };
            if (userAvatarImgEl) userAvatarImgEl.addEventListener('click', triggerAvatarUpload);
            if (changeAvatarBtnEl) changeAvatarBtnEl.addEventListener('click', triggerAvatarUpload);
            if (avatarUploadInputEl) avatarUploadInputEl.addEventListener('change', handleAvatarFileSelect);
            const rewardsTabEl = document.getElementById('rewards-tab-link');
            if (rewardsTabEl) {
                rewardsTabEl.addEventListener('shown.bs.tab', event => {
                    if (!clientData || !clientData.id) {
                        document.getElementById('rewards-container').innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver y canjear recompensas para tus envíos.</p></div>';
                        return;
                    }
                    loadAvailableRewards();
                });
            }
            const ordersTabEl = document.getElementById('my-orders-tab-link');
            if (ordersTabEl) {
                ordersTabEl.addEventListener('shown.bs.tab', event => {
                    loadUserOrders();
                });
            }
            window.addEventListener('resize', adjustBodyPaddingAndFabPosition);
            window.addEventListener('scroll', handleScroll);
        }

        function adjustBodyPaddingAndFabPosition() {
            const bodyEl = document.body;
            const bannerEl = document.getElementById('downloadAppBanner');
            let totalPaddingBottom = 0;
            let fabBottomPosition = 25;
            if (window.matchMedia("(max-width: 768px)").matches) {
                fabBottomPosition = 20;
            }
            if (window.matchMedia("(max-width: 576px)").matches) {
                fabBottomPosition = 15;
            }
            if (bannerEl && bannerEl.style.display !== 'none' && !bannerEl.classList.contains('animate__fadeOutDown')) {
                totalPaddingBottom = bannerEl.offsetHeight + 20;
                fabBottomPosition = bannerEl.offsetHeight + (window.matchMedia("(max-width: 576px)").matches ? 15 : window.matchMedia("(max-width: 768px)").matches ? 20 : 25) ; 
            }
            bodyEl.style.paddingBottom = totalPaddingBottom + 'px';
            const floatingButtonsContainer = document.querySelector('.floating-buttons-container');
            if (floatingButtonsContainer) {
                 floatingButtonsContainer.style.bottom = fabBottomPosition + 'px';
            }
        }

        function handleAppDownloadPromotion() {
            const dontShowCheckbox = document.getElementById('dontShowDownloadModalAgain');
            const downloadModalEl = document.getElementById('downloadAppModal');
            const bannerEl = document.getElementById('downloadAppBanner');
            if (!localStorage.getItem(DOWNLOAD_MODAL_DISMISSED_KEY) && downloadAppModalInstance) {
                setTimeout(() => {
                    if (!localStorage.getItem(DOWNLOAD_MODAL_DISMISSED_KEY)) {
                        downloadAppModalInstance.show();
                    }
                }, 1500);
            }
            if (downloadModalEl && dontShowCheckbox) {
                downloadModalEl.addEventListener('hidden.bs.modal', function () {
                    if (dontShowCheckbox.checked) {
                        localStorage.setItem(DOWNLOAD_MODAL_DISMISSED_KEY, 'true');
                    }
                });
            }
            const bannerDismissed = localStorage.getItem(DOWNLOAD_BANNER_DISMISSED_KEY);
            if (bannerEl && !bannerDismissed) {
                let bannerDelay = 2500;
                if (!localStorage.getItem(DOWNLOAD_MODAL_DISMISSED_KEY)) {
                    bannerDelay = 8000;
                }
                setTimeout(() => {
                    if (!localStorage.getItem(DOWNLOAD_BANNER_DISMISSED_KEY)) {
                        bannerEl.style.display = 'block';
                        bannerEl.classList.remove('animate__fadeOutDown');
                        bannerEl.classList.add('animate__animated', 'animate__fadeInUp');
                        adjustBodyPaddingAndFabPosition();
                    }
                }, bannerDelay);
                const closeBannerButton = bannerEl.querySelector('.btn-close');
                if (closeBannerButton) {
                    closeBannerButton.addEventListener('click', () => {
                        bannerEl.classList.remove('animate__fadeInUp');
                        bannerEl.classList.add('animate__animated', 'animate__fadeOutDown');
                        setTimeout(() => {
                            bannerEl.style.display = 'none';
                            localStorage.setItem(DOWNLOAD_BANNER_DISMISSED_KEY, 'true');
                            adjustBodyPaddingAndFabPosition();
                        }, 500); 
                    });
                }
            } else if (bannerEl && bannerDismissed) {
                 bannerEl.style.display = 'none';
            }
            adjustBodyPaddingAndFabPosition();
        }

        function clearFormAndFeedback(formId, feedbackId) {
            if (formId) {
                const form = document.getElementById(formId);
                if (form) form.reset();
            }
            if (feedbackId) {
                const feedbackEl = document.getElementById(feedbackId);
                if (feedbackEl) feedbackEl.innerHTML = '';
            }
        }

        async function fetchDataFromGAS(action, method = 'POST', payloadData = null) {
            if (loadingSpinnerUser) loadingSpinnerUser.classList.add('show');
            try {
                let url = GOOGLE_SCRIPT_URL_USER;
                const options = { method: method, headers: {}, mode: 'cors', redirect: 'follow' };
                if (method === 'GET') {
                    const params = new URLSearchParams({ action: action, cacheBuster: new Date().getTime() });
                    if (payloadData) {
                        for (const key in payloadData) {
                            if (payloadData.hasOwnProperty(key)) { params.append(key, payloadData[key]); }
                        }
                    }
                    url += `?${params.toString()}`;
                } else {
                    options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
                    const dataToSend = { action: action, payload: payloadData };
                    const formBody = new URLSearchParams();
                    formBody.append("data", JSON.stringify(dataToSend));
                    options.body = formBody.toString();
                }
                const res = await fetch(url, options);
                const responseText = await res.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Respuesta no es JSON válido del servidor: ${responseText.substring(0,150)}`);
                }
                return responseData;
            } catch (error) {
                showGlobalFeedback(`Error de conexión o servidor: ${error.message || 'Desconocido'}. Intenta de nuevo.`, "danger", 7000);
                return { success: false, message: `Error de conexión o servidor: ${error.message || 'Desconocido'}.` };
            } finally {
                if (loadingSpinnerUser) loadingSpinnerUser.classList.remove('show');
            }
        }

        function loadClientDataFromStorage() {
            const storedClientData = localStorage.getItem(LOGGED_IN_CLIENT_KEY);
            if (storedClientData) {
                try {
                    clientData = JSON.parse(storedClientData);
                } catch (e) {
                    localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
                    clientData = null;
                }
            } else {
                clientData = null;
            }
        }

        function updateClientDisplayAndUI() {
            const el = id => document.getElementById(id);
            const authNavContainer = el('auth-buttons-nav');
            const logoutNavButton = el('logoutButtonNav');
            const vipCardContainer = el('vip-card-container');
            const guestPromptContainer = el('guest-prompt');
            const userAvatarImg = el('user-avatar');
            const myOrdersTabLink = el('my-orders-tab-link');
            if (clientData && clientData.id && (clientData.verificado === true || String(clientData.verificado).toLowerCase() === 'true')) {
                el('client-name').textContent = `¡Hola, ${clientData.nombre ? clientData.nombre.split(' ')[0] : 'Cliente'}!`;
                el('client-points').textContent = clientData.puntos !== undefined ? clientData.puntos : 0;
                el('client-status').textContent = `Nivel: ${(clientData.puntos||0)>=150?"Oro":(clientData.puntos||0)>=75?"Plata":"Bronce"}`;
                el('client-phone-display').textContent = clientData.telefono ? `Tel: ${clientData.telefono}` : '';
                el('vip-status-badge').style.display = 'inline-block';
                if (userAvatarImg) {
                    if (clientData[LOCAL_AVATAR_DATA_KEY] && typeof clientData[LOCAL_AVATAR_DATA_KEY] === 'string') {
                        userAvatarImg.src = clientData[LOCAL_AVATAR_DATA_KEY];
                    } else if (clientData.avatarurl && typeof clientData.avatarurl === 'string' && clientData.avatarurl.trim() !== '') {
                         userAvatarImg.src = clientData.avatarurl + (clientData.avatarurl.includes('?') ? '&t=' : '?t=') + new Date().getTime();
                    } else {
                        userAvatarImg.src = 'https://via.placeholder.com/80/FFFFFF/2C3E50?Text=VIP';
                    }
                }
                if(authNavContainer) authNavContainer.innerHTML = `<span class="navbar-text text-light me-2 small">Hola, ${clientData.nombre ? clientData.nombre.split(' ')[0] : 'VIP'}</span>`;
                if(logoutNavButton) logoutNavButton.style.display = 'inline-block';
                if(vipCardContainer) vipCardContainer.style.display = 'block';
                if(guestPromptContainer) guestPromptContainer.style.display = 'none';
                if(myOrdersTabLink) myOrdersTabLink.innerHTML = `<i class="bi bi-receipt me-1"></i>Mis Envíos`;
            } else {
                el('client-name').textContent = `¡Bienvenido!`;
                el('client-points').textContent = 0;
                el('client-status').textContent = "Inicia sesión o regístrate para enviar.";
                el('client-phone-display').textContent = '';
                el('vip-status-badge').style.display = 'none';
                if (userAvatarImg) userAvatarImg.src = 'https://via.placeholder.com/80/FFFFFF/2C3E50?Text=VIP';
                if(authNavContainer) authNavContainer.innerHTML = `<button class="btn btn-sm btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="bi bi-box-arrow-in-right"></i> Login</button><button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#registerUserModal"><i class="bi bi-person-plus"></i> Registro</button>`;
                if(logoutNavButton) logoutNavButton.style.display = 'none';
                if(vipCardContainer) vipCardContainer.style.display = 'none';
                if(guestPromptContainer) guestPromptContainer.style.display = 'block';
                if(myOrdersTabLink) myOrdersTabLink.innerHTML = `<i class="bi bi-receipt me-1"></i>Mis Envíos`;
                const ordersHistoryContainer = el('orders-history-container');
                if (ordersHistoryContainer) ordersHistoryContainer.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tus envíos.</p></div>';
                const rewardsContainer = el('rewards-container');
                if (rewardsContainer) rewardsContainer.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver y canjear recompensas para tus envíos.</p></div>';
            }
            updateCartDisplay();
        }

        function logoutClient() {
            clientData = null;
            localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
            shoppingCart = [];
            availableRewards = [];
            localStorage.removeItem(USER_CART_KEY);
            localStorage.removeItem(REWARDS_USER_CACHE_KEY);
            localStorage.removeItem(REWARDS_CACHE_EXPIRY_KEY);
            updateClientDisplayAndUI();
            showGlobalFeedback('Sesión cerrada. ¡Vuelve pronto!', 'info');
            handleAppDownloadPromotion();
            const activeTab = document.querySelector('.nav-pills .nav-link.active');
            if (activeTab) {
                const activeTabHref = activeTab.getAttribute('href');
                if (activeTabHref === '#my-orders-tab') {
                     const ordersContainer = document.getElementById('orders-history-container');
                     if(ordersContainer) ordersContainer.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tus envíos.</p></div>';
                } else if (activeTabHref === '#rewards-tab') {
                     const rewardsContainer = document.getElementById('rewards-container');
                     if(rewardsContainer) rewardsContainer.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver y canjear recompensas para tus envíos.</p></div>';
                }
            }
        }

        async function handleUserRegistrationAttempt() {
            const nombre = document.getElementById('newUserName').value.trim();
            const telefono = document.getElementById('newUserPhone').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('newUserConfirmPassword').value;
            const feedbackElId = 'registration-feedback';
            if (!nombre || !telefono || !password || !confirmPassword) {
                showFeedbackInModal(null, feedbackElId, 'Todos los campos marcados con * son requeridos.', 'danger'); return;
            }
            if (password !== confirmPassword) {
                showFeedbackInModal(null, feedbackElId, 'Las contraseñas no coinciden.', 'danger'); return;
            }
            if (!/^\+?\d{7,15}$/.test(telefono)) {
                showFeedbackInModal(null, feedbackElId, 'Por favor, ingresa un número de teléfono válido (7-15 dígitos, puede incluir + al inicio).', 'danger'); return;
            }
             if (password.length < 6) {
                showFeedbackInModal(null, feedbackElId, 'La contraseña debe tener al menos 6 caracteres.', 'danger'); return;
            }
            showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Registrando...', 'info', null);
            const payload = { nombre, telefono, email, password };
            const result = await fetchDataFromGAS('registerNewUser', 'POST', payload);
            if (result.success) {
                showFeedbackInModal(null, feedbackElId, `${result.message || '¡Registro exitoso!'} Ahora puedes iniciar sesión para realizar tus envíos.`, 'success', 4000);
                document.getElementById('newUserRegistrationForm').reset();
                setTimeout(() => {
                    registrationModalInstance?.hide();
                    loginModalInstance?.show();
                }, 3000);
            } else {
                showFeedbackInModal(null, feedbackElId, result.message || 'Error al registrar. Intenta de nuevo.', 'danger');
            }
        }

        async function handleLoginAttempt() {
            const telefono = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;
            const feedbackElId = 'login-feedback';
            if (!telefono || !password) {
                showFeedbackInModal(null, feedbackElId, 'Teléfono y contraseña son requeridos.', 'danger'); return;
            }
            showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Iniciando sesión...', 'info', null);
            const payload = { telefono, password };
            const result = await fetchDataFromGAS('loginUser', 'POST', payload);
            if (result.success && result.data) {
                clientData = result.data;
                localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                updateClientDisplayAndUI();
                showFeedbackInModal(null, feedbackElId, `¡Bienvenido de nuevo, ${clientData.nombre.split(' ')[0]}! Listo para enviar.`, 'success', 3000);
                setTimeout(() => loginModalInstance?.hide(), 2000);
                loadMenuItems(true); 
                loadAvailableRewards(true);
                loadUserOrders();
            } else {
                showFeedbackInModal(null, feedbackElId, result.message || 'Error al iniciar sesión. Verifica tus datos.', 'danger');
            }
        }

        async function handleAvatarFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                showGlobalFeedback('Por favor, selecciona un archivo de imagen (JPEG, PNG, GIF).', 'warning');
                event.target.value = null; return;
            }
            const maxSizeInBytes = 2 * 1024 * 1024; 
            if (file.size > maxSizeInBytes) {
                showGlobalFeedback('La imagen es demasiado grande (máx 2MB antes de comprimir).', 'warning');
                event.target.value = null; return;
            }
            showGlobalFeedback('Procesando imagen...', 'info', null);
            try {
                const compressedDataUrl = await compressImage(file, file.type);
                if (clientData && clientData.id) {
                    clientData[LOCAL_AVATAR_DATA_KEY] = compressedDataUrl;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    const userAvatarImg = document.getElementById('user-avatar');
                    if(userAvatarImg) userAvatarImg.src = compressedDataUrl;
                    showGlobalFeedback('Avatar actualizado localmente. Subiendo al servidor...', 'info', 3000);
                } else {
                    showGlobalFeedback('Error: No hay sesión de usuario activa para guardar el avatar local.', 'danger');
                    event.target.value = null; return;
                }
                const parts = compressedDataUrl.split(';base64,');
                const contentType = parts[0].split(':')[1];
                const imageData = parts[1];
                await uploadClientAvatar(imageData, contentType, file.name);
            } catch (error) {
                showGlobalFeedback(`Error al procesar la imagen: ${error.message}`, 'danger');
            } finally {
                event.target.value = null;
            }
        }

        function compressImage(file, originalMimeType) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_AVATAR_DIMENSION) {
                                height = Math.round(height * MAX_AVATAR_DIMENSION / width);
                                width = MAX_AVATAR_DIMENSION;
                            }
                        } else {
                            if (height > MAX_AVATAR_DIMENSION) {
                                width = Math.round(width * MAX_AVATAR_DIMENSION / height);
                                height = MAX_AVATAR_DIMENSION;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', AVATAR_JPEG_QUALITY));
                    };
                    img.onerror = () => reject(new Error("No se pudo cargar la imagen para compresión."));
                };
                reader.onerror = () => reject(new Error("Error leyendo el archivo de imagen."));
            });
        }

        async function uploadClientAvatar(imageData, contentType, filename) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback('Debes iniciar sesión para cambiar tu avatar.', 'warning'); return;
            }
            const payload = {
                clientId: clientData.id,
                imageData: imageData, 
                contentType: contentType, 
                filename: "avatar_" + clientData.id + "_" + Date.now() + "." + (contentType.split('/')[1] || 'jpg')
            };
            const result = await fetchDataFromGAS('updateClientAvatar', 'POST', payload);
            if (result.success && result.data && result.data.newAvatarUrl) {
                if (result.data.clientData) {
                    const localAvatarTemp = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.clientData;
                    if (localAvatarTemp && !clientData[LOCAL_AVATAR_DATA_KEY]) {
                        clientData[LOCAL_AVATAR_DATA_KEY] = localAvatarTemp;
                    }
                    if (result.data.newAvatarUrl) clientData.avatarurl = result.data.newAvatarUrl;
                } else {
                     clientData.avatarurl = result.data.newAvatarUrl;
                }
                localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                showGlobalFeedback('¡Avatar guardado con éxito en el servidor!', 'success');
            } else {
                showGlobalFeedback(result.message || 'Error al guardar el avatar en el servidor. Se mantiene la versión local.', 'warning');
            }
        }

        async function loadMenuItems(forceRefresh = false) {
            const menuContainer = document.getElementById('menu-container');
            if (!menuContainer) { return; }
            const cachedProducts = localStorage.getItem(PRODUCTS_USER_CACHE_KEY);
            const cacheExpiryString = localStorage.getItem(MENU_CACHE_EXPIRY_KEY);
            const now = new Date().getTime();
            const cacheExpiry = cacheExpiryString ? parseInt(cacheExpiryString) : 0;
            if (!forceRefresh && cachedProducts && cacheExpiry && now < cacheExpiry) {
                try {
                    menuItems = JSON.parse(cachedProducts);
                    generateCategoryFilters();
                    filterMenuByCategory(currentFilterCategory);
                    return;
                } catch(e) {
                    localStorage.removeItem(PRODUCTS_USER_CACHE_KEY);
                    localStorage.removeItem(MENU_CACHE_EXPIRY_KEY);
                }
            }
            menuContainer.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">${forceRefresh ? 'Actualizando' : 'Cargando'} menú y combos...</p></div>`;
            const res = await fetchDataFromGAS('getPublicProducts', 'GET');
            if (res.success && Array.isArray(res.data)) {
                menuItems = res.data.map(p => ({
                    ...p,
                    price: parseFloat(p.price) || 0,
                    points: parseInt(p.points) || 0,
                    id: String(p.id),
                    category: p.category || "Otros"
                }));
                localStorage.setItem(PRODUCTS_USER_CACHE_KEY, JSON.stringify(menuItems));
                localStorage.setItem(MENU_CACHE_EXPIRY_KEY, (now + CACHE_DURATION_MS).toString());
                generateCategoryFilters();
                filterMenuByCategory(currentFilterCategory);
                if (forceRefresh) showGlobalFeedback("Menú y combos actualizados.", "success", 2000);
            } else {
                menuContainer.innerHTML = `<div class="col-12 text-center p-5"><p class="text-danger fs-5">Error al ${forceRefresh ? 'actualizar' : 'cargar'} el menú y combos: ${res.message || 'Desconocido.'}</p></div>`;
                if (cachedProducts) {
                    try {
                        menuItems = JSON.parse(cachedProducts);
                        generateCategoryFilters(); filterMenuByCategory(currentFilterCategory);
                        showGlobalFeedback("No se pudo actualizar el menú, mostrando última versión disponible.", "warning", 4000);
                    } catch(e) {}
                }
            }
        }

        function forceLoadMenuItems() {
            loadMenuItems(true);
        }

       function generateCategoryFilters() {
            const filterContainer = document.getElementById('filter-container');
            if (!filterContainer) {
                console.error("Contenedor de filtros no encontrado.");
                return;
            }
            filterContainer.innerHTML = '';
            if (!menuItems || menuItems.length === 0) {
                return;
            }
            const allBtn = document.createElement('button');
            allBtn.className = 'btn btn-sm btn-filter';
            allBtn.textContent = 'Todos';
            allBtn.onclick = () => filterMenuByCategory('all');
            filterContainer.appendChild(allBtn);
            const categories = [...new Set(menuItems.map(item => item.category || "Otros"))]
                .sort((a, b) => a.localeCompare(b));
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-filter';
                btn.textContent = category;
                btn.onclick = () => filterMenuByCategory(category);
                filterContainer.appendChild(btn);
            });
            const filterButtons = filterContainer.querySelectorAll('.btn-filter');
            filterButtons.forEach(btn => {
                const btnTextLower = btn.textContent.toLowerCase();
                const currentFilterLower = currentFilterCategory.toLowerCase();
                if ((currentFilterLower === 'all' && btnTextLower === 'todos') || 
                    (btnTextLower === currentFilterLower && currentFilterLower !== 'all')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function filterMenuByCategory(category) {
            currentFilterCategory = category;
            generateMenu();
        }

        function generateMenu() {
            const menuContainer = document.getElementById('menu-container');
            if (!menuContainer) return;
            menuContainer.innerHTML = '';
            const itemsToDisplay = currentFilterCategory === 'all' ? menuItems : menuItems.filter(item => (item.category || "Otros") === currentFilterCategory);
            if (!itemsToDisplay || itemsToDisplay.length === 0) {
                menuContainer.innerHTML = `<div class="col-12 text-center p-5"><p class="fs-5">No hay productos disponibles ${currentFilterCategory === 'all' ? '' : 'en la categoría "' + currentFilterCategory + '"'}.</p></div>`;
                return;
            }
            itemsToDisplay.sort((a,b) => (a.name || "").localeCompare(b.name || "")).forEach(item => {
                const itemId = String(item.id);
                menuContainer.innerHTML += `
                <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
                    <div class="menu-item-card card w-100 d-flex flex-column">
                        <img src="${item.imageurl || 'https://via.placeholder.com/350x220/E74C3C/FFF?text=' + encodeURIComponent(item.name || 'Producto')}" 
                             class="product-image card-img-top" alt="${item.name || 'Producto'}" style="cursor: pointer;" onclick="showProductDetailModal('${itemId}')">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${item.name || 'Sin Nombre'}</h5>
                            <p class="card-text flex-grow-1">${item.description || 'Deliciosa opción de nuestro menú.'}</p>
                            <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                                <span class="fw-bold fs-5" style="color: var(--primary-color);">USD ${(item.price || 0).toFixed(2)}</span>
                                <span class="badge bg-success text-white">+${item.points || 0} Puntos</span>
                            </div>
                            <button class="btn btn-primary mt-3 w-100" onclick="addToCart('${itemId}')"><i class="bi bi-cart-plus-fill me-2"></i>Añadir al Envío</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function showProductDetailModal(productId) {
            populateModalWithProduct(productId);
            productDetailModalInstance.show();
        }

        function switchProductInModal(productId) {
            populateModalWithProduct(productId);
        }

        function populateModalWithProduct(productId) {
            const product = menuItems.find(p => p.id === productId);
            if (!product) {
                console.error("Producto no encontrado para el modal:", productId);
                return;
            }
            document.getElementById('modal-product-image').src = product.imageurl || 'https://via.placeholder.com/500x600/141E30/FAFAFA?text=' + encodeURIComponent(product.name || 'Producto');
            document.getElementById('modal-product-name').textContent = product.name || 'Sin Nombre';
            document.getElementById('modal-product-description').textContent = product.description || 'Descripción no disponible.';
            document.getElementById('modal-product-price').textContent = `USD ${(product.price || 0).toFixed(2)}`;
            document.getElementById('modal-product-points').textContent = `+${product.points || 0} Puntos`;
            const btnContainer = document.getElementById('modal-add-to-cart-button-container');
            btnContainer.innerHTML = `<button class="btn btn-primary btn-lg w-100" onclick="addToCartAndCloseModal('${productId}')"><i class="bi bi-cart-plus-fill me-2"></i>Añadir al Envío</button>`;
            generateRecommendations(productId);
        }

        function generateRecommendations(currentProductId) {
            const recommendationsContainer = document.getElementById('modal-recommendations-container');
            recommendationsContainer.innerHTML = '<h5><i class="bi bi-magic me-2"></i>También podría interesarte</h5>';
            const currentProduct = menuItems.find(p => p.id === currentProductId);
            if (!currentProduct) return;
            const candidates = menuItems.filter(p => p.id !== currentProductId);
            const sameCategory = candidates.filter(p => p.category === currentProduct.category);
            const otherCategory = candidates.filter(p => p.category !== currentProduct.category);
            const shuffledCandidates = [...sameCategory.sort(() => 0.5 - Math.random()), ...otherCategory.sort(() => 0.5 - Math.random())];
            const finalRecommendations = shuffledCandidates.slice(0, 3);
            if (finalRecommendations.length === 0) {
                recommendationsContainer.innerHTML += '<p class="small text-muted">No hay otras recomendaciones por ahora.</p>';
                return;
            }
            const recRow = document.createElement('div');
            recRow.className = 'row g-2';
            finalRecommendations.forEach(rec => {
                recRow.innerHTML += `
                <div class="col-4">
                    <div class="recommendation-card" onclick="switchProductInModal('${rec.id}')">
                        <img src="${rec.imageurl || 'https://via.placeholder.com/150/21243D/FAFAFA?text=' + encodeURIComponent(rec.name)}" alt="${rec.name}">
                        <div class="p-2"><div class="rec-title">${rec.name}</div></div>
                    </div>
                </div>`;
            });
            recommendationsContainer.appendChild(recRow);
        }

        function addToCartAndCloseModal(productId) {
            addToCart(productId);
            productDetailModalInstance.hide();
        }

        function loadCartFromStorage(){
            const storedCart = localStorage.getItem(USER_CART_KEY); 
            shoppingCart = storedCart ? (JSON.parse(storedCart) || []) : [];
            updateCartDisplay();
        }

        function saveCartToStorage(){
            try {
                localStorage.setItem(USER_CART_KEY, JSON.stringify(shoppingCart));
            } catch(e) {
                showGlobalFeedback("No se pudo guardar el carrito. Espacio de almacenamiento lleno?", "danger");
            }
        }

        function addToCart(productId) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback('Inicia sesión para añadir productos a tu envío.', 'warning');
                loginModalInstance?.show();
                return;
            }
            if (!menuItems || menuItems.length === 0) {
                showGlobalFeedback("Error: El menú no está cargado. Intenta recargar la página.", "danger");
                return;
            }
            const product = menuItems.find(item => item.id === productId); 
            if (!product) {
                showGlobalFeedback("Producto no encontrado.", "danger");
                return;
            }
            const existingItem = shoppingCart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity = (existingItem.quantity || 0) + 1;
            } else {
                shoppingCart.push({
                    productId: product.id, name: product.name, 
                    price:parseFloat(product.price)||0, quantity:1, points:parseInt(product.points)||0
                });
            }
            saveCartToStorage();
            updateCartDisplay();
            renderCartItems();
            showGlobalFeedback(`${product.name} añadido a tu envío!`, 'success', 2000);
        }

        function updateCartQuantity(productId, change) {
            const itemInCart = shoppingCart.find(item => item.productId === productId);
            if (itemInCart) {
                itemInCart.quantity += change;
                if (itemInCart.quantity <= 0) {
                    shoppingCart = shoppingCart.filter(item => item.productId !== productId);
                }
            }
            saveCartToStorage();
            renderCartItems();
            updateCartDisplay();
        }

        function removeFromCart(productId) {
            shoppingCart = shoppingCart.filter(item => item.productId !== productId);
            saveCartToStorage();
            renderCartItems();
            updateCartDisplay();
            showGlobalFeedback("Producto eliminado del envío.", "info", 1500);
        }

        function clearCart() {
            if (shoppingCart.length === 0) {
                showFeedbackInModal(null, 'order-placement-feedback', 'El carrito de envío ya está vacío.', 'info', 2000);
                return;
            }
            if (confirm("¿Estás seguro de que quieres vaciar tu carrito de envío?")) {
                shoppingCart = [];
                saveCartToStorage();
                renderCartItems();
                updateCartDisplay();
                showFeedbackInModal(null, 'order-placement-feedback', 'Carrito de envío vaciado.', 'info', 2000);
            }
        }

        function updateCartDisplay() {
            let totalItems = Array.isArray(shoppingCart) ? shoppingCart.reduce((s, i) => s + (i.quantity || 0), 0) : 0;
            if (floatingCartButtonEl && floatingCartCountEl) {
                const isCurrentlyVisible = floatingCartButtonEl.style.display !== 'none' && !floatingCartButtonEl.classList.contains('animate__zoomOut');
                const shouldBeVisible = totalItems > 0 && clientData && clientData.id;
                if (shouldBeVisible && !isCurrentlyVisible) {
                    floatingCartButtonEl.classList.remove('animate__zoomOut');
                    floatingCartButtonEl.classList.add('animate__animated', 'animate__zoomIn');
                    floatingCartButtonEl.style.display = 'flex';
                } else if (!shouldBeVisible && isCurrentlyVisible) {
                    floatingCartButtonEl.classList.remove('animate__zoomIn');
                    floatingCartButtonEl.classList.add('animate__animated', 'animate__zoomOut');
                    setTimeout(() => {
                        if ( !(totalItems > 0 && clientData && clientData.id) ) { 
                           floatingCartButtonEl.style.display = 'none';
                        }
                    }, 500);
                }
                floatingCartCountEl.textContent = totalItems;
            }
            const pointsEl = document.getElementById('cart-points-to-earn');
            if(pointsEl) pointsEl.textContent = Array.isArray(shoppingCart) ? shoppingCart.reduce((s,i)=>s+((i.points||0)*(i.quantity||0)),0) : 0;
            adjustBodyPaddingAndFabPosition();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            const totalPriceEl = document.getElementById('cart-total-price');
            const pointsToEarnEl = document.getElementById('cart-points-to-earn');
            if (!container || !totalPriceEl || !pointsToEarnEl) return;
            container.innerHTML = ''; let currentTotal = 0; let totalPoints = 0;
            if (!Array.isArray(shoppingCart) || shoppingCart.length === 0) {
                container.innerHTML = '<p class="text-center py-4 fs-5">Tu carrito de envío está vacío.</p>';
                totalPriceEl.textContent = '0.00';
                pointsToEarnEl.textContent = '0';
                updateCartDisplay();
                return;
            }
            const ul = document.createElement('ul'); 
            ul.className = 'list-group list-group-flush';
            shoppingCart.forEach(item => {
                const itemTotal = (parseFloat(item.price) || 0) * (item.quantity || 0);
                const itemPoints = (item.points || 0) * (item.quantity || 0);
                currentTotal += itemTotal;
                totalPoints += itemPoints;
                const itemProductId = String(item.productId);
                const li = document.createElement('li'); 
                li.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2 py-3 bg-transparent text-light border-secondary';
                li.innerHTML = `
                    <div class="me-auto">
                        <strong class="d-block">${item.name || 'Desconocido'}</strong>
                        <small class="text-muted">${item.quantity||0} x USD ${(parseFloat(item.price)||0).toFixed(2)}</small>
                    </div>
                    <div class="fw-bold me-3 fs-5">USD ${itemTotal.toFixed(2)}</div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary px-2 py-1" onclick="updateCartQuantity('${itemProductId}',-1)"><i class="bi bi-dash-lg"></i></button>
                        <span class="btn btn-light disabled px-3 py-1 border-secondary text-dark">${item.quantity||0}</span>
                        <button class="btn btn-outline-secondary px-2 py-1" onclick="updateCartQuantity('${itemProductId}',1)"><i class="bi bi-plus-lg"></i></button>
                        <button class="btn btn-outline-danger ms-2 px-2 py-1" onclick="removeFromCart('${itemProductId}')"><i class="bi bi-trash"></i></button>
                    </div>`;
                ul.appendChild(li);
            });
            container.appendChild(ul); 
            totalPriceEl.textContent = currentTotal.toFixed(2);
            pointsToEarnEl.textContent = totalPoints;
            updateCartDisplay();
        }

        function generateWhatsAppMessage(orderId, cart, total) {
            let message = `¡Hola! 👋 He realizado un nuevo pedido desde DL Cumanayagua.\n\n`;
            message += `*Nro. de Envío:* ${orderId}\n\n`;
            message += "*Resumen del pedido:*\n";
            cart.forEach(item => {
                message += `- ${item.quantity}x ${item.name}\n`;
            });
            message += `\n*Total:* USD ${total.toFixed(2)}\n\n`;
            message += `Espero instrucciones para el pago. ¡Gracias!`;
            return encodeURIComponent(message);
        }

        function postWhatsAppNotification() {
            showGlobalFeedback("Serás redirigido a WhatsApp. Una vez enviado el mensaje, puedes cerrar esta ventana.", "info", 8000);
            setTimeout(() => {
                cartModalInstance?.hide();
                clearFormAndFeedback(null, 'order-placement-feedback');
                document.getElementById('cart-footer-info').style.display = 'block';
                document.getElementById('cart-footer-buttons').style.display = 'flex';
            }, 5000);
        }

        async function confirmAndPlaceOrder() {
            if (!Array.isArray(shoppingCart) || shoppingCart.length === 0) { 
                showFeedbackInModal(null, 'order-placement-feedback', "Tu carrito de envío está vacío.", "warning");
                return; 
            }
            if (!clientData || !clientData.id) { 
                showFeedbackInModal(null, 'order-placement-feedback', 'Inicia sesión para realizar un envío.', 'warning'); 
                cartModalInstance?.hide();
                loginModalInstance?.show();
                return; 
            }
            showFeedbackInModal(null, 'order-placement-feedback', '<div class="spinner-border spinner-border-sm me-2"></div>Procesando envío...', 'info', null);
            const cartPayload = shoppingCart.map(item => ({ productId: String(item.productId), quantity: item.quantity || 0 }));
            const result = await fetchDataFromGAS('placeOrder', 'POST', { clientId: String(clientData.id), cartItems: cartPayload });
            
            if (result.success && result.data) {
                const orderTotal = shoppingCart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)), 0);
                const whatsappMessage = generateWhatsAppMessage(result.data.orderId, shoppingCart, orderTotal);
                const whatsappUrl = `https://wa.me/5355189657?text=${whatsappMessage}`;
                
                const feedbackEl = document.getElementById('order-placement-feedback');
                feedbackEl.innerHTML = `
                    <div class="alert alert-success" role="alert">
                      <h4 class="alert-heading">¡Envío Programado con Éxito!</h4>
                      <p>Tu pedido con ID <strong>#${result.data.orderId}</strong> ha sido registrado. El siguiente paso es notificarnos por WhatsApp para coordinar el pago.</p>
                      <hr>
                      <a href="${whatsappUrl}" target="_blank" class="btn btn-success btn-lg w-100" onclick="postWhatsAppNotification()">
                        <i class="bi bi-whatsapp me-2"></i><strong>Notificar Pedido por WhatsApp</strong>
                      </a>
                    </div>
                `;
                
                document.getElementById('cart-footer-info').style.display = 'none';
                document.getElementById('cart-footer-buttons').style.display = 'none';

                shoppingCart = []; 
                saveCartToStorage();
                
                if (result.data.updatedClient) {
                    const localAvatar = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.updatedClient;
                    if (localAvatar && !clientData[LOCAL_AVATAR_DATA_KEY]) clientData[LOCAL_AVATAR_DATA_KEY] = localAvatar;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    updateClientDisplayAndUI(); 
                }
                
                renderCartItems(); 
                loadUserOrders();

            } else {
                showFeedbackInModal(null, 'order-placement-feedback', result.message || 'Error al programar el envío.', 'danger');
            }
        }

        async function loadUserOrders() {
            const container = document.getElementById('orders-history-container'); 
            if (!container) return;
            if (!clientData || !clientData.id) { 
                container.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tu historial de envíos.</p></div>';
                return; 
            }
            container.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);"></div><p class="mt-2 fs-5">Cargando historial de envíos...</p></div>`;
            const result = await fetchDataFromGAS('getUserOrders', 'POST', { clientId: String(clientData.id) });
            if (result.success && Array.isArray(result.data)) {
                if (result.data.length === 0) { 
                    container.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Aún no has realizado ningún envío.</p></div>';
                    return; 
                }
                let html = '<div class="accordion shadow-sm" id="ordersAccordion">';
                result.data.sort((a,b) => new Date(b.orderdateiso || b.orderdate) - new Date(a.orderdateiso || a.orderdate));
                result.data.forEach((order, index) => {
                    const items = order.itemsjson; 
                    let itemsHtml = '<ul class="list-unstyled small ms-3 mt-1">'; 
                    if (Array.isArray(items) && items.length > 0) {
                        items.forEach(item => { 
                            itemsHtml += `<li>${item.quantity}x ${item.name} (USD ${((parseFloat(item.price)||0) * (item.quantity||0)).toFixed(2)})</li>`; 
                        });
                    } else { itemsHtml += '<li>No hay detalles de ítems.</li>'; }
                    itemsHtml += '</ul>';
                    let sbc = 'bg-secondary';
                    const os = String(order.status || '').toLowerCase();
                    if (os === 'pendiente de pago' || os === 'pendiente') sbc = 'bg-warning text-dark'; 
                    else if (os === 'procesado' || os === 'en preparación') sbc = 'bg-info text-dark';
                    else if (os === 'entregado' || os === 'completado') sbc = 'bg-success';
                    else if (os === 'cancelado') sbc = 'bg-danger';
                    const dateStr = order.orderdateiso || order.orderdate;
                    const odf = dateStr ? new Date(dateStr).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric', hour:'2-digit', minute:'2-digit' }) : 'Fecha N/A';
                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="hO${order.orderid}"><button class="accordion-button ${index>0?'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#cO${order.orderid}" aria-expanded="${index===0}" aria-controls="cO${order.orderid}"><span class="me-auto">${odf} - Envío #${String(order.orderid).substr(-6)} - USD ${(parseFloat(order.totalamount)||0).toFixed(2)}</span><span class="badge ${sbc} text-uppercase">${order.status||'N/A'}</span></button></h2>
                            <div id="cO${order.orderid}" class="accordion-collapse collapse ${index===0?'show':''}" aria-labelledby="hO${order.orderid}" data-bs-parent="#ordersAccordion"><div class="accordion-body"><strong>Puntos ${order.pointsgiven?'Otorgados':'A Otorgar'}:</strong> ${order.totalpointsawarded||0}<br><strong>Ítems:</strong>${itemsHtml}</div></div>
                        </div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div class="col-12 text-center p-5"><p class="text-danger fs-5">Error al cargar historial de envíos: ${result.message || 'Error.'}</p></div>`;
            }
        }

        async function loadAvailableRewards(forceReload = false) {
            const rc = document.getElementById('rewards-container'); 
            if (!rc) return;
            if (!clientData || !clientData.id) { 
                rc.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver recompensas para tus envíos.</p></div>';
                return; 
            }
            const cachedRewards = localStorage.getItem(REWARDS_USER_CACHE_KEY);
            const cacheExpiryString = localStorage.getItem(REWARDS_CACHE_EXPIRY_KEY);
            const now = new Date().getTime();
            const cacheExpiry = cacheExpiryString ? parseInt(cacheExpiryString) : 0;
            if (!forceReload && cachedRewards && cacheExpiry && now < cacheExpiry) {
                try {
                    availableRewards = JSON.parse(cachedRewards);
                    generateRewardsList();
                    console.log("Recompensas cargadas desde caché.");
                    return;
                } catch(e) {
                    console.error("Error parseando recompensas de caché:", e);
                    localStorage.removeItem(REWARDS_USER_CACHE_KEY);
                    localStorage.removeItem(REWARDS_CACHE_EXPIRY_KEY);
                }
            }
            rc.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);"></div><p class="mt-2 fs-5">${forceReload ? 'Actualizando' : 'Cargando'} recompensas...</p></div>`;
            const res = await fetchDataFromGAS('getAvailableRewards', 'GET');
            if (res.success && Array.isArray(res.data)) {
                availableRewards = res.data.map(r => ({...r, rewardid: String(r.rewardid), pointsrequired:parseInt(r.pointsrequired)||0, stock:parseInt(r.stock) }));
                try {
                    localStorage.setItem(REWARDS_USER_CACHE_KEY, JSON.stringify(availableRewards));
                    localStorage.setItem(REWARDS_CACHE_EXPIRY_KEY, (now + CACHE_DURATION_MS).toString());
                    console.log("Recompensas guardadas en caché.");
                } catch (cacheError) {
                    console.error("Error guardando recompensas en caché:", cacheError);
                    showGlobalFeedback("No se pudo guardar la caché de recompensas. Espacio lleno?", "warning");
                }
                generateRewardsList();
                if (forceReload) showGlobalFeedback("Recompensas actualizadas.", "success", 2000);
            } else {
                rc.innerHTML = `<div class="col-12 text-center p-5"><p class="text-danger fs-5">No se pudo cargar recompensas: ${res.message||'Error.'}</p></div>`;
                 if (cachedRewards) { 
                    try { 
                        availableRewards = JSON.parse(cachedRewards); 
                        generateRewardsList(); 
                        showGlobalFeedback("No se pudieron actualizar las recompensas, mostrando última versión disponible.", "warning", 4000);
                    } catch(e) {}
                }
            }
        }

        function forceLoadRewards() {
            if (!clientData || !clientData.id) {
                showGlobalFeedback("Inicia sesión para ver y actualizar recompensas.", "warning");
                const rc = document.getElementById('rewards-container');
                if (rc) rc.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver recompensas para tus envíos.</p></div>';
                return;
            }
            loadAvailableRewards(true);
        }

        function generateRewardsList() {
            const rc = document.getElementById('rewards-container'); 
            if (!rc) return;
            rc.innerHTML = '';
            if (!clientData || !clientData.id) { 
                rc.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver recompensas para tus envíos.</p></div>';
                return;
            }
            if (!availableRewards || availableRewards.length === 0) { 
                rc.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">No hay recompensas disponibles para canjear.</p></div>';
                return; 
            }
            const cp = clientData ? (parseInt(clientData.puntos) || 0) : 0;
            availableRewards.sort((a,b) => (a.pointsrequired||0)-(b.pointsrequired||0));
            availableRewards.forEach(reward => {
                const ca = cp >= reward.pointsrequired;
                const hs = isNaN(reward.stock) || reward.stock === 9999 || reward.stock > 0; 
                const cr = ca && hs;
                const rid = String(reward.rewardid);
                rc.innerHTML += `
                <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
                    <div class="reward-card card w-100 ${!cr ? 'opacity-75' : ''}">
                        <img src="${reward.imageurl || 'https://via.placeholder.com/350x220/F1C40F/2C3E50?text=' + encodeURIComponent(reward.name||'Recompensa')}" class="reward-image card-img-top" alt="${reward.name||'Recompensa'}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-1">${reward.name||'N/A'}</h5>
                            <p class="card-text small flex-grow-1 mb-3">${reward.description||'Beneficio para tus envíos.'}</p>
                            <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                                <span class="fw-bold fs-5" style="color: var(--accent-color);">${reward.pointsrequired} Pts</span>
                                ${!isNaN(reward.stock) && reward.stock !== 9999 ? `<span class="small text-muted">Disp: ${reward.stock}</span>` : '<span class="small text-muted">Ilimitado!</span>'}
                            </div>
                            <button class="btn btn-warning w-100 mt-3" onclick="attemptRedeemReward('${rid}')" ${!cr?'disabled':''}>
                                <i class="bi bi-award-fill me-2"></i> ${cr ? 'Canjear para Envío' : (ca&&!hs ? 'Agotado' : 'Puntos Insuficientes')}
                            </button>
                        </div>
                    </div>
                </div>`;
            });
        }

        async function attemptRedeemReward(rewardId) {
            if (!clientData || !clientData.id) { 
                showGlobalFeedback("Debes iniciar sesión para canjear.", "warning");
                loginModalInstance?.show();
                return; 
            }
            const reward = availableRewards.find(r => r.rewardid === rewardId);
            if (!reward) {
                showGlobalFeedback("Recompensa no encontrada.", "danger");
                return;
            }
            if (!confirm(`¿Canjear "${reward.name}" por ${reward.pointsrequired} puntos para un próximo envío?`)) return;
            showGlobalFeedback("Procesando canje...", "info", null);
            const result = await fetchDataFromGAS('redeemReward', 'POST', { clientId: String(clientData.id), rewardId: rewardId });
            if (result.success && result.data) {
                showGlobalFeedback(result.message || "¡Recompensa canjeada! Se aplicará en tu próximo envío o según se indique.", "success", 5000);
                if (result.data.updatedClient) {
                    const localAvatar = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.updatedClient;
                    if(localAvatar && !clientData[LOCAL_AVATAR_DATA_KEY]) clientData[LOCAL_AVATAR_DATA_KEY] = localAvatar;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    updateClientDisplayAndUI();
                }
                loadAvailableRewards(true); 
            } else {
                showGlobalFeedback(result.message || "No se pudo canjear. Intenta de nuevo.", "danger", 7000);
            }
        }

        function showFeedbackInModal(modalIdUnused, elId, msg, type='info', dur=4000) {
            const div = document.getElementById(elId); 
            if (!div) return;
            div.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show small py-2" role="alert">${msg}<button type="button" class="btn-close btn-close-white btn-sm py-2" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
            if (dur !== null && type !== 'info' && !(String(msg).includes('spinner-border'))) {
                 setTimeout(() => { if (div && div.innerHTML.includes(msg)) div.innerHTML = ''; }, dur);
            }
        }
        
        function showGlobalFeedback(msg, type = 'info', dur = 4000) {
            const toastPlacement = document.getElementById('toastPlacement');
            if (!toastPlacement) {
                alert(`${type.toUpperCase()}: ${msg}`);
                return;
            }
            const toastId = 'liveToast-' + Date.now();
            let tbc = 'bg-primary text-white', bcc = 'btn-close-white'; 
            if (type === 'danger') { tbc = 'bg-danger text-white'; }
            else if (type === 'success') { tbc = 'bg-success text-white'; }
            else if (type === 'warning') { tbc = 'bg-warning text-dark'; bcc = 'btn-close-dark';}
            const toastHTML = `
                <div class="toast align-items-center ${tbc} border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close ${bcc} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
                </div>`;
            toastPlacement.insertAdjacentHTML('beforeend', toastHTML);
            const toastEl = document.getElementById(toastId);
            if (toastEl) {
                const toastInstance = new bootstrap.Toast(toastEl, { 
                    autohide: (dur !== null && !String(msg).includes('spinner-border')), 
                    delay: dur 
                });
                toastInstance.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }
        }
    </script>
</body>
</html>
