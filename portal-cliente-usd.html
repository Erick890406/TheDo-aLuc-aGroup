<!DOCTYPE html>
<html lang="es" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta VIP - Doña Lucía</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <meta name="description" content="Con DL USD Cumanayagua, compra fácil y seguro productos, alimentos y regalos para tus seres queridos en Cumanayagua, Cuba. Paga cómodamente desde USA con Zelle.">
    <meta property="og:title" content="DL USD Cumanayagua: ¡Sorprende a tu Familia en Cuba!" />
    <meta property="og:description" content="Envía amor comprando productos en Cumanayagua. Compra online desde USA para tu familia en Cuba y paga con Zelle. ¡Fácil, rápido y con cariño!" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://erick890406.github.io/TheDo-aLuc-aGroup/portal-cliente-usd.html" />
    <meta property="og:site_name" content="DL USD Cumanayagua" />
    <meta property="og:image" content="https://i.postimg.cc/x8hj4gKx/Dl-Usd-2-cuamanayagua.png" />
    <meta property="og:image:secure_url" content="https://i.postimg.cc/x8hj4gKx/Dl-Usd-2-cuamanayagua.png" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="628" />
    <meta property="og:image:alt" content="Envía productos a Cuba - DL USD Cumanayagua" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Envía a Cuba con DL USD Cumanayagua" />
    <meta name="twitter:description" content="Compra para tu familia en Cumanayagua desde USA. Paga con Zelle. Alimentos, regalos y más. ¡Visítanos!" />
    <meta name="twitter:image" content="https://i.postimg.cc/jjNmrcyw/Meta-Etiqueta.png" />
    <meta name="twitter:image:alt" content="Promoción DL USD Cumanayagua para compras familiares en Cuba" />
    <link rel="manifest" href="manifest.json">
<style>
:root {
    /* Sistema de Design - Paleta Clara Moderna */
    --primary-50: #EFF6FF;
    --primary-100: #DBEAFE;
    --primary-500: #3B82F6;
    --primary-600: #2563EB;
    --primary-700: #1D4ED8;
    
    --accent-50: #F0F9FF;
    --accent-500: #0EA5E9;
    --accent-600: #0284C7;
    
    --success-50: #ECFDF5;
    --success-500: #10B981;
    --success-600: #059669;
    
    --warning-50: #FFFBEB;
    --warning-500: #F59E0B;
    --warning-600: #D97706;
    
    --error-50: #FEF2F2;
    --error-500: #EF4444;
    --error-600: #DC2626;
    
    /* Escala de Grises - Sistema consistente */
    --white: #FFFFFF;
    --gray-50: #F8FAFC;
    --gray-100: #F1F5F9;
    --gray-200: #E2E8F0;
    --gray-300: #CBD5E1;
    --gray-400: #94A3B8;
    --gray-500: #64748B;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1E293B;
    --gray-900: #0F172A;
    
    /* Tokens Semánticos */
    --bg-primary: var(--white);
    --bg-secondary: var(--gray-50);
    --bg-tertiary: var(--gray-100);
    
    --text-primary: var(--gray-900);
    --text-secondary: var(--gray-700);
    --text-tertiary: var(--gray-500);
    --text-muted: var(--gray-400);
    
    --border-primary: var(--gray-200);
    --border-secondary: var(--gray-300);
    --border-focused: var(--primary-500);
    
    /* Elevación - Sistema de sombras */
    --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    
    /* Border Radius - Escala consistente */
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --radius-2xl: 20px;
    
    /* Espaciado - Sistema 4px grid */
    --space-1: 4px;
    --space-2: 8px;
    --space-3: 12px;
    --space-4: 16px;
    --space-5: 20px;
    --space-6: 24px;
    --space-8: 32px;
    --space-10: 40px;
    --space-12: 48px;
    --space-16: 64px;
    
    /* Tipografía - Sistema escalable */
    --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --font-family-display: 'Inter', sans-serif;
    
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;
    
    --font-weight-normal: 400;
    --font-weight-medium: 500;
    --font-weight-semibold: 600;
    --font-weight-bold: 700;
    
    /* Transiciones - Consistentes */
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* Reset Moderno */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

/* Base Styles */
body {
    font-family: var(--font-family-sans);
    font-size: var(--text-base);
    font-weight: var(--font-weight-normal);
    line-height: 1.5;
    color: var(--text-primary);
    background: var(--bg-secondary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

main {
    flex-grow: 1;
    padding-top: 80px; /* Para compensar navbar fixed */
}

/* Container System */
.container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-4);
}

/* Typography Scale */
h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-family-display);
    font-weight: var(--font-weight-semibold);
    line-height: 1.2;
    color: var(--text-primary);
    margin-bottom: var(--space-4);
}

h1 { font-size: var(--text-3xl); }
h2 { font-size: var(--text-2xl); }
h3 { font-size: var(--text-xl); }
h4 { font-size: var(--text-lg); }
h5 { font-size: var(--text-base); }
h6 { font-size: var(--text-sm); }

.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-tertiary { color: var(--text-tertiary); }
.text-muted { color: var(--text-muted); }

/* Navigation - Modern Header */
.navbar-custom {
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-primary);
    box-shadow: var(--shadow-sm);
    backdrop-filter: blur(8px);
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1000;
    padding: var(--space-3) 0;
}

.navbar-brand {
    font-family: var(--font-family-display);
    font-size: var(--text-xl);
    font-weight: var(--font-weight-bold);
    color: var(--primary-600);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.navbar-brand img {
    height: 32px;
    width: auto;
    border-radius: var(--radius-sm);
}

.navbar-nav {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    list-style: none;
    margin: 0;
    padding: 0;
}

.nav-link {
    color: var(--text-secondary);
    text-decoration: none;
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    border: none;
    background: none;
    cursor: pointer;
}

.nav-link:hover,
.nav-link.active {
    color: var(--primary-600);
    background: var(--primary-50);
}

/* Dropdown Styles */
.navbar .dropdown-menu {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: var(--space-2);
    min-width: 200px;
}

.navbar .dropdown-item {
    color: var(--text-secondary);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

.navbar .dropdown-item:hover {
    background: var(--primary-50);
    color: var(--primary-600);
}

.navbar .dropdown-divider {
    border-color: var(--border-primary);
    margin: var(--space-2) 0;
}

.navbar-toggler {
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-2);
    background: none;
    cursor: pointer;
}

.navbar-toggler-icon {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='%2364748B' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
    width: 20px;
    height: 20px;
}

/* Button System */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-5);
    border: 1.5px solid transparent;
    border-radius: var(--radius-md);
    font-weight: var(--font-weight-medium);
    font-size: var(--text-sm);
    text-decoration: none;
    cursor: pointer;
    transition: var(--transition-fast);
    position: relative;
    overflow: hidden;
    background: none;
}

.btn:focus {
    outline: 2px solid var(--primary-100);
    outline-offset: 2px;
}

.btn-primary {
    background: var(--primary-600);
    color: var(--white);
    border-color: var(--primary-600);
}

.btn-primary:hover {
    background: var(--primary-700);
    border-color: var(--primary-700);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background: var(--white);
    color: var(--text-secondary);
    border-color: var(--border-primary);
}

.btn-secondary:hover {
    background: var(--gray-50);
    border-color: var(--border-secondary);
    transform: translateY(-1px);
}

.btn-outline {
    background: transparent;
    color: var(--primary-600);
    border-color: var(--primary-600);
}

.btn-outline:hover {
    background: var(--primary-50);
    transform: translateY(-1px);
}

.btn-success {
    background: var(--success-600);
    color: var(--white);
    border-color: var(--success-600);
}

.btn-success:hover {
    background: var(--success-700);
    border-color: var(--success-700);
    transform: translateY(-1px);
}

.btn-warning {
    background: var(--warning-500);
    color: var(--white);
    border-color: var(--warning-500);
}

.btn-warning:hover {
    background: var(--warning-600);
    border-color: var(--warning-600);
    transform: translateY(-1px);
}

.btn-danger {
    background: var(--error-500);
    color: var(--white);
    border-color: var(--error-500);
}

.btn-danger:hover {
    background: var(--error-600);
    border-color: var(--error-600);
    transform: translateY(-1px);
}

.btn-sm {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-xs);
}

.btn-lg {
    padding: var(--space-4) var(--space-6);
    font-size: var(--text-base);
}

/* Card System */
.card {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-sm);
    transition: var(--transition-normal);
    overflow: hidden;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--border-secondary);
}

.menu-item-card,
.reward-card {
    composes: card;
}

.product-image,
.reward-image {
    width: 100%;
    aspect-ratio: 3 / 4;
    object-fit: cover;
    border-bottom: 1px solid var(--border-primary);
}

.card-body {
    padding: var(--space-6);
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.card-title {
    font-size: var(--text-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    line-height: 1.3;
    margin: 0;
}

.card-text {
    color: var(--text-secondary);
    font-size: var(--text-sm);
    line-height: 1.5;
    flex-grow: 1;
}

.price-points-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-primary);
}

.price {
    font-size: var(--text-xl);
    font-weight: var(--font-weight-bold);
    color: var(--primary-600);
}

/* Badge System */
.badge {
    display: inline-flex;
    align-items: center;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-lg);
    font-size: var(--text-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge-success {
    background: var(--success-50);
    color: var(--success-700);
    border: 1px solid var(--success-200);
}

.badge-primary {
    background: var(--primary-50);
    color: var(--primary-700);
    border: 1px solid var(--primary-200);
}

.badge-warning {
    background: var(--warning-50);
    color: var(--warning-700);
    border: 1px solid var(--warning-200);
}

.badge-danger {
    background: var(--error-50);
    color: var(--error-700);
    border: 1px solid var(--error-200);
}

.badge-info {
    background: var(--accent-50);
    color: var(--accent-700);
    border: 1px solid var(--accent-200);
}

/* Filter System */
#filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-6);
    justify-content: center;
}

.btn-filter {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
    cursor: pointer;
    text-decoration: none;
}

.btn-filter:hover,
.btn-filter.active {
    background: var(--primary-600);
    border-color: var(--primary-600);
    color: var(--white);
    transform: translateY(-1px);
}

/* Sort Select */
#sortProductsSelect {
    background: var(--bg-primary);
    border: 1.5px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-2) var(--space-4);
    color: var(--text-primary);
    font-size: var(--text-sm);
    min-width: 200px;
    cursor: pointer;
}

#sortProductsSelect:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px var(--primary-100);
}

/* Search Input */
#productSearchInput {
    background: var(--bg-primary);
    border: 1.5px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-base);
    color: var(--text-primary);
    width: 100%;
    transition: var(--transition-fast);
}

#productSearchInput:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px var(--primary-100);
}

#clearSearchButton {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-md);
    transition: var(--transition-fast);
}

#clearSearchButton:hover {
    background: var(--gray-100);
    color: var(--text-secondary);
}

/* VIP Card - Premium Design */
#vip-card-container {
    background: linear-gradient(135deg, var(--primary-600), var(--accent-600));
    border-radius: var(--radius-2xl);
    color: var(--white);
    padding: var(--space-8);
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-xl);
    margin-bottom: var(--space-8);
}

#vip-card-container::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at center, rgba(255,255,255,0.1), transparent 70%);
    transform: rotate(25deg);
    z-index: 0;
}

#vip-card-container * {
    position: relative;
    z-index: 1;
}

#vip-status-badge {
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    color: var(--white);
    border: 1px solid rgba(255,255,255,0.3);
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-lg);
}

#client-name {
    font-size: var(--text-2xl);
    font-weight: var(--font-weight-bold);
    margin: var(--space-2) 0;
    color: var(--white);
}

#client-status {
    color: rgba(255,255,255,0.8);
    margin-bottom: var(--space-2);
}

.points-display {
    font-size: var(--text-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--white);
    margin: var(--space-2) 0;
}

#client-phone-display {
    color: rgba(255,255,255,0.7);
    font-size: var(--text-sm);
}

#clientReferralCode {
    color: var(--white) !important;
    font-weight: var(--font-weight-bold);
}

/* Form System */
.form-control {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    border: 1.5px solid var(--border-primary);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    transition: var(--transition-fast);
    background: var(--bg-primary);
    color: var(--text-primary);
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px var(--primary-100);
}

.form-select {
    background: var(--bg-primary);
    border: 1.5px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-3) var(--space-4);
    color: var(--text-primary);
    font-size: var(--text-base);
    cursor: pointer;
}

.form-select:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px var(--primary-100);
}

/* Tab System */
.nav-pills {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-2);
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-8);
    flex-wrap: wrap;
}

.nav-pills .nav-item {
    flex: 1;
    min-width: 120px;
}

.nav-pills .nav-link {
    background: transparent;
    color: var(--text-secondary);
    border-radius: var(--radius-md);
    padding: var(--space-3) var(--space-4);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
    text-align: center;
    border: none;
    text-decoration: none;
    display: block;
    width: 100%;
}

.nav-pills .nav-link:hover {
    background: var(--gray-50);
    color: var(--text-primary);
}

.nav-pills .nav-link.active {
    background: var(--primary-600);
    color: var(--white);
    box-shadow: var(--shadow-sm);
}

/* Modal System */
.modal-content {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    color: var(--text-primary);
}

.modal-header {
    border-bottom: 1px solid var(--border-primary);
    padding: var(--space-6);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    color: var(--text-primary);
    font-weight: var(--font-weight-semibold);
    font-size: var(--text-xl);
    margin: 0;
}

.modal-body {
    padding: var(--space-6);
    color: var(--text-primary);
}

.modal-footer {
    border-top: 1px solid var(--border-primary);
    padding: var(--space-6);
}

/* Close Button */
.btn-close {
    background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%2364748B'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
    border: none;
    opacity: 0.8; /* MODIFICADO: Aumentada opacidad por defecto */
    width: 1em;
    height: 1em;
    padding: 0.25em;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.btn-close:hover {
    opacity: 1;
    background-color: var(--gray-100);
}

.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%);
}

/* Product Detail Modal */
#modal-product-image {
    width: 100%;
    aspect-ratio: 4 / 5;
    object-fit: cover;
    border-radius: var(--radius-lg);
    border: 2px solid var(--primary-500);
}

#modal-product-name {
    color: var(--text-primary);
    font-weight: var(--font-weight-bold);
    font-size: var(--text-2xl);
    margin-bottom: var(--space-4);
}

#modal-product-description {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-4);
}

#modal-product-price {
    color: var(--primary-600);
    font-size: var(--text-2xl);
    font-weight: var(--font-weight-bold);
}

#modal-product-points {
    background: var(--success-50);
    color: var(--success-700);
    border: 1px solid var(--success-200);
}

/* Recommendations */
#modal-recommendations-container h5 {
    color: var(--text-primary);
    border-bottom: 2px solid var(--primary-500);
    padding-bottom: var(--space-2);
    margin-bottom: var(--space-4);
    font-weight: var(--font-weight-semibold);
}

.recommendation-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition-fast);
    text-decoration: none;
    color: inherit;
}

.recommendation-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary-500);
    box-shadow: var(--shadow-md);
    text-decoration: none;
    color: inherit;
}

.recommendation-card img {
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
}

.recommendation-card .rec-title {
    font-size: var(--text-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
    padding: var(--space-2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
}

.recommendation-card .rec-title + small.text-primary {
    color: var(--primary-600) !important;
    font-weight: var(--font-weight-semibold);
    padding: 0 var(--space-2) var(--space-2);
    display: block;
}

/* Reward Detail Modal */
#modal-reward-image {
    width: 100%;
    aspect-ratio: 4 / 5;
    object-fit: cover;
    border-radius: var(--radius-lg);
    border: 2px solid var(--accent-500);
}

#modal-reward-name {
    color: var(--text-primary);
    font-weight: var(--font-weight-bold);
    font-size: var(--text-2xl);
    margin-bottom: var(--space-4);
}

#modal-reward-description {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-4);
}

#modal-reward-points-required {
    color: var(--accent-600);
    font-size: var(--text-2xl);
    font-weight: var(--font-weight-bold);
}
/* ESTILOS MEJORADOS PARA EL CARRITO - DISEÑO PROFESIONAL */
.cart-section {
    padding: var(--space-6);
    background: linear-gradient(135deg, var(--primary-50) 0%, var(--white) 100%);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--primary-100);
    position: relative;
    overflow: hidden;
}

.cart-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-500), var(--accent-500));
}

.cart-items {
    margin-bottom: var(--space-6);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.cart-item {
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
    animation: slideInUp 0.4s ease-out;
}

.cart-item:nth-child(1) { animation-delay: 0.1s; }
.cart-item:nth-child(2) { animation-delay: 0.2s; }
.cart-item:nth-child(3) { animation-delay: 0.3s; }
.cart-item:nth-child(4) { animation-delay: 0.4s; }

.cart-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(to bottom, var(--primary-500), var(--accent-500));
    opacity: 0;
    transition: opacity var(--transition-fast);
}

.cart-item:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-200);
}

.cart-item:hover::before {
    opacity: 1;
}

/* Indicador de cantidad */
.item-quantity-indicator {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: var(--white);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-sm);
    font-weight: var(--font-weight-bold);
    box-shadow: var(--shadow-sm);
}

.item-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    min-width: 0;
}

.item-name {
    font-weight: var(--font-weight-semibold);
    color: var(--gray-900);
    font-size: var(--text-base);
    line-height: 1.3;
    letter-spacing: -0.01em;
    margin-bottom: 0;
}

.item-details {
    font-size: var(--text-sm);
    color: var(--gray-500);
    line-height: 1.2;
}

.item-price-section {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: var(--space-1);
    text-align: right;
}

.item-price {
    font-weight: var(--font-weight-bold);
    color: var(--primary-600);
    font-size: var(--text-lg);
    letter-spacing: -0.01em;
}

.item-unit-price {
    font-size: var(--text-xs);
    color: var(--gray-400);
    font-weight: var(--font-weight-medium);
}

.item-points {
    background: var(--success-50);
    color: var(--success-700);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-weight-medium);
    border: 1px solid var(--success-200);
}

/* Controles de cantidad */
.cart-controls {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    background: var(--gray-50);
    padding: var(--space-1);
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
}

.quantity-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-sm);
    font-weight: var(--font-weight-bold);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.quantity-btn.decrease {
    background: var(--gray-200);
    color: var(--gray-700);
}

.quantity-btn.decrease:hover {
    background: var(--error-100);
    color: var(--error-600);
}

.quantity-btn.increase {
    background: var(--primary-100);
    color: var(--primary-600);
}

.quantity-btn.increase:hover {
    background: var(--primary-200);
    color: var(--primary-700);
}

.quantity-display {
    min-width: 40px;
    text-align: center;
    font-weight: var(--font-weight-semibold);
    color: var(--gray-800);
    font-size: var(--text-sm);
}

.remove-btn {
    background: var(--error-50);
    color: var(--error-600);
    border: 1px solid var(--error-200);
    border-radius: var(--radius-md);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.remove-btn:hover {
    background: var(--error-100);
    border-color: var(--error-300);
    transform: scale(1.05);
}

/* Sistema de puntos mejorado */
.points-container {
    background: linear-gradient(135deg, var(--success-50) 0%, var(--primary-50) 100%);
    padding: var(--space-5);
    border-radius: var(--radius-xl);
    margin: var(--space-6) 0;
    border: 2px solid var(--success-200);
    position: relative;
    overflow: hidden;
    text-align: center;
}

.points-container::before {
    content: '';
    position: absolute;
    top: -20px;
    right: -20px;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, var(--primary-300) 0%, transparent 70%);
    opacity: 0.3;
    border-radius: 50%;
}

.points-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    background: linear-gradient(135deg, var(--primary-500), var(--accent-500));
    color: var(--white);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-3);
    box-shadow: var(--shadow-sm);
}

.points-text {
    font-weight: var(--font-weight-bold);
    color: var(--success-700);
    font-size: var(--text-2xl);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
}

.points-icon {
    font-size: var(--text-xl);
    color: var(--warning-500);
}

/* ===== VARIABLES CSS ===== */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --warning-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    --error-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    
    --dark-bg: #1a202c;
    --darker-bg: #0f1419;
    --card-bg: rgba(255, 255, 255, 0.95);
    --text-primary: #2d3748;
    --text-secondary: #718096;
    --text-light: #e2e8f0;
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    
    --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-large: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-fast: all 0.15s ease;
    --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===== CONTENEDOR PRINCIPAL ===== */
.cart-section {
    background: var(--card-bg);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-large);
    padding: 1.5rem;
    margin: 1rem 0;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.cart-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
    z-index: 1;
}

/* ===== ENCABEZADO ===== */
.cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-light);
}

.cart-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.cart-title i {
    color: #667eea;
}

.cart-subtitle {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin: 0;
}

/* ===== ITEMS DEL CARRITO ===== */
.cart-items {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
    margin-bottom: 1.5rem;
}

.cart-item {
    display: grid;
    grid-template-columns: 60px 1fr auto auto;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    background: white;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
    transition: var(--transition);
    position: relative;
    animation: slideInUp 0.4s ease-out;
}

.cart-item:nth-child(1) { animation-delay: 0.1s; }
.cart-item:nth-child(2) { animation-delay: 0.2s; }
.cart-item:nth-child(3) { animation-delay: 0.3s; }
.cart-item:nth-child(4) { animation-delay: 0.4s; }

.cart-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: #667eea;
}

.cart-item.removing {
    animation: slideOutRight 0.4s ease-in-out forwards;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideOutRight {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100%);
    }
}

/* ===== MINIATURAS ===== */
.item-thumbnail-container {
    position: relative;
    width: 50px;
    height: 50px;
    border-radius: var(--radius-md);
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    flex-shrink: 0;
}

.item-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
    background: var(--primary-gradient);
}

.cart-item:hover .item-thumbnail {
    transform: scale(1.1);
}

.item-thumbnail.fallback {
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.8rem;
}

.item-thumbnail.fallback::before {
    content: 'DL';
}

.quantity-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--secondary-gradient);
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
    border: 2px solid white;
    box-shadow: var(--shadow-soft);
    z-index: 2;
    transition: var(--transition);
}

.quantity-badge.high-quantity {
    background: var(--warning-gradient);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1);
        box-shadow: var(--shadow-soft);
    }
    50% { 
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
    }
}

/* ===== INFORMACIÓN DEL PRODUCTO ===== */
.item-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 0;
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.95rem;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
}

.item-details {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

.item-price {
    font-weight: 700;
    color: #667eea;
    font-size: 0.9rem;
    background: rgba(102, 126, 234, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
}

.item-unit-price {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.item-points {
    background: var(--success-gradient);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

/* ===== CONTROLES DE CANTIDAD ===== */
.cart-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f7fafc;
    padding: 0.5rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    flex-shrink: 0;
}

.quantity-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    color: white;
    flex-shrink: 0;
}

.quantity-btn:active {
    transform: scale(0.9);
}

.quantity-btn.decrease {
    background: #e53e3e;
}

.quantity-btn.decrease:hover {
    background: #c53030;
    box-shadow: var(--shadow-soft);
}

.quantity-btn.increase {
    background: #38a169;
}

.quantity-btn.increase:hover {
    background: #2f855a;
    box-shadow: var(--shadow-soft);
}

.quantity-display {
    min-width: 30px;
    text-align: center;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
    background: white;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--border-light);
    transition: var(--transition);
}

/* ===== BOTÓN ELIMINAR ===== */
.remove-btn {
    background: #718096;
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    cursor: pointer;
    transition: var(--transition);
    margin-left: 0.25rem;
    flex-shrink: 0;
}

.remove-btn:active {
    transform: scale(0.9);
}

.remove-btn:hover {
    background: #4a5568;
    box-shadow: var(--shadow-soft);
}

/* ===== RESUMEN DEL CARRITO ===== */
.cart-summary {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: #f7fafc;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding: 0.5rem 0;
}

.summary-row:last-child {
    margin-bottom: 0;
}

.summary-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
}

.summary-value {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.points-summary {
    background: var(--success-gradient);
    color: white;
    padding: 1rem;
    border-radius: var(--radius-lg);
    margin: 1rem 0;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.points-summary::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
}

.points-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 1;
}

.points-text {
    font-size: 1.25rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    position: relative;
    z-index: 1;
}

.points-icon {
    color: rgba(255, 255, 255, 0.9);
}

/* ===== SECCIÓN TOTAL ===== */
.total-section {
    background: var(--dark-bg);
    color: white;
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    margin: 1rem 0;
    position: relative;
    overflow: hidden;
}

.total-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--primary-gradient);
    opacity: 0.9;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
}

.total-label {
    font-size: 1.1rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
}

.total-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* ===== BOTONES DE ACCIÓN ===== */
.cart-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.cart-action-btn {
    flex: 1;
    min-width: 120px;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-medium);
    background: white;
    color: var(--text-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
    border: none;
}

.cart-action-btn:hover {
    background: #f7fafc;
    border-color: var(--border-light);
    transform: translateY(-1px);
}

.cart-action-btn.danger {
    background: #fed7d7;
    color: #c53030;
    border-color: #feb2b2;
}

.cart-action-btn.danger:hover {
    background: #feb2b2;
    color: #9b2c2c;
}

/* ===== BOTÓN DE PAGO ===== */
.payment-method {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    background: var(--secondary-gradient);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: var(--transition);
    margin-top: 1rem;
    text-decoration: none;
    width: 100%;
    box-sizing: border-box;
}

.payment-method:active {
    transform: scale(0.98);
}

.payment-method:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.payment-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.payment-icon {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.payment-text-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.payment-text {
    font-weight: 600;
    font-size: 1rem;
    color: white;
}

.payment-subtext {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.8);
}

.payment-arrow {
    font-size: 1.2rem;
    opacity: 0.8;
    flex-shrink: 0;
}

/* ===== ESTADO VACÍO ===== */
.cart-empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-secondary);
}

.cart-empty-icon {
    font-size: 3rem;
    color: #cbd5e0;
    margin-bottom: 1rem;
    opacity: 0.7;
}

.cart-empty-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.cart-empty-subtext {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

/* ===== NOTIFICACIONES ===== */
.cart-notification {
    position: fixed;
    top: 100px;
    right: 20px;
    background: var(--success-gradient);
    color: white;
    padding: 12px 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    z-index: 10000;
    transform: translateX(400px);
    transition: var(--transition-slow);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 300px;
}

.cart-notification.show {
    transform: translateX(0);
}

.cart-notification .notification-content {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}

.cart-notification i {
    font-size: 1.2em;
}

.cart-notification.success {
    background: var(--success-gradient);
}

.cart-notification.error {
    background: var(--error-gradient);
}

.cart-notification.warning {
    background: var(--warning-gradient);
}

.cart-notification.info {
    background: var(--primary-gradient);
}

/* ===== SCROLLBAR ===== */
.cart-items::-webkit-scrollbar {
    width: 6px;
}

.cart-items::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.cart-items::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.cart-items::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* ===== RESPONSIVE - TABLETS ===== */
@media (max-width: 768px) {
    .cart-section {
        padding: 1.25rem;
        margin: 0.75rem 0;
        border-radius: var(--radius-lg);
    }
    
    .cart-item {
        grid-template-columns: 50px 1fr auto;
        gap: 0.75rem;
        padding: 0.75rem;
        min-height: 70px;
    }
    
    .cart-controls {
        grid-column: unset;
        justify-content: flex-end;
        margin-top: 0;
        padding: 0.4rem;
        gap: 0.4rem;
        background: #f8fafc;
        border-radius: var(--radius-sm);
        min-width: fit-content;
    }
    
    .quantity-btn {
        width: 28px;
        height: 28px;
        min-width: 28px;
        font-size: 0.8rem;
    }
    
    .remove-btn {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
        margin-left: 0.2rem;
    }
    
    .quantity-display {
        min-width: 25px;
        font-size: 0.8rem;
        padding: 0.2rem 0.4rem;
    }
    
    .item-info {
        min-width: 0;
        padding-right: 0.5rem;
    }
    
    .item-name {
        font-size: 0.85rem;
    }
    
    .item-details {
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .item-price {
        font-size: 0.8rem;
        padding: 0.15rem 0.5rem;
    }
    
    .item-unit-price {
        font-size: 0.7rem;
    }
    
    .item-points {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
    }
    
    .item-thumbnail-container {
        width: 45px;
        height: 45px;
    }
    
    .quantity-badge {
        width: 18px;
        height: 18px;
        font-size: 0.6rem;
        top: -4px;
        right: -4px;
    }
    
    .cart-summary {
        padding: 1.25rem;
        margin-top: 1.25rem;
    }
    
    .total-section {
        padding: 1.25rem;
    }
    
    .total-amount {
        font-size: 1.3rem;
    }
    
    .payment-method {
        padding: 0.875rem 1.25rem;
    }
    
    .cart-actions {
        gap: 0.5rem;
    }
    
    .cart-action-btn {
        min-width: 100px;
        padding: 0.625rem 0.875rem;
        font-size: 0.8rem;
    }
}

/* ===== RESPONSIVE - MÓVILES PEQUEÑOS ===== */
@media (max-width: 480px) {
    .cart-section {
        padding: 1rem;
        margin: 0.5rem;
        border-radius: var(--radius-md);
    }
    
    .cart-header {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
    }
    
    .cart-title {
        font-size: 1.25rem;
    }
    
    .cart-item {
        grid-template-columns: 40px 1fr auto;
        gap: 0.5rem;
        padding: 0.6rem;
    }
    
    .item-thumbnail-container {
        width: 40px;
        height: 40px;
    }
    
    .item-thumbnail {
        border-radius: var(--radius-sm);
    }
    
    .cart-controls {
        padding: 0.3rem;
        gap: 0.3rem;
    }
    
    .quantity-btn {
        width: 26px;
        height: 26px;
        min-width: 26px;
        font-size: 0.75rem;
    }
    
    .remove-btn {
        width: 26px;
        height: 26px;
        font-size: 0.75rem;
    }
    
    .quantity-display {
        min-width: 22px;
        font-size: 0.75rem;
        padding: 0.15rem 0.3rem;
    }
    
    .item-name {
        font-size: 0.8rem;
    }
    
    .item-details {
        gap: 0.3rem;
    }
    
    .item-price {
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
    }
    
    .item-unit-price {
        font-size: 0.65rem;
    }
    
    .item-points {
        font-size: 0.6rem;
        padding: 0.1rem 0.3rem;
    }
    
    .cart-summary {
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .summary-row {
        margin-bottom: 0.5rem;
    }
    
    .points-summary {
        padding: 0.75rem;
        margin: 0.75rem 0;
    }
    
    .total-section {
        padding: 1rem;
        margin: 0.75rem 0;
    }
    
    .total-amount {
        font-size: 1.3rem;
    }
    
    .payment-method {
        padding: 0.875rem 1rem;
        margin-top: 0.75rem;
    }
    
    .payment-icon {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
    }
    
    .payment-text {
        font-size: 0.9rem;
    }
    
    .cart-actions {
        flex-direction: column;
    }
    
    .cart-action-btn {
        min-width: auto;
        width: 100%;
    }
}

/* ===== RESPONSIVE - MÓVILES MUY PEQUEÑOS ===== */
@media (max-width: 360px) {
    .cart-item {
        grid-template-columns: 35px minmax(0, 1fr) auto;
        gap: 0.4rem;
        padding: 0.5rem;
    }
    
    .item-thumbnail-container {
        width: 35px;
        height: 35px;
    }
    
    .quantity-badge {
        width: 16px;
        height: 16px;
        font-size: 0.55rem;
        top: -3px;
        right: -3px;
    }
    
    .cart-controls {
        padding: 0.25rem;
        gap: 0.25rem;
    }
    
    .quantity-btn {
        width: 24px;
        height: 24px;
        min-width: 24px;
        font-size: 0.7rem;
    }
    
    .remove-btn {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
    }
    
    .quantity-display {
        min-width: 20px;
        font-size: 0.7rem;
        padding: 0.1rem 0.25rem;
    }
    
    .item-name {
        font-size: 0.75rem;
    }
    
    .item-details {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.2rem;
    }
    
    .item-price,
    .item-unit-price,
    .item-points {
        font-size: 0.65rem;
    }
}

/* ===== OPTIMIZACIONES TÁCTILES ===== */
@media (hover: none) and (pointer: coarse) {
    .quantity-btn,
    .remove-btn {
        min-width: 44px;
        min-height: 44px;
    }
    
    .cart-controls {
        padding: 0.5rem;
    }
    
    .cart-item {
        min-height: 80px;
    }
    
    .quantity-btn:active,
    .remove-btn:active,
    .payment-method:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
    }
}

/* ===== MEJORAS DE ACCESIBILIDAD ===== */
@media (prefers-reduced-motion: reduce) {
    .cart-item,
    .quantity-btn,
    .remove-btn,
    .payment-method {
        transition: none;
        animation: none;
    }
}

/* ===== MODO OSCURO ===== */
@media (prefers-color-scheme: dark) {
    .cart-item {
        background: #2d3748;
        border-color: #4a5568;
    }
    
    .item-name {
        color: #e2e8f0;
    }
    
    .item-unit-price {
        color: #a0aec0;
    }
    
    .cart-controls {
        background: #1a202c;
        border-color: #4a5568;
    }
    
    .quantity-display {
        background: #2d3748;
        color: #e2e8f0;
        border-color: #4a5568;
    }
    
    .cart-summary {
        background: #2d3748;
        border-color: #4a5568;
    }
    
    .summary-label {
        color: #a0aec0;
    }
    
    .summary-value {
        color: #e2e8f0;
    }
    
    .cart-action-btn {
        background: #2d3748;
        color: #e2e8f0;
        border-color: #4a5568;
    }
    
    .cart-action-btn:hover {
        background: #374151;
    }
}
/* Toast System */
.toast {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    color: var(--text-primary);
}

.toast-body {
    padding: var(--space-4);
    color: var(--text-primary);
}

.toast.bg-primary { 
    background: var(--primary-600) !important; 
    color: var(--white);
    border: none;
}

.toast.bg-success { 
    background: var(--success-600) !important; 
    color: var(--white);
    border: none;
}

.toast.bg-danger { 
    background: var(--error-600) !important; 
    color: var(--white);
    border: none;
}

.toast.bg-warning { 
    background: var(--warning-600) !important; 
    color: var(--white);
    border: none;
}

/* Floating Action Buttons */
.floating-buttons-container {
    position: fixed;
    bottom: var(--space-8);
    right: var(--space-8);
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.floating-button {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-xl);
    color: var(--white);
    font-size: var(--text-xl);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-lg);
    border: none;
    transition: var(--transition-normal);
    text-decoration: none;
    position: relative;
    cursor: pointer;
}

.floating-button:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-xl);
}

#floatingCartButton {
    background: var(--primary-600);
}

#whatsappButton {
    background: var(--success-600);
}

#floatingShareButton {
    background: var(--accent-600);
}

.floating-cart-count {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--error-600);
    color: var(--white);
    font-size: var(--text-xs);
    font-weight: var(--font-weight-bold);
    padding: 2px 6px;
    border-radius: 20px;
    border: 2px solid var(--bg-primary);
    min-width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.floating-button.clicked-animation {
    animation: fabPulse 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

@keyframes fabPulse {
    0% {
        transform: scale(1);
        box-shadow: var(--shadow-lg);
    }
    50% {
        transform: scale(0.9);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    100% {
        transform: scale(1);
        box-shadow: var(--shadow-lg);
    }
}

/* Footer */
.footer-custom {
    background: var(--bg-primary);
    border-top: 1px solid var(--border-primary);
    color: var(--text-secondary);
    margin-top: auto;
    padding: var(--space-8) 0;
}

.footer-avatar {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: var(--radius-xl);
    border: 3px solid var(--primary-500);
}

.footer-name {
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin: var(--space-2) 0;
}

.footer-link {
    color: var(--text-secondary);
    text-decoration: none;
    transition: var(--transition-fast);
    display: inline-block;
    margin-bottom: var(--space-2);
}

.footer-link:hover {
    color: var(--primary-600);
    transform: translateX(2px);
    text-decoration: none;
}

.social-icons .social-icon-link {
    font-size: var(--text-xl);
    color: var(--text-muted);
    transition: var(--transition-fast);
    text-decoration: none;
}

.social-icons .social-icon-link:hover {
    color: var(--primary-600);
    transform: translateY(-2px);
    text-decoration: none;
}

.footer-refresh-btn {
    width: 36px;
    height: 36px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 50%;
    color: var(--text-muted);
    transition: var(--transition-fast);
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.footer-refresh-btn:hover {
    color: var(--primary-600);
    background: var(--primary-50);
    border-color: var(--primary-500);
}

/* Loading States */
.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.loading-spinner.show {
    display: flex;
}

.luxury-spinner-inner {
    border: 3px solid var(--border-primary);
    border-top: 3px solid var(--primary-600);
    border-radius: 50%;
    width: 48px;
    height: 48px;
    animation: spin 1s linear infinite;
}

.luxury-spinner-text {
    margin-top: var(--space-4);
    color: var(--white);
    font-weight: var(--font-weight-medium);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Alert System */
.alert {
    padding: var(--space-4) var(--space-5);
    border-radius: var(--radius-lg);
    border-left: 4px solid;
    background: var(--bg-primary);
    margin-bottom: var(--space-4);
}

.alert-info {
    border-left-color: var(--primary-500);
    background: var(--primary-50);
    color: var(--primary-700);
}

.alert-success {
    border-left-color: var(--success-500);
    background: var(--success-50);
    color: var(--success-700);
}

.alert-warning {
    border-left-color: var(--warning-500);
    background: var(--warning-50);
    color: var(--warning-700);
}

.alert-danger {
    border-left-color: var(--error-500);
    background: var(--error-50);
    color: var(--error-700);
}

/* Guest Prompt */
#guest-prompt {
    background: linear-gradient(135deg, var(--primary-50), var(--accent-50));
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    text-align: center;
    margin-bottom: var(--space-8);
    box-shadow: var(--shadow-sm);
}

#guest-prompt h4 {
    color: var(--primary-700);
    margin-bottom: var(--space-4);
}

#guest-prompt .lead {
    color: var(--text-secondary);
    font-size: var(--text-lg);
    margin-bottom: var(--space-4);
}

/* Quick Navigation */
#quick-nav-buttons {
    position: fixed;
    bottom: 140px;
    right: var(--space-8);
    z-index: 99;
    display: none;
    flex-direction: column;
    gap: var(--space-2);
}

.quick-nav-btn {
    width: 40px;
    height: 40px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--primary-600);
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: var(--transition-fast);
    box-shadow: var(--shadow-sm);
}

.quick-nav-btn:hover {
    background: var(--primary-600);
    color: var(--white);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

/* Auth Modal Tabs */
#authModal .nav-tabs {
    border-bottom: 1px solid var(--border-primary);
    margin-bottom: var(--space-6);
}

#authModal .nav-tabs .nav-link {
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-secondary);
    padding: var(--space-3) var(--space-4);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
}

#authModal .nav-tabs .nav-link:hover {
    border-bottom-color: var(--border-secondary);
    color: var(--text-primary);
}

#authModal .nav-tabs .nav-link.active {
    border-bottom-color: var(--primary-600);
    color: var(--primary-600);
    background: transparent;
}

#authModal .tab-content {
    padding-top: var(--space-4);
}

/* Help Modal Accordion */
.accordion-item {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-3);
    overflow: hidden;
}

.accordion-button {
    background: var(--bg-primary);
    color: var(--text-primary);
    border: none;
    padding: var(--space-4) var(--space-5);
    font-weight: var(--font-weight-medium);
    transition: var(--transition-fast);
}

.accordion-button:not(.collapsed) {
    background: var(--primary-50);
    color: var(--primary-700);
    box-shadow: none;
}

.accordion-button:focus {
    border-color: var(--primary-500);
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.accordion-body {
    background: var(--bg-primary);
    color: var(--text-secondary);
    padding: var(--space-4) var(--space-5);
    border-top: 1px solid var(--border-primary);
}

/* Download App Banner */
#downloadAppBanner {
    background: var(--bg-primary) !important;
    border-top: 3px solid var(--primary-500);
    box-shadow: var(--shadow-lg);
    padding: var(--space-4) 0;
    position: fixed;
    bottom: 0;
    width: 100%;
    z-index: 1040;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 0 var(--space-4);
    }
    
    .navbar-brand {
        font-size: var(--text-lg);
    }
    
    .navbar-nav {
        gap: var(--space-1);
    }
    
    .nav-link {
        padding: var(--space-2);
        font-size: var(--text-sm);
    }
    
    .card-body {
        padding: var(--space-4);
    }
    
    .floating-buttons-container {
        bottom: var(--space-6);
        right: var(--space-6);
    }
    
    .floating-button {
        width: 52px;
        height: 52px;
        font-size: var(--text-lg);
    }
    
    #quick-nav-buttons {
        bottom: 120px;
        right: var(--space-6);
    }
    
    .nav-pills {
        flex-direction: column;
    }
    
    .nav-pills .nav-item {
        min-width: auto;
    }
}

@media (max-width: 576px) {
    main {
        padding-top: 70px;
    }
    
    .btn {
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-sm);
    }
    
    #vip-card-container {
        padding: var(--space-6);
        margin: var(--space-4) 0;
    }
    
    .floating-buttons-container {
        bottom: var(--space-4);
        right: var(--space-4);
    }
    
    .floating-button {
        width: 48px;
        height: 48px;
        font-size: var(--text-base);
    }
    
    .floating-cart-count {
        top: -2px;
        right: -2px;
        font-size: 10px;
        min-width: 18px;
        height: 18px;
    }
    
    .modal-body,
    .modal-header,
    .modal-footer {
        padding: var(--space-4);
    }
}

/* Utility Classes */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

.d-flex { display: flex; }
.d-none { display: none; }
.d-block { display: block; }
.d-inline-block { display: inline-block; }

.flex-column { flex-direction: column; }
.flex-wrap { flex-wrap: wrap; }
.align-items-center { align-items: center; }
.justify-content-center { justify-content: center; }
.justify-content-between { justify-content: space-between; }
.justify-content-end { justify-content: flex-end; }

.mt-1 { margin-top: var(--space-1); }
.mt-2 { margin-top: var(--space-2); }
.mt-3 { margin-top: var(--space-3); }
.mt-4 { margin-top: var(--space-4); }
.mt-6 { margin-top: var(--space-6); }
.mb-1 { margin-bottom: var(--space-1); }
.mb-2 { margin-bottom: var(--space-2); }
.mb-3 { margin-bottom: var(--space-3); }
.mb-4 { margin-bottom: var(--space-4); }
.mb-6 { margin-bottom: var(--space-6); }

.ms-1 { margin-left: var(--space-1); }
.ms-2 { margin-left: var(--space-2); }
.ms-3 { margin-left: var(--space-3); }
.ms-4 { margin-left: var(--space-4); }
.me-1 { margin-right: var(--space-1); }
.me-2 { margin-right: var(--space-2); }
.me-3 { margin-right: var(--space-3); }

.p-1 { padding: var(--space-1); }
.p-2 { padding: var(--space-2); }
.p-3 { padding: var(--space-3); }
.p-4 { padding: var(--space-4); }
.p-6 { padding: var(--space-6); }

.ps-2 { padding-left: var(--space-2); }
.ps-3 { padding-left: var(--space-3); }
.pe-2 { padding-right: var(--space-2); }
.pe-3 { padding-right: var(--space-3); }

.gap-2 { gap: var(--space-2); }
.gap-3 { gap: var(--space-3); }
.gap-4 { gap: var(--space-4); }

.w-100 { width: 100%; }
.h-100 { height: 100%; }

.position-relative { position: relative; }
.position-absolute { position: absolute; }
.position-fixed { position: fixed; }

.top-0 { top: 0; }
.bottom-0 { bottom: 0; }
.start-0 { left: 0; }
.end-0 { right: 0; }

.opacity-75 { opacity: 0.75; }
.opacity-50 { opacity: 0.5; }

.fw-bold { font-weight: var(--font-weight-bold); }
.fw-semibold { font-weight: var(--font-weight-semibold); }
.fw-medium { font-weight: var(--font-weight-medium); }
.fw-normal { font-weight: var(--font-weight-normal); }

.fs-5 { font-size: var(--text-lg); }
.fs-6 { font-size: var(--text-base); }

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: var(--gray-100);
}

::-webkit-scrollbar-thumb {
    background: var(--gray-400);
    border-radius: var(--radius-sm);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--gray-500);
}

/* Focus Management */
*:focus-visible {
    outline: 2px solid var(--primary-500);
    outline-offset: 2px;
}

/* Reduced Motion Support */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

</style>

</head>
<body id="top">
    <input type="file" id="avatarUploadInput" accept="image/jpeg, image/png, image/gif" style="display: none;">

    <nav class="navbar navbar-expand-sm navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#top">
                <img src="img/Logo-DL-Cumanayagua.png" alt="Doña Lucía Logo" style="height: 30px; margin-right: 8px;">
                DL Cumanayagua
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavContent" aria-controls="navbarNavContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavContent">
                <ul class="navbar-nav ms-auto mb-2 mb-sm-0 align-items-sm-center">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTabAndScroll('menu-tab-link')"><i class="bi bi-card-list me-1"></i>Menú</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTabAndScroll('rewards-tab-link')"><i class="bi bi-gift me-1"></i>Recompensas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTabAndScroll('my-orders-tab-link')"><i class="bi bi-receipt me-1"></i>Mis Envíos</a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal"><i class="bi bi-question-circle me-1"></i>Ayuda</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="moreOptionsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical me-1"></i>Más
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="moreOptionsDropdown">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#presentationVideoModal"><i class="bi bi-play-btn-fill me-2"></i>Ver Video Intro</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#sharePageModal"><i class="bi bi-share-fill me-2"></i>Compartir Página/App</a></li>
                            <li><hr class="dropdown-divider border-secondary"></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#downloadAppModal"><i class="bi bi-phone-vibrate-fill me-2"></i>Descargar App (Cuba)</a></li>
                        </ul>
                    </li>
                     <li class="nav-item d-block d-sm-none my-2">
                        <hr class="border-secondary">
                    </li>
                    <li class="nav-item d-flex align-items-center" id="auth-buttons-nav-container">
                        <div id="auth-buttons-nav" class="d-flex align-items-center">
                        </div>
                         <button id="logoutButtonNav" class="btn btn-sm btn-outline-warning ms-2" style="display:none;" onclick="logoutClient()"><i class="bi bi-box-arrow-right"></i> Salir</button>
                    </li>
                     <li class="nav-item ms-sm-2" id="cartNavItem" style="display: none !important;">
                        <button class="btn cart-nav-button p-0" type="button" data-bs-toggle="modal" data-bs-target="#cartModal">
                            <i class="bi bi-cart-fill"></i>
                            <span class="badge rounded-pill cart-count-nav" id="cart-count-nav">0</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <div class="container mt-5 pt-4 pb-5">
            <div id="vip-card-container" class="vip-card p-md-4 p-3 mb-4 position-relative animate__animated animate__fadeInDown" style="display: none;">
                <!-- Contenedor para centrar el contenido principal de la tarjeta -->
                <div class="vip-card-content-centered">
                    <span class="position-absolute top-0 start-0 m-3 badge" id="vip-status-badge">VIP</span>
                    <div class="position-relative d-inline-block">
                        <img id="user-avatar" src="./img/placeholder-avatar.png" alt="User Avatar" class="rounded-circle mb-2 shadow-sm" width="80" height="80" style="cursor:pointer; display:none;" title="Haz clic para cambiar tu avatar">
                        <button id="changeAvatarButton" class="btn btn-sm position-absolute bottom-0 end-0 mb-2 me-0 rounded-circle p-1 lh-1" title="Cambiar avatar" style="display:none; transform: translate(25%, 25%);">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                    </div>
                    <h2 class="mb-1 mt-2" id="client-name">¡Hola!</h2>
                    <p class="mb-1 opacity-75" id="client-status">Miembro DL</p>
                    <div class="points-display mb-2" id="client-points">0</div>
                    <small id="client-phone-display" class="text-light opacity-75 d-block"></small>
                    <div id="client-referral-code-container" class="mt-2" style="display: none;">
                        <small class="text-light opacity-75 d-block">Tu Código de Referido:</small>
                        <div class="d-flex align-items-center justify-content-center">
                            <strong id="clientReferralCode" class="text-warning fs-5 me-2">Cargando...</strong>
                            <button class="btn btn-sm btn-outline-light py-0 px-2" onclick="copyReferralCode()" title="Copiar código">
                                <i class="bi bi-clipboard-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

             <div id="guest-prompt" class="alert alert-info text-center shadow-sm animate__animated animate__fadeInUp" style="display: block;">
                <h4><i class="bi bi-gift-fill me-2"></i>¡Envía alegría a Cuba con DL Cumanayagua!</h4>
                <p class="lead mb-2">Compra para tus familiares y amigos en Cumanayagua desde cualquier parte del mundo. Paga fácilmente con Zelle.</p>
                <p>Inicia sesión o regístrate para gestionar tus envíos y acumular puntos para futuras compras.</p>
            </div>

            <ul class="nav nav-pills mb-4">
                <li class="nav-item" role="presentation"><a class="nav-link active" id="menu-tab-link" data-bs-toggle="pill" href="#menu-tab" role="tab" aria-controls="menu-tab" aria-selected="true"><i class="bi bi-card-list me-1"></i>Menú y Combos</a></li>
                <li class="nav-item" role="presentation"><a class="nav-link" id="rewards-tab-link" data-bs-toggle="pill" href="#rewards-tab" role="tab" aria-controls="rewards-tab" aria-selected="false"><i class="bi bi-gift me-1"></i>Recompensas</a></li>
                <li class="nav-item" role="presentation"><a class="nav-link" id="my-orders-tab-link" data-bs-toggle="pill" href="#my-orders-tab" role="tab" aria-controls="my-orders-tab" aria-selected="false"><i class="bi bi-receipt me-1"></i>Mis Envíos</a></li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="menu-tab" role="tabpanel" aria-labelledby="menu-tab-link">
                    <div class="d-flex justify-content-center align-items-center mb-4">
                        <h3 class="mb-0 me-3 text-center"><i class="bi bi-cup-straw me-2"></i>Menú y Combos para Enviar</h3>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshMenuButton" onclick="forceLoadMenuItems()" title="Actualizar menú">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>

                    <div id="popular-items-section" class="mb-5">
                        <h4 class="mb-3 text-center"><i class="bi bi-star-fill text-warning me-2"></i>¡Lo Más Pedido Hoy!</h4>
                        <div class="row g-3 g-md-4" id="popular-items-container">
                            <div class="col-12 text-center p-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div><span class="ms-2">Cargando populares...</span></div>
                        </div>
                        <hr class="my-4 border-secondary">
                    </div>

                    <div class="mb-4 position-relative">
                        <input type="text" id="productSearchInput" class="form-control form-control-lg" placeholder="Buscar productos por nombre..." aria-label="Buscar productos">
                        <button id="clearSearchButton" class="btn btn-sm position-absolute end-0 top-50 translate-middle-y me-2" style="display:none;" title="Limpiar búsqueda">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
                        <div id="filter-container" class="d-flex flex-wrap justify-content-center align-items-center">
                        </div>
                        <div class="ms-auto">
                            <select id="sortProductsSelect" class="form-select form-select-sm bg-dark text-light border-secondary" style="min-width: 200px;">
                                <option value="default" selected>Ordenar por...</option>
                                <option value="name-asc">Nombre (A-Z)</option>
                                <option value="name-desc">Nombre (Z-A)</option>
                                <option value="price-asc">Precio (Menor a Mayor)</option>
                                <option value="price-desc">Precio (Mayor a Menor)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 g-md-4" id="menu-container"><div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div></div>
                </div>
                <div class="tab-pane fade" id="rewards-tab" role="tabpanel" aria-labelledby="rewards-tab-link">
                    <div class="d-flex justify-content-center align-items-center mb-4">
                        <h3 class="mb-0 me-3 text-center"><i class="bi bi-stars me-2"></i>Recompensas para tus Envíos</h3>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshRewardsButton" onclick="forceLoadRewards()" title="Actualizar recompensas">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="row g-3 g-md-4" id="rewards-container"><div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div></div>
                </div>
                <div class="tab-pane fade" id="my-orders-tab" role="tabpanel" aria-labelledby="my-orders-tab-link">
                    <h3 class="mb-4 text-center"><i class="bi bi-clock-history me-2"></i>Historial de Envíos</h3>
                    <div id="orders-history-container"><div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tus envíos.</p></div></div>
                </div>
            </div>
        </div>
    </main>

    <div id="loadingSpinnerUser" class="loading-spinner">
      <div class="luxury-spinner">
        <div class="luxury-spinner-inner"></div>
        <span class="luxury-spinner-text">Cargando...</span>
      </div>
    </div>
    <div id="downloadAppBanner" class="fixed-bottom p-3 bg-dark text-light shadow-lg" style="z-index: 1040; display:none;">
        <div class="container d-flex justify-content-between align-items-center flex-wrap">
            <div class="me-3 mb-2 mb-md-0">
                <strong class="d-block fs-5"><i class="bi bi-star-fill me-1 text-warning"></i> ¡Nuestra App para facilitar tu compra en Cuba!</strong>
                <span class="small">Permite que gestiones tus pedidos y beneficios fácilmente.</span>
            </div>
            <div class="d-flex align-items-center">
                <a href="https://drive.google.com/file/d/1JN1qbrX2JB7P5apVzzhtBy5x2hBPxCWa/view?usp=drive_link" download="DonaLucia_Cumanayagua.apk" class="btn btn-warning btn-sm me-2 py-2">
                    <i class="bi bi-android2 me-1"></i> Descargar App
                </a>
                <button class="btn btn-outline-warning btn-sm me-3 py-2" onclick="shareAppLinkViaCopy()" title="Copiar enlace de descarga de la App">
                    <i class="bi bi-share-fill me-1"></i> Compartir App
                </button>
                <button type="button" class="btn-close btn-close-white" aria-label="Cerrar banner"></button>
            </div>
        </div>
    </div>
    <div class="toast-container position-fixed bottom-0 start-0 p-3" id="toastPlacement" style="z-index: 2050"> </div>

    <!-- INICIO MODAL DE AUTENTICACIÓN UNIFICADO -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalLabel">Acceso / Registro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs nav-fill mb-3" id="authTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="login-tab-btn" data-bs-toggle="tab" data-bs-target="#login-tab-pane" type="button" role="tab" aria-controls="login-tab-pane" aria-selected="true">
                                <i class="bi bi-box-arrow-in-right me-1"></i>Iniciar Sesión
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="register-tab-btn" data-bs-toggle="tab" data-bs-target="#register-tab-pane" type="button" role="tab" aria-controls="register-tab-pane" aria-selected="false">
                                <i class="bi bi-person-plus-fill me-1"></i>Crear Cuenta
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="authTabContent">
                        <div class="tab-pane fade show active" id="login-tab-pane" role="tabpanel" aria-labelledby="login-tab-btn" tabindex="0">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="loginPhone" class="form-label">Teléfono (Tuyo)</label>
                                    <input type="tel" class="form-control" id="loginPhone" required autocomplete="username tel">
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="loginPassword" required autocomplete="current-password">
                                </div>
                                <div id="login-feedback" class="mt-3 mb-3"></div>
                                <button type="button" class="btn btn-primary w-100" onclick="handleLoginAttempt()">Acceder</button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="register-tab-pane" role="tabpanel" aria-labelledby="register-tab-btn" tabindex="0">
                            <form id="newUserRegistrationForm">
                                <div class="mb-3">
                                    <label for="newUserName" class="form-label">Nombre Completo (Tuyo) <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newUserName" required autocomplete="name">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserPhone" class="form-label">Teléfono (Tuyo, con código de país si es de USA) <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="newUserPhone" required placeholder="Ej: +1 XXX XXX XXXX" autocomplete="tel">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserEmail" class="form-label">Correo (Tuyo) <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="newUserEmail" required autocomplete="email">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserPassword" class="form-label">Contraseña <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="newUserPassword" required autocomplete="new-password">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserConfirmPassword" class="form-label">Confirmar Contraseña <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="newUserConfirmPassword" required autocomplete="new-password">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserReferralCodeUsed" class="form-label">Código de Referido (Opcional)</label>
                                    <input type="text" class="form-control" id="newUserReferralCodeUsed" placeholder="Ingresa un código si tienes uno">
                                </div>
                                <div id="registration-feedback" class="mt-3 mb-3"></div>
                                <button type="button" class="btn btn-primary w-100" onclick="handleUserRegistrationAttempt()">Registrarme</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN MODAL DE AUTENTICACIÓN UNIFICADO -->

    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="cartModalLabel"><i class="bi bi-cart3 me-2"></i>Mi Carrito de Envío</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="cart-items-container"><p class="text-center">Tu carrito está vacío.</p></div><div class="modal-footer justify-content-between flex-wrap"><div id="cart-footer-info"><small class="text-muted d-block">Puntos a ganar: <span id="cart-points-to-earn" class="fw-bold">0</span></small><strong class="fs-5">Total: <span id="cart-total-price" style="color: var(--primary-color);">0.00</span> USD</strong><br><small class="text-warning"><i class="bi bi-credit-card-2-front-fill"></i> Pagos por Zelle.</small></div><div class="d-flex mt-2 mt-sm-0" id="cart-footer-buttons" style="display: none;"><button type="button" class="btn btn-outline-danger me-2" onclick="clearCart()"><i class="bi bi-trash3 me-1"></i>Vaciar</button><button type="button" class="btn btn-success" onclick="confirmAndPlaceOrder()"><i class="bi bi-check-circle me-1"></i>Confirmar Envío</button></div></div><div id="order-placement-feedback" class="m-3"></div></div></div></div>
    <div class="modal fade" id="downloadAppModal" tabindex="-1" aria-labelledby="downloadAppModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="downloadAppModalLabel"><i class="bi bi-phone-vibrate-fill me-2" style="color:var(--primary-color);"></i> ¡App para tu Familia en Cuba!</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body text-center"><img src="https://i.postimg.cc/XJxYzHZW/striking-app-icon-the-letters-dl-in-a-custom-l.png" alt="Doña Lucía App Icon" class="img-fluid rounded-circle mb-3 shadow" style="width: 100px; height: 100px; border: 3px solid var(--primary-color);">
            <p class="lead mb-2">Instala la App para que tu familia en Cuba pueda ver el menú, canjear puntos, obtener recompensas y estar al tanto de las novedades. ¡Una forma fácil de conectar!</p>
            <p><strong>Nota:</strong> Esta app es para que tus familiares en Cuba exploren. Las compras y pagos se realizan desde esta página web.</p>
            <a href="https://drive.google.com/file/d/1JN1qbrX2JB7P5apVzzhtBy5x2hBPxCWa/view?usp=drive_link" download="DonaLucia_Cumanayagua.apk" class="btn btn-primary btn-lg mt-3 w-100 animate__animated animate__pulse animate__infinite animate__slower">
                <i class="bi bi-android2 me-2"></i> Descargar para Android
            </a>
                <p class="mt-3 mb-1">
                    <small class="text-muted">Si su dispositivo lo solicita, deben habilitar "Instalar apps desconocidas" en Ajustes para poder instalarla.</small></p></div>
                    </div></div>
    </div>
    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title" id="productDetailModalLabel">Detalles del Producto</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body pt-0"><div class="row g-4"><div class="col-md-6"><img src="./img/placeholder-product.png" id="modal-product-image" class="img-fluid" alt="Imagen del producto"></div><div class="col-md-6 d-flex flex-column"><h2 id="modal-product-name" class="mb-2">Nombre del Producto</h2><p id="modal-product-description" class="text-muted flex-grow-1">Descripción detallada del producto...</p><div class="d-flex justify-content-between align-items-center mb-3"><span id="modal-product-price">USD 0.00</span><span class="badge bg-success" id="modal-product-points">+0 Puntos</span></div><div id="modal-add-to-cart-button-container" class="mb-4"></div><div id="modal-recommendations-container"></div></div></div></div></div></div>
    </div>

    <div class="modal fade" id="rewardDetailModal" tabindex="-1" aria-labelledby="rewardDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="rewardDetailModalLabel">Detalles de la Recompensa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="row g-4">
                    <div class="col-md-5">
                        <img src="./img/placeholder-product.png" id="modal-reward-image" class="img-fluid" alt="Imagen de la recompensa" style="aspect-ratio: 4 / 5; object-fit: cover; border-radius: 1rem; border: 2px solid var(--accent-color);">
                    </div>
                    <div class="col-md-7 d-flex flex-column">
                        <h2 id="modal-reward-name" class="mb-2" style="font-family: 'Playfair Display', serif; color: var(--accent-color);">Nombre de la Recompensa</h2>
                        <p id="modal-reward-description" class="text-muted">Descripción detallada de la recompensa...</p>
                        <div class="d-flex justify-content-between align-items-center my-3">
                            <span id="modal-reward-points-required" style="color: var(--accent-color); font-size: 1.75rem; font-weight: 700;">0 Puntos</span>
                            <span class="badge" id="modal-reward-stock-info"></span>
                        </div>
                        <div id="modal-redeem-reward-button-container" class="mb-3">
                            <!-- Botón de canje se insertará aquí -->
                        </div>
                        <hr class="border-secondary my-3">
                        <div id="modal-product-recommendations-for-reward-container">
                            <h5 class="text-light mb-3" style="font-weight: 600;"><i class="bi bi-hand-thumbs-up-fill me-2"></i>Productos que te podrían gustar:</h5>
                            <div id="reward-modal-product-recs-row" class="row g-2">
                                <!-- Recomendaciones de productos -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="modal fade" id="sharePageModal" tabindex="-1" aria-labelledby="sharePageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sharePageModalLabel"><i class="bi bi-share-fill me-2" style="color:var(--primary-color);"></i>Compartir</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <h6 class="text-light">Compartir esta Página Web:</h6>
                    <p class="mb-1 small text-muted">Para que otros puedan realizar compras y envíos.</p>
                    <div id="qrcodeCanvas" class="mx-auto mb-3 border border-secondary p-2 rounded" style="width: 150px; height: 150px; background-color: white;">
                    </div>
                    <div class="d-grid gap-2 mb-4">
                        <button class="btn btn-primary btn-sm" id="copyLinkButton">
                            <i class="bi bi-clipboard-check-fill me-2"></i>Copiar Enlace de Página
                        </button>
                        <a id="shareViaWhatsAppButton" class="btn btn-success btn-sm" href="#" target="_blank">
                            <i class="bi bi-whatsapp me-2"></i>Página por WhatsApp
                        </a>
                        <a id="shareViaTelegramButton" class="btn btn-info btn-sm text-dark" href="#" target="_blank">
                            <i class="bi bi-telegram me-2"></i>Página por Telegram
                        </a>
                    </div>

                    <hr style="border-color: rgba(255,255,255,0.2);">

                    <h6 class="text-light mt-3">Compartir la App (para familia en Cuba):</h6>
                    <p class="mb-1 small text-muted">Para que tus familiares en Cuba vean el catálogo.</p>
                     <div id="qrcodeAppCanvas" class="mx-auto mb-3 border border-secondary p-2 rounded" style="width: 150px; height: 150px; background-color: white;">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" onclick="shareAppLinkViaCopy()">
                            <i class="bi bi-clipboard-check-fill me-2"></i>Copiar Enlace de App
                        </button>
                        <a id="shareAppViaWhatsAppButtonModal" class="btn btn-success btn-sm" href="#" target="_blank">
                            <i class="bi bi-whatsapp me-2"></i>App por WhatsApp
                        </a>
                         <a id="shareAppViaTelegramButtonModal" class="btn btn-info btn-sm text-dark" href="#" target="_blank">
                            <i class="bi bi-telegram me-2"></i>App por Telegram
                        </a>
                    </div>
                    <small class="d-block mt-3 text-muted">Muestra los códigos QR para escanear directamente.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmClearCartModal" tabindex="-1" aria-labelledby="confirmClearCartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmClearCartModalLabel"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirmar Acción</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres vaciar completamente tu carrito de envío? Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmClearCartButton">
                        <i class="bi bi-trash3-fill me-1"></i>Sí, Vaciar Carrito
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmRedeemRewardModal" tabindex="-1" aria-labelledby="confirmRedeemRewardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmRedeemRewardModalLabel"><i class="bi bi-patch-check-fill text-warning me-2"></i>Confirmar Canje de Recompensa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmRedeemRewardText">¿Estás seguro de que quieres canjear esta recompensa?</p>
                    <div id="redeemRewardFeedback" class="mt-3"></div>
                </div>
                <div class="modal-footer" id="confirmRedeemRewardFooter">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="confirmRedeemRewardButton">
                        <i class="bi bi-award-fill me-1"></i>Sí, Canjear Ahora
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="presentationVideoModal" tabindex="-1" aria-labelledby="presentationVideoModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-xl" id="presentationVideoDialog">
            <div class="modal-content" id="presentationVideoContent" style="background-color: transparent; border: none; box-shadow: none;">
                <div class="modal-header border-0 position-absolute top-0 end-0" style="z-index: 10;">
                     <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="closePresentationVideoModal" style="background-color: rgba(0,0,0,0.5); border-radius:50%; padding:0.5em;"></button>
                </div>
                <div class="modal-body p-0" id="presentationVideoBody">
                    <video id="introVideo" width="100%" height="auto" controls autoplay muted playsinline preload="auto">
                        <source src="./Dl%20Cumanayagua%20Logo%20reveal.mp4" type="video/mp4">
                        Tu navegador no soporta la etiqueta de video.
                    </video>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel"><i class="bi bi-question-circle-fill me-2" style="color:var(--primary-color);"></i>Ayuda y Cómo Funciona DL Cumanayagua</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="lead">¡Bienvenido a DL Cumanayagua! Aquí te explicamos cómo funciona nuestra plataforma para que puedas enviar productos y cariño a tus seres queridos en Cumanayagua, Cuba, de forma fácil y segura.</p>

                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOneHelp">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOneHelp" aria-expanded="true" aria-controls="collapseOneHelp">
                                    <i class="bi bi-person-circle me-2"></i>Tu Cuenta (Cliente Comprador)
                                </button>
                            </h2>
                            <div id="collapseOneHelp" class="accordion-collapse collapse show" aria-labelledby="headingOneHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>Esta página web es para ti, el cliente que realiza la compra desde fuera de Cuba (ej. USA) para enviar a Cumanayagua.</p>
                                    <ul>
                                        <li><strong>Registro e Inicio de Sesión:</strong> Crea una cuenta o inicia sesión con tu número de teléfono, correo y contraseña. Esto te permitirá guardar tu historial de envíos, acumular puntos y acceder a recompensas.</li>
                                        <li><strong>Información Personal:</strong> Tu nombre, teléfono y correo son para gestionar tus pedidos y comunicarnos contigo.</li>

                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwoHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwoHelp" aria-expanded="false" aria-controls="collapseTwoHelp">
                                   <i class="bi bi-card-list me-2"></i> Menú y Combos (Realizar un Envío)
                                </button>
                            </h2>
                            <div id="collapseTwoHelp" class="accordion-collapse collapse" aria-labelledby="headingTwoHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>Explora nuestro catálogo de productos y combos disponibles para enviar.</p>
                                    <ul>
                                        <li><strong>Añadir al Carrito:</strong> Selecciona los productos que deseas enviar y añádelos a tu carrito de envío.</li>
                                        <li><strong>Ver Detalles:</strong> Haz clic en la imagen de un producto para ver más detalles, descripción y recomendaciones.</li>
                                        <li><strong>Carrito de Envío:</strong> Revisa tu selección, ajusta cantidades y ve el total en USD.</li>
                                        <li><strong>Confirmar Envío:</strong> Una vez listo, confirma tu envío. Se generará un número de pedido.</li>
                                        <li><strong>Pago con Zelle:</strong> Tras confirmar, te proporcionaremos instrucciones para realizar el pago mediante Zelle. Deberás notificarnos por WhatsApp una vez realizado el pedido para coordinar el pago.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThreeHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThreeHelp" aria-expanded="false" aria-controls="collapseThreeHelp">
                                    <i class="bi bi-star-fill me-2"></i>Puntos y Recompensas
                                </button>
                            </h2>
                            <div id="collapseThreeHelp" class="accordion-collapse collapse" aria-labelledby="headingThreeHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>¡Premiamos tu fidelidad!</p>
                                    <ul>
                                        <li><strong>Acumular Puntos:</strong> Con cada compra que realices (y una vez confirmado el pago), acumularás puntos en tu cuenta. La cantidad de puntos por producto se indica en el menú.</li>
                                        <li><strong>Ver tus Puntos:</strong> El total de tus puntos disponibles se muestra en tu tarjeta VIP al iniciar sesión.</li>
                                        <li><strong>Sección Recompensas:</strong> Aquí encontrarás productos o beneficios especiales que puedes canjear utilizando tus puntos acumulados.</li>
                                        <li><strong>Canjear Recompensas:</strong> Si tienes suficientes puntos, podrás canjear una recompensa. Esta se aplicará a un futuro envío o según se especifique. Deberás notificarnos por WhatsApp al canjear para coordinar.</li>
                                        <li><strong>Puntos de Bienvenida:</strong> Actualmente, no se otorgan puntos de bienvenida al registrarse. Los puntos se ganan a través de las compras. (Excepción: Ver Programa de Referidos).</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFourHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFourHelp" aria-expanded="false" aria-controls="collapseFourHelp">
                                    <i class="bi bi-receipt-cutoff me-2"></i>Mis Envíos
                                </button>
                            </h2>
                            <div id="collapseFourHelp" class="accordion-collapse collapse" aria-labelledby="headingFourHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>En esta sección podrás ver un historial de todos los envíos que has realizado, su estado (Pendiente, Procesado, Entregado, Cancelado), los productos incluidos y los puntos otorgados.</p>
                                </div>
                            </div>
                        </div>
                         <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFiveHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiveHelp" aria-expanded="false" aria-controls="collapseFiveHelp">
                                    <i class="bi bi-phone-fill me-2"></i>App DL Cumanayagua (Para tu familia en Cuba)
                                </button>
                            </h2>
                            <div id="collapseFiveHelp" class="accordion-collapse collapse" aria-labelledby="headingFiveHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>Ofrecemos una aplicación Android (.apk) que puedes descargar y compartir con tus familiares en Cumanayagua.</p>
                                    <ul>
                                        <li><strong>Propósito de la App:</strong> Esta app permite a tus seres queridos en Cuba ver el catálogo de productos y las recompensas disponibles. Así, pueden decirte qué les gustaría recibir.</li>
                                        <li><strong>¿Cómo Compartirla?:</strong> Puedes usar los botones de "Compartir Página/App" en el menú superior o el botón flotante <i class="bi bi-share-fill"></i> para obtener enlaces de descarga y QR.</li>
                                        <li><strong>Instalación:</strong> Deberán descargar el archivo .apk e instalarlo en su teléfono Android. Es posible que necesiten habilitar "Instalar apps desconocidas" en los ajustes de su teléfono.</li>
                                        <li><strong>Importante:</strong> La app es solo para visualización. Las compras, pagos y gestión de tu cuenta de cliente (acumulación de puntos, etc.) se realizan siempre a través de esta página web por ti, el comprador.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSixHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSixHelp" aria-expanded="false" aria-controls="collapseSixHelp">
                                    <i class="bi bi-person-hearts me-2"></i>Programa de Referidos
                                </button>
                            </h2>
                            <div id="collapseSixHelp" class="accordion-collapse collapse" aria-labelledby="headingSixHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>¡Invita a tus amigos y ambos ganan!</p>
                                    <ul>
                                        <li><strong>Tu Código de Referido:</strong> Cuando inicias sesión, verás tu código de referido personal en tu tarjeta VIP. Compártelo con amigos que quieran hacer envíos a Cumanayagua.</li>
                                        <li><strong>Para tus Amigos (Nuevos Clientes):</strong> Al registrarse, tu amigo puede ingresar tu código de referido en el campo "Código de Referido". Si el código es válido, tu amigo recibirá <strong>15 puntos extra</strong> de bienvenida.</li>
                                        <li><strong>Para Ti (Quien Refiere):</strong> Cuando tu amigo se registra exitosamente usando tu código, tú recibirás <strong>25 puntos</strong> como agradecimiento.</li>
                                        <li>Los puntos se añaden automáticamente a sus respectivas cuentas.</li>
                                    </ul>
                                    <p class="small text-muted">Nota: Los puntos y condiciones del programa de referidos pueden cambiar.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="mt-4">Si tienes más preguntas, no dudes en contactarnos a través del botón de WhatsApp flotante. ¡Estamos para ayudarte!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- INICIO: NUEVO MODAL PARA MENSAJE GLOBAL -->
    <div class="modal fade" id="globalMessageModal" tabindex="-1" aria-labelledby="globalMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalMessageModalTitle">
                        <i class="bi bi-info-circle-fill me-2" style="color:var(--primary-color);"></i>
                        Anuncio Importante
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="globalMessageModalBody">
                    <p>Cargando mensaje...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN: NUEVO MODAL PARA MENSAJE GLOBAL -->


    <div class="floating-buttons-container">
        <a id="whatsappButton" href="https://wa.me/5355189657?text=Hola,%20tengo%20una%20consulta%20sobre%20DL%20Cumanayagua." class="floating-button" target="_blank" title="Chatea con nosotros">
            <i class="bi bi-whatsapp"></i>
        </a>
        <button id="floatingCartButton" class="floating-button" type="button" data-bs-toggle="modal" data-bs-target="#cartModal" style="display: none;" title="Ver Carrito de Envío">
            <i class="bi bi-cart3"></i>
            <span class="floating-cart-count" id="floating-cart-count">0</span>
        </button>
        <button id="floatingShareButton" class="floating-button" type="button" data-bs-toggle="modal" data-bs-target="#sharePageModal" title="Compartir esta página" style="background: linear-gradient(145deg, #5D3FD3, #8A2BE2);">
            <i class="bi bi-share-fill"></i>
        </button>
    </div>

    <div id="quick-nav-buttons">
        <a href="#top" class="quick-nav-btn" title="Ir arriba"><i class="bi bi-arrow-up"></i></a>
        <a href="#bottom" id="go-down-btn" class="quick-nav-btn" title="Ir abajo"><i class="bi bi-arrow-down"></i></a>
    </div>

    <footer id="bottom" class="footer-custom pt-5 pb-4">
        <div class="container text-center text-md-start">
            <div class="row gy-4">
                <div class="col-lg-4 col-md-12 mb-4 mb-md-0">
                    <div class="d-flex align-items-center justify-content-center justify-content-md-start mb-3">
                         <img src="https://i.postimg.cc/rsFSGFt2/Generated-Image-June-11-2025-1-22-AM.jpg" alt="Erick Olivera" class="footer-avatar me-3">
                         <div>
                            <h5 class="text-uppercase fw-bold mb-1" style="color: var(--primary-color);">DL Cumanayagua</h5>
                            <p class="footer-name mb-0">Erick Olivera</p>
                         </div>
                    </div>
                    <p class="small text-muted">
                        Tu conexión directa para enviar productos y cariño a tus seres queridos en Cumanayagua. Fácil, rápido y seguro.
                    </p>
                </div>
                <div class="col-lg-2 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Navegación</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" onclick="showTabAndScroll('menu-tab-link'); return false;" class="footer-link">Menú</a></li>
                        <li><a href="#" onclick="showTabAndScroll('rewards-tab-link'); return false;" class="footer-link">Recompensas</a></li>
                        <li><a href="#" onclick="showTabAndScroll('my-orders-tab-link'); return false;" class="footer-link">Mis Envíos</a></li>
                        <li><a href="#" data-bs-toggle="modal" data-bs-target="#downloadAppModal" class="footer-link">App para Cuba</a></li>
                         <li><a href="#" data-bs-toggle="modal" data-bs-target="#helpModal" class="footer-link">Ayuda</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Contacto</h5>
                     <p><i class="bi bi-telephone-fill me-2"></i>+53 55189657</p>
                     <p><i class="bi bi-geo-alt-fill me-2"></i>Cumanayagua, Cuba</p>
                </div>
                <div class="col-lg-3 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Síguenos</h5>
                    <div class="social-icons">
                        <a href="https://wa.me/5355189657?text=Hola,%20tengo%20una%20consulta%20sobre%20DL%20Cumanayagua." class="social-icon-link me-3 fs-4" title="WhatsApp"><i class="bi bi-whatsapp"></i></a>
                        <a href="#!" class="social-icon-link me-3 fs-4" title="Facebook"><i class="bi bi-facebook"></i></a>
                        <a href="#!" class="social-icon-link fs-4" title="Instagram"><i class="bi bi-instagram"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4" style="border-color: rgba(255,255,255,0.1);">
            <div class="footer-copyright-container d-flex justify-content-center align-items-center">
                <span class="small text-muted">© 2024 DL Cumanayagua. Todos los derechos reservados.</span>
                <button class="footer-refresh-btn ms-3" onclick="forceFullCacheRefresh()" title="Actualizar datos de la página">
                    <i class="bi bi-cloud-arrow-down-fill fs-5"></i>
                </button>
            </div>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        const GOOGLE_SCRIPT_URL_USER = 'https://script.google.com/macros/s/AKfycbyG77ab1DSxczn02VlA99PtBYAVZzoJXr0vbjvXhbXtQno_Cypjyl5HQWHfg-cMXBZMlg/exec';
        const LOGGED_IN_CLIENT_KEY = 'cafeteriaVipClientLoggedIn_v8';
        const USER_CART_KEY = 'cafeteriaUserCart_v5';
        const MAX_AVATAR_DIMENSION = 200;
        const AVATAR_JPEG_QUALITY = 0.75;
        const LOCAL_AVATAR_DATA_KEY = 'localAvatarDataUrl_v1';
        const DOWNLOAD_MODAL_DISMISSED_KEY = 'downloadModalDismissed_DL_v2';
        const DOWNLOAD_BANNER_DISMISSED_KEY = 'downloadBannerDismissed_DL_v1';
        const PRESENTATION_VIDEO_SHOWN_KEY = 'presentationVideoShown_v1';
        const APP_DOWNLOAD_LINK = "https://drive.google.com/file/d/1JN1qbrX2JB7P5apVzzhtBy5x2hBPxCWa/view?usp=drive_link";
        const REFERRAL_POINTS_FOR_REFERRER = 25;
        const REFERRAL_POINTS_FOR_REFEREE = 15;
        // NUEVA CONSTANTE
        const SEEN_MESSAGE_TIMESTAMP_KEY = 'seenGlobalMessageTimestamp_v1';


        let clientData = null;
        let menuItems = [];
        let availableRewards = [];
        let shoppingCart = [];
        let currentFilterCategory = 'all';
        let currentSortOption = 'default';
        const loadingSpinnerUser = document.getElementById('loadingSpinnerUser');
        let authModalInstance, 
            cartModalInstance, downloadAppModalInstance, productDetailModalInstance,
            sharePageModalInstance, confirmClearCartModalInstance,
            confirmRedeemRewardModalInstance, presentationVideoModalInstance,
            helpModalInstance, rewardDetailModalInstance, globalMessageModalInstance; // <-- AÑADIDO
        let floatingCartButtonEl;
        let floatingCartCountEl;
        let qrcodePageInstance = null;
        let qrcodeAppInstance = null;


        document.addEventListener('DOMContentLoaded', async function() {
            floatingCartButtonEl = document.getElementById('floatingCartButton');
            floatingCartCountEl = document.getElementById('floating-cart-count');
            initializeModals();
            loadCartFromStorage();
            loadClientDataFromStorage();
            updateClientDisplayAndUI();
            
            // Lógica de carga de datos iniciales optimizada
            await loadInitialData();
            
            setupEventListeners();
            handleAppDownloadPromotion();
            handleScroll();
            initializeShareModal();
            setupShareEventListeners();
            setupFloatingButtonFeedback();
            handlePresentationVideo();
            setupNavbarToggler();

            const confirmClearCartBtn = document.getElementById('confirmClearCartButton');
            if (confirmClearCartBtn) {
                confirmClearCartBtn.addEventListener('click', performClearCartActions);
            }

            const productSearchInput = document.getElementById('productSearchInput');
            const clearSearchButton = document.getElementById('clearSearchButton');
            const sortProductsSelect = document.getElementById('sortProductsSelect');

            if (productSearchInput) {
                productSearchInput.addEventListener('input', function() {
                    generateMenu();
                    if (this.value.length > 0 && clearSearchButton) {
                        clearSearchButton.style.display = 'block';
                    } else if (clearSearchButton) {
                        clearSearchButton.style.display = 'none';
                    }
                });
            }
            if (clearSearchButton) {
                clearSearchButton.addEventListener('click', function() {
                    if(productSearchInput) productSearchInput.value = '';
                    clearSearchButton.style.display = 'none';
                    generateMenu();
                });
            }
            if (sortProductsSelect) {
                sortProductsSelect.addEventListener('change', function() {
                    currentSortOption = this.value;
                    generateMenu();
                });
            }

            const helpAccordionItems = document.querySelectorAll('#helpAccordion .accordion-collapse');
            let hasDynamicHelpItems = false;
            helpAccordionItems.forEach((item, index) => {
                const button = item.previousElementSibling.querySelector('button');
                if (button && button.getAttribute('data-bs-target').startsWith('#collapseHelp')) { 
                    hasDynamicHelpItems = true;
                    const newId = `collapseHelp${index}`; 
                    item.id = newId;
                    button.setAttribute('data-bs-target', `#${newId}`);
                    button.setAttribute('aria-controls', newId);
                }
            });
        });

        function setupNavbarToggler() {
            const navLinks = document.querySelectorAll('#navbarNavContent .nav-link, #navbarNavContent .dropdown-item');
            const navbarToggler = document.querySelector('.navbar-toggler');
            const navbarCollapseEl = document.getElementById('navbarNavContent');
            let navbarCollapseInstance = null;

            if (navbarCollapseEl) {
                navbarCollapseInstance = bootstrap.Collapse.getOrCreateInstance(navbarCollapseEl, {toggle: false});
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    const isTogglerVisible = getComputedStyle(navbarToggler).display !== 'none';
                    const isMenuExpanded = navbarCollapseEl.classList.contains('show');

                    if (isMenuExpanded && isTogglerVisible) {
                        const opensModal = link.getAttribute('data-bs-toggle') === 'modal';
                        const isDropdownToggle = link.classList.contains('dropdown-toggle');

                        if (!opensModal && !isDropdownToggle) {
                            if (navbarCollapseInstance) {
                                navbarCollapseInstance.hide();
                            }
                        }
                    }
                });
            });
        }

        function showTabAndScroll(tabLinkId) {
            const tabLink = document.getElementById(tabLinkId);
            if (tabLink) {
                const tabInstance = bootstrap.Tab.getOrCreateInstance(tabLink);
                tabInstance.show();

                const tabPaneId = tabLink.getAttribute('href');
                if (tabPaneId) {
                    const tabPane = document.querySelector(tabPaneId);
                    if (tabPane) {
                        setTimeout(() => {
                            tabPane.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 150);
                    }
                }
            }
        }


        function handleScroll() {
            const quickNav = document.getElementById('quick-nav-buttons');
            const goDownBtn = document.getElementById('go-down-btn');
            if (!quickNav || !goDownBtn) return;

            const floatingButtonsContainer = document.querySelector('.floating-buttons-container');
            let fabContainerBottom = 25;
             if (floatingButtonsContainer) {
                const style = window.getComputedStyle(floatingButtonsContainer);
                fabContainerBottom = parseFloat(style.bottom) || fabContainerBottom;
            }

            if (window.scrollY > 300) {
                quickNav.style.display = 'flex';
            } else {
                quickNav.style.display = 'none';
            }

            let pageBottomOffset = 100;
            const footer = document.getElementById('bottom');
            if (footer) pageBottomOffset += footer.offsetHeight;

            const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - pageBottomOffset);
            goDownBtn.style.display = nearBottom ? 'none' : 'flex';
        }


        async function forceFullCacheRefresh() {
            if (confirm("Esto borrará TODOS los datos de navegación (incluyendo sesión iniciada, carrito, etc.) y recargará la página desde cero para obtener la versión más reciente. ¿Deseas continuar?")) {
                showGlobalFeedback("Limpiando datos y actualizando...", "info", null);
                try {
                    console.log("Limpiando localStorage...");
                    localStorage.clear();
                    console.log("localStorage limpiado.");

                    console.log("Limpiando sessionStorage...");
                    sessionStorage.clear();
                    console.log("sessionStorage limpiado.");

                    if ('serviceWorker' in navigator && navigator.serviceWorker.getRegistrations) {
                        console.log("Intentando desregistrar Service Workers...");
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (let registration of registrations) {
                            await registration.unregister();
                            console.log('Service Worker desregistrado:', registration.scope);
                        }
                        console.log("Service Workers desregistrados (si los había).");
                    }

                    if (window.caches && window.caches.keys) {
                        console.log("Intentando limpiar caché de la API de Cache...");
                        const keys = await window.caches.keys();
                        await Promise.all(keys.map(key => window.caches.delete(key)));
                        console.log("Cachés de la API eliminados.");
                    }
                } catch (error) {
                    console.error("Error durante la limpieza de caché:", error);
                    showGlobalFeedback("Error al limpiar algunos datos de caché.", "warning");
                }

                try {
                    const baseUrl = window.location.origin + window.location.pathname;
                    const timestamp = new Date().getTime();
                    const newUrl = `${baseUrl}?t=${timestamp}`;
                    console.log(`Intentando recargar con URL para evitar caché: ${newUrl}`);
                    window.location.href = newUrl;

                    setTimeout(() => {
                        console.log("Fallback: intentando location.reload(true) después de la navegación por URL.");
                        window.location.reload(true);
                    }, 1500);
                } catch (e) {
                    console.error("Error al intentar recargar la página con URL:", e);
                    console.log("Fallback final: intentando location.reload(true) directamente.");
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 1500);
                }
            }
        }

        function initializeModals() {
            try {
                const authModalEl = document.getElementById('authModal');
                if (authModalEl) authModalInstance = new bootstrap.Modal(authModalEl);
                else console.warn("Modal con ID 'authModal' no encontrado.");

                ['cartModal', 'downloadAppModal', 'productDetailModal', 'sharePageModal', 'confirmClearCartModal', 'confirmRedeemRewardModal', 'presentationVideoModal', 'helpModal', 'rewardDetailModal', 'globalMessageModal'].forEach(id => { // <-- AÑADIDO 'globalMessageModal'
                    const el = document.getElementById(id);
                    if (el) {
                        if (id === 'cartModal') cartModalInstance = new bootstrap.Modal(el);
                        else if (id === 'downloadAppModal') downloadAppModalInstance = new bootstrap.Modal(el);
                        else if (id === 'productDetailModal') productDetailModalInstance = new bootstrap.Modal(el);
                        else if (id === 'sharePageModal') sharePageModalInstance = new bootstrap.Modal(el);
                        else if (id === 'confirmClearCartModal') confirmClearCartModalInstance = new bootstrap.Modal(el);
                        else if (id === 'confirmRedeemRewardModal') confirmRedeemRewardModalInstance = new bootstrap.Modal(el);
                        else if (id === 'presentationVideoModal') presentationVideoModalInstance = new bootstrap.Modal(el);
                        else if (id === 'helpModal') helpModalInstance = new bootstrap.Modal(el);
                        else if (id === 'rewardDetailModal') rewardDetailModalInstance = new bootstrap.Modal(el);
                        else if (id === 'globalMessageModal') globalMessageModalInstance = new bootstrap.Modal(el); // <-- AÑADIDO
                    } else { console.warn(`Modal con ID '${id}' no encontrado.`); }
                });
            } catch (error) { console.error("Error inicializando modales:", error); }
        }

        function setupEventListeners() {
            const authModalEl = document.getElementById('authModal');
            if (authModalEl) {
                authModalEl.addEventListener('hidden.bs.modal', () => {
                    clearFormAndFeedback('newUserRegistrationForm', 'registration-feedback');
                    clearFormAndFeedback('loginForm', 'login-feedback');
                });
            }
            
            document.getElementById('cartModal')?.addEventListener('show.bs.modal', renderCartItems);
            document.getElementById('cartModal')?.addEventListener('hidden.bs.modal', () => {
                document.getElementById('order-placement-feedback').innerHTML = '';
                document.getElementById('cart-footer-info').style.display = 'block';
                document.getElementById('cart-footer-buttons').style.display = 'flex';
            });
            const avatarUploadInputEl = document.getElementById('avatarUploadInput');
            const userAvatarImgEl = document.getElementById('user-avatar');
            const changeAvatarBtnEl = document.getElementById('changeAvatarButton');
            const triggerAvatarUpload = () => {
                if (clientData && clientData.id && avatarUploadInputEl) {
                    avatarUploadInputEl.click();
                } else if (!clientData || !clientData.id) {
                    showGlobalFeedback("Inicia sesión para cambiar tu avatar.", "warning");
                    openAuthModal('login');
                }
            };
            if (userAvatarImgEl) userAvatarImgEl.addEventListener('click', triggerAvatarUpload);
            if (changeAvatarBtnEl) changeAvatarBtnEl.addEventListener('click', triggerAvatarUpload);
            if (avatarUploadInputEl) avatarUploadInputEl.addEventListener('change', handleAvatarFileSelect);
            const rewardsTabEl = document.getElementById('rewards-tab-link');
            if (rewardsTabEl) {
                rewardsTabEl.addEventListener('shown.bs.tab', event => {
                    if (!clientData || !clientData.id) {
                         generateRewardsList();
                        return;
                    }
                    if (availableRewards.length === 0) forceLoadRewards();
                });
            }
            const ordersTabEl = document.getElementById('my-orders-tab-link');
            if (ordersTabEl) {
                ordersTabEl.addEventListener('shown.bs.tab', event => {
                    loadUserOrders();
                });
            }
            window.addEventListener('resize', adjustBodyPaddingAndFabPosition);
            window.addEventListener('scroll', handleScroll);
        }
        
        function openAuthModal(tabToActivate = 'login') {
            if (authModalInstance) {
                authModalInstance.show();
                const tabButtonId = (tabToActivate === 'register') ? 'register-tab-btn' : 'login-tab-btn';
                const tabButton = document.getElementById(tabButtonId);
                if (tabButton) {
                    const tab = bootstrap.Tab.getOrCreateInstance(tabButton);
                    tab.show();
                }
            } else {
                console.error("Auth modal instance not found");
            }
        }

        function adjustBodyPaddingAndFabPosition() {
            const bodyEl = document.body;
            const bannerEl = document.getElementById('downloadAppBanner');
            const floatingButtonsContainer = document.querySelector('.floating-buttons-container');
            const quickNavButtons = document.getElementById('quick-nav-buttons');
            const navbarEl = document.querySelector('.navbar-custom.fixed-top');

            let totalPaddingBottom = 0;
            let fabContainerBottomOffset = 25;
            let quickNavBottomOffset = 260;

            if (window.matchMedia("(max-width: 768px)").matches) {
                fabContainerBottomOffset = 20;
                quickNavBottomOffset = 235;
            }
            if (window.matchMedia("(max-width: 576px)").matches) {
                fabContainerBottomOffset = 15;
                quickNavBottomOffset = 210;
            }

            if (bannerEl && bannerEl.style.display !== 'none' && !bannerEl.classList.contains('animate__fadeOutDown')) {
                const bannerHeight = bannerEl.offsetHeight;
                totalPaddingBottom = bannerHeight + 10;
                fabContainerBottomOffset += bannerHeight;
                quickNavBottomOffset += bannerHeight;
            }

            bodyEl.style.paddingBottom = totalPaddingBottom + 'px';

            if (navbarEl) {
                const navbarHeight = navbarEl.offsetHeight;
                if (parseFloat(bodyEl.style.paddingTop) !== navbarHeight) {
                    bodyEl.style.paddingTop = navbarHeight + 'px';
                }
            }

            if (floatingButtonsContainer) {
                 floatingButtonsContainer.style.bottom = fabContainerBottomOffset + 'px';
            }
            if (quickNavButtons && quickNavButtons.style.display !== 'none') {
                quickNavButtons.style.bottom = quickNavBottomOffset + 'px';
            }
             handleScroll();
        }


        function handleAppDownloadPromotion() {
            const downloadModalEl = document.getElementById('downloadAppModal');
            const bannerEl = document.getElementById('downloadAppBanner');
            const videoAlreadyShown = localStorage.getItem(PRESENTATION_VIDEO_SHOWN_KEY);

            // Mostrar modal de descarga de la app
            if ((videoAlreadyShown === 'true' || !videoAlreadyShown ) && !localStorage.getItem(DOWNLOAD_MODAL_DISMISSED_KEY) && downloadAppModalInstance) {
                 setTimeout(() => {
                    if (!localStorage.getItem(DOWNLOAD_MODAL_DISMISSED_KEY)) {
                        const presentationModalIsActive = document.getElementById('presentationVideoModal')?.classList.contains('show');
                        if (!presentationModalIsActive) {
                           downloadAppModalInstance.show();
                        }
                    }
                }, (videoAlreadyShown !== 'true' && !videoAlreadyShown) ? 7000 : 2500);
            }

            if (downloadModalEl) {
                downloadModalEl.addEventListener('hidden.bs.modal', function () {
                    localStorage.setItem(DOWNLOAD_MODAL_DISMISSED_KEY, 'true');
                });
            }
            
            // Mostrar banner de descarga
            const bannerDismissed = localStorage.getItem(DOWNLOAD_BANNER_DISMISSED_KEY);
            if (bannerEl && !bannerDismissed) {
                let bannerDelay = 3500;
                if (!localStorage.getItem(DOWNLOAD_MODAL_DISMISSED_KEY) || (videoAlreadyShown !== 'true' && !videoAlreadyShown) ) {
                    bannerDelay = 12000;
                }
                setTimeout(() => {
                    const presentationModalIsActive = document.getElementById('presentationVideoModal')?.classList.contains('show');
                    const downloadAppModalIsActive = document.getElementById('downloadAppModal')?.classList.contains('show');
                    if (!localStorage.getItem(DOWNLOAD_BANNER_DISMISSED_KEY) && !presentationModalIsActive && !downloadAppModalIsActive) {
                        bannerEl.style.display = 'block';
                        bannerEl.classList.remove('animate__fadeOutDown');
                        bannerEl.classList.add('animate__animated', 'animate__fadeInUp');
                        adjustBodyPaddingAndFabPosition();
                    }
                }, bannerDelay);
                const closeBannerButton = bannerEl.querySelector('.btn-close');
                if (closeBannerButton) {
                    closeBannerButton.addEventListener('click', () => {
                        bannerEl.classList.remove('animate__fadeInUp');
                        bannerEl.classList.add('animate__animated', 'animate__fadeOutDown');
                        setTimeout(() => {
                            bannerEl.style.display = 'none';
                            localStorage.setItem(DOWNLOAD_BANNER_DISMISSED_KEY, 'true');
                            adjustBodyPaddingAndFabPosition();
                        }, 500);
                    });
                }
            } else if (bannerEl && bannerDismissed) {
                 bannerEl.style.display = 'none';
            }
            adjustBodyPaddingAndFabPosition();
        }

        function handlePresentationVideo() {
            const videoAlreadyShown = localStorage.getItem(PRESENTATION_VIDEO_SHOWN_KEY);
            const videoElement = document.getElementById('introVideo');
            const presentationModalEl = document.getElementById('presentationVideoModal');

            if (!videoAlreadyShown) {
                if (presentationVideoModalInstance && videoElement) {
                    const anyMajorModalActive = ['authModal', 'cartModal', 'downloadAppModal', 'helpModal'].some(id => {
                        const modal = document.getElementById(id);
                        return modal && modal.classList.contains('show');
                    });

                    if (!anyMajorModalActive) {
                        setTimeout(() => presentationVideoModalInstance.show(), 1000);
                    }
                } else {
                    console.warn("Modal de video o elemento de video no encontrado para mostrar automáticamente.");
                }
            }

            if (presentationModalEl && videoElement) {
                presentationModalEl.addEventListener('shown.bs.modal', function () {
                    videoElement.currentTime = 0;
                    videoElement.play().catch(error => {
                        console.warn("Autoplay del video bloqueado por el navegador:", error);
                    });
                });

                presentationModalEl.addEventListener('hidden.bs.modal', function () {
                    videoElement.pause();
                    localStorage.setItem(PRESENTATION_VIDEO_SHOWN_KEY, 'true');
                });

                videoElement.addEventListener('ended', function() {
                    if (presentationVideoModalInstance) {
                        presentationVideoModalInstance.hide();
                    }
                });
            }
        }

        function clearFormAndFeedback(formId, feedbackId) {
            if (formId) {
                const form = document.getElementById(formId);
                if (form) form.reset();
            }
            if (feedbackId) {
                const feedbackEl = document.getElementById(feedbackId);
                if (feedbackEl) feedbackEl.innerHTML = '';
            }
        }

        async function fetchDataFromGAS(action, method = 'POST', payloadData = null) {
            if (loadingSpinnerUser) loadingSpinnerUser.classList.add('show');
            try {
                let url = GOOGLE_SCRIPT_URL_USER;
                const options = { method: method, headers: {}, mode: 'cors', redirect: 'follow' };
                if (method === 'GET') {
                    const params = new URLSearchParams({ action: action, cacheBuster: new Date().getTime() });
                    if (payloadData) {
                        for (const key in payloadData) {
                            if (payloadData.hasOwnProperty(key)) { params.append(key, payloadData[key]); }
                        }
                    }
                    url += `?${params.toString()}`;
                } else {
                    options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
                    const dataToSend = { action: action, payload: payloadData };
                    const formBody = new URLSearchParams();
                    formBody.append("data", JSON.stringify(dataToSend));
                    options.body = formBody.toString();
                }
                const res = await fetch(url, options);
                const responseText = await res.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Respuesta no es JSON válido del servidor: ${responseText.substring(0,150)}`);
                }
                return responseData;
            } catch (error) {
                showGlobalFeedback(`Error de conexión o servidor: ${error.message || 'Desconocido'}. Intenta de nuevo.`, "danger", 7000);
                return { success: false, message: `Error de conexión o servidor: ${error.message || 'Desconocido'}.` };
            } finally {
                if (loadingSpinnerUser) loadingSpinnerUser.classList.remove('show');
            }
        }

        function loadClientDataFromStorage() {
            const storedClientData = localStorage.getItem(LOGGED_IN_CLIENT_KEY);
            if (storedClientData) {
                try {
                    clientData = JSON.parse(storedClientData);
                } catch (e) {
                    localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
                    clientData = null;
                }
            } else {
                clientData = null;
            }
        }

        function updateClientDisplayAndUI() {
    const el = id => document.getElementById(id);
    const authNavContainer = el('auth-buttons-nav');
    const logoutNavButton = el('logoutButtonNav');
    const vipCardContainer = el('vip-card-container');
    const guestPromptContainer = el('guest-prompt');
    const userAvatarImg = el('user-avatar');
    const myOrdersTabLink = el('my-orders-tab-link');
    const referralCodeContainerEl = el('client-referral-code-container');
    const clientReferralCodeEl = el('clientReferralCode');


    if (clientData && clientData.id && (clientData.verificado === true || String(clientData.verificado).toLowerCase() === 'true')) {
        el('client-name').textContent = `¡Hola, ${clientData.nombre ? clientData.nombre.split(' ')[0] : 'Cliente'}!`;
        el('client-points').textContent = clientData.puntos !== undefined ? clientData.puntos : 0;
        el('client-status').textContent = `Nivel: ${(clientData.puntos||0)>=150?"Oro":(clientData.puntos||0)>=75?"Plata":"Bronce"}`;
        el('client-phone-display').textContent = clientData.telefono ? `Tel: ${clientData.telefono}` : '';
        el('vip-status-badge').style.display = 'inline-block';
        if (userAvatarImg) {
            if (clientData[LOCAL_AVATAR_DATA_KEY] && typeof clientData[LOCAL_AVATAR_DATA_KEY] === 'string') {
                userAvatarImg.src = clientData[LOCAL_AVATAR_DATA_KEY];
            } else if (clientData.avatarurl && typeof clientData.avatarurl === 'string' && clientData.avatarurl.trim() !== '') {
                 userAvatarImg.src = clientData.avatarurl + (clientData.avatarurl.includes('?') ? '&t=' : '?t=') + new Date().getTime();
            } else {
                userAvatarImg.src = './img/placeholder-avatar.png'; // CORREGIDO
            }
        }
        if(authNavContainer) authNavContainer.innerHTML = `<span class="navbar-text text-light me-2 small">Hola, ${clientData.nombre ? clientData.nombre.split(' ')[0] : 'VIP'}</span>`;
        if(logoutNavButton) logoutNavButton.style.display = 'inline-block';
        if(vipCardContainer) vipCardContainer.style.display = 'block';
        if(guestPromptContainer) guestPromptContainer.style.display = 'none';
        if(myOrdersTabLink) myOrdersTabLink.innerHTML = `<i class="bi bi-receipt me-1"></i>Mis Envíos`;

        if (clientData.referralcode && clientReferralCodeEl && referralCodeContainerEl) {
            clientReferralCodeEl.textContent = clientData.referralcode;
            referralCodeContainerEl.style.display = 'block';
        } else if (referralCodeContainerEl) {
            referralCodeContainerEl.style.display = 'none';
        }

    } else {
        el('client-name').textContent = `¡Bienvenido!`;
        el('client-points').textContent = 0;
        el('client-status').textContent = "Inicia sesión o regístrate para enviar.";
        el('client-phone-display').textContent = '';
        el('vip-status-badge').style.display = 'none';
        if (userAvatarImg) userAvatarImg.src = './img/placeholder-avatar.png'; // CORREGIDO
        if(authNavContainer) authNavContainer.innerHTML = `
            <button class="btn btn-sm btn-outline-light me-2" onclick="openAuthModal('login')"><i class="bi bi-box-arrow-in-right"></i> Login</button>
            <button class="btn btn-sm btn-warning" onclick="openAuthModal('register')"><i class="bi bi-person-plus"></i> Registro</button>`;
        if(logoutNavButton) logoutNavButton.style.display = 'none';
        if(vipCardContainer) vipCardContainer.style.display = 'none';
        if(guestPromptContainer) guestPromptContainer.style.display = 'block';
        if(myOrdersTabLink) myOrdersTabLink.innerHTML = `<i class="bi bi-receipt me-1"></i>Mis Envíos`;
        if (referralCodeContainerEl) referralCodeContainerEl.style.display = 'none';
        loadUserOrders();
        generateRewardsList();
    }
    updateCartDisplay();
}

        function logoutClient() {
            clientData = null;
            localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
            shoppingCart = [];
            availableRewards = [];
            localStorage.removeItem(USER_CART_KEY);
            updateClientDisplayAndUI();
            showGlobalFeedback('Sesión cerrada. ¡Vuelve pronto!', 'info');
            handleAppDownloadPromotion();
        }

        async function handleUserRegistrationAttempt() {
            const nombre = document.getElementById('newUserName').value.trim();
            const telefono = document.getElementById('newUserPhone').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('newUserConfirmPassword').value;
            const referralCodeUsed = document.getElementById('newUserReferralCodeUsed').value.trim();
            const feedbackElId = 'registration-feedback';

            if (!nombre || !telefono || !email || !password || !confirmPassword) {
                showFeedbackInModal(null, feedbackElId, 'Todos los campos marcados con * son requeridos.', 'danger'); return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showFeedbackInModal(null, feedbackElId, 'Por favor, ingresa un correo electrónico válido.', 'danger'); return;
            }
            if (password !== confirmPassword) {
                showFeedbackInModal(null, feedbackElId, 'Las contraseñas no coinciden.', 'danger'); return;
            }
            if (!/^\+?\d{7,15}$/.test(telefono)) {
                showFeedbackInModal(null, feedbackElId, 'Por favor, ingresa un número de teléfono válido (7-15 dígitos, puede incluir + al inicio).', 'danger'); return;
            }
             if (password.length < 6) {
                showFeedbackInModal(null, feedbackElId, 'La contraseña debe tener al menos 6 caracteres.', 'danger'); return;
            }
            showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Registrando...', 'info', null);
            const payload = { nombre, telefono, email, password, referralCodeUsed };
            const result = await fetchDataFromGAS('registerNewUser', 'POST', payload);
            if (result.success) {
                showFeedbackInModal(null, feedbackElId, `${result.message || '¡Registro exitoso!'} Ahora puedes iniciar sesión para realizar tus envíos.`, 'success', 4000);
                document.getElementById('newUserRegistrationForm').reset();
                setTimeout(() => {
                    if (authModalInstance) {
                        const loginTabBtn = document.getElementById('login-tab-btn');
                        if (loginTabBtn) {
                            bootstrap.Tab.getOrCreateInstance(loginTabBtn).show();
                        }
                        clearFormAndFeedback('newUserRegistrationForm', 'registration-feedback');
                    }
                }, 3000);
            } else {
                showFeedbackInModal(null, feedbackElId, result.message || 'Error al registrar. Intenta de nuevo.', 'danger');
            }
        }

        async function handleLoginAttempt() {
            const telefono = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;
            const feedbackElId = 'login-feedback';
            if (!telefono || !password) {
                showFeedbackInModal(null, feedbackElId, 'Teléfono y contraseña son requeridos.', 'danger'); return;
            }
            showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Iniciando sesión...', 'info', null);
            const payload = { telefono, password };
            const result = await fetchDataFromGAS('loginUser', 'POST', payload);
            if (result.success && result.data) {
                clientData = result.data;
                localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                updateClientDisplayAndUI();
                showFeedbackInModal(null, feedbackElId, `¡Bienvenido de nuevo, ${clientData.nombre.split(' ')[0]}! Listo para enviar.`, 'success', 3000);
                setTimeout(() => authModalInstance?.hide(), 2000);
                loadUserOrders();
            } else {
                showFeedbackInModal(null, feedbackElId, result.message || 'Error al iniciar sesión. Verifica tus datos.', 'danger');
            }
        }

        async function handleAvatarFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                showGlobalFeedback('Por favor, selecciona un archivo de imagen (JPEG, PNG, GIF).', 'warning');
                event.target.value = null; return;
            }
            const maxSizeInBytes = 2 * 1024 * 1024;
            if (file.size > maxSizeInBytes) {
                showGlobalFeedback('La imagen es demasiado grande (máx 2MB antes de comprimir).', 'warning');
                event.target.value = null; return;
            }
            showGlobalFeedback('Procesando imagen...', 'info', null);
            try {
                const compressedDataUrl = await compressImage(file, file.type);
                if (clientData && clientData.id) {
                    clientData[LOCAL_AVATAR_DATA_KEY] = compressedDataUrl;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    const userAvatarImg = document.getElementById('user-avatar');
                    if(userAvatarImg) userAvatarImg.src = compressedDataUrl;
                    showGlobalFeedback('Avatar actualizado localmente. Subiendo al servidor...', 'info', 3000);
                } else {
                    showGlobalFeedback('Error: No hay sesión de usuario activa para guardar el avatar local.', 'danger');
                    event.target.value = null; return;
                }
                const parts = compressedDataUrl.split(';base64,');
                const contentType = parts[0].split(':')[1];
                const imageData = parts[1];
                await uploadClientAvatar(imageData, contentType, file.name);
            } catch (error) {
                showGlobalFeedback(`Error al procesar la imagen: ${error.message}`, 'danger');
            } finally {
                event.target.value = null;
            }
        }

        function compressImage(file, originalMimeType) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_AVATAR_DIMENSION) {
                                height = Math.round(height * MAX_AVATAR_DIMENSION / width);
                                width = MAX_AVATAR_DIMENSION;
                            }
                        } else {
                            if (height > MAX_AVATAR_DIMENSION) {
                                width = Math.round(width * MAX_AVATAR_DIMENSION / height);
                                height = MAX_AVATAR_DIMENSION;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', AVATAR_JPEG_QUALITY));
                    };
                    img.onerror = () => reject(new Error("No se pudo cargar la imagen para compresión."));
                };
                reader.onerror = () => reject(new Error("Error leyendo el archivo de imagen."));
            });
        }

        async function uploadClientAvatar(imageData, contentType, filename) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback('Debes iniciar sesión para cambiar tu avatar.', 'warning'); return;
            }
            const payload = {
                clientId: clientData.id,
                imageData: imageData,
                contentType: contentType,
                filename: "avatar_" + clientData.id + "_" + Date.now() + "." + (contentType.split('/')[1] || 'jpg')
            };
            const result = await fetchDataFromGAS('updateClientAvatar', 'POST', payload);
            if (result.success && result.data && result.data.newAvatarUrl) {
                if (result.data.clientData) {
                    const localAvatarTemp = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.clientData;
                    if (localAvatarTemp && !clientData[LOCAL_AVATAR_DATA_KEY]) {
                        clientData[LOCAL_AVATAR_DATA_KEY] = localAvatarTemp;
                    }
                    if (result.data.newAvatarUrl) clientData.avatarurl = result.data.newAvatarUrl;
                } else {
                     clientData.avatarurl = result.data.newAvatarUrl;
                }
                localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                showGlobalFeedback('¡Avatar guardado con éxito en el servidor!', 'success');
            } else {
                showGlobalFeedback(result.message || 'Error al guardar el avatar en el servidor. Se mantiene la versión local.', 'warning');
            }
        }

        async function loadInitialData() {
            const menuContainer = document.getElementById('menu-container');
            const rewardsContainer = document.getElementById('rewards-container');
            const popularContainer = document.getElementById('popular-items-container');
            
            menuContainer.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div>`;
            rewardsContainer.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div>`;
            if (popularContainer) popularContainer.innerHTML = '<div class="col-12 text-center p-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div><span class="ms-2">Cargando...</span></div>';

            const res = await fetchDataFromGAS('getInitialClientData', 'GET');

            if (res.success && res.data) {
                menuItems = (res.data.products || []).map(p => ({
                    ...p, price: parseFloat(p.price) || 0, points: parseInt(p.points) || 0,
                    id: String(p.id), category: p.category || "Otros"
                }));
                generatePopularItems();
                generateCategoryFilters();
                generateMenu();

                availableRewards = (res.data.rewards || []).map(r => ({
                    ...r, rewardid: String(r.rewardid), pointsrequired: parseInt(r.pointsrequired) || 0, stock: parseInt(r.stock)
                }));
                generateRewardsList();

                if (res.data.globalMessage && res.data.globalMessage.lastUpdated) {
                    handleGlobalMessage(res.data.globalMessage);
                }

            } else {
                menuContainer.innerHTML = `<div class="col-12 text-center p-5"><p class="text-danger fs-5">Error al cargar los datos: ${res.message || 'Desconocido.'}</p></div>`;
                rewardsContainer.innerHTML = `<div class="col-12 text-center p-5"><p class="text-danger fs-5">Error al cargar las recompensas.</p></div>`;
                if (popularContainer) popularContainer.innerHTML = '<div class="col-12 text-center p-3"><p class="text-danger">Error al cargar populares.</p></div>';
            }
        }

        function handleGlobalMessage(message) {
            const lastSeenTimestamp = localStorage.getItem(SEEN_MESSAGE_TIMESTAMP_KEY);
            
            if (message.lastUpdated !== lastSeenTimestamp) {
                const titleEl = document.getElementById('globalMessageModalTitle');
                const bodyEl = document.getElementById('globalMessageModalBody');
                
                if (titleEl && bodyEl && globalMessageModalInstance) {
                    titleEl.innerHTML = `<i class="bi bi-info-circle-fill me-2" style="color:var(--primary-color);"></i> ${message.title}`;
                    bodyEl.innerHTML = message.body;

                    globalMessageModalInstance.show();
                    
                    localStorage.setItem(SEEN_MESSAGE_TIMESTAMP_KEY, message.lastUpdated);
                }
            }
        }

        async function forceLoadMenuItems() {
             const res = await fetchDataFromGAS('getPublicProducts', 'GET');
             if (res.success && Array.isArray(res.data)) {
                menuItems = res.data.map(p => ({...p, price: parseFloat(p.price) || 0, points: parseInt(p.points) || 0, id: String(p.id), category: p.category || "Otros"}));
                generatePopularItems();
                generateCategoryFilters();
                generateMenu();
                showGlobalFeedback("Menú y combos actualizados.", "success", 2000);
             } else {
                showGlobalFeedback("No se pudo actualizar el menú.", "warning", 4000);
             }
        }

        function generatePopularItems() {
    const popularContainer = document.getElementById('popular-items-container');
    if (!popularContainer) return;

    if (!menuItems || menuItems.length === 0) {
        popularContainer.innerHTML = '<div class="col-12 text-center p-3"><p class="text-muted">No hay productos para mostrar como populares aún.</p></div>';
        return;
    }
    
    // FILTRAR PRODUCTOS AGOTADOS
    let availableItems = menuItems.filter(item => item.active !== false);
    
    let popularToShow = [...availableItems];
    popularToShow.sort(() => 0.5 - Math.random());
    popularToShow = popularToShow.slice(0, 4);

    if (popularToShow.length === 0) {
         popularContainer.innerHTML = '<div class="col-12 text-center p-3"><p class="text-muted">No hay productos destacados en este momento.</p></div>';
         return;
    }
    
    // SOLO PRODUCTOS DISPONIBLES
    popularContainer.innerHTML = '';
    popularToShow.forEach(item => {
        const itemId = String(item.id);
        popularContainer.innerHTML += `
        <div class="col-6 col-md-6 col-lg-3 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.6s;">
            <div class="menu-item-card card w-100 d-flex flex-column">
               <img src="${item.imageurl || './img/placeholder-product.png'}"
                     class="product-image card-img-top" alt="${item.name || 'Producto'}" style="cursor: pointer;" onclick="showProductDetailModal('${itemId}')" loading="lazy">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${item.name || 'Sin Nombre'}</h5>
                    <p class="card-text small flex-grow-1">${(item.description || 'Deliciosa opción de nuestro menú.').substring(0,70)}${(item.description || '').length > 70 ? '...' : ''}</p>
                    <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-2">
                        <span class="fw-bold fs-6" style="color: var(--primary-color);">USD ${(item.price || 0).toFixed(2)}</span>
                        <span class="badge bg-success text-white small">+${item.points || 0} Pts</span>
                    </div>
                    <button class="btn btn-sm btn-primary mt-2 w-100" onclick="addToCart('${itemId}')"><i class="bi bi-cart-plus-fill me-1"></i>Añadir</button>
                </div>
            </div>
        </div>`;
    });
}

       function generateCategoryFilters() {
            const filterContainer = document.getElementById('filter-container');
            if (!filterContainer) {
                console.error("Contenedor de filtros no encontrado.");
                return;
            }
            filterContainer.innerHTML = '';
            if (!menuItems || menuItems.length === 0) {
                return;
            }
            const allBtn = document.createElement('button');
            allBtn.className = 'btn btn-sm btn-filter';
            allBtn.textContent = 'Todos';
            allBtn.onclick = () => filterMenuByCategory('all');
            filterContainer.appendChild(allBtn);
            const categories = [...new Set(menuItems.map(item => item.category || "Otros"))]
                .sort((a, b) => a.localeCompare(b));
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-filter';
                btn.textContent = category;
                btn.onclick = () => filterMenuByCategory(category);
                filterContainer.appendChild(btn);
            });
            const filterButtons = filterContainer.querySelectorAll('.btn-filter');
            filterButtons.forEach(btn => {
                const btnTextLower = btn.textContent.toLowerCase();
                const currentFilterLower = currentFilterCategory.toLowerCase();
                if ((currentFilterLower === 'all' && btnTextLower === 'todos') ||
                    (btnTextLower === currentFilterLower && currentFilterLower !== 'all')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function filterMenuByCategory(category) {
            currentFilterCategory = category;
            generateCategoryFilters();
            generateMenu();
        }

        function generateMenu() {
    const menuContainer = document.getElementById('menu-container');
    if (!menuContainer) return;
    menuContainer.innerHTML = '';

    const searchTerm = document.getElementById('productSearchInput')?.value.toLowerCase().trim() || '';
    
    // FILTRAR PRODUCTOS AGOTADOS
    let itemsToDisplay = [...menuItems].filter(item => item.active !== false);

    if (currentFilterCategory !== 'all') {
        itemsToDisplay = itemsToDisplay.filter(item => (item.category || "Otros") === currentFilterCategory);
    }

    if (searchTerm) {
        itemsToDisplay = itemsToDisplay.filter(item =>
            (item.name || '').toLowerCase().includes(searchTerm) ||
            (item.description || '').toLowerCase().includes(searchTerm)
        );
    }

    switch (currentSortOption) {
        case 'name-asc':
            itemsToDisplay.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
            break;
        case 'name-desc':
            itemsToDisplay.sort((a, b) => (b.name || "").localeCompare(a.name || ""));
            break;
        case 'price-asc':
            itemsToDisplay.sort((a, b) => (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0));
            break;
        case 'price-desc':
            itemsToDisplay.sort((a, b) => (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0));
            break;
        case 'default':
        default:
            itemsToDisplay.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
            break;
    }

    if (!itemsToDisplay || itemsToDisplay.length === 0) {
        let emptyMessage = `<div class="col-12 text-center p-md-5 p-4">`;
        emptyMessage += `<i class="bi bi-search-heart display-1 text-muted opacity-50 mb-3"></i>`;
        if (searchTerm && currentFilterCategory === 'all') {
            emptyMessage += `<h4 class="text-light mb-2">Sin resultados para "${searchTerm}"</h4><p class="text-muted mb-3">No encontramos productos que coincidan con tu búsqueda.</p>`;
        } else if (searchTerm && currentFilterCategory !== 'all') {
             emptyMessage += `<h4 class="text-light mb-2">Sin resultados en "${currentFilterCategory}"</h4><p class="text-muted mb-3">No hay productos en esta categoría que coincidan con "${searchTerm}".</p>`;
        } else if (!searchTerm && currentFilterCategory !== 'all') {
            emptyMessage += `<h4 class="text-light mb-2">Categoría Vacía</h4><p class="text-muted mb-3">No hay productos disponibles en la categoría "${currentFilterCategory}".</p>`;
        } else {
            emptyMessage += `<h4 class="text-light mb-2">Menú Vacío</h4><p class="text-muted mb-3">No hay productos disponibles en el menú en este momento.</p>`;
        }
        emptyMessage += `<p class="text-muted">Intenta con otros términos o revisa todas las categorías.</p>`;
        if (searchTerm || currentFilterCategory !== 'all') {
            emptyMessage += `<button class="btn btn-outline-primary mt-2" onclick="resetFiltersAndSearch()">Ver todo el menú</button>`;
        }
        emptyMessage += `</div>`;
        menuContainer.innerHTML = emptyMessage;
        return;
    }

    itemsToDisplay.forEach(item => {
        const itemId = String(item.id);
        // SOLO PRODUCTOS DISPONIBLES - ELIMINAR LÓGICA DE DISPONIBILIDAD
        const buttonHtml = `<button class="btn btn-primary mt-3 w-100" onclick="addToCart('${itemId}')"><i class="bi bi-cart-plus-fill me-2"></i>Añadir al Envío</button>`;

        menuContainer.innerHTML += `
        <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
            <div class="menu-item-card card w-100 d-flex flex-column">
                <img src="${item.imageurl || 'https://via.placeholder.com/350x220/E74C3C/FFF?text=' + encodeURIComponent(item.name || 'Producto')}"
                     class="product-image card-img-top" alt="${item.name || 'Producto'}" style="cursor: pointer;" onclick="showProductDetailModal('${itemId}')" loading="lazy">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${item.name || 'Sin Nombre'}</h5>
                    <p class="card-text flex-grow-1">${item.description || 'Deliciosa opción de nuestro menú.'}</p>
                    <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                        <span class="fw-bold fs-5" style="color: var(--primary-color);">USD ${(item.price || 0).toFixed(2)}</span>
                        <span class="badge bg-success text-white">+${item.points || 0} Puntos</span>
                    </div>
                    ${buttonHtml}
                </div>
            </div>
        </div>`;
    });
}

        function resetFiltersAndSearch() {
            const productSearchInput = document.getElementById('productSearchInput');
            if (productSearchInput) productSearchInput.value = '';
            const clearSearchButton = document.getElementById('clearSearchButton');
            if (clearSearchButton) clearSearchButton.style.display = 'none';
            currentFilterCategory = 'all';
            currentSortOption = 'default';
            const sortSelect = document.getElementById('sortProductsSelect');
            if (sortSelect) sortSelect.value = 'default';
            generateCategoryFilters();
            generateMenu();
        }

        function showProductDetailModal(productId) {
            populateModalWithProduct(productId);
            productDetailModalInstance.show();
        }

        function switchProductInModal(productId) {
            populateModalWithProduct(productId);
        }

        function populateModalWithProduct(productId) {
            const product = menuItems.find(p => p.id === productId);
            if (!product) {
                console.error("Producto no encontrado para el modal:", productId);
                return;
            }
            document.getElementById('modal-product-image').src = product.imageurl || './img/placeholder-product.png';
            document.getElementById('modal-product-name').textContent = product.name || 'Sin Nombre';
            document.getElementById('modal-product-description').textContent = product.description || 'Descripción no disponible.';
            document.getElementById('modal-product-price').textContent = `USD ${(product.price || 0).toFixed(2)}`;
            document.getElementById('modal-product-points').textContent = `+${product.points || 0} Puntos`;
            
            const btnContainer = document.getElementById('modal-add-to-cart-button-container');
            const isAvailable = product.active !== false;
            
            if (isAvailable) {
                 btnContainer.innerHTML = `<button class="btn btn-primary btn-lg w-100" onclick="addToCartAndCloseModal('${productId}')"><i class="bi bi-cart-plus-fill me-2"></i>Añadir al Envío</button>`;
            } else {
                 btnContainer.innerHTML = `<button class="btn btn-secondary btn-lg w-100" disabled><i class="bi bi-x-circle-fill me-2"></i>Producto No Disponible</button>`;
            }

            generateRecommendations(productId);
        }

        function generateRecommendations(currentProductId) {
    const recommendationsContainer = document.getElementById('modal-recommendations-container');
    recommendationsContainer.innerHTML = '<h5><i class="bi bi-magic me-2"></i>También podría interesarte</h5>';
    const currentProduct = menuItems.find(p => p.id === currentProductId);
    if (!currentProduct) return;
    
    // FILTRAR PRODUCTOS AGOTADOS
    const candidates = menuItems.filter(p => p.id !== currentProductId && p.active !== false);
    
    const sameCategory = candidates.filter(p => p.category === currentProduct.category);
    const otherCategory = candidates.filter(p => p.category !== currentProduct.category);
    const shuffledCandidates = [...sameCategory.sort(() => 0.5 - Math.random()), ...otherCategory.sort(() => 0.5 - Math.random())];
    const finalRecommendations = shuffledCandidates.slice(0, 3);
    
    if (finalRecommendations.length === 0) {
        recommendationsContainer.innerHTML += '<p class="small text-muted">No hay otras recomendaciones por ahora.</p>';
        return;
    }
    
    const recRow = document.createElement('div');
    recRow.className = 'row g-2';
    finalRecommendations.forEach(rec => {
        recRow.innerHTML += `
        <div class="col-4">
            <div class="recommendation-card" onclick="switchProductInModal('${rec.id}')">
                <img src="${rec.imageurl || './img/placeholder-product.png'}" alt="${rec.name}" loading="lazy">
                <div class="p-2"><div class="rec-title">${rec.name}</div></div>
            </div>
        </div>`;
    });
    recommendationsContainer.appendChild(recRow);
}

        function addToCartAndCloseModal(productId) {
            addToCart(productId);
            productDetailModalInstance.hide();
        }

        function loadCartFromStorage(){
            const storedCart = localStorage.getItem(USER_CART_KEY);
            shoppingCart = storedCart ? (JSON.parse(storedCart) || []) : [];
            updateCartDisplay();
        }

        function saveCartToStorage(){
            try {
                localStorage.setItem(USER_CART_KEY, JSON.stringify(shoppingCart));
            } catch(e) {
                showGlobalFeedback("No se pudo guardar el carrito. Espacio de almacenamiento lleno?", "danger");
            }
        }

        function addToCart(productId) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback('Inicia sesión para añadir productos a tu envío.', 'warning');
                openAuthModal('login');
                return;
            }
            if (!menuItems || menuItems.length === 0) {
                showGlobalFeedback("Error: El menú no está cargado. Intenta recargar la página.", "danger");
                return;
            }
            const product = menuItems.find(item => item.id === productId);
            if (!product) {
                showGlobalFeedback("Producto no encontrado.", "danger");
                return;
            }
            const existingItem = shoppingCart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity = (existingItem.quantity || 0) + 1;
            } else {
                shoppingCart.push({
                    productId: product.id, name: product.name,
                    price:parseFloat(product.price)||0, quantity:1, points:parseInt(product.points)||0
                });
            }
            saveCartToStorage();
            updateCartDisplay();
            renderCartItems();
            showGlobalFeedback(`${product.name} añadido a tu envío!`, 'success', 2000);
        }

        function updateCartQuantity(productId, change) {
            const itemInCart = shoppingCart.find(item => item.productId === productId);
            if (itemInCart) {
                itemInCart.quantity += change;
                if (itemInCart.quantity <= 0) {
                    shoppingCart = shoppingCart.filter(item => item.productId !== productId);
                }
            }
            saveCartToStorage();
            renderCartItems();
            updateCartDisplay();
        }

        function removeFromCart(productId) {
            shoppingCart = shoppingCart.filter(item => item.productId !== productId);
            saveCartToStorage();
            renderCartItems();
            updateCartDisplay();
            showGlobalFeedback("Producto eliminado del envío.", "info", 1500);
        }

        function clearCart() {
            if (shoppingCart.length === 0) {
                showFeedbackInModal(null, 'order-placement-feedback', 'El carrito de envío ya está vacío.', 'info', 2000);
                if (cartModalInstance && document.getElementById('cartModal').classList.contains('show')) {
                } else if (cartModalInstance) {
                    cartModalInstance.show();
                }
                return;
            }

            if (confirmClearCartModalInstance) {
                confirmClearCartModalInstance.show();
            } else {
                if (confirm("¿Estás seguro de que quieres vaciar tu carrito de envío?")) {
                    performClearCartActions();
                }
            }
        }

        function performClearCartActions() {
            shoppingCart = [];
            saveCartToStorage();
            renderCartItems();
            updateCartDisplay();
            showFeedbackInModal(null, 'order-placement-feedback', 'Carrito de envío vaciado.', 'info', 2000);
            if (cartModalInstance && document.getElementById('cartModal').classList.contains('show')) {
            } else {
                showGlobalFeedback('Carrito de envío vaciado.', 'info');
            }
            if (confirmClearCartModalInstance) {
                 confirmClearCartModalInstance.hide();
            }
        }


        function updateCartDisplay() {
            let totalItems = Array.isArray(shoppingCart) ? shoppingCart.reduce((s, i) => s + (i.quantity || 0), 0) : 0;
            if (floatingCartButtonEl && floatingCartCountEl) {
                const isCurrentlyVisible = floatingCartButtonEl.style.display !== 'none' && !floatingCartButtonEl.classList.contains('animate__zoomOut');
                const shouldBeVisible = totalItems > 0 && clientData && clientData.id;
                if (shouldBeVisible && !isCurrentlyVisible) {
                    floatingCartButtonEl.classList.remove('animate__zoomOut');
                    floatingCartButtonEl.classList.add('animate__animated', 'animate__zoomIn');
                    floatingCartButtonEl.style.display = 'flex';
                } else if (!shouldBeVisible && isCurrentlyVisible) {
                    floatingCartButtonEl.classList.remove('animate__zoomIn');
                    floatingCartButtonEl.classList.add('animate__animated', 'animate__zoomOut');
                    setTimeout(() => {
                        if ( !(totalItems > 0 && clientData && clientData.id) ) {
                           floatingCartButtonEl.style.display = 'none';
                        }
                    }, 500);
                }
                floatingCartCountEl.textContent = totalItems;
            }
            const pointsEl = document.getElementById('cart-points-to-earn');
            if(pointsEl) pointsEl.textContent = Array.isArray(shoppingCart) ? shoppingCart.reduce((s,i)=>s+((i.points||0)*(i.quantity||0)),0) : 0;
            adjustBodyPaddingAndFabPosition();
        }

    // ===== FUNCIONES AUXILIARES PARA RENDER CART ITEMS =====
function handleQuantityChange(productId, change, button) {
    if (button) {
        button.style.transform = 'scale(0.9)';
        setTimeout(() => {
            button.style.transform = 'scale(1)';
        }, 150);
    }
    updateCartQuantity(productId, change);
}

function handleRemoveItem(productId, button) {
    if (button) {
        button.style.transform = 'scale(0.8) rotate(90deg)';
        setTimeout(() => {
            removeFromCart(productId);
        }, 300);
    } else {
        removeFromCart(productId);
    }
}

function handlePayment() {
    const paymentButton = document.querySelector('.payment-method');
    if (paymentButton) {
        paymentButton.style.transform = 'scale(0.95)';
        paymentButton.style.opacity = '0.8';
        
        setTimeout(() => {
            paymentButton.style.transform = 'scale(1)';
            paymentButton.style.opacity = '1';
            confirmAndPlaceOrder();
        }, 200);
    } else {
        confirmAndPlaceOrder();
    }
}

function applyMobileOptimizations() {
    const isMobile = window.innerWidth <= 768;
    if (isMobile) {
        const cartItems = document.querySelectorAll('.cart-item');
        cartItems.forEach(item => {
            const controls = item.querySelector('.cart-controls');
            const thumbnail = item.querySelector('.item-thumbnail-container');
            
            if (controls) {
                controls.style.display = 'flex';
                controls.style.visibility = 'visible';
                controls.style.opacity = '1';
            }
            
            if (thumbnail) {
                thumbnail.style.display = 'block';
                thumbnail.style.visibility = 'visible';
            }
        });
    }
}

function animateCartItems() {
    const items = document.querySelectorAll('.cart-item');
    items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.4s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateX(0)';
        }, index * 100);
    });
}

function showCartNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `cart-notification ${type}`;
    
    const icons = {
        success: 'bi-check-circle-fill',
        error: 'bi-exclamation-circle-fill',
        warning: 'bi-exclamation-triangle-fill',
        info: 'bi-info-circle-fill'
    };
    
    notification.innerHTML = `
        <div class="notification-content">
            <i class="bi ${icons[type] || icons.success}"></i>
            <span>${message}</span>
        </div>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 10000;
        transform: translateX(400px);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.1);
        max-width: 300px;
        color: white;
    `;
    
    const colors = {
        success: 'linear-gradient(135deg, #10b981, #059669)',
        error: 'linear-gradient(135deg, #ef4444, #dc2626)',
        warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
        info: 'linear-gradient(135deg, #3b82f6, #1d4ed8)'
    };
    notification.style.background = colors[type] || colors.success;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 3000);
}

function continueShopping() {
    const cartModal = bootstrap.Modal.getInstance(document.getElementById('cartModal'));
    if (cartModal) {
        cartModal.hide();
    }
    showCartNotification('Puedes seguir agregando productos', 'info');
}

// ===== FUNCIÓN PRINCIPAL RENDER CART ITEMS =====
function renderCartItems() {
    const container = document.getElementById('cart-items-container');
    const totalPriceEl = document.getElementById('cart-total-price');
    const pointsToEarnEl = document.getElementById('cart-points-to-earn');
    const cartFooterButtons = document.getElementById('cart-footer-buttons');
    
    if (!container || !totalPriceEl || !pointsToEarnEl || !cartFooterButtons) return;
    
    container.innerHTML = '';
    let currentTotal = 0;
    let totalPoints = 0;
    let totalItems = 0;

    if (!Array.isArray(shoppingCart) || shoppingCart.length === 0) {
        container.innerHTML = `
            <div class="cart-empty-state">
                <div class="cart-empty-icon">
                    <i class="bi bi-cart-x"></i>
                </div>
                <div class="cart-empty-text">Tu carrito está vacío</div>
                <div class="cart-empty-subtext">Agrega algunos productos para comenzar</div>
            </div>
        `;
        totalPriceEl.textContent = '0.00';
        pointsToEarnEl.textContent = '0';
        cartFooterButtons.style.display = 'none'; // MODIFICADO: Ocultar botones
        updateCartDisplay();
        return;
    } else {
        cartFooterButtons.style.display = 'flex'; // MODIFICADO: Mostrar botones
    }

    const cartContainer = document.createElement('div');
    cartContainer.className = 'cart-items';

    shoppingCart.forEach((item, index) => {
        const itemTotal = (parseFloat(item.price) || 0) * (item.quantity || 1);
        const itemPoints = (parseInt(item.points) || 0) * (item.quantity || 1);
        currentTotal += itemTotal;
        totalPoints += itemPoints;
        totalItems += (item.quantity || 1);

        const itemProductId = String(item.productId || item.id || '');
        const hasImage = item.image || item.imageUrl || item.img || item.photo || item.thumbnail || item.picture;

        const placeholderSVG = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiByeD0iOCIgZmlsbD0idXJsKCNncmFkaWVudCkiLz4KPHRleHQgeD0iMjUiIHk9IjI4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmb250LXdlaWdodD0iYm9sZCI+REw8L3RleHQ+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50IiB4MT0iMjUiIHkxPSIwIiB4Mj0iMjUiIHkyPSI1MCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=';

        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.setAttribute('data-product-id', itemProductId);

        cartItem.innerHTML = `
            <div class="item-thumbnail-container">
                ${hasImage ? 
                    `<img src="${hasImage}" 
                         alt="${item.name || 'Producto'}" 
                         class="item-thumbnail"
                         loading="lazy"
                         onerror="this.onerror=null; this.classList.add('fallback'); this.src='${placeholderSVG}';">` :
                    `<div class="item-thumbnail fallback"></div>`
                }
                <div class="quantity-badge ${(item.quantity || 1) > 5 ? 'high-quantity' : ''}">
                    ${item.quantity || 1}
                </div>
            </div>
            
            <div class="item-info">
                <div class="item-name" title="${item.name || 'Producto'}">
                    ${item.name || 'Producto'}
                </div>
                <div class="item-details">
                    <span class="item-price">USD ${itemTotal.toFixed(2)}</span>
                    <span class="item-unit-price">${item.quantity || 1} × $${(parseFloat(item.price) || 0).toFixed(2)}</span>
                    ${itemPoints > 0 ? `<span class="item-points">+${itemPoints} pts</span>` : ''}
                </div>
            </div>
            
            <div class="cart-controls">
                <button class="quantity-btn decrease" 
                        onclick="handleQuantityChange('${itemProductId}', -1, this)"
                        title="Disminuir cantidad"
                        aria-label="Reducir cantidad de ${item.name || 'producto'}">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <span class="quantity-display" aria-live="polite">${item.quantity || 1}</span>
                <button class="quantity-btn increase" 
                        onclick="handleQuantityChange('${itemProductId}', 1, this)"
                        title="Aumentar cantidad"
                        aria-label="Aumentar cantidad de ${item.name || 'producto'}">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button class="remove-btn" 
                        onclick="handleRemoveItem('${itemProductId}', this)"
                        title="Eliminar producto"
                        aria-label="Eliminar ${item.name || 'producto'} del carrito">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;

        cartContainer.appendChild(cartItem);
    });

    container.appendChild(cartContainer);

    const cartSummary = document.createElement('div');
    cartSummary.className = 'cart-summary';
    cartSummary.innerHTML = `
        <div class="summary-row">
            <span class="summary-label">Subtotal (${totalItems} ${totalItems === 1 ? 'producto' : 'productos'})</span>
            <span class="summary-value">USD ${currentTotal.toFixed(2)}</span>
        </div>
        <div class="summary-row">
            <span class="summary-label">Envío</span>
            <span class="summary-value">Gratis</span>
        </div>
        
        <div class="points-summary">
            <div class="points-badge">
                <i class="bi bi-star-fill"></i> Puntos a ganar
            </div>
            <div class="points-text">
                <i class="bi bi-trophy points-icon"></i> ${totalPoints} puntos
            </div>
            <div style="margin-top: 8px; font-size: 0.75rem; color: rgba(255,255,255,0.8);">
                Estos puntos se agregarán después del pago
            </div>
        </div>
    `;
    container.appendChild(cartSummary);

    const totalSection = document.createElement('div');
    totalSection.className = 'total-section';
    totalSection.innerHTML = `
        <div class="total-row">
            <span class="total-label">Total del envío</span>
            <span class="total-amount">USD ${currentTotal.toFixed(2)}</span>
        </div>
        <div style="text-align: center; margin-top: 12px; opacity: 0.8; font-size: 0.8rem;">
            Incluye todos los productos seleccionados
        </div>
    `;
    container.appendChild(totalSection);

    const cartActions = document.createElement('div');
    cartActions.className = 'cart-actions';
    cartActions.innerHTML = `
        <button class="cart-action-btn danger" onclick="clearCart()">
            <i class="bi bi-trash"></i>
            Vaciar Carrito
        </button>
        <button class="cart-action-btn" onclick="continueShopping()">
            <i class="bi bi-arrow-left"></i>
            Seguir Comprando
        </button>
    `;
    container.appendChild(cartActions);

    const paymentMethod = document.createElement('a');
    paymentMethod.href = '#';
    paymentMethod.className = 'payment-method';
    paymentMethod.setAttribute('role', 'button');
    paymentMethod.onclick = (e) => {
        e.preventDefault();
        handlePayment();
    };
    paymentMethod.innerHTML = `
        <div class="payment-info">
            <div class="payment-icon">Z</div>
            <div class="payment-text-content">
                <div class="payment-text">Pagar con Zelle</div>
                <div class="payment-subtext">Procesamiento seguro</div>
            </div>
        </div>
        <i class="bi bi-arrow-right payment-arrow"></i>
    `;
    container.appendChild(paymentMethod);

    totalPriceEl.textContent = currentTotal.toFixed(2);
    pointsToEarnEl.textContent = totalPoints;
    
    updateCartDisplay();
    applyMobileOptimizations();
    setTimeout(animateCartItems, 100);
}



        function generateWhatsAppMessage(orderId, cart, total) {
            let message = `¡Hola! 👋 He realizado un nuevo pedido desde DL Cumanayagua.\n\n`;
            message += `*Nro. de Envío:* ${orderId}\n\n`;
            message += "*Resumen del pedido:*\n";
            cart.forEach(item => {
                message += `- ${item.quantity}x ${item.name}\n`;
            });
            message += `\n*Total:* USD ${total.toFixed(2)}\n\n`;
            message += `Espero instrucciones para el pago. ¡Gracias!`;
            return encodeURIComponent(message);
        }

        function postWhatsAppNotification() {
            showGlobalFeedback("Serás redirigido a WhatsApp. Una vez enviado el mensaje, puedes cerrar esta ventana.", "info", 8000);
            setTimeout(() => {
                cartModalInstance?.hide();
            }, 5000);
        }

        async function confirmAndPlaceOrder() {
            if (!Array.isArray(shoppingCart) || shoppingCart.length === 0) {
                showFeedbackInModal(null, 'order-placement-feedback', "Tu carrito de envío está vacío.", "warning");
                return;
            }
            if (!clientData || !clientData.id) {
                showFeedbackInModal(null, 'order-placement-feedback', 'Inicia sesión para realizar un envío.', 'warning');
                cartModalInstance?.hide();
                openAuthModal('login');
                return;
            }
            showFeedbackInModal(null, 'order-placement-feedback', '<div class="spinner-border spinner-border-sm me-2"></div>Procesando envío...', 'info', null);
            const cartPayload = shoppingCart.map(item => ({ productId: String(item.productId), quantity: item.quantity || 0 }));
            const result = await fetchDataFromGAS('placeOrder', 'POST', { clientId: String(clientData.id), cartItems: cartPayload });

            if (result.success && result.data) {
                const orderTotal = shoppingCart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)), 0);
                const whatsappMessage = generateWhatsAppMessage(result.data.orderId, shoppingCart, orderTotal);
                const whatsappUrl = `https://wa.me/5355189657?text=${whatsappMessage}`;

                const feedbackEl = document.getElementById('order-placement-feedback');
                feedbackEl.innerHTML = `
                    <div class="alert alert-success" role="alert">
                      <h4 class="alert-heading">¡Envío Programado con Éxito!</h4>
                      <p>Tu pedido con ID <strong>#${result.data.orderId}</strong> ha sido registrado. El siguiente paso es notificarnos por WhatsApp para coordinar el pago.</p>
                      <hr>
                      <a href="${whatsappUrl}" target="_blank" class="btn btn-success btn-lg w-100" onclick="postWhatsAppNotification()">
                        <i class="bi bi-whatsapp me-2"></i><strong>Notificar Pedido por WhatsApp</strong>
                      </a>
                    </div>
                `;

                document.getElementById('cart-footer-info').style.display = 'none';
                document.getElementById('cart-footer-buttons').style.display = 'none';

                shoppingCart = [];
                saveCartToStorage();

                if (result.data.updatedClient) {
                    const localAvatar = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.updatedClient;
                    if (localAvatar && !clientData[LOCAL_AVATAR_DATA_KEY]) clientData[LOCAL_AVATAR_DATA_KEY] = localAvatar;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    updateClientDisplayAndUI();
                }

                renderCartItems();
                loadUserOrders();

            } else {
                showFeedbackInModal(null, 'order-placement-feedback', result.message || 'Error al programar el envío.', 'danger');
            }
        }

        async function loadUserOrders() {
            const container = document.getElementById('orders-history-container');
            if (!container) return;
            if (!clientData || !clientData.id) {
                container.innerHTML = `
                    <div class="col-12 text-center p-md-5 p-4">
                        <i class="bi bi-person-fill-lock display-1 text-muted opacity-50 mb-3"></i>
                        <h4 class="text-light mb-2">Acceso VIP Requerido</h4>
                        <p class="text-muted mb-3">Inicia sesión o regístrate para ver tu historial de envíos.</p>
                        <button class="btn btn-warning me-2" onclick="openAuthModal('login')">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesión
                        </button>
                        <button class="btn btn-outline-light" onclick="openAuthModal('register')">
                            <i class="bi bi-person-plus me-2"></i>Registrarme
                        </button>
                    </div>`;
                return;
            }
            container.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);"></div><p class="mt-2 fs-5">Cargando historial de envíos...</p></div>`;
            const result = await fetchDataFromGAS('getUserOrders', 'POST', { clientId: String(clientData.id) });
            if (result.success && Array.isArray(result.data)) {
                if (result.data.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center p-md-5 p-4">
                            <i class="bi bi-box-seam-fill display-1 text-muted opacity-50 mb-3"></i>
                            <h4 class="text-light mb-2">Aún no tienes envíos registrados</h4>
                            <p class="text-muted mb-3">Parece que todavía no has enviado nada. ¿Listo para sorprender a alguien?</p>
                            <button class="btn btn-primary" onclick="showTabAndScroll('menu-tab-link')">
                                <i class="bi bi-card-list me-2"></i>Explorar Menú y Combos
                            </button>
                        </div>`;
                    return;
                }
                let html = '<div class="accordion shadow-sm" id="ordersAccordion">';
                result.data.sort((a,b) => new Date(b.orderdateiso || b.orderdate) - new Date(a.orderdateiso || a.orderdate));
                result.data.forEach((order, index) => {
                    const items = order.itemsjson;
                    let itemsHtml = '<ul class="list-unstyled small ms-3 mt-1">';
                    if (Array.isArray(items) && items.length > 0) {
                        items.forEach(item => {
                            itemsHtml += `<li>${item.quantity}x ${item.name} (USD ${((parseFloat(item.price)||0) * (item.quantity||0)).toFixed(2)})</li>`;
                        });
                    } else { itemsHtml += '<li>No hay detalles de ítems.</li>'; }
                    itemsHtml += '</ul>';
                    let sbc = 'bg-secondary';
                    const os = String(order.status || '').toLowerCase();
                    if (os === 'pendiente de pago' || os === 'pendiente') sbc = 'bg-warning text-dark';
                    else if (os === 'procesado' || os === 'en preparación') sbc = 'bg-info text-dark';
                    else if (os === 'entregado' || os === 'completado') sbc = 'bg-success';
                    else if (os === 'cancelado') sbc = 'bg-danger';
                    const dateStr = order.orderdateiso || order.orderdate;
                    const odf = dateStr ? new Date(dateStr).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric', hour:'2-digit', minute:'2-digit' }) : 'Fecha N/A';
                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="hO${order.orderid}"><button class="accordion-button ${index>0?'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#cO${order.orderid}" aria-expanded="${index===0}" aria-controls="cO${order.orderid}"><span class="me-auto">${odf} - Envío #${String(order.orderid).substr(-6)} - USD ${(parseFloat(order.totalamount)||0).toFixed(2)}</span><span class="badge ${sbc} text-uppercase">${order.status||'N/A'}</span></button></h2>
                            <div id="cO${order.orderid}" class="accordion-collapse collapse ${index===0?'show':''}" aria-labelledby="hO${order.orderid}" data-bs-parent="#ordersAccordion"><div class="accordion-body"><strong>Puntos ${order.pointsgiven?'Otorgados':'A Otorgar'}:</strong> ${order.totalpointsawarded||0}<br><strong>Ítems:</strong>${itemsHtml}</div></div>
                        </div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                 container.innerHTML = `
                    <div class="col-12 text-center p-md-5 p-4">
                        <i class="bi bi-emoji-frown display-1 text-danger opacity-75 mb-3"></i>
                        <h4 class="text-light mb-2">Error al cargar envíos</h4>
                        <p class="text-danger mb-3">${result.message || 'Ocurrió un problema al intentar obtener tu historial.'}</p>
                        <button class="btn btn-outline-secondary" onclick="loadUserOrders()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Intentar de nuevo
                        </button>
                    </div>`;
            }
        }

        async function forceLoadRewards() {
            if (!clientData || !clientData.id) {
                generateRewardsList();
                showGlobalFeedback("Inicia sesión para ver y actualizar recompensas.", "warning");
                return;
            }
            const res = await fetchDataFromGAS('getAvailableRewards', 'GET');
            if (res.success && Array.isArray(res.data)) {
                availableRewards = res.data.map(r => ({...r, rewardid: String(r.rewardid), pointsrequired:parseInt(r.pointsrequired)||0, stock:parseInt(r.stock) }));
                generateRewardsList();
                showGlobalFeedback("Recompensas actualizadas.", "success", 2000);
            } else {
                showGlobalFeedback("No se pudieron actualizar las recompensas.", "warning", 4000);
            }
        }

        function generateRewardsList() {
            const rc = document.getElementById('rewards-container');
            if (!rc) return;
            rc.innerHTML = '';
            if (!clientData || !clientData.id) {
                rc.innerHTML = `
                    <div class="col-12 text-center p-md-5 p-4">
                        <i class="bi bi-person-fill-lock display-1 text-muted opacity-50 mb-3"></i>
                        <h4 class="text-light mb-2">Acceso VIP Requerido</h4>
                        <p class="text-muted mb-3">Inicia sesión o regístrate para descubrir y canjear recompensas exclusivas para tus envíos.</p>
                        <button class="btn btn-warning me-2" onclick="openAuthModal('login')">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesión
                        </button>
                        <button class="btn btn-outline-light" onclick="openAuthModal('register')">
                            <i class="bi bi-person-plus me-2"></i>Registrarme
                        </button>
                    </div>`;
                return;
            }
            if (!availableRewards || availableRewards.length === 0) {
                rc.innerHTML = `
                    <div class="col-12 text-center p-md-5 p-4">
                        <i class="bi bi-gift-fill display-1 text-muted opacity-50 mb-3"></i>
                        <h4 class="text-light mb-2">Aún no hay recompensas disponibles</h4>
                        <p class="text-muted mb-3">Sigue realizando envíos para acumular puntos y estate atento a nuevas recompensas. ¡Pronto podrías canjear grandes beneficios!</p>
                        <button class="btn btn-primary" onclick="showTabAndScroll('menu-tab-link')">
                            <i class="bi bi-bag-heart-fill me-2"></i>Hacer un Envío y Ganar Puntos
                        </button>
                    </div>`;
                return;
            }
            const cp = clientData ? (parseInt(clientData.puntos) || 0) : 0;
            availableRewards.sort((a,b) => (a.pointsrequired||0)-(b.pointsrequired||0));
            availableRewards.forEach(reward => {
                const ca = cp >= reward.pointsrequired;
                const hs = isNaN(reward.stock) || reward.stock === 9999 || reward.stock > 0;
                const cr = ca && hs; 
                const rid = String(reward.rewardid);
                rc.innerHTML += `
                <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
                    <div class="reward-card card w-100 ${!cr ? 'opacity-75' : ''}">
                       <img src="${reward.imageurl || './img/placeholder-product.png'}"
                             class="reward-image card-img-top" alt="${reward.name||'Recompensa'}" loading="lazy"
                             style="cursor: pointer;" onclick="showRewardDetailModal('${rid}')">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-1" style="cursor: pointer;" onclick="showRewardDetailModal('${rid}')">${reward.name||'N/A'}</h5>
                            <p class="card-text small flex-grow-1 mb-3">${(reward.description||'Beneficio para tus envíos.').substring(0,70)}${(reward.description || '').length > 70 ? '...' : ''}</p>
                            <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                                <span class="fw-bold fs-5" style="color: var(--accent-color);">${reward.pointsrequired} Pts</span>
                                ${!isNaN(reward.stock) && reward.stock !== 9999 ? `<span class="small text-muted">Disp: ${reward.stock}</span>` : (reward.stock === 0 ? `<span class="small text-danger fw-bold">Agotado</span>` : `<span class="small text-muted">Ilimitado</span>`)}
                            </div>
                            <button class="btn btn-warning w-100 mt-3" onclick="attemptRedeemReward('${rid}')" ${!cr?'disabled':''}>
                                <i class="bi bi-award-fill me-2"></i> ${cr ? 'Canjear para Envío' : (ca && !hs && reward.stock === 0 ? 'Agotado' : (ca && !hs ? 'Agotado' : 'Puntos Insuf.'))}
                            </button>
                        </div>
                    </div>
                </div>`;
            });
        }

        async function showRewardDetailModal(rewardId) {
            if (!availableRewards || availableRewards.length === 0) await forceLoadRewards();
            const reward = availableRewards.find(r => r.rewardid === rewardId);

            if (!reward) {
                showGlobalFeedback("Recompensa no encontrada.", "danger");
                return;
            }

           document.getElementById('modal-reward-image').src = reward.imageurl || './img/placeholder-product.png';
            document.getElementById('modal-reward-name').textContent = reward.name || 'Sin Nombre';
            document.getElementById('modal-reward-description').textContent = reward.description || 'Descripción no disponible.';
            document.getElementById('modal-reward-points-required').textContent = `${reward.pointsrequired || 0} Puntos`;

            const stockInfoEl = document.getElementById('modal-reward-stock-info');
            if (!isNaN(reward.stock) && reward.stock !== 9999) {
                stockInfoEl.textContent = `Disponibles: ${reward.stock}`;
                stockInfoEl.className = reward.stock > 0 ? 'badge bg-success' : 'badge bg-danger';
            } else if (reward.stock === 0) { 
                 stockInfoEl.textContent = `Agotado`;
                 stockInfoEl.className = 'badge bg-danger fw-bold';
            } else { 
                stockInfoEl.textContent = 'Ilimitado';
                stockInfoEl.className = 'badge bg-info';
            }


            const redeemBtnContainer = document.getElementById('modal-redeem-reward-button-container');
            const clientPoints = clientData ? (parseInt(clientData.puntos) || 0) : 0;
            const canAfford = clientPoints >= reward.pointsrequired;
            const hasStock = isNaN(reward.stock) || reward.stock === 9999 || reward.stock > 0;
            const canRedeem = canAfford && hasStock && clientData && clientData.id;

            if (canRedeem) {
                redeemBtnContainer.innerHTML = `<button class="btn btn-warning btn-lg w-100" onclick="redeemFromDetailModal('${reward.rewardid}')"><i class="bi bi-award-fill me-2"></i>Canjear por ${reward.pointsrequired} Pts</button>`;
            } else if (clientData && clientData.id) {
                let reason = "";
                if (!canAfford) reason = "Puntos insuficientes.";
                else if (!hasStock) reason = "Recompensa agotada.";
                redeemBtnContainer.innerHTML = `<button class="btn btn-secondary btn-lg w-100" disabled><i class="bi bi-x-octagon-fill me-2"></i>No canjeable (${reason})</button>`;
            } else {
                 redeemBtnContainer.innerHTML = `<button class="btn btn-outline-light btn-lg w-100" onclick="if(rewardDetailModalInstance) rewardDetailModalInstance.hide(); openAuthModal('login');"><i class="bi bi-person-check-fill me-2"></i>Iniciar sesión para canjear</button>`;
            }

            generateProductRecommendationsForRewardModal();
            if(rewardDetailModalInstance) rewardDetailModalInstance.show();
        }

        function redeemFromDetailModal(rewardId) {
            if(rewardDetailModalInstance) rewardDetailModalInstance.hide();
            attemptRedeemReward(rewardId);
        }
function generateProductRecommendationsForRewardModal() {
    const recommendationsContainer = document.getElementById('reward-modal-product-recs-row');
    if (!recommendationsContainer) return;
    recommendationsContainer.innerHTML = '';

    if (!menuItems || menuItems.length === 0) {
        recommendationsContainer.innerHTML = '<p class="text-muted small col-12">No hay productos para recomendar en este momento.</p>';
        return;
    }

    // FILTRAR PRODUCTOS AGOTADOS
    let candidates = [...menuItems].filter(item => item.active !== false);
    candidates.sort(() => 0.5 - Math.random());

    const finalRecommendations = candidates.slice(0, 3);

    if (finalRecommendations.length === 0) {
        recommendationsContainer.innerHTML = '<p class="text-muted small col-12">No hay productos para recomendar.</p>';
        return;
    }

    finalRecommendations.forEach(rec => {
    recommendationsContainer.innerHTML += `
    <div class="col-4">
        <div class="recommendation-card" onclick="if(rewardDetailModalInstance) rewardDetailModalInstance.hide(); showProductDetailModal('${rec.id}');">
            <img src="${rec.imageurl || './img/placeholder-product.png'}" alt="${rec.name}" loading="lazy">
            <div class="p-2">
                <div class="rec-title">${rec.name}</div>
                <small class="text-primary fw-bold d-block mt-1">USD ${rec.price.toFixed(2)}</small>
            </div>
        </div>
    </div>`;
});
}

        function generateRewardWhatsAppMessage(rewardName, clientName) {
            let message = `¡Hola! 👋 Acabo de canjear una recompensa desde DL Cumanayagua.\n\n`;
            message += `*Cliente:* ${clientName}\n`;
            message += `*Recompensa Canjeada:* ${rewardName}\n\n`;
            message += `Por favor, tomar nota para mi próximo envío. ¡Gracias!`;
            return encodeURIComponent(message);
        }

        async function attemptRedeemReward(rewardId) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback("Debes iniciar sesión para canjear.", "warning");
                openAuthModal('login');
                return;
            }
            const reward = availableRewards.find(r => r.rewardid === rewardId);
            if (!reward) {
                showGlobalFeedback("Recompensa no encontrada.", "danger");
                return;
            }

            const modalTextEl = document.getElementById('confirmRedeemRewardText');
            const modalFeedbackEl = document.getElementById('redeemRewardFeedback');
            const modalFooterEl = document.getElementById('confirmRedeemRewardFooter');

            if (modalTextEl) modalTextEl.innerHTML = `¿Estás seguro de que quieres canjear "<strong>${reward.name}</strong>" por <strong>${reward.pointsrequired} puntos</strong>?`;
            if (modalFeedbackEl) modalFeedbackEl.innerHTML = '';

            if (modalFooterEl) {
                modalFooterEl.innerHTML = `
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="confirmRedeemRewardButtonDynamicInstance">
                        <i class="bi bi-award-fill me-1"></i>Sí, Canjear Ahora
                    </button>`;

                const confirmButtonDynamic = document.getElementById('confirmRedeemRewardButtonDynamicInstance');
                if (confirmButtonDynamic) {
                    confirmButtonDynamic.onclick = async () => {
                        if (modalFeedbackEl) modalFeedbackEl.innerHTML = `<div class="alert alert-info py-2 small"><div class="spinner-border spinner-border-sm me-2"></div>Procesando canje...</div>`;
                        confirmButtonDynamic.disabled = true;

                        const result = await fetchDataFromGAS('redeemReward', 'POST', { clientId: String(clientData.id), rewardId: rewardId });

                        if (result.success && result.data) {
                            const pointsBefore = clientData.puntos;
                            clientData.puntos = (clientData.puntos || 0) - (reward.pointsrequired || 0);
                            if (clientData.puntos < 0) clientData.puntos = 0;

                            if (result.data.updatedClient) {
                                const serverPoints = result.data.updatedClient.puntos;
                                const localAvatar = clientData[LOCAL_AVATAR_DATA_KEY];
                                clientData = result.data.updatedClient;
                                clientData.puntos = Math.min(pointsBefore - (reward.pointsrequired || 0), serverPoints);
                                if(localAvatar && !clientData[LOCAL_AVATAR_DATA_KEY]) clientData[LOCAL_AVATAR_DATA_KEY] = localAvatar;
                            }

                            localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                            updateClientDisplayAndUI();

                            const whatsappMessage = generateRewardWhatsAppMessage(reward.name, clientData.nombre);
                            const whatsappUrl = `https://wa.me/5355189657?text=${whatsappMessage}`;
                            if (modalFeedbackEl) {
                                modalFeedbackEl.innerHTML = `
                                    <div class="alert alert-success py-2 small">
                                        ${result.message || "¡Recompensa canjeada con éxito!"}
                                        <hr class="my-2">
                                        <a href="${whatsappUrl}" target="_blank" class="btn btn-sm btn-success w-100"
                                           onclick="if(confirmRedeemRewardModalInstance) confirmRedeemRewardModalInstance.hide(); if(rewardDetailModalInstance && rewardDetailModalInstance._isShown) rewardDetailModalInstance.hide();">
                                            <i class="bi bi-whatsapp me-2"></i>Notificar Canje por WhatsApp
                                        </a>
                                    </div>`;
                            }
                            if (modalFooterEl) {
                                modalFooterEl.innerHTML = `<button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="if(rewardDetailModalInstance && rewardDetailModalInstance._isShown) rewardDetailModalInstance.hide();">Cerrar</button>`;
                            }
                            forceLoadRewards();
                        } else {
                            if (modalFeedbackEl) modalFeedbackEl.innerHTML = `<div class="alert alert-danger py-2 small">${result.message || "No se pudo canjear. Intenta de nuevo."}</div>`;
                            if(confirmButtonDynamic) confirmButtonDynamic.disabled = false;
                        }
                    };
                }
            }

            if (confirmRedeemRewardModalInstance) {
                confirmRedeemRewardModalInstance.show();
            }
        }


        function showFeedbackInModal(modalIdUnused, elId, msg, type='info', dur=4000) {
            const div = document.getElementById(elId);
            if (!div) return;
            div.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show small py-2" role="alert">${msg}<button type="button" class="btn-close btn-close-white btn-sm py-2" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
            if (dur !== null && type !== 'info' && !(String(msg).includes('spinner-border'))) {
                 setTimeout(() => { if (div && div.innerHTML.includes(msg)) div.innerHTML = ''; }, dur);
            }
        }

        function showGlobalFeedback(msg, type = 'info', dur = 4000) {
            const toastPlacement = document.getElementById('toastPlacement');
            if (!toastPlacement) {
                alert(`${type.toUpperCase()}: ${msg}`);
                return;
            }
            const toastId = 'liveToast-' + Date.now();
            let tbc = 'bg-primary text-white', bcc = 'btn-close-white';
            if (type === 'danger') { tbc = 'bg-danger text-white'; }
            else if (type === 'success') { tbc = 'bg-success text-white'; }
            else if (type === 'warning') { tbc = 'bg-warning text-dark'; bcc = 'btn-close-dark';}
            const toastHTML = `
                <div class="toast align-items-center ${tbc} border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close ${bcc} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
                </div>`;
            toastPlacement.insertAdjacentHTML('beforeend', toastHTML);
            const toastEl = document.getElementById(toastId);
            if (toastEl) {
                const toastInstance = new bootstrap.Toast(toastEl, {
                    autohide: (dur !== null && !String(msg).includes('spinner-border')),
                    delay: dur
                });
                toastInstance.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }
        }

        function initializeShareModal() {
             const shareModalEl = document.getElementById('sharePageModal');
             if (shareModalEl) {
                shareModalEl.addEventListener('shown.bs.modal', generateQrCodesForSharing);
             }
        }

        function generateQrCodesForSharing() {
            const qrPageCanvas = document.getElementById('qrcodeCanvas');
            const qrAppCanvas = document.getElementById('qrcodeAppCanvas');

            if (qrPageCanvas) {
                qrPageCanvas.innerHTML = '';
                if (qrcodePageInstance) {
                    qrcodePageInstance.clear();
                    qrcodePageInstance = null;
                }
                const pageUrl = window.location.href;
                qrcodePageInstance = new QRCode(qrPageCanvas, {
                    text: pageUrl, width: 130, height: 130,
                    colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
                });

                const sharePageText = encodeURIComponent(`¡Echa un vistazo a DL Cumanayagua para enviar productos a Cuba! ${pageUrl}`);
                document.getElementById('shareViaWhatsAppButton').href = `https://wa.me/?text=${sharePageText}`;
                document.getElementById('shareViaTelegramButton').href = `https://t.me/share/url?url=${encodeURIComponent(pageUrl)}&text=${encodeURIComponent('¡Visita DL Cumanayagua!')}`;
            }

            if (qrAppCanvas) {
                qrAppCanvas.innerHTML = '';
                 if (qrcodeAppInstance) {
                    qrcodeAppInstance.clear();
                    qrcodeAppInstance = null;
                }
                qrcodeAppInstance = new QRCode(qrAppCanvas, {
                    text: APP_DOWNLOAD_LINK, width: 130, height: 130,
                    colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
                });
                const shareAppText = encodeURIComponent(`Descarga la app de DL Cumanayagua para que tu familia en Cuba vea el catálogo: ${APP_DOWNLOAD_LINK}`);
                document.getElementById('shareAppViaWhatsAppButtonModal').href = `https://wa.me/?text=${shareAppText}`;
                document.getElementById('shareAppViaTelegramButtonModal').href = `https://t.me/share/url?url=${encodeURIComponent(APP_DOWNLOAD_LINK)}&text=${encodeURIComponent('Descarga la app DL Cumanayagua')}`;
            }
        }

        function shareAppLinkViaCopy() {
            navigator.clipboard.writeText(APP_DOWNLOAD_LINK).then(() => {
                showGlobalFeedback('¡Enlace de descarga de la App copiado!', 'success', 2500);
            }, (err) => {
                showGlobalFeedback('Error al copiar enlace de la App.', 'danger');
                console.error('Error al copiar enlace de la App: ', err);
            });
        }

        function shareAppLinkViaWhatsApp() {
            const message = encodeURIComponent(`Te comparto el enlace para descargar la App de DL Cumanayagua, para que tu familia en Cuba pueda ver el catálogo de productos: ${APP_DOWNLOAD_LINK}`);
            window.open(`https://wa.me/?text=${message}`, '_blank');
        }


        function setupShareEventListeners() {
            const copyLinkButton = document.getElementById('copyLinkButton');
            if (copyLinkButton) {
                copyLinkButton.addEventListener('click', function() {
                    const pageUrl = window.location.href;
                    navigator.clipboard.writeText(pageUrl).then(function() {
                        showGlobalFeedback('¡Enlace de la página copiado!', 'success', 2000);
                    }, function(err) {
                        showGlobalFeedback('Error al copiar el enlace de la página.', 'danger', 3000);
                        console.error('Error al copiar: ', err);
                    });
                });
            }
        }

        function setupFloatingButtonFeedback() {
            if (floatingCartButtonEl) {
                floatingCartButtonEl.addEventListener('click', function() {
                    floatingCartButtonEl.classList.add('clicked-animation');
                    setTimeout(() => {
                        floatingCartButtonEl.classList.remove('clicked-animation');
                    }, 400);
                });
            }

            const floatingShareButtonEl = document.getElementById('floatingShareButton');
            if (floatingShareButtonEl) {
                floatingShareButtonEl.addEventListener('click', function() {
                    floatingShareButtonEl.classList.add('clicked-animation');
                    setTimeout(() => {
                        floatingShareButtonEl.classList.remove('clicked-animation');
                    }, 400);
                });
            }

            const whatsappButtonEl = document.getElementById('whatsappButton');
            if (whatsappButtonEl) {
                whatsappButtonEl.addEventListener('click', function(event) {
                    whatsappButtonEl.classList.add('clicked-animation');
                    setTimeout(() => {
                        whatsappButtonEl.classList.remove('clicked-animation');
                    }, 400);
                });
            }
        }

        function copyReferralCode() {
            if (clientData && clientData.referralcode) {
                navigator.clipboard.writeText(clientData.referralcode).then(() => {
                    showGlobalFeedback('¡Tu código de referido ha sido copiado!', 'success', 2000);
                }).catch(err => {
                    showGlobalFeedback('Error al copiar el código.', 'danger');
                    console.error('Error al copiar código de referido: ', err);
                });
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { scope: '/TheDo-aLuc-aGroup/' }) 
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar el Service Worker:', error);
                    });
            });
        }
// Agrega esto al final de tu archivo JavaScript
window.addEventListener('resize', function() {
    applyMobileOptimizations();
});

document.addEventListener('DOMContentLoaded', function() {
    applyMobileOptimizations();
    
    // Inicializar funciones globales
    if (typeof handleQuantityChange === 'undefined') {
        window.handleQuantityChange = handleQuantityChange;
    }
    if (typeof handleRemoveItem === 'undefined') {
        window.handleRemoveItem = handleRemoveItem;
    }
    if (typeof handlePayment === 'undefined') {
        window.handlePayment = handlePayment;
    }
});
    </script>
</body>
</html>

