<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta VIP - Doña Lucía</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
:root {
    --primary-color: #F1C40F;
    --accent-color: #E67E22;
    --bg-dark: #141E30;
    --bg-card: #21243D;
    --text-light: #FAFAFA;
    --text-muted: #B0B0B0;
    --radius-lg: 1.5rem;
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.25);
    --transition-fast: all 0.3s ease;
}

body {
    font-family: 'Montserrat', sans-serif;
    background: linear-gradient(135deg, var(--bg-dark) 0%, #243B55 100%);
    color: var(--text-light);
    margin: 0;
    padding: 0;
    min-height: 100vh;
    overflow-x: hidden;
}

.navbar-custom {
    background: #0f1c2d;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    box-shadow: var(--shadow-lg);
}

.navbar-brand {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-color) !important;
}

.navbar .nav-link,
.navbar-text {
    color: var(--text-light);
}

.btn-primary {
    background-color: var(--primary-color);
    border: none;
    color: #000;
    font-weight: 600;
    transition: var(--transition-fast);
}

.btn-primary:hover {
    background-color: #d4ac0d;
}

.btn-outline-secondary { /* Para botones genéricos con este outline */
    border-color: var(--accent-color);
    color: var(--accent-color);
}

.btn-outline-secondary:hover {
    background-color: var(--accent-color);
    color: white;
}

.menu-item-card,
.reward-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: none;
    display: flex;
    flex-direction: column;
    height: 100%;
    transition: var(--transition-fast);
}

.menu-item-card:hover,
.reward-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.4);
}

.product-image,
.reward-image {
    height: 200px;
    object-fit: cover;
    width: 100%;
    border-top-left-radius: var(--radius-lg);
    border-top-right-radius: var(--radius-lg);
    border-bottom: 3px solid var(--primary-color);
}

.card-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 1rem;
}

.card-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.card-text {
    color: var(--text-muted);
    font-size: 0.9rem;
    flex-grow: 1;
}

.price-points-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem; /* Separación del contenido superior */
    padding-top: 0.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.badge {
    font-size: 0.8rem;
    padding: 0.4em 0.6em;
    border-radius: 0.75rem;
}
   /* CSS para ocultar el avatar y su botón de edición */
        #user-avatar,
        #changeAvatarButton,
        #vip-card-container > .text-center.text-md-start > .position-relative.d-inline-block { /* Agrupados para concisión */
            display: none !important;
        }

#filter-container .btn-filter {
    margin: 0.25rem;
    background: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    transition: var(--transition-fast);
}

#filter-container .btn-filter.active,
#filter-container .btn-filter:hover {
    background: var(--primary-color);
    color: #2C3E50; /* Texto oscuro para contraste con fondo primario */
}

.toast {
    border-radius: var(--radius-lg);
    font-weight: 500;
}

.toast-body {
    font-size: 0.9rem;
}

.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(20, 30, 48, 0.8); /* Fondo oscuro semi-transparente */
    display: none; /* Se controla por JS con .show */
    align-items: center;
    justify-content: center;
    z-index: 2000;
    transition: opacity 0.3s ease;
}
.loading-spinner.show { /* Clase para mostrar el spinner */
    display: flex !important; /* Usar !important para asegurar la visualización */
}


.luxury-spinner-inner {
    border: 5px solid rgba(255,255,255,0.1); /* Borde claro semi-transparente */
    border-top: 5px solid var(--primary-color); /* Borde superior con color primario */
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

.luxury-spinner-text {
    margin-top: 1rem;
    color: var(--text-muted);
    font-weight: bold;
}

@keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
}

.modal-content {
    background-color: #1f2a3d; /* Fondo oscuro para modales */
    color: var(--text-light);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
}

.form-control {
    background-color: #2c3e50; /* Fondo oscuro para inputs */
    border: 1px solid #3b4a5a; /* Borde sutil */
    color: white; /* Texto blanco */
}

.form-control:focus {
    border-color: var(--primary-color); /* Borde primario en focus */
    box-shadow: 0 0 0 0.2rem rgba(241, 196, 15, 0.25); /* Sombra de focus */
    background-color: #2c3e50;
    color: white;
}

.nav-pills .nav-link {
    background-color: #2c3e50; /* Fondo para links no activos */
    color: var(--text-light);
    margin: 0 0.25rem;
    border-radius: 0.75rem;
    transition: var(--transition-fast);
}

.nav-pills .nav-link.active {
    background-color: var(--primary-color); /* Fondo primario para link activo */
    color: #2C3E50; /* Texto oscuro para contraste */
    font-weight: 600;
}

.accordion-button {
    background-color: #1f2a3d; /* Fondo para botón de acordeón */
    color: var(--text-light);
    border: none;
}
.accordion-button:not(.collapsed) { /* Estilo para botón de acordeón abierto */
    color: var(--primary-color);
    background-color: #1a2535; /* Un poco más oscuro que el default */
    box-shadow: inset 0 -1px 0 rgba(255,255,255,.1);
}
.accordion-button:focus {
    z-index: 3;
    border-color: var(--primary-color);
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(241,196,15,.25); /* Sombra de focus consistente */
}


.accordion-body {
    background-color: var(--bg-card); /* Fondo del cuerpo del acordeón */
    color: var(--text-light);
}

#vip-card-container {
    background: linear-gradient(135deg, #1a1a2e, #16213e); /* Gradiente para la tarjeta VIP */
    border: 2px solid rgba(241, 196, 15, 0.6); /* Borde con color primario */
    box-shadow: 0 0 25px rgba(241, 196, 15, 0.2), 0 0 60px rgba(0,0,0,0.4); /* Sombras múltiples */
    border-radius: var(--radius-lg);
    color: var(--text-light);
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease;
    padding: 2rem;
    backdrop-filter: blur(10px); /* Efecto de desenfoque (si el navegador lo soporta) */
}

#vip-card-container:hover {
    transform: scale(1.02); /* Ligero zoom al pasar el mouse */
    box-shadow: 0 0 35px rgba(241, 196, 15, 0.4), 0 0 80px rgba(0,0,0,0.5);
}

#vip-card-container::before { /* Efecto de brillo sutil */
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at center, rgba(241,196,15,0.08), transparent 70%);
    transform: rotate(25deg);
    z-index: 0;
}

#vip-card-container * { /* Asegura que el contenido esté sobre el ::before */
    position: relative;
    z-index: 1;
}

#vip-status-badge {
    background: linear-gradient(45deg, #F1C40F, #E67E22); /* Gradiente para el badge VIP */
    color: #2C3E50; /* Texto oscuro para contraste */
    font-size: 0.9rem;
    padding: 0.4em 0.8em;
    border-radius: 2rem; /* Más redondeado */
    font-weight: 700;
    text-shadow: 0 0 3px rgba(0,0,0,0.5); /* Sombra de texto sutil */
}

#user-avatar {
    border: 3px solid #F1C40F; /* Borde primario para el avatar */
    box-shadow: 0 0 15px rgba(241, 196, 15, 0.5); /* Sombra primaria */
    transition: transform 0.3s ease;
    object-fit: cover; /* Asegura que la imagen cubra el área sin distorsionarse */
}

#user-avatar:hover {
    transform: scale(1.05);
    cursor: pointer;
}

#client-name {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
    margin-top: 0.5rem;
}

#client-status {
    font-size: 1rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
}

.points-display {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--primary-color);
}

#client-phone-display {
    font-size: 0.9rem;
    color: var(--text-muted);
}

#changeAvatarButton {
    background: var(--primary-color); /* Fondo primario */
    color: #2C3E50; /* Texto oscuro */
    box-shadow: 0 0 5px rgba(241,196,15,0.6);
    border: none;
}

.cart-nav-button { /* Estilo para el botón del carrito en la navbar */
    position: relative;
    color: var(--text-light);
    background: transparent;
    border: none;
    font-size: 1.5rem; /* Ajusta el tamaño del ícono del carrito */
}
.cart-nav-button:hover {
    color: var(--primary-color);
}

.cart-count-nav { /* Estilo para el contador del carrito */
    position: absolute;
    top: -5px;
    right: -10px;
    background-color: var(--accent-color); /* Color de acento */
    color: white;
    font-size: 0.7rem;
    padding: 0.2em 0.45em;
}


@media (max-width: 1024px) { /* Para tablets grandes y laptops pequeñas */
    .product-image,
    .reward-image {
        height: 180px;
    }
    .card-title {
        font-size: 1rem;
    }
}

@media (max-width: 768px) { /* Para tablets */
    .navbar-brand {
        font-size: 1.25rem;
    }
    .product-image,
    .reward-image {
        height: 160px;
    }
    .card-text {
        font-size: 0.85rem;
    }
    .btn { /* Ajuste general de tamaño de botones */
        font-size: 0.85rem;
    }
    .card-body {
        padding: 0.75rem;
    }
    /* Las clases col-md-6 ya se encargan de 2 columnas aquí */
}

@media (max-width: 576px) { /* Para móviles (Bootstrap sm y xs) */
    /* Las clases col-6 ya se encargan de 2 columnas aquí */
    .product-image,
    .reward-image {
        height: 140px; /* Imágenes más pequeñas en móviles */
    }
    .card-title {
        font-size: 0.95rem;
    }
    .price-points-row { /* Elementos de precio/puntos en columna */
        flex-direction: column;
        gap: 0.25rem;
        align-items: flex-start;
    }
    .btn { /* Botones un poco más pequeños */
        font-size: 0.8rem;
    }
    #client-name { /* Nombre del cliente más pequeño en móviles */
        font-size: 1.5rem;
    }
    .points-display { /* Puntos más pequeños en móviles */
        font-size: 1.5rem;
    }
}
</style>

</head>
<body>
    <input type="file" id="avatarUploadInput" accept="image/jpeg, image/png, image/gif" style="display: none;">

    <nav class="navbar navbar-expand-sm navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-star-half me-2"></i>Doña Lucía</a>
            <div class="ms-auto d-flex align-items-center">
                <div id="auth-buttons-nav" class="d-flex align-items-center">
                    <!-- Botones login/registro o nombre de usuario -->
                </div>
                <button id="logoutButtonNav" class="btn btn-sm btn-outline-warning ms-2" style="display:none;" onclick="logoutClient()"><i class="bi bi-box-arrow-right"></i> Salir</button>
                <div class="nav-item ms-2" id="cartNavItem" style="display: none;">
                    <button class="btn cart-nav-button p-0" type="button" data-bs-toggle="modal" data-bs-target="#cartModal">
                        <i class="bi bi-cart-fill"></i>
                        <span class="badge rounded-pill cart-count-nav" id="cart-count-nav">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5 pt-4 pb-5"> <!-- Ajustado padding para fixed-top navbar y contenido inferior -->
        <div id="vip-card-container" class="vip-card p-md-4 p-3 mb-4 position-relative animate__animated animate__fadeInDown" style="display: none;"> <!-- Padding responsivo -->
            <span class="position-absolute top-0 start-0 m-3 badge" id="vip-status-badge">VIP</span>
            <div class="text-center text-md-start"> <!-- Centrado en móvil, izquierda en md+ -->
                <div class="position-relative d-inline-block">
                    <img id="user-avatar" src="https://via.placeholder.com/80/FFFFFF/2C3E50?Text=VIP" alt="User Avatar" class="rounded-circle mb-2 shadow-sm" width="80" height="80" style="cursor:pointer; display:none;" title="Haz clic para cambiar tu avatar">
                    <button id="changeAvatarButton" class="btn btn-sm position-absolute bottom-0 end-0 mb-2 me-0 rounded-circle p-1 lh-1" title="Cambiar avatar" style="display:none; transform: translate(25%, 25%);">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                </div>
                <h2 class="mb-1 mt-2 mt-md-0" id="client-name">¡Hola!</h2>
            </div>
            <div class="text-center text-md-start mt-2">
                <p class="mb-1 opacity-75" id="client-status">Miembro VIP</p>
                <div class="points-display mb-2" id="client-points">0</div>
                <small id="client-phone-display" class="text-light opacity-75"></small>
            </div>
        </div>
         <div id="guest-prompt" class="alert alert-info text-center shadow-sm animate__animated animate__fadeInUp" style="display: block;">
            <h4><i class="bi bi-award-fill me-2"></i>¡Bienvenido a Doña Lucía!</h4>
            <p class="lead mb-2">Inicia sesión para ver tus puntos y acceder a beneficios exclusivos, o regístrate para empezar a acumular.</p>
        </div>

        <ul class="nav nav-pills nav-fill mb-4 justify-content-center shadow-sm p-2 rounded" style="background-color: rgba(0,0,0,0.2);"> <!-- Fondo semi-transparente para tabs -->
            <li class="nav-item" role="presentation"><a class="nav-link active" id="menu-tab-link" data-bs-toggle="pill" href="#menu-tab" role="tab" aria-controls="menu-tab" aria-selected="true"><i class="bi bi-card-list me-1"></i>Menú</a></li>
            <li class="nav-item" role="presentation"><a class="nav-link" id="rewards-tab-link" data-bs-toggle="pill" href="#rewards-tab" role="tab" aria-controls="rewards-tab" aria-selected="false"><i class="bi bi-gift me-1"></i>Recompensas</a></li>
            <li class="nav-item" role="presentation"><a class="nav-link" id="my-orders-tab-link" data-bs-toggle="pill" href="#my-orders-tab" role="tab" aria-controls="my-orders-tab" aria-selected="false"><i class="bi bi-receipt me-1"></i>Mis Pedidos</a></li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="menu-tab" role="tabpanel" aria-labelledby="menu-tab-link">
                <div class="d-flex justify-content-center align-items-center mb-4">
                    <h3 class="mb-0 me-3 text-center"><i class="bi bi-cup-straw me-2"></i>Nuestro Delicioso Menú</h3>
                    <button class="btn btn-sm btn-outline-secondary" id="refreshMenuButton" onclick="forceLoadMenuItems()" title="Actualizar menú">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div id="filter-container" class="d-flex flex-wrap justify-content-center align-items-center mb-3">
                    <button class="btn btn-sm btn-filter active" onclick="filterMenuByCategory('all')">Todos</button>
                </div>
                <div class="row g-3 g-md-4" id="menu-container"> <!-- g-3 para móviles, g-4 para md+ -->
                    <div class="col-12 text-center p-5">
                        <div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 fs-5">Cargando menú...</p>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="rewards-tab" role="tabpanel" aria-labelledby="rewards-tab-link">
                <h3 class="mb-4 text-center"><i class="bi bi-stars me-2"></i>Recompensas Disponibles</h3>
                <div class="row g-3 g-md-4" id="rewards-container"><div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">Cargando recompensas...</p></div></div>
            </div>
            <div class="tab-pane fade" id="my-orders-tab" role="tabpanel" aria-labelledby="my-orders-tab-link">
                <h3 class="mb-4 text-center"><i class="bi bi-clock-history me-2"></i>Historial de Pedidos</h3>
                <div id="orders-history-container"><div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tus pedidos.</p></div></div>
            </div>
        </div>
    </div>

    <div id="loadingSpinnerUser" class="loading-spinner">
      <div class="luxury-spinner">
        <div class="luxury-spinner-inner"></div>
        <span class="luxury-spinner-text">Cargando...</span>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastPlacement" style="z-index: 2050"> <!-- z-index más alto para toasts --></div>

    <!-- Modales -->
    <div class="modal fade" id="registerUserModal" tabindex="-1" aria-labelledby="registerUserModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="registerUserModalLabel">Crear Cuenta VIP</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="newUserRegistrationForm"><div class="mb-3"><label for="newUserName" class="form-label">Nombre Completo <span class="text-danger">*</span></label><input type="text" class="form-control" id="newUserName" required autocomplete="name"></div><div class="mb-3"><label for="newUserPhone" class="form-label">Teléfono <span class="text-danger">*</span></label><input type="tel" class="form-control" id="newUserPhone" required placeholder="Ej: 5xxxxxxx" autocomplete="tel"></div><div class="mb-3"><label for="newUserEmail" class="form-label">Correo (Opcional)</label><input type="email" class="form-control" id="newUserEmail" autocomplete="email"></div><div class="mb-3"><label for="newUserPassword" class="form-label">Contraseña <span class="text-danger">*</span></label><input type="password" class="form-control" id="newUserPassword" required autocomplete="new-password"></div><div class="mb-3"><label for="newUserConfirmPassword" class="form-label">Confirmar Contraseña <span class="text-danger">*</span></label><input type="password" class="form-control" id="newUserConfirmPassword" required autocomplete="new-password"></div><div id="registration-feedback" class="mt-3"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="handleUserRegistrationAttempt()">Registrarme</button></div></div></div></div>
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="loginModalLabel">Iniciar Sesión VIP</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="loginForm"><div class="mb-3"><label for="loginPhone" class="form-label">Teléfono</label><input type="tel" class="form-control" id="loginPhone" required autocomplete="username tel"></div><div class="mb-3"><label for="loginPassword" class="form-label">Contraseña</label><input type="password" class="form-control" id="loginPassword" required autocomplete="current-password"></div><div id="login-feedback" class="mt-3"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="handleLoginAttempt()">Acceder</button></div></div></div></div>
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="cartModalLabel"><i class="bi bi-cart3 me-2"></i>Mi Pedido</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="cart-items-container"><p class="text-center">Tu carrito está vacío.</p></div><div class="modal-footer justify-content-between flex-wrap"><div class="text-start mb-2 mb-sm-0"><small class="text-muted d-block">Puntos a ganar: <span id="cart-points-to-earn" class="fw-bold">0</span></small><strong class="fs-5">Total: <span id="cart-total-price" style="color: var(--primary-color);">0.00</span> CUP</strong></div><div class="d-flex"><button type="button" class="btn btn-outline-danger me-2" onclick="clearCart()"><i class="bi bi-trash3 me-1"></i>Vaciar</button><button type="button" class="btn btn-success" onclick="confirmAndPlaceOrder()"><i class="bi bi-check-circle me-1"></i>Confirmar</button></div></div><div id="order-placement-feedback" class="m-3"></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const GOOGLE_SCRIPT_URL_USER = 'https://script.google.com/macros/s/AKfycbwAfHYrTED_uAyCCqDc7z8qBuRVvfhuqbFm0e55v9Yaqm4XDlLe4r0NSVVvW-e2305Q/exec'; // ¡¡¡REEMPLAZA ESTA URL!!!
        const LOGGED_IN_CLIENT_KEY = 'cafeteriaVipClientLoggedIn_v8';
        const PRODUCTS_USER_CACHE_KEY = 'cafeteriaUserProductsCache_v8';
        const USER_CART_KEY = 'cafeteriaUserCart_v5';
        const REWARDS_USER_CACHE_KEY = 'cafeteriaUserRewardsCache_v3';
        const MENU_CACHE_EXPIRY_KEY = 'cafeteriaMenuCacheExpiry_v1';
        const CACHE_DURATION_MS = 60 * 60 * 1000; // 1 hora de caché para el menú

        const MAX_AVATAR_DIMENSION = 200; // Píxeles (para ancho o alto máximo)
        const AVATAR_JPEG_QUALITY = 0.75; // Calidad para JPEG (0.0 - 1.0)
        const LOCAL_AVATAR_DATA_KEY = 'localAvatarDataUrl_v1';

        let clientData = null;
        let menuItems = [];
        let availableRewards = [];
        let shoppingCart = [];
        let currentFilterCategory = 'all';

        const loadingSpinnerUser = document.getElementById('loadingSpinnerUser');
        let registrationModalInstance, loginModalInstance, cartModalInstance;

        document.addEventListener('DOMContentLoaded', async function() {
            initializeModals();
            loadCartFromStorage();
            loadClientDataFromStorage();
            updateClientDisplayAndUI();
            await loadMenuItems();
            setupEventListeners();
        });

        function initializeModals() {
            try {
                ['registerUserModal', 'loginModal', 'cartModal'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id === 'registerUserModal') registrationModalInstance = new bootstrap.Modal(el);
                        else if (id === 'loginModal') loginModalInstance = new bootstrap.Modal(el);
                        else if (id === 'cartModal') cartModalInstance = new bootstrap.Modal(el);
                    } else { console.warn(`Modal con ID '${id}' no encontrado.`); }
                });
            } catch (error) { console.error("Error inicializando modales:", error); }
        }

        function setupEventListeners() {
            document.getElementById('registerUserModal')?.addEventListener('hidden.bs.modal', () => clearFormAndFeedback('newUserRegistrationForm', 'registration-feedback'));
            document.getElementById('loginModal')?.addEventListener('hidden.bs.modal', () => clearFormAndFeedback('loginForm', 'login-feedback'));
            document.getElementById('cartModal')?.addEventListener('show.bs.modal', renderCartItems);

            const avatarUploadInputEl = document.getElementById('avatarUploadInput');
            const userAvatarImgEl = document.getElementById('user-avatar');
            const changeAvatarBtnEl = document.getElementById('changeAvatarButton');

            const triggerAvatarUpload = () => {
                if (clientData && clientData.id && avatarUploadInputEl) {
                    avatarUploadInputEl.click();
                } else if (!clientData || !clientData.id) {
                    showGlobalFeedback("Inicia sesión para cambiar tu avatar.", "warning");
                    loginModalInstance?.show();
                }
            };

            if (userAvatarImgEl) {
                userAvatarImgEl.addEventListener('click', triggerAvatarUpload);
            }
            if (changeAvatarBtnEl) {
                 changeAvatarBtnEl.addEventListener('click', triggerAvatarUpload);
            }
            if (avatarUploadInputEl) {
                avatarUploadInputEl.addEventListener('change', handleAvatarFileSelect);
            }

            const rewardsTabEl = document.getElementById('rewards-tab-link');
            if (rewardsTabEl) {
                rewardsTabEl.addEventListener('shown.bs.tab', event => {
                    if (!clientData || !clientData.id) {
                        document.getElementById('rewards-container').innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver y canjear recompensas.</p></div>';
                        return;
                    }
                    loadAvailableRewards(true);
                });
            }
            const ordersTabEl = document.getElementById('my-orders-tab-link');
            if (ordersTabEl) {
                ordersTabEl.addEventListener('shown.bs.tab', event => {
                    loadUserOrders();
                });
            }
        }

        function clearFormAndFeedback(formId, feedbackId) {
            if (formId) {
                const form = document.getElementById(formId);
                if (form) form.reset();
            }
            if (feedbackId) {
                const feedbackEl = document.getElementById(feedbackId);
                if (feedbackEl) feedbackEl.innerHTML = '';
            }
        }

        async function fetchDataFromGAS(action, method = 'POST', payloadData = null) {
            console.log(`[fetchDataFromGAS] Acción: ${action}, Método: ${method}, Payload (primeros 200 chars):`, JSON.stringify(payloadData).substring(0, 200));
            if (GOOGLE_SCRIPT_URL_USER === 'PON_AQUI_LA_URL_DE_TU_SCRIPT_DESPLEGADO' || !GOOGLE_SCRIPT_URL_USER || GOOGLE_SCRIPT_URL_USER.length < 20 || !GOOGLE_SCRIPT_URL_USER.includes('script.google.com')) {
                showGlobalFeedback("Error de Configuración: URL del script no definida o inválida. Por favor, contacta al administrador.", "danger", null); 
                if (loadingSpinnerUser) loadingSpinnerUser.classList.remove('show');
                return { success: false, message: 'GOOGLE_SCRIPT_URL_USER no configurada o inválida.' };
            }
            if (loadingSpinnerUser) loadingSpinnerUser.classList.add('show');
            
            try {
                let url = GOOGLE_SCRIPT_URL_USER;
                const options = { method: method, headers: {}, mode: 'cors', redirect: 'follow' };

                if (method === 'GET') {
                    const params = new URLSearchParams({ action: action, cacheBuster: new Date().getTime() });
                    if (payloadData) {
                        for (const key in payloadData) {
                            if (payloadData.hasOwnProperty(key)) { params.append(key, payloadData[key]); }
                        }
                    }
                    url += `?${params.toString()}`;
                } else { 
                    options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
                    const dataToSend = { action: action, payload: payloadData };
                    const formBody = new URLSearchParams();
                    formBody.append("data", JSON.stringify(dataToSend));
                    options.body = formBody.toString();
                }
                
                const res = await fetch(url, options);
                const responseText = await res.text();
                
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (parseError) {
                    console.error(`[fetchDataFromGAS] Error parseando JSON para ${action}:`, parseError, "Respuesta original (primeros 300):", responseText.substring(0,300));
                    if (responseText.toLowerCase().includes("<title>error</title>") || responseText.toLowerCase().includes("script function not found")) {
                         throw new Error(`Error en el servidor de Google Apps Script. Revisa la consola del script.`);
                    }
                    throw new Error(`Respuesta no es JSON válido del servidor: ${responseText.substring(0,150)}`);
                }
                return responseData;

            } catch (error) {
                console.error(`Excepción en fetchDataFromGAS (Acción: ${action}):`, error);
                showGlobalFeedback(`Error de conexión o servidor: ${error.message || 'Desconocido'}. Intenta de nuevo.`, "danger", 7000);
                return { success: false, message: `Error de conexión o servidor: ${error.message || 'Desconocido'}.` };
            } finally {
                if (loadingSpinnerUser) loadingSpinnerUser.classList.remove('show');
            }
        }

        function loadClientDataFromStorage() {
            const storedClientData = localStorage.getItem(LOGGED_IN_CLIENT_KEY);
            if (storedClientData) {
                try {
                    clientData = JSON.parse(storedClientData);
                } catch (e) {
                    localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
                    clientData = null;
                }
            } else {
                clientData = null;
            }
        }

        function updateClientDisplayAndUI() {
            const el = id => document.getElementById(id);
            const authNavContainer = el('auth-buttons-nav');
            const logoutNavButton = el('logoutButtonNav');
            const vipCardContainer = el('vip-card-container');
            const guestPromptContainer = el('guest-prompt');
            const userAvatarImg = el('user-avatar');
            const changeAvatarBtn = el('changeAvatarButton');

            if (clientData && clientData.id && (clientData.verificado === true || String(clientData.verificado).toLowerCase() === 'true')) {
                el('client-name').textContent = `¡Hola, ${clientData.nombre ? clientData.nombre.split(' ')[0] : 'Amigo'}!`;
                el('client-points').textContent = clientData.puntos !== undefined ? clientData.puntos : 0;
                el('client-status').textContent = `Nivel: ${(clientData.puntos||0)>=150?"Oro":(clientData.puntos||0)>=75?"Plata":"Bronce"}`;
                el('client-phone-display').textContent = clientData.telefono ? `Tel: ${clientData.telefono}` : '';
                el('vip-status-badge').style.display = 'inline-block';
                if(userAvatarImg) userAvatarImg.style.display = 'inline-block';

                if (userAvatarImg) {
                    if (clientData[LOCAL_AVATAR_DATA_KEY] && typeof clientData[LOCAL_AVATAR_DATA_KEY] === 'string') {
                        userAvatarImg.src = clientData[LOCAL_AVATAR_DATA_KEY];
                    } else if (clientData.avatarurl && typeof clientData.avatarurl === 'string' && clientData.avatarurl.trim() !== '') {
                         userAvatarImg.src = clientData.avatarurl + (clientData.avatarurl.includes('?') ? '&t=' : '?t=') + new Date().getTime();
                    } else {
                        userAvatarImg.src = 'https://via.placeholder.com/80/FFFFFF/2C3E50?Text=VIP';
                    }
                }
                if (changeAvatarBtn) changeAvatarBtn.style.display = 'block';
                if(authNavContainer) authNavContainer.innerHTML = `<span class="navbar-text text-light me-2 small">Hola, ${clientData.nombre ? clientData.nombre.split(' ')[0] : 'VIP'}</span>`;
                if(logoutNavButton) logoutNavButton.style.display = 'inline-block';
                if(vipCardContainer) vipCardContainer.style.display = 'block';
                if(guestPromptContainer) guestPromptContainer.style.display = 'none';
            } else {
                el('client-name').textContent = `¡Bienvenido!`;
                el('client-points').textContent = 0;
                el('client-status').textContent = "Inicia sesión o regístrate.";
                el('client-phone-display').textContent = '';
                el('vip-status-badge').style.display = 'none';
                if(userAvatarImg) userAvatarImg.style.display = 'none';
                if (userAvatarImg) userAvatarImg.src = 'https://via.placeholder.com/80/FFFFFF/2C3E50?Text=VIP';
                if (changeAvatarBtn) changeAvatarBtn.style.display = 'none';
                if(authNavContainer) authNavContainer.innerHTML = `<button class="btn btn-sm btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="bi bi-box-arrow-in-right"></i> Login</button><button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#registerUserModal"><i class="bi bi-person-plus"></i> Registro</button>`;
                if(logoutNavButton) logoutNavButton.style.display = 'none';
                if(vipCardContainer) vipCardContainer.style.display = 'none';
                if(guestPromptContainer) guestPromptContainer.style.display = 'block';
                
                const ordersHistoryContainer = el('orders-history-container');
                if (ordersHistoryContainer) ordersHistoryContainer.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tus pedidos.</p></div>';
                const rewardsContainer = el('rewards-container');
                if (rewardsContainer) rewardsContainer.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver y canjear recompensas.</p></div>';
            }
            updateCartDisplay();
        }

        function logoutClient() {
            clientData = null;
            localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
            shoppingCart = [];
            availableRewards = [];
            localStorage.removeItem(USER_CART_KEY);
            localStorage.removeItem(REWARDS_USER_CACHE_KEY);
            updateClientDisplayAndUI();
            showGlobalFeedback('Sesión cerrada. ¡Vuelve pronto!', 'info');

            const activeTab = document.querySelector('.nav-pills .nav-link.active');
            if (activeTab) {
                const activeTabHref = activeTab.getAttribute('href');
                if (activeTabHref === '#my-orders-tab') {
                     const ordersContainer = document.getElementById('orders-history-container');
                     if(ordersContainer) ordersContainer.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tus pedidos.</p></div>';
                } else if (activeTabHref === '#rewards-tab') {
                     const rewardsContainer = document.getElementById('rewards-container');
                     if(rewardsContainer) rewardsContainer.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver y canjear recompensas.</p></div>';
                }
            }
        }

        async function handleUserRegistrationAttempt() {
            const nombre = document.getElementById('newUserName').value.trim();
            const telefono = document.getElementById('newUserPhone').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('newUserConfirmPassword').value;
            const feedbackElId = 'registration-feedback';

            if (!nombre || !telefono || !password || !confirmPassword) {
                showFeedbackInModal(null, feedbackElId, 'Todos los campos marcados con * son requeridos.', 'danger'); return;
            }
            if (password !== confirmPassword) {
                showFeedbackInModal(null, feedbackElId, 'Las contraseñas no coinciden.', 'danger'); return;
            }
            if (!/^\d{7,15}$/.test(telefono)) {
                showFeedbackInModal(null, feedbackElId, 'Por favor, ingresa un número de teléfono válido (7-15 dígitos, solo números).', 'danger'); return;
            }
             if (password.length < 6) {
                showFeedbackInModal(null, feedbackElId, 'La contraseña debe tener al menos 6 caracteres.', 'danger'); return;
            }
            showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Registrando...', 'info', null);
            const payload = { nombre, telefono, email, password };
            const result = await fetchDataFromGAS('registerNewUser', 'POST', payload);
            if (result.success) {
                showFeedbackInModal(null, feedbackElId, `${result.message || '¡Registro exitoso!'} Ahora puedes iniciar sesión.`, 'success', 4000);
                document.getElementById('newUserRegistrationForm').reset();
                setTimeout(() => {
                    registrationModalInstance?.hide();
                    loginModalInstance?.show();
                }, 3000);
            } else {
                showFeedbackInModal(null, feedbackElId, result.message || 'Error al registrar. Intenta de nuevo.', 'danger');
            }
        }

        async function handleLoginAttempt() {
            const telefono = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;
            const feedbackElId = 'login-feedback';
            if (!telefono || !password) {
                showFeedbackInModal(null, feedbackElId, 'Teléfono y contraseña son requeridos.', 'danger'); return;
            }
            showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Iniciando sesión...', 'info', null);
            const payload = { telefono, password };
            const result = await fetchDataFromGAS('loginUser', 'POST', payload);
            if (result.success && result.data) {
                clientData = result.data;
                localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                updateClientDisplayAndUI();
                showFeedbackInModal(null, feedbackElId, `¡Bienvenido de nuevo, ${clientData.nombre.split(' ')[0]}!`, 'success', 3000);
                setTimeout(() => loginModalInstance?.hide(), 2000);
                
                loadMenuItems(true); 
                loadAvailableRewards(true);
                loadUserOrders();
            } else {
                showFeedbackInModal(null, feedbackElId, result.message || 'Error al iniciar sesión. Verifica tus datos.', 'danger');
            }
        }

        async function handleAvatarFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showGlobalFeedback('Por favor, selecciona un archivo de imagen (JPEG, PNG, GIF).', 'warning');
                event.target.value = null; return;
            }
            const maxSizeInBytes = 2 * 1024 * 1024; 
            if (file.size > maxSizeInBytes) {
                showGlobalFeedback('La imagen es demasiado grande (máx 2MB antes de comprimir).', 'warning');
                event.target.value = null; return;
            }

            showGlobalFeedback('Procesando imagen...', 'info', null);

            try {
                const compressedDataUrl = await compressImage(file, file.type);
                if (clientData && clientData.id) {
                    clientData[LOCAL_AVATAR_DATA_KEY] = compressedDataUrl;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    
                    const userAvatarImg = document.getElementById('user-avatar');
                    if(userAvatarImg) userAvatarImg.src = compressedDataUrl;
                    showGlobalFeedback('Avatar actualizado localmente. Subiendo al servidor...', 'info', 3000);
                } else {
                    showGlobalFeedback('Error: No hay sesión de usuario activa para guardar el avatar local.', 'danger');
                    event.target.value = null; return;
                }
                
                const parts = compressedDataUrl.split(';base64,');
                const contentType = parts[0].split(':')[1];
                const imageData = parts[1];
                await uploadClientAvatar(imageData, contentType, file.name);

            } catch (error) {
                showGlobalFeedback(`Error al procesar la imagen: ${error.message}`, 'danger');
            } finally {
                event.target.value = null;
            }
        }

        function compressImage(file, originalMimeType) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_AVATAR_DIMENSION) {
                                height = Math.round(height * MAX_AVATAR_DIMENSION / width);
                                width = MAX_AVATAR_DIMENSION;
                            }
                        } else {
                            if (height > MAX_AVATAR_DIMENSION) {
                                width = Math.round(width * MAX_AVATAR_DIMENSION / height);
                                height = MAX_AVATAR_DIMENSION;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', AVATAR_JPEG_QUALITY));
                    };
                    img.onerror = () => reject(new Error("No se pudo cargar la imagen para compresión."));
                };
                reader.onerror = () => reject(new Error("Error leyendo el archivo de imagen."));
            });
        }

        async function uploadClientAvatar(imageData, contentType, filename) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback('Debes iniciar sesión para cambiar tu avatar.', 'warning'); return;
            }
            const payload = {
                clientId: clientData.id,
                imageData: imageData, 
                contentType: contentType, 
                filename: "avatar_" + clientData.id + "_" + Date.now() + "." + (contentType.split('/')[1] || 'jpg')
            };

            const result = await fetchDataFromGAS('updateClientAvatar', 'POST', payload);
            if (result.success && result.data && result.data.newAvatarUrl) {
                if (result.data.clientData) {
                    const localAvatarTemp = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.clientData;
                    if (localAvatarTemp && !clientData[LOCAL_AVATAR_DATA_KEY]) {
                        clientData[LOCAL_AVATAR_DATA_KEY] = localAvatarTemp;
                    }
                    if (result.data.newAvatarUrl) clientData.avatarurl = result.data.newAvatarUrl;
                } else {
                     clientData.avatarurl = result.data.newAvatarUrl;
                }
                localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                showGlobalFeedback('¡Avatar guardado con éxito en el servidor!', 'success');
            } else {
                showGlobalFeedback(result.message || 'Error al guardar el avatar en el servidor. Se mantiene la versión local.', 'warning');
            }
        }

        async function loadMenuItems(forceRefresh = false) {
            const menuContainer = document.getElementById('menu-container');
            if (!menuContainer) { return; }
            
            const cachedProducts = localStorage.getItem(PRODUCTS_USER_CACHE_KEY);
            const cacheExpiryString = localStorage.getItem(MENU_CACHE_EXPIRY_KEY);
            const now = new Date().getTime();
            const cacheExpiry = cacheExpiryString ? parseInt(cacheExpiryString) : 0;

            if (!forceRefresh && cachedProducts && cacheExpiry && now < cacheExpiry) {
                try {
                    menuItems = JSON.parse(cachedProducts);
                    generateCategoryFilters();
                    filterMenuByCategory(currentFilterCategory);
                    return;
                } catch(e) {
                    localStorage.removeItem(PRODUCTS_USER_CACHE_KEY);
                    localStorage.removeItem(MENU_CACHE_EXPIRY_KEY);
                }
            }
            menuContainer.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">${forceRefresh ? 'Actualizando' : 'Cargando'} menú...</p></div>`;
            const res = await fetchDataFromGAS('getPublicProducts', 'GET');
            if (res.success && Array.isArray(res.data)) {
                menuItems = res.data.map(p => ({
                    ...p,
                    price: parseFloat(p.price) || 0,
                    points: parseInt(p.points) || 0,
                    id: String(p.id),
                    category: p.category || "Otros"
                }));
                localStorage.setItem(PRODUCTS_USER_CACHE_KEY, JSON.stringify(menuItems));
                localStorage.setItem(MENU_CACHE_EXPIRY_KEY, (now + CACHE_DURATION_MS).toString());
                generateCategoryFilters();
                filterMenuByCategory(currentFilterCategory);
                if (forceRefresh) showGlobalFeedback("Menú actualizado.", "success", 2000);
            } else {
                menuContainer.innerHTML = `<div class="col-12 text-center p-5"><p class="text-danger fs-5">Error al ${forceRefresh ? 'actualizar' : 'cargar'} el menú: ${res.message || 'Desconocido.'}</p></div>`;
                if (cachedProducts) {
                    try {
                        menuItems = JSON.parse(cachedProducts);
                        generateCategoryFilters(); filterMenuByCategory(currentFilterCategory);
                        showGlobalFeedback("No se pudo actualizar el menú, mostrando última versión disponible.", "warning", 4000);
                    } catch(e) { /* Cache corrupto */ }
                }
            }
        }

        function forceLoadMenuItems() {
            loadMenuItems(true);
        }

        function generateCategoryFilters() {
            const filterContainer = document.getElementById('filter-container');
            if (!filterContainer || !menuItems || menuItems.length === 0) {
                if(filterContainer) filterContainer.innerHTML = '';
                return;
            }
            const categories = [...new Set(menuItems.map(item => item.category || "Otros"))].sort((a,b) => a.localeCompare(b));
            
            const allButton = filterContainer.querySelector('.btn-filter[onclick*="all"]');
            filterContainer.innerHTML = ''; // Limpiar todo
            if (allButton) filterContainer.appendChild(allButton); // Re-agregar el botón "Todos"
            else { // Si no existe, crearlo
                const newAllButton = document.createElement('button');
                newAllButton.className = 'btn btn-sm btn-filter active';
                newAllButton.textContent = 'Todos';
                newAllButton.onclick = () => filterMenuByCategory('all');
                filterContainer.appendChild(newAllButton);
            }


            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-filter';
                btn.textContent = category;
                btn.onclick = () => filterMenuByCategory(category);
                filterContainer.appendChild(btn);
            });
            // Asegurar que el filtro actual se aplique visualmente
             const currentActiveButton = filterContainer.querySelector(`.btn-filter.active`);
             if(currentActiveButton) currentActiveButton.classList.remove('active');
             const newActiveButton = Array.from(filterContainer.querySelectorAll('.btn-filter')).find(
                btn => (btn.textContent.toLowerCase() === currentFilterCategory.toLowerCase()) || (currentFilterCategory === 'all' && btn.textContent.toLowerCase() === 'todos')
            );
            if (newActiveButton) newActiveButton.classList.add('active');
        }

        function filterMenuByCategory(category) {
            currentFilterCategory = category;
            const filterButtons = document.querySelectorAll('#filter-container .btn-filter');
            filterButtons.forEach(btn => {
                const btnCategoryText = btn.textContent.trim().toLowerCase();
                const targetCategory = category.toLowerCase();
                if (btnCategoryText === targetCategory || (targetCategory === 'all' && btnCategoryText === 'todos')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            generateMenu();
        }

        function generateMenu() {
            const menuContainer = document.getElementById('menu-container');
            if (!menuContainer) return;
            menuContainer.innerHTML = '';
            
            const itemsToDisplay = currentFilterCategory === 'all' ?
                                   menuItems :
                                   menuItems.filter(item => (item.category || "Otros") === currentFilterCategory);
            
            if (!itemsToDisplay || itemsToDisplay.length === 0) {
                menuContainer.innerHTML = `<div class="col-12 text-center p-5"><p class="fs-5">No hay productos disponibles ${currentFilterCategory === 'all' ? '' : 'en la categoría "' + currentFilterCategory + '"'}.</p></div>`;
                return;
            }

            itemsToDisplay.sort((a,b) => (a.name || "").localeCompare(b.name || "")).forEach(item => {
                let placeholderText = encodeURIComponent(item.name || 'Producto');
                if (item.category) {
                    const catLower = item.category.toLowerCase();
                    if (catLower.includes('pizza')) placeholderText = 'Pizza';
                    else if (catLower.includes('bebida')) placeholderText = 'Bebida';
                    else if (catLower.includes('hamburguesa')) placeholderText = 'Hamburguesa';
                }
                const itemId = String(item.id);

                menuContainer.innerHTML += `
                <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
                    <div class="menu-item-card card w-100 d-flex flex-column">
                        <img src="${item.imageurl || 'https://via.placeholder.com/350x220/E74C3C/FFF?text=' + placeholderText}" class="product-image card-img-top" alt="${item.name || 'Producto'}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${item.name || 'Sin Nombre'}</h5>
                            <p class="card-text flex-grow-1">${item.description || 'Deliciosa opción de nuestro menú.'}</p>
                            <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                                <span class="fw-bold fs-5" style="color: var(--primary-color);">${(item.price || 0).toFixed(2)} CUP</span>
                                <span class="badge bg-success text-white">+${item.points || 0} Puntos</span>
                            </div>
                            <button class="btn btn-primary mt-3 w-100" onclick="addToCart('${itemId}')">
                                <i class="bi bi-cart-plus-fill me-2"></i>Añadir
                            </button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function loadCartFromStorage(){ 
            const storedCart = localStorage.getItem(USER_CART_KEY); 
            shoppingCart = storedCart ? (JSON.parse(storedCart) || []) : [];
            updateCartDisplay();
        }
        
        function saveCartToStorage(){ 
            try {
                localStorage.setItem(USER_CART_KEY, JSON.stringify(shoppingCart));
            } catch(e) {
                showGlobalFeedback("No se pudo guardar el carrito. Espacio de almacenamiento lleno?", "danger");
            }
        }

        function addToCart(productId) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback('Inicia sesión para añadir productos al carrito.', 'warning');
                loginModalInstance?.show(); return;
            }
            if (!menuItems || menuItems.length === 0) {
                showGlobalFeedback("Error: El menú no está cargado. Intenta recargar la página.", "danger"); return;
            }
            const product = menuItems.find(item => item.id === productId); 
            if (!product) {
                showGlobalFeedback("Producto no encontrado.", "danger"); return;
            }

            const existingItem = shoppingCart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity = (existingItem.quantity || 0) + 1;
            } else {
                shoppingCart.push({
                    productId: product.id, name: product.name, 
                    price:parseFloat(product.price)||0, quantity:1, points:parseInt(product.points)||0
                });
            }
            saveCartToStorage(); updateCartDisplay(); renderCartItems();
            showGlobalFeedback(`${product.name} añadido al carrito!`, 'success', 2000);
        }

        function updateCartQuantity(productId, change) {
            const itemInCart = shoppingCart.find(item => item.productId === productId);
            if (itemInCart) {
                itemInCart.quantity += change;
                if (itemInCart.quantity <= 0) {
                    shoppingCart = shoppingCart.filter(item => item.productId !== productId);
                }
            }
            saveCartToStorage(); renderCartItems(); updateCartDisplay();
        }

        function removeFromCart(productId) {
            shoppingCart = shoppingCart.filter(item => item.productId !== productId);
            saveCartToStorage(); renderCartItems(); updateCartDisplay();
            showGlobalFeedback("Producto eliminado del carrito.", "info", 1500);
        }

        function clearCart() {
            if (shoppingCart.length === 0) {
                showFeedbackInModal(null, 'order-placement-feedback', 'El carrito ya está vacío.', 'info', 2000); return;
            }
            if (confirm("¿Estás seguro de que quieres vaciar tu carrito?")) {
                shoppingCart = []; saveCartToStorage(); renderCartItems(); updateCartDisplay();
                showFeedbackInModal(null, 'order-placement-feedback', 'Carrito vaciado.', 'info', 2000);
            }
        }

        function updateCartDisplay() {
            const cartCountNavEl = document.getElementById('cart-count-nav');
            const cartNavItemEl = document.getElementById('cartNavItem');
            let totalItems = Array.isArray(shoppingCart) ? shoppingCart.reduce((s, i) => s + (i.quantity || 0), 0) : 0;

            if (cartCountNavEl) cartCountNavEl.textContent = totalItems;
            if (cartNavItemEl) cartNavItemEl.style.display = (totalItems > 0 && clientData && clientData.id) ? 'block' : 'none';
            
            const pointsEl = document.getElementById('cart-points-to-earn');
            if(pointsEl) pointsEl.textContent = Array.isArray(shoppingCart) ? shoppingCart.reduce((s,i)=>s+((i.points||0)*(i.quantity||0)),0) : 0;
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            const totalPriceEl = document.getElementById('cart-total-price');
            const pointsToEarnEl = document.getElementById('cart-points-to-earn');

            if (!container || !totalPriceEl || !pointsToEarnEl) return;
            container.innerHTML = ''; let currentTotal = 0; let totalPoints = 0;

            if (!Array.isArray(shoppingCart) || shoppingCart.length === 0) {
                container.innerHTML = '<p class="text-center py-4 fs-5">Tu carrito está vacío.</p>';
                totalPriceEl.textContent = '0.00'; pointsToEarnEl.textContent = '0';
                updateCartDisplay(); return;
            }

            const ul = document.createElement('ul'); 
            ul.className = 'list-group list-group-flush';
            
            shoppingCart.forEach(item => {
                const itemTotal = (parseFloat(item.price) || 0) * (item.quantity || 0);
                const itemPoints = (item.points || 0) * (item.quantity || 0);
                currentTotal += itemTotal; totalPoints += itemPoints;
                const itemProductId = String(item.productId);

                const li = document.createElement('li'); 
                li.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2 py-3 bg-transparent text-light border-secondary';
                li.innerHTML = `
                    <div class="me-auto">
                        <strong class="d-block">${item.name || 'Desconocido'}</strong>
                        <small class="text-muted">${item.quantity||0} x ${(parseFloat(item.price)||0).toFixed(2)} CUP</small>
                    </div>
                    <div class="fw-bold me-3 fs-5">${itemTotal.toFixed(2)} CUP</div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary px-2 py-1" onclick="updateCartQuantity('${itemProductId}',-1)"><i class="bi bi-dash-lg"></i></button>
                        <span class="btn btn-light disabled px-3 py-1 border-secondary text-dark">${item.quantity||0}</span>
                        <button class="btn btn-outline-secondary px-2 py-1" onclick="updateCartQuantity('${itemProductId}',1)"><i class="bi bi-plus-lg"></i></button>
                        <button class="btn btn-outline-danger ms-2 px-2 py-1" onclick="removeFromCart('${itemProductId}')"><i class="bi bi-trash"></i></button>
                    </div>`;
                ul.appendChild(li);
            });
            container.appendChild(ul); 
            totalPriceEl.textContent = currentTotal.toFixed(2);
            pointsToEarnEl.textContent = totalPoints;
            updateCartDisplay();
        }

        async function confirmAndPlaceOrder() {
            if (!Array.isArray(shoppingCart) || shoppingCart.length === 0) { 
                showFeedbackInModal(null, 'order-placement-feedback', "Tu carrito está vacío.", "warning"); return; 
            }
            if (!clientData || !clientData.id) { 
                showFeedbackInModal(null, 'order-placement-feedback', 'Inicia sesión para realizar un pedido.', 'warning'); 
                cartModalInstance?.hide(); loginModalInstance?.show(); return; 
            }
            showFeedbackInModal(null, 'order-placement-feedback', '<div class="spinner-border spinner-border-sm me-2"></div>Procesando pedido...', 'info', null);
            
            const cartPayload = shoppingCart.map(item => ({ productId: String(item.productId), quantity: item.quantity || 0 }));
            const result = await fetchDataFromGAS('placeOrder', 'POST', { clientId: String(clientData.id), cartItems: cartPayload });
            
            if (result.success && result.data) {
                showFeedbackInModal(null, 'order-placement-feedback', `${result.message || 'Pedido realizado!'} ID: ${result.data.orderId}`, 'success', 7000);
                shoppingCart = []; saveCartToStorage();
                
                if (result.data.updatedClient) {
                    const localAvatar = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.updatedClient;
                    if (localAvatar && !clientData[LOCAL_AVATAR_DATA_KEY]) clientData[LOCAL_AVATAR_DATA_KEY] = localAvatar;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    updateClientDisplayAndUI(); 
                }
                setTimeout(() => { 
                    cartModalInstance?.hide(); clearFormAndFeedback(null, 'order-placement-feedback'); 
                    loadUserOrders(); renderCartItems(); 
                }, 4000);
            } else {
                showFeedbackInModal(null, 'order-placement-feedback', result.message || 'Error al realizar el pedido.', 'danger');
            }
        }

        async function loadUserOrders() {
            const container = document.getElementById('orders-history-container'); 
            if (!container) return;
            if (!clientData || !clientData.id) { 
                container.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tu historial.</p></div>'; return; 
            }
            container.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);"></div><p class="mt-2 fs-5">Cargando historial...</p></div>`;
            
            const result = await fetchDataFromGAS('getUserOrders', 'POST', { clientId: String(clientData.id) });
            
            if (result.success && Array.isArray(result.data)) {
                if (result.data.length === 0) { 
                    container.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Aún no has realizado ningún pedido.</p></div>'; return; 
                }
                let html = '<div class="accordion shadow-sm" id="ordersAccordion">';
                result.data.sort((a,b) => new Date(b.orderdateiso || b.orderdate) - new Date(a.orderdateiso || a.orderdate));

                result.data.forEach((order, index) => {
                    const items = order.itemsjson; 
                    let itemsHtml = '<ul class="list-unstyled small text-muted ms-3 mt-1">';
                    if (Array.isArray(items) && items.length > 0) {
                        items.forEach(item => { 
                            itemsHtml += `<li>${item.quantity}x ${item.name} (${((parseFloat(item.price)||0) * (item.quantity||0)).toFixed(2)} CUP)</li>`; 
                        });
                    } else { itemsHtml += '<li>No hay detalles de ítems.</li>'; }
                    itemsHtml += '</ul>';
                    
                    let sbc = 'bg-secondary';
                    const os = String(order.status || '').toLowerCase();
                    if (os === 'pendiente') sbc = 'bg-warning text-dark';
                    else if (os === 'procesado' || os === 'en preparación') sbc = 'bg-info text-dark';
                    else if (os === 'entregado' || os === 'completado') sbc = 'bg-success';
                    else if (os === 'cancelado') sbc = 'bg-danger';
                    
                    const dateStr = order.orderdateiso || order.orderdate;
                    const odf = dateStr ? new Date(dateStr).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric', hour:'2-digit', minute:'2-digit' }) : 'Fecha N/A';

                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="hO${order.orderid}"><button class="accordion-button ${index>0?'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#cO${order.orderid}" aria-expanded="${index===0}" aria-controls="cO${order.orderid}"><span class="me-auto">${odf} - #${String(order.orderid).substr(-6)} - ${(parseFloat(order.totalamount)||0).toFixed(2)}</span><span class="badge ${sbc} text-uppercase">${order.status||'N/A'}</span></button></h2>
                            <div id="cO${order.orderid}" class="accordion-collapse collapse ${index===0?'show':''}" aria-labelledby="hO${order.orderid}" data-bs-parent="#ordersAccordion"><div class="accordion-body"><strong>Puntos ${order.pointsgiven?'Otorgados':'A Otorgar'}:</strong> ${order.totalpointsawarded||0}<br><strong>Ítems:</strong>${itemsHtml}</div></div>
                        </div>`;
                });
                html += '</div>'; container.innerHTML = html;
            } else {
                container.innerHTML = `<div class="col-12 text-center p-5"><p class="text-danger fs-5">Error al cargar historial: ${result.message || 'Error.'}</p></div>`;
            }
        }

        async function loadAvailableRewards(forceReload = false) {
            const rc = document.getElementById('rewards-container'); 
            if (!rc) return;
            if (!clientData || !clientData.id) { 
                rc.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver recompensas.</p></div>'; return; 
            }
            const cachedRewards = localStorage.getItem(REWARDS_USER_CACHE_KEY);
            if (!forceReload && cachedRewards) {
                try { availableRewards = JSON.parse(cachedRewards); generateRewardsList(); return; }
                catch(e) { localStorage.removeItem(REWARDS_USER_CACHE_KEY); }
            }
            
            rc.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);"></div><p class="mt-2 fs-5">${forceReload ? 'Actualizando' : 'Cargando'} recompensas...</p></div>`;
            const res = await fetchDataFromGAS('getAvailableRewards', 'GET');
            
            if (res.success && Array.isArray(res.data)) {
                availableRewards = res.data.map(r => ({...r, rewardid: String(r.rewardid), pointsrequired:parseInt(r.pointsrequired)||0, stock:parseInt(r.stock) }));
                localStorage.setItem(REWARDS_USER_CACHE_KEY, JSON.stringify(availableRewards));
                generateRewardsList();
            } else {
                rc.innerHTML = `<div class="col-12 text-center p-5"><p class="text-danger fs-5">No se pudo cargar recompensas: ${res.message||'Error.'}</p></div>`;
                 if (cachedRewards) {
                    try { availableRewards = JSON.parse(cachedRewards); generateRewardsList(); 
                          showGlobalFeedback("No se actualizaron recompensas, mostrando caché.", "warning", 4000);
                    } catch(e) { /* Cache corrupto */ }
                }
            }
        }

        function generateRewardsList() {
            const rc = document.getElementById('rewards-container'); 
            if (!rc) return; rc.innerHTML = '';
            
            if (!clientData || !clientData.id) { 
                rc.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver recompensas.</p></div>'; return;
            }
            if (!availableRewards || availableRewards.length === 0) { 
                rc.innerHTML = '<div class="col-12 text-center p-5"><p class="fs-5">No hay recompensas disponibles.</p></div>'; return; 
            }

            const cp = clientData ? (parseInt(clientData.puntos) || 0) : 0;
            availableRewards.sort((a,b) => (a.pointsrequired||0)-(b.pointsrequired||0));
            
            availableRewards.forEach(reward => {
                const ca = cp >= reward.pointsrequired;
                const hs = isNaN(reward.stock) || reward.stock === 9999 || reward.stock > 0; 
                const cr = ca && hs;
                const rid = String(reward.rewardid);

                rc.innerHTML += `
                <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
                    <div class="reward-card card w-100 ${!cr ? 'opacity-75' : ''}">
                        <img src="${reward.imageurl || 'https://via.placeholder.com/350x220/F1C40F/2C3E50?text=' + encodeURIComponent(reward.name||'Recompensa')}" class="reward-image card-img-top" alt="${reward.name||'Recompensa'}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-1">${reward.name||'N/A'}</h5>
                            <p class="card-text small text-muted flex-grow-1 mb-3">${reward.description||'Beneficio VIP.'}</p>
                            <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                                <span class="fw-bold fs-5" style="color: var(--accent-color);">${reward.pointsrequired} Pts</span>
                                ${!isNaN(reward.stock) && reward.stock !== 9999 ? `<span class="small text-muted">Disp: ${reward.stock}</span>` : '<span class="small text-muted">Ilimitado!</span>'}
                            </div>
                            <button class="btn btn-warning w-100 mt-3" onclick="attemptRedeemReward('${rid}')" ${!cr?'disabled':''}>
                                <i class="bi bi-award-fill me-2"></i> ${cr ? 'Canjear' : (ca&&!hs ? 'Agotado' : 'Insuficientes')}
                            </button>
                        </div>
                    </div>
                </div>`;
            });
        }

        async function attemptRedeemReward(rewardId) {
            if (!clientData || !clientData.id) { 
                showGlobalFeedback("Debes iniciar sesión para canjear.", "warning"); loginModalInstance?.show(); return; 
            }
            const reward = availableRewards.find(r => r.rewardid === rewardId);
            if (!reward) { showGlobalFeedback("Recompensa no encontrada.", "danger"); return; }
            if (!confirm(`¿Canjear "${reward.name}" por ${reward.pointsrequired} puntos?`)) return;
            
            showGlobalFeedback("Procesando canje...", "info", null);
            const result = await fetchDataFromGAS('redeemReward', 'POST', { clientId: String(clientData.id), rewardId: rewardId });
            
            if (result.success && result.data) {
                showGlobalFeedback(result.message || "¡Recompensa canjeada!", "success", 5000);
                if (result.data.updatedClient) {
                    const localAvatar = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.updatedClient;
                    if(localAvatar && !clientData[LOCAL_AVATAR_DATA_KEY]) clientData[LOCAL_AVATAR_DATA_KEY] = localAvatar;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    updateClientDisplayAndUI();
                }
                loadAvailableRewards(true); 
            } else {
                showGlobalFeedback(result.message || "No se pudo canjear. Intenta de nuevo.", "danger", 7000);
            }
        }

        function showFeedbackInModal(modalIdUnused, elId, msg, type='info', dur=4000) {
            const div = document.getElementById(elId); 
            if (!div) return;
            div.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show small py-2" role="alert">${msg}<button type="button" class="btn-close btn-close-white btn-sm py-2" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
            if (dur !== null && type !== 'info' && !(String(msg).includes('spinner-border'))) {
                 setTimeout(() => { if (div && div.innerHTML.includes(msg)) div.innerHTML = ''; }, dur);
            }
        }

        function showGlobalFeedback(msg, type = 'info', dur = 4000) {
            const toastPlacement = document.getElementById('toastPlacement');
            if (!toastPlacement) { alert(`${type.toUpperCase()}: ${msg}`); return; }
            const toastId = 'liveToast-' + Date.now();
            
            let tbc = 'bg-primary text-white', bcc = 'btn-close-white'; // Default para info
            if (type === 'danger') { tbc = 'bg-danger text-white'; }
            else if (type === 'success') { tbc = 'bg-success text-white'; }
            else if (type === 'warning') { tbc = 'bg-warning text-dark'; bcc = 'btn-close-dark';}

            const toastHTML = `
                <div class="toast align-items-center ${tbc} border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close ${bcc} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
                </div>`;
            toastPlacement.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastEl = document.getElementById(toastId);
            if (toastEl) {
                const toastInstance = new bootstrap.Toast(toastEl, { 
                    autohide: (dur !== null && !String(msg).includes('spinner-border')), 
                    delay: dur 
                });
                toastInstance.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }
        }
    </script>
</body>
</html>
