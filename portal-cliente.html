<!DOCTYPE html>
<html lang="es" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta VIP - Doña Lucía</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <meta name="description" content="Con DL USD Cumanayagua, compra fácil y seguro productos, alimentos y regalos para tus seres queridos en Cumanayagua, Cuba. Paga cómodamente desde USA con Zelle.">
    <meta property="og:title" content="DL USD Cumanayagua: ¡Sorprende a tu Familia en Cuba!" />
    <meta property="og:description" content="Envía amor comprando productos en Cumanayagua. Compra online desde USA para tu familia en Cuba y paga con Zelle. ¡Fácil, rápido y con cariño!" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://erick890406.github.io/TheDo-aLuc-aGroup/portal-cliente-usd.html" />
    <meta property="og:site_name" content="DL USD Cumanayagua" />
    <meta property="og:image" content="https://i.postimg.cc/x8hj4gKx/Dl-Usd-2-cuamanayagua.png" />
    <meta property="og:image:secure_url" content="https://i.postimg.cc/x8hj4gKx/Dl-Usd-2-cuamanayagua.png" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="628" />
    <meta property="og:image:alt" content="Envía productos a Cuba - DL USD Cumanayagua" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Envía a Cuba con DL USD Cumanayagua" />
    <meta name="twitter:description" content="Compra para tu familia en Cumanayagua desde USA. Paga con Zelle. Alimentos, regalos y más. ¡Visítanos!" />
    <meta name="twitter:image" content="https://i.postimg.cc/jjNmrcyw/Meta-Etiqueta.png" />
    <meta name="twitter:image:alt" content="Promoción DL USD Cumanayagua para compras familiares en Cuba" />
    <link rel="manifest" href="manifest.json">
<style>
:root {
    /* Nueva Paleta Azul - Calma, Poder, Seriedad */
    --primary-color: #3B7DDD; /* Un azul profesional y confiable para CTAs y acentos principales */
    --accent-color: #6096BA;  /* Un azul más suave y calmado para acentos secundarios */
    --bg-dark: #0A192F;       /* Azul marino muy oscuro, casi negro, para el fondo principal - Poder y Seriedad */
    --bg-card: #172A45;       /* Azul oscuro para tarjetas, ligeramente más claro que el fondo - Profundidad */
    --text-light: #CCD6F6;    /* Un blanco azulado muy claro para texto sobre fondos oscuros - Calma y legibilidad */
    --text-muted: #8892B0;    /* Un gris azulado para texto secundario - Sutileza */
    
    --radius-lg: 1.25rem; /* Ligeramente menos redondeado para un look más formal */
    --shadow-lg: 0 8px 20px rgba(0,0,0,0.2);
    --transition-fast: all 0.25s ease-in-out;
    --primary-color-rgb: 59, 125, 221; /* RGB de --primary-color */
    --accent-color-rgb: 96, 150, 186; /* RGB de --accent-color */
    --bg-card-rgb: 23, 42, 69; /* RGB de --bg-card */
    --text-light-rgb: 204, 214, 246; /* RGB de --text-light */
    --bg-dark-rgb: 10, 25, 47; /* RGB de --bg-dark */
}

body {
    font-family: 'Montserrat', sans-serif;
    background: linear-gradient(135deg, var(--bg-dark) 0%, #0D203C 100%); /* Degradado sutil de azules oscuros */
    color: var(--text-light);
    margin: 0;
    padding: 0;
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: 0px; /* Será ajustado por JS */
    display: flex;
    flex-direction: column;
}

main {
    flex-grow: 1;
}

.text-muted {
    color: var(--text-muted) !important;
}
.text-warning { /* Reemplazar el uso de text-warning con el color primario */
    color: var(--primary-color) !important;
}

.navbar-custom {
    background: #071325; /* Un poco más oscuro que bg-dark para distinción */
    border-bottom: 1px solid rgba(var(--primary-color-rgb),0.2);
    box-shadow: var(--shadow-lg);
    z-index: 1030;
}

.navbar-brand {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--text-light) !important; /* Marca en color claro */
}
.navbar-brand img { /* Ajustar logo si es necesario */
    /* filter: brightness(0) invert(1); */ /* Comentado o eliminado */
}


.navbar .nav-link,
.navbar-text {
    color: var(--text-muted); /* Texto de navegación más sutil */
}
.navbar .nav-link:hover,
.navbar .nav-link.active {
    color: var(--text-light); /* Resaltar al pasar el mouse o activo */
}
.navbar-toggler {
    border-color: rgba(var(--primary-color-rgb), 0.5);
}
.navbar-toggler-icon {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(var(--primary-color-rgb), 0.9)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
}
.navbar-collapse {
    background-color: #071325; /* Consistente con la barra de navegación */
}
@media (max-width: 575.98px) {
    .navbar-collapse {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        padding: 1rem;
        box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        border-top: 1px solid rgba(var(--primary-color-rgb),0.1);
    }
    .navbar-nav .nav-item {
        margin-bottom: 0.5rem;
    }
    .navbar-nav .nav-link {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
    }
    .navbar-nav .nav-link:hover {
        background-color: rgba(var(--primary-color-rgb),0.1);
        color: var(--primary-color);
    }
}


.btn-primary {
    background-color: var(--primary-color);
    border: none;
    color: #fff; /* Texto blanco para contraste con azul primario */
    font-weight: 600;
    transition: var(--transition-fast);
}

.btn-primary:hover {
    background-color: #2F67C0; /* Azul primario ligeramente más oscuro al pasar el mouse */
    color: #fff;
}

.btn-warning { /* Reemplazar estilos de btn-warning */
    background-color: var(--primary-color);
    border: none;
    color: #fff;
    font-weight: 600;
    transition: var(--transition-fast);
}
.btn-warning:hover {
    background-color: #2F67C0;
    color: #fff;
}
.btn-outline-warning { /* Reemplazar estilos de btn-outline-warning */
    border-color: var(--primary-color);
    color: var(--primary-color);
}
.btn-outline-warning:hover {
    background-color: var(--primary-color);
    color: #fff;
}


.btn-outline-secondary {
    border-color: var(--accent-color);
    color: var(--accent-color);
}

.btn-outline-secondary:hover {
    background-color: var(--accent-color);
    color: var(--text-light);
}

.menu-item-card,
.reward-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15); /* Sombra más sutil */
    border: 1px solid rgba(var(--accent-color-rgb), 0.15); /* Borde sutil */
    display: flex;
    flex-direction: column;
    height: 100%;
    transition: var(--transition-fast);
}

.menu-item-card:hover,
.reward-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    border-color: rgba(var(--accent-color-rgb), 0.3);
}

.product-image,
.reward-image {
    width: 100%;
    aspect-ratio: 3 / 4;
    object-fit: cover;
    border-top-left-radius: var(--radius-lg);
    border-top-right-radius: var(--radius-lg);
    border-bottom: 2px solid var(--accent-color); /* Borde con color de acento */
}

.card-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 1.25rem; /* Un poco más de padding */
}

.card-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.card-text {
    color: var(--text-muted);
    font-size: 0.9rem;
    flex-grow: 1;
}

.reward-card .card-text {
    color: var(--text-light);
}

.price-points-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 0.75rem; /* Aumentado */
    border-top: 1px solid rgba(var(--text-light-rgb),0.1);
}
.price-points-row .fw-bold { /* Precio de producto */
    color: var(--primary-color);
}


.badge {
    font-size: 0.8rem;
    padding: 0.4em 0.6em;
    border-radius: 0.75rem;
}
.badge.bg-success { /* Mantener verde para éxito o cambiar a un azul claro */
    background-color: #28a745 !important; /* O var(--accent-color) si se prefiere */
    color: white !important;
}


#user-avatar,
#changeAvatarButton,
#vip-card-container > .text-center.text-md-start > .position-relative.d-inline-block {
    display: none !important;
}

#filter-container .btn-filter {
    margin: 0.25rem;
    background: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    transition: var(--transition-fast);
}

#filter-container .btn-filter.active,
#filter-container .btn-filter:hover {
    background: var(--primary-color);
    color: #fff; /* Texto blanco en botón activo */
}

.toast {
    border-radius: var(--radius-lg);
    font-weight: 500;
}
/* Estilos para toasts ya definidos, solo asegurar consistencia con la paleta */
.toast.bg-primary { background-color: var(--primary-color) !important; color: white; }
.toast.bg-success { background-color: #28a745 !important; color: white; } /* Mantener verde o cambiar */
.toast.bg-danger { background-color: #dc3545 !important; color: white; } /* Mantener rojo o cambiar */
.toast.bg-warning { background-color: var(--accent-color) !important; color: var(--bg-dark); } /* Usar acento para warning */


.toast-body {
    font-size: 0.9rem;
}

.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(var(--bg-dark-rgb), 0.85); /* Fondo oscuro del spinner */
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    transition: opacity 0.3s ease;
}
.loading-spinner.show {
    display: flex !important;
}


.luxury-spinner-inner {
    border: 5px solid rgba(var(--text-light-rgb),0.1);
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

.luxury-spinner-text {
    margin-top: 1rem;
    color: var(--text-muted);
    font-weight: bold;
}

@keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
}

.modal-content {
    background-color: var(--bg-card); /* Fondo de modal consistente */
    color: var(--text-light);
    border-radius: var(--radius-lg);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); /* Sombra de modal */
    border: 1px solid rgba(var(--accent-color-rgb), 0.2);
}

#helpModal .accordion-button {
    background-color: var(--bg-dark); /* Fondo de botón de acordeón */
    color: var(--text-light);
}
#helpModal .accordion-button:not(.collapsed) {
    color: var(--primary-color);
    background-color: var(--bg-card); /* Fondo de botón de acordeón activo */
}
#helpModal .accordion-body {
    background-color: #0F1E36; /* Un poco más claro que bg-dark para cuerpo de acordeón */
    font-size: 0.95rem;
}
#helpModal .accordion-item {
    border: 1px solid rgba(var(--accent-color-rgb),0.1);
    margin-bottom: 0.5rem;
    border-radius: 0.5rem;
    overflow: hidden;
}


.form-control {
    background-color: #10213B; /* Fondo de input */
    border: 1px solid var(--accent-color);
    color: var(--text-light);
}

.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgb), 0.25);
    background-color: #10213B;
    color: var(--text-light);
}
.form-select.bg-dark { /* Selector con fondo oscuro */
    background-color: #10213B !important;
    border-color: var(--accent-color);
    color: var(--text-light);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%233B7DDD' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
}


.nav-pills {
    background-color: rgba(var(--bg-card-rgb),0.5); /* Fondo semi-transparente para pills */
    padding: 0.5rem;
    border-radius: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.nav-pills .nav-item {
    flex-grow: 1;
    flex-basis: 0;
    min-width: 100px;
}

.nav-pills .nav-link {
    background-color: var(--bg-card); /* Fondo de link de pill */
    color: var(--text-muted);
    border-radius: 0.75rem;
    transition: var(--transition-fast);
    padding: 0.6rem 0.5rem;
    font-size: 0.85rem;
    text-align: center;
    display: block;
    width: 100%;
}

.nav-pills .nav-link:hover {
    background-color: #23395B; /* Fondo de link de pill al pasar el mouse */
    color: var(--text-light);
}

.nav-pills .nav-link.active {
    background-color: var(--primary-color);
    color: #fff; /* Texto blanco en pill activa */
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(var(--primary-color-rgb),0.3);
}

.accordion-button {
    background-color: var(--bg-card);
    color: var(--text-light);
    border: none;
}
.accordion-button:not(.collapsed) {
    color: var(--primary-color);
    background-color: #10213B; /* Fondo de acordeón activo */
    box-shadow: inset 0 -1px 0 rgba(var(--primary-color-rgb),.15);
}
.accordion-button:focus {
    z-index: 3;
    border-color: var(--primary-color);
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgb),.25);
}


.accordion-body {
    background-color: #0F1E36; /* Un poco más claro que bg-dark para cuerpo de acordeón */
    color: var(--text-light);
}

#vip-card-container {
    background: linear-gradient(135deg, #172A45, #0A192F);
    border: 2px solid rgba(var(--primary-color-rgb), 0.6);
    box-shadow: 0 0 25px rgba(var(--primary-color-rgb), 0.15), 0 0 50px rgba(0,0,0,0.3);
    border-radius: var(--radius-lg);
    color: var(--text-light);
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease;
    padding: 2rem;
    backdrop-filter: blur(5px);
    text-align: center; /* Centrará el texto de los elementos hijos directos */
}

/* NUEVO: Contenedor para el contenido que se quiere centrar */
.vip-card-content-centered {
    /* Este div no necesita mucho estilo si #vip-card-container ya usa text-align: center */
}

/* Ajuste específico para el contenedor del código de referido para que el strong y el botón se centren */
#client-referral-code-container .d-flex {
    justify-content: center !important; /* Asegura el centrado */
}

#vip-card-container:hover {
    transform: scale(1.02);
    box-shadow: 0 0 35px rgba(var(--primary-color-rgb), 0.3), 0 0 70px rgba(0,0,0,0.4);
}

#vip-card-container::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at center, rgba(var(--primary-color-rgb),0.06), transparent 70%); /* Efecto de luz más sutil */
    transform: rotate(25deg);
    z-index: 0;
}

#vip-card-container * {
    position: relative;
    z-index: 1;
}

#vip-status-badge {
    background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); /* Degradado azul para badge */
    color: #fff; /* Texto blanco */
    font-size: 0.9rem;
    padding: 0.4em 0.8em;
    border-radius: 2rem;
    font-weight: 700;
    text-shadow: 0 0 3px rgba(0,0,0,0.3);
}

#user-avatar {
    border: 3px solid var(--primary-color);
    box-shadow: 0 0 15px rgba(var(--primary-color-rgb), 0.4);
    transition: transform 0.3s ease;
    object-fit: cover;
}

#user-avatar:hover {
    transform: scale(1.05);
    cursor: pointer;
}

#client-name {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-light); /* Nombre del cliente en color claro */
    margin-top: 0.5rem;
}

#client-status {
    font-size: 1rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
}

.points-display {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--primary-color); /* Puntos en color primario */
}

#client-phone-display {
    font-size: 0.9rem;
    color: var(--text-muted);
}

#changeAvatarButton {
    background: var(--primary-color);
    color: #fff;
    box-shadow: 0 0 5px rgba(var(--primary-color-rgb),0.5);
    border: none;
}
#clientReferralCode {
    color: var(--primary-color) !important; /* Código de referido en color primario */
}

#cartNavItem {
    display: none !important;
}


#downloadAppBanner {
    background-color: var(--bg-dark) !important; /* Usar el fondo oscuro definido */
    border-top: 3px solid var(--primary-color);
    animation-duration: 0.6s;
    z-index: 1040;
}
#downloadAppBanner .fs-5 strong i.text-warning {
    color: var(--primary-color) !important; /* Icono de estrella en color primario */
}


.floating-buttons-container {
    position: fixed;
    bottom: 25px;
    right: 25px;
    z-index: 1035;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.floating-button {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    color: white;
    font-size: 1.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
    border: 2px solid rgba(var(--text-light-rgb), 0.1); /* Borde más sutil */
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    padding: 0;
    cursor: pointer;
    text-decoration: none;
}

.floating-button:hover {
    transform: scale(1.1) translateY(-3px);
}

.floating-button.clicked-animation {
    animation: fabPulse 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

@keyframes fabPulse {
    0% {
        transform: scale(1);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
    }
    50% {
        transform: scale(0.9);
        box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.4);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
    }
}

#floatingCartButton {
    background: linear-gradient(145deg, var(--accent-color), var(--primary-color)); /* Degradado azul para carrito */
    color: #fff;
    position: relative;
}
#floatingCartButton:hover {
     box-shadow: 0 10px 25px rgba(var(--primary-color-rgb), 0.4);
}

#whatsappButton { /* Mantener verde de WhatsApp */
    background: linear-gradient(145deg, #25D366, #128C7E);
}
#whatsappButton:hover {
    box-shadow: 0 10px 25px rgba(37, 211, 102, 0.4);
}
#floatingShareButton { /* Botón de compartir con azules serios */
    background: linear-gradient(145deg, var(--bg-card), var(--bg-dark));
}
#floatingShareButton:hover {
    box-shadow: 0 10px 25px rgba(var(--accent-color-rgb), 0.3);
}

.floating-cart-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: var(--bg-dark); /* Fondo oscuro */
    color: var(--primary-color); /* Texto en color primario */
    font-size: 0.8rem;
    font-weight: bold;
    padding: 0.3em 0.6em;
    border-radius: 50%;
    border: 1.5px solid var(--primary-color);
    min-width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

#productDetailModal .modal-content {
    border: 1px solid rgba(var(--accent-color-rgb),0.2);
}

#modal-product-image {
    width: 100%;
    aspect-ratio: 4 / 5;
    object-fit: cover;
    border-radius: 1rem;
    border: 2px solid var(--primary-color);
}

#modal-product-name {
    font-family: 'Playfair Display', serif;
    color: var(--text-light); /* Nombre de producto en modal */
}

#modal-product-price, #cart-total-price {
    color: var(--primary-color) !important; /* Precio en modal y carrito */
    font-size: 1.75rem;
    font-weight: 700;
}
#cart-footer-info .text-warning i {
    color: var(--accent-color) !important; /* Icono de Zelle */
}


#modal-recommendations-container h5 {
    color: var(--text-light);
    border-bottom: 1px solid rgba(var(--text-light-rgb),0.15);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.recommendation-card {
    background: var(--bg-card);
    border-radius: 1rem;
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition-fast);
    border: 1px solid transparent;
}

.recommendation-card:hover {
    transform: translateY(-4px);
    border-color: var(--accent-color);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.recommendation-card img {
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
}

.recommendation-card .rec-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-light);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.recommendation-card .rec-title + small.text-primary { /* Precio en recomendación */
     color: var(--accent-color) !important; /* Usar acento para no competir con el principal */
}

.footer-custom {
    background-color: #071325; /* Mismo que navbar para consistencia */
    color: var(--text-muted);
    border-top: 3px solid var(--primary-color);
    margin-top: auto;
}

.footer-avatar {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid var(--accent-color);
}

.footer-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    color: var(--text-light);
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
}

.footer-custom h5 {
    color: var(--text-light);
}
.footer-custom h5.text-uppercase.fw-bold[style*="color: var(--primary-color);"] {
    color: var(--text-light) !important; /* Título principal del footer en claro */
}


.footer-link {
    color: var(--text-muted);
    text-decoration: none;
    transition: var(--transition-fast);
    display: inline-block;
    margin-bottom: 0.5rem;
}

.footer-link:hover {
    color: var(--primary-color);
    transform: translateX(5px);
}

.social-icons .social-icon-link {
    font-size: 1.5rem;
    color: var(--text-muted);
    transition: var(--transition-fast);
}

.social-icons .social-icon-link:hover {
    color: var(--primary-color);
    transform: translateY(-2px);
}

.footer-refresh-btn {
    width: 35px;
    height: 35px;
    background-color: rgba(var(--bg-card-rgb), 0.8);
    border: 1px solid rgba(var(--text-light-rgb), 0.1);
    border-radius: 50%;
    color: var(--text-muted);
    transition: var(--transition-fast);
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.footer-refresh-btn:hover {
    color: var(--accent-color);
    background-color: var(--bg-card);
}

#quick-nav-buttons {
    position: fixed;
    bottom: 260px; /* Será ajustado por JS */
    right: 30px;
    z-index: 1034;
    display: none;
    flex-direction: column;
    gap: 0.5rem;
}

.quick-nav-btn {
    width: 45px;
    height: 45px;
    background-color: rgba(var(--bg-card-rgb), 0.8);
    backdrop-filter: blur(5px);
    color: var(--primary-color);
    border: 1px solid rgba(var(--text-light-rgb), 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    text-decoration: none;
    transition: all 0.3s ease;
}

.quick-nav-btn:hover {
    background-color: var(--bg-card);
    color: var(--accent-color);
    transform: scale(1.1);
}

#presentationVideoDialog.modal-xl {
    max-width: 95vw;
}
#presentationVideoContent {
}
#introVideo {
    display: block;
    width: 100%;
    height: auto;
    max-height: 90vh;
}

#modal-reward-image {
    border-color: var(--accent-color) !important;
}
#modal-reward-name {
    color: var(--text-light) !important; /* Nombre de recompensa */
}
#modal-reward-points-required {
    color: var(--accent-color) !important; /* Puntos de recompensa */
}
#confirmRedeemRewardModal .text-warning i,
#rewardDetailModal .btn-warning,
#rewardDetailModal .btn-warning:hover { /* Botones y elementos de "warning" para recompensas */
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: var(--bg-dark) !important;
}
#rewardDetailModal .btn-warning:hover {
    background-color: #5289A3 !important; /* Acento más oscuro al pasar el mouse */
}
#modal-reward-stock-info.bg-success { background-color: #28a745 !important; }
#modal-reward-stock-info.bg-danger { background-color: #dc3545 !important; }
#modal-reward-stock-info.bg-info { background-color: var(--accent-color) !important; color: var(--bg-dark) !important; }


@media (max-width: 768px) {
    .navbar-brand { font-size: 1.25rem; }
    .card-text { font-size: 0.85rem; }
    .btn { font-size: 0.85rem; }
    .card-body { padding: 0.75rem; }
    #downloadAppBanner .container { flex-direction: column; text-align: center; }
    #downloadAppBanner .me-3.mb-2.mb-md-0 { margin-bottom: 0.75rem !important; }

    .floating-buttons-container { bottom: 20px; right: 20px; }
    .floating-button { width: 60px; height: 60px; font-size: 1.6rem; }
    .floating-cart-count { font-size: 0.75rem; min-width: 22px; height: 22px; top: -6px; right: -6px; }

    #quick-nav-buttons {
        bottom: 235px;
        right: 20px;
    }
    .quick-nav-btn { width: 40px; height: 40px; font-size: 1.2rem; }
}

@media (max-width: 576px) {
    .card-title { font-size: 0.95rem; }
    .price-points-row { flex-direction: column; gap: 0.25rem; align-items: flex-start; }
    .btn { font-size: 0.8rem; }
    #client-name { font-size: 1.5rem; }
    .points-display { font-size: 1.5rem; }
    .nav-pills .nav-link { font-size: 0.8rem; padding: 0.5rem; }
    .nav-pills .nav-item { min-width: 90px; }

    .floating-buttons-container { bottom: 15px; right: 15px; }
    .floating-button { width: 55px; height: 55px; font-size: 1.5rem; }
    .floating-cart-count { font-size: 0.7rem; min-width: 20px; height: 20px; top: -5px; right: -5px; }

    #quick-nav-buttons {
        bottom: 210px;
        right: 15px;
    }
    .quick-nav-btn { width: 38px; height: 38px; font-size: 1.1rem; }

    .footer-copyright-container {
        flex-direction: column;
        gap: 0.75rem;
    }
}

/* Styles for Auth Modal Tabs */
#authModal .nav-tabs .nav-link {
    background-color: transparent;
    border-color: rgba(var(--primary-color-rgb), 0.2);
    color: var(--text-muted);
    border-bottom-width: 2px; /* Thicker bottom border for inactive */
}

#authModal .nav-tabs .nav-link:hover {
    border-color: rgba(var(--primary-color-rgb), 0.5);
    color: var(--text-light);
}

#authModal .nav-tabs .nav-link.active {
    background-color: var(--bg-card); /* Or var(--primary-color) if you prefer solid fill */
    color: var(--primary-color); /* Or #fff if background is var(--primary-color) */
    border-color: var(--primary-color) var(--primary-color) var(--bg-card); /* Match card bg for bottom border */
    border-bottom-color: var(--primary-color); /* Active tab bottom border highlight */
    font-weight: 600;
}

#authModal .tab-content {
    padding-top: 1rem; /* Add some space below tabs */
}

/* Make sure modal footer buttons in auth modal also fit the theme */
#authModal .modal-footer .btn-primary {
    background-color: var(--primary-color);
    border: none;
    color: #fff;
}
#authModal .modal-footer .btn-primary:hover {
    background-color: #2F67C0; /* Darker primary */
}
#authModal .modal-footer .btn-outline-secondary {
    border-color: var(--accent-color);
    color: var(--accent-color);
}
#authModal .modal-footer .btn-outline-secondary:hover {
    background-color: var(--accent-color);
    color: var(--text-light);
}
</style>

</head>
<body id="top">
    <input type="file" id="avatarUploadInput" accept="image/jpeg, image/png, image/gif" style="display: none;">

    <nav class="navbar navbar-expand-sm navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#top">
                <img src="img/Logo-DL-Cumanayagua.png" alt="Doña Lucía Logo" style="height: 30px; margin-right: 8px;">
                DL Cumanayagua
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavContent" aria-controls="navbarNavContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavContent">
                <ul class="navbar-nav ms-auto mb-2 mb-sm-0 align-items-sm-center">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTabAndScroll('menu-tab-link')"><i class="bi bi-card-list me-1"></i>Menú</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTabAndScroll('rewards-tab-link')"><i class="bi bi-gift me-1"></i>Recompensas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTabAndScroll('my-orders-tab-link')"><i class="bi bi-receipt me-1"></i>Mis Envíos</a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal"><i class="bi bi-question-circle me-1"></i>Ayuda</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="moreOptionsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical me-1"></i>Más
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="moreOptionsDropdown">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#presentationVideoModal"><i class="bi bi-play-btn-fill me-2"></i>Ver Video Intro</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#sharePageModal"><i class="bi bi-share-fill me-2"></i>Compartir Página/App</a></li>
                            <li><hr class="dropdown-divider border-secondary"></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#downloadAppModal"><i class="bi bi-phone-vibrate-fill me-2"></i>Descargar App (Cuba)</a></li>
                        </ul>
                    </li>
                     <li class="nav-item d-block d-sm-none my-2">
                        <hr class="border-secondary">
                    </li>
                    <li class="nav-item d-flex align-items-center" id="auth-buttons-nav-container">
                        <div id="auth-buttons-nav" class="d-flex align-items-center">
                        </div>
                         <button id="logoutButtonNav" class="btn btn-sm btn-outline-warning ms-2" style="display:none;" onclick="logoutClient()"><i class="bi bi-box-arrow-right"></i> Salir</button>
                    </li>
                     <li class="nav-item ms-sm-2" id="cartNavItem" style="display: none !important;">
                        <button class="btn cart-nav-button p-0" type="button" data-bs-toggle="modal" data-bs-target="#cartModal">
                            <i class="bi bi-cart-fill"></i>
                            <span class="badge rounded-pill cart-count-nav" id="cart-count-nav">0</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <div class="container mt-5 pt-4 pb-5">
            <div id="vip-card-container" class="vip-card p-md-4 p-3 mb-4 position-relative animate__animated animate__fadeInDown" style="display: none;">
                <!-- Contenedor para centrar el contenido principal de la tarjeta -->
                <div class="vip-card-content-centered">
                    <span class="position-absolute top-0 start-0 m-3 badge" id="vip-status-badge">VIP</span>
                    <!-- El avatar ya no se mostrará por el CSS display:none, pero lo dejamos por si se reactiva -->
                    <div class="position-relative d-inline-block">
                        <img id="user-avatar" src="https://via.placeholder.com/80/FFFFFF/2C3E50?Text=VIP" alt="User Avatar" class="rounded-circle mb-2 shadow-sm" width="80" height="80" style="cursor:pointer; display:none;" title="Haz clic para cambiar tu avatar">
                        <button id="changeAvatarButton" class="btn btn-sm position-absolute bottom-0 end-0 mb-2 me-0 rounded-circle p-1 lh-1" title="Cambiar avatar" style="display:none; transform: translate(25%, 25%);">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                    </div>
                    <h2 class="mb-1 mt-2" id="client-name">¡Hola!</h2>
                    <p class="mb-1 opacity-75" id="client-status">Miembro DL</p>
                    <div class="points-display mb-2" id="client-points">0</div>
                    <small id="client-phone-display" class="text-light opacity-75 d-block"></small> <!-- Añadido d-block para que ocupe su línea -->
                    <div id="client-referral-code-container" class="mt-2" style="display: none;">
                        <small class="text-light opacity-75 d-block">Tu Código de Referido:</small> <!-- Añadido d-block -->
                        <div class="d-flex align-items-center justify-content-center"> <!-- justify-content-center para el código y botón -->
                            <strong id="clientReferralCode" class="text-warning fs-5 me-2">Cargando...</strong>
                            <button class="btn btn-sm btn-outline-light py-0 px-2" onclick="copyReferralCode()" title="Copiar código">
                                <i class="bi bi-clipboard-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

             <div id="guest-prompt" class="alert alert-info text-center shadow-sm animate__animated animate__fadeInUp" style="display: block;">
                <h4><i class="bi bi-gift-fill me-2"></i>¡Envía alegría a Cuba con DL Cumanayagua!</h4>
                <p class="lead mb-2">Compra para tus familiares y amigos en Cumanayagua desde cualquier parte del mundo. Paga fácilmente con Zelle.</p>
                <p>Inicia sesión o regístrate para gestionar tus envíos y acumular puntos para futuras compras.</p>
            </div>

            <ul class="nav nav-pills mb-4">
                <li class="nav-item" role="presentation"><a class="nav-link active" id="menu-tab-link" data-bs-toggle="pill" href="#menu-tab" role="tab" aria-controls="menu-tab" aria-selected="true"><i class="bi bi-card-list me-1"></i>Menú y Combos</a></li>
                <li class="nav-item" role="presentation"><a class="nav-link" id="rewards-tab-link" data-bs-toggle="pill" href="#rewards-tab" role="tab" aria-controls="rewards-tab" aria-selected="false"><i class="bi bi-gift me-1"></i>Recompensas</a></li>
                <li class="nav-item" role="presentation"><a class="nav-link" id="my-orders-tab-link" data-bs-toggle="pill" href="#my-orders-tab" role="tab" aria-controls="my-orders-tab" aria-selected="false"><i class="bi bi-receipt me-1"></i>Mis Envíos</a></li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="menu-tab" role="tabpanel" aria-labelledby="menu-tab-link">
                    <div class="d-flex justify-content-center align-items-center mb-4">
                        <h3 class="mb-0 me-3 text-center"><i class="bi bi-cup-straw me-2"></i>Menú y Combos para Enviar</h3>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshMenuButton" onclick="forceLoadMenuItems()" title="Actualizar menú">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>

                    <div id="popular-items-section" class="mb-5">
                        <h4 class="mb-3 text-center"><i class="bi bi-star-fill text-warning me-2"></i>¡Lo Más Pedido Hoy!</h4>
                        <div class="row g-3 g-md-4" id="popular-items-container">
                            <div class="col-12 text-center p-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div><span class="ms-2">Cargando populares...</span></div>
                        </div>
                        <hr class="my-4 border-secondary">
                    </div>

                    <div class="mb-4 position-relative">
                        <input type="text" id="productSearchInput" class="form-control form-control-lg" placeholder="Buscar productos por nombre..." aria-label="Buscar productos">
                        <button id="clearSearchButton" class="btn btn-sm position-absolute end-0 top-50 translate-middle-y me-2" style="display:none;" title="Limpiar búsqueda">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
                        <div id="filter-container" class="d-flex flex-wrap justify-content-center align-items-center">
                        </div>
                        <div class="ms-auto">
                            <select id="sortProductsSelect" class="form-select form-select-sm bg-dark text-light border-secondary" style="min-width: 200px;">
                                <option value="default" selected>Ordenar por...</option>
                                <option value="name-asc">Nombre (A-Z)</option>
                                <option value="name-desc">Nombre (Z-A)</option>
                                <option value="price-asc">Precio (Menor a Mayor)</option>
                                <option value="price-desc">Precio (Mayor a Menor)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 g-md-4" id="menu-container"><div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div></div>
                </div>
                <div class="tab-pane fade" id="rewards-tab" role="tabpanel" aria-labelledby="rewards-tab-link">
                    <div class="d-flex justify-content-center align-items-center mb-4">
                        <h3 class="mb-0 me-3 text-center"><i class="bi bi-stars me-2"></i>Recompensas para tus Envíos</h3>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshRewardsButton" onclick="forceLoadRewards()" title="Actualizar recompensas">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="row g-3 g-md-4" id="rewards-container"><div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">Cargando...</p></div></div>
                </div>
                <div class="tab-pane fade" id="my-orders-tab" role="tabpanel" aria-labelledby="my-orders-tab-link">
                    <h3 class="mb-4 text-center"><i class="bi bi-clock-history me-2"></i>Historial de Envíos</h3>
                    <div id="orders-history-container"><div class="col-12 text-center p-5"><p class="fs-5">Inicia sesión para ver tus envíos.</p></div></div>
                </div>
            </div>
        </div>
    </main>

    <div id="loadingSpinnerUser" class="loading-spinner">
      <div class="luxury-spinner">
        <div class="luxury-spinner-inner"></div>
        <span class="luxury-spinner-text">Cargando...</span>
      </div>
    </div>
    <div id="downloadAppBanner" class="fixed-bottom p-3 bg-dark text-light shadow-lg" style="z-index: 1040; display:none;">
        <div class="container d-flex justify-content-between align-items-center flex-wrap">
            <div class="me-3 mb-2 mb-md-0">
                <strong class="d-block fs-5"><i class="bi bi-star-fill me-1 text-warning"></i> ¡Nuestra App para facilitar tu compra en Cuba!</strong>
                <span class="small">Permite que gestiones tus pedidos y beneficios fácilmente.</span>
            </div>
            <div class="d-flex align-items-center">
                <a href="https://drive.google.com/file/d/1JN1qbrX2JB7P5apVzzhtBy5x2hBPxCWa/view?usp=drive_link" download="DonaLucia_Cumanayagua.apk" class="btn btn-warning btn-sm me-2 py-2">
                    <i class="bi bi-android2 me-1"></i> Descargar App
                </a>
                <button class="btn btn-outline-warning btn-sm me-3 py-2" onclick="shareAppLinkViaCopy()" title="Copiar enlace de descarga de la App">
                    <i class="bi bi-share-fill me-1"></i> Compartir App
                </button>
                <button type="button" class="btn-close btn-close-white" aria-label="Cerrar banner"></button>
            </div>
        </div>
    </div>
    <div class="toast-container position-fixed bottom-0 start-0 p-3" id="toastPlacement" style="z-index: 2050"> </div>

    <!-- INICIO MODAL DE AUTENTICACIÓN UNIFICADO -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalLabel">Acceso / Registro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs nav-fill mb-3" id="authTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="login-tab-btn" data-bs-toggle="tab" data-bs-target="#login-tab-pane" type="button" role="tab" aria-controls="login-tab-pane" aria-selected="true">
                                <i class="bi bi-box-arrow-in-right me-1"></i>Iniciar Sesión
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="register-tab-btn" data-bs-toggle="tab" data-bs-target="#register-tab-pane" type="button" role="tab" aria-controls="register-tab-pane" aria-selected="false">
                                <i class="bi bi-person-plus-fill me-1"></i>Crear Cuenta
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="authTabContent">
                        <div class="tab-pane fade show active" id="login-tab-pane" role="tabpanel" aria-labelledby="login-tab-btn" tabindex="0">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="loginPhone" class="form-label">Teléfono (Tuyo)</label>
                                    <input type="tel" class="form-control" id="loginPhone" required autocomplete="username tel">
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="loginPassword" required autocomplete="current-password">
                                </div>
                                <div id="login-feedback" class="mt-3 mb-3"></div>
                                <button type="button" class="btn btn-primary w-100" onclick="handleLoginAttempt()">Acceder</button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="register-tab-pane" role="tabpanel" aria-labelledby="register-tab-btn" tabindex="0">
                            <form id="newUserRegistrationForm">
                                <div class="mb-3">
                                    <label for="newUserName" class="form-label">Nombre Completo (Tuyo) <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newUserName" required autocomplete="name">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserPhone" class="form-label">Teléfono (Tuyo, con código de país si es de USA) <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="newUserPhone" required placeholder="Ej: +1 XXX XXX XXXX" autocomplete="tel">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserEmail" class="form-label">Correo (Tuyo) <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="newUserEmail" required autocomplete="email">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserPassword" class="form-label">Contraseña <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="newUserPassword" required autocomplete="new-password">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserConfirmPassword" class="form-label">Confirmar Contraseña <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="newUserConfirmPassword" required autocomplete="new-password">
                                </div>
                                <div class="mb-3">
                                    <label for="newUserReferralCodeUsed" class="form-label">Código de Referido (Opcional)</label>
                                    <input type="text" class="form-control" id="newUserReferralCodeUsed" placeholder="Ingresa un código si tienes uno">
                                </div>
                                <div id="registration-feedback" class="mt-3 mb-3"></div>
                                <button type="button" class="btn btn-primary w-100" onclick="handleUserRegistrationAttempt()">Registrarme</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN MODAL DE AUTENTICACIÓN UNIFICADO -->

    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="cartModalLabel"><i class="bi bi-cart3 me-2"></i>Mi Carrito de Envío</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="cart-items-container"><p class="text-center">Tu carrito está vacío.</p></div><div class="modal-footer justify-content-between flex-wrap"><div id="cart-footer-info"><small class="text-muted d-block">Puntos a ganar: <span id="cart-points-to-earn" class="fw-bold">0</span></small><strong class="fs-5">Total: <span id="cart-total-price" style="color: var(--primary-color);">0.00</span> USD</strong><br><small class="text-warning"><i class="bi bi-credit-card-2-front-fill"></i> Pagos por Zelle.</small></div><div class="d-flex mt-2 mt-sm-0" id="cart-footer-buttons"><button type="button" class="btn btn-outline-danger me-2" onclick="clearCart()"><i class="bi bi-trash3 me-1"></i>Vaciar</button><button type="button" class="btn btn-success" onclick="confirmAndPlaceOrder()"><i class="bi bi-check-circle me-1"></i>Confirmar Envío</button></div></div><div id="order-placement-feedback" class="m-3"></div></div></div></div>
    <div class="modal fade" id="downloadAppModal" tabindex="-1" aria-labelledby="downloadAppModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="downloadAppModalLabel"><i class="bi bi-phone-vibrate-fill me-2" style="color:var(--primary-color);"></i> ¡App para tu Familia en Cuba!</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body text-center"><img src="https://i.postimg.cc/XJxYzHZW/striking-app-icon-the-letters-dl-in-a-custom-l.png" alt="Doña Lucía App Icon" class="img-fluid rounded-circle mb-3 shadow" style="width: 100px; height: 100px; border: 3px solid var(--primary-color);">
            <p class="lead mb-2">Instala la App para que tu familia en Cuba pueda ver el menú, canjear puntos, obtener recompensas y estar al tanto de las novedades. ¡Una forma fácil de conectar!</p>
            <p><strong>Nota:</strong> Esta app es para que tus familiares en Cuba exploren. Las compras y pagos se realizan desde esta página web.</p>
            <a href="https://drive.google.com/file/d/1JN1qbrX2JB7P5apVzzhtBy5x2hBPxCWa/view?usp=drive_link" download="DonaLucia_Cumanayagua.apk" class="btn btn-primary btn-lg mt-3 w-100 animate__animated animate__pulse animate__infinite animate__slower">
                <i class="bi bi-android2 me-2"></i> Descargar para Android
            </a>
                <p class="mt-3 mb-1">
                    <small class="text-muted">Si su dispositivo lo solicita, deben habilitar "Instalar apps desconocidas" en Ajustes para poder instalarla.</small></p></div>
                    <div class="modal-footer justify-content-center border-0 pt-0"><div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="dontShowDownloadModalAgain">
                        <label class="form-check-label small" for="dontShowDownloadModalAgain">No volver a mostrar este mensaje (al inicio)</label></div></div></div></div>
    </div>
    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title" id="productDetailModalLabel">Detalles del Producto</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body pt-0"><div class="row g-4"><div class="col-md-6"><img src="https://via.placeholder.com/500x600" id="modal-product-image" class="img-fluid" alt="Imagen del producto"></div><div class="col-md-6 d-flex flex-column"><h2 id="modal-product-name" class="mb-2">Nombre del Producto</h2><p id="modal-product-description" class="text-muted flex-grow-1">Descripción detallada del producto...</p><div class="d-flex justify-content-between align-items-center mb-3"><span id="modal-product-price">USD 0.00</span><span class="badge bg-success" id="modal-product-points">+0 Puntos</span></div><div id="modal-add-to-cart-button-container" class="mb-4"></div><div id="modal-recommendations-container"></div></div></div></div></div></div>
    </div>

    <div class="modal fade" id="rewardDetailModal" tabindex="-1" aria-labelledby="rewardDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="rewardDetailModalLabel">Detalles de la Recompensa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-0">
                    <div class="row g-4">
                        <div class="col-md-5">
                            <img src="https://via.placeholder.com/500x600" id="modal-reward-image" class="img-fluid" alt="Imagen de la recompensa" style="aspect-ratio: 4 / 5; object-fit: cover; border-radius: 1rem; border: 2px solid var(--accent-color);">
                        </div>
                        <div class="col-md-7 d-flex flex-column">
                            <h2 id="modal-reward-name" class="mb-2" style="font-family: 'Playfair Display', serif; color: var(--accent-color);">Nombre de la Recompensa</h2>
                            <p id="modal-reward-description" class="text-muted">Descripción detallada de la recompensa...</p>
                            <div class="d-flex justify-content-between align-items-center my-3">
                                <span id="modal-reward-points-required" style="color: var(--accent-color); font-size: 1.75rem; font-weight: 700;">0 Puntos</span>
                                <span class="badge" id="modal-reward-stock-info"></span>
                            </div>
                            <div id="modal-redeem-reward-button-container" class="mb-3">
                                <!-- Botón de canje se insertará aquí -->
                            </div>
                            <hr class="border-secondary my-3">
                            <div id="modal-product-recommendations-for-reward-container">
                                <h5 class="text-light mb-3" style="font-weight: 600;"><i class="bi bi-hand-thumbs-up-fill me-2"></i>Productos que te podrían gustar:</h5>
                                <div id="reward-modal-product-recs-row" class="row g-2">
                                    <!-- Recomendaciones de productos -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sharePageModal" tabindex="-1" aria-labelledby="sharePageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sharePageModalLabel"><i class="bi bi-share-fill me-2" style="color:var(--primary-color);"></i>Compartir</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <h6 class="text-light">Compartir esta Página Web:</h6>
                    <p class="mb-1 small text-muted">Para que otros puedan realizar compras y envíos.</p>
                    <div id="qrcodeCanvas" class="mx-auto mb-3 border border-secondary p-2 rounded" style="width: 150px; height: 150px; background-color: white;">
                    </div>
                    <div class="d-grid gap-2 mb-4">
                        <button class="btn btn-primary btn-sm" id="copyLinkButton">
                            <i class="bi bi-clipboard-check-fill me-2"></i>Copiar Enlace de Página
                        </button>
                        <a id="shareViaWhatsAppButton" class="btn btn-success btn-sm" href="#" target="_blank">
                            <i class="bi bi-whatsapp me-2"></i>Página por WhatsApp
                        </a>
                        <a id="shareViaTelegramButton" class="btn btn-info btn-sm text-dark" href="#" target="_blank">
                            <i class="bi bi-telegram me-2"></i>Página por Telegram
                        </a>
                    </div>

                    <hr style="border-color: rgba(255,255,255,0.2);">

                    <h6 class="text-light mt-3">Compartir la App (para familia en Cuba):</h6>
                    <p class="mb-1 small text-muted">Para que tus familiares en Cuba vean el catálogo.</p>
                     <div id="qrcodeAppCanvas" class="mx-auto mb-3 border border-secondary p-2 rounded" style="width: 150px; height: 150px; background-color: white;">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" onclick="shareAppLinkViaCopy()">
                            <i class="bi bi-clipboard-check-fill me-2"></i>Copiar Enlace de App
                        </button>
                        <a id="shareAppViaWhatsAppButtonModal" class="btn btn-success btn-sm" href="#" target="_blank">
                            <i class="bi bi-whatsapp me-2"></i>App por WhatsApp
                        </a>
                         <a id="shareAppViaTelegramButtonModal" class="btn btn-info btn-sm text-dark" href="#" target="_blank">
                            <i class="bi bi-telegram me-2"></i>App por Telegram
                        </a>
                    </div>
                    <small class="d-block mt-3 text-muted">Muestra los códigos QR para escanear directamente.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmClearCartModal" tabindex="-1" aria-labelledby="confirmClearCartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmClearCartModalLabel"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirmar Acción</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres vaciar completamente tu carrito de envío? Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmClearCartButton">
                        <i class="bi bi-trash3-fill me-1"></i>Sí, Vaciar Carrito
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmRedeemRewardModal" tabindex="-1" aria-labelledby="confirmRedeemRewardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmRedeemRewardModalLabel"><i class="bi bi-patch-check-fill text-warning me-2"></i>Confirmar Canje de Recompensa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmRedeemRewardText">¿Estás seguro de que quieres canjear esta recompensa?</p>
                    <div id="redeemRewardFeedback" class="mt-3"></div>
                </div>
                <div class="modal-footer" id="confirmRedeemRewardFooter">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="confirmRedeemRewardButton">
                        <i class="bi bi-award-fill me-1"></i>Sí, Canjear Ahora
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="presentationVideoModal" tabindex="-1" aria-labelledby="presentationVideoModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-xl" id="presentationVideoDialog">
            <div class="modal-content" id="presentationVideoContent" style="background-color: transparent; border: none; box-shadow: none;">
                <div class="modal-header border-0 position-absolute top-0 end-0" style="z-index: 10;">
                     <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="closePresentationVideoModal" style="background-color: rgba(0,0,0,0.5); border-radius:50%; padding:0.5em;"></button>
                </div>
                <div class="modal-body p-0" id="presentationVideoBody">
                    <video id="introVideo" width="100%" height="auto" controls autoplay muted playsinline preload="auto">
                        <source src="./Dl%20Cumanayagua%20Logo%20reveal.mp4" type="video/mp4">
                        Tu navegador no soporta la etiqueta de video.
                    </video>
                </div>
                <div class="modal-footer border-0 justify-content-center pt-2 pb-3 position-absolute bottom-0 start-50 translate-middle-x w-100" style="z-index: 10; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); pointer-events: none;">
                    <div class="form-check" style="pointer-events: auto;">
                        <input class="form-check-input" type="checkbox" value="" id="dontShowVideoAgainCheckbox" style="border-color:rgba(255,255,255,0.5);">
                        <label class="form-check-label small text-light" for="dontShowVideoAgainCheckbox">
                            No volver a mostrar este video
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel"><i class="bi bi-question-circle-fill me-2" style="color:var(--primary-color);"></i>Ayuda y Cómo Funciona DL Cumanayagua</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="lead">¡Bienvenido a DL Cumanayagua! Aquí te explicamos cómo funciona nuestra plataforma para que puedas enviar productos y cariño a tus seres queridos en Cumanayagua, Cuba, de forma fácil y segura.</p>

                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOneHelp">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOneHelp" aria-expanded="true" aria-controls="collapseOneHelp">
                                    <i class="bi bi-person-circle me-2"></i>Tu Cuenta (Cliente Comprador)
                                </button>
                            </h2>
                            <div id="collapseOneHelp" class="accordion-collapse collapse show" aria-labelledby="headingOneHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>Esta página web es para ti, el cliente que realiza la compra desde fuera de Cuba (ej. USA) para enviar a Cumanayagua.</p>
                                    <ul>
                                        <li><strong>Registro e Inicio de Sesión:</strong> Crea una cuenta o inicia sesión con tu número de teléfono, correo y contraseña. Esto te permitirá guardar tu historial de envíos, acumular puntos y acceder a recompensas.</li>
                                        <li><strong>Información Personal:</strong> Tu nombre, teléfono y correo son para gestionar tus pedidos y comunicarnos contigo.</li>

                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwoHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwoHelp" aria-expanded="false" aria-controls="collapseTwoHelp">
                                   <i class="bi bi-card-list me-2"></i> Menú y Combos (Realizar un Envío)
                                </button>
                            </h2>
                            <div id="collapseTwoHelp" class="accordion-collapse collapse" aria-labelledby="headingTwoHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>Explora nuestro catálogo de productos y combos disponibles para enviar.</p>
                                    <ul>
                                        <li><strong>Añadir al Carrito:</strong> Selecciona los productos que deseas enviar y añádelos a tu carrito de envío.</li>
                                        <li><strong>Ver Detalles:</strong> Haz clic en la imagen de un producto para ver más detalles, descripción y recomendaciones.</li>
                                        <li><strong>Carrito de Envío:</strong> Revisa tu selección, ajusta cantidades y ve el total en USD.</li>
                                        <li><strong>Confirmar Envío:</strong> Una vez listo, confirma tu envío. Se generará un número de pedido.</li>
                                        <li><strong>Pago con Zelle:</strong> Tras confirmar, te proporcionaremos instrucciones para realizar el pago mediante Zelle. Deberás notificarnos por WhatsApp una vez realizado el pedido para coordinar el pago.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThreeHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThreeHelp" aria-expanded="false" aria-controls="collapseThreeHelp">
                                    <i class="bi bi-star-fill me-2"></i>Puntos y Recompensas
                                </button>
                            </h2>
                            <div id="collapseThreeHelp" class="accordion-collapse collapse" aria-labelledby="headingThreeHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>¡Premiamos tu fidelidad!</p>
                                    <ul>
                                        <li><strong>Acumular Puntos:</strong> Con cada compra que realices (y una vez confirmado el pago), acumularás puntos en tu cuenta. La cantidad de puntos por producto se indica en el menú.</li>
                                        <li><strong>Ver tus Puntos:</strong> El total de tus puntos disponibles se muestra en tu tarjeta VIP al iniciar sesión.</li>
                                        <li><strong>Sección Recompensas:</strong> Aquí encontrarás productos o beneficios especiales que puedes canjear utilizando tus puntos acumulados.</li>
                                        <li><strong>Canjear Recompensas:</strong> Si tienes suficientes puntos, podrás canjear una recompensa. Esta se aplicará a un futuro envío o según se especifique. Deberás notificarnos por WhatsApp al canjear para coordinar.</li>
                                        <li><strong>Puntos de Bienvenida:</strong> Actualmente, no se otorgan puntos de bienvenida al registrarse. Los puntos se ganan a través de las compras. (Excepción: Ver Programa de Referidos).</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFourHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFourHelp" aria-expanded="false" aria-controls="collapseFourHelp">
                                    <i class="bi bi-receipt-cutoff me-2"></i>Mis Envíos
                                </button>
                            </h2>
                            <div id="collapseFourHelp" class="accordion-collapse collapse" aria-labelledby="headingFourHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>En esta sección podrás ver un historial de todos los envíos que has realizado, su estado (Pendiente, Procesado, Entregado, Cancelado), los productos incluidos y los puntos otorgados.</p>
                                </div>
                            </div>
                        </div>
                         <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFiveHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiveHelp" aria-expanded="false" aria-controls="collapseFiveHelp">
                                    <i class="bi bi-phone-fill me-2"></i>App DL Cumanayagua (Para tu familia en Cuba)
                                </button>
                            </h2>
                            <div id="collapseFiveHelp" class="accordion-collapse collapse" aria-labelledby="headingFiveHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>Ofrecemos una aplicación Android (.apk) que puedes descargar y compartir con tus familiares en Cumanayagua.</p>
                                    <ul>
                                        <li><strong>Propósito de la App:</strong> Esta app permite a tus seres queridos en Cuba ver el catálogo de productos y las recompensas disponibles. Así, pueden decirte qué les gustaría recibir.</li>
                                        <li><strong>¿Cómo Compartirla?:</strong> Puedes usar los botones de "Compartir Página/App" en el menú superior o el botón flotante <i class="bi bi-share-fill"></i> para obtener enlaces de descarga y QR.</li>
                                        <li><strong>Instalación:</strong> Deberán descargar el archivo .apk e instalarlo en su teléfono Android. Es posible que necesiten habilitar "Instalar apps desconocidas" en los ajustes de su teléfono.</li>
                                        <li><strong>Importante:</strong> La app es solo para visualización. Las compras, pagos y gestión de tu cuenta de cliente (acumulación de puntos, etc.) se realizan siempre a través de esta página web por ti, el comprador.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSixHelp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSixHelp" aria-expanded="false" aria-controls="collapseSixHelp">
                                    <i class="bi bi-person-hearts me-2"></i>Programa de Referidos
                                </button>
                            </h2>
                            <div id="collapseSixHelp" class="accordion-collapse collapse" aria-labelledby="headingSixHelp" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>¡Invita a tus amigos y ambos ganan!</p>
                                    <ul>
                                        <li><strong>Tu Código de Referido:</strong> Cuando inicias sesión, verás tu código de referido personal en tu tarjeta VIP. Compártelo con amigos que quieran hacer envíos a Cumanayagua.</li>
                                        <li><strong>Para tus Amigos (Nuevos Clientes):</strong> Al registrarse, tu amigo puede ingresar tu código de referido en el campo "Código de Referido". Si el código es válido, tu amigo recibirá <strong>15 puntos extra</strong> de bienvenida.</li>
                                        <li><strong>Para Ti (Quien Refiere):</strong> Cuando tu amigo se registra exitosamente usando tu código, tú recibirás <strong>25 puntos</strong> como agradecimiento.</li>
                                        <li>Los puntos se añaden automáticamente a sus respectivas cuentas.</li>
                                    </ul>
                                    <p class="small text-muted">Nota: Los puntos y condiciones del programa de referidos pueden cambiar.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="mt-4">Si tienes más preguntas, no dudes en contactarnos a través del botón de WhatsApp flotante. ¡Estamos para ayudarte!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>


    <div class="floating-buttons-container">
        <a id="whatsappButton" href="https://wa.me/5355189657?text=Hola,%20tengo%20una%20consulta%20sobre%20DL%20Cumanayagua." class="floating-button" target="_blank" title="Chatea con nosotros">
            <i class="bi bi-whatsapp"></i>
        </a>
        <button id="floatingCartButton" class="floating-button" type="button" data-bs-toggle="modal" data-bs-target="#cartModal" style="display: none;" title="Ver Carrito de Envío">
            <i class="bi bi-cart3"></i>
            <span class="floating-cart-count" id="floating-cart-count">0</span>
        </button>
        <button id="floatingShareButton" class="floating-button" type="button" data-bs-toggle="modal" data-bs-target="#sharePageModal" title="Compartir esta página" style="background: linear-gradient(145deg, #5D3FD3, #8A2BE2);">
            <i class="bi bi-share-fill"></i>
        </button>
    </div>

    <div id="quick-nav-buttons">
        <a href="#top" class="quick-nav-btn" title="Ir arriba"><i class="bi bi-arrow-up"></i></a>
        <a href="#bottom" id="go-down-btn" class="quick-nav-btn" title="Ir abajo"><i class="bi bi-arrow-down"></i></a>
    </div>

    <footer id="bottom" class="footer-custom pt-5 pb-4">
        <div class="container text-center text-md-start">
            <div class="row gy-4">
                <div class="col-lg-4 col-md-12 mb-4 mb-md-0">
                    <div class="d-flex align-items-center justify-content-center justify-content-md-start mb-3">
                         <img src="https://i.postimg.cc/rsFSGFt2/Generated-Image-June-11-2025-1-22-AM.jpg" alt="Erick Olivera" class="footer-avatar me-3">
                         <div>
                            <h5 class="text-uppercase fw-bold mb-1" style="color: var(--primary-color);">DL Cumanayagua</h5>
                            <p class="footer-name mb-0">Erick Olivera</p>
                         </div>
                    </div>
                    <p class="small text-muted">
                        Tu conexión directa para enviar productos y cariño a tus seres queridos en Cumanayagua. Fácil, rápido y seguro.
                    </p>
                </div>
                <div class="col-lg-2 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Navegación</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" onclick="showTabAndScroll('menu-tab-link'); return false;" class="footer-link">Menú</a></li>
                        <li><a href="#" onclick="showTabAndScroll('rewards-tab-link'); return false;" class="footer-link">Recompensas</a></li>
                        <li><a href="#" onclick="showTabAndScroll('my-orders-tab-link'); return false;" class="footer-link">Mis Envíos</a></li>
                        <li><a href="#" data-bs-toggle="modal" data-bs-target="#downloadAppModal" class="footer-link">App para Cuba</a></li>
                         <li><a href="#" data-bs-toggle="modal" data-bs-target="#helpModal" class="footer-link">Ayuda</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Contacto</h5>
                     <p><i class="bi bi-telephone-fill me-2"></i>+53 55189657</p>
                     <p><i class="bi bi-geo-alt-fill me-2"></i>Cumanayagua, Cuba</p>
                </div>
                <div class="col-lg-3 col-md-4">
                    <h5 class="text-uppercase fw-bold mb-4">Síguenos</h5>
                    <div class="social-icons">
                        <a href="https://wa.me/5355189657?text=Hola,%20tengo%20una%20consulta%20sobre%20DL%20Cumanayagua." class="social-icon-link me-3 fs-4" title="WhatsApp"><i class="bi bi-whatsapp"></i></a>
                        <a href="#!" class="social-icon-link me-3 fs-4" title="Facebook"><i class="bi bi-facebook"></i></a>
                        <a href="#!" class="social-icon-link fs-4" title="Instagram"><i class="bi bi-instagram"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4" style="border-color: rgba(255,255,255,0.1);">
            <div class="footer-copyright-container d-flex justify-content-center align-items-center">
                <span class="small text-muted">© 2024 DL Cumanayagua. Todos los derechos reservados.</span>
                <button class="footer-refresh-btn ms-3" onclick="forceFullCacheRefresh()" title="Actualizar datos de la página">
                    <i class="bi bi-cloud-arrow-down-fill fs-5"></i>
                </button>
            </div>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        const GOOGLE_SCRIPT_URL_USER = 'https://script.google.com/macros/s/AKfycby3oshMqxSgpF8Sl8cPRslGv7l4P4VQZtCRgbT6VTlHN9KrC0OH5hJPySeJo81bfggg9A/exec';
        const LOGGED_IN_CLIENT_KEY = 'cafeteriaVipClientLoggedIn_v8';
        const PRODUCTS_USER_CACHE_KEY = 'cafeteriaUserProductsCache_v8';
        const USER_CART_KEY = 'cafeteriaUserCart_v5';
        const REWARDS_USER_CACHE_KEY = 'cafeteriaUserRewardsCache_v3';
        const REWARDS_CACHE_EXPIRY_KEY = 'cafeteriaRewardsCacheExpiry_v1';
        const MENU_CACHE_EXPIRY_KEY = 'cafeteriaMenuCacheExpiry_v1';
        const CACHE_DURATION_MS = 60 * 60 * 1000; // 1 hour
        const MAX_AVATAR_DIMENSION = 200;
        const AVATAR_JPEG_QUALITY = 0.75;
        const LOCAL_AVATAR_DATA_KEY = 'localAvatarDataUrl_v1';
        const DOWNLOAD_MODAL_DISMISSED_KEY = 'downloadModalDismissed_DL_v2';
        const DOWNLOAD_BANNER_DISMISSED_KEY = 'downloadBannerDismissed_DL_v1';
        const PRESENTATION_VIDEO_SHOWN_KEY = 'presentationVideoShown_v1';
        const APP_DOWNLOAD_LINK = "https://drive.google.com/file/d/1JN1qbrX2JB7P5apVzzhtBy5x2hBPxCWa/view?usp=drive_link";
        const REFERRAL_POINTS_FOR_REFERRER = 25; // Puntos para quien refiere
        const REFERRAL_POINTS_FOR_REFEREE = 15; // Puntos extra para el nuevo referido


        let clientData = null;
        let menuItems = [];
        let availableRewards = [];
        let shoppingCart = [];
        let currentFilterCategory = 'all';
        let currentSortOption = 'default';
        const loadingSpinnerUser = document.getElementById('loadingSpinnerUser');
        let authModalInstance, 
            cartModalInstance, downloadAppModalInstance, productDetailModalInstance,
            sharePageModalInstance, confirmClearCartModalInstance,
            confirmRedeemRewardModalInstance, presentationVideoModalInstance,
            helpModalInstance, rewardDetailModalInstance;
        let floatingCartButtonEl;
        let floatingCartCountEl;
        let qrcodePageInstance = null;
        let qrcodeAppInstance = null;


        document.addEventListener('DOMContentLoaded', async function() {
            floatingCartButtonEl = document.getElementById('floatingCartButton');
            floatingCartCountEl = document.getElementById('floating-cart-count');
            initializeModals();
            loadCartFromStorage();
            loadClientDataFromStorage();
            updateClientDisplayAndUI();
            await loadMenuItems();
            setupEventListeners();
            handleAppDownloadPromotion();
            handleScroll();
            initializeShareModal();
            setupShareEventListeners();
            setupFloatingButtonFeedback();
            handlePresentationVideo();
            setupNavbarToggler();

            const confirmClearCartBtn = document.getElementById('confirmClearCartButton');
            if (confirmClearCartBtn) {
                confirmClearCartBtn.addEventListener('click', performClearCartActions);
            }

            const productSearchInput = document.getElementById('productSearchInput');
            const clearSearchButton = document.getElementById('clearSearchButton');
            const sortProductsSelect = document.getElementById('sortProductsSelect');

            if (productSearchInput) {
                productSearchInput.addEventListener('input', function() {
                    generateMenu();
                    if (this.value.length > 0 && clearSearchButton) {
                        clearSearchButton.style.display = 'block';
                    } else if (clearSearchButton) {
                        clearSearchButton.style.display = 'none';
                    }
                });
            }
            if (clearSearchButton) {
                clearSearchButton.addEventListener('click', function() {
                    if(productSearchInput) productSearchInput.value = '';
                    clearSearchButton.style.display = 'none';
                    generateMenu();
                });
            }
            if (sortProductsSelect) {
                sortProductsSelect.addEventListener('change', function() {
                    currentSortOption = this.value;
                    generateMenu();
                });
            }

            const helpAccordionItems = document.querySelectorAll('#helpAccordion .accordion-collapse');
            let hasDynamicHelpItems = false;
            helpAccordionItems.forEach((item, index) => {
                const button = item.previousElementSibling.querySelector('button');
                if (button && button.getAttribute('data-bs-target').startsWith('#collapseHelp')) { 
                    hasDynamicHelpItems = true;
                    const newId = `collapseHelp${index}`; 
                    item.id = newId;
                    button.setAttribute('data-bs-target', `#${newId}`);
                    button.setAttribute('aria-controls', newId);
                }
            });
        });

        function setupNavbarToggler() {
            const navLinks = document.querySelectorAll('#navbarNavContent .nav-link, #navbarNavContent .dropdown-item');
            const navbarToggler = document.querySelector('.navbar-toggler');
            const navbarCollapseEl = document.getElementById('navbarNavContent');
            let navbarCollapseInstance = null;

            if (navbarCollapseEl) {
                navbarCollapseInstance = bootstrap.Collapse.getOrCreateInstance(navbarCollapseEl, {toggle: false});
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    const isTogglerVisible = getComputedStyle(navbarToggler).display !== 'none';
                    const isMenuExpanded = navbarCollapseEl.classList.contains('show');

                    if (isMenuExpanded && isTogglerVisible) {
                        const opensModal = link.getAttribute('data-bs-toggle') === 'modal';
                        const isDropdownToggle = link.classList.contains('dropdown-toggle');

                        if (!opensModal && !isDropdownToggle) {
                            if (navbarCollapseInstance) {
                                navbarCollapseInstance.hide();
                            }
                        }
                    }
                });
            });
        }

        function showTabAndScroll(tabLinkId) {
            const tabLink = document.getElementById(tabLinkId);
            if (tabLink) {
                const tabInstance = bootstrap.Tab.getOrCreateInstance(tabLink);
                tabInstance.show();

                const tabPaneId = tabLink.getAttribute('href');
                if (tabPaneId) {
                    const tabPane = document.querySelector(tabPaneId);
                    if (tabPane) {
                        setTimeout(() => {
                            tabPane.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 150);
                    }
                }
            }
        }


        function handleScroll() {
            const quickNav = document.getElementById('quick-nav-buttons');
            const goDownBtn = document.getElementById('go-down-btn');
            if (!quickNav || !goDownBtn) return;

            const floatingButtonsContainer = document.querySelector('.floating-buttons-container');
            let fabContainerBottom = 25;
             if (floatingButtonsContainer) {
                const style = window.getComputedStyle(floatingButtonsContainer);
                fabContainerBottom = parseFloat(style.bottom) || fabContainerBottom;
            }

            if (window.scrollY > 300) {
                quickNav.style.display = 'flex';
            } else {
                quickNav.style.display = 'none';
            }

            let pageBottomOffset = 100;
            const footer = document.getElementById('bottom');
            if (footer) pageBottomOffset += footer.offsetHeight;

            const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - pageBottomOffset);
            goDownBtn.style.display = nearBottom ? 'none' : 'flex';
        }


        async function forceFullCacheRefresh() {
            if (confirm("Esto borrará TODOS los datos de navegación (incluyendo sesión iniciada, carrito, etc.) y recargará la página desde cero para obtener la versión más reciente. ¿Deseas continuar?")) {
                showGlobalFeedback("Limpiando datos y actualizando...", "info", null);
                try {
                    console.log("Limpiando localStorage...");
                    localStorage.clear();
                    console.log("localStorage limpiado.");

                    console.log("Limpiando sessionStorage...");
                    sessionStorage.clear();
                    console.log("sessionStorage limpiado.");

                    if ('serviceWorker' in navigator && navigator.serviceWorker.getRegistrations) {
                        console.log("Intentando desregistrar Service Workers...");
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (let registration of registrations) {
                            await registration.unregister();
                            console.log('Service Worker desregistrado:', registration.scope);
                        }
                        console.log("Service Workers desregistrados (si los había).");
                    }

                    if (window.caches && window.caches.keys) {
                        console.log("Intentando limpiar caché de la API de Cache...");
                        const keys = await window.caches.keys();
                        await Promise.all(keys.map(key => window.caches.delete(key)));
                        console.log("Cachés de la API eliminados.");
                    }
                } catch (error) {
                    console.error("Error durante la limpieza de caché:", error);
                    showGlobalFeedback("Error al limpiar algunos datos de caché.", "warning");
                }

                try {
                    const baseUrl = window.location.origin + window.location.pathname;
                    const timestamp = new Date().getTime();
                    const newUrl = `${baseUrl}?t=${timestamp}`;
                    console.log(`Intentando recargar con URL para evitar caché: ${newUrl}`);
                    window.location.href = newUrl;

                    setTimeout(() => {
                        console.log("Fallback: intentando location.reload(true) después de la navegación por URL.");
                        window.location.reload(true);
                    }, 1500);
                } catch (e) {
                    console.error("Error al intentar recargar la página con URL:", e);
                    console.log("Fallback final: intentando location.reload(true) directamente.");
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 1500);
                }
            }
        }

        function initializeModals() {
            try {
                const authModalEl = document.getElementById('authModal');
                if (authModalEl) authModalInstance = new bootstrap.Modal(authModalEl);
                else console.warn("Modal con ID 'authModal' no encontrado.");

                ['cartModal', 'downloadAppModal', 'productDetailModal', 'sharePageModal', 'confirmClearCartModal', 'confirmRedeemRewardModal', 'presentationVideoModal', 'helpModal', 'rewardDetailModal'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id === 'cartModal') cartModalInstance = new bootstrap.Modal(el);
                        else if (id === 'downloadAppModal') downloadAppModalInstance = new bootstrap.Modal(el);
                        else if (id === 'productDetailModal') productDetailModalInstance = new bootstrap.Modal(el);
                        else if (id === 'sharePageModal') sharePageModalInstance = new bootstrap.Modal(el);
                        else if (id === 'confirmClearCartModal') confirmClearCartModalInstance = new bootstrap.Modal(el);
                        else if (id === 'confirmRedeemRewardModal') confirmRedeemRewardModalInstance = new bootstrap.Modal(el);
                        else if (id === 'presentationVideoModal') presentationVideoModalInstance = new bootstrap.Modal(el);
                        else if (id === 'helpModal') helpModalInstance = new bootstrap.Modal(el);
                        else if (id === 'rewardDetailModal') rewardDetailModalInstance = new bootstrap.Modal(el);
                    } else { console.warn(`Modal con ID '${id}' no encontrado.`); }
                });
            } catch (error) { console.error("Error inicializando modales:", error); }
        }

        function setupEventListeners() {
            const authModalEl = document.getElementById('authModal');
            if (authModalEl) {
                authModalEl.addEventListener('hidden.bs.modal', () => {
                    clearFormAndFeedback('newUserRegistrationForm', 'registration-feedback');
                    clearFormAndFeedback('loginForm', 'login-feedback');
                });
            }
            
            document.getElementById('cartModal')?.addEventListener('show.bs.modal', renderCartItems);
            document.getElementById('cartModal')?.addEventListener('hidden.bs.modal', () => {
                document.getElementById('order-placement-feedback').innerHTML = '';
                document.getElementById('cart-footer-info').style.display = 'block';
                document.getElementById('cart-footer-buttons').style.display = 'flex';
            });
            const avatarUploadInputEl = document.getElementById('avatarUploadInput');
            const userAvatarImgEl = document.getElementById('user-avatar');
            const changeAvatarBtnEl = document.getElementById('changeAvatarButton');
            const triggerAvatarUpload = () => {
                if (clientData && clientData.id && avatarUploadInputEl) {
                    avatarUploadInputEl.click();
                } else if (!clientData || !clientData.id) {
                    showGlobalFeedback("Inicia sesión para cambiar tu avatar.", "warning");
                    openAuthModal('login');
                }
            };
            if (userAvatarImgEl) userAvatarImgEl.addEventListener('click', triggerAvatarUpload);
            if (changeAvatarBtnEl) changeAvatarBtnEl.addEventListener('click', triggerAvatarUpload);
            if (avatarUploadInputEl) avatarUploadInputEl.addEventListener('change', handleAvatarFileSelect);
            const rewardsTabEl = document.getElementById('rewards-tab-link');
            if (rewardsTabEl) {
                rewardsTabEl.addEventListener('shown.bs.tab', event => {
                    if (!clientData || !clientData.id) {
                         generateRewardsList();
                        return;
                    }
                    loadAvailableRewards();
                });
            }
            const ordersTabEl = document.getElementById('my-orders-tab-link');
            if (ordersTabEl) {
                ordersTabEl.addEventListener('shown.bs.tab', event => {
                    loadUserOrders();
                });
            }
            window.addEventListener('resize', adjustBodyPaddingAndFabPosition);
            window.addEventListener('scroll', handleScroll);
        }
        
        function openAuthModal(tabToActivate = 'login') {
            if (authModalInstance) {
                authModalInstance.show();
                const tabButtonId = (tabToActivate === 'register') ? 'register-tab-btn' : 'login-tab-btn';
                const tabButton = document.getElementById(tabButtonId);
                if (tabButton) {
                    const tab = bootstrap.Tab.getOrCreateInstance(tabButton);
                    tab.show();
                }
            } else {
                console.error("Auth modal instance not found");
            }
        }

        function adjustBodyPaddingAndFabPosition() {
            const bodyEl = document.body;
            const bannerEl = document.getElementById('downloadAppBanner');
            const floatingButtonsContainer = document.querySelector('.floating-buttons-container');
            const quickNavButtons = document.getElementById('quick-nav-buttons');
            const navbarEl = document.querySelector('.navbar-custom.fixed-top');

            let totalPaddingBottom = 0;
            let fabContainerBottomOffset = 25;
            let quickNavBottomOffset = 260;

            if (window.matchMedia("(max-width: 768px)").matches) {
                fabContainerBottomOffset = 20;
                quickNavBottomOffset = 235;
            }
            if (window.matchMedia("(max-width: 576px)").matches) {
                fabContainerBottomOffset = 15;
                quickNavBottomOffset = 210;
            }

            if (bannerEl && bannerEl.style.display !== 'none' && !bannerEl.classList.contains('animate__fadeOutDown')) {
                const bannerHeight = bannerEl.offsetHeight;
                totalPaddingBottom = bannerHeight + 10;
                fabContainerBottomOffset += bannerHeight;
                quickNavBottomOffset += bannerHeight;
            }

            bodyEl.style.paddingBottom = totalPaddingBottom + 'px';

            if (navbarEl) {
                const navbarHeight = navbarEl.offsetHeight;
                if (parseFloat(bodyEl.style.paddingTop) !== navbarHeight) {
                    bodyEl.style.paddingTop = navbarHeight + 'px';
                }
            }

            if (floatingButtonsContainer) {
                 floatingButtonsContainer.style.bottom = fabContainerBottomOffset + 'px';
            }
            if (quickNavButtons && quickNavButtons.style.display !== 'none') {
                quickNavButtons.style.bottom = quickNavBottomOffset + 'px';
            }
             handleScroll();
        }


        function handleAppDownloadPromotion() {
            const dontShowCheckbox = document.getElementById('dontShowDownloadModalAgain');
            const downloadModalEl = document.getElementById('downloadAppModal');
            const bannerEl = document.getElementById('downloadAppBanner');
            const videoAlreadyShown = localStorage.getItem(PRESENTATION_VIDEO_SHOWN_KEY);

            if ((videoAlreadyShown === 'true' || !videoAlreadyShown ) && !localStorage.getItem(DOWNLOAD_MODAL_DISMISSED_KEY) && downloadAppModalInstance) {
                 setTimeout(() => {
                    if (!localStorage.getItem(DOWNLOAD_MODAL_DISMISSED_KEY)) {
                        const presentationModalIsActive = document.getElementById('presentationVideoModal')?.classList.contains('show');
                        if (!presentationModalIsActive) {
                           downloadAppModalInstance.show();
                        }
                    }
                }, (videoAlreadyShown !== 'true' && !videoAlreadyShown) ? 7000 : 2500);
            }

            if (downloadModalEl && dontShowCheckbox) {
                downloadModalEl.addEventListener('hidden.bs.modal', function () {
                    if (dontShowCheckbox.checked) {
                        localStorage.setItem(DOWNLOAD_MODAL_DISMISSED_KEY, 'true');
                    }
                });
            }
            const bannerDismissed = localStorage.getItem(DOWNLOAD_BANNER_DISMISSED_KEY);
            if (bannerEl && !bannerDismissed) {
                let bannerDelay = 3500;
                if (!localStorage.getItem(DOWNLOAD_MODAL_DISMISSED_KEY) || (videoAlreadyShown !== 'true' && !videoAlreadyShown) ) {
                    bannerDelay = 12000;
                }
                setTimeout(() => {
                    const presentationModalIsActive = document.getElementById('presentationVideoModal')?.classList.contains('show');
                    const downloadAppModalIsActive = document.getElementById('downloadAppModal')?.classList.contains('show');
                    if (!localStorage.getItem(DOWNLOAD_BANNER_DISMISSED_KEY) && !presentationModalIsActive && !downloadAppModalIsActive) {
                        bannerEl.style.display = 'block';
                        bannerEl.classList.remove('animate__fadeOutDown');
                        bannerEl.classList.add('animate__animated', 'animate__fadeInUp');
                        adjustBodyPaddingAndFabPosition();
                    }
                }, bannerDelay);
                const closeBannerButton = bannerEl.querySelector('.btn-close');
                if (closeBannerButton) {
                    closeBannerButton.addEventListener('click', () => {
                        bannerEl.classList.remove('animate__fadeInUp');
                        bannerEl.classList.add('animate__animated', 'animate__fadeOutDown');
                        setTimeout(() => {
                            bannerEl.style.display = 'none';
                            localStorage.setItem(DOWNLOAD_BANNER_DISMISSED_KEY, 'true');
                            adjustBodyPaddingAndFabPosition();
                        }, 500);
                    });
                }
            } else if (bannerEl && bannerDismissed) {
                 bannerEl.style.display = 'none';
            }
            adjustBodyPaddingAndFabPosition();
        }

        function handlePresentationVideo() {
            const videoAlreadyShown = localStorage.getItem(PRESENTATION_VIDEO_SHOWN_KEY);
            const videoElement = document.getElementById('introVideo');
            const dontShowCheckbox = document.getElementById('dontShowVideoAgainCheckbox');
            const presentationModalEl = document.getElementById('presentationVideoModal');

            if (!videoAlreadyShown || videoAlreadyShown === 'false') {
                if (presentationVideoModalInstance && videoElement) {
                    const anyMajorModalActive = ['authModal', 'cartModal', 'downloadAppModal', 'helpModal'].some(id => {
                        const modal = document.getElementById(id);
                        return modal && modal.classList.contains('show');
                    });

                    if (!anyMajorModalActive) {
                        setTimeout(() => presentationVideoModalInstance.show(), 1000);
                    }
                } else {
                    console.warn("Modal de video o elemento de video no encontrado para mostrar automáticamente.");
                }
            }

            if (presentationModalEl && videoElement) {
                presentationModalEl.addEventListener('shown.bs.modal', function () {
                    videoElement.currentTime = 0;
                    videoElement.play().catch(error => {
                        console.warn("Autoplay del video bloqueado por el navegador:", error);
                    });
                });

                presentationModalEl.addEventListener('hidden.bs.modal', function () {
                    videoElement.pause();
                    if (dontShowCheckbox && dontShowCheckbox.checked) {
                        localStorage.setItem(PRESENTATION_VIDEO_SHOWN_KEY, 'true');
                    }
                });

                videoElement.addEventListener('ended', function() {
                    if (presentationVideoModalInstance) {
                        presentationVideoModalInstance.hide();
                    }
                });
            }
        }

        function clearFormAndFeedback(formId, feedbackId) {
            if (formId) {
                const form = document.getElementById(formId);
                if (form) form.reset();
            }
            if (feedbackId) {
                const feedbackEl = document.getElementById(feedbackId);
                if (feedbackEl) feedbackEl.innerHTML = '';
            }
        }

        async function fetchDataFromGAS(action, method = 'POST', payloadData = null) {
            if (loadingSpinnerUser) loadingSpinnerUser.classList.add('show');
            try {
                let url = GOOGLE_SCRIPT_URL_USER;
                const options = { method: method, headers: {}, mode: 'cors', redirect: 'follow' };
                if (method === 'GET') {
                    const params = new URLSearchParams({ action: action, cacheBuster: new Date().getTime() });
                    if (payloadData) {
                        for (const key in payloadData) {
                            if (payloadData.hasOwnProperty(key)) { params.append(key, payloadData[key]); }
                        }
                    }
                    url += `?${params.toString()}`;
                } else {
                    options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
                    const dataToSend = { action: action, payload: payloadData };
                    const formBody = new URLSearchParams();
                    formBody.append("data", JSON.stringify(dataToSend));
                    options.body = formBody.toString();
                }
                const res = await fetch(url, options);
                const responseText = await res.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Respuesta no es JSON válido del servidor: ${responseText.substring(0,150)}`);
                }
                return responseData;
            } catch (error) {
                showGlobalFeedback(`Error de conexión o servidor: ${error.message || 'Desconocido'}. Intenta de nuevo.`, "danger", 7000);
                return { success: false, message: `Error de conexión o servidor: ${error.message || 'Desconocido'}.` };
            } finally {
                if (loadingSpinnerUser) loadingSpinnerUser.classList.remove('show');
            }
        }

        function loadClientDataFromStorage() {
            const storedClientData = localStorage.getItem(LOGGED_IN_CLIENT_KEY);
            if (storedClientData) {
                try {
                    clientData = JSON.parse(storedClientData);
                } catch (e) {
                    localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
                    clientData = null;
                }
            } else {
                clientData = null;
            }
        }

        function updateClientDisplayAndUI() {
            const el = id => document.getElementById(id);
            const authNavContainer = el('auth-buttons-nav');
            const logoutNavButton = el('logoutButtonNav');
            const vipCardContainer = el('vip-card-container');
            const guestPromptContainer = el('guest-prompt');
            const userAvatarImg = el('user-avatar');
            const myOrdersTabLink = el('my-orders-tab-link');
            const referralCodeContainerEl = el('client-referral-code-container');
            const clientReferralCodeEl = el('clientReferralCode');


            if (clientData && clientData.id && (clientData.verificado === true || String(clientData.verificado).toLowerCase() === 'true')) {
                el('client-name').textContent = `¡Hola, ${clientData.nombre ? clientData.nombre.split(' ')[0] : 'Cliente'}!`;
                el('client-points').textContent = clientData.puntos !== undefined ? clientData.puntos : 0;
                el('client-status').textContent = `Nivel: ${(clientData.puntos||0)>=150?"Oro":(clientData.puntos||0)>=75?"Plata":"Bronce"}`;
                el('client-phone-display').textContent = clientData.telefono ? `Tel: ${clientData.telefono}` : '';
                el('vip-status-badge').style.display = 'inline-block';
                if (userAvatarImg) {
                    if (clientData[LOCAL_AVATAR_DATA_KEY] && typeof clientData[LOCAL_AVATAR_DATA_KEY] === 'string') {
                        userAvatarImg.src = clientData[LOCAL_AVATAR_DATA_KEY];
                    } else if (clientData.avatarurl && typeof clientData.avatarurl === 'string' && clientData.avatarurl.trim() !== '') {
                         userAvatarImg.src = clientData.avatarurl + (clientData.avatarurl.includes('?') ? '&t=' : '?t=') + new Date().getTime();
                    } else {
                        userAvatarImg.src = 'https://via.placeholder.com/80/FFFFFF/2C3E50?Text=VIP';
                    }
                }
                if(authNavContainer) authNavContainer.innerHTML = `<span class="navbar-text text-light me-2 small">Hola, ${clientData.nombre ? clientData.nombre.split(' ')[0] : 'VIP'}</span>`;
                if(logoutNavButton) logoutNavButton.style.display = 'inline-block';
                if(vipCardContainer) vipCardContainer.style.display = 'block';
                if(guestPromptContainer) guestPromptContainer.style.display = 'none';
                if(myOrdersTabLink) myOrdersTabLink.innerHTML = `<i class="bi bi-receipt me-1"></i>Mis Envíos`;

                if (clientData.referralcode && clientReferralCodeEl && referralCodeContainerEl) {
                    clientReferralCodeEl.textContent = clientData.referralcode;
                    referralCodeContainerEl.style.display = 'block';
                } else if (referralCodeContainerEl) {
                    referralCodeContainerEl.style.display = 'none';
                }

            } else {
                el('client-name').textContent = `¡Bienvenido!`;
                el('client-points').textContent = 0;
                el('client-status').textContent = "Inicia sesión o regístrate para enviar.";
                el('client-phone-display').textContent = '';
                el('vip-status-badge').style.display = 'none';
                if (userAvatarImg) userAvatarImg.src = 'https://via.placeholder.com/80/FFFFFF/2C3E50?Text=VIP';
                if(authNavContainer) authNavContainer.innerHTML = `
                    <button class="btn btn-sm btn-outline-light me-2" onclick="openAuthModal('login')"><i class="bi bi-box-arrow-in-right"></i> Login</button>
                    <button class="btn btn-sm btn-warning" onclick="openAuthModal('register')"><i class="bi bi-person-plus"></i> Registro</button>`;
                if(logoutNavButton) logoutNavButton.style.display = 'none';
                if(vipCardContainer) vipCardContainer.style.display = 'none';
                if(guestPromptContainer) guestPromptContainer.style.display = 'block';
                if(myOrdersTabLink) myOrdersTabLink.innerHTML = `<i class="bi bi-receipt me-1"></i>Mis Envíos`;
                if (referralCodeContainerEl) referralCodeContainerEl.style.display = 'none';
                loadUserOrders();
                generateRewardsList();
            }
            updateCartDisplay();
        }

        function logoutClient() {
            clientData = null;
            localStorage.removeItem(LOGGED_IN_CLIENT_KEY);
            shoppingCart = [];
            availableRewards = [];
            localStorage.removeItem(USER_CART_KEY);
            localStorage.removeItem(REWARDS_USER_CACHE_KEY);
            localStorage.removeItem(REWARDS_CACHE_EXPIRY_KEY);
            updateClientDisplayAndUI();
            showGlobalFeedback('Sesión cerrada. ¡Vuelve pronto!', 'info');
            handleAppDownloadPromotion();
        }

        async function handleUserRegistrationAttempt() {
            const nombre = document.getElementById('newUserName').value.trim();
            const telefono = document.getElementById('newUserPhone').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('newUserConfirmPassword').value;
            const referralCodeUsed = document.getElementById('newUserReferralCodeUsed').value.trim();
            const feedbackElId = 'registration-feedback';

            if (!nombre || !telefono || !email || !password || !confirmPassword) {
                showFeedbackInModal(null, feedbackElId, 'Todos los campos marcados con * son requeridos.', 'danger'); return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showFeedbackInModal(null, feedbackElId, 'Por favor, ingresa un correo electrónico válido.', 'danger'); return;
            }
            if (password !== confirmPassword) {
                showFeedbackInModal(null, feedbackElId, 'Las contraseñas no coinciden.', 'danger'); return;
            }
            if (!/^\+?\d{7,15}$/.test(telefono)) {
                showFeedbackInModal(null, feedbackElId, 'Por favor, ingresa un número de teléfono válido (7-15 dígitos, puede incluir + al inicio).', 'danger'); return;
            }
             if (password.length < 6) {
                showFeedbackInModal(null, feedbackElId, 'La contraseña debe tener al menos 6 caracteres.', 'danger'); return;
            }
            showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Registrando...', 'info', null);
            const payload = { nombre, telefono, email, password, referralCodeUsed };
            const result = await fetchDataFromGAS('registerNewUser', 'POST', payload);
            if (result.success) {
                showFeedbackInModal(null, feedbackElId, `${result.message || '¡Registro exitoso!'} Ahora puedes iniciar sesión para realizar tus envíos.`, 'success', 4000);
                document.getElementById('newUserRegistrationForm').reset();
                setTimeout(() => {
                    if (authModalInstance) {
                        const loginTabBtn = document.getElementById('login-tab-btn');
                        if (loginTabBtn) {
                            bootstrap.Tab.getOrCreateInstance(loginTabBtn).show();
                        }
                        clearFormAndFeedback('newUserRegistrationForm', 'registration-feedback');
                    }
                }, 3000);
            } else {
                showFeedbackInModal(null, feedbackElId, result.message || 'Error al registrar. Intenta de nuevo.', 'danger');
            }
        }

        async function handleLoginAttempt() {
            const telefono = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;
            const feedbackElId = 'login-feedback';
            if (!telefono || !password) {
                showFeedbackInModal(null, feedbackElId, 'Teléfono y contraseña son requeridos.', 'danger'); return;
            }
            showFeedbackInModal(null, feedbackElId, '<div class="spinner-border spinner-border-sm me-2"></div>Iniciando sesión...', 'info', null);
            const payload = { telefono, password };
            const result = await fetchDataFromGAS('loginUser', 'POST', payload);
            if (result.success && result.data) {
                clientData = result.data;
                localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                updateClientDisplayAndUI();
                showFeedbackInModal(null, feedbackElId, `¡Bienvenido de nuevo, ${clientData.nombre.split(' ')[0]}! Listo para enviar.`, 'success', 3000);
                setTimeout(() => authModalInstance?.hide(), 2000);
                loadMenuItems(true);
                loadAvailableRewards(true);
                loadUserOrders();
            } else {
                showFeedbackInModal(null, feedbackElId, result.message || 'Error al iniciar sesión. Verifica tus datos.', 'danger');
            }
        }

        async function handleAvatarFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                showGlobalFeedback('Por favor, selecciona un archivo de imagen (JPEG, PNG, GIF).', 'warning');
                event.target.value = null; return;
            }
            const maxSizeInBytes = 2 * 1024 * 1024;
            if (file.size > maxSizeInBytes) {
                showGlobalFeedback('La imagen es demasiado grande (máx 2MB antes de comprimir).', 'warning');
                event.target.value = null; return;
            }
            showGlobalFeedback('Procesando imagen...', 'info', null);
            try {
                const compressedDataUrl = await compressImage(file, file.type);
                if (clientData && clientData.id) {
                    clientData[LOCAL_AVATAR_DATA_KEY] = compressedDataUrl;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    const userAvatarImg = document.getElementById('user-avatar');
                    if(userAvatarImg) userAvatarImg.src = compressedDataUrl;
                    showGlobalFeedback('Avatar actualizado localmente. Subiendo al servidor...', 'info', 3000);
                } else {
                    showGlobalFeedback('Error: No hay sesión de usuario activa para guardar el avatar local.', 'danger');
                    event.target.value = null; return;
                }
                const parts = compressedDataUrl.split(';base64,');
                const contentType = parts[0].split(':')[1];
                const imageData = parts[1];
                await uploadClientAvatar(imageData, contentType, file.name);
            } catch (error) {
                showGlobalFeedback(`Error al procesar la imagen: ${error.message}`, 'danger');
            } finally {
                event.target.value = null;
            }
        }

        function compressImage(file, originalMimeType) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_AVATAR_DIMENSION) {
                                height = Math.round(height * MAX_AVATAR_DIMENSION / width);
                                width = MAX_AVATAR_DIMENSION;
                            }
                        } else {
                            if (height > MAX_AVATAR_DIMENSION) {
                                width = Math.round(width * MAX_AVATAR_DIMENSION / height);
                                height = MAX_AVATAR_DIMENSION;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', AVATAR_JPEG_QUALITY));
                    };
                    img.onerror = () => reject(new Error("No se pudo cargar la imagen para compresión."));
                };
                reader.onerror = () => reject(new Error("Error leyendo el archivo de imagen."));
            });
        }

        async function uploadClientAvatar(imageData, contentType, filename) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback('Debes iniciar sesión para cambiar tu avatar.', 'warning'); return;
            }
            const payload = {
                clientId: clientData.id,
                imageData: imageData,
                contentType: contentType,
                filename: "avatar_" + clientData.id + "_" + Date.now() + "." + (contentType.split('/')[1] || 'jpg')
            };
            const result = await fetchDataFromGAS('updateClientAvatar', 'POST', payload);
            if (result.success && result.data && result.data.newAvatarUrl) {
                if (result.data.clientData) {
                    const localAvatarTemp = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.clientData;
                    if (localAvatarTemp && !clientData[LOCAL_AVATAR_DATA_KEY]) {
                        clientData[LOCAL_AVATAR_DATA_KEY] = localAvatarTemp;
                    }
                    if (result.data.newAvatarUrl) clientData.avatarurl = result.data.newAvatarUrl;
                } else {
                     clientData.avatarurl = result.data.newAvatarUrl;
                }
                localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                showGlobalFeedback('¡Avatar guardado con éxito en el servidor!', 'success');
            } else {
                showGlobalFeedback(result.message || 'Error al guardar el avatar en el servidor. Se mantiene la versión local.', 'warning');
            }
        }

        async function loadMenuItems(forceRefresh = false) {
            const menuContainer = document.getElementById('menu-container');
            if (!menuContainer) { return; }
            const popularContainer = document.getElementById('popular-items-container');

            const cachedProducts = localStorage.getItem(PRODUCTS_USER_CACHE_KEY);
            const cacheExpiryString = localStorage.getItem(MENU_CACHE_EXPIRY_KEY);
            const now = new Date().getTime();
            const cacheExpiry = cacheExpiryString ? parseInt(cacheExpiryString) : 0;

            if (!forceRefresh && cachedProducts && cacheExpiry && now < cacheExpiry) {
                try {
                    menuItems = JSON.parse(cachedProducts);
                    generatePopularItems();
                    generateCategoryFilters();
                    generateMenu();
                    return;
                } catch(e) {
                    localStorage.removeItem(PRODUCTS_USER_CACHE_KEY);
                    localStorage.removeItem(MENU_CACHE_EXPIRY_KEY);
                }
            }
            menuContainer.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div><p class="mt-2 fs-5">${forceRefresh ? 'Actualizando' : 'Cargando'} menú y combos...</p></div>`;
            if(popularContainer) popularContainer.innerHTML = '<div class="col-12 text-center p-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div><span class="ms-2">Cargando populares...</span></div>';

            const res = await fetchDataFromGAS('getPublicProducts', 'GET');
            if (res.success && Array.isArray(res.data)) {
                menuItems = res.data.map(p => ({
                    ...p,
                    price: parseFloat(p.price) || 0,
                    points: parseInt(p.points) || 0,
                    id: String(p.id),
                    category: p.category || "Otros"
                }));
                localStorage.setItem(PRODUCTS_USER_CACHE_KEY, JSON.stringify(menuItems));
                localStorage.setItem(MENU_CACHE_EXPIRY_KEY, (now + CACHE_DURATION_MS).toString());
                generatePopularItems();
                generateCategoryFilters();
                generateMenu();
                if (forceRefresh) showGlobalFeedback("Menú y combos actualizados.", "success", 2000);
            } else {
                menuContainer.innerHTML = `<div class="col-12 text-center p-5"><p class="text-danger fs-5">Error al ${forceRefresh ? 'actualizar' : 'cargar'} el menú y combos: ${res.message || 'Desconocido.'}</p></div>`;
                if(popularContainer) popularContainer.innerHTML = '<div class="col-12 text-center p-3"><p class="text-danger">Error al cargar populares.</p></div>';
                if (cachedProducts) {
                    try {
                        menuItems = JSON.parse(cachedProducts);
                        generatePopularItems();
                        generateCategoryFilters(); generateMenu();
                        showGlobalFeedback("No se pudo actualizar el menú, mostrando última versión disponible.", "warning", 4000);
                    } catch(e) {}
                }
            }
        }

        function forceLoadMenuItems() {
            loadMenuItems(true);
        }

        function generatePopularItems() {
            const popularContainer = document.getElementById('popular-items-container');
            if (!popularContainer) return;

            if (!menuItems || menuItems.length === 0) {
                popularContainer.innerHTML = '<div class="col-12 text-center p-3"><p class="text-muted">No hay productos para mostrar como populares aún.</p></div>';
                return;
            }
            let popularToShow = [...menuItems];
            popularToShow.sort(() => 0.5 - Math.random());
            popularToShow = popularToShow.slice(0, 4);

            if (popularToShow.length === 0) {
                 popularContainer.innerHTML = '<div class="col-12 text-center p-3"><p class="text-muted">No hay productos destacados en este momento.</p></div>';
                 return;
            }
            popularContainer.innerHTML = '';
            popularToShow.forEach(item => {
                const itemId = String(item.id);
                popularContainer.innerHTML += `
                <div class="col-6 col-md-6 col-lg-3 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.6s;">
                    <div class="menu-item-card card w-100 d-flex flex-column">
                        <img src="${item.imageurl || 'https://via.placeholder.com/350x220/E74C3C/FFF?text=' + encodeURIComponent(item.name || 'Producto')}"
                             class="product-image card-img-top" alt="${item.name || 'Producto'}" style="cursor: pointer;" onclick="showProductDetailModal('${itemId}')" loading="lazy">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${item.name || 'Sin Nombre'}</h5>
                            <p class="card-text small flex-grow-1">${(item.description || 'Deliciosa opción de nuestro menú.').substring(0,70)}${(item.description || '').length > 70 ? '...' : ''}</p>
                            <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-2">
                                <span class="fw-bold fs-6" style="color: var(--primary-color);">USD ${(item.price || 0).toFixed(2)}</span>
                                <span class="badge bg-success text-white small">+${item.points || 0} Pts</span>
                            </div>
                            <button class="btn btn-sm btn-primary mt-2 w-100" onclick="addToCart('${itemId}')"><i class="bi bi-cart-plus-fill me-1"></i>Añadir</button>
                        </div>
                    </div>
                </div>`;
            });
        }

       function generateCategoryFilters() {
            const filterContainer = document.getElementById('filter-container');
            if (!filterContainer) {
                console.error("Contenedor de filtros no encontrado.");
                return;
            }
            filterContainer.innerHTML = '';
            if (!menuItems || menuItems.length === 0) {
                return;
            }
            const allBtn = document.createElement('button');
            allBtn.className = 'btn btn-sm btn-filter';
            allBtn.textContent = 'Todos';
            allBtn.onclick = () => filterMenuByCategory('all');
            filterContainer.appendChild(allBtn);
            const categories = [...new Set(menuItems.map(item => item.category || "Otros"))]
                .sort((a, b) => a.localeCompare(b));
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-filter';
                btn.textContent = category;
                btn.onclick = () => filterMenuByCategory(category);
                filterContainer.appendChild(btn);
            });
            const filterButtons = filterContainer.querySelectorAll('.btn-filter');
            filterButtons.forEach(btn => {
                const btnTextLower = btn.textContent.toLowerCase();
                const currentFilterLower = currentFilterCategory.toLowerCase();
                if ((currentFilterLower === 'all' && btnTextLower === 'todos') ||
                    (btnTextLower === currentFilterLower && currentFilterLower !== 'all')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function filterMenuByCategory(category) {
            currentFilterCategory = category;
            generateCategoryFilters();
            generateMenu();
        }

        function generateMenu() {
            const menuContainer = document.getElementById('menu-container');
            if (!menuContainer) return;
            menuContainer.innerHTML = '';

            const searchTerm = document.getElementById('productSearchInput')?.value.toLowerCase().trim() || '';
            let itemsToDisplay = [...menuItems];

            if (currentFilterCategory !== 'all') {
                itemsToDisplay = itemsToDisplay.filter(item => (item.category || "Otros") === currentFilterCategory);
            }

            if (searchTerm) {
                itemsToDisplay = itemsToDisplay.filter(item =>
                    (item.name || '').toLowerCase().includes(searchTerm) ||
                    (item.description || '').toLowerCase().includes(searchTerm)
                );
            }

            switch (currentSortOption) {
                case 'name-asc':
                    itemsToDisplay.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
                    break;
                case 'name-desc':
                    itemsToDisplay.sort((a, b) => (b.name || "").localeCompare(a.name || ""));
                    break;
                case 'price-asc':
                    itemsToDisplay.sort((a, b) => (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0));
                    break;
                case 'price-desc':
                    itemsToDisplay.sort((a, b) => (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0));
                    break;
                case 'default':
                default:
                    itemsToDisplay.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
                    break;
            }

            if (!itemsToDisplay || itemsToDisplay.length === 0) {
                let emptyMessage = `<div class="col-12 text-center p-md-5 p-4">`;
                emptyMessage += `<i class="bi bi-search-heart display-1 text-muted opacity-50 mb-3"></i>`;
                if (searchTerm && currentFilterCategory === 'all') {
                    emptyMessage += `<h4 class="text-light mb-2">Sin resultados para "${searchTerm}"</h4><p class="text-muted mb-3">No encontramos productos que coincidan con tu búsqueda.</p>`;
                } else if (searchTerm && currentFilterCategory !== 'all') {
                     emptyMessage += `<h4 class="text-light mb-2">Sin resultados en "${currentFilterCategory}"</h4><p class="text-muted mb-3">No hay productos en esta categoría que coincidan con "${searchTerm}".</p>`;
                } else if (!searchTerm && currentFilterCategory !== 'all') {
                    emptyMessage += `<h4 class="text-light mb-2">Categoría Vacía</h4><p class="text-muted mb-3">No hay productos disponibles en la categoría "${currentFilterCategory}".</p>`;
                } else {
                    emptyMessage += `<h4 class="text-light mb-2">Menú Vacío</h4><p class="text-muted mb-3">No hay productos disponibles en el menú en este momento.</p>`;
                }
                emptyMessage += `<p class="text-muted">Intenta con otros términos o revisa todas las categorías.</p>`;
                if (searchTerm || currentFilterCategory !== 'all') {
                    emptyMessage += `<button class="btn btn-outline-primary mt-2" onclick="resetFiltersAndSearch()">Ver todo el menú</button>`;
                }
                emptyMessage += `</div>`;
                menuContainer.innerHTML = emptyMessage;
                return;
            }

            itemsToDisplay.forEach(item => {
                const itemId = String(item.id);
                menuContainer.innerHTML += `
                <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
                    <div class="menu-item-card card w-100 d-flex flex-column">
                        <img src="${item.imageurl || 'https://via.placeholder.com/350x220/E74C3C/FFF?text=' + encodeURIComponent(item.name || 'Producto')}"
                             class="product-image card-img-top" alt="${item.name || 'Producto'}" style="cursor: pointer;" onclick="showProductDetailModal('${itemId}')" loading="lazy">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${item.name || 'Sin Nombre'}</h5>
                            <p class="card-text flex-grow-1">${item.description || 'Deliciosa opción de nuestro menú.'}</p>
                            <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                                <span class="fw-bold fs-5" style="color: var(--primary-color);">USD ${(item.price || 0).toFixed(2)}</span>
                                <span class="badge bg-success text-white">+${item.points || 0} Puntos</span>
                            </div>
                            <button class="btn btn-primary mt-3 w-100" onclick="addToCart('${itemId}')"><i class="bi bi-cart-plus-fill me-2"></i>Añadir al Envío</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function resetFiltersAndSearch() {
            const productSearchInput = document.getElementById('productSearchInput');
            if (productSearchInput) productSearchInput.value = '';
            const clearSearchButton = document.getElementById('clearSearchButton');
            if (clearSearchButton) clearSearchButton.style.display = 'none';
            currentFilterCategory = 'all';
            currentSortOption = 'default';
            const sortSelect = document.getElementById('sortProductsSelect');
            if (sortSelect) sortSelect.value = 'default';
            generateCategoryFilters();
            generateMenu();
        }


        function showProductDetailModal(productId) {
            populateModalWithProduct(productId);
            productDetailModalInstance.show();
        }

        function switchProductInModal(productId) {
            populateModalWithProduct(productId);
        }

        function populateModalWithProduct(productId) {
            const product = menuItems.find(p => p.id === productId);
            if (!product) {
                console.error("Producto no encontrado para el modal:", productId);
                return;
            }
            document.getElementById('modal-product-image').src = product.imageurl || 'https://via.placeholder.com/500x600/141E30/FAFAFA?text=' + encodeURIComponent(product.name || 'Producto');
            document.getElementById('modal-product-name').textContent = product.name || 'Sin Nombre';
            document.getElementById('modal-product-description').textContent = product.description || 'Descripción no disponible.';
            document.getElementById('modal-product-price').textContent = `USD ${(product.price || 0).toFixed(2)}`;
            document.getElementById('modal-product-points').textContent = `+${product.points || 0} Puntos`;
            const btnContainer = document.getElementById('modal-add-to-cart-button-container');
            btnContainer.innerHTML = `<button class="btn btn-primary btn-lg w-100" onclick="addToCartAndCloseModal('${productId}')"><i class="bi bi-cart-plus-fill me-2"></i>Añadir al Envío</button>`;
            generateRecommendations(productId);
        }

        function generateRecommendations(currentProductId) {
            const recommendationsContainer = document.getElementById('modal-recommendations-container');
            recommendationsContainer.innerHTML = '<h5><i class="bi bi-magic me-2"></i>También podría interesarte</h5>';
            const currentProduct = menuItems.find(p => p.id === currentProductId);
            if (!currentProduct) return;
            const candidates = menuItems.filter(p => p.id !== currentProductId);
            const sameCategory = candidates.filter(p => p.category === currentProduct.category);
            const otherCategory = candidates.filter(p => p.category !== currentProduct.category);
            const shuffledCandidates = [...sameCategory.sort(() => 0.5 - Math.random()), ...otherCategory.sort(() => 0.5 - Math.random())];
            const finalRecommendations = shuffledCandidates.slice(0, 3);
            if (finalRecommendations.length === 0) {
                recommendationsContainer.innerHTML += '<p class="small text-muted">No hay otras recomendaciones por ahora.</p>';
                return;
            }
            const recRow = document.createElement('div');
            recRow.className = 'row g-2';
            finalRecommendations.forEach(rec => {
                recRow.innerHTML += `
                <div class="col-4">
                    <div class="recommendation-card" onclick="switchProductInModal('${rec.id}')">
                        <img src="${rec.imageurl || 'https://via.placeholder.com/150/21243D/FAFAFA?text=' + encodeURIComponent(rec.name)}" alt="${rec.name}" loading="lazy">
                        <div class="p-2"><div class="rec-title">${rec.name}</div></div>
                    </div>
                </div>`;
            });
            recommendationsContainer.appendChild(recRow);
        }

        function addToCartAndCloseModal(productId) {
            addToCart(productId);
            productDetailModalInstance.hide();
        }

        function loadCartFromStorage(){
            const storedCart = localStorage.getItem(USER_CART_KEY);
            shoppingCart = storedCart ? (JSON.parse(storedCart) || []) : [];
            updateCartDisplay();
        }

        function saveCartToStorage(){
            try {
                localStorage.setItem(USER_CART_KEY, JSON.stringify(shoppingCart));
            } catch(e) {
                showGlobalFeedback("No se pudo guardar el carrito. Espacio de almacenamiento lleno?", "danger");
            }
        }

        function addToCart(productId) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback('Inicia sesión para añadir productos a tu envío.', 'warning');
                openAuthModal('login');
                return;
            }
            if (!menuItems || menuItems.length === 0) {
                showGlobalFeedback("Error: El menú no está cargado. Intenta recargar la página.", "danger");
                return;
            }
            const product = menuItems.find(item => item.id === productId);
            if (!product) {
                showGlobalFeedback("Producto no encontrado.", "danger");
                return;
            }
            const existingItem = shoppingCart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity = (existingItem.quantity || 0) + 1;
            } else {
                shoppingCart.push({
                    productId: product.id, name: product.name,
                    price:parseFloat(product.price)||0, quantity:1, points:parseInt(product.points)||0
                });
            }
            saveCartToStorage();
            updateCartDisplay();
            renderCartItems();
            showGlobalFeedback(`${product.name} añadido a tu envío!`, 'success', 2000);
        }

        function updateCartQuantity(productId, change) {
            const itemInCart = shoppingCart.find(item => item.productId === productId);
            if (itemInCart) {
                itemInCart.quantity += change;
                if (itemInCart.quantity <= 0) {
                    shoppingCart = shoppingCart.filter(item => item.productId !== productId);
                }
            }
            saveCartToStorage();
            renderCartItems();
            updateCartDisplay();
        }

        function removeFromCart(productId) {
            shoppingCart = shoppingCart.filter(item => item.productId !== productId);
            saveCartToStorage();
            renderCartItems();
            updateCartDisplay();
            showGlobalFeedback("Producto eliminado del envío.", "info", 1500);
        }

        function clearCart() {
            if (shoppingCart.length === 0) {
                showFeedbackInModal(null, 'order-placement-feedback', 'El carrito de envío ya está vacío.', 'info', 2000);
                if (cartModalInstance && document.getElementById('cartModal').classList.contains('show')) {
                } else if (cartModalInstance) {
                    cartModalInstance.show();
                }
                return;
            }

            if (confirmClearCartModalInstance) {
                confirmClearCartModalInstance.show();
            } else {
                if (confirm("¿Estás seguro de que quieres vaciar tu carrito de envío?")) {
                    performClearCartActions();
                }
            }
        }

        function performClearCartActions() {
            shoppingCart = [];
            saveCartToStorage();
            renderCartItems();
            updateCartDisplay();
            showFeedbackInModal(null, 'order-placement-feedback', 'Carrito de envío vaciado.', 'info', 2000);
            if (cartModalInstance && document.getElementById('cartModal').classList.contains('show')) {
            } else {
                showGlobalFeedback('Carrito de envío vaciado.', 'info');
            }
            if (confirmClearCartModalInstance) {
                 confirmClearCartModalInstance.hide();
            }
        }


        function updateCartDisplay() {
            let totalItems = Array.isArray(shoppingCart) ? shoppingCart.reduce((s, i) => s + (i.quantity || 0), 0) : 0;
            if (floatingCartButtonEl && floatingCartCountEl) {
                const isCurrentlyVisible = floatingCartButtonEl.style.display !== 'none' && !floatingCartButtonEl.classList.contains('animate__zoomOut');
                const shouldBeVisible = totalItems > 0 && clientData && clientData.id;
                if (shouldBeVisible && !isCurrentlyVisible) {
                    floatingCartButtonEl.classList.remove('animate__zoomOut');
                    floatingCartButtonEl.classList.add('animate__animated', 'animate__zoomIn');
                    floatingCartButtonEl.style.display = 'flex';
                } else if (!shouldBeVisible && isCurrentlyVisible) {
                    floatingCartButtonEl.classList.remove('animate__zoomIn');
                    floatingCartButtonEl.classList.add('animate__animated', 'animate__zoomOut');
                    setTimeout(() => {
                        if ( !(totalItems > 0 && clientData && clientData.id) ) {
                           floatingCartButtonEl.style.display = 'none';
                        }
                    }, 500);
                }
                floatingCartCountEl.textContent = totalItems;
            }
            const pointsEl = document.getElementById('cart-points-to-earn');
            if(pointsEl) pointsEl.textContent = Array.isArray(shoppingCart) ? shoppingCart.reduce((s,i)=>s+((i.points||0)*(i.quantity||0)),0) : 0;
            adjustBodyPaddingAndFabPosition();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            const totalPriceEl = document.getElementById('cart-total-price');
            const pointsToEarnEl = document.getElementById('cart-points-to-earn');
            if (!container || !totalPriceEl || !pointsToEarnEl) return;
            container.innerHTML = ''; let currentTotal = 0; let totalPoints = 0;
            if (!Array.isArray(shoppingCart) || shoppingCart.length === 0) {
                container.innerHTML = '<p class="text-center py-4 fs-5">Tu carrito de envío está vacío.</p>';
                totalPriceEl.textContent = '0.00';
                pointsToEarnEl.textContent = '0';
                updateCartDisplay();
                return;
            }
            const ul = document.createElement('ul');
            ul.className = 'list-group list-group-flush';
            shoppingCart.forEach(item => {
                const itemTotal = (parseFloat(item.price) || 0) * (item.quantity || 0);
                const itemPoints = (item.points || 0) * (item.quantity || 0);
                currentTotal += itemTotal;
                totalPoints += itemPoints;
                const itemProductId = String(item.productId);
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2 py-3 bg-transparent text-light border-secondary';
                li.innerHTML = `
                    <div class="me-auto">
                        <strong class="d-block">${item.name || 'Desconocido'}</strong>
                        <small class="text-muted">${item.quantity||0} x USD ${(parseFloat(item.price)||0).toFixed(2)}</small>
                    </div>
                    <div class="fw-bold me-3 fs-5">USD ${itemTotal.toFixed(2)}</div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary px-2 py-1" onclick="updateCartQuantity('${itemProductId}',-1)"><i class="bi bi-dash-lg"></i></button>
                        <span class="btn btn-light disabled px-3 py-1 border-secondary text-dark">${item.quantity||0}</span>
                        <button class="btn btn-outline-secondary px-2 py-1" onclick="updateCartQuantity('${itemProductId}',1)"><i class="bi bi-plus-lg"></i></button>
                        <button class="btn btn-outline-danger ms-2 px-2 py-1" onclick="removeFromCart('${itemProductId}')"><i class="bi bi-trash"></i></button>
                    </div>`;
                ul.appendChild(li);
            });
            container.appendChild(ul);
            totalPriceEl.textContent = currentTotal.toFixed(2);
            pointsToEarnEl.textContent = totalPoints;
            updateCartDisplay();
        }

        function generateWhatsAppMessage(orderId, cart, total) {
            let message = `¡Hola! 👋 He realizado un nuevo pedido desde DL Cumanayagua.\n\n`;
            message += `*Nro. de Envío:* ${orderId}\n\n`;
            message += "*Resumen del pedido:*\n";
            cart.forEach(item => {
                message += `- ${item.quantity}x ${item.name}\n`;
            });
            message += `\n*Total:* USD ${total.toFixed(2)}\n\n`;
            message += `Espero instrucciones para el pago. ¡Gracias!`;
            return encodeURIComponent(message);
        }

        function postWhatsAppNotification() {
            showGlobalFeedback("Serás redirigido a WhatsApp. Una vez enviado el mensaje, puedes cerrar esta ventana.", "info", 8000);
            setTimeout(() => {
                cartModalInstance?.hide();
            }, 5000);
        }

        async function confirmAndPlaceOrder() {
            if (!Array.isArray(shoppingCart) || shoppingCart.length === 0) {
                showFeedbackInModal(null, 'order-placement-feedback', "Tu carrito de envío está vacío.", "warning");
                return;
            }
            if (!clientData || !clientData.id) {
                showFeedbackInModal(null, 'order-placement-feedback', 'Inicia sesión para realizar un envío.', 'warning');
                cartModalInstance?.hide();
                openAuthModal('login');
                return;
            }
            showFeedbackInModal(null, 'order-placement-feedback', '<div class="spinner-border spinner-border-sm me-2"></div>Procesando envío...', 'info', null);
            const cartPayload = shoppingCart.map(item => ({ productId: String(item.productId), quantity: item.quantity || 0 }));
            const result = await fetchDataFromGAS('placeOrder', 'POST', { clientId: String(clientData.id), cartItems: cartPayload });

            if (result.success && result.data) {
                const orderTotal = shoppingCart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)), 0);
                const whatsappMessage = generateWhatsAppMessage(result.data.orderId, shoppingCart, orderTotal);
                const whatsappUrl = `https://wa.me/5355189657?text=${whatsappMessage}`;

                const feedbackEl = document.getElementById('order-placement-feedback');
                feedbackEl.innerHTML = `
                    <div class="alert alert-success" role="alert">
                      <h4 class="alert-heading">¡Envío Programado con Éxito!</h4>
                      <p>Tu pedido con ID <strong>#${result.data.orderId}</strong> ha sido registrado. El siguiente paso es notificarnos por WhatsApp para coordinar el pago.</p>
                      <hr>
                      <a href="${whatsappUrl}" target="_blank" class="btn btn-success btn-lg w-100" onclick="postWhatsAppNotification()">
                        <i class="bi bi-whatsapp me-2"></i><strong>Notificar Pedido por WhatsApp</strong>
                      </a>
                    </div>
                `;

                document.getElementById('cart-footer-info').style.display = 'none';
                document.getElementById('cart-footer-buttons').style.display = 'none';

                shoppingCart = [];
                saveCartToStorage();

                if (result.data.updatedClient) {
                    const localAvatar = clientData[LOCAL_AVATAR_DATA_KEY];
                    clientData = result.data.updatedClient;
                    if (localAvatar && !clientData[LOCAL_AVATAR_DATA_KEY]) clientData[LOCAL_AVATAR_DATA_KEY] = localAvatar;
                    localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                    updateClientDisplayAndUI();
                }

                renderCartItems();
                loadUserOrders();

            } else {
                showFeedbackInModal(null, 'order-placement-feedback', result.message || 'Error al programar el envío.', 'danger');
            }
        }

        async function loadUserOrders() {
            const container = document.getElementById('orders-history-container');
            if (!container) return;
            if (!clientData || !clientData.id) {
                container.innerHTML = `
                    <div class="col-12 text-center p-md-5 p-4">
                        <i class="bi bi-person-fill-lock display-1 text-muted opacity-50 mb-3"></i>
                        <h4 class="text-light mb-2">Acceso VIP Requerido</h4>
                        <p class="text-muted mb-3">Inicia sesión o regístrate para ver tu historial de envíos.</p>
                        <button class="btn btn-warning me-2" onclick="openAuthModal('login')">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesión
                        </button>
                        <button class="btn btn-outline-light" onclick="openAuthModal('register')">
                            <i class="bi bi-person-plus me-2"></i>Registrarme
                        </button>
                    </div>`;
                return;
            }
            container.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);"></div><p class="mt-2 fs-5">Cargando historial de envíos...</p></div>`;
            const result = await fetchDataFromGAS('getUserOrders', 'POST', { clientId: String(clientData.id) });
            if (result.success && Array.isArray(result.data)) {
                if (result.data.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center p-md-5 p-4">
                            <i class="bi bi-box-seam-fill display-1 text-muted opacity-50 mb-3"></i>
                            <h4 class="text-light mb-2">Aún no tienes envíos registrados</h4>
                            <p class="text-muted mb-3">Parece que todavía no has enviado nada. ¿Listo para sorprender a alguien?</p>
                            <button class="btn btn-primary" onclick="showTabAndScroll('menu-tab-link')">
                                <i class="bi bi-card-list me-2"></i>Explorar Menú y Combos
                            </button>
                        </div>`;
                    return;
                }
                let html = '<div class="accordion shadow-sm" id="ordersAccordion">';
                result.data.sort((a,b) => new Date(b.orderdateiso || b.orderdate) - new Date(a.orderdateiso || a.orderdate));
                result.data.forEach((order, index) => {
                    const items = order.itemsjson;
                    let itemsHtml = '<ul class="list-unstyled small ms-3 mt-1">';
                    if (Array.isArray(items) && items.length > 0) {
                        items.forEach(item => {
                            itemsHtml += `<li>${item.quantity}x ${item.name} (USD ${((parseFloat(item.price)||0) * (item.quantity||0)).toFixed(2)})</li>`;
                        });
                    } else { itemsHtml += '<li>No hay detalles de ítems.</li>'; }
                    itemsHtml += '</ul>';
                    let sbc = 'bg-secondary';
                    const os = String(order.status || '').toLowerCase();
                    if (os === 'pendiente de pago' || os === 'pendiente') sbc = 'bg-warning text-dark';
                    else if (os === 'procesado' || os === 'en preparación') sbc = 'bg-info text-dark';
                    else if (os === 'entregado' || os === 'completado') sbc = 'bg-success';
                    else if (os === 'cancelado') sbc = 'bg-danger';
                    const dateStr = order.orderdateiso || order.orderdate;
                    const odf = dateStr ? new Date(dateStr).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric', hour:'2-digit', minute:'2-digit' }) : 'Fecha N/A';
                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="hO${order.orderid}"><button class="accordion-button ${index>0?'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#cO${order.orderid}" aria-expanded="${index===0}" aria-controls="cO${order.orderid}"><span class="me-auto">${odf} - Envío #${String(order.orderid).substr(-6)} - USD ${(parseFloat(order.totalamount)||0).toFixed(2)}</span><span class="badge ${sbc} text-uppercase">${order.status||'N/A'}</span></button></h2>
                            <div id="cO${order.orderid}" class="accordion-collapse collapse ${index===0?'show':''}" aria-labelledby="hO${order.orderid}" data-bs-parent="#ordersAccordion"><div class="accordion-body"><strong>Puntos ${order.pointsgiven?'Otorgados':'A Otorgar'}:</strong> ${order.totalpointsawarded||0}<br><strong>Ítems:</strong>${itemsHtml}</div></div>
                        </div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                 container.innerHTML = `
                    <div class="col-12 text-center p-md-5 p-4">
                        <i class="bi bi-emoji-frown display-1 text-danger opacity-75 mb-3"></i>
                        <h4 class="text-light mb-2">Error al cargar envíos</h4>
                        <p class="text-danger mb-3">${result.message || 'Ocurrió un problema al intentar obtener tu historial.'}</p>
                        <button class="btn btn-outline-secondary" onclick="loadUserOrders()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Intentar de nuevo
                        </button>
                    </div>`;
            }
        }

        async function loadAvailableRewards(forceReload = false) {
            const rc = document.getElementById('rewards-container');
            if (!rc) return;
            if (!clientData || !clientData.id) {
                generateRewardsList();
                return;
            }

            const cachedRewards = localStorage.getItem(REWARDS_USER_CACHE_KEY);
            const cacheExpiryString = localStorage.getItem(REWARDS_CACHE_EXPIRY_KEY);
            const now = new Date().getTime();
            const cacheExpiry = cacheExpiryString ? parseInt(cacheExpiryString) : 0;

            if (!forceReload && cachedRewards && cacheExpiry && now < cacheExpiry) {
                try {
                    availableRewards = JSON.parse(cachedRewards);
                    generateRewardsList();
                    console.log("Recompensas cargadas desde caché.");
                    return;
                } catch(e) {
                    console.error("Error parseando recompensas de caché:", e);
                    localStorage.removeItem(REWARDS_USER_CACHE_KEY);
                    localStorage.removeItem(REWARDS_CACHE_EXPIRY_KEY);
                }
            }

            rc.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);"></div><p class="mt-2 fs-5">${forceReload ? 'Actualizando' : 'Cargando'} recompensas...</p></div>`;
            const res = await fetchDataFromGAS('getAvailableRewards', 'GET');
            if (res.success && Array.isArray(res.data)) {
                availableRewards = res.data.map(r => ({...r, rewardid: String(r.rewardid), pointsrequired:parseInt(r.pointsrequired)||0, stock:parseInt(r.stock) }));
                try {
                    localStorage.setItem(REWARDS_USER_CACHE_KEY, JSON.stringify(availableRewards));
                    localStorage.setItem(REWARDS_CACHE_EXPIRY_KEY, (now + CACHE_DURATION_MS).toString());
                    console.log("Recompensas guardadas en caché.");
                } catch (cacheError) {
                    console.error("Error guardando recompensas en caché:", cacheError);
                    showGlobalFeedback("No se pudo guardar la caché de recompensas. Espacio lleno?", "warning");
                }
                generateRewardsList();
                if (forceReload) showGlobalFeedback("Recompensas actualizadas.", "success", 2000);
            } else {
                rc.innerHTML = `
                    <div class="col-12 text-center p-md-5 p-4">
                        <i class="bi bi-cloud-slash-fill display-1 text-danger opacity-75 mb-3"></i>
                        <h4 class="text-light mb-2">Error al cargar recompensas</h4>
                        <p class="text-danger mb-3">${res.message || 'No pudimos obtener la lista de recompensas en este momento.'}</p>
                        <button class="btn btn-outline-secondary" onclick="forceLoadRewards()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reintentar
                        </button>
                    </div>`;
                 if (cachedRewards && !forceReload) {
                    try {
                        availableRewards = JSON.parse(cachedRewards);
                        generateRewardsList();
                        showGlobalFeedback("No se pudieron actualizar las recompensas, mostrando última versión disponible.", "warning", 4000);
                    } catch(e) {}
                }
            }
        }

        function forceLoadRewards() {
            if (!clientData || !clientData.id) {
                generateRewardsList();
                showGlobalFeedback("Inicia sesión para ver y actualizar recompensas.", "warning");
                return;
            }
            loadAvailableRewards(true);
        }

        function generateRewardsList() {
            const rc = document.getElementById('rewards-container');
            if (!rc) return;
            rc.innerHTML = '';
            if (!clientData || !clientData.id) {
                rc.innerHTML = `
                    <div class="col-12 text-center p-md-5 p-4">
                        <i class="bi bi-person-fill-lock display-1 text-muted opacity-50 mb-3"></i>
                        <h4 class="text-light mb-2">Acceso VIP Requerido</h4>
                        <p class="text-muted mb-3">Inicia sesión o regístrate para descubrir y canjear recompensas exclusivas para tus envíos.</p>
                        <button class="btn btn-warning me-2" onclick="openAuthModal('login')">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesión
                        </button>
                        <button class="btn btn-outline-light" onclick="openAuthModal('register')">
                            <i class="bi bi-person-plus me-2"></i>Registrarme
                        </button>
                    </div>`;
                return;
            }
            if (!availableRewards || availableRewards.length === 0) {
                rc.innerHTML = `
                    <div class="col-12 text-center p-md-5 p-4">
                        <i class="bi bi-gift-fill display-1 text-muted opacity-50 mb-3"></i>
                        <h4 class="text-light mb-2">Aún no hay recompensas disponibles</h4>
                        <p class="text-muted mb-3">Sigue realizando envíos para acumular puntos y estate atento a nuevas recompensas. ¡Pronto podrías canjear grandes beneficios!</p>
                        <button class="btn btn-primary" onclick="showTabAndScroll('menu-tab-link')">
                            <i class="bi bi-bag-heart-fill me-2"></i>Hacer un Envío y Ganar Puntos
                        </button>
                    </div>`;
                return;
            }
            const cp = clientData ? (parseInt(clientData.puntos) || 0) : 0;
            availableRewards.sort((a,b) => (a.pointsrequired||0)-(b.pointsrequired||0));
            availableRewards.forEach(reward => {
                const ca = cp >= reward.pointsrequired;
                const hs = isNaN(reward.stock) || reward.stock === 9999 || reward.stock > 0;
                const cr = ca && hs; 
                const rid = String(reward.rewardid);
                rc.innerHTML += `
                <div class="col-6 col-md-6 col-lg-4 d-flex align-items-stretch animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
                    <div class="reward-card card w-100 ${!cr ? 'opacity-75' : ''}">
                        <img src="${reward.imageurl || 'https://via.placeholder.com/350x220/F1C40F/2C3E50?text=' + encodeURIComponent(reward.name||'Recompensa')}"
                             class="reward-image card-img-top" alt="${reward.name||'Recompensa'}" loading="lazy"
                             style="cursor: pointer;" onclick="showRewardDetailModal('${rid}')">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-1" style="cursor: pointer;" onclick="showRewardDetailModal('${rid}')">${reward.name||'N/A'}</h5>
                            <p class="card-text small flex-grow-1 mb-3">${(reward.description||'Beneficio para tus envíos.').substring(0,70)}${(reward.description || '').length > 70 ? '...' : ''}</p>
                            <div class="price-points-row d-flex justify-content-between align-items-center mt-auto pt-3">
                                <span class="fw-bold fs-5" style="color: var(--accent-color);">${reward.pointsrequired} Pts</span>
                                ${!isNaN(reward.stock) && reward.stock !== 9999 ? `<span class="small text-muted">Disp: ${reward.stock}</span>` : (reward.stock === 0 ? `<span class="small text-danger fw-bold">Agotado</span>` : `<span class="small text-muted">Ilimitado</span>`)}
                            </div>
                            <button class="btn btn-warning w-100 mt-3" onclick="attemptRedeemReward('${rid}')" ${!cr?'disabled':''}>
                                <i class="bi bi-award-fill me-2"></i> ${cr ? 'Canjear para Envío' : (ca && !hs && reward.stock === 0 ? 'Agotado' : (ca && !hs ? 'Agotado' : 'Puntos Insuf.'))}
                            </button>
                        </div>
                    </div>
                </div>`;
            });
        }

        async function showRewardDetailModal(rewardId) {
            if (!availableRewards || availableRewards.length === 0) await loadAvailableRewards();
            const reward = availableRewards.find(r => r.rewardid === rewardId);

            if (!reward) {
                showGlobalFeedback("Recompensa no encontrada.", "danger");
                return;
            }

            document.getElementById('modal-reward-image').src = reward.imageurl || 'https://via.placeholder.com/500x600/E67E22/FAFAFA?text=' + encodeURIComponent(reward.name || 'Recompensa');
            document.getElementById('modal-reward-name').textContent = reward.name || 'Sin Nombre';
            document.getElementById('modal-reward-description').textContent = reward.description || 'Descripción no disponible.';
            document.getElementById('modal-reward-points-required').textContent = `${reward.pointsrequired || 0} Puntos`;

            const stockInfoEl = document.getElementById('modal-reward-stock-info');
            if (!isNaN(reward.stock) && reward.stock !== 9999) {
                stockInfoEl.textContent = `Disponibles: ${reward.stock}`;
                stockInfoEl.className = reward.stock > 0 ? 'badge bg-success' : 'badge bg-danger';
            } else if (reward.stock === 0) { 
                 stockInfoEl.textContent = `Agotado`;
                 stockInfoEl.className = 'badge bg-danger fw-bold';
            } else { 
                stockInfoEl.textContent = 'Ilimitado';
                stockInfoEl.className = 'badge bg-info';
            }


            const redeemBtnContainer = document.getElementById('modal-redeem-reward-button-container');
            const clientPoints = clientData ? (parseInt(clientData.puntos) || 0) : 0;
            const canAfford = clientPoints >= reward.pointsrequired;
            const hasStock = isNaN(reward.stock) || reward.stock === 9999 || reward.stock > 0;
            const canRedeem = canAfford && hasStock && clientData && clientData.id;

            if (canRedeem) {
                redeemBtnContainer.innerHTML = `<button class="btn btn-warning btn-lg w-100" onclick="redeemFromDetailModal('${reward.rewardid}')"><i class="bi bi-award-fill me-2"></i>Canjear por ${reward.pointsrequired} Pts</button>`;
            } else if (clientData && clientData.id) {
                let reason = "";
                if (!canAfford) reason = "Puntos insuficientes.";
                else if (!hasStock) reason = "Recompensa agotada.";
                redeemBtnContainer.innerHTML = `<button class="btn btn-secondary btn-lg w-100" disabled><i class="bi bi-x-octagon-fill me-2"></i>No canjeable (${reason})</button>`;
            } else {
                 redeemBtnContainer.innerHTML = `<button class="btn btn-outline-light btn-lg w-100" onclick="if(rewardDetailModalInstance) rewardDetailModalInstance.hide(); openAuthModal('login');"><i class="bi bi-person-check-fill me-2"></i>Iniciar sesión para canjear</button>`;
            }

            generateProductRecommendationsForRewardModal();
            if(rewardDetailModalInstance) rewardDetailModalInstance.show();
        }

        function redeemFromDetailModal(rewardId) {
            if(rewardDetailModalInstance) rewardDetailModalInstance.hide();
            attemptRedeemReward(rewardId);
        }

        function generateProductRecommendationsForRewardModal() {
            const recommendationsContainer = document.getElementById('reward-modal-product-recs-row');
            if (!recommendationsContainer) return;
            recommendationsContainer.innerHTML = '';

            if (!menuItems || menuItems.length === 0) {
                recommendationsContainer.innerHTML = '<p class="text-muted small col-12">No hay productos para recomendar en este momento.</p>';
                return;
            }

            let candidates = [...menuItems];
            candidates.sort(() => 0.5 - Math.random());

            const finalRecommendations = candidates.slice(0, 3);

            if (finalRecommendations.length === 0) {
                recommendationsContainer.innerHTML = '<p class="text-muted small col-12">No hay productos para recomendar.</p>';
                return;
            }

            finalRecommendations.forEach(rec => {
                recommendationsContainer.innerHTML += `
                <div class="col-4">
                    <div class="recommendation-card" onclick="if(rewardDetailModalInstance) rewardDetailModalInstance.hide(); showProductDetailModal('${rec.id}');">
                        <img src="${rec.imageurl || 'https://via.placeholder.com/150/21243D/FAFAFA?text=' + encodeURIComponent(rec.name)}" alt="${rec.name}" loading="lazy">
                        <div class="p-2">
                            <div class="rec-title">${rec.name}</div>
                            <small class="text-primary fw-bold d-block mt-1">USD ${rec.price.toFixed(2)}</small>
                        </div>
                    </div>
                </div>`;
            });
        }

        function generateRewardWhatsAppMessage(rewardName, clientName) {
            let message = `¡Hola! 👋 Acabo de canjear una recompensa desde DL Cumanayagua.\n\n`;
            message += `*Cliente:* ${clientName}\n`;
            message += `*Recompensa Canjeada:* ${rewardName}\n\n`;
            message += `Por favor, tomar nota para mi próximo envío. ¡Gracias!`;
            return encodeURIComponent(message);
        }

        async function attemptRedeemReward(rewardId) {
            if (!clientData || !clientData.id) {
                showGlobalFeedback("Debes iniciar sesión para canjear.", "warning");
                openAuthModal('login');
                return;
            }
            const reward = availableRewards.find(r => r.rewardid === rewardId);
            if (!reward) {
                showGlobalFeedback("Recompensa no encontrada.", "danger");
                return;
            }

            const modalTextEl = document.getElementById('confirmRedeemRewardText');
            const modalFeedbackEl = document.getElementById('redeemRewardFeedback');
            const modalFooterEl = document.getElementById('confirmRedeemRewardFooter');

            if (modalTextEl) modalTextEl.innerHTML = `¿Estás seguro de que quieres canjear "<strong>${reward.name}</strong>" por <strong>${reward.pointsrequired} puntos</strong>?`;
            if (modalFeedbackEl) modalFeedbackEl.innerHTML = '';

            if (modalFooterEl) {
                modalFooterEl.innerHTML = `
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="confirmRedeemRewardButtonDynamicInstance">
                        <i class="bi bi-award-fill me-1"></i>Sí, Canjear Ahora
                    </button>`;

                const confirmButtonDynamic = document.getElementById('confirmRedeemRewardButtonDynamicInstance');
                if (confirmButtonDynamic) {
                    confirmButtonDynamic.onclick = async () => {
                        if (modalFeedbackEl) modalFeedbackEl.innerHTML = `<div class="alert alert-info py-2 small"><div class="spinner-border spinner-border-sm me-2"></div>Procesando canje...</div>`;
                        confirmButtonDynamic.disabled = true;

                        const result = await fetchDataFromGAS('redeemReward', 'POST', { clientId: String(clientData.id), rewardId: rewardId });

                        if (result.success && result.data) {
                            const pointsBefore = clientData.puntos;
                            clientData.puntos = (clientData.puntos || 0) - (reward.pointsrequired || 0);
                            if (clientData.puntos < 0) clientData.puntos = 0;

                            if (result.data.updatedClient) {
                                const serverPoints = result.data.updatedClient.puntos;
                                const localAvatar = clientData[LOCAL_AVATAR_DATA_KEY];
                                clientData = result.data.updatedClient;
                                clientData.puntos = Math.min(pointsBefore - (reward.pointsrequired || 0), serverPoints);
                                if(localAvatar && !clientData[LOCAL_AVATAR_DATA_KEY]) clientData[LOCAL_AVATAR_DATA_KEY] = localAvatar;
                            }

                            localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                            updateClientDisplayAndUI();

                            const whatsappMessage = generateRewardWhatsAppMessage(reward.name, clientData.nombre);
                            const whatsappUrl = `https://wa.me/5355189657?text=${whatsappMessage}`;
                            if (modalFeedbackEl) {
                                modalFeedbackEl.innerHTML = `
                                    <div class="alert alert-success py-2 small">
                                        ${result.message || "¡Recompensa canjeada con éxito!"}
                                        <hr class="my-2">
                                        <a href="${whatsappUrl}" target="_blank" class="btn btn-sm btn-success w-100"
                                           onclick="if(confirmRedeemRewardModalInstance) confirmRedeemRewardModalInstance.hide(); if(rewardDetailModalInstance && rewardDetailModalInstance._isShown) rewardDetailModalInstance.hide();">
                                            <i class="bi bi-whatsapp me-2"></i>Notificar Canje por WhatsApp
                                        </a>
                                    </div>`;
                            }
                            if (modalFooterEl) {
                                modalFooterEl.innerHTML = `<button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="if(rewardDetailModalInstance && rewardDetailModalInstance._isShown) rewardDetailModalInstance.hide();">Cerrar</button>`;
                            }
                            loadAvailableRewards(true);
                        } else {
                            if (modalFeedbackEl) modalFeedbackEl.innerHTML = `<div class="alert alert-danger py-2 small">${result.message || "No se pudo canjear. Intenta de nuevo."}</div>`;
                            if(confirmButtonDynamic) confirmButtonDynamic.disabled = false;
                        }
                    };
                }
            }

            if (confirmRedeemRewardModalInstance) {
                confirmRedeemRewardModalInstance.show();
            } else {
                if (confirm(`¿Canjear "${reward.name}" por ${reward.pointsrequired} puntos para un próximo envío?`)) {
                     showGlobalFeedback("Procesando canje...", "info", null);
                     const resultFallback = await fetchDataFromGAS('redeemReward', 'POST', { clientId: String(clientData.id), rewardId: rewardId });
                     if (resultFallback.success && resultFallback.data) {
                        showGlobalFeedback(resultFallback.message || "¡Recompensa canjeada!", "success", 5000);
                         if (resultFallback.data.updatedClient) {
                            const localAvatar = clientData[LOCAL_AVATAR_DATA_KEY];
                            clientData = resultFallback.data.updatedClient;
                            if(localAvatar && !clientData[LOCAL_AVATAR_DATA_KEY]) clientData[LOCAL_AVATAR_DATA_KEY] = localAvatar;
                            clientData.puntos = (clientData.puntos || 0) - (reward.pointsrequired || 0);
                            if (clientData.puntos < 0) clientData.puntos = 0;
                            localStorage.setItem(LOGGED_IN_CLIENT_KEY, JSON.stringify(clientData));
                            updateClientDisplayAndUI();
                        }
                        loadAvailableRewards(true);
                     } else {
                        showGlobalFeedback(resultFallback.message || "No se pudo canjear. Intenta de nuevo.", "danger", 7000);
                     }
                }
            }
        }


        function showFeedbackInModal(modalIdUnused, elId, msg, type='info', dur=4000) {
            const div = document.getElementById(elId);
            if (!div) return;
            div.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show small py-2" role="alert">${msg}<button type="button" class="btn-close btn-close-white btn-sm py-2" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
            if (dur !== null && type !== 'info' && !(String(msg).includes('spinner-border'))) {
                 setTimeout(() => { if (div && div.innerHTML.includes(msg)) div.innerHTML = ''; }, dur);
            }
        }

        function showGlobalFeedback(msg, type = 'info', dur = 4000) {
            const toastPlacement = document.getElementById('toastPlacement');
            if (!toastPlacement) {
                alert(`${type.toUpperCase()}: ${msg}`);
                return;
            }
            const toastId = 'liveToast-' + Date.now();
            let tbc = 'bg-primary text-white', bcc = 'btn-close-white';
            if (type === 'danger') { tbc = 'bg-danger text-white'; }
            else if (type === 'success') { tbc = 'bg-success text-white'; }
            else if (type === 'warning') { tbc = 'bg-warning text-dark'; bcc = 'btn-close-dark';}
            const toastHTML = `
                <div class="toast align-items-center ${tbc} border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close ${bcc} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
                </div>`;
            toastPlacement.insertAdjacentHTML('beforeend', toastHTML);
            const toastEl = document.getElementById(toastId);
            if (toastEl) {
                const toastInstance = new bootstrap.Toast(toastEl, {
                    autohide: (dur !== null && !String(msg).includes('spinner-border')),
                    delay: dur
                });
                toastInstance.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }
        }

        function initializeShareModal() {
             const shareModalEl = document.getElementById('sharePageModal');
             if (shareModalEl) {
                shareModalEl.addEventListener('shown.bs.modal', generateQrCodesForSharing);
             }
        }

        function generateQrCodesForSharing() {
            const qrPageCanvas = document.getElementById('qrcodeCanvas');
            const qrAppCanvas = document.getElementById('qrcodeAppCanvas');

            if (qrPageCanvas) {
                qrPageCanvas.innerHTML = '';
                if (qrcodePageInstance) {
                    qrcodePageInstance.clear();
                    qrcodePageInstance = null;
                }
                const pageUrl = window.location.href;
                qrcodePageInstance = new QRCode(qrPageCanvas, {
                    text: pageUrl, width: 130, height: 130,
                    colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
                });

                const sharePageText = encodeURIComponent(`¡Echa un vistazo a DL Cumanayagua para enviar productos a Cuba! ${pageUrl}`);
                document.getElementById('shareViaWhatsAppButton').href = `https://wa.me/?text=${sharePageText}`;
                document.getElementById('shareViaTelegramButton').href = `https://t.me/share/url?url=${encodeURIComponent(pageUrl)}&text=${encodeURIComponent('¡Visita DL Cumanayagua!')}`;
            }

            if (qrAppCanvas) {
                qrAppCanvas.innerHTML = '';
                 if (qrcodeAppInstance) {
                    qrcodeAppInstance.clear();
                    qrcodeAppInstance = null;
                }
                qrcodeAppInstance = new QRCode(qrAppCanvas, {
                    text: APP_DOWNLOAD_LINK, width: 130, height: 130,
                    colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
                });
                const shareAppText = encodeURIComponent(`Descarga la app de DL Cumanayagua para que tu familia en Cuba vea el catálogo: ${APP_DOWNLOAD_LINK}`);
                document.getElementById('shareAppViaWhatsAppButtonModal').href = `https://wa.me/?text=${shareAppText}`;
                document.getElementById('shareAppViaTelegramButtonModal').href = `https://t.me/share/url?url=${encodeURIComponent(APP_DOWNLOAD_LINK)}&text=${encodeURIComponent('Descarga la app DL Cumanayagua')}`;
            }
        }

        function shareAppLinkViaCopy() {
            navigator.clipboard.writeText(APP_DOWNLOAD_LINK).then(() => {
                showGlobalFeedback('¡Enlace de descarga de la App copiado!', 'success', 2500);
            }, (err) => {
                showGlobalFeedback('Error al copiar enlace de la App.', 'danger');
                console.error('Error al copiar enlace de la App: ', err);
            });
        }

        function shareAppLinkViaWhatsApp() {
            const message = encodeURIComponent(`Te comparto el enlace para descargar la App de DL Cumanayagua, para que tu familia en Cuba pueda ver el catálogo de productos: ${APP_DOWNLOAD_LINK}`);
            window.open(`https://wa.me/?text=${message}`, '_blank');
        }


        function setupShareEventListeners() {
            const copyLinkButton = document.getElementById('copyLinkButton');
            if (copyLinkButton) {
                copyLinkButton.addEventListener('click', function() {
                    const pageUrl = window.location.href;
                    navigator.clipboard.writeText(pageUrl).then(function() {
                        showGlobalFeedback('¡Enlace de la página copiado!', 'success', 2000);
                    }, function(err) {
                        showGlobalFeedback('Error al copiar el enlace de la página.', 'danger', 3000);
                        console.error('Error al copiar: ', err);
                    });
                });
            }
        }

        function setupFloatingButtonFeedback() {
            if (floatingCartButtonEl) {
                floatingCartButtonEl.addEventListener('click', function() {
                    floatingCartButtonEl.classList.add('clicked-animation');
                    setTimeout(() => {
                        floatingCartButtonEl.classList.remove('clicked-animation');
                    }, 400);
                });
            }

            const floatingShareButtonEl = document.getElementById('floatingShareButton');
            if (floatingShareButtonEl) {
                floatingShareButtonEl.addEventListener('click', function() {
                    floatingShareButtonEl.classList.add('clicked-animation');
                    setTimeout(() => {
                        floatingShareButtonEl.classList.remove('clicked-animation');
                    }, 400);
                });
            }

            const whatsappButtonEl = document.getElementById('whatsappButton');
            if (whatsappButtonEl) {
                whatsappButtonEl.addEventListener('click', function(event) {
                    whatsappButtonEl.classList.add('clicked-animation');
                    setTimeout(() => {
                        whatsappButtonEl.classList.remove('clicked-animation');
                    }, 400);
                });
            }
        }

        function copyReferralCode() {
            if (clientData && clientData.referralcode) {
                navigator.clipboard.writeText(clientData.referralcode).then(() => {
                    showGlobalFeedback('¡Tu código de referido ha sido copiado!', 'success', 2000);
                }).catch(err => {
                    showGlobalFeedback('Error al copiar el código.', 'danger');
                    console.error('Error al copiar código de referido: ', err);
                });
            }
        }

         // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { scope: '/TheDo-aLuc-aGroup/' }) 
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar el Service Worker:', error);
                    });
            });
        }

    </script>
</body>
</html>
